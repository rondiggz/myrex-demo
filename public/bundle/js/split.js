/*! For license information please see split.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[777],{32005:(e,t,i)=>{"use strict";i.d(t,{E:()=>r});var s=i(32485),n=i.n(s),o=i(16700),a=i(74848);const r=e=>{let{iconClass:t,label:i,badgeStyle:s,onClick:r,className:h,imageUrl:l,labelClass:d}=e;const c=(0,o.bt)("badge");return(0,a.jsxs)("span",{className:n()("badge",h,{clickable:!!r},c),onClick:r,style:s,children:[t&&(0,a.jsx)("span",{className:n()("icon","badge-icon",t)}),i&&(0,a.jsx)("span",{className:n()("badge-label",d),children:i}),l&&(0,a.jsx)("span",{className:"badge-img",children:(0,a.jsx)("img",{src:l,alt:"badge"})})]})}},34674:(e,t,i)=>{"use strict";i.d(t,{c:()=>h});var s=i(32485),n=i.n(s),o=i(56453),a=i(16700),r=i(74848);function h(e){let{title:t,className:i,variant:s,actions:h,badge:l,decals:d,active:c=!1,selected:u=!1,disabled:p=!1,selectMode:m=!1,selectDisabled:g=!1,onSelect:f,id:v,onClick:y,onMouseEnter:b,onMouseLeave:w,ref:I}=e;const D=(0,a.bt)("mp-nova-list-item"),S=n()("mp-nova-list-item",D,i,{[`mp-nova-list-item-${s}`]:void 0!==s,"mp-nova-disabled":p,"mp-nova-multi-select":m,interactive:!!y,selected:u,active:c});return(0,r.jsxs)("div",{className:S,onClick:y,onMouseEnter:b,onMouseLeave:w,"data-id":v,ref:I,children:[m&&(0,r.jsx)(o.S,{id:`mp-list-checkbox-${v}`,defaultChecked:u,onChange:f,onClick:e=>e.stopPropagation(),disabled:g}),l&&(0,r.jsx)("span",{className:"mp-list-item-badge",children:l}),(0,r.jsxs)("span",{className:"mp-list-item-title",children:[(0,r.jsx)("span",{className:"mp-list-item-text",children:t}),d&&(0,r.jsx)("span",{className:"mp-list-item-decals",children:d})]}),h&&(0,r.jsx)("span",{className:"mp-list-item-actions",children:h})]})}},34558:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetScans"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"scans"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ScanDetails"},directives:[]}]}}]}}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ScanDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"Scan"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"index"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"name"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"alignment"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"options"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"timeOfDay"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"anchor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"camera"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"name"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"vendor"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"captureMode"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"depthCameraType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"cameraTypes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"sensorSerialNumbers"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"serialNumber"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mountCalibrationVersion"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"softwareVersion"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:452}};t.loc.source={body:"query GetScans($modelId: ID!) {\n  model(id: $modelId) {\n    id\n    assets {\n      scans {\n        ...ScanDetails\n      }\n    }\n  }\n}\n\nfragment ScanDetails on Scan {\n  id\n  index\n  name\n  created\n  alignment\n  options\n  url\n  timeOfDay\n  anchor {\n    id\n  }\n  camera {\n    id\n    name\n    vendor\n    model\n    captureMode\n    depthCameraType\n    cameraTypes\n    sensorSerialNumbers\n    serialNumber\n    mountCalibrationVersion\n    softwareVersion\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var s=e.type;"NamedType"===s.kind&&t.add(s.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var s={};function n(e,t){for(var i=0;i<e.definitions.length;i++){var s=e.definitions[i];if(s.name&&s.name.value==t)return s}}function o(e,t){var i={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var o=s[t]||new Set,a=new Set,r=new Set;for(o.forEach((function(e){r.add(e)}));r.size>0;){var h=r;r=new Set,h.forEach((function(e){a.has(e)||(a.add(e),(s[e]||new Set).forEach((function(e){r.add(e)})))}))}return a.forEach((function(t){var s=n(e,t);s&&i.definitions.push(s)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),s[e.name.value]=t}})),e.exports=t,e.exports.GetScans=o(t,"GetScans"),e.exports.ScanDetails=o(t,"ScanDetails")},76185:(e,t,i)=>{"use strict";function s(e){if(null==e)throw new Error(`Expected a defined value but got ${e} instead`)}i.d(t,{$:()=>s})},84917:(e,t,i)=>{"use strict";var s;function n(e){const t=new Date;t.setHours(0,0,0,0),e.setHours(0,0,0,0);const i=(t.getTime()-e.getTime())/864e5;if(0===i)return s.TODAY;if(1===i)return s.YESTERDAY;if(i<7)return s.THIS_WEEK;const n=Math.floor(i/7);return 1===n?s.ONE_WEEK_AGO:2===n?s.TWO_WEEKS_AGO:3===n?s.THREE_WEEKS_AGO:s.OLDER}i.d(t,{T:()=>s,n:()=>n}),function(e){e.TODAY="TODAY",e.YESTERDAY="YESTERDAY",e.THIS_WEEK="THIS_WEEK",e.ONE_WEEK_AGO="ONE_WEEK_AGO",e.TWO_WEEKS_AGO="TWO_WEEKS_AGO",e.THREE_WEEKS_AGO="THREE_WEEKS_AGO",e.OLDER="OLDER"}(s||(s={}))},49216:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>h});var s=i(64882),n=i(35843),o=i(71687),a=i(32484);const{TILEDMESH_SETTINGS:r}=a.yJ;class h extends s.n{constructor(){super(...arguments),this.name="automation-support"}async init(e,t){const i=window;if(i.MP_AUTOMATION)this.addAutomationHooks(t,i.MP_AUTOMATION);else{const e=performance.now(),s=setInterval((()=>{i.MP_AUTOMATION?(this.addAutomationHooks(t,i.MP_AUTOMATION),clearInterval(s)):performance.now()-e>5e3&&clearInterval(s)}),100)}}async addAutomationHooks(e,t){const i=await e.getModuleBySymbol(o.M7);t.estimatedGPUMemoryAllocated=()=>i.estimatedGPUMemoryAllocated(),t.maxLOD=()=>r.maxLOD,t.diGetContainer=n.Ks}}},97573:(e,t,i)=>{"use strict";i.d(t,{EH:()=>n,v6:()=>o});var s=i(90457);const n=(e=200)=>[{property:s.ResizeProperty.width,setDimension:e=>e.width,duration:e},{property:s.ResizeProperty.height,setDimension:e=>e.height,duration:e},{property:s.ResizeProperty.top,setDimension:()=>0,duration:e},{property:s.ResizeProperty.left,setDimension:()=>0,duration:e}],o=(e,t,i,n=200)=>{const o=[];return void 0!==e&&o.push({property:s.ResizeProperty.width,setDimension:t=>t.width+e,duration:n}),void 0!==t&&o.push({property:s.ResizeProperty.height,setDimension:e=>e.height+t,duration:n}),void 0!==i&&o.push({property:s.ResizeProperty.left,setDimension:()=>i,duration:n}),o}},62916:(e,t,i)=>{"use strict";var s;i.d(t,{S:()=>s}),function(e){e[e.Reticle=0]="Reticle",e[e.GridPlane=1]="GridPlane"}(s||(s={}))},83681:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>I});var s=i(64882),n=i(14614),o=i(64200),a=i(25443),r=i(79243),h=i(49953),l=i(71687),d=i(10459),c=i(7584),u=i(8694),p=i(99583),m=i(66806),g=i(2993),f=i(81587),v=i(86866),y=i(78498);function b(e){const t=(0,y.p)(v.U$.toVisionSweepQuaternion(e.rotation));return{position:(0,y.I)(v.U$.toVisionVector(e.position)),rotation:t,aspect:e.aspect(),isOrtho:e.isOrtho(),fovX:e.fovX(),fovY:e.fovY()}}function w(e){return(0,f.$T)(new Date(e))}class I extends s.n{constructor(){super(...arguments),this.name="dwell-analytics",this.currentRoomBoundRoomData=null,this.pendingDwellEvents=[],this.onCameraChange=(0,r.n)((e=>{this.checkForDwellEvent(),e.clone(this.currentEvent.pose),this.currentEvent.startTimeMs=Date.now(),this.scheduleDwellTimeOutEvent()}),1e3),this.checkForDwellEvent=(e=!1)=>{const{startTimeMs:t,viewmode:i,roomId:s}=this.currentEvent;if(!t||this.appData.phase!==n.Jj.PLAYING)return;const o=Date.now(),a=o-t,r={pose:b(this.currentEvent.pose),durationMs:a,startTime:w(t),endTime:w(o),timedOut:e,viewmode:i,roomId:s};this.trackDwellEvent(r)},this.onViewmodeUpdate=e=>{e.value!==m.N.Transition&&(this.currentEvent.viewmode=(0,g.Te)(e.value))},this.onCurrentRoomChanged=e=>{e&&(this.currentEvent.roomId=e.id)},this.trackDwellEvent=e=>{this.pendingDwellEvents.push(e),this.trackPendingDwellEvents()},this.trackPendingDwellEvents=(0,r.n)((()=>{const e={events:JSON.stringify(this.pendingDwellEvents)};this.pendingDwellEvents=[],this.analytics.track("dwell_events",e)}),5e3),this.onBlur=()=>this.stopTrackingDwellTime(!1),this.stopTrackingDwellTime=(e=!1)=>{this.checkForDwellEvent(e),delete this.currentEvent.startTimeMs},this.resumeTrackingDwellTime=()=>{this.currentEvent.startTimeMs||(this.currentEvent.startTimeMs=Date.now()),this.scheduleDwellTimeOutEvent()},this.throttledResumeTrackingDwellTime=(0,r.n)(this.resumeTrackingDwellTime,100),this.scheduleDwellTimeOutEvent=(0,o.s)((()=>this.stopTrackingDwellTime(!0)),15e3)}async init(e,t){var i,s,o;[this.analytics,this.cameraData,this.appData,this.viewmodeData,this.policyData,this.settingsData]=await Promise.all([t.getModuleBySymbol(l.aF),t.market.waitForData(d.M),t.market.waitForData(n.zH),t.market.waitForData(p.X),t.market.waitForData(h.L),t.market.waitForData(a.o)]),(0,c.m2)(this.policyData,this.settingsData,this.appData.application===n.lg.WORKSHOP)&&(this.currentRoomBoundRoomData=await t.market.waitForData(u.y),this.bindings.push(this.currentRoomBoundRoomData.makeCurrentRoomChangeSubscription(this.onCurrentRoomChanged))),this.currentEvent={pose:this.cameraData.pose.clone(),viewmode:(0,g.Te)(null),roomId:null!==(o=null===(s=null===(i=this.currentRoomBoundRoomData)||void 0===i?void 0:i.currentRoom)||void 0===s?void 0:s.id)&&void 0!==o?o:null},this.bindings.push(this.cameraData.pose.onChanged(this.onCameraChange)),this.bindings.push(this.viewmodeData.onPropertyChanged("currentModeObservable",this.onViewmodeUpdate)),window.addEventListener("blur",this.onBlur),window.addEventListener("focus",this.resumeTrackingDwellTime),window.addEventListener("keydown",this.resumeTrackingDwellTime,{capture:!0}),window.addEventListener("touchcancel",this.resumeTrackingDwellTime),window.addEventListener("touchstart",this.resumeTrackingDwellTime),window.addEventListener("touchend",this.resumeTrackingDwellTime),window.addEventListener("touchmove",this.throttledResumeTrackingDwellTime),window.addEventListener("mousemove",this.throttledResumeTrackingDwellTime)}dispose(e){super.dispose(e),window.removeEventListener("blur",this.onBlur),window.removeEventListener("focus",this.resumeTrackingDwellTime),window.removeEventListener("keydown",this.resumeTrackingDwellTime,{capture:!0}),window.removeEventListener("touchcancel",this.resumeTrackingDwellTime),window.removeEventListener("touchstart",this.resumeTrackingDwellTime),window.removeEventListener("touchend",this.resumeTrackingDwellTime),window.removeEventListener("touchmove",this.throttledResumeTrackingDwellTime),window.removeEventListener("mousemove",this.throttledResumeTrackingDwellTime)}}},16115:(e,t,i)=>{"use strict";var s;i.r(t),i.d(t,{FeatureUsage:()=>s,FeatureUsageAnalyticsHandler:()=>n.q,FeatureUsageMessage:()=>o.P,default:()=>w}),function(e){let t,i,s;!function(e){e.TAG="tag",e.HIGHLIGHT="highlight",e.MEASUREMENTS="measurements"}(t=e.FeatureType||(e.FeatureType={})),function(e){e.TAG_VIEW="tag_view",e.HIGHLIGHT_VIEW="highlight_view",e.MEASUREMENTS_VIEW="measurements_view"}(i=e.ViewEventName||(e.ViewEventName={})),function(e){e.VIEW="view"}(s=e.ViewEventAction||(e.ViewEventAction={}))}(s||(s={}));var n=i(99622),o=i(67536),a=i(64882),r=i(14614),h=i(9139),l=i(25443),d=i(49953),c=i(47737),u=i(10459),p=i(99583),m=i(39209),g=i(2993),f=i(80419);class v{constructor(e){this.engine=e}subscribe(e){return this.engine.subscribe(f.T8,(({sid:t,view:i})=>{const n={itemId:t,tagAction:i,action:s.ViewEventAction.VIEW,featureType:s.FeatureType.TAG,eventName:s.ViewEventName.TAG_VIEW};e(n)}))}}var y=i(7584),b=i(8694);class w extends a.n{constructor(){super(...arguments),this.name="feature-usage-module",this.currentViewId="",this.currentRoomId=null,this.currentFloorId=null,this.currentViewmode=(0,g.Te)(null)}async init(e,t){var i;const s=h.Vy.for(this);s.debug("fetching data model dependencies"),[this.cameraData,this.policyData,this.layersData,this.settingsData,this.viewmodeData,this.floorsViewData,this.applicationData]=await Promise.all([t.market.waitForData(u.M),t.market.waitForData(d.L),t.market.waitForData(c.P),t.market.waitForData(l.o),t.market.waitForData(p.X),t.market.waitForData(m.X),t.market.waitForData(r.zH)]),s.debug("data model dependencies resolved"),this.currentViewmode=(0,g.Te)(this.viewmodeData.peekabooCorrectedMode(this.cameraData)),this.bindings.push(this.viewmodeData.makeModeChangeSubscription((()=>{this.currentViewmode=(0,g.Te)(this.viewmodeData.peekabooCorrectedMode(this.cameraData))})),this.cameraData.pose.onChanged((()=>{this.currentViewmode=(0,g.Te)(this.viewmodeData.peekabooCorrectedMode(this.cameraData))}))),this.currentViewId=this.layersData.currentViewId,this.bindings.push(this.layersData.onPropertyChanged("currentViewId",(()=>{this.currentViewId=this.layersData.currentViewId}))),this.currentFloorId=this.floorsViewData.currentFloorId,this.bindings.push(this.floorsViewData.makeFloorChangeSubscription((()=>{this.currentFloorId=this.floorsViewData.currentFloorId})));const n=this.applicationData.application===r.lg.WORKSHOP;if((0,y.m2)(this.policyData,this.settingsData,n)){s.debug("fetching [CurrentRoomBoundRoomData] data model dependency");const e=await t.market.waitForData(b.y);s.debug("[CurrentRoomBoundRoomData] data model dependency resolved"),this.currentRoomId=(null===(i=e.currentRoom)||void 0===i?void 0:i.id)||null,this.bindings.push(e.makeCurrentRoomChangeSubscription((e=>{this.currentRoomId=(null==e?void 0:e.id)||null})))}const a=new v(t);this.bindings.push(a.subscribe((e=>{const i=Object.assign(Object.assign({},e),this.metadata);t.broadcast(new o.P(i))})))}get metadata(){return{roomId:this.currentRoomId,viewId:this.currentViewId,floorId:this.currentFloorId,viewmode:this.currentViewmode,interactionSource:"gui"}}}},18633:(e,t,i)=>{"use strict";i.d(t,{OR:()=>a,Zl:()=>r,v0:()=>o,v3:()=>n,vp:()=>h});var s=i(92475);class n extends s.E{constructor(e,t,i,s,n){super(e),this.position=t,this.clientPosition=i,this.delta=s,this.buttons=n}}class o extends s.E{constructor(e,t,i,s,n,o){super(e),this.position=t,this.clientPosition=i,this.delta=s,this.buttons=n,this.progress=o}}class a extends s.E{constructor(e,t,i,s){super(e),this.position=t,this.clientPosition=i,this.buttons=s}}class r extends s.E{constructor(e,t,i,s){super(e),this.position=t,this.clientPosition=i,this.buttons=s}}class h extends s.E{constructor(e,t,i,s){super(e),this.position=t,this.clientPosition=i,this.cancelled=s}}},34567:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>R});var s=i(64882),n=i(92953),o=i(81547),a=i(1284),r=i(97234),h=i(9139),l=i(71687),d=i(81530),c=i(47737),u=i(85182),p=i(20968),m=i(3928),g=i(68909);class f extends m.v{constructor(){super(...arguments),this.position=new g.Vector3,this.floorId="",this.sid="",this.layerId="",this.text="",this.visible=!1,this.roomId=void 0,this.created=new Date,this.modified=new Date,this.version="3.1"}copy(e){return this.floorId=e.floorId,this.roomId=e.roomId,this.sid=e.sid,this.text=e.text,this.visible=e.visible,this.roomId=e.roomId,this.created=e.created,this.modified=e.modified,this.position.copy(e.position),this.version=e.version,this.commit(),this}}var v=i(51666),y=i(86866);const b=new h.Vy("mds-label-serialize");class w{constructor(){this.validate=e=>{if(!e)return!1;const t=["enabled","floorId","label","position"].filter((t=>!(t in e))),i=0===t.length,s=!!e.floorId&&"string"==typeof e.floorId,n=!!e.position&&(0,v.Z)(e.position),o=i&&s&&n;return o||b.debug("Label invalid:",{missingFields:t,validPosition:n}),o}}serialize(e,t){const i=D(e,t);return this.validate(i)?i:null}}class I{constructor(){this.validate=e=>{if(!e)return!1;const t=["enabled","label","position","floorId","roomId","layerId"];return Object.keys(e).every((e=>t.includes(e)))}}serialize(e,t){const i=D(e,t);return i&&this.validate(i)?i:null}}const D=(e,t)=>{const i={};return void 0!==e.visible&&(i.enabled=e.visible),void 0!==e.text&&(i.label=e.text),void 0!==e.position&&(0,v.Z)(e.position)&&(i.position=y.U$.toVisionVector(e.position)),void 0!==e.floorId&&""!==e.floorId&&(i.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(i.roomId=e.roomId),t&&void 0!==e.layerId&&""!==e.layerId&&(i.layerId=e.layerId),Object.keys(i).length>0?i:null};var S=i(81587);const E=new h.Vy("mds-label-deserializer");class M{constructor(){this.validate=e=>{if(!e)return!1;const t=["id","created","modified","enabled","floor","label","position"].filter((t=>!(t in e))),i=0===t.length,s=!(!e.floor||!e.floor.id),n=!!e.position&&(0,v.Z)(e.position);return i&&s&&n||E.debug("Label invalid:",{missingFields:t,validFloor:s,validPosition:n}),i&&s&&n}}deserialize(e){var t;if(!e||!this.validate(e))return E.debug("Deserialized invalid Label data from MDS",e),null;const i=new f;return i.sid=e.id,i.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",i.floorId=e.floor.id,i.text=e.label,i.visible=!!e.enabled,i.created=(0,S.XH)(e.created),i.modified=(0,S.XH)(e.modified),i.position=y.U$.fromVisionVector(e.position),e.room&&e.room.id&&(i.roomId=e.room.id),i}}var C=i(96069),T=i(47907),x=i(11751),A=i(74381);const L=new h.Vy("MdsLabelStore");class P extends p.g{constructor(e){super(e),this.prefetchKey="data.model.labels",this.layeredType=A.jM.LABEL,this.deserializer=new M,this.updateSerializer=new I,this.createSerializer=new w}async read(e){const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t,includeLayers:this.readLayerId()};return this.query(C.GetLabels,i,e).then((e=>{var t,i;const s=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.labels;if(!s||!Array.isArray(s))return null;const n=[];for(const e of s){const t=this.deserializer.deserialize(e);t&&n.push(t)}return n.reduce(((e,t)=>(e[t.sid]=t,e)),{})}))}async create(e){const t=this.getViewId(),i=[];for(const s of e){const e=this.createSerializer.serialize(s,this.writeLayerId(s.layerId));if(!e)throw L.error("Failure saving label:",s.sid,s),new Error("Could not save Label");const n={modelId:t,labelId:s.sid,data:e,includeLayers:this.readLayerId()};await this.mutate(C.AddLabel,n).then((e=>{var t;const n=null===(t=e.data)||void 0===t?void 0:t.addLabel;if(!n)throw new Error("Could not save label: empty response");const o=(new f).copy(s);o.sid=n.id,o.commit(),L.debug(Object.assign({type:"addLabel"},e)),i.push(o)}))}return i}async update(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";const s={};s.modelId=t,s.includeLayers=this.readLayerId();let n="";for(const t of e){const e=t.sid,o=this.updateSerializer.serialize(t,!1);if(!o)throw L.error("Failure updating label:",e,t),new Error("Could not update Label");i+=`, $patch${e}: LabelPatch!`,s[`patch${e}`]=o,n+=`patch${e}:\n        patchLabel(modelId: $modelId, labelId: "${e}", patch: $patch${e}) {\n          ...LabelDetails\n        }\n      `}const o=T.J1`
      mutation labelUpdate($modelId: ID! ${i}, $includeLayers: Boolean!) {
        ${n}
      }

      ${(0,x.y)(C.LabelDetails)}
    `;return this.mutate(o,s).then((e=>{L.debug(Object.assign({type:"patchLabel"},e))}))}async delete(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const t of e){if(!t||t&&!t.sid)throw L.error("Failure deleting label:",t),new Error("Could not update Label");i+=`delete${t.sid}: deleteLabel(modelId: $modelId, labelId: "${t.sid}") `}const s=T.J1`
      mutation batchDeleteLabel($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(s,{modelId:t}).then((()=>{}))}}class R extends s.n{constructor(){super(...arguments),this.name="label-data",this.monitor=null}async init(e,t){const{readonly:i}=e;this.engine=t,this.market=t.market,this.layersData=await t.market.waitForData(c.P),this.store=new P({context:this.layersData.mdsContext,readonly:e.readonly,includeDisabled:!e.readonly,baseUrl:e.baseUrl});const s=await this.store.read()||{},r=await t.getModuleBySymbol(l.T9),h=await t.getModuleBySymbol(l.PM);for(const e of Object.values(s))h.inferMeshIdsFromPoint(e,e.position,!1);this.labelData=t.market.tryGetData(u.B)||new u.B(s),this.store.onNewData((async e=>{var t;this.labelData.atomic((()=>{this.layersData.replaceBackendLayers(this.labelData.getCollection(),{})})),e&&this.labelData.atomic((()=>{this.layersData.replaceBackendLayers(this.labelData.getCollection(),e)})),null===(t=this.monitor)||void 0===t||t.clearDiffRecord()})),await this.store.refresh(),this.market.register(u.B,this.labelData),i||(this.monitor=new n.F(this.labelData.getCollection(),{aggregationType:o.D.Manual,shallow:!0},this.engine),this.bindings.push(r.onSave((()=>this.saveDiff()),{dataType:a.p.LABELS})))}dispose(e){this.store.dispose(),super.dispose(e)}async save(){return this.engine.commandBinder.issueCommand(new d.F({dataTypes:[a.p.LABELS]}))}getDiffRecord(){var e;return(null===(e=this.monitor)||void 0===e?void 0:e.getDiffRecord())||[]}async saveDiff(){if(!this.store||!this.monitor)return void h.Vy.for(this).warn("Labels changes will NOT be saved");this.monitor.commitChanges();const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=e.map((e=>{var t;const i=e.diff.layerId||(null===(t=this.labelData.getLabel(e.index))||void 0===t?void 0:t.layerId);return Object.assign(Object.assign({},e),{layerId:i})})).filter((e=>!this.layersData.isInMemoryLayer(e.layerId))),i=t.filter((e=>e.action===r.Xw.removed)).map((e=>({sid:e.index,layerId:e.layerId}))),s=t.filter((e=>e.action===r.Xw.added)).map((e=>this.labelData.getLabel(e.index))),n=t.filter((e=>e.action===r.Xw.updated)).map((e=>Object.assign(Object.assign({sid:e.index},e.diff),{layerId:e.layerId})));return Promise.all([this.store.delete(i),this.store.create(s),this.store.update(n)]).then((()=>{}))}onUpdate(e){}}},27145:(e,t,i)=>{"use strict";i.r(t),i.d(t,{USER_LABELS:()=>T,default:()=>fe});var s=i(64882),n=i(25443),o=i(71687),a=i(85182),r=i(10459),h=i(39209),l=i(96319),d=i(22278),c=i(12837),u=i(50485),p=i(37458),m=i(16153),g=i(68909),f=i(38069);const v={ColorDefault:f.V.WHITE.clone(),ColorHovered:f.V.MP_BRAND.clone(),ColorInvalid:new g.Color(16750933)};class y extends m.QM{use(e){this.userData.sid=e.data.sid,this.collider.data=e.data,this.collider.name=e.data.text,this.collider.labelMesh=e}}class b extends g.Mesh{constructor(){super(...arguments),this.hitTest=(()=>{const e=new g.Matrix4,t=new g.Ray,i=new g.Plane(new g.Vector3(0,0,-1)),s=new g.Vector3;return(n,o)=>{if(e.copy(this.matrixWorld).invert(),t.copy(n.ray).applyMatrix4(e),t.intersectPlane(i,s)){const e=this.scale.x/this.scale.y;let t=.5;e<1.5&&(t=1/e),Math.abs(s.x)<=t&&Math.abs(s.y)<=.75&&(s.applyMatrix4(this.matrixWorld),o.push({distance:n.ray.origin.distanceTo(s),point:s.clone(),object:this}))}}})()}labelVisible(){return!(!this.labelMesh||!this.labelMesh.labelVisible())}getId(){if(!this.data)throw new Error("LabelInputCollider used before configure");return this.data.sid}raycast(e,t){if(!this.labelVisible())return;if(this.material.depthTest)return void this.hitTest(e,t);const i=this.material.depthTest?t:[];this.hitTest(e,i),i.length>0&&(i[0].distance/=1e4,t.push(i[0]))}}class w{constructor(e={}){this.makeLabel=()=>{const e=new y(Object.assign({},this.textStyle));return e.scaleType=m.bF.WORLD,e.setRenderOrder(p.X.labels),e.setRenderLayer(this.layer),e.opacity=0,e},this.textStyle=m.Il.makeConfig(Object.assign({color:f.V.WHITE.clone(),background:!1,backgroundAsCollider:!0,backgroundColliderType:b,backgroundColor:f.V.PORTAL.clone(),backgroundOpacity:1,outline:!0,outlineWidth:.06,wordWrapWidth:void 0,disableDepth:!0},e))}setRenderLayer(e){this.layer=e}}var I=i(11165);class D extends I.u{constructor(e){super(),this.payload={ids:e}}}D.id="FILTER_LABEL_VISIBILITY";class S extends I.u{constructor(e){super(),this.payload={enabled:e}}}S.id="VISIBILITY_FILTER_ENABLED";var E=i(88325),M=i(9139),C=i(92237);const T={LABEL_SIZE:0,FADE_DURATION:200};class x extends g.Object3D{constructor(e){super(),this.text=e,this.maxOpacity=1,this.labelAnim=new C.z(0),this.filtered=!1,this.hidden=!1,this.selectState={active:!1,on:()=>{},off:()=>{}},this.validState={active:!0,on:()=>{const e=this.hoverState.active?v.ColorHovered:v.ColorDefault;this.text.setColor(e)},off:()=>{this.text.setColor(v.ColorInvalid)}},this.hoverState={active:!1,on:()=>{this.validState.active&&this.text.setColor(v.ColorHovered)},off:()=>{this.validState.active&&this.text.setColor(v.ColorDefault)}},this.add(e)}use(e){this.data=e,this.userData.sid=e.sid,this.userData.data=e,this.text.use(this),this.labelUpdate(e.position,new g.Quaternion,"")}getId(){return this.data.sid}labelVisible(){return!this.filtered&&!this.hidden}updatePose(e,t){return this.labelUpdate(e,t,this.data.text),this}setMaxOpacity(e){this.maxOpacity=e,this.toggleLabel(this.labelVisible())}free(){this.labelAnim.value>0&&this.toggleLabel(!1)}tickAnimations(e){return this.animateLabelOpacity(.5*e),this}toggleLabel(e){this.hidden=!e,this.updateOpacity()}isHidden(){return this.hidden}toggleFiltered(e){e!==this.filtered&&(this.filtered=e,this.updateOpacity())}updateOpacity(){const e=this.labelVisible()?this.maxOpacity:0;this.labelAnim.endValue!==e&&this.labelAnim.modifyAnimation(this.labelAnim.value,e,T.FADE_DURATION)}animateLabelOpacity(e){const t=this.labelAnim.tick(e);Math.min(t,this.maxOpacity)!==this.text.opacity&&(this.text.opacity=t)}labelUpdate(e,t,i){this.text.position.copy(e),this.text.quaternion.copy(t),this.text.text=i}billboard(e,t,i,s,n,o,a){this.text.scaleBillboard(e,t,i,s,n,o,a)}}const A=new M.Vy("label-spawner");class L{constructor(e,t,i){this.map=e,this.maker=t,this.getContainer=i,this.pool=[],this.bindings=[],this.meshesMap=(0,E.y)();const s=e.keys;for(const t of s){const i=e.get(t);this.add(i,t)}this.bindings.push(e.onElementChanged({onAdded:(e,t)=>{this.add(e,t),A.debug("LabelMesh: added:",t)},onRemoved:(e,t)=>{A.debug("LabelMesh: removing:",t);const i=this.meshesMap.get(t);i&&this.free(i)}}))}subscribe(e){return this.meshesMap.onElementChanged(e)}get(e){return this.meshesMap.get(e)}free(e){const t=e.getId(),i=this.meshesMap.get(t);i.free(),this.meshesMap.delete(t),i.removeFromParent(),this.pool.push(i),A.debug("LabelMesh: removed:",i)}add(e,t){const i=this.get(t);if(i)return i;const s=this.pool.shift(),n=this.getContainer(e.layerId,"RoomLabels");if(void 0!==s)return s.use(e),n.add(s),this.meshesMap.set(t,s),s;{const i=new x(this.maker.makeLabel());return i.use(e),n.add(i),this.meshesMap.set(t,i),i}}dispose(){for(const e of this.meshesMap.values)this.free(e),e.text.dispose();this.meshesMap.clear();for(const e of this.pool)e.text.dispose();this.pool.length=0,this.bindings.forEach((e=>e.cancel()))}}var P=i(86866);class R{constructor(e,t,i,s){this.meshes=e,this.cameraData=i,this.screenFilter=s,this.dirty=!0,this.bindings=[],this.pendingMesh=null,this.setDirty=()=>{this.dirty=!0},this.bindings.push(i.onChanged(this.setDirty),t.onChanged(this.setDirty));for(const e of this.meshes.values)e.text.onGeomUpdate(this.setDirty);this.meshes.onElementChanged({onAdded:e=>e.text.onGeomUpdate(this.setDirty)})}dispose(){this.bindings.forEach((e=>e.cancel())),this.bindings.length=0}setPendingMeshId(e){if((!this.pendingMesh||this.pendingMesh.getId()!==e)&&(this.pendingMesh&&(this.pendingMesh.data.removeOnChanged(this.setDirty),this.pendingMesh=null),e)){const t=this.meshes.get(e);t.data.onChanged(this.setDirty),this.pendingMesh=t}}beforeRender(){if(!this.dirty)return;this.dirty=!1;const{position:e,rotation:t,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,n=this.cameraData.zoom(),o=this.cameraData.aspect(),a=(0,P.m9)(64-T.LABEL_SIZE,0,64,.02,.1);for(const r of this.meshes.values)r.isHidden()||(r.updatePose(r.data.position,t),r.billboard(e,t,i,n,s,o,a));this.screenFilter.update();for(const e of this.meshes.values)e.isHidden()||e.toggleFiltered(!this.screenFilter.visible(e.data.sid))}render(e){for(const t of this.meshes)t.tickAnimations(e)}deactivate(){}init(){}activate(){}}var O=i(35341),V=i.n(O),F=i(19968);class B{constructor(e,t,i){this.meshes=e,this.cameraData=t,this.enabled=i,this.tree=new(V()),this.visibleMap={},this._screenPosition=new g.Vector2,this._ndcPosition=new g.Vector3,this._cornerWorldPosition=new g.Vector3,this._cornerScreenPosition=new g.Vector2,this._selectedId=null,this.update=()=>{this.enabled()?(this.visibleMap={},this.updatePositions()):Object.keys(this.visibleMap).length&&(this.visibleMap={})}}visible(e){if(!(e in this.visibleMap))return!1;return e in this.visibleMap}setSelectedMeshId(e){this._selectedId=e}updatePositions(){this.tree.clear(),this.meshes().filter((e=>!e.isHidden())).map((e=>{(0,F.bz)(this.cameraData,e.text.position,this._screenPosition,this._ndcPosition);const{width:t,height:i}=e.text.getUnscaledSize();this._cornerWorldPosition.set(.5*t,-.5*i,0),e.text.updateMatrixWorld(),this._cornerWorldPosition.applyMatrix4(e.text.matrixWorld),(0,F.bz)(this.cameraData,this._cornerWorldPosition,this._cornerScreenPosition);const s=e.getId()!==this._selectedId?this._ndcPosition.z:-999;return this.describeBbox(e.text,this._screenPosition,this._cornerScreenPosition,s)})).sort(((e,t)=>e.depth-t.depth)).forEach((e=>{this.tree.collides(e)||(this.tree.insert(e),this.visibleMap[e.id]=e)}))}describeBbox(e,t,i,s){i.sub(t);const n=i.x,o=i.y;return{id:e.userData.sid,depth:s,minX:t.x-n,minY:t.y-o,maxX:t.x+n,maxY:t.y+o}}}var N=i(14614),k=i(56208),H=i(28475),G=i(73566),_=i(99583),U=i(47737);class W{constructor(e){this.meshes=e,this.initialized=!1,this.pendingMeshId=null,this.selectedMeshId=null,this.dirty=!0,this.bindings=[],this.labelIdVisibility={},this.visibilityFilterEnabled=!1,this.featureEnabled=()=>{if(!this.initialized)return!1;const e=this.appData.phase===N.Jj.PLAYING,t=this.settingsData.tryGetSetting(H.RP,!1),i=this.settingsData.tryGetSetting(k.Q$.Labels,!1)||this.toolsData.activeToolName===G.S0.LABELS,s=e&&t&&i;return this.settingsData.setSetting(H.LZ,s),s},this.visibleByTool=()=>{if(!this.initialized)return!1;const{activeToolName:e}=this.toolsData;return null===e||e===G.S0.LABELS||e===G.S0.PHOTOS||e===G.S0.SEARCH||e===G.S0.LAYERS},this.visibleByViewmode=()=>{const e=this.settingsData.tryGetSetting(k.Q$.LabelsDollhouse,!1)||this.toolsData.activeToolName===G.S0.LABELS,t=this.viewmodeData.isDollhouse()&&e,i=this.viewmodeData.isFloorplan()&&(this.appData.application===N.lg.WORKSHOP&&this.visibleByTool()||this.settingsData.tryGetSetting(k.Q$.Labels,!1)),s=this.viewmodeData.isDollhouse()&&this.settingsData.tryGetSetting(k.Q$.Labels,!1)&&this.cameraData.pose.isPitchFactorOrtho;return i||t||s},this.hiddenByTransition=()=>this.viewmodeData.transitionActive()||this.floorsViewData.transitionActive,this.visibleByFloor=e=>{if(!(this.toolsData.activeToolName===G.S0.LABELS)){const{roomSelectModeActive:e,floorSelectModeActive:t}=this.floorsViewData;if(!e)return!1;if(t)return!1}return this.viewmodeData.isFloorplan()?this.floorsViewData.currentFloor?this.floorsViewData.isCurrentOrAllFloors(e):this.floorsViewData.topFloorId===e:this.floorsViewData.isCurrentOrAllFloors(e)},this.setDirty=()=>{this.dirty=!0}}async init(e){[this.viewmodeData,this.floorsViewData,this.settingsData,this.toolsData,this.appData,this.layersData,this.cameraData]=await Promise.all([e.waitForData(_.X),e.waitForData(h.X),e.waitForData(n.o),e.waitForData(l.M),e.waitForData(N.zH),e.waitForData(U.P),e.waitForData(r.M)]);const t=await e.waitForData(a.B);[this.viewmodeData,this.floorsViewData,this.settingsData,this.toolsData,this.appData,t].forEach((e=>this.bindings.push(e.onChanged(this.setDirty)))),this.bindings.push(this.layersData.onCurrentLayersChanged(this.setDirty),this.cameraData.pose.isPitchFactorOrthoObservable.onChanged(this.setDirty)),this.meshes.onChanged(this.setDirty),this.initialized=!0}dispose(){this.bindings.forEach((e=>e.cancel())),this.bindings.length=0}setVisibilityFilterEnabled(e){this.visibilityFilterEnabled=e,this.setDirty()}updateLabelVisibility(e){this.labelIdVisibility=e.reduce(((e,t)=>(e[t]=!0,e)),{}),this.setDirty()}onUpdate(){if(!this.initialized||!this.dirty)return;this.dirty=!1;const e=this.featureEnabled()&&!this.hiddenByTransition()&&this.visibleByTool()&&this.visibleByViewmode(),t=e=>e.visible&&this.visibleByFloor(e.floorId)&&this.visibleById(e.sid)&&this.layerToggledOn(e.layerId)&&this.layersData.layerVisible(e.layerId);for(const i of this.meshes.values){const s=i.data.sid===this.pendingMeshId||i.data.sid===this.selectedMeshId,n=e&&(s||t(i.data));i.toggleLabel(n)}this.dirtyCb&&this.dirtyCb()}setPendingMeshId(e){this.pendingMeshId=e,this.setDirty()}setSelectedMeshId(e){this.selectedMeshId=e,this.setDirty()}setDirtyCallback(e){this.dirtyCb=e}visibleById(e){return!this.visibilityFilterEnabled||!!this.labelIdVisibility[e]}layerToggledOn(e){return this.appData.application===N.lg.WORKSHOP||this.layersData.layerToggled(e)}}var z=i(53282),j=i(62802),$=i(46793),X=i(13893),q=i(23184),Y=i(31002),Q=i(81544),K=i(35699),Z=i(77510),J=i(27200),ee=i(9997);class te{constructor(e,t,i,s,n,o){this.labelRenderer=e,this.issueCommand=t,this.input=i,this.floorsViewData=s,this.toolsData=n,this.roomNavigationPose=o,this.inputBindings=[],this.appStateBindings=[],this.raycasterRegistrationBindings=[],this.active=!0,this.enabled=!0,this.refresh=()=>{this.shouldBeInteractive!==this.active&&(this.inputBindings.forEach((e=>this.shouldBeInteractive?e.renew():e.cancel())),this.raycasterRegistrationBindings.forEach((e=>this.shouldBeInteractive?e.renew():e.cancel())),this.active=this.shouldBeInteractive)},this.refreshColliders=()=>{for(const e of this.labelRenderer.labelMeshIterator())this.shouldBeInteractive?this.input.registerMesh(e.text.collider,!1):this.input.unregisterMesh(e.text.collider)},this.clearColliders=()=>{for(const e of this.labelRenderer.labelMeshIterator())this.input.unregisterMesh(e.text.collider)},this.inputBindings.push(...this.setupInputBindings()),this.raycasterRegistrationBindings.push(...this.setupRaycasterBindings());const a=this.toolsData.onPropertyChanged("activeToolName",this.refresh),r=this.floorsViewData.makeFloorChangeSubscription(this.refresh),h=this.floorsViewData.onRoomSelectModeChange(this.refresh);this.appStateBindings.push(a,r,h),this.refresh()}toggleInput(e){this.enabled!==e&&(this.enabled=e,this.appStateBindings.forEach((t=>e?t.renew():t.cancel())),this.refresh())}get shouldBeInteractive(){return this.enabled&&null===this.toolsData.activeToolName&&this.floorsViewData.roomSelectModeActive}setupRaycasterBindings(){return[(0,z.Sh)((()=>this.refreshColliders()),(()=>this.clearColliders()),!0,"toggleLabelMeshInput"),this.labelRenderer.subscribe({onAdded:e=>this.input.registerMesh(e.text.collider,!1),onRemoved:e=>this.input.unregisterMesh(e.text.collider)})]}setupInputBindings(){const e=q.f.is((e=>e instanceof b&&e.labelVisible())),t=this.input.registerMeshHandler(Y.rX,e,((e,t)=>{const i=this.labelRenderer.getLabelMesh(t.getId());if(i){const e=i.data.roomId;if(e){const t=this.roomNavigationPose.getPoseForRoom(e,i.data.position);t&&this.issueCommand(new $.S2($.w5.INSIDE,X.fl.Interpolate,t))}else this.issueCommand(new ee.rH({focusPosition:i.data.position,transition:X.fl.Interpolate}))}}));if((0,J.C8)())return[t];let i=null;return[new j.P(this.input.registerMeshHandler(Q.L,e,((e,t)=>{const s=this.labelRenderer.getLabelMesh(t.getId());s&&(s.hoverState.active=!0,s.hoverState.on(),i=s,this.issueCommand(new K.X(Z.b.FINGER)))})),this.input.registerMeshHandler(Q.q,q.f.isType(b),((e,t)=>{i&&this.issueCommand(new K.X(Z.b.DEFAULT));const s=this.labelRenderer.getLabelMesh(t.getId());s&&(s.hoverState.active=!1,s.hoverState.off()),i=null})),(0,z.Sh)((()=>{}),(()=>{i&&(i.hoverState.active=!1,i.hoverState.off(),this.issueCommand(new K.X(Z.b.DEFAULT)),i=null)}),!0,"labelHoverClear")),t]}}var ie=i(81662),se=i(66806);const ne=new M.Vy("room-with-a-view");class oe{constructor(e,t,i){this.sweepData=e,this.roomData=t,this.meshData=i}getPoseForRoom(e,t){const i=this.bestViewForRoom(e,t);if(i){return{rotation:i.rotation,sweepID:i.sweepID,viewmode:se.N.Panorama}}return null}bestViewForRoom(e,t){const i=this.sweepData.filter((t=>t.roomId===e&&t.enabled));if(0===i.length)return ne.debug("no sweeps in selected room",{roomId:e,scansInRoom:i}),null;let s=1;const n=this.roomData.get(e),o=this.meshData.meshGroups.rooms.get(n.meshSubgroup),a=(null==o?void 0:o.boundingBox.getSize(new g.Vector3).length())||1/0;t&&a>10&&(s=.1);const r=i.sort(((i,n)=>{let o=0,a=0;t&&(o=i.position.distanceTo(t),a=n.position.distanceTo(t));const r=i.neighbours.map((e=>this.sweepData.getSweep(e))).filter((t=>t.roomId===e)).length,h=n.neighbours.map((e=>this.sweepData.getSweep(e))).filter((t=>t.roomId===e)).length;return 1*s*(h-r)-3*(a-o)})),h=r[0];if(!h)return ne.debug("no start sweep",{roomId:e,scansInRoom:i,connectedness:r}),null;const l=h.neighbours.map((e=>this.sweepData.getSweep(e))).sort(((t,i)=>{let s=h.position.distanceTo(t.position),n=h.position.distanceTo(i.position);return t.roomId===e&&(s*=1e3),i.roomId===e&&(n*=1e3),n-s})).map((e=>({sweep:e,dist:h.position.distanceTo(e.position),rm:e.roomId}))),d=l[0];ne.warn({roomId:e,roomSize:a,scoring:r,byDistance:l,scansInRoom:i});const c=new g.Quaternion;if(1===i.length&&void 0!==d){const e=(new g.Matrix4).setPosition(h.position);e.lookAt(d.sweep.position,h.position,ie.B1.UP),c.setFromRotationMatrix(e)}else{const e=(new g.Matrix4).setPosition(h.position);e.lookAt(h.position,d.sweep.position,ie.B1.UP),c.setFromRotationMatrix(e)}return{sweepID:h.id,rotation:c}}}var ae=i(74381),re=i(56147),he=i(94547),le=i(15580),de=i(58899),ce=i(84917);class ue extends de.r{constructor(e,t,i,s,n){super(e,t,i),this.editMode=s,this.label=n,this.onSelect=()=>{super.onSelect(),this.editMode||this.commandBinder.issueCommand(new ee.UZ(this.label))},this.id=this.label.sid,this.title=this.label.text,this.icon="icon-toolbar-labels",this.typeId=ae.jM.LABEL,this.floorId=this.label.floorId,this.roomId=this.label.roomId||"",this.layerId=this.label.layerId,this.dateBucket=(0,ce.n)(this.label.created),this.enabled=this.label.visible}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}}const{LABELS:pe}=re.A.SHOWCASE;var me=i(71067);class ge extends s.n{constructor(){super(...arguments),this.name="user-labels",this.labelMeshIterator=()=>this.spawner.meshesMap.values,this.filterVisibleLabels=async e=>{this.visibilityRules.updateLabelVisibility(e.ids)},this.changeVisibilityFilterEnabled=async e=>{this.visibilityRules.setVisibilityFilterEnabled(e.enabled)}}async init(e,t){const[i,s,p,m,g,f,v,y,b,I,E]=await Promise.all([t.market.waitForData(a.B),t.market.waitForData(r.M),t.market.waitForData(h.X),t.market.waitForData(l.M),t.market.waitForData(c.A),t.market.waitForData(u.q),t.market.waitForData(d.U),t.getModuleBySymbol(o.M7),t.getModuleBySymbol(o.mL),t.getModuleBySymbol(o.gS),t.market.waitForData(n.o)]),M=y.getScene(),C=new w({assetBasePath:E.tryGetSetting("assetBasePath",""),lang:I.languageCode});C.setRenderLayer(t.claimRenderLayer("labels")),this.spawner=new L(i.getCollection(),C,((e,t)=>M.getSubTree([e||me.j,t]))),this.visibilityRules=new W(this.spawner.meshesMap),this.visibilityRules.init(t.market),this.bindings.push(t.commandBinder.addBinding(D,this.filterVisibleLabels),t.commandBinder.addBinding(S,this.changeVisibilityFilterEnabled));this.labelFilter=new B(this.labelMeshIterator,s,(()=>this.visibilityRules.featureEnabled()&&this.visibilityRules.visibleByTool())),this.labelRenderer=new R(this.spawner.meshesMap,i.getCollection(),s,this.labelFilter),t.addComponent(this,this.labelRenderer),this.visibilityRules.setDirtyCallback(this.labelRenderer.setDirty);const T=new oe(g,f,v);this.labelNavInput=new te(this,t.commandBinder.issueCommand,b,p,m,T),this.toggleInput(!0),async function(e,t,i){const[s,n,o]=await Promise.all([e.market.waitForData(N.zH),e.market.waitForData(U.P),e.market.waitForData(l.M)]);let a=s.application===N.lg.WORKSHOP;const r=(i,s,o,r=[])=>{const h=[];return 0===r.length&&t.iterate((t=>{(a||t.visible&&n.layerToggled(t.layerId))&&i(t.text)&&h.push(new ue(e.commandBinder,n,s,a,t))})),e.commandBinder.issueCommand(new D(h.map((e=>e.id)))),h.sort(((e,t)=>e.title.localeCompare(t.title)))},h=t=>{e.commandBinder.issueCommand(new S(!!t))},d=e=>new j.P(t.onChanged(e)),c=()=>{e.commandBinder.issueCommandWhenBound(new he.Oc({id:ae.jM.LABEL,groupPhraseKey:pe.SEARCH_GROUP_HEADER,getSimpleMatches:r,registerChangeObserver:d,onSearchActivatedChanged:h,groupOrder:30,groupIcon:"toolbar-labels",batchSupported:!0}))},u=()=>{e.commandBinder.issueCommandWhenBound(new he.tf(ae.jM.LABEL))},p=()=>{a=s.application===N.lg.WORKSHOP;const e=o.activeToolName===G.S0.LABELS,t=i.tryGetSetting(k.Q$.Labels,!1),n=i.tryGetSetting(le.n9,!1),r=i.tryGetSetting(le._z,!1);(t||e)&&(n||r||a)?c():u()},m=[s.onPropertyChanged("application",p),i.onChanged(p),o.onChanged(p)];return p(),new j.P(...m)}(t,i,E).then((e=>this.bindings.push(e)))}dispose(e){super.dispose(e),this.visibilityRules.dispose(),this.spawner.dispose()}getLabelMesh(e){return e&&this.spawner.get(e)||null}addLabelMesh(e,t){return this.spawner.add(e,t)}freeLabelMesh(e){e&&this.spawner.free(e)}setPendingMeshId(e){this.visibilityRules.setPendingMeshId(e),this.labelRenderer.setPendingMeshId(e)}setSelectedMeshId(e){this.labelFilter.setSelectedMeshId(e),this.visibilityRules.setSelectedMeshId(e)}toggleInput(e){this.labelNavInput.toggleInput(e)}subscribe(e){return this.spawner.subscribe(e)}onUpdate(){this.visibilityRules&&this.visibilityRules.onUpdate()}}const fe=ge},18952:(e,t,i)=>{"use strict";i.d(t,{CW:()=>d,yp:()=>u});var s=i(68909),n=i(53172),o=i(19968);const a=new s.Vector2,r=new s.Vector3,h=new s.Vector2,l=new s.Vector2,d=(e,t,i)=>{const s=((e,t,i)=>((0,o.bz)(i,e,h),(0,o.bz)(i,t,l),{pixelDistance:h.distanceTo(l),startScreenPosition:h,endScreenPosition:l}))(e,t,i),n=((e,t,i)=>(r.copy(e).add(t).multiplyScalar(.5),(0,o.bz)(i,r,a),a))(e,t,i);return{screenPosition:n,rotation:c(h,l),pixelDistance:s.pixelDistance,startScreenPosition:s.startScreenPosition,endScreenPosition:s.endScreenPosition}},c=(e,t)=>{const i=e.y-t.y,s=e.x-t.x;let o=Math.atan2(i,s)*n.tm;return o=o>=90||o<=-90?o+180:o,o},u=(e,t=10,i=40)=>({width:Math.max(9*Math.max(e,2)+t,i),height:18+t})},33235:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Group:()=>Ce,Grouper:()=>Me,MeasurementLabelBackgroundMesh:()=>ke,MeasurementLabelRenderer:()=>He,MeasurementLineRenderer:()=>Re,MeasurementModeData:()=>se.s,MeasuringPhase:()=>ie.hb,default:()=>Ti,labelVisible:()=>ie.Vk});var s,n,o=i(64882),a=i(97234),r=i(14614),h=i(4850),l=i(53282);!function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED",e[e.UPDATED=2]="UPDATED",e[e.COUNT=3]="COUNT"}(s||(s={})),function(e){e[e.ADDED=1]="ADDED",e[e.REMOVED=2]="REMOVED",e[e.UPDATED=4]="UPDATED",e[e.ALL=7]="ALL"}(n||(n={}));const d=(e,t)=>{const i=t&n.ADDED,s=t&n.REMOVED,o=t&n.UPDATED,a={};let r;return new l.WC((()=>e),(t=>r=e.onElementChanged((e=>(a.onAdded=i?e:void 0,a.onRemoved=s?e:void 0,a.onUpdated=o?e:void 0,a))(t))),(e=>{r&&r.cancel()}))};var c,u=i(62802),p=i(1284),m=i(9139),g=i(27200),f=i(90082),v=i(71687),y=i(16153),b=i(74381),w=i(77510),I=i(13893),D=i(35699),S=i(39209),E=i(99583),M=i(66806),C=i(68909),T=i(92237);!function(e){e[e.FloorplanOnly=0]="FloorplanOnly",e[e.ThreeD=1]="ThreeD"}(c||(c={}));var x=i(18952),A=i(40160),L=i(93818);const P=new m.Vy("line-data"),R=()=>({lineVisibleByFeatureType:!0,labelVisibleByFeatureType:!0});class O{constructor(e,t,i,s,n,o,a=R){this.cameraModule=e,this.viewmodeData=t,this.floorsViewData=i,this.isCurrentSweepAligned=s,this.getUnits=n,this.isFeatureEnabled=o,this.visibleFilter=a,this.derivedDataCache={},this.dollhouseLineStyle=c.ThreeD,this.setVisibilityFilter=e=>{this.visibleFilter=e},this.resetVisibilityFilter=()=>{this.visibleFilter=R},this.make=(e,t,i)=>{const s=t(),{start_position:n,end_position:o,visible:a,floorId:r,type:h,text:l}=s,d=a&&this.isFeatureEnabled(),c=d&&this.visibleByFloorAndModes(r,h),u=void 0!==i?i.opacity.value:0,p=0===u||u===A.HT.LABEL_HIDDEN_OPACITY&&c;if(i&&p&&(!d||!c))return i;let m=c,g=c;if(c){const t=this.visibleFilter(e);m=m&&t.lineVisibleByFeatureType,g=g&&t.labelVisibleByFeatureType}let f=0;const v=n.distanceTo(o),y=(0,L.R5)(v,this.getUnits());if(g||!p){const{width:e,height:t}=(0,x.yp)(l.length+y.length),i=(0,x.CW)(n,o,this.cameraModule.cameraData);this.tmpVec.copy(i.startScreenPosition).sub(i.endScreenPosition);let s=Math.abs(this.tmpVec.y)<Math.abs(this.tmpVec.x)?t:e;A.HT.ALIGN_LABELS&&(s=e,f=i.rotation),g=g&&i.pixelDistance>s}let b;const w=m&&g?1:m&&!g?A.HT.LABEL_HIDDEN_OPACITY:0;i?(b=i.opacity,b.endValue===w&&m===i.visible&&g===i.labelVisible||b.modifyAnimation(b.value,w,A.HT.FADE_DURATION)):b=new T.z(0,w,A.HT.FADE_DURATION);const I={sid:e,rotation:f,labelVisible:g,visible:m,length:v,displayLength:y,labelContents:l.length>0?`${y} ${l}`:y,opacity:b,layerId:s.layerId};return this.derivedDataCache[e]={getLineData:t,previousDerivedData:I},I},this.update=e=>{if(this.derivedDataCache[e]){const{getLineData:t,previousDerivedData:i}=this.derivedDataCache[e];return this.make(e,t,i)}P.warn(`data not found for ${e}`)},this.get=e=>{if(this.derivedDataCache[e])return this.derivedDataCache[e].previousDerivedData},this.remove=e=>{this.derivedDataCache[e]&&delete this.derivedDataCache[e]},this.clear=()=>{this.derivedDataCache={}},this.visibleByFloorAndModes=(e,t)=>{if(this.floorsViewData.transition.progress.active)return!1;const i=this.viewmodeData.isInside(),s=this.viewmodeData.isFloorplan(),n=this.viewmodeData.isDollhouse()||this.viewmodeData.isExterior(),o=this.cameraModule.cameraData.pose.pitchFactor(),a=this.floorsViewData.currentFloorId,r=!a,h=!(!a||a!==e),l=e===this.floorsViewData.topFloorId,d=t===c.FloorplanOnly&&(s||n&&o<=1e-5)&&(h||l&&r),u=t===this.dollhouseLineStyle&&n&&!(n&&o<=.9)&&(h||r);return t===c.ThreeD&&i&&this.isCurrentSweepAligned()||u||d},this.tmpVec=new C.Vector2}setDollhouseLineStyle(e){this.dollhouseLineStyle=e}}var V=i(78849),F=i(25443),B=i(56208),N=i(23339),k=i(87965),H=i(12837),G=i(3071),_=i(8774),U=i(87951),W=i(5320),z=i(98159),j=i(11165);class $ extends j.u{constructor(e,...t){super(),this.payload={sids:t,visible:e}}}$.id="MEASUREMENTS_SET_VISIBILITY";class X extends j.u{constructor(e,t=""){super(),this.payload={sid:e,text:t}}}X.id="RENAME_MEASUREMENT";class q extends j.u{constructor(e){super(),this.payload=e}}q.id="MEASURE_CONTENTS_REPLACE";class Y extends j.u{constructor(e){super(),this.payload={sids:e}}}Y.id="FILTER_MEASUREMENT_VISIBILITY";class Q extends j.u{constructor(e){super(),this.payload={enabled:e}}}Q.id="MEASUREMENT_VISIBILITY_FILTER_ENABLED";class K extends j.u{constructor(e){super(),this.payload={groupId:e}}}K.id="NAVIGATE_TO_MEASUREMENT";var Z=i(20246),J=i(17084),ee=i(73566),te=i(9360),ie=i(41535),se=i(28454),ne=i(81662),oe=i(53172);var ae;!function(e){e[e.Axes=1]="Axes",e[e.PlanarAxes=2]="PlanarAxes",e[e.EdgesAndPlanarAxes=3]="EdgesAndPlanarAxes",e[e.Edges=4]="Edges",e[e.Free=5]="Free",e[e.Locked=6]="Locked"}(ae||(ae={}));const re={[ne.os.UP]:{dir:Object.freeze(ne.B1.UP.clone())},[ne.os.DOWN]:{dir:Object.freeze(ne.B1.DOWN.clone())},[ne.os.BACK]:{dir:Object.freeze(ne.B1.BACK.clone())},[ne.os.LEFT]:{dir:Object.freeze(ne.B1.LEFT.clone())},[ne.os.RIGHT]:{dir:Object.freeze(ne.B1.RIGHT.clone())},[ne.os.FORWARD]:{dir:Object.freeze(ne.B1.FORWARD.clone())}},he={[ne.os.HORIZONTAL_PLANE]:{dir:Object.freeze(ne.B1.HORIZONTAL_PLANE.clone())}},le=(()=>{let e=0;const t=new C.Vector3,i=new C.Vector3,s=new C.Vector3,n=new C.Vector3,o=999,a=Object.freeze(ne.B1.ZERO.clone()),r=Object.keys(re).map((e=>Object.assign(Object.assign({},re[e]),{name:e,angleTo:o}))),h=Object.keys(he).map((e=>Object.assign(Object.assign({},he[e]),{name:e,angleTo:o}))),l=e=>(e+3)%2;let d=r[0];return(c,u,p=ae.Axes)=>{if(p===ae.Free)return{position:u.clone(),constrainedAxis:a,axisName:ne.os.NONE};if(r.forEach((e=>e.angleTo=o)),h.forEach((e=>e.angleTo=o)),s.copy(u).sub(c),e=s.length(),e<.05)return{position:u.clone(),constrainedAxis:a,axisName:ne.os.NONE};n.copy(s).normalize();const m=.05*Math.min(e,1);if(p!==ae.Locked){for(const e of r){const t=(0,oe.H)(n.angleTo(e.dir));t<d.angleTo&&(d=e),e.angleTo=t}if(d.angleTo>20){const e=Math.abs(s.y);e*e<m&&(d=h[0])}}t.set(c.x*l(d.dir.x),c.y*l(d.dir.y),c.z*l(d.dir.z)),i.set(u.x*Math.abs(d.dir.x),u.y*Math.abs(d.dir.y),u.z*Math.abs(d.dir.z)).add(t);return p===ae.Locked||i.distanceToSquared(u)<m?{position:i.clone(),constrainedAxis:d.dir,axisName:d.name}:{position:u.clone(),constrainedAxis:a,axisName:ne.os.NONE}}})(),de=1081,ce=192,ue=320,pe=128,me={smoothness:.4,perspective:{fov:40,thresholdClose:1,thresholdFar:8,offsetClose:.25,offsetFar:.5,scale:1},ortho:{fov:5,thresholdClose:5,thresholdFar:20,offsetClose:15,offsetFar:30,scale:4}},ge={desktop:ae.Edges,floorplan:ae.Axes,mobile:ae.Edges,alt:ae.Free,shift:ae.PlanarAxes,shiftAlt:ae.EdgesAndPlanarAxes,disabled:ae.Free},fe=.15,ve=.1,ye=.1,be=.5,we=.035,Ie=.025,De="measurements";var Se=i(69304),Ee=i(25712);class Me{constructor(e){this.contents=e,this.groupInfo=[],this.groupIndices=[],this.groupInfoMap={},this.groupIndicesMap={}}startGroup(e){const t=0===this.groupCount,i=this.contents.length!==this.groupIndices[this.groupCount-1];if(t||i){let t=e.sid;if(!t)for(t=(0,Ee.W0)();this.groupInfoMap.hasOwnProperty(t);)t=(0,Ee.W0)();const i=Object.assign(Object.assign({},e),{sid:t});this.groupInfo.push(i),this.groupInfoMap[t]=i,this.groupIndices.push(this.contents.length),this.groupIndicesMap[this.contents.length]=!0}return this.groupIndices.length-1}reset(){this.contents.atomic((()=>{for(let e=this.contents.length-1;e>=0;--e)this.removeFromIdx(e);this.groupIndices=[],this.groupInfo=[],this.groupIndicesMap={}}))}isStartIndex(e){return!!this.groupIndicesMap[e]}*groups(){for(let e=0;e<this.groupCount;++e)yield this.getGroup(e)}*[Symbol.iterator](){for(const e of this.contents)yield e}getGroupStartIndex(e){return this.groupIndices[e]}getGroup(e){const t=this.groupIndices[e],i=this.groupIndices[e+1],s=isNaN(i)?this.contents.length-1:i-1;return new Ce(e,this.contents,t,s,Object.assign({},this.groupInfo[e]))}getGroupById(e){for(let t=0;t<this.groupInfo.length;t++)if(e===this.groupInfo[t].sid)return this.getGroup(t)}indexOfGroup(e){for(let t=0;t<this.groupInfo.length;t++)if(e(this.groupInfo[t]))return t;return-1}updateGroupInfo(e,t){const i=this.groupInfo[e].sid;delete this.groupInfoMap[i];const s=Object.assign({sid:i},t);this.groupInfo.splice(e,1,s),this.groupInfoMap[i]=s}get groupCount(){return this.groupIndices.length}get length(){return this.contents.length}get(e){return this.contents.get(e)}push(e){if(0===this.groupCount)throw Error("Grouper: Error pushing points when we have no groups!");return this.contents.push(e.clone()),this.contents.length}pop(){return this.removeFromIdx(this.contents.length-1)}removeFromIdx(e){if(e<this.contents.length&&e>=0&&this.contents.length>=0){const t=this.contents.get(e);return this.contents.remove(e),this.removeEmptyGroups(),t}}removeEmptyGroups(){this.contents.length<=this.groupIndices[this.groupCount-1]&&this.removeGroup(this.groupCount-1)}groupFromPointIndex(e){if(0>e||e>=this.length)return-1;let t=this.groupCount-1;for(;e<this.groupIndices[t];)--t;return t}removeGroup(e){if(e>this.groupCount||e<0)return;const t=this.getGroup(e);if(0===t.count)return;const i=this.groupIndices[e];this.groupIndices.splice(e,1),this.groupInfo.splice(e,1),delete this.groupInfoMap[t.info.sid],delete this.groupIndicesMap[i];for(let i=e;i<this.groupCount;++i){const e=this.groupIndices[i],s=e-t.count;this.groupIndices[i]=s,delete this.groupIndicesMap[e],this.groupIndicesMap[s]=!0}this.contents.splice(t.startIndex,t.count)}update(e,t){this.contents.update(e,t.clone())}copy(e,t=!0){return t&&this.reset(),this.contents.atomic((()=>{for(const t of e){this.startGroup(t.info);for(const e of t)this.push(e)}})),this}toString(){return`Grouper: { groupCount: ${this.groupCount}, length: ${this.length}, groups: [${[...this.groups()].map((e=>`${e}`))}]}`}}class Ce{constructor(e,t,i,s,n){this.index=e,this.grouper=t,this.startIndex=i,this.endIndex=s,this.data=n}*[Symbol.iterator](){for(let e=0;e<this.count;++e)yield this.get(e)}get(e){if(!this.has(e))throw RangeError(`Out of range error ${e} / ${this.count-1}`);return this.grouper.get(this.startIndex+e)}has(e){return e>=0&&this.startIndex+e<=this.endIndex}get count(){return this.endIndex-this.startIndex+1}get info(){return this.data}get isClosed(){const e=this.grouper.get(this.startIndex),t=this.grouper.get(this.endIndex);return this.count>2&&e.distanceTo(t)<=.001}get length(){let e=0,t=null;for(let i=0;i<this.count;i++)t&&(e+=this.get(i).distanceTo(t)),t=this.get(i);return e}get segmentLengths(){const e=[];let t=null;for(let i=0;i<this.count;i++)t&&e.push(this.get(i).distanceTo(t)),t=this.get(i);return e}hasLength(){const e=this.grouper.get(this.startIndex),t=this.grouper.get(this.endIndex);return e&&t&&(this.isClosed||e.distanceTo(t)>.001)}clone(){const e=[],t={get:t=>e[t],contents:e};for(let e=0;e<this.count;e++)t.contents.push(this.get(e));return new Ce(this.index,t,0,t.contents.length-1,Object.assign({},this.data))}describe(e=this.endIndex){return`GroupSegment${this.index}/${this.startIndex}/${e}}`}equals(e){if(this.count!==e.count||this.index!==e.index)return!1;if((0,Se.E7)(this.info,e.info))return!1;for(let t=0;t<this.count;++t)if(!this.get(t).equals(e.get(t)))return!1;return!0}}var Te,xe=i(56637),Ae=i(46771),Le=i(40397),Pe=i(52943);!function(e){e[e.x=16711680]="x",e[e.y=32768]="y",e[e.z=255]="z",e[e.free=16777215]="free",e[e.xz=16711935]="xz",e[e.laser=16724312]="laser",e[e.yellow=16776960]="yellow",e[e.white=16777215]="white"}(Te||(Te={}));class Re{constructor(e,t,i,s,o,a,r=()=>-1,h,l=16777215){this.points=e,this.createPointSubscription=t,this.cameraModule=i,this.lineModule=s,this.mainLayer=o,this.lineLayer=a,this.selectedGroup=r,this.getLineDetails=h,this.lineColor=l,this.endpointGeometry=(0,xe.Wi)(),this.linePool=[],this.groupToLines={},this.pointToLines={},this.activeLines=[],this.cameraQuaternion=new C.Quaternion,this.cameraPosition=new C.Vector3,this.cameraProjection=new Ae.k,this.getLinesForPoint=e=>{const t=[];if(this.pointToLines[e])for(const i of this.pointToLines[e]){const e=i.getMesh(Pe.Y.line),{startIndex:s,endIndex:n,group:o}=e.userData;t.push({endIndex:n,startIndex:s,line:i,group:o})}return t},this.updateMaterialColors(this.lineColor),this.dataSubs=[this.createPointSubscription(n.REMOVED,((e,t)=>{this.resetLines()}))]}updateMaterialColors(e){const t=A.UP.lineDefault;this.lineMaterial=this.lineModule.makeLineMaterial(e,!0,{linewidth:t}),this.setStencilState(this.lineMaterial),this.endpointMaterial=this.lineModule.makeEndpointMaterial(e);const i={dashed:!0,dashSize:.025,gapSize:.05,linewidth:A.UP.dottedLineDefault};this.dottedLineMaterial=this.lineModule.makeLineMaterial(e,!1,i),this.setStencilState(this.dottedLineMaterial),this.xLineMaterial=this.lineModule.makeLineMaterial(Te.x,!1,i),this.yLineMaterial=this.lineModule.makeLineMaterial(Te.y,!1,i),this.zLineMaterial=this.lineModule.makeLineMaterial(Te.z,!1,i),this.xzLineMaterial=this.lineModule.makeLineMaterial(Te.xz,!1,i)}setStencilState(e){e.stencilRef=1,e.stencilFail=C.KeepStencilOp,e.stencilZFail=C.KeepStencilOp,e.stencilZPass=C.KeepStencilOp,e.stencilFunc=C.GreaterStencilFunc,e.stencilWrite=!0}setLineOpacityByGroup(e,t){const i=this.groupToLines[e];if(i)for(const e of i)e.opacity(t)}setLineOpacityByPoint(e,t){const i=this.getLinesForPoint(e);if(i)for(const e of i)e.line.opacity(t)}resetLines(){for(const e of this.lines)e.opacity(0),e.hide();this.groupToLines={},this.pointToLines={},this.lines.length=0}updateAllLines(){if(!(this.points.length<1)){this.cameraQuaternion.copy(this.cameraModule.cameraData.pose.rotation),this.cameraPosition.copy(this.cameraModule.cameraData.pose.position),this.cameraProjection.copy(this.cameraModule.cameraData.pose.projection);for(let e=0;e<this.points.length;e++)this.updateLine(e);for(const e in this.groupToLines){const t=Number(e),i=this.groupToLines[t];for(const e of i)e.updateSelected(this.selectedGroup()===t)}}}init(){}dispose(){this.deactivate();for(const e of this.linePool)e.dispose();this.endpointGeometry.dispose(),this.dottedLineMaterial.dispose(),this.lineMaterial.dispose(),this.endpointMaterial.dispose(),this.xLineMaterial.dispose(),this.yLineMaterial.dispose(),this.zLineMaterial.dispose()}activate(){for(const e of this.dataSubs)e.renew()}deactivate(){for(const e of this.dataSubs)e.cancel();this.resetLines()}get lines(){return this.activeLines}get dottedMaterial(){return this.dottedLineMaterial}beforeRenderViewport(){this.updateAllLines()}render(){}get xMaterial(){return this.xLineMaterial}get yMaterial(){return this.yLineMaterial}get zMaterial(){return this.zLineMaterial}get xzMaterial(){return this.xzLineMaterial}updateLine(e){const t=this.points.get(e),i=this.points.get(e+1),s=this.points.groupFromPointIndex(e)===this.points.groupFromPointIndex(e+1);t&&i&&s&&this.setLinePosition(e,t,i)}setLinePosition(e,t,i){let s=this.linePool[e];if(!s){const n=this.points.groupFromPointIndex(e),o=this.getLineDetails(n,e,e+1);if(!o.visible)return;const a=A.UP.endpointDefault>.01?this.endpointMaterial.clone():void 0;s=this.lineModule.makeLine(t,i,this.lineMaterial.clone(),a,(()=>!(0,Le.Gp)(this.cameraProjection)),o.layerId),this.setupLine(s,e),s.setRenderLayer(this.mainLayer)}s.visible||this.setupLine(s,e),this.linePool[e]=s,s.updateResolution(this.cameraModule.cameraData.width,this.cameraModule.cameraData.height),s.updatePositions(t,i),s.updateBillboard({rotation:this.cameraQuaternion,position:this.cameraPosition,projection:this.cameraProjection})}setupLine(e,t){const i=this.points.groupFromPointIndex(t),s=this.getLineDetails(i,t,t+1);e.layerId=s.layerId,e.children.forEach((e=>{e.userData.startIndex=t,e.userData.endIndex=t+1,e.userData.group=i,e.layers.mask=this.mainLayer.mask})),e.getMesh(Pe.Y.line).layers.mask=this.lineLayer.mask,this.activeLines.push(e),this.addLineToGroup(i,e),this.addLineToPoint(t,e),this.addLineToPoint(t+1,e),e.show(),e.opacity(0)}addLineToGroup(e,t){this.groupToLines[e]||(this.groupToLines[e]=[]),this.groupToLines[e].push(t)}addLineToPoint(e,t){this.pointToLines[e]||(this.pointToLines[e]=[]),this.pointToLines[e].push(t)}}var Oe=i(3249),Ve=i(19968),Fe=i(31002),Be=i(81544),Ne=i(23184);class ke extends C.Mesh{}class He{constructor(e,t,i,s,n,o,a,r,h,l,d,c,u){this.points=e,this.input=t,this.mobile=i,this.cameraModule=s,this.renderLayer=n,this.renderOrder=o,this.textRenderer=a,this.getLineDetails=r,this.changeCursor=h,this.getPhase=l,this.setSelectedLine=d,this.scene=c,this.depthTextures=u,this.meshPool=[],this.textGeometry=new C.PlaneGeometry(1,1),this.tmpMidpoint=new C.Vector3,this.tmpCamPos=new C.Vector3,this.cameraRotation=new C.Quaternion,this.cameraProjection=new Ae.k,this.cameraPosition=new C.Vector3;this.inputSubs=[this.input.registerMeshHandler(Fe.rX,Ne.f.isType(ke),((e,t)=>{var i,s;if(this.getPhase()===ie.hb.IDLE)return t instanceof C.Object3D?(this.setSelectedLine(null===(s=null===(i=null==t?void 0:t.parent)||void 0===i?void 0:i.userData)||void 0===s?void 0:s.groupIndex),!0):void 0}))],this.mobile||this.inputSubs.push(...this.registerHoverHandlers()),this.setupSplatDepthTexBinding(),this.deactivate(),this.deactivateInteraction()}registerHoverHandlers(){return[this.input.registerMeshHandler(Be.L,Ne.f.isType(ke),(()=>{this.getPhase()===ie.hb.IDLE&&this.changeCursor(w.b.FINGER)})),this.input.registerMeshHandler(Be.q,Ne.f.isType(ke),(()=>{this.changeCursor(w.b.DEFAULT)}))]}reset(){for(const e of this.meshPool)e&&(this.input.unregisterMesh(e.collider),e.removeFromParent());this.depthTexSub.cancel(),this.meshPool=[]}init(){}dispose(){this.textGeometry.dispose()}activate(){this.depthTexSub.renew()}deactivate(){this.reset()}activateInteraction(){for(const e of this.inputSubs)e.renew()}deactivateInteraction(){for(const e of this.inputSubs)e.cancel()}updateDepthTexture(){const e=this.depthTextures.getDepthTexture("splat");for(const t of this.meshPool)t&&t.setFadeDepthTexture(e)}setupSplatDepthTexBinding(){this.updateDepthTexture(),this.depthTexSub=this.depthTextures.onDepthTextureChanged("splat",(()=>this.updateDepthTexture()))}beforeRenderViewport(){const e=this.cameraModule.cameraData,t=e.pose;this.cameraRotation.copy(t.rotation),this.cameraPosition.copy(t.position),this.cameraProjection.copy(t.projection);const i=(0,Le.Rc)(this.cameraProjection),s=(0,Le.Gp)(this.cameraProjection),n=e.height,o=e.zoom(),a=e.aspect();for(let e=1;e<this.points.length;++e){const t=e-1,r=this.points.groupFromPointIndex(e),h=this.getLineDetails(r,t,e);if(!h||r!==this.points.groupFromPointIndex(t)){this.removeLabelMesh(e);continue}const l=this.points.get(t),d=this.points.get(e),c=this.setMeshVisible(e,h.labelVisible,h.layerId);if(!c)continue;c.text!==h.labelContents&&(c.text=h.labelContents);const u=this.cameraPosition.distanceTo(c.position);if(this.updateMeshPose(c,l,d,this.cameraRotation,this.cameraPosition,u,h.rotation,s),s||i)c.scaleFactor=Ie*o;else{const e=(0,Ve.jn)(c.position,this.cameraPosition,this.cameraRotation,this.cameraProjection.asThreeMatrix4()),t=Math.abs(e.x);if(t<1){const e=(0,Le.Nv)(this.cameraProjection,this.cameraPosition,c.position,n,ye),i=((0,Oe.qE)(a,1,2.5)+o)*we,s=1+be-t*be-i;c.scaleFactor=Math.max(Math.min(1/e*s,3),.001)}else c.scaleFactor=.001}}for(let e=this.points.length;e<this.meshPool.length;e++)this.removeLabelMesh(e);this.meshPool=this.meshPool.slice(0,this.points.length)}setTextOpacityByPoint(e,t){const i=this.meshPool[e];i&&(i.opacity=t)}updateMeshPose(e,t,i,s,n,o,a,r){this.tmpMidpoint.copy(t).add(i).multiplyScalar(.5);const h=r?e=>this.tmpCamPos.copy(e).addScaledVector(ne.B1.UP,.15):e=>this.tmpCamPos.copy(n).sub(e).setLength(.15*o).add(e);e.setPosition(this.tmpMidpoint,h),e.setOrientation(s,a)}render(){}setMeshVisible(e,t,i){let s=this.meshPool[e];if(!s&&t){s=this.textRenderer.createLabel(),s.setRenderLayer(this.renderLayer),s.renderOrder=this.renderOrder,s.opacity=1,s.visible=!1,s.setFadeDepthTexture(this.depthTextures.getDepthTexture("splat"));const t=this.points.groupFromPointIndex(e);s.userData.groupIndex=t,(i?this.scene.getSubTree([i,"labels",`${e}`]):this.scene).add(s),s.userData.layerId=i,this.input.registerMesh(s.collider,!1),this.meshPool[e]=s}if(s){s.userData.layerId!==i&&(s.removeFromParent(),(i?this.scene.getSubTree([i,"labels",`${e}`]):this.scene).add(s),s.userData.layerId=i);const n=t?.001:A.HT.LABEL_HIDDEN_OPACITY;if(s.visible=s.opacity>n,!s.visible)return null}return s}removeLabelMesh(e){const t=this.meshPool[e];t&&(t.removeFromParent(),t.dispose(),this.input.unregisterMesh(t.collider),this.meshPool[e]=null)}}var Ge=i(14868);const _e=i.p+"images/scope.svg";var Ue=i(32024),We=i(22299),ze=i(5243),je=i(62916);const $e=i.p+"images/vert_arrows.png",Xe=i.p+"images/surface_grid_planar_256.png";var qe=i(37458);class Ye{constructor(e,t=Ge.H.ALL){this.scene=e,this.layer=t,this.supportsMobile=!0,this.style=je.S.GridPlane,this.alignToNormal=!0,this.xzTex=(0,Ue.y)($e),this.zyTex=(0,Ue.y)(Xe),this.bindings=[],this.onOpacityUpdate=e=>{this.container.children.forEach((t=>{t.isMesh&&(t.material.opacity=Math.max(0,e.opacity.value))}))},this.onPositionUpdate=(e,t)=>{this.container.position.copy(e).addScaledVector(t,.005),this.alignToNormal&&(0,Le.KK)(this.container,e,t)},this.scale=e=>{this.container.scale.set(e,e,e)},this.onRaycasterUpdate=e=>{e.hit&&e.hit.face&&this.onPositionUpdate(e.hit.point.clone(),e.hit.face.normal)},this.container=new C.Group;const i=new C.PlaneGeometry(.4,.4),s={color:16777215,side:C.DoubleSide,transparent:!0,depthTest:!0,depthWrite:!1};this.xzTex.generateMipmaps=!1,this.xzTex.minFilter=C.LinearFilter,this.xzMaterial=new C.MeshBasicMaterial(Object.assign(Object.assign({},s),{color:65280,map:this.xzTex})),this.xzMaterial.premultipliedAlpha=!1;const n=new C.Mesh(i,this.xzMaterial);n.rotateOnAxis(ne.B1.LEFT,Math.PI/2),this.zyTex.generateMipmaps=!1,this.zyTex.minFilter=C.NearestFilter,this.zyMaterial=new C.MeshBasicMaterial(Object.assign(Object.assign({},s),{map:this.zyTex})),this.zyMaterial.premultipliedAlpha=!1;const o=new C.Mesh(i,this.zyMaterial);this.container.add(n,o),this.container.children.forEach((e=>{e.renderOrder=qe.X.reticule,e.layers.mask=this.layer.mask}))}init(){}render(){}dispose(){this.container.children.forEach((e=>{if(e.isMesh){e.geometry.dispose();const t=e.material;t.dispose(),t.map&&t.map.dispose()}}))}async activate(e){const t=await e.market.waitForData(We.J),i=await e.market.waitForData(ze.$);this.bindings.push(t.onChanged(this.onOpacityUpdate),i.onChanged(this.onRaycasterUpdate)),this.scene.add(this.container)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(e){this.container.visible=e}}var Qe=i(35568),Ke=i(86866);class Ze{constructor(e,t,i,s,n,o,a,r,h){this.mobile=e,this.pointer=t,this.cameraModule=i,this.scene=s,this.renderToTexture=n,this.getLayer=o,this.viewportModule=h,this.editing=!1,this.editingStateChange=!1,this.setupCursorRenderCamera=()=>{const e=new C.PerspectiveCamera(me.perspective.fov,1,.1,100);e.name="Cursor Peek Camera";const t=Ge.H.ALL,i=["measurement-mode","measurement3d"];for(const e of i)t.removeLayers(this.getLayer(e));e.layers.mask=t.mask,e.updateProjectionMatrix();return{camera:e,update:(t,i,s)=>{e.fov=t,e.near=i,e.far=s,e.updateProjectionMatrix()}}};const l=(0,Ue.y)(_e),d=new C.Vector2,c=e=>{const t=this.rttView.height,i=this.rttView.width,s=this.viewportModule.viewportManager.activeViewport,n=s.rect.max.y-s.rect.min.y,{x:o,y:a}=e;let r=t/2;const h=-i/2;r=a<t/2+r?t+r:-r;const l=s.rect.min.x+o+h,c=s.rect.min.y+n-a-r;return d.set(l,c)};this.cursorMesh=new Ye(this.scene,this.getLayer("cursor-mesh")),this.cursorMesh.setVisible(!1);const u=new C.Vector3,p=new C.Quaternion,m=new C.Vector2;let g,f,v=a(),y=me.perspective;this.renderIntersection=(e,t,i)=>{g||(f=this.setupCursorRenderCamera(),g=f.camera,f.update(me.perspective.fov,.1,100)),v!==a()&&(y=a()?me.ortho:me.perspective,this.cursorMesh.scale(y.scale),f.update(y.fov,.1,100),v=a());const s=this.editingStateChange?1:me.smoothness;if(t&&!r()){const o=this.viewportModule.viewportManager.activeViewport;if(o.camera.getWorldPosition(u),o.camera.getWorldQuaternion(p),a()){const e=this.cameraModule.cameraData.zoom(),i=(0,Ke.m9)(e,y.thresholdClose,y.thresholdFar,y.offsetClose,y.offsetFar);g.position.copy(t.point).addScaledVector(ne.B1.UP,i),g.quaternion.copy(p)}else{const e=(0,Ke.m9)(t.distance,y.thresholdClose,y.thresholdFar,y.offsetClose,y.offsetFar),i=u.clone().sub(t.point).setLength(e).add(t.point);g.position.lerp(i,s),g.lookAt(t.point)}g.updateMatrixWorld();const r=this.scene.scene;n.render(e,r,g),m.lerp(c(i),s);const h=!1;n.renderToScreen(e,h,m,l)}this.editingStateChange=!1}}init(){}dispose(){}activate(){this.scene.addChild(Qe.o.Root,this.cursorMesh.container);const e=this.mobile?pe:this.cameraModule.cameraData.height>de?ue:ce;this.rttView=this.renderToTexture.createRenderTarget2D(e,e,{format:C.RGBAFormat},!1)}setMeasuringPhase(e){const t=this.mobile?!!ie.TI.mobile[e]:!!ie.TI.desktop[e];t!==this.editing&&(this.editingStateChange=!0,this.editing=t,this.cursorMesh.setVisible(this.editing))}deactivate(){this.scene.removeChild(Qe.o.Root,this.cursorMesh.container),this.renderToTexture.disposeRenderTarget2D(this.rttView),this.editing=!1}beforeRender(e){this.intersect()}intersect(){if(this.editing){const e=this.mobile?this.pointer.lastIntersection:this.pointer.getIntersection();if(e){this.cursorMesh.onPositionUpdate(e.point.clone(),e.normal);const{screenPosition:t}=(0,Ve.bz)(this.cameraModule.cameraData,e.point.clone());this.renderIntersection(this.rttView,e,t)}}}render(){}}var Je,et=i(5894),tt=i(83075),it=i(5984),st=i(52947);!function(e){e[e.SnapPoint=1]="SnapPoint",e[e.SnapLine=2]="SnapLine",e[e.AxisAny=3]="AxisAny",e[e.AxisX=4]="AxisX",e[e.AxisY=5]="AxisY",e[e.AxisZ=6]="AxisZ",e[e.Mesh=7]="Mesh",e[e.RoomMesh=8]="RoomMesh",e[e.LinePoint=9]="LinePoint",e[e.LineSegment=10]="LineSegment"}(Je||(Je={}));class nt extends st.cF{constructor(e,t,i){super(e,t),this.featureType=i}}class ot extends st.cF{constructor(e,t,i){super(e,t),this.featureType=i}}const at={[ne.os.UP]:Je.AxisY,[ne.os.DOWN]:Je.AxisY,[ne.os.FORWARD]:Je.AxisZ,[ne.os.BACK]:Je.AxisZ,[ne.os.LEFT]:Je.AxisX,[ne.os.RIGHT]:Je.AxisX,[ne.os.HORIZONTAL_PLANE]:Je.AxisY,NONE:void 0};var rt;!function(e){e[e.UserAxis=1]="UserAxis",e[e.UserPoint=2]="UserPoint",e[e.UserLine=3]="UserLine",e[e.ModelFeature=4]="ModelFeature"}(rt||(rt={}));const ht={[Je.LinePoint]:rt.UserPoint,[Je.LineSegment]:rt.UserLine,[Je.AxisAny]:rt.UserAxis,[Je.AxisX]:rt.UserAxis,[Je.AxisY]:rt.UserAxis,[Je.AxisZ]:rt.UserAxis,[Je.Mesh]:rt.ModelFeature,[Je.RoomMesh]:rt.ModelFeature,[Je.SnapLine]:rt.ModelFeature,[Je.SnapPoint]:rt.ModelFeature};var lt=i(45979);class dt{constructor(e,t,i,s){this.constraint=t,this.meshQuery=i,this.point=new C.Vector3,this.normal=new C.Vector3,ct(e,i)?this.updateFromIntersection(e,t):ut(e,i)&&s&&this.updateFromSnapIntersection(e,t,s),this.source=e}updatePoint(e){return this.point.copy(e),this.source.point.copy(e),this}updateFromIntersection(e,t){return this.source=e,this.updateContents(t,e.point,e.face.normal,e.distance,e.object),this}updateFromSnapIntersection(e,t,i){return this.source=e,this.updateContents(t,e.point,i,e.distance,e.object),this}copy({constraint:e,point:t,normal:i,distance:s,object:n}){this.updateContents(e,t,i,s,n)}clone(){return new dt(this.source,this.constraint,this.meshQuery)}updateContents(e,t,i,s,n){this.constraint=e,this.point.copy(t),this.normal.copy(i),this.distance=s,this.object=n;const o=this.meshQuery.roomIdFloorIdFromObject(n);o&&(this.roomId=o.roomId||null,this.floorId=o.floorId,this.layerId=o.layerId),this.featureType=(e=>{if(e)return"featureType"in e&&void 0!==e.featureType?e.featureType:e instanceof C.Vector3||e instanceof st.F7?Je.SnapPoint:tt.m.isRoomMesh(e)?Je.RoomMesh:e instanceof it.r?Je.Mesh:e instanceof C.Line3||e instanceof st.cF?Je.SnapLine:void 0})(n)}}const ct=(e,t)=>e&&"face"in e&&void 0!==e.face&&(t.floorIdFromObject(e.object)||e.object.floorId),ut=(e,t)=>e&&"isLineOctreeIntersection"in e&&t.floorIdFromObject(e.object),pt=(()=>{class e extends C.Object3D{constructor(e,t,i,s,n){super(),this.floorId=e,this.roomId=t,this.meshGroup=i,this.meshSubGroup=s,this.sourceViewId=n}}return(t,i,s,n,o,a,r,h)=>({point:t,object:new e(n,o,a,r,h),face:{a:0,b:1,c:2,normal:i,materialIndex:0},distance:s})})();var mt=i(6687),gt=i(94790),ft=i(46957);class vt extends C.Mesh{constructor(e,t,i,s,n,o,a,r,h,l,d,c){super(),this.pointGroups=e,this.input=t,this.cameraData=i,this.mobile=s,this.changeCursor=n,this.getPhase=o,this.changePhase=a,this.restorePreviousPhase=r,this.setSelectedLine=h,this.getSelected=l,this.onDragStart=d,this.onDragEnd=c,this.inputSubscriptions=[],this.groupVisible=[],this.raycast=(()=>{const e=new C.Vector3,t=new C.Vector3,i=new C.Vector3,s=(e,t,i)=>{if(e.isOrtho())return i.copy(t);{const s=A.HT.OFFSET_TOWARDS_CAMERA;return i.copy(e.position).sub(t).setLength(s).add(t)}};return(n,o)=>{const{pose:a,width:r}=this.cameraData,h=this.mobile?3:-2,l=A.UP.lineDefault+h,d=a.projection.asThreeMatrix4(),c=a.position;let u,p=0,m=0;for(let o=0;o<this.pointGroups.groupCount;++o){const h=this.pointGroups.getGroup(o);if(!(void 0!==this.editingGroup&&this.editingGroup!==o)&&this.groupVisible[o]){for(let g=0;g<h.count-1;++g){const f=s(a,h.get(g),t),v=s(a,h.get(g+1),i);if(f&&v){const t=n.ray.distanceSqToSegment(f,v,void 0,e),i=c.distanceTo(e);let s=(0,Le.ff)(i,d,r)*l;if(s*=s,t<s){let i,a=e;this.editingPointIndex?i=this.editingPointIndex:f.distanceToSquared(e)<2*s?(i=m,a=f):v.distanceToSquared(e)<2*s&&(i=m+1,a=v),(!u||t<p)&&(u={distance:n.ray.origin.distanceTo(a),point:a,object:this,instanceId:o,index:i},p=t)}}m++}m++}else m+=h.count}u&&o.push(u)}})(),this.inputSubscriptions.push(...this.registerCommonInput()),s||this.inputSubscriptions.push(...this.registerHoverInput()),this.deactivate()}activate(){this.input.registerMesh(this,!1),this.inputSubscriptions.forEach((e=>e.renew()))}deactivate(){this.input.unregisterMesh(this),this.inputSubscriptions.forEach((e=>e.cancel()))}dispose(){this.deactivate()}setEditingGroup(e){this.editingGroup=e}setGroupVisible(e,t){this.groupVisible[e]=t}validJoint(e){return!!e&&void 0!==e.index}registerHoverInput(){return[this.input.registerMeshHandler(Be.L,Ne.f.isType(vt),((e,t,i)=>{this.getPhase()===ie.hb.IDLE&&this.changeCursor(i&&void 0!==i.index?w.b.GRAB:w.b.FINGER)})),this.input.registerMeshHandler(Be.q,Ne.f.isType(vt),((e,t,i)=>{this.getPhase()===ie.hb.IDLE&&this.changeCursor(w.b.DEFAULT)}))]}registerCommonInput(){return[this.input.registerMeshHandler(Fe.rX,Ne.f.isType(vt),((e,t,i)=>{if(!(0,ft.d)(e))return!1;if(this.getPhase()!==ie.hb.IDLE)return!1;const s=i&&void 0!==i.instanceId?i.instanceId:-1,n=this.getSelected()===s?-1:s;return this.setSelectedLine(n),!0})),this.input.registerMeshHandler(gt.jF,Ne.f.isType(vt),((e,t,i)=>!!(0,ft.d)(e)&&(!!ie.nm[this.getPhase()]&&(!this.validJoint(i)||(!i||void 0===i.instanceId||(this.getPhase()===ie.hb.EDITING||(this.editingPointIndex=i.index,this.onDragStart(i.instanceId),this.setSelectedLine(i.instanceId),this.changePhase(ie.hb.EDITING),this.mobile||this.changeCursor(w.b.GRABBING)),!0)))))),this.input.registerMeshHandler(gt._w,Ne.f.isType(vt),((e,t,i)=>this.getPhase()===ie.hb.EDITING&&(this.editingPointIndex=void 0,this.restorePreviousPhase(),this.onDragEnd(),this.mobile||this.changeCursor(w.b.DEFAULT),!0)))]}}const yt=new m.Vy("snapping");class bt{constructor(e,t,i,s,n,o,a){this.raycaster=e,this.getConstraintStyle=t,this.floorsViewData=s,this.viewmodeData=n,this.meshQuery=o,this.cameraPoseData=a,this.origin=null,this.planeNormal=new C.Vector3,this.plane=new C.Plane,this.ray=new C.Ray,this.originChangedListeners=[],this.registeredSnapFeatures={[rt.UserAxis]:[],[rt.UserLine]:[],[rt.UserPoint]:[],[rt.ModelFeature]:[]},this.clearOrigin=()=>{this.origin=null,this.originChangedListeners.forEach((e=>e(null)))},this.setOrigin=(e,t=!1)=>{this.origin&&!t||(this.origin=e,this.plane.setFromNormalAndCoplanarPoint(this.origin.normal,this.origin.point),this.originChangedListeners.forEach((e=>e(this.origin))),yt.debug("Updating origin",this.origin,{forceUpdate:t}))},this.setOriginFromPointer=e=>{if(this.origin)return;const t=this.getMeshIntersection();if(!t)return;const i=new dt(t,this.getConstraintStyle(),this.meshQuery);e&&i.updatePoint(e),this.setOrigin(i,!0)},this.snapFeatures=e=>this.registeredSnapFeatures[e].reduce(((e,t)=>e.concat(t.features)),[]),this.addSnapFeatures=(e,t,i)=>{const s=ht[t];this.registeredSnapFeatures[s].push({owner:e,features:i}),yt.debug(`Adding ${i.length} snap feature groups`,Je[t],t)},this.removeSnapFeatures=(e,t)=>{const i=ht[t],s=this.registeredSnapFeatures[i].findIndex((t=>t.owner===e));if(-1!==s){const e=this.registeredSnapFeatures[i].splice(s,1);yt.debug(`Removing ${e.length} snap feature groups`,Je[t],t)}else yt.debug(`removeTemporarySnapFeature: ${t} ${Je[t]} not found from`,e,this.registeredSnapFeatures)},this.filters={nop:e=>!0,isNotMeasurementInput:e=>!(e instanceof vt),meshVisible:e=>!!(e instanceof lt.z&&e.visible)||!!(0,mt.dW)(e)&&(!this.viewmodeData.isDollhouse()||this.floorsViewData.isCurrentMeshGroupOrAllFloors(e.meshGroup)),visibleFloor:e=>{const t=e.object;return!t||!t.meta||null==t.meta.meshGroup||this.floorsViewData.isCurrentMeshGroupOrAllFloors(t.meta.meshGroup)},userPoints:e=>{if(void 0===e.object)return!1;if((t=e.object)&&t instanceof C.Vector3)for(const t of this.snapFeatures(rt.UserPoint))if(t.equals(e.object))return!0;var t;return!1},userLines:e=>{if(void 0===e.object)return!1;if((t=e.object)&&"isSnapAxisLine3"in t||"isSnapUserLine3"in t||"isSnapLine3"in t||"start"in t&&"end"in t&&"closestPointToPoint"in t){for(const t of this.snapFeatures(rt.UserLine))if(t.equals(e.object))return!0;for(const t of this.snapFeatures(rt.UserAxis))if(t.equals(e.object))return!0}var t;return!1},userFeatures:e=>this.filters.userPoints(e)||this.filters.userLines(e)},this.meshSnapRadius=i?fe:ve}preload(){this.raycaster.snapping.preloadMeshSnapping()}getMeshIntersection(e){let t=[];const i=this.viewmodeData.isFloorplan()||this.viewmodeData.isDollhouse()&&this.cameraPoseData.pitchFactor()<.01;if(e&&e.origin&&e.normal)t=this.raycaster.picking.cast(e.origin,e.normal,this.filters.meshVisible);else if(i){const e=this.floorsViewData.getHighestVisibleFloor(),i=new C.Vector3(0,1,0),s=(new C.Plane).setFromNormalAndCoplanarPoint(i,new C.Vector3(0,e.boundingBox.max.y,0)),n=new C.Vector3;if(this.raycaster.pointer.pointerRay.intersectPlane(s,n)){const s=this.raycaster.pointer.pointerRay.origin.distanceTo(n);t=[pt(n,i,s,e.id,null,e.meshGroup,null,this.floorsViewData.sourceViewId)]}}else t=this.raycaster.pointer.cast(this.filters.meshVisible);const s=t[0];return ct(s,this.meshQuery)||(n=s)&&"face"in n&&void 0!==n.face&&n.object instanceof lt.z?s:null;var n}getIntersection(e){const t=this.getMeshIntersection(e);if(!t)return null;this.cachedHit||(this.cachedHit=new dt(t,this.getConstraintStyle(),this.meshQuery));const i=this.cachedHit.updateFromIntersection(t,this.getConstraintStyle()),s=this.raycaster.pointer.pointerRay;this.ray.set(s.origin,s.direction),this.planeNormal.copy(i.normal);switch(this.getConstraintStyle()){case ae.Free:return i;case ae.Axes:return this.lockToWorldAxes(i);case ae.PlanarAxes:const e=[...this.snapFeatures(rt.UserAxis),...this.snapFeatures(rt.UserLine),...this.snapFeatures(rt.UserPoint)];return this.softSnapToEdges(i,e,this.filters.userFeatures);case ae.Edges:const t=[...this.snapFeatures(rt.UserLine),...this.snapFeatures(rt.UserPoint)];return this.softSnapToEdges(i,t,this.filters.visibleFloor);case ae.EdgesAndPlanarAxes:const s=[...this.snapFeatures(rt.UserAxis),...this.snapFeatures(rt.UserLine),...this.snapFeatures(rt.UserPoint)];return this.softSnapToEdges(i,s,this.filters.visibleFloor)}return i}get lastIntersection(){return this.cachedHit}onOriginChanged(e,t=!1){const i={renew:()=>{this.originChangedListeners.push(e)},cancel:()=>{(0,et.Nz)(this.originChangedListeners,e)}};return t&&i.renew(),i}lockToWorldAxes(e){if(this.origin){const t=le(this.origin.point,e.point,ae.Axes);return this.cachedHit.copy(e),this.cachedHit.point.copy(t.position),this.cachedHit.constraint="NONE"!==t.axisName?ae.Axes:ae.Free,this.cachedHit.featureType=at[t.axisName],this.cachedHit}return e}softSnapToEdges(e,t,i){const s=this.origin?this.origin.point:e.point,n=this.origin?this.origin.normal:e.normal;this.raycaster.snapping.add(...t);const o=this.raycaster.snapping.cast(this.ray,this.meshSnapRadius,s,n).filter(i),a=this.findClosestVisible(o);return this.raycaster.snapping.remove(...t),a?(this.cachedHit.updateFromSnapIntersection(a,this.getConstraintStyle(),n),this.cachedHit):e}findClosestVisible(e){let t=null;const i=new C.Vector3;for(const s of e){i.copy(s.point).sub(this.ray.origin).normalize();const e=this.raycaster.picking.pick(this.ray.origin,i,this.filters.meshVisible);if(!e||e.distance>s.distance-.05){t=s;break}}return t?{isLineOctreeIntersection:!0,distance:t.distance,distanceToRay:t.distanceToRay,point:t.point,object:t.object}:null}}var wt=i(64200);class It{constructor(e,t,i,s){this.points=e,this.createPointSubscription=t,this.pointer=i,this.mobileCreateHackJob=s,this.subscriptions=[],this.lineSegments=[],this.updateSnapping=e=>{this.lineSegments.length>0&&(this.pointer.removeSnapFeatures(this,Je.LineSegment),this.lineSegments.length=0);for(let t=0;t<this.points.length;t++)if(t!==e&&t!==e-1&&t!==e+1&&!this.points.isStartIndex(t)){const e=this.points.get(t),i=this.points.get(t-1);this.lineSegments.push(new ot(i,e,Je.LineSegment))}this.lineSegments.length>0&&this.pointer.addSnapFeatures(this,Je.LineSegment,this.lineSegments)}}init(){}dispose(){}activate(e){let t=-1,i=-1;const s=(0,wt.s)((()=>this.updateSnapping(this.points.length)),16);this.subscriptions.push(this.createPointSubscription(n.ADDED,s,!0),this.createPointSubscription(n.REMOVED,s,!0),this.createPointSubscription(n.UPDATED,((e,s)=>{s===t||this.mobileCreateHackJob()&&s===i||(this.updateSnapping(s),i=t,t=s)}),!0))}deactivate(){this.subscriptions.forEach((e=>e.cancel())),this.subscriptions.length=0,this.pointer.removeSnapFeatures(this,Je.LinePoint),this.pointer.removeSnapFeatures(this,Je.LineSegment)}beforeRender(){}render(){}}var Dt=i(72268);class St{constructor(e,t,i,s,n,o){this.points=e,this.pointer=i,this.getPhase=s,this.onDrag=n,this.onDragEnd=o,this.inputSubscriptions=[],this.dragging=!1,this.onDragBegin=(e,t,i)=>{if(!ie.y_[this.getPhase()])return!1;if(!i||void 0===i.index)return!1;this.dragging=!0;const s=this.points.isStartIndex(i.index)?i.index+1:i.index-1,n=this.points.get(s);return this.pointer.clearOrigin(),this.pointer.setOriginFromPointer(n),!0},this.onDragEndEvent=()=>!!ie.y_[this.getPhase()]&&(!!this.dragging&&(this.onDragEnd(),this.pointer.clearOrigin(),this.dragging=!1,!0)),this.onDragEvent=(e,t,i)=>{if(e.buttons!==Dt.O.PRIMARY)return!1;if(!ie.y_[this.getPhase()])return!1;if(!i||void 0===i.index||void 0===i.instanceId)return!1;const s=this.pointer.getIntersection();return s&&this.points.update(i.index,s.point),this.onDrag(i.instanceId),!0},this.inputSubscriptions.push(t.registerMeshHandler(gt.SK,Ne.f.isType(vt),this.onDragBegin),t.registerMeshHandler(gt.jF,Ne.f.isType(vt),this.onDragEvent),t.registerMeshHandler(gt._w,Ne.f.isType(vt),this.onDragEndEvent)),this.deactivate()}activate(){for(const e of this.inputSubscriptions)e.renew()}deactivate(){for(const e of this.inputSubscriptions)e.cancel()}}var Et=i(78079);class Mt{constructor(e,t,i,s,n,o,a){this.lines=e,this.getLinesForPoint=t,this.editingMaterial=i,this.createPointSubscription=s,this.getPhase=o,this.getSelected=a,this.bindings=[],this.onDragEnd=e=>{for(const e of this.lines)e.restoreLineMaterial()},this.onClick=(e,t,i)=>{if(this.getPhase()!==ie.hb.IDLE)return!1;for(const e of this.lines)e.restoreLineMaterial();if(!i||void 0===i.index)return!1;if(e.down){const e=i.index;void 0!==e&&this.styleLines(e)}return!1},this.styleLines=e=>{const t=this.getLinesForPoint(e);for(const e of t)e.group===this.getSelected()&&e.line.overrideLineMaterial(this.editingMaterial)},this.bindings.push(n.registerMeshHandler(Et.CD,Ne.f.isType(vt),this.onClick),n.registerUnfilteredHandler(gt._w,this.onDragEnd),...this.setupLineStyler(this.createPointSubscription)),this.deactivate()}activate(){for(const e of this.bindings)e.renew()}deactivate(){for(const e of this.bindings)e.cancel()}setupLineStyler(e){return[e(n.ADDED,(()=>{const e=this.lines[this.lines.length-1];e&&e.restoreLineMaterial()}),!0),e(n.UPDATED,((e,t)=>{this.styleLines(t)}),!0)]}}var Ct=i(18633),Tt=i(79875);class xt{constructor(e,t,i,s,n,o,a,r,h,l){this.points=e,this.setSelected=t,this.pointer=i,this.changePhase=s,this.getPhase=n,this.isFloorplan=o,this.currentFloorId=a,this.currentRoomId=r,this.currentLayerId=h,this.inferRoomAssociation=l,this.id=xt,this.onGroupCreated=e=>null,this.onGroupAddPoint=()=>null,this.onDone=()=>null,this.onEdit=e=>null,this.previousPhase=ie.hb.IDLE,this.currentLinePoints=0,this.previousPoint=new C.Vector3,this.inputSubscriptions=[],this.log=new m.Vy("measurement-creator"),this.isReadonly=!1,this.createNewLine=e=>{const t=this.inferRoomAssociation(e),i=e.roomId||t.roomId||this.currentRoomId()||void 0,s=e.floorId||t.floorId||this.currentFloorId(),n=t.layerId||this.currentLayerId();if(this.log.debug(`Starting measurement: floorId="${s}" roomId="${i}"`),!s)throw new Tt.v(`Cannot create new line on invalid floor '${s}'`);const o={visible:!0,roomId:i,floorId:s,type:this.isFloorplan()?c.FloorplanOnly:c.ThreeD,text:"",created:new Date,modified:new Date,temporary:this.isReadonly,layerId:n},a=this.points.startGroup(o);this.currentGroup=a,this.points.push(e.point),this.currentLinePoints=1,this.setSelected(a);const r=this.points.getGroup(a);this.onGroupCreated(r.info.sid),this.pointer.setOrigin(e,!0)},this.addPointToLine=e=>{this.previousPoint.copy(e.point),this.points.push(e.point),++this.currentLinePoints,this.onGroupAddPoint(),this.pointer.setOrigin(e,!0)},this.updateLastPoint=e=>{this.points.update(this.points.length-1,e.point)},this.getIntersection=()=>this.pointer.getIntersection(),this.setPhase=e=>{const t=this.getPhase();e!==t&&(this.previousPhase=t,this.changePhase(e))},this.restorePreviousPhase=()=>{this.setPhase(this.previousPhase)}}start(){if(this.getPhase()===ie.hb.IDLE){this.previousPoint.set(1e3,1e3,1e3),this.setPhase(ie.hb.CREATING),this.setSelected(-1);for(const e of this.inputSubscriptions)e.renew()}}cancelSubs(){for(const e of this.inputSubscriptions)e.cancel()}stop(){this.cancelSubs(),this.currentLinePoints=0,this.setSelected(-1),this.setPhase(ie.hb.IDLE),this.pointer.clearOrigin(),this.onDone()}syncReadonly(e){this.isReadonly=e}}class At extends xt{constructor(e,t,i,s,n,o,a,r,h,l,d,c,u,p,m){super(e,t,s,n,h,d,c,u,p,m),this.setCreatePointProgress=o,this.updateCreatePointHit=a,this.toggleCameraMovement=r,this.continuous=l,this.onLongPressSuccess=e=>{this.log.debug("onLongPressSuccess while in phase:",ie.hb[this.getPhase()]),this.getPhase()===ie.hb.CREATING?(this.createNewLine(e),this.addPointToLine(e)):this.getPhase()===ie.hb.CREATING_NEXT_POINT&&(this.continuous()?(this.updateLastPoint(e),this.addPointToLine(e)):this.updateLastPoint(e)),this.setPhase(ie.hb.POINT_PLACED)},this.onLongPressStart=e=>{if(e.buttons===Dt.O.PRIMARY&&(this.getPhase()===ie.hb.CREATING||this.getPhase()===ie.hb.CREATING_NEXT_POINT)){const e=this.getIntersection();e&&(this.previousPoint.equals(e.point)||(this.setPhase(ie.hb.CONFIRMING_POINT),this.toggleCameraMovement(!1),this.setCreatePointProgress(Date.now(),At.longPressCreateThreshold),this.updateCreatePointHit(e),this.previousPhase===ie.hb.CREATING_NEXT_POINT&&(this.updateLastPoint(e),this.toggleLastPointDraggable(!1)),this.creatingPointTimeout=window.setTimeout((()=>{this.restorePreviousPhase(),this.onLongPressSuccess(e),this.toggleLastPointDraggable(!0)}),At.longPressCreateThreshold)))}},this.onLongPressEnd=()=>{this.getPhase()===ie.hb.CONFIRMING_POINT&&(this.log.debug("onLongPressEnd, cancelling confirmation"),this.setCreatePointProgress(0,At.longPressCreateThreshold),window.clearTimeout(this.creatingPointTimeout),this.toggleCameraMovement(!0),this.restorePreviousPhase()),this.getPhase()===ie.hb.CREATING_NEXT_POINT&&this.points.update(this.points.length-1,this.points.get(this.points.length-2)),this.setPlacedtoCreatePhase()},this.onDrag=()=>{const e=this.getIntersection();e&&(this.setPlacedtoCreatePhase(),this.setPhase(ie.hb.EDITING),this.previousPhase===ie.hb.CREATING_NEXT_POINT?this.updateLastTwoPoints(e):this.previousPhase===ie.hb.CREATING&&this.updateLastPoint(e))},this.onDragEnd=()=>{this.getPhase()===ie.hb.EDITING&&this.restorePreviousPhase(),this.getPhase()!==ie.hb.CREATING&&this.getPhase()!==ie.hb.CREATING_NEXT_POINT||(this.toggleLastPointDraggable(!1),this.toggleCameraMovement(!0))},this.toggleLastPointDraggable=e=>{e?(this.dragSub.renew(),this.dragEndSub.renew()):(this.dragSub.cancel(),this.dragEndSub.cancel())},this.updateLastTwoPoints=e=>{this.points.update(this.points.length-1,e.point),this.points.update(this.points.length-2,e.point)},this.dragSub=i(gt.jF,this.onDrag),this.dragEndSub=i(gt._w,this.onDragEnd),this.inputSubscriptions.push(i(Ct.OR,this.onLongPressStart),i(Ct.vp,this.onLongPressEnd),i(Fe.wR,(e=>e.preventDefault()))),this.dragSub.cancel(),this.dragEndSub.cancel(),this.cancelSubs()}start(){super.start()}stop(){if(this.getPhase()===ie.hb.CREATING_NEXT_POINT)if(this.continuous())this.points.pop();else{const e=this.points.getGroup(this.currentGroup);this.points.removeFromIdx(e.startIndex)}super.stop()}setPlacedtoCreatePhase(){this.getPhase()===ie.hb.POINT_PLACED&&(this.continuous()?(this.previousPhase===ie.hb.CREATING||this.previousPhase===ie.hb.CREATING_NEXT_POINT)&&this.setPhase(ie.hb.CREATING_NEXT_POINT):this.previousPhase===ie.hb.CREATING?this.setPhase(ie.hb.CREATING_NEXT_POINT):this.previousPhase===ie.hb.CREATING_NEXT_POINT&&this.setPhase(ie.hb.CREATING))}}At.longPressCreateThreshold=500;class Lt extends xt{constructor(e,t,i,s,n,o,a,r,h,l,d,c,u){super(e,t,s,n,o,a,r,h,l,c),this.continuous=d,this.meshQuery=u,this.onCreate=e=>{const t=this.previousPoint.distanceTo(e.point)>.01;if(this.getPhase()===ie.hb.CREATING)return this.createNewLine(e),this.addPointToLine(e),void this.setPhase(ie.hb.CREATING_NEXT_POINT);t&&this.getPhase()===ie.hb.CREATING_NEXT_POINT&&(this.continuous()?(this.updateLastPoint(e),this.addPointToLine(e)):this.finishLine(e))},this.onMouseMove=()=>{if(this.getPhase()===ie.hb.CREATING_NEXT_POINT){const e=this.getIntersection();e&&this.updateLastPoint(e)}},this.onMouseClick=e=>{if(e.button!==Dt.m.PRIMARY||this.getPhase()===ie.hb.IDLE)return;const t=this.getIntersection();t&&this.onCreate(t)},this.onDoubleClick=e=>{if(e.preventDefault(),e.button!==Dt.m.PRIMARY||this.getPhase()===ie.hb.IDLE)return;const t=this.getIntersection();if(t&&2===this.currentLinePoints){const e={origin:t.point.addScaledVector(t.normal,.05),normal:t.normal},i=this.pointer.getMeshIntersection(e);if(i)if(this.continuous()){this.points.pop();const e=new dt(i,ae.Free,this.meshQuery);this.addPointToLine(e),this.addPointToLine(e),this.setPhase(ie.hb.CREATING_NEXT_POINT)}else this.finishLine(new dt(i,ae.Free,this.meshQuery))}},this.inputSubscriptions.push(i(Et.$3,this.onMouseMove),i(Fe.rX,this.onMouseClick),i(Fe.wR,this.onDoubleClick)),this.cancelSubs()}start(){super.start()}stop(){this.getPhase()===ie.hb.CREATING_NEXT_POINT&&(this.points.pop(),this.currentLinePoints<3&&this.points.pop()),super.stop()}finishLine(e){this.points.pop(),this.addPointToLine(e),this.setPhase(ie.hb.CREATING),this.onDone()}}var Pt=i(3694),Rt=i(60043),Ot=i(28337),Vt=i(71397),Ft=i(41837);class Bt{constructor(e,t,i,s,n){this.pointer=e,this.mobile=t,this.getPhase=i,this.scene=s,this.getLayer=n,this.subscriptions=[],this.editing=!1,this.axisLines=[],this.axisAlignmentHelper=new C.Object3D,this.updateSnapping=e=>{if(this.axisLines.length>0&&(this.pointer.removeSnapFeatures(this,Je.AxisAny),this.axisLines.length=0),e){this.axisAlignmentHelper.position.copy(e.point);const t=(0,Le.KK)(this.axisAlignmentHelper,e.point,e.normal);this.axisAlignmentHelper.updateMatrixWorld(!0);const i=this.axisAlignmentHelper.matrixWorld,s=100,n=(e,t,i,n)=>{const o=new nt(e.clone().multiplyScalar(s),t.clone().multiplyScalar(s),n);return o.applyMatrix4(i),o},o=(new C.Matrix4).copyPosition(i);this.axisLines.push(n(ne.B1.UP,ne.B1.DOWN,o,Je.AxisY)),t||this.axisLines.push(n(ne.B1.FORWARD,ne.B1.BACK,i,Je.AxisY),n(ne.B1.UP,ne.B1.DOWN,i,Je.AxisX),n(ne.B1.LEFT,ne.B1.RIGHT,i,Je.AxisZ)),this.axisLines.length>0&&this.pointer.addSnapFeatures(this,Je.AxisAny,this.axisLines)}}}init(){}dispose(){}activate(){this.subscriptions.push(this.pointer.onOriginChanged(this.updateSnapping,!0)),this.axisLineRenderer=new Nt(this.scene,this.getLayer("cursor-mesh"))}deactivate(){this.subscriptions.forEach((e=>e.cancel())),this.subscriptions.length=0,this.pointer.removeSnapFeatures(this,Je.AxisAny),this.axisLineRenderer.dispose(),this.axisLineRenderer=null}beforeRender(){const e=this.getPhase(),t=this.mobile?!!ie.TI.mobile[e]:!!ie.TI.desktop[e];t!==this.editing&&(this.editing=t,this.axisLineRenderer.clearLines())}render(){this.editing&&this.axisLineRenderer.render(this.pointer.lastIntersection,this.axisLines)}}class Nt{constructor(e,t){this.scene=e,this.layer=t,this.offsetFromMesh=.0075,this.featureColors={[Je.AxisX]:Te.x,[Je.AxisZ]:Te.z,[Je.AxisY]:Te.y},this.axesVisibleInConstraints={[ae.EdgesAndPlanarAxes]:!0,[ae.Axes]:!0,[ae.PlanarAxes]:!0},this.linesActive=[],this.linesFree=[],this.axesVisible=[],this.axisMat=new C.LineBasicMaterial({color:4095,linewidth:1,opacity:.75,transparent:!0,depthWrite:!1,depthTest:!0}),this.render=(e,t)=>{if(e&&this.axesVisibleInConstraints[e.constraint]&&t.length>0){if(t.length!==this.axesVisible.length)this.clearLines();else{this.axesVisible.every(((e,i)=>e.equals(t[i])))||this.clearLines()}if(this.container.parent!==this.scene.scene){for(const e of t){const t=this.getMesh(e);t.material.color.setHex(this.featureColors[e.featureType]),this.container.add(t),this.linesActive.push(t)}this.axesVisible=t.map((e=>e)),this.scene.addChild(Qe.o.Root,this.container),this.container.position.copy(e.normal).multiplyScalar(this.offsetFromMesh),this.container.updateMatrixWorld(!0)}}else this.clearLines()},this.clearLines=()=>{if(0!==this.linesActive.length){for(;this.linesActive.length>0;){const e=this.linesActive.pop();e&&(this.container.remove(e),this.linesFree.push(e))}this.scene.removeChild(Qe.o.Root,this.container)}},this.container=new C.Object3D}getMesh(e){let t=this.linesFree.pop();return t?t.geometry.setFromPoints([e.start,e.end]):(t=new kt(e,this.axisMat.clone()),t.layers.mask=this.layer.mask),t}dispose(){for(this.clearLines();this.linesFree.length>0;){const e=this.linesFree.pop();e&&(this.container.remove(e),e.geometry.dispose(),e.material.dispose())}this.linesActive=[],this.linesFree=[],this.container=null}}class kt extends C.Line{constructor(e,t){super(void 0,t),this.material=t,this.geometry=(new C.BufferGeometry).setFromPoints([e.start,e.end])}}var Ht=i(81530),Gt=i(47737),_t=i(93877),Ut=i(47907),Wt=i(96276),zt=i(20968),jt=i(84651),$t=i(64639);const Xt={[c.FloorplanOnly]:b._f.LINETYPE_2D,[c.ThreeD]:b._f.LINETYPE_3D},qt={[b._f.LINETYPE_2D]:c.FloorplanOnly,[b._f.LINETYPE_3D]:c.ThreeD};class Yt{serialize(e,t){if(!e)return null;const i=[],{text:s,visible:n,type:o,floorId:a,roomId:r,layerId:h}=e.info;for(const t of e){const e={position:Ke.U$.toVisionVector(t)};a&&(e.floorId=a),r&&(e.roomId=r),i.push(e)}const l={enabled:n,label:s,version:"3.2",lineType:Xt[o]||b._f.LINETYPE_3D,points:i};return t&&(l.layerId=h),this.validate(l)?l:null}validate(e){return!!e&&!(e.points.length<2)}}var Qt=i(81587);const Kt=new m.Vy("mds-measurement-serializer");class Zt{constructor(){this.points=(0,h.Z)([]),this.grouper=new Me(this.points)}deserialize(e){var t;if(!e||!Array.isArray(e))return Kt.debug("No contents",e),null;this.grouper.reset();for(const i of e)if(this.validate(i)){const e=i.lineType||b._f.LINETYPE_3D,s=qt[e],n=this.getModelContextFromPoint(i.points[0]),o=Object.assign(Object.assign({layerId:(null===(t=i.layer)||void 0===t?void 0:t.id)||"",sid:i.id,text:i.label||"",visible:i.enabled,type:s},n),{created:(0,Qt.XH)(i.created),modified:(0,Qt.XH)(i.modified),temporary:!1});this.grouper.startGroup(o),i.points.forEach((e=>this.grouper.push(Ke.U$.fromVisionVector(e.position))))}else Kt.debug("Deserialized invalid Measurement data from MDS",i);return 0===this.grouper.length?null:this.grouper}validate(e){if(!e||"object"!=typeof e)return!1;const t=["id","points"].every((t=>t in e)),i=e.points&&Array.isArray(e.points)&&e.points.length>0,s=t&&i;return s||Kt.debug("Invalid MDS.MeasurementPath:",{hasRequiredFields:t,hasPoints:i,data:e}),s}getModelContextFromPoint(e){return{floorId:e.floor&&e.floor.id?e.floor.id:"",roomId:e.room&&e.room.id?e.room.id:""}}}class Jt extends zt.g{constructor(){super(...arguments),this.serializer=new Yt,this.deserializer=new Zt,this.prefetchKey="data.model.measurementPaths",this.layeredType=b.jM.MEASUREMENTPATH}async read(e){const{readonly:t}=this.config,i={modelId:this.getViewId(),includeDisabled:!t,includeLayers:this.readLayerId()};return this.query($t.GetMeasurements,i,e).then((e=>{var t,i;if(!jt.t.isOk(e,"model.measurementPaths"))throw new Wt.tW("MdsMeasurementModeStore.read failed");return this.deserializer.deserialize(null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.measurementPaths)}))}async create(e){const t=this.getViewId(),i=this.serializer.serialize(e,this.writeLayerId(e.info.layerId));if(!i)throw new Error("Could not create Measurement");return this.mutate($t.AddMeasurement,{modelId:t,data:i}).then((e=>{var t,i;const s=null===(i=null===(t=e.data)||void 0===t?void 0:t.addMeasurementPath)||void 0===i?void 0:i.id;if(!s)throw new Error("Unable to add measurement!");return s}))}async update(e){if(!e||0===e.length)return Promise.resolve();const t=this.getViewId();let i="";const s={};s.modelId=t;let n="";for(const t of e){const e=t.info.sid,o=this.serializer.serialize(t,!1);if(!o)throw new Error("Could not update Measurement");s[`data${e}`]=o,i+=`, $data${e}: MeasurementPathPatch!`,n+=`patch${e}: patchMeasurementPath(modelId: $modelId, pathId: "${e}", patch: $data${e}) {\n        id\n      }`}const o=Ut.J1`
      mutation PatchMeasurements($modelId: ID! ${i}) {
        ${n}
      }
    `;return this.mutate(o,s).then((()=>{}))}async delete(...e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const t of e){const{pathId:e}=t;i+=`delete${e}: deleteMeasurementPath(modelId: $modelId, pathId: "${e}")`}const s=Ut.J1`
      mutation DeleteMeasurements($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(s,{modelId:t}).then((()=>{}))}}var ei=i(50485),ti=i(58899),ii=i(84917);class si extends ti.r{constructor(e,t,i,s,n,o){super(e,t,i),this.group=s,this.units=n,this.label=si.getLabel(this.group,this.textParser),this.onSelect=async()=>{super.onSelect(),this.commandBinder.issueCommand(new K(this.id))},this.textParser=o,this.id=this.group.info.sid,this.title=si.getTitle(this.group,this.units,this.textParser),this.description=si.getDescription(this.group,this.units),this.icon="icon-tape-measure",this.enabled=this.group.info.visible,this.typeId=b.jM.MEASUREMENTPATH,this.floorId=this.group.info.floorId,this.roomId=this.group.info.roomId||"",this.layerId=this.group.info.layerId,this.dateBucket=(0,ii.n)(this.group.info.created)}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}static getTitle(e,t,i){const s=(0,L.R5)(e.length,t),n=si.getLabel(e,i);return n?`${s} ${n}`:s}static getLabel(e,t){return t.getPlainText(e.info.text)}static getDescription(e,t){if(e.count>2){return e.segmentLengths.map((e=>(0,L.R5)(e,t))).join("  ")}return""}}var ni=i(39905),oi=i(94547),ai=i(95846),ri=i(89395),hi=i(28479),li=i(13397),di=i(95143),ci=i(40104),ui=i(34674),pi=i(32005),mi=i(87399),gi=i(68375),fi=i(74848);const vi=e=>{let{item:t}=e;const i=(0,gi.s)(),s=(0,ai.B)(t.id),n=(0,li.e)(),o=(0,ri.E)(),a=(0,hi.L)();if(!s)return null;const{id:r,textParser:h,title:l,description:d,icon:u}=t,p=r===o,m=s.info.type===c.FloorplanOnly?"floorplan":"dollhouse",g=n?(0,di.x8)(l,n):l,f=n?(0,di.x8)(d,n):d,v=(0,fi.jsxs)("div",{className:"item-details",children:[(0,fi.jsxs)("div",{className:"item-header",children:[(0,fi.jsx)(mi.L,{text:g||"",textParser:h,markers:di.S8}),(0,fi.jsx)("div",{className:"list-item-decal",children:(0,fi.jsx)(ci.I,{name:m})})]}),d&&(0,fi.jsx)("div",{className:"item-description",children:(0,fi.jsx)(mi.L,{text:f,textParser:h,markers:di.S8})})]});return(0,fi.jsx)(ui.c,{id:r,className:"search-result-item",title:v,active:p,disabled:!t.enabled,onClick:async()=>{i.trackGuiEvent("search_item_measurement_click",{tool:a}),t.onSelect()},badge:(0,fi.jsx)(pi.E,{iconClass:u})},r)};var yi=i(56147);const{MEASUREMENTS:bi}=yi.A.SHOWCASE,wi=new ni.r({});var Ii=i(39118),Di=i(46192),Si=i(92868),Ei=i(38069),Mi=i(27309);class Ci extends o.n{constructor(){super(),this.name="measurement-mode",this.mutationRecord={[a.Xw.added]:new Set,[a.Xw.updated]:new Set,[a.Xw.removed]:new Set},this.removedLayerMap=new Map,this.store=null,this.newDataBinding=null,this.roomboundData=null,this.longPressStart=Date.now(),this.threshold=800,this.lineSidToPointMap={},this.mobile=!1,this.cameraAndDragBlocked=!1,this.blockNavigation=()=>!1,this.constraint=ae.Free,this.visibilityFilterEnabled=!1,this.editable=!0,this.changeCursor=e=>{this.engine.commandBinder.issueCommand(new D.X(e))},this.onEdit=e=>{const t=this.data.getGroupInfo(e),i=t&&t.info.sid||null;this.data.editingGroupId!==i&&(this.data.editingGroupId=i,this.colliders.setEditingGroup(e))},this.onEditEnd=()=>{if(this.data.editingGroupId){const e=this.pointGroups.getGroupById(this.data.editingGroupId);e&&(this.mutationRecord.updated.add(e.info.sid),this.save(),this.engine.broadcast(new Ft.bV(this.buildAnalyticsMessageFromGroup(e))))}this.data.editingGroupId=null,this.colliders.setEditingGroup(void 0)},this.onCreatorAddNewLine=e=>{m.Vy.for(this).debug("onCreatorAddNewLine",e),this.data.creatingGroupId=e},this.onCreatorAddPoint=()=>{if(this.data.creatingGroupId){m.Vy.for(this).debug("onCreatorAddNewSegment",this.data.creatingGroupId);const e=this.pointGroups.getGroupById(this.data.creatingGroupId);if(e&&e.count>1&&e.length>0){const t=this.buildAnalyticsMessageFromGroup(e);this.engine.broadcast(new Ft.hR(Object.assign(Object.assign({},t),{startPosition:this.pointGroups.get(e.startIndex),endPosition:this.pointGroups.get(e.endIndex)})))}}},this.onCreatorStop=()=>{if(this.data.creatingGroupId){const e=this.pointGroups.getGroupById(this.data.creatingGroupId);e&&(e.count>1&&e.hasLength()?(this.engine.broadcast(new Ft.QZ(Object.assign({},this.buildAnalyticsMessageFromGroup(e)))),this.mutationRecord.added.add(e.info.sid),this.save()):this.engine.broadcast(new Ft.sN))}this.data.creatingGroupId=null},this.onToggleMeasurementMode=async(e,t,i)=>{this.toggleMeasuringMode(e,i)},this.onViewmodeChange=()=>{this.getPhase()!==ie.hb.CLOSED&&this.stopMeasuring()},this.onSweepChange=()=>{const e=this.getPhase();e!==ie.hb.CREATING&&e!==ie.hb.CREATING_NEXT_POINT&&this.setSelected(-1)},this.initStorageOnApplicationChange=async()=>{var e;const t=this.loadSavedMeasurements();this.data.modeActive()&&this.engine.commandBinder.issueCommand(new G.S(!1)),this.store&&t&&!this.newDataBinding?this.newDataBinding=this.store.onNewData((async e=>{this.getPhase()!==ie.hb.CLOSED&&this.stopMeasuring(),this.loadSavedMeasurements()?this.replaceContents(null==e?void 0:e.groups()):this.replaceContents(),this.clearMutationRecord()})):this.newDataBinding&&!t&&(this.newDataBinding.cancel(),this.newDataBinding=null,this.replaceContents()),t&&await(null===(e=this.store)||void 0===e?void 0:e.refresh())},this.getPhase=()=>this.data.phase,this.toggleCameraMovement=e=>{e||this.cameraAndDragBlocked?e&&this.cameraAndDragBlocked&&(this.dragInterceptor.cancel(),this.navigation.removeNavigationRule(this.blockNavigation),this.cameraAndDragBlocked=!1):(this.dragInterceptor.renew(),this.navigation.addNavigationRule(this.blockNavigation),this.cameraAndDragBlocked=!0)},this.getConstraint=()=>this.settings.tryGetSetting(k.Y.MeasurementSnapping,!1)?this.viewmodeData.isExterior()?ge.disabled:this.viewmodeData.isFloorplan()||(0,Ve.aY)(this.cameraModule.cameraData.pose.pitchFactor())?ge.floorplan:this.constraint:ge.disabled,this.selectedItemChanged=()=>{const{activeItemId:e,selectedType:t}=this.searchData;-1===this.getSelected()||e&&t===b.jM.MEASUREMENTPATH||this.setSelectedById(null)},this.getSelected=()=>this.data.selectedGroupIndex,this.setSelected=e=>{this.data.selectedGroupIndex!==e&&this.data.setSelectedGroupIndex(e)},this.setSelectedById=e=>{if(null===e)this.setSelected(-1);else{const t=this.pointGroups.getGroupById(e);t&&this.setSelected(t.index)}},this.deleteSelectedMeasurement=()=>{-1!==this.data.selectedGroupIndex&&(this.deleteMeasurement(this.data.selectedGroupIndex),this.setSelected(-1),this.changePhase(ie.hb.IDLE),this.mobile||(this.navigation.removeNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new D.X(w.b.DEFAULT))))},this.deleteMeasurementBySids=async e=>{const t=e.sids;for(const i of t){const t=this.pointGroups.getGroupById(i);if(!t)throw m.Vy.for(this).error("Measurement delete failed",Object.assign({},e)),Error("Measurement delete failed, not found");this.deleteMeasurement(t.index,!0)}this.save()},this.onToggleContinuous=()=>{this.stopMeasuring()},this.changePhase=e=>{this.getPhase()!==e&&(m.Vy.for(this).debug(`Phase Change: ${ie.hb[this.getPhase()]} -> ${ie.hb[e]}`),this.previousPhase=this.getPhase(),this.data.setPhase(e))},this.restorePreviousPhase=()=>{this.changePhase(this.previousPhase)},this.onPhaseChange=e=>{if(this.intersectionVisualizer.setMeasuringPhase(e),this.previousPhase!==e)switch(e){case ie.hb.CLOSED:case ie.hb.IDLE:this.engine.broadcast(new Z.Vk(!0)),this.engine.commandBinder.issueCommand(new te.RK);break;case ie.hb.EDITING:case ie.hb.CREATING:case ie.hb.POINT_PLACED:case ie.hb.CREATING_NEXT_POINT:case ie.hb.CONFIRMING_POINT:this.engine.broadcast(new Z.Vk(!1)),this.engine.commandBinder.issueCommand(new te.WH)}},this.buildAnalyticsMessage=e=>{const t=this.pointGroups.getGroup(e);return t&&t.hasLength()?this.buildAnalyticsMessageFromGroup(t):null},this.buildAnalyticsMessageFromGroup=e=>{const t=c[e.info.type];return Object.assign(Object.assign({sid:e.info&&e.info.sid?e.info.sid:e.describe(),totalLength:e?e.length:0,segments:e?e.count:0,temporary:!!e.info.temporary,viewmode:this.viewmodeData.peekabooCorrectedMode(this.cameraModule.cameraData),floorId:e.info.floorId,continuous:this.settings.tryGetSetting(k.Y.MeasurementContinuousLines,!1)},this.getAnalyticsForConstraints()),{type:t})},this.getAnalyticsForConstraints=()=>{const e=this.pointer.lastIntersection;if(e){const t=e.featureType,i=e.constraint;return{featureType:void 0!==t?Je[t]:"None",constraint:ae[i]}}return null},this.toggleMeasuringMode=(e,t)=>{m.Vy.for(this).debug("toggleMeasuringMode",e);e!==(this.getPhase()!==ie.hb.CLOSED)&&(e?(this.editable=t,this.engine.toggleRendering(this,!0),this.changePhase(ie.hb.IDLE),this.lineStyler.activate(),this.renderer.activate(),this.textRenderer.activate(),this.editable&&(this.editor.activate(),this.colliders.activate(),this.textRenderer.activateInteraction()),this.engine.broadcast(new Ft.z(!0,this.viewmodeData.peekabooCorrectedMode(this.cameraModule.cameraData),this.pointGroups.groupCount))):(this.engine.toggleRendering(this,!1),this.stopMeasuring(),this.changePhase(ie.hb.CLOSED),this.toggleCameraMovement(!0),this.editable&&(this.editor.deactivate(),this.colliders.deactivate(),this.textRenderer.deactivateInteraction()),this.lineStyler.deactivate(),this.renderer.deactivate(),this.textRenderer.deactivate(),this.engine.broadcast(new Ft.z(!1,this.viewmodeData.peekabooCorrectedMode(this.cameraModule.cameraData),this.pointGroups.groupCount))))},this.startMeasuring=()=>{this.settings.tryGetSetting(k.Y.MeasurementSnapping,!1)&&this.pointer.preload(),this.mobile||(this.navigation.addNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new D.X(w.b.XHAIR))),this.creator.start()},this.stopMeasuring=()=>{if(this.getPhase()===ie.hb.CLOSED)return;const e=this.isMeasurementComplete(this.data.selectedGroupIndex);this.isCreating()&&!e&&this.deleteSelectedMeasurement(),this.creator.stop(),this.mobile||(this.navigation.removeNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new D.X(w.b.DEFAULT)))},this.setupIntersectionVisuals=(e,t,i,s,n,o,a,r)=>{t.addVisibilityRule((()=>{const e=this.getPhase();return!(!n&&e===ie.hb.CREATING||e===ie.hb.CONFIRMING_POINT||e===ie.hb.CREATING_NEXT_POINT||e===ie.hb.EDITING)}));return new Ze(n,s,this.cameraModule,i,e,o,(()=>a.peekabooCorrectedMode(this.cameraModule.cameraData)===M.N.Floorplan),(()=>a.isExterior()),r)},this.renameMeasurement=async e=>{const t=this.pointGroups.getGroupById(e.sid);if(!t)throw m.Vy.for(this).error("Measurement rename failed",Object.assign({},e)),Error("Measurement rename failed, not found");const i=void 0!==e.text&&e.text.length<=24;if(!t||!i)throw m.Vy.for(this).error("Measurement text invalid, text must be between 0 and 24 charachters in length.",Object.assign({},e)),new Error("Measurement text invalid");{const i=""===t.info.text&&e.text.length>0,s=!i&&t.info.text!==e.text;this.pointGroups.updateGroupInfo(t.index,Object.assign(Object.assign({},t.info),{text:e.text})),this.mutationRecord.updated.add(t.info.sid),this.save(),i&&this.engine.broadcast(new Ft.kC(e.sid,e.text)),s&&this.engine.broadcast(new Ft.wx(e.sid,t.info.text,e.text))}},this.onChangeVisibility=async e=>{const{sids:t,visible:i}=e;for(const s of t){const t=this.pointGroups.getGroupById(s);if(!t)throw m.Vy.for(this).error("Measurement visibility toggle failed",Object.assign(Object.assign({},e),{group:t})),new Error("Measurement visibility toggle failed, not found");{this.pointGroups.updateGroupInfo(t.index,Object.assign(Object.assign({},t.info),{visible:i})),this.mutationRecord.updated.add(t.info.sid);const e=this.buildAnalyticsMessage(t.index);e&&this.engine.broadcast(new Ft.bV(e)),i||t.index!==this.getSelected()||this.setSelected(-1)}}this.save()},this.filterVisibility=async e=>{this.data.idVisibility=new Set(e.sids),this.data.commit()},this.changeVisibilityFilterEnabled=async e=>{this.data.idVisibility=new Set,this.visibilityFilterEnabled=e.enabled,this.data.commit()},this.currentRoomId=()=>(0,Di.C)(this.roomboundData,this.layersData,this.layersData.activeLayerId)?this.roomData.selected.value:null,this.clearMutationRecord=this.clearMutationRecord.bind(this),this.deleteMeasurement=this.deleteMeasurement.bind(this),this.replaceContents=this.replaceContents.bind(this),this.navigateToMeasurement=this.navigateToMeasurement.bind(this)}async init(e,t){var i;const{readonly:s,baseUrl:n}=e;this.config=e,this.mobile=(0,g.Fr)(),this.engine=t;const[o,a,l,c,m,f,w,I,D,M]=await Promise.all([t.getModuleBySymbol(v.M7),t.getModuleBySymbol(v.kM),t.getModuleBySymbol(v.mL),t.getModuleBySymbol(v.ZF),t.getModuleBySymbol(v.sA),t.market.waitForData(S.X),t.getModuleBySymbol(v.jh),t.market.waitForData(E.X),t.market.waitForData(H.A),t.market.waitForData(ei.q)]);[this.settings,this.playerOptions,this.layersData,this.searchData]=await Promise.all([t.market.waitForData(F.o),t.market.waitForData(B.EY),t.market.waitForData(Gt.P),t.market.waitForData(V.L)]),t.market.waitForData(Si.A).then((e=>this.roomboundData=e)),this.playerOptions=await t.market.waitForData(B.EY),this.layersData=await t.market.waitForData(Gt.P),this.scene=o.getScene(),this.depthTextures=o.getDepthTextures(),this.viewmodeData=I,this.cameraModule=w,this.floorsViewData=f,this.roomData=M,this.input=l,this.navigation=await t.getModuleBySymbol(v.Kv),this.meshQueryModule=await t.getModuleBySymbol(v.PM);const C=await t.getModuleBySymbol(v.T9);this.applicationData=await t.market.waitForData(r.zH),this.lineDerivedDataFactory=new O(w,I,f,(()=>!!D.state.currentSweep&&D.isSweepAligned(D.state.currentSweep)),(()=>this.settings.tryGetSetting(k.Y.UnitType,N.t.IMPERIAL)),(()=>!0));const T=t.claimRenderLayer(this.name);this.data=new se.s;const x=(0,h.Z)([]);this.pointGroups=new Me(x);const A=(e,t,i=!1)=>d(x,e).createSubscription(t,i);this.dataSubscription=x.onChanged((()=>{this.data.repopulate(this.pointGroups.groups()),this.data.commit()})),this.store=new Jt({context:this.layersData.mdsContext,readonly:s,baseUrl:n}),this.registerRoomAssociationSource(t),async function(e,t,i,s){const n=await e.market.waitForData(r.zH);let o=n.application===r.lg.WORKSHOP;const a=(n,a,r,h=[])=>{const l=s.tryGetSetting(k.Y.UnitType,N.t.METRIC),d=[],c=t.groups();if(0===h.length)for(const t of c)(o||t.info.visible&&i.layerToggled(t.info.layerId))&&n(si.getTitle(t,l,wi),si.getDescription(t,l))&&d.push(new si(e.commandBinder,i,a,t,l,wi));return e.commandBinder.issueCommand(new Y(d.map((e=>e.id)))),d},h=t=>{e.commandBinder.issueCommand(new Q(!!t))},l=e=>new u.P(t.onDataChanged(e),s.onSettingChanged(k.Y.UnitType,e)),d={renew:()=>{e.commandBinder.issueCommandWhenBound(new oi.Oc({id:b.jM.MEASUREMENTPATH,groupPhraseKey:bi.SEARCH_GROUP_HEADER,getSimpleMatches:a,registerChangeObserver:l,onSearchActivatedChanged:h,groupOrder:40,groupIcon:"tape-measure",batchSupported:!0,itemFC:vi}))},cancel:()=>{e.commandBinder.issueCommandWhenBound(new oi.tf(b.jM.MEASUREMENTPATH))}},c=()=>{o=n.application===r.lg.WORKSHOP,s.tryGetSetting(B.Q$.Measurements,!0)||o?d.renew():d.cancel()},p=n.onPropertyChanged("application",c),m=s.onSettingChanged(B.Q$.Measurements,c);return c(),new u.P(d,p,m)}(t,this.data,this.layersData,this.settings).then((e=>this.bindings.push(e))),this.pointer=new bt(m,this.getConstraint,this.mobile,this.floorsViewData,this.viewmodeData,this.meshQueryModule,w.cameraData.pose);const L=new It(this.pointGroups,A,this.pointer,(()=>{const e=this.settings.tryGetSetting(k.Y.MeasurementContinuousLines,!1),t=this.getPhase()===ie.hb.CREATING||this.getPhase()===ie.hb.CREATING_NEXT_POINT||this.previousPhase===ie.hb.CREATING_NEXT_POINT&&this.getPhase()===ie.hb.EDITING;return e&&this.mobile&&t}));t.addComponent(this,L);const P=new Bt(this.pointer,this.mobile,this.getPhase,this.scene,t.getRenderLayer);t.addComponent(this,P),this.creator=this.instantiateCreator(w.cameraData),this.initStorageOnApplicationChange();const R=(e,t,i)=>{const s=this.pointGroups.getGroup(e),n=s.describe(i);this.lineSidToPointMap[n]=i;const o=this.lineDerivedDataFactory.get(n);return this.lineDerivedDataFactory.make(n,(()=>({start_position:this.pointGroups.get(t),end_position:this.pointGroups.get(i),visible:this.getMeasurementVisibility(s.info.sid,s.info.layerId,s.info.visible),floorId:s.info.floorId,roomId:s.info.roomId,layerId:s.info.layerId,type:s.info.type,text:this.pointGroups.isStartIndex(t)?s.info.text:""})),o)};this.renderer=new Re(this.pointGroups,A,w,c,T,t.claimRenderLayer("measure-lines"),this.getSelected,R),await t.addComponent(this,this.renderer);const j=new y.Il({assetBasePath:null!==(i=this.settings.getSetting("assetBasePath"))&&void 0!==i?i:"",color:Ei.V.BLACK.clone(),background:!0,backgroundColor:Ei.V.WHITE.clone(),backgroundColliderType:ke,fadeDepth:Mi.G,fadeWidth:Mi.p});this.textRenderer=new He(this.pointGroups,l,this.mobile,w,T,qe.X.labels,j,R,this.changeCursor,this.getPhase,this.setSelected,this.scene,this.depthTextures),await t.addComponent(this,this.textRenderer),this.editor=new St(this.pointGroups,l,this.pointer,this.getPhase,this.onEdit,this.onEditEnd),this.colliders=new vt(this.pointGroups,this.input,w.cameraData,this.mobile,this.changeCursor,this.getPhase,this.changePhase,this.restorePreviousPhase,this.setSelected,this.getSelected,this.onEdit,this.onEditEnd),this.lineStyler=new Mt(this.renderer.lines,this.renderer.getLinesForPoint,this.renderer.dottedMaterial,A,this.input,this.getPhase,this.getSelected);const[Z,J]=await Promise.all([t.getModuleBySymbol(v._v),t.getModuleBySymbol(v.Qm)]);this.viewportModule=J,this.intersectionVisualizer=this.setupIntersectionVisuals(a,Z,this.scene,this.pointer,this.mobile,t.getRenderLayer,this.viewmodeData,J),t.addComponent(this,this.intersectionVisualizer),this.dragInterceptor=new u.P(this.input.registerPriorityHandler(gt.jF,it.r,(()=>!0)),this.input.registerPriorityHandler(gt.jF,Pt.W,(()=>!0))),this.dragInterceptor.cancel(),this.mobile||this.bindings.push(...this.hotkeys()),this.bindings.push(this.applicationData.onPropertyChanged("application",this.initStorageOnApplicationChange),I.makeModeChangeSubscription(this.onViewmodeChange),D.makeSweepChangeSubscription(this.onSweepChange),t.commandBinder.addBinding(G.S,(async e=>{this.onToggleMeasurementMode(e.on,e.dimWhileActive,e.editable)})),t.commandBinder.addBinding(_.X,(async()=>this.startMeasuring())),t.commandBinder.addBinding(U.y,(async e=>this.setSelected(e.index))),t.commandBinder.addBinding(W.R,(async()=>this.stopMeasuring())),t.commandBinder.addBinding(z.SH,(async()=>this.deleteSelectedMeasurement())),t.commandBinder.addBinding(z.tm,(async e=>this.deleteMeasurement(e.index))),t.commandBinder.addBinding($,this.onChangeVisibility),t.commandBinder.addBinding(X,this.renameMeasurement),t.commandBinder.addBinding(z.CN,this.deleteMeasurementBySids),t.commandBinder.addBinding(q,(async e=>{var t;return this.replaceContents(null===(t=e.points)||void 0===t?void 0:t.groups())})),t.commandBinder.addBinding(Y,this.filterVisibility),t.commandBinder.addBinding(Q,this.changeVisibilityFilterEnabled),t.commandBinder.addBinding(K,this.navigateToMeasurement),this.dataSubscription,this.settings.onSettingChanged(k.Y.MeasurementContinuousLines,(()=>this.onToggleContinuous())),C.onSave((()=>this.saveDiff()),{dataType:p.p.MEASUREMENTS}),this.layersData.onPropertyChanged("currentViewId",(()=>this.updateSettings())),this.layersData.onPropertyChanged("activeLayerId",(()=>this.updatePendingMeasurement())),this.data.onPropertyChanged("phase",this.onPhaseChange),this.searchData.onPropertyChanged("activeItemId",this.selectedItemChanged)),t.market.register(se.s,this.data),t.toggleRendering(this,!1),this.updateSettings(),this.registerDebugSettings()}replaceContents(e){this.lineDerivedDataFactory.clear();for(let e=this.pointGroups.groupCount;e>=0;e--){const t=this.pointGroups.getGroup(e);this.layersData.isInMemoryLayer(t.info.layerId)||this.pointGroups.removeGroup(e)}e&&this.pointGroups.copy(e,!1)}loadSavedMeasurements(){return this.config.readonly=this.applicationData.application!==r.lg.WORKSHOP,this.creator.syncReadonly(this.config.readonly),!this.config.readonly||this.playerOptions.options.measurements_saved}isCreating(){const e=this.getPhase();return e===ie.hb.CREATING||e===ie.hb.CREATING_NEXT_POINT}setConstraintStyle(e){m.Vy.for(this).debug("setConstraintStyle:",ae[e]),this.constraint=e}deleteMeasurement(e,t=!1){const i=this.buildAnalyticsMessage(e);i&&this.engine.broadcast(new Ft.To(Object.assign(Object.assign({},i),{count:this.pointGroups.groupCount-1})));const s=this.pointGroups.getGroup(e);if(s){const{sid:i,layerId:n}=s.info;this.pointGroups.removeGroup(e),i!==this.data.creatingGroupId&&(this.layersData.isInMemoryLayer(n)||(this.mutationRecord.removed.add(i),this.removedLayerMap.set(i,n),t||this.save()))}}isMeasurementComplete(e){if(-1===e||!this.isCreating())return!0;const t=this.getPhase(),i=this.pointGroups.getGroup(e);return this.settings.tryGetSetting(k.Y.MeasurementContinuousLines,!1)?i.count>2&&t===ie.hb.CREATING_NEXT_POINT:i.count>=2&&t===ie.hb.CREATING}hotkeys(){return[this.input.registerHandler(Rt.k,(e=>{if(e.state===Ot.$.PRESSED)switch(e.key){case Vt.D.ESCAPE:this.getPhase()===ie.hb.CONFIRMING_POINT?(this.creator.stop(),this.creator.start(),this.changePhase(ie.hb.CREATING)):this.isCreating()?this.stopMeasuring():this.applicationData.application!==r.lg.WORKSHOP&&this.getPhase()!==ie.hb.CLOSED&&this.engine.commandBinder.issueCommand(new J.yU(ee.S0.MEASUREMENTS,!1));break;case Vt.D.BACKSPACE:case Vt.D.DELETE:this.getPhase()!==ie.hb.CLOSED&&this.getPhase()!==ie.hb.EDITING&&this.deleteSelectedMeasurement();break;case Vt.D.RETURN:const e=this.pointGroups.groupCount-1;this.isMeasurementComplete(e)&&this.stopMeasuring()}})),this.input.registerHandler(Rt.k,(e=>{if(e.key===Vt.D.SHIFT||e.key===Vt.D.ALT){const{altKey:t,shiftKey:i}=e.modifiers,s=i&&t?ge.shiftAlt:t?ge.alt:i?ge.shift:ge.desktop;this.setConstraintStyle(s)}}))]}onUpdate(e){if(this.getPhase()===ie.hb.CLOSED)return;const t=this.data.selectedGroupIndex,i=this.mobile?ie.Vk.mobile[this.getPhase()]:ie.Vk.desktop[this.getPhase()];for(const s in this.lineSidToPointMap){const n=this.lineDerivedDataFactory.get(s);if(n){n.opacity.tick(e);const o=this.lineSidToPointMap[s],a=this.pointGroups.groupFromPointIndex(o),r=a===t&&n.visible?1:n.opacity.value,h=i&&!n.labelVisible?0:r;this.textRenderer.setTextOpacityByPoint(o,h),this.renderer.setLineOpacityByPoint(o,r),-1!==a&&this.colliders.setGroupVisible(a,r>0)}}if(this.mobile)if(this.getPhase()===ie.hb.CONFIRMING_POINT){const e=(Date.now()-this.longPressStart)/this.threshold;e<=1&&(this.data.pressProgress=e,this.data.commit())}else this.getPhase()===ie.hb.CREATING&&0!==this.data.pressProgress&&(this.data.pressProgress=0,this.data.commit())}dispose(){var e,t;this.data.modeActive()&&(this.stopMeasuring(),this.engine.commandBinder.issueCommand(new G.S(!1))),this.colliders.dispose(),this.textRenderer.dispose(),this.renderer.dispose(),this.engine.disposeRenderLayer(this.name),null===(e=this.store)||void 0===e||e.dispose(),this.store=null,null===(t=this.newDataBinding)||void 0===t||t.cancel(),this.newDataBinding=null,super.dispose(this.engine)}clearMutationRecord(){for(const e of Object.values(this.mutationRecord))e.clear()}async save(){if(!this.config.readonly)return this.engine.commandBinder.issueCommand(new Ht.F({dataTypes:[p.p.MEASUREMENTS]}));this.clearMutationRecord()}async saveDiff(){var e,t;if(this.data.repopulate(this.pointGroups.groups()),this.data.commit(),this.data.notifyDataChanged(),this.config.readonly||!this.store)return void this.clearMutationRecord();const i=this.mutationRecord,s=[];m.Vy.for(this).debug("MDS mutation ops:",`{\n      added: '${[...i.added.keys()]}',\n      updated: '${[...i.updated.keys()]}',\n      removed: '${[...i.removed.keys()]}',\n    }`);const n=[];for(const e of i[a.Xw.removed]){if(i[a.Xw.added].has(e))i[a.Xw.added].delete(e);else{const t=this.removedLayerMap.get(e);n.push({pathId:e,layerId:t})}i[a.Xw.updated].delete(e)}this.removedLayerMap.clear();const o=this.store.delete(...n);s.push(o);for(const t of i[a.Xw.added]){if(this.layersData.isInMemoryLayer(null===(e=this.data.getGroupInfoBySid(t))||void 0===e?void 0:e.info.layerId))continue;const n=this.pointGroups.getGroupById(t);if(n){const e=this.store.create(n).then((e=>{e&&(m.Vy.for(this).debug(`Updating group id for new path: ${n.info.sid} -> ${e}`),this.pointGroups.updateGroupInfo(n.index,Object.assign(Object.assign({},n.info),{sid:e}))),this.data.repopulate(this.pointGroups.groups()),this.data.commit(),this.data.notifyDataChanged()}));s.push(e)}i[a.Xw.updated].delete(t)}const r=[];for(const e of i[a.Xw.updated]){if(this.layersData.isInMemoryLayer(null===(t=this.data.getGroupInfoBySid(e))||void 0===t?void 0:t.info.layerId))continue;const i=this.pointGroups.getGroupById(e);i&&r.push(i)}const h=this.store.update(r);return s.push(h),this.clearMutationRecord(),Promise.all(s)}updatePendingMeasurement(){const e=this.data.creatingGroupId;if(e){const t=this.pointGroups.getGroupById(e);if(!t)return void m.Vy.for(this).error("Missing pending measurement group");if(!this.layersData.isInMemoryLayer(t.info.layerId)){const i=this.layersData.activeLayerId;this.pointGroups.updateGroupInfo(t.index,Object.assign(Object.assign({},t.info),{layerId:i}));const s=this.data.getGroupInfoBySid(e);s&&(s.info.layerId=i,this.data.commit(),this.data.notifyDataChanged())}}}getMeasurementVisibility(e,t,i){if(!this.data.modeActive())return!1;const{selectedGroupSid:s,creatingGroupId:n,editingGroupId:o,idVisibility:a}=this.data,h=this.applicationData.application===r.lg.WORKSHOP||this.layersData.layerToggled(t),l=this.layersData.layerVisible(t),d=[s,n,o].includes(e),c=!this.visibilityFilterEnabled||a.has(e);return h&&(d||i&&c&&l)}async registerDebugSettings(){const e=await this.engine.getModuleBySymbol(f.ZF);e.registerMenuEntry({header:"Measurement Debug",setting:"measure/fp_in_dh",initialValue:()=>!1,onChange:t=>(this.lineDerivedDataFactory.setDollhouseLineStyle(t?c.FloorplanOnly:c.ThreeD),e.updateSetting("measure/fp_in_dh",t))})}updateSettings(){const e=this.layersData.getCurrentView(),t=(null==e?void 0:e.viewType)===_t.jK.TRUEPLAN,i=this.settings.tryGetSetting(De,!0);(null==e?void 0:e.isCompositeView())&&(ge.mobile=ae.Free,ge.desktop=ae.Free,ge.alt=ae.Edges),this.constraint=this.mobile?ge.mobile:ge.desktop;const s=t||i;this.settings.setSetting(De,s)}instantiateCreator(e){let t;const i=this.viewmodeData,s=()=>{const t=i.isFloorplan(),s=i.isDollhouse()&&e.pose.pitchFactor()<.01;return t||s},n=e=>{var t,i,s;const n=this.config.readonly||!this.store,o=n&&e.layerId||this.layersData.activeLayerId,a={floorId:e.floorId||"",roomId:e.roomId||"",layerId:o};if(a.floorId&&a.roomId||this.meshQueryModule.inferMeshIdsFromPoint(a,e.point,!0),n&&!e.layerId){const n=(null!==(t=e.layerId)&&void 0!==t?t:e.floorId)?null===(i=this.meshQueryModule.nearestMeshInfoOnFloor(e.point,e.floorId))||void 0===i?void 0:i.object.layerId:null===(s=this.meshQueryModule.nearestMeshInfo(e.point))||void 0===s?void 0:s.object.layerId;a.layerId=n||a.layerId}return a};if(this.mobile){const i=(e,t)=>{this.longPressStart=e,this.threshold=t},o=t=>{const i=(0,Ve.bz)(e,t.point);this.data.setPointPosition(i.screenPosition)};t=new At(this.pointGroups,this.setSelected,this.input.registerUnfilteredHandler,this.pointer,this.changePhase,i,o,this.toggleCameraMovement,this.getPhase,(()=>this.settings.tryGetSetting(k.Y.MeasurementContinuousLines,!1)),s,(()=>this.floorsViewData.getHighestVisibleFloorId()),this.currentRoomId,(()=>this.layersData.activeLayerId),n)}else t=new Lt(this.pointGroups,this.setSelected,this.input.registerUnfilteredHandler,this.pointer,this.changePhase,this.getPhase,s,(()=>this.floorsViewData.getHighestVisibleFloorId()),this.currentRoomId,(()=>this.layersData.activeLayerId),(()=>this.settings.tryGetSetting(k.Y.MeasurementContinuousLines,!1)),n,this.meshQueryModule);return t.onGroupCreated=this.onCreatorAddNewLine,t.onGroupAddPoint=this.onCreatorAddPoint,t.onEdit=this.onEdit,t.onDone=this.onCreatorStop,t.syncReadonly(this.config.readonly),t}async navigateToMeasurement({groupId:e}){const t=this.data.getGroupInfoBySid(e);if(!t)return;const i=[];for(const e of t)i.push(e);const s=(new C.Box3).setFromPoints(i),n=t.info.type===c.FloorplanOnly?M.N.Floorplan:M.N.Dollhouse;s.expandByScalar(n===M.N.Dollhouse?1.25:1);const o={mode:n,transition:I.fl.Interpolate,floorId:t.info.floorId},a=this.viewportModule.viewportManager.viewportIdForLayerId(t.info.layerId);try{await this.navigation.focus(s,Object.assign({viewportId:a},o)),this.setSelectedById(e)}catch(e){m.Vy.for(this).info("Unable to navigateToMeasurement:",e)}}registerRoomAssociationSource(e){const t=this.data;e.commandBinder.issueCommandWhenBound(new Ii.l({type:"measurements",getPositionId:function*(){for(const e of t.groups())yield{id:e.info.sid,roomId:e.info.roomId,floorId:e.info.floorId,position:e.get(0),layerId:e.info.layerId}},updateRoomForId:(e,i)=>{const s=t.getGroupInfoBySid(e);if(!s)throw new Error("Invalid measurement group id");s.info.roomId=i||void 0}}))}}const Ti=Ci},31993:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ModelRatedMessage:()=>a.N,SubmitModelRatingCommand:()=>r.i,ToggleModelRatingDialogCommand:()=>r.c,default:()=>E});var s=i(6909),n=i(64882),o=i(77489),a=i(95522),r=i(26432),h=i(81088),l=i(22213),d=i(37572),c=i(9139);const u=new c.Vy("model-rating-data-store"),p=e=>e,m=e=>e;class g extends d.xO{constructor(e,t,i){super({queue:e,deserialize:p,serialize:m,path:`${t}/api/v1/jsonstore/model/model-rating/${i}`}),this.queue=e,this.baseUrl=t,this.modelId=i}async canPromptRating(){let e;try{e=await this.read()}catch(e){return u.error("Failed to read existing rating data from JSONStore"),!1}const t=!!e.rated_at;return!!!e.prompt_dismissed_at&&!t}async recordRatingSubmitted(){this.update({rated_at:(new Date).toISOString()})}async recordAutomaticPromptDismissed(){this.update({prompt_dismissed_at:(new Date).toISOString()})}async reset(){var e;const t=`${this.baseUrl}/api/v1/jsonstore/model/model-rating/${this.modelId}`;if(!(null===(e=this.modelId)||void 0===e?void 0:e.length))throw new Error(`Refusing to DELETE ${t}`);if(window.confirm("Are you sure you want to reset the Model Rated value for this space? This cannot be undone."))return this.queue.delete(t,this.options).then((()=>{window.location.reload()}))}}var f=i(87965),v=i(25443),y=i(33156),b=i(90082);const w=e=>864e5*e,I=w(1),D=w(7);class S extends n.n{constructor(){super(...arguments),this.name="model-rating",this.promptEnabled=!1,this.totalActiveTime=0,this.wasLastOpeningAutomatic=!1,this.canPrompt=async()=>{const e=Date.now(),t=+this.settings.tryGetSetting(f.Y.LastRatingPromptTime,null),i=!t||isNaN(t)||+new Date(e)-+new Date(t)>=I,s=await this.store.canPromptRating();return c.Vy.for(this).debug(`canPromptUser: ${i}, canPromptModel: ${s}`),i&&s},this.handleActivityPingMessage=async e=>{if(this.totalActiveTime+=e.durationDollhouse+e.durationFloorplan+e.durationInside,c.Vy.for(this).debug(`prompt timing update: totalActiveTime:${this.totalActiveTime}, threshHold: 74500`),this.totalActiveTime<74500||!this.promptEnabled)return;this.engine.unsubscribe(s.h,this.handleActivityPingMessage);if(await this.canPrompt()&&!this.viewData.isDialogVisible){c.Vy.for(this).debug("automatically prompting user for Model Rating");const e=(new Date).toISOString();this.settings.setLocalStorageSetting(f.Y.LastRatingPromptTime,e),this.engine.commandBinder.issueCommand(new r.c(!0)),this.wasLastOpeningAutomatic=!0}},this.handleSubmitModelRatingCommand=async({rating:e,didFinish:t})=>{c.Vy.for(this).info(e),this.engine.broadcast(new a.N(e)),this.store.recordRatingSubmitted(),t&&(this.engine.commandBinder.issueCommand(new r.c(!1)),this.engine.commandBinder.issueCommand(new h.X6(l.a.RATING_THANK_YOU,!0)))},this.handleToggleDialogCommand=async({toVisible:e})=>{this.viewData.setDialogVisible(e);!this.viewData.isDialogVisible&&this.wasLastOpeningAutomatic&&(this.store.recordAutomaticPromptDismissed(),this.wasLastOpeningAutomatic=!1)}}async init(e,t){this.engine=t,this.config=e,this.viewData=new o.G,this.store=new g(e.queue,e.baseUrl,e.baseModelId),this.promptEnabled=e.promptEnabled,this.settings=await t.market.waitForData(v.o),this.userData=await t.market.waitForData(y.E),this.bindings.push(t.commandBinder.addBinding(r.c,this.handleToggleDialogCommand),t.commandBinder.addBinding(r.i,this.handleSubmitModelRatingCommand));const i=this.userData.getModelCreatedDate();let n=!!i&&Date.now()-+new Date(i)<D;this.promptEnabled&&e.debug&&(c.Vy.for(this).info("Debug Mode Enabled: Ignoring max model age requirement for rating prompt."),n=!0),c.Vy.for(this).debug(`promptEnabled: ${e.promptEnabled}, isModelEligible: ${n}`),this.promptEnabled&&n&&this.bindings.push(t.subscribe(s.h,this.handleActivityPingMessage)),t.market.register(o.G,this.viewData),this.registerSettings()}async registerSettings(){const e=await this.engine.getModuleBySymbol(b.ZF),{debug:t}=this.config;t&&e.registerMenuButton({header:"Model Rating",buttonName:"Reset Model Rated value",callback:()=>{this.settings.setLocalStorageSetting(f.Y.LastRatingPromptTime,null),this.store.reset()}})}dispose(e){this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],super.dispose(e)}}const E=S},35699:(e,t,i)=>{"use strict";i.d(t,{X:()=>n});var s=i(11165);class n extends s.u{constructor(e=null){super(),this.payload={cursor:e}}}n.id="SET_MOUSE_CURSOR"},77510:(e,t,i)=>{"use strict";var s;i.d(t,{b:()=>s}),function(e){e.NONE="none",e.DEFAULT="default",e.MOVE="move",e.MOVE_LF="col-resize",e.MOVE_UD="row-resize",e.XHAIR="crosshair",e.PLUS="cell",e.QUESTION="help",e.NOPE="not-allowed",e.FINGER="pointer",e.TEXT="text",e.TEXT_VERT="vertical-text",e.ZOOM_IN="zoom-in",e.ZOOM_OUT="zoom-in",e.GRAB="grab",e.GRABBING="grabbing",e.ARROW_R="e-resize",e.ARROW_L="w-resize",e.ARROW_U="n-resize",e.ARROW_D="s-resize",e.ARROW_UR="ne-resize",e.ARROW_UL="nw-resize",e.ARROW_DR="se-resize",e.ARROW_DL="sw-resize",e.ARROW_LR="ew-resize",e.ARROW_UD="ns-resize",e.ARROW_URDL="nesw-resize",e.ARROW_ULDR="nwse-resize",e.ROOMBOUNDS_DEFAULT="rbe-default",e.ROOMBOUNDS_MOVING="rbe-moving",e.ROOMBOUNDS_PLACE_NODE="rbe-place-node",e.ROOMBOUNDS_FINISH_ROOM="rbe-finish-room"}(s||(s={}))},46192:(e,t,i)=>{"use strict";i.d(t,{C:()=>o});var s=i(93877),n=i(56547);function o(e,t,i){const o=e&&e.hasRooms(),a=i?t.getLayer(i):t.getActiveLayer();return a&&a.layerType===s.ku.COMMON_USER_LAYER?!o:!!(0,n.XF)(t.getCurrentView())||!o}},39118:(e,t,i)=>{"use strict";i.d(t,{l:()=>n});var s=i(11165);class n extends s.u{constructor(e){super(),this.payload={roomAssociation:e}}}n.id="REGISTER_ROOM_ASSOCIATION_SOURCE"},33930:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ce});var s=i(64882),n=i(62802),o=i(1284),a=i(45987),r=i(14614),h=i(25443),l=i(71687),d=i(93358),c=i(50485),u=i(58687),p=i(98848),m=i(81530),g=i(92868),f=i(88186),v=i(39118),y=i(7584),b=i(84917),w=i(74381),I=i(47737),D=i(87965),S=i(23339),E=i(24790),M=i(56147),C=i(94547),T=i(58899),x=i(58229),A=i(9997),L=i(99380),P=i(30169),R=i(15580),O=i(56208);class V extends T.r{constructor(e,t,i,s,n,o,a){super(e,t,s),this.room=n,this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new A.Dd(this.room))},this.floorId=a,this.roomId=n.id,this.title=o,this.id=this.room.id,this.typeId=w.jM.MODELROOM,this.icon=`icon-${(0,L.bt)(this.room.roomTypeIds)}`;const r=i.tryGetSetting(D.Y.UnitType,S.t.IMPERIAL);this.description=this.room.getMeasurementText(r),this.layerId=E.qw,this.dateBucket=b.T.OLDER,this.enabled=!0}}var F=i(11579),B=i(47907),N=i(20968),k=i(32126),H=i(9139),G=i(69304),_=i(84615),U=i(26348),W=i(68909),z=i(86866),j=i(76185);const $=new H.Vy("MdsRoomBoundsDeserializer");class X{deserialize(e,t=!1){var i,s,n,o,a,r,h,l,d;const c={version:0,floors:{}};for(const t of e.floors||[]){const e={edges:{},vertices:{},rooms:{}};c.floors[t.id]=e;for(const i of t.vertices||[])i?e.vertices[i.id]={x:i.position.x,y:i.position.y}:$.warn("Found null vertex in floor vertices!");for(const i of t.edges||[]){if(!i||null===i.thickness||null===i.centerLineBias){$.warn("Invalid edge!");continue}for(const t of i.vertices||[])(null==t?void 0:t.position)&&(e.vertices[t.id]={x:t.position.x,y:t.position.y});const t={vertices:(i.vertices||[]).map((e=>null==e?void 0:e.id)),thickness:i.thickness,bias:i.centerLineBias,openings:{},type:i.type||void 0};e.edges[i.id]=t;for(const e of i.openings||[]){if(!e){$.warn("Found null opening!");continue}if(!this.ensureOpeningLabelType(e.label,e.type))continue;const i=(0,G.Et)(e.height)&&(0,G.Et)(e.lowerElevation)&&e.height-.1<1e-6&&e.lowerElevation-.1<1e-6,s=null!=e.height&&(e.height<1e-6||isNaN(e.height)),n=null!=e.lowerElevation&&isNaN(e.lowerElevation),o={height:i||s?null:e.height,lowerElevation:i||n?null:e.lowerElevation,relativePos:e.relativeCenter,width:e.width,label:this.ensureOpeningLabelType(e.label,e.type)};(0,j.$)(t.openings),t.openings[e.id]=o}}}for(const u of e.rooms||[]){if(!u||!u.floor){$.warn("Found null room");continue}if(!c.floors[u.floor.id]){$.warn("Unable to find floor for room!");continue}const e=u.classifications||[].sort(((e,t)=>(e.confidence||0)-(t.confidence||0))),p=null===(i=u.dimensionEstimates)||void 0===i?void 0:i.units,m=(u.label||"").trim();c.floors[u.floor.id].rooms[u.id]={edges:(null===(n=null===(s=u.boundary)||void 0===s?void 0:s.edges)||void 0===n?void 0:n.map((e=>e.id)))||[],holes:(null===(o=u.holes)||void 0===o?void 0:o.map((e=>{var t;return(null===(t=e.edges)||void 0===t?void 0:t.map((e=>e.id)))||[]})))||[],classifications:e,label:m,width:this.ensureMetric("distance",null===(a=u.dimensionEstimates)||void 0===a?void 0:a.width,p),length:this.ensureMetric("distance",null===(r=u.dimensionEstimates)||void 0===r?void 0:r.depth,p),area:this.ensureMetric("area",null===(h=u.dimensionEstimates)||void 0===h?void 0:h.area,p),areaIndoorWithWalls:this.ensureMetric("area",null===(l=u.dimensionEstimates)||void 0===l?void 0:l.areaIndoorWithWalls,p),height:this.ensureMetric("distance",null===(d=u.dimensionEstimates)||void 0===d?void 0:d.height,p)||NaN,keywords:u.keywords||[],ceiling:t?this.mdsCeilingToCeiling(u.ceiling,p):void 0}}return c}ensureMetric(e,t,i){if(null!=t&&null!=i){const s=i===w.WU.IMPERIAL,n="area"===e?U.D6:U.hV;return s?n(t):t}return NaN}ensureOpeningLabelType(e,t){return(0,L.fI)(e)?e:t===w.lJ.OPENING?_.k.DIVIDER:_.k.DOOR_UNKNOWN}mdsCeilingToCeiling(e,t){if(null!=e&&null!=e.maxHeight&&null!=e.minHeight&&null!=e.planes&&e.planes.length>0){const i=[];for(const s of e.planes)if(null!=s.measurements&&s.measurements.length>0){const e=[];for(const i of s.measurements)null!=i.height&&null!=i.bottom&&e.push({height:this.ensureMetric("distance",i.height,t),bottom:z.U$.fromVisionVector(new W.Vector3(i.bottom.x,i.bottom.y,i.bottom.z))});e.length>0&&i.push({measurements:e})}if(i.length>0)return{minHeight:this.ensureMetric("distance",e.minHeight,t),maxHeight:this.ensureMetric("distance",e.maxHeight,t),planes:i}}}}var q=i(98720),Y=i(35336);class Q extends N.g{constructor(e,t=!1,i=!1,s=()=>{}){super(e),this.writeRepairs=t,this.ceilingsEnabled=i,this.broadcast=s,this.queuedMutations=[],this.seenRooms=new Map,this.lastUpdates=new Map,this.entitiesToDelete=new Map,this.deserializer=new X}async read(e){var t,i;const s={modelId:this.getViewId()};e=Object.assign({anonymous:!0},e);const n=await this.query(k.GetRoomBounds,s,e);return(null===(i=null===(t=null==n?void 0:n.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.floors)?this.validateData(this.deserializer.deserialize(n.data.model,this.ceilingsEnabled)):null}async readClassifications({options:e,localizeFn:t}={}){var i;const s=Object.assign(Object.assign({},e),{prefetchKey:"data.roomClassifications",anonymous:!0});return((null===(i=(await this.query(k.GetRoomClassifications,{},s)).data)||void 0===i?void 0:i.roomClassifications)||[]).reduce(((e,i)=>(i&&(e[i.id]=t?t(i):i),e)),{})}get readonly(){return this.config.readonly}set readonly(e){this.config.readonly=e}queueAddNode(e){this.queueMutation(`addBoundaryVertex(modelId: $modelId, id: "${e.id}", vertex: ${this.vertexDetailsFromNode(e)}) { id }`)}queueUpdateNode(e){this.updateEntity("node",e.id,`patchBoundaryVertex(modelId: $modelId, id: "${e.id}", vertex: ${this.vertexDetailsFromNode(e)}) { id }`)}vertexDetailsFromNode(e){return`{\n      floorId: "${e.floorId}",\n      position: { x: ${e.x} y: ${-e.z} }\n    }`}queueRemoveNode(e){this.queueRemoveEntity("node",e.id)}queueAddWall(e){this.queueMutation(`addBoundaryEdge(modelId: $modelId, id: "${e.id}", edge: ${this.edgeDetailsFromWall(e)}) { id }`)}queueUpdateWall(e){this.updateEntity("wall",e.id,`patchBoundaryEdge(modelId: $modelId, id: "${e.id}" edge: ${this.edgeDetailsFromWall(e)}) { id }`)}edgeDetailsFromWall(e){return`\n    {\n      floorId: "${e.floorId}"\n      vertices: ["${e.from.id}", "${e.to.id}"]\n      thickness: ${e.width}\n      units: ${w.WU.METRIC}\n      centerLineBias: ${1-e.bias}\n      type: ${e.type===q.b.SOLID?w.gP.WALL:w.gP.INVISIBLE}\n    }\n    `}queueRemoveWall(e){this.queueRemoveEntity("wall",e.id)}queueAddOpening(e){this.queueMutation(`addEdgeOpenings(modelId: $modelId, id: "${e.wallId}", openings: [${this.openingDetailsFromOpening(e)}]) { id }`)}queueUpdateOpening(e){this.updateEntity("opening",e.id,`patchEdgeOpening(modelId: $modelId, id: "${e.wallId}", opening: ${this.openingDetailsFromOpening(e)}) { id }`)}openingDetailsFromOpening(e){const t=e.lowerElevation;return(0,j.$)(t),`\n    {\n      id: "${e.id}"\n      relativeCenter: ${e.relativePos}\n      type: ${(0,L.q9)(e.label)}\n      label: "${e.label}"\n      width: ${e.width}\n      height: ${e.height?e.height:0}\n      lowerElevation: ${t}\n    }\n    `}queueRemoveOpening(e){this.queueMutation(`removeEdgeOpenings(\n        modelId: $modelId\n        id: "${e.wallId}"\n        openings: ["${e.id}"]\n      )`),this.clearEntityUpdate("opening",e.id)}queueAddRoom(e){this.queueMutation(`addRoom(\n        modelId: $modelId,\n        id: "${e.id}",\n        room: ${this.getRoomDetailsFromRoom(e)}\n      ) { id }`)}queueUpdateRoom(e){const t=this.seenRooms.get(e.id);t&&t!==e&&this.clearEntityUpdate("room",e.id),this.seenRooms.set(e.id,e),this.updateEntity("room",e.id,`patchRoom(\n        modelId: $modelId,\n        id: "${e.id}",\n        room: ${this.getRoomDetailsFromRoom(e)}\n      ) { id }`)}getRoomDetailsFromRoom(e){const t=!e.showDimensions,i=!e.showHeight,s=e.isFlatCeiling()?e.getMinCeilingHeight():NaN;return`\n    {\n      floorId: "${e.floorId}"\n      label: "${this.escapeUserString(e.name)}"\n      classifications: [${e.roomTypeIds.map((e=>`"${e}"`))}],\n      boundary: {\n        edges: [${Array.from(e.walls.values()).map((e=>`"${e.id}"`))}],\n      }\n      holes: [${Array.from(e.holes.values()).map((e=>`{ edges: [${Array.from(e.values()).map((e=>`"${e.id}"`))}] }`))}]\n      dimensionEstimates: {\n        room: "${e.id}",\n        area: ${Number.isNaN(e.area)?0:e.area},\n        areaIndoor: ${Number.isNaN(e.area)?null:e.area},\n        areaIndoorWithWalls: ${Number.isNaN(e.areaWithWalls)?null:e.areaWithWalls},\n        depth: ${Number.isNaN(e.length)||t?0:e.length}\n        width: ${Number.isNaN(e.width)||t?0:e.width}\n        height: ${Number.isNaN(s)||i?0:s}\n        units: ${w.WU.METRIC}\n      },\n      keywords: [${e.allKeywords().map((e=>`"${e}"`))}],\n      ${this.getCeilingDetailsForRoom(e)}\n    }\n    `}getCeilingDetailsForRoom(e){if(null!=e.ceiling){return`ceiling: {\n        planes: [${e.ceiling.planes.map((e=>`{\n          measurements: [${e.measurements.map((e=>{const t=z.U$.toVisionVector(e.bottom);return`{\n            height: ${e.height},\n            bottom: {\n              x: ${t.x},\n              y: ${t.y},\n              z: ${t.z},\n            }\n          }`}))}]\n        }`))}],\n      }`}return"ceiling: {\n        planes: null,\n      }"}queueRemoveRoom(e){this.seenRooms.delete(e.id),this.queueRemoveEntity("room",e.id)}queueRemoveLegacyRooms(e){const t=e.map((e=>`"${e}"`));this.queueMutation(`deleteRoomsAndBoundaryData(\n      modelId: $modelId,\n      selectedData: {\n        ids: [${t.join(",")}],\n        type: ${w.w0.ROOM}\n      }\n    )`)}queueUpdateRoomAssociations(e){if(0===e.length)return;this.queueMutation(`bulkPatchRoomData(\n        modelId: $modelId,\n        updatedRoomAssociations: [${e.map((e=>(e=>`{ ${Object.keys(e).map((t=>`${t}: ${JSON.stringify(e[t])}`)).join(",")} }`)(e)))}]\n      )`)}peekQueuedMutations(){return this.queuedMutations.slice()}async submitQueuedMutations(){if(this.checkForPendingDeletes(),0===this.queuedMutations.length)return;const e=this.queuedMutations.slice();this.queuedMutations.length=0;for(const e of this.lastUpdates.values())e.clear();const t=[];let i=0;const s=async()=>{if(0===t.length)return;const e=B.J1`
        mutation updateRoomBoundaries($modelId: ID!) {
          ${t.map(((e,t)=>`op${t}: ${e}`)).join("\n")}
        }
      `;await this.mutate(e,{modelId:this.getViewId()}),t.length=0,i=0};for(const n of e){const e=n.startsWith("delete");(t.length>40||i+n.length>65536||e)&&await s(),t.push(n),i+=n.length,e&&await s()}await s()}updateEntity(e,t,i){const s=this.lastUpdates.get(e)||new Map;this.lastUpdates.set(e,s);const n=s.get(t);void 0!==n?this.queuedMutations[n]=i:(this.queueMutation(i),s.set(t,this.queuedMutations.length-1))}clearEntityUpdate(e,t){const i=this.lastUpdates.get(e);i&&i.delete(t)}queueRemoveEntity(e,t){var i;const s=null!==(i=this.entitiesToDelete.get(e))&&void 0!==i?i:[];s.push(t),this.entitiesToDelete.set(e,s)}checkForPendingDeletes(){const e=[["room",w.w0.ROOM],["wall",w.w0.BOUNDARYEDGE],["node",w.w0.BOUNDARYVERTEX]];for(const[t,i]of e){const e=this.entitiesToDelete.get(t);if(e){const s=`deleteRoomsAndBoundaryData(\n            modelId: $modelId,\n            selectedData: {\n              ids: [${e.map((e=>`"${e}"`)).join(",")}],\n              type: ${i}\n            }\n          )\n        `;this.queuedMutations.push(s),e.forEach((e=>this.clearEntityUpdate(t,e)))}}this.entitiesToDelete.clear()}queueMutation(e){this.checkForPendingDeletes(),this.queuedMutations.push(e)}escapeUserString(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}validateData(e){var t,i,s;const n=this.config.readonly||!this.writeRepairs;Object.values(e.floors).forEach((e=>{const t={};Object.values(e.edges).forEach((e=>{e.vertices&&e.vertices.forEach((e=>{t[e]=!0}))}));const i={};Object.entries(e.vertices).forEach((([e,s])=>{t[e]?i[e]=s:n?this.broadcast(new Y.Z(`validateData: Would delete orphan node: ${e}`)):(this.broadcast(new Y.Z(`validateData: Deleting orphan node: ${e}`)),this.queueRemoveEntity("node",e))})),e.vertices=i})),Object.values(e.floors).forEach((e=>{Object.entries(e.edges).forEach((([t,i])=>{var s;2===(null===(s=i.vertices)||void 0===s?void 0:s.length)&&e.vertices[i.vertices[0]]&&e.vertices[i.vertices[1]]||(delete e.edges[t],n?this.broadcast(new Y.Z(`validateData: Would delete invalid wall: ${t}`)):(this.broadcast(new Y.Z(`validateData: Deleting invalid wall: ${t}`)),this.queueRemoveEntity("wall",t)))}))}));for(const o of Object.values(e.floors))for(const e of Object.keys(o.rooms)){const a=o.rooms[e];let r=!1;const h=(null!==(t=a.edges)&&void 0!==t?t:[]).concat(null!==(s=null===(i=a.holes)||void 0===i?void 0:i.flat())&&void 0!==s?s:[]);for(const e of h){o.edges[e]||(r=!0)}r&&(n?this.broadcast(new Y.Z(`validateData: Would delete invalid room: ${e}`)):(this.broadcast(new Y.Z(`validateData: Deleting invalid room: ${e}`)),this.queueRemoveEntity("room",e)),delete o.rooms[e])}return Object.values(e.floors).forEach((e=>{const t=t=>{n?this.broadcast(new Y.Z(`validateData: Would delete existing wall: ${t}`)):(this.broadcast(new Y.Z(`validateData: Deleting existing wall: ${t}`)),this.queueRemoveEntity("wall",t)),delete e.edges[t]},i=new Map;Object.entries(e.rooms).forEach((([e,t])=>{for(const s of t.edges||[]){const t=i.get(s)||[];t.push(e),i.set(s,t)}}));const s=new Map;Array.from(Object.entries(e.edges)).forEach((([n,o])=>{if(!o.vertices)return;const a=o.vertices.slice().sort().join(":");if(s.has(a))if(i.has(n)){const o=s.get(a);if(o&&!i.has(o))t(o),s.set(a,n);else if(o){const r=i.get(o);for(const t of r||[]){const i=e.rooms[t].edges||[];for(let e=0;e<i.length;e++)i[e]===o&&(i[e]=n)}t(o),s.set(a,n)}}else t(n);else s.set(a,n)}))})),n||this.submitQueuedMutations(),e}}var K=i(85281),Z=i(37572);class J extends Z.xO{constructor(e,t,i){const s=new ee,n=new te;super({queue:e,path:`${t}/api/v1/jsonstore/model/room-bound-debug/${i}`,batchUpdate:!1,deserialize:e=>s.deserialize(e),serialize:e=>n.serialize(e)})}}class ee{deserialize(e){if(!this.isValid(e))return null;return{mutations:e.mutations.slice(),error:e.error,localData:e.localData,actionList:e.actionList}}isValid(e){return!(!e||"object"!=typeof e)&&(e.mutations&&"object"==typeof e.mutations)}}class te{serialize(e,...t){return e}}var ie=i(46192),se=i(52030),ne=i(90082),oe=i(12837),ae=i(99583),re=i(81662),he=i(99276),le=i(60356);class de extends s.n{constructor(){super(...arguments),this.name="room_bound_data",this.associationSources=[],this.modifiedFloors=new Set,this.layersChecked=!1,this.mdsHasAreaIndoorWithWalls=!0,this.processPromise=Promise.resolve(),this.isProcessingCeilings=!1,this.ceilingRecalcQueue=[],this.afterFinalize=async()=>{if(!this.writeBindings||null==this.appData)throw new Error("Not permitted to write room bounds data");if(this.appData.error)return;const e=this.data.getSnapshot(),t=this.store.peekQueuedMutations();try{this.store.queueUpdateRoomAssociations(this.updateRoomAssociations()),await this.store.submitQueuedMutations(),this.data.getAndClearActionList()}catch(i){throw H.Vy.for(this).info("Error finalizing room bounds data",i),this.data.clearUndoBuffer(),this.appData.error=i,this.appData.commit(),this.debugStore.update({error:`${(new Date).toUTCString()} ${i.message}`,mutations:t,localData:e,actionList:this.data.getAndClearActionList()}),i}},this.addRoom=e=>{if(null!=this.roomData){if(this.roomData.get(e.id)||this.roomData.add(new d.W({id:e.id,floorId:e.floorId,meshSubgroup:-1})),this.addToModifiedFloors(e),this.data.legacyRoomIds.length){this.store.queueRemoveLegacyRooms(this.data.legacyRoomIds);for(const e of this.data.legacyRoomIds)this.roomData.remove(e);this.data.legacyRoomIds.length=0}this.store.queueAddRoom(e)}},this.removeRoom=e=>{null!=this.roomData&&(this.roomData.get(e.id)&&this.roomData.remove(e.id),this.addToModifiedFloors(e),this.store.queueRemoveRoom(e))}}async init(e,t){this.engine=t;const[i,s,d,b,S,E,T]=await Promise.all([t.getModuleBySymbol(l.az),t.market.waitForData(h.o),t.market.waitForData(ae.X),t.market.waitForData(x.q),t.getModuleBySymbol(l.GR),t.getModuleBySymbol(l.sA),t.market.waitForData(oe.A)]);this.floorsData=b,this.layersModule=i,this.modelMeshModule=S,this.raycasterModule=E,this.viewmodeData=d;const A=this.layersModule.layersData.getBaseModelId();if(!A)return t.market.register(g.A,new g.A(null)),s.setSetting(y.qQ,!0),void t.broadcast(new Y.t(new Error("Unable to find view for RoomBoundData")));this.store=new Q({viewId:A,context:this.layersModule.layersData.mdsContext,readonly:!0,baseUrl:e.baseUrl},1===s.getOverrideParam("rbeRepair",0),s.tryGetSetting(se.VS,!1),t.broadcast.bind(t));const L=await this.store.read();this.updateHasAreaIndoorWithWalls(L),this.localeModule=await t.getModuleBySymbol(l.gS),this.debugStore=new J(e.requestQueue,e.baseUrl,A);const B=await this.store.readClassifications({localizeFn:e=>this.localizeRoomClassification(e)});F.xt.forEach((e=>{const t=e.join(F.Q5);B[t]={id:t,label:e.map((e=>{var t;return(null===(t=B[e])||void 0===t?void 0:t.label)||[]})).join(F.Ae),defaultKeywords:(0,f.vQ)(e.map((e=>B[e])))}})),this.data=new g.A(L,B,t.broadcast.bind(t),new le.F(T,b)),this.data.commit(),this.data.rooms.size>0&&s.setSetting(K.n,!0),this.data.clearUndoBuffer(),this.data.resetHistory(),e.readonly||Promise.all([t.market.waitForData(c.q),t.market.waitForData(u.M),t.getModuleBySymbol(l.T9)]).then((([e,i,s])=>{this.roomData=e,this.writeBindings=new n.P(this.data.onWallsChanged({onAdded:e=>{this.addToModifiedFloors(e),this.store.queueAddWall(e)},onUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateWall(e)},onRemoved:e=>{this.addToModifiedFloors(e),this.store.queueRemoveWall(e)}}),this.data.onNodesChanged({onAdded:e=>{this.addToModifiedFloors(e),this.store.queueAddNode(e)},onUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateNode(e)},onRemoved:e=>{this.addToModifiedFloors(e),this.store.queueRemoveNode(e)}}),this.data.onRoomsChanged({onAdded:this.addRoom,onUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateRoom(e)},onChildUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateRoom(e)},onRemoved:this.removeRoom}),this.data.onOpeningsChanged({onAdded:e=>{this.addToModifiedFloors(e),this.store.queueAddOpening(e)},onUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateOpening(e)},onRemoved:e=>{this.addToModifiedFloors(e),this.store.queueRemoveOpening(e)}}),s.onSave((async()=>{i.setProcessingSubState(!0),await this.processPromise,i.setProcessingSubState(!1)}),{dataType:o.p.ROOM_BOUNDS,phase:p.w.BEFORE}),this.data.afterFinalize((async()=>{this.ceilingRecalcQueue.push((async()=>await this.recalculateCeilings())),this.isProcessingCeilings||(this.processPromise=this.flushCeilingCalculations()),this.engine.commandBinder.issueCommand(new m.F({dataTypes:[o.p.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0}))}))),this.writeBindings.cancel(),t.getModuleBySymbol(ne.ZF).then((e=>{e.getSettingsGui().loadPromise.then((()=>{e.getSettingsGui().addButton(0,"Debug","Clear Ceilings",(()=>{this.data.clearAllCeilings(),this.engine.commandBinder.issueCommand(new m.F({dataTypes:[o.p.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0}))}))}))}))})),this.bindings.push(t.subscribe(a.E5,(e=>this.trackRoomBoundsABTest(t,e.application))),t.commandBinder.addBinding(v.l,(e=>this.registerRoomAssociationSource(e.roomAssociation)))),async function(e,t){const[i,s,o,a,d]=await Promise.all([e.market.waitForData(r.zH),e.market.waitForData(I.P),e.market.waitForData(h.o),e.market.waitForData(x.q),e.getModuleBySymbol(l.gS)]);let c=i.application===r.lg.WORKSHOP;const u=(i,n,r,h=[])=>{const l=o.tryGetSetting(R.n9,!1),u=o.tryGetSetting(R._z,!1),p=l||u||c,m=o.tryGetSetting(O.Q$.RoomBounds,!1)||c,g=0===h.length;if(!(m&&p&&g))return[];const f=[];for(const r of t.rooms.values()){const h=(0,P.Ay)(r.id,d,t);if(i(r.name)||i(h)){const t=a.getFloor(r.floorId);if(!t)throw new Error("Unable to find floor for room while generating search results.");f.push(new V(e.commandBinder,s,o,n,r,h,t.id))}}return f.sort(((e,t)=>e.title.localeCompare(t.title)))},p=e=>{},m=e=>new n.P(t.onChanged(e),o.onSettingChanged(D.Y.UnitType,e)),g={renew:()=>{e.commandBinder.issueCommandWhenBound(new C.Oc({id:w.jM.MODELROOM,groupPhraseKey:M.A.SHOWCASE.ROOMS.SEARCH_GROUP_HEADER,getSimpleMatches:u,registerChangeObserver:m,onSearchActivatedChanged:p,groupOrder:100,groupIcon:"edit-floorplan",batchSupported:!1}))},cancel:()=>{e.commandBinder.issueCommandWhenBound(new C.tf(w.jM.MODELROOM))}},f=()=>{c=i.application===r.lg.WORKSHOP,o.tryGetSetting(O.Q$.RoomBounds,!1)||c?g.renew():g.cancel()},v=i.onPropertyChanged("application",f),y=o.onSettingChanged(O.Q$.RoomBounds,f);return f(),new n.P(g,v,y)}(t,this.data).then((e=>this.bindings.push(e))),t.market.register(g.A,this.data),t.market.waitForData(r.zH).then((e=>{this.appData=e,this.trackRoomBoundsABTest(t,e.application)}))}dispose(e){super.dispose(e),this.writeBindings&&this.writeBindings.cancel()}async setReadOnly(e){e!==this.store.readonly&&(this.store.readonly=e,this.writeBindings&&(e?this.writeBindings.cancel():(this.writeBindings.renew(),this.layersChecked||(await this.layersModule.convertModelToLayered(),this.layersModule.layersData.getProxyLayerId()||await this.layersModule.checkForProxyLayer(),this.data.validateGraph()))))}getGrossIndoorArea(e){return this.data.getGrossFloorArea(null,e)}getRoomsByClassification(e){return Array.from(this.data.rooms.values()).filter((t=>t.classifications.some((t=>e.includes(t.id)))))}findRoomIdFromCameraPose({position:e,rotation:t,floorId:i,maxDistance:s=6}){const n=this.modelMeshModule.setChunkSide(W.DoubleSide),o=re.B1.FORWARD.clone().applyQuaternion(t),a=this.floorsData.getFloor(i).meshGroup,r=this.raycasterModule.picking.pick(e,o,(e=>e instanceof he.B&&e.meshGroup===a));this.modelMeshModule.setChunkSide(n);const h=new W.Vector3;if(r&&r.distance<s){const e=-1*Math.min(1,r.distance/2);h.copy(r.point).addScaledVector(o,e)}else h.copy(e);return this.data.findRoomIdForPosition(h,i)}findRoomFromCameraPose(e){const t=this.findRoomIdFromCameraPose(e);return t?this.data.getRoom(t):null}localizeRoomClassification(e){return this.localeModule?Object.assign(Object.assign({},e),{label:(0,P.TG)(e,this.localeModule)}):e}trackRoomBoundsABTest(e,t){Promise.all([e.getModuleBySymbol(l.aF),e.market.waitForData(h.o)]).then((([e,i])=>{const s=this.data.rooms.size>0,n=t===r.lg.WORKSHOP||s&&(0,y.h4)(i);e.trackFeatures(`${y.Yk}:${n}`)}))}addToModifiedFloors(e){this.modifiedFloors.add(e.floorId)}updateRoomAssociations(){const e=new Map;for(const t of this.associationSources)for(const i of t.getPositionId()){if(!i.floorId||!this.modifiedFloors.has(i.floorId)||!(0,ie.C)(this.data,this.layersModule.layersData,i.layerId))continue;const s=this.data.findRoomIdForPosition(i.position,i.floorId,i.roomId);if(s!=i.roomId){const n=e.get(s)||(s?{roomId:s}:{resetRoom:!0}),o=n[t.type]||[];o.push(i.id),n[t.type]=o,e.set(s,n),t.updateRoomForId(i.id,s)}}return this.modifiedFloors.clear(),Array.from(e.values())}updateHasAreaIndoorWithWalls(e){if(e){for(const t in e.floors){const i=e.floors[t];if(i.rooms)for(const e in i.rooms){const t=i.rooms[e];if(null!=t.areaIndoorWithWalls&&!isNaN(t.areaIndoorWithWalls))return void(this.mdsHasAreaIndoorWithWalls=!0)}}this.mdsHasAreaIndoorWithWalls=!1}}async registerRoomAssociationSource(e){this.associationSources.push(e)}async flushCeilingCalculations(){for(this.isProcessingCeilings=!0;this.ceilingRecalcQueue.length>0;)await this.ceilingRecalcQueue[0](),this.ceilingRecalcQueue.shift();this.isProcessingCeilings=!1}async recalculateCeilings(e){this.viewmodeData.isInside()||await this.data.recalculateCeilings(e)}async runMigrations(e,t){await this.computeAllCeilingsIfNecessary(),await this.saveAreaIndoorWithWalls(),this.data.computeLowerElevationForOpenings()}async computeAllCeilingsIfNecessary(){Array.from(this.data.rooms.values()).some((e=>null!=e.ceiling))||(this.ceilingRecalcQueue.push((async()=>await this.recalculateCeilings(!0))),this.processPromise=this.flushCeilingCalculations(),await this.processPromise)}async saveAreaIndoorWithWalls(){this.mdsHasAreaIndoorWithWalls||(this.data.markAllRoomsDirty(),await this.engine.commandBinder.issueCommand(new m.F({dataTypes:[o.p.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0})))}}const ce=de},73026:(e,t,i)=>{"use strict";i.d(t,{k:()=>a});var s=i(68909),n=i(86324),o=i(60552);class a extends s.Object3D{constructor(e,t){super(),this.units=e,this.roomBoundViewData=t,this.userIsInside=!1,this.currentRoomHeight=0,this.linesInScene=!1,this.removeLineTimeout=null,this.linesInScene=!1}onLinesAdded(){}onLinesRemoved(){}onRender(e){const{solid:t,faded:i}=this.calcOpacities(e);(t>.1||i>.1)&&this.userIsInside&&this.roomBoundViewData.roomDimensionsVisible?this.addLinesToScene():this.removeLinesFromScene()}addLinesToScene(){if(!this.linesInScene){for(const e of this.lineSceneObjs())this.add(e),e.startTransition();this.onLinesAdded(),this.linesInScene=!0,this.removeLineTimeout&&(window.clearTimeout(this.removeLineTimeout),this.removeLineTimeout=null)}}removeLinesFromScene(){if(this.linesInScene){const e=()=>{for(const e of this.lineSceneObjs())this.remove(e);this.onLinesRemoved(),this.removeLineTimeout=null};null!=this.removeLineTimeout&&(window.clearTimeout(this.removeLineTimeout),this.removeLineTimeout=null);for(const e of this.lineSceneObjs())e.startTransition(n.ES.FADE_OUT);this.removeLineTimeout=window.setTimeout(e,o.rH),this.linesInScene=!1}}setUserIsInsideRoom(e,t){this.userIsInside=e,this.currentRoomHeight=t}updateUnits(e){this.units=e,this.updateLabelEndpoints()}}},71101:(e,t,i)=>{"use strict";i.d(t,{S:()=>s,j:()=>n});var s,n,o=i(37458);!function(e){e[e.BASE=o.X.roomBounds]="BASE",e[e.OPENING_STENCIL=o.X.roomBounds+1]="OPENING_STENCIL",e[e.EDGE_STENCIL=o.X.roomBounds+2]="EDGE_STENCIL",e[e.ROOM=o.X.roomBounds+3]="ROOM",e[e.EDGE=o.X.roomBounds+4]="EDGE",e[e.OPENING_LINES=o.X.roomBounds+5]="OPENING_LINES",e[e.INSIDE_LINES=o.X.roomBounds+6]="INSIDE_LINES",e[e.NODE=o.X.roomBounds+7]="NODE"}(s||(s={})),function(e){e[e.OPENINGS=0]="OPENINGS",e[e.EDGE=1]="EDGE"}(n||(n={}))},48823:(e,t,i)=>{"use strict";i.d(t,{y:()=>w});var s=i(38069),n=i(18952),o=i(52885),a=i(94814),r=i(68909),h=i(71101),l=i(23689),d=i(60552),c=i(87708),u=i(74634),p=i(19968),m=i(86324),g=i(20854),f=i(73026),v=i(6525);class y extends f.k{constructor(e,t,i,s,n,o,a,r,h,l){super(a,r),this.labelManager=n,this.floorId=o,this.depthMesh=l,this.labels=[],this.lines=[],this.datumLines=[],this.labelLines=[],this.labelsVisible=!1,this.solidOutlines=new m.y4(this.lines,(0,g.ay)(h)),this.datumLinesObj=new v.uG([]),this.updateEndpoints(e,t,i,s),this.updateLabelEndpoints()}lineSceneObjs(){return[this.solidOutlines,this.datumLinesObj.solidDatums]}calcOpacities(e){return{solid:e*g.lO,faded:e*g.z2}}updateEndpoints(e,t,i,s){this.datumLines=e.map((e=>({points:e.points,opacity:1})));const n=[];if(null!=s)for(const e of i){const t=(new r.Vector3).copy(e.points[0]);t.y-=s,n.push({points:[e.points[0].clone(),t]})}this.lines=t.concat(n,i),this.labelLines=t.concat(n).filter((e=>!e.skipLabel)),this.solidOutlines.updateEndpoints(this.lines),this.datumLinesObj.updateEndpoints(this.datumLines),this.updateLabelEndpoints()}onRender(e){var t,i;super.onRender(e);const{solid:s,faded:n}=this.calcOpacities(e);this.solidOutlines.globalOpacity(s),this.datumLinesObj.globalOpacity(s,n);const o=this.userIsInside&&this.roomBoundViewData.roomDimensionsVisible;if(o){for(const e of this.labels)e.setVisible(!0);null===(t=this.datumLabel)||void 0===t||t.setVisible(!0)}else{for(const e of this.labels)e.setVisible(!1);null===(i=this.datumLabel)||void 0===i||i.setVisible(!1)}this.labelsVisible!==o&&(this.labelManager.needsImmediateCollsisionDetection(),this.labelsVisible=o)}onLinesAdded(){this.add(this.datumLinesObj.datumCircles),this.depthMesh.visible=!0}onLinesRemoved(){this.remove(this.datumLinesObj.datumCircles),this.depthMesh.visible=!1}updateLabelEndpoints(){var e;const t=this.labelLines.length-this.labels.length;t>0?this.createLabels(t,this.labels):t<0&&this.deleteLabels(t,this.labels);for(let e=0;e<this.labelLines.length;e++){const t=this.labelLines[e];this.labels[e].updateDimensions(t.points[0],t.points[1],0,this.units),this.labels[e].isVertical(t.points[0],t.points[1])&&(this.labels[e].labelGroupId="inside_height_label")}this.datumLines.length>0&&(null==this.datumLabel&&(this.datumLabel=this.labelManager.createDatumLabel(this.floorId,this),this.datumLabel.setVisible(!1)),null===(e=this.datumLabel)||void 0===e||e.updateDimensions(this.datumLines[0].points[0],this.datumLines[0].points[1],0,this.units))}createLabels(e,t){for(let i=0;i<e;i++){const e=this.labelManager.createInsideLabel(this.floorId,this);e.setVisible(!1),t.push(e)}}deleteLabels(e,t){const i=Math.abs(e);for(let e=0;e<i;e++){const e=t.pop();e&&this.labelManager.deleteLabel(e)}}}const b={baseState:{innerColor:s.V.LENS_GRAY,outerColor:s.V.WHITE,opacity:0},hoverState:{innerColor:s.V.WHITE,outerColor:s.V.WHITE,opacity:.25},selectState:{innerColor:s.V.NEPTUNE,outerColor:s.V.WHITE,opacity:0},dimState:{innerColor:s.V.LENS_GRAY,outerColor:s.V.WHITE,opacity:.5}};class w extends l.r{constructor(e,t,i,a,l,d,u,m,f,v){const I=w.getGeoFromRoom(e,i),D=new r.MeshBasicMaterial({color:s.V.LENS_GRAY,depthTest:!1,side:r.DoubleSide,transparent:!0,opacity:0,blending:r.NormalBlending,blendEquation:r.AddEquation,blendSrc:r.SrcAlphaFactor,blendDst:r.DstColorFactor,stencilRef:65535,stencilFuncMask:1<<h.j.EDGE,stencilFail:r.KeepStencilOp,stencilZFail:r.KeepStencilOp,stencilZPass:r.KeepStencilOp,stencilFunc:r.GreaterStencilFunc,stencilWrite:!0});super(e.id,t,a),this.floorId=t,this.baseHeight=i,this.roomBoundViewData=d,this.labelManager=u,this.units=m,this.calcBaseHeight=f,this.caretsInstanceBuffer=v,this.currRoomLabelRadius=.5,this.potentialLabels=[],this.perimeterLabels=[],this.hideMaterial=new r.ShaderMaterial({vertexShader:c.Om.vertexShader,fragmentShader:c.Om.fragmentShader,uniforms:r.UniformsUtils.clone(c.Om.uniforms),depthTest:!1,side:r.DoubleSide,transparent:!0}),this.depthMaterial=new r.ShaderMaterial({vertexShader:c.Tx.vertexShader,fragmentShader:c.Tx.fragmentShader,uniforms:r.UniformsUtils.clone(c.Tx.uniforms),depthTest:!0,side:r.FrontSide}),this.perimeterLabelsVisible=!1,this.fullLabelVisible=!1,this.hoverTimer=null,this.labelHovered=!1,this.heightLines=new r.Group,this.heightLinesInScene=!1,this.heightLabels=[],this.insideNess=1,this.getLabelRadiusPx=e=>{const t=e.split("\n"),i=t.reduce(((e,t)=>Math.max(e,t.length)),0),s=(0,n.yp)(i,0,0),o=.5*s.width,a=.5*s.height*t.length;return Math.max(o,a)},this.worldRadiusToScreen=(()=>{const e=[new r.Vector3(1,0,0),new r.Vector3(-1,0,0),new r.Vector3(0,0,1),new r.Vector3(0,0,-1)],t=new r.Vector3,i=new r.Vector2,s=new r.Vector2,n=new r.Vector3;return(o,a,r)=>{let h=Number.MAX_SAFE_INTEGER;(0,p.bz)(this.cameraData,o,i,n),r.copy(i);for(const r of e){t.copy(o).addScaledVector(r,a),(0,p.bz)(this.cameraData,t,s,n);const e=i.distanceTo(s);e<h&&(h=e)}return h}})(),this.updateCarets=(()=>{const e=[new r.Vector2,new r.Vector2,new r.Vector2,new r.Vector2];return()=>{const t=this.cameraData.metersPerPx(),i=this.room.length/t,s=this.room.width/t,n=this.roomLabel.getSize(),o=n.width+2>i,a=n.height+2>s,r=this.fullLabelVisible&&(o||a),h=this.roomBoundViewData.roomDimensionsVisible&&this.roomBoundViewData.roomWallsVisible;this.room.canDisplayDimensions()&&!this.perimeterLabelsVisible&&this.fullLabelVisible&&!r&&h?(this.caretsInstanceBuffer.setVisibilityForInstances(this,!0),e[0].subVectors(this.room.w2,this.room.w1).normalize(),e[1].subVectors(this.room.w1,this.room.w2).normalize(),e[2].subVectors(this.room.l2,this.room.l1).normalize(),e[3].subVectors(this.room.l1,this.room.l2).normalize(),this.caretsInstanceBuffer.updateStateForInstances(this,[{normal:e[0],tip:this.room.w1,height:this.baseHeight},{normal:e[1],tip:this.room.w2,height:this.baseHeight},{normal:e[2],tip:this.room.l1,height:this.baseHeight},{normal:e[3],tip:this.room.l2,height:this.baseHeight}])):this.caretsInstanceBuffer.setVisibilityForInstances(this,!1)}})(),this.main2DMesh=new r.Mesh(I,D),this.baseHeight+=g.u4,this.standardMaterial=D,this.renderOrder=h.S.ROOM,this.roomLabel=this.labelManager.createRoomLabel(e.floorId,e.id,this.main2DMesh),this.roomLabel.setVisible(!e.hide),this.room=e,this.caretsInstanceBuffer.allocInstance(this),this.updateRoomLabelPositionAndText(!0),this.colors=b,this.extrusionMesh=new r.Mesh(w.getExtrudedGeo(this.room,this.baseHeight),this.depthMaterial),this.animation.onChanged((()=>{const e=this.prevColorState;this.standardMaterial.color.lerpColors(e.innerColor,this.targetColorScheme.innerColor,this.animation.value);const t=(0,o.C)(e.opacity,this.targetColorScheme.opacity,this.animation.value);this.opacity=t}));const{datumLines:S,floorLines:E,roofLines:M,height:C}=this.calculateInsideModeLinePositions();this.insideModeLines=new y(S,E,M,C,u,e.floorId,this.units,this.roomBoundViewData,l,this.extrusionMesh),this.main2DMesh.add(this.insideModeLines)}hasIntersectionPriorityWithRespectTo(e){return!(!e.object||!e.object.isModelMesh)}dispose(){this.labelManager.deleteLabel(this.roomLabel);for(const e of this.perimeterLabels)this.labelManager.deleteLabel(e),e.dispose();for(const e of this.heightLabels)this.labelManager.deleteLabel(e),e.dispose();this.datumLabel&&(this.labelManager.deleteLabel(this.datumLabel),this.datumLabel.dispose()),this.clearHoverTimer(),this.caretsInstanceBuffer.removeInstance(this)}hoverRoomLabel(e){const t=()=>{if(!e&&this.roomLabel.getDisplayingTooltip()===e||e&&this.fullLabelVisible)return void(e||(this.labelHovered=!1,this.updateMaterial()));this.roomLabel.setDisplayingTooltip(e),this.updateMaterial();const t=this.roomLabel.label.collider.material;t.opacity=e?.65:0,t.transparent=!0,this.updateRoomLabelPositionAndText(!1),this.updateCarets()};this.labelHovered=e,e?null===this.hoverTimer&&(this.hoverTimer=window.setTimeout(t,d.jd),this.updateMaterial()):(t(),this.clearHoverTimer())}updateUnits(e){this.units=e,this.insideModeLines.updateUnits(this.units),this.updateLabels()}updateGeo(e){this.room=e;const t=isNaN(this.room.floorHeight)?this.calcBaseHeight(this.room):this.room.floorHeight;this.baseHeight=t+g.u4;const i=w.getGeoFromRoom(e,t);this.main2DMesh.geometry.dispose(),this.main2DMesh.geometry=i,this.main2DMesh.geometry.computeBoundingBox();const s=w.getExtrudedGeo(e,t);this.extrusionMesh.geometry.dispose(),this.extrusionMesh.geometry=s,this.updateRoomLabelPositionAndText(!1),this.updateLabels(),this.createHeightObjects();const{datumLines:n,floorLines:o,roofLines:a,height:r}=this.calculateInsideModeLinePositions();this.insideModeLines.updateEndpoints(n,o,a,r)}beforeRender(){this.standardMaterial.opacity=this.opacity*(1-this.pitchFactor)*Number(this.roomBoundViewData.roomWallsVisible);const e=this.dimState.active?.5:1;this.caretsInstanceBuffer.setOpacityForInstances(this,e),this.updateLabelBillboard(),this.updateMaterial(),this.updateCarets()}updateLabelBillboard(){if(this.isRoomLabelVisible()){const{position:e,rotation:t,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,n=this.cameraData.isOrtho()?this.cameraData.zoom():1,o=this.cameraData.aspect(),a=.1;this.roomLabel.label.quaternion.copy(t),this.roomLabel.label.scaleBillboard(e,t,i,n,s,o,a),this.roomLabel.label.updateMatrix(),this.roomLabel.label.updateMatrixWorld()}}updateLabelVisibility(){const e=this.hoverState.active||this.labelHovered;this.perimeterLabelsVisible=this.roomBoundViewData.roomDimensionsVisible&&(this.selectState.active||e&&(0,p.aY)(this.pitchFactor))&&this.insideNess<.9,this.updateLabels();for(const e of this.perimeterLabels)e.setVisible(this.perimeterLabelsVisible);const t=this.perimeterLabelsVisible&&!(0,p.aY)(this.pitchFactor);for(const e of this.heightLabels)e.setVisible(t);this.datumLabel&&this.datumLabel.setVisible(t),this.updateCarets()}updateMaterial(){this.main2DMesh.material=this.room.hide?this.hideMaterial:this.standardMaterial,super.updateMaterial();const e=this.hoverState.active||this.labelHovered,t=(0,p.aY)(this.pitchFactor);(this.selectState.active||e)&&!t&&this.roomBoundViewData.roomDimensionsVisible?this.heightLinesInScene||(this.main2DMesh.add(this.heightLines),this.heightLinesInScene=!0):this.heightLinesInScene&&(this.main2DMesh.remove(this.heightLines),this.heightLinesInScene=!1),e&&t&&(this.targetColorScheme=this.colors.hoverState),this.hideMaterial.uniforms.opacity.value=e?1:0;const i=this.standardMaterial;this.prevColorState.innerColor.copy(i.color),this.prevColorState.opacity=i.opacity,this.animation.modifyAnimation(0,1,d.JT,a.WD),this.roomLabel.setDimmed(this.dimState.active),this.roomLabel.setVisible(this.isRoomLabelVisible()),this.updateLabelVisibility()}isRoomLabelVisible(){const e=this.hoverState.active||this.labelHovered;return!(this.insideNess>.9)&&((!this.room.hide||e)&&this.potentialLabels.length>0)}updateText(e,t){this.potentialLabels=e,this.updateRoomLabelPositionAndText(t),this.updateCarets()}static getGeoFromRoom(e,t){const{points:i,faces:s}=e.getGeometry(),n=i.map((e=>[e.x,t,e.y])).flat(1),o=new r.BufferGeometry;return o.setAttribute("position",new r.BufferAttribute(new Float32Array(n),3)),o.setIndex(s.flat(1)),o}static getExtrudedGeo(e,t){const{points:i,faces:s}=e.getGeometry(),n=i.map((e=>[e.x,t,e.y])),o=s.slice(),a=e.calculateMinimalInnerLoop(.01);for(const e of a.wallLoop)for(let i=0;i<e.length;i++){const s=n.length,a=e[i],r=e[(i+1)%e.length],h=[a.x,t,a.z],l=[r.x,t,r.z],d=[r.x,t+100,r.z],c=[a.x,t+100,a.z];n.push(h,l,d,c),o.push([s+0,s+2,s+1],[s+0,s+3,s+2])}const h=new r.BufferGeometry;return h.setAttribute("position",new r.BufferAttribute(new Float32Array(n.flat(1)),3)),h.setIndex(o.flat(1)),h}updateRoomLabelPositionAndText(e){if(0===this.potentialLabels.length)return;const t=[];if(!e){const{position:e}=this.roomLabel.label,i={x:e.x,y:e.z};this.room.holesCW.find((e=>{const t=e.map((e=>({x:e.x,y:e.z})));return(0,u.L)(i,t)}))||t.push({point:e.clone(),radius:this.currRoomLabelRadius})}const i=this.room.getViewCenter(new r.Vector3,1.5);i.y=this.baseHeight+d.Dh;const s=this.room.getViewCenterDistance(1.5);t.push({point:i,radius:s});const{screenPosition:n}=(0,p.bz)(this.cameraData,i,new r.Vector2,new r.Vector3),o=new r.Vector2;for(const e of t){this.roomLabel.label.position.copy(e.point),this.roomLabel.label.position.y=this.baseHeight+d.Dh,this.currRoomLabelRadius=e.radius;let t=!1;this.fullLabelVisible=!0;for(const i of this.potentialLabels){const s=this.getLabelRadiusPx(i),a=1.5*this.worldRadiusToScreen(this.roomLabel.label.position,e.radius,o),r=o.distanceTo(n);if(!this.cameraData.pose.isOrtho()||s+r<=a||this.roomLabel.getDisplayingTooltip()){this.roomLabel.label.text=i,t=!0;break}this.fullLabelVisible=!1}if(t)break}}calculateInsideModeLinePositions(){const e=this.room.getMaxCeilingDatum(),t=[];if(e){const i=new r.Vector3(e.position.x,this.baseHeight,e.position.z),s=new r.Vector3(e.position.x,this.baseHeight+e.height,e.position.z);t.push({points:[i,s]})}const i=[],s=this.room.canDisplayHeight()?this.room.getMinCeilingHeight():void 0;if(null!=s){const e=this.baseHeight+s,t=this.room.minimalInnerLoop;for(const s of t){const t=s.length;for(let n=0;n<t;n++){const o=(new r.Vector3).copy(s[n]);o.y=e;const a=(new r.Vector3).copy(s[(n+1)%t]);a.y=e,i.push({points:[o,a]})}}}const n=[];for(const e of this.room.minimalInnerEdges)e.solid&&n.push({points:[new r.Vector3(e.start.x,this.baseHeight,e.start.z),new r.Vector3(e.end.x,this.baseHeight,e.end.z)],skipLabel:e.skipInsideLabel});return{datumLines:t,roofLines:i,height:s,floorLines:n}}updateLabels(){var e;if(!this.perimeterLabelsVisible)return;const t=this.room.hide?[]:this.room.minimalInnerEdges,i=this.room.canDisplayHeight()?t.filter((e=>e.needsHeightLabel)):[],s=i.length;for(;t.length>this.perimeterLabels.length;)this.perimeterLabels.push(this.labelManager.createPerimeterLabel(this.room.floorId,this.main2DMesh,!0));for(;s>this.heightLabels.length;){const e=this.labelManager.createHeightLabel(this.room.floorId,!1,this.main2DMesh,!0);e.labelGroupId=this.room.id,this.heightLabels.push(e)}for(;t.length<this.perimeterLabels.length;){const e=this.perimeterLabels.pop();if(!e)throw new Error("Label should exist!");this.labelManager.deleteLabel(e)}for(;s<this.heightLabels.length;){const e=this.heightLabels.pop();if(!e)throw new Error("Label should exist!");this.labelManager.deleteLabel(e)}for(let e=0;e<t.length;e++){const i=t[e],s=i.start.clone();s.y=this.baseHeight;const n=i.end.clone();n.y=this.baseHeight,this.perimeterLabels[e].updateDimensions(s,n,0,this.units)}for(let e=0;e<s;e++){const t=i[e].start.clone();t.y=this.baseHeight;const s=t.clone();s.y=this.baseHeight+this.room.getMinCeilingHeight(),this.heightLabels[e].updateDimensions(t,s,0,this.units)}const n=this.room.getMaxCeilingDatum();if(null!=n){null==this.datumLabel&&(this.datumLabel=this.labelManager.createDatumLabel(this.room.floorId,this.main2DMesh),this.datumLabel.labelGroupId=this.room.id+"_max_height",this.datumLabel.labelHeightFraction=2/3);const t=n.position.clone();t.y=this.baseHeight;const i=t.clone();i.y+=n.height,null===(e=this.datumLabel)||void 0===e||e.updateDimensions(t,i,0,this.units)}else this.datumLabel&&(this.datumLabel.dispose(),this.labelManager.deleteLabel(this.datumLabel),this.datumLabel=null);this.labelManager.needsImmediateCollsisionDetection()}clearHoverTimer(){null!==this.hoverTimer&&(clearTimeout(this.hoverTimer),this.hoverTimer=null)}createHeightObjects(){this.heightLines.clear();const e=[],t=(t,i,s=e)=>{s.push({points:[t.clone(),i.clone()]})},i=[],s=new r.Vector3,n=new r.Vector3,o=this.room.minimalInnerLoop,a=this.room.getMinCeilingHeight(),h=this.baseHeight+a;for(const e of this.room.minimalInnerEdges)e.solid&&(s.copy(e.start),s.y=this.baseHeight,n.copy(e.end),n.y=this.baseHeight,t(s,n));if(this.room.canDisplayHeight())for(const e of o){const i=e.length;for(let o=0;o<i;o++)s.copy(e[o]),s.y=h,n.copy(e[(o+1)%i]),n.y=h,t(s,n),s.copy(e[o]),s.y=this.baseHeight,n.copy(s),n.y+=a,t(s,n)}const l=this.room.getMaxCeilingDatum();l&&(s.copy(l.position),s.y=this.baseHeight,n.copy(s),n.y+=l.height,t(s,n,i)),this.dhOutlines=new v.M2(e,[]),this.dhDatumLines=new v.hZ(i),this.heightLines.add(this.dhOutlines),this.heightLines.add(this.dhDatumLines)}setIsInside(e){this.insideModeLines.setUserIsInsideRoom(e,this.baseHeight)}onRender(e,t){this.pitchFactor=e,this.insideNess=t,this.raycastEnabled=t<.1&&(this.roomBoundViewData.roomDimensionsVisible||(0,p.aY)(this.pitchFactor)),this.insideModeLines.onRender(t);const i=(1-t)*e;this.dhOutlines&&this.dhOutlines.globalOpacity(i),this.dhDatumLines&&this.dhDatumLines.globalOpacity(i)}raycast(e,t){if(!this.raycastEnabled)return;const i=[];if(this.main2DMesh.raycast(e,i),i.length>0){i[0].object=this,t.push(i[0])}}}},23689:(e,t,i)=>{"use strict";i.d(t,{r:()=>r});var s=i(19968),n=i(92237),o=i(68909),a=i(71101);class r{constructor(e,t,i){this.roomBoundsId=e,this.floorId=t,this.cameraData=i,this.visible=!0,this.animation=new n.z(0),this.prevColorState={opacity:1,innerColor:new o.Color,outerColor:new o.Color},this.pitchFactor=1,this.raycastEnabled=!0,this.fullyInitialized=!1,this.opacity=1,this.selectState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.hoverState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.highlightState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.dimState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.name=e,this.renderOrder=a.S.BASE}updateMaterial(){var e;let t=this.colors.baseState;this.dimState.active&&(t=this.colors.dimState),this.hoverState.active&&(t=this.colors.hoverState),this.highlightState.active&&(t=null!==(e=this.colors.highlightState)&&void 0!==e?e:this.colors.selectState),this.selectState.active&&(t=this.colors.selectState);t!==this.targetColorScheme&&(this.targetColorScheme=t)}tickAnimations(e){this.animation.tick(e)}onRender(e,t){this.pitchFactor=e,this.raycastEnabled=(0,s.aY)(this.pitchFactor)}}},6525:(e,t,i)=>{"use strict";i.d(t,{hZ:()=>f,M2:()=>g,uG:()=>v});var s=i(68909),n=i(45138),o=i.n(n),a=i(68216),r=i.n(a);const h={uniforms:{screenSize:{value:new s.Vector2(0,0)},pixelRatio:{value:1},color:{value:new s.Vector3(1,1,1)},cameraPos:{value:new s.Vector3(0,0,0)},radius:{value:10},opacity:{value:1},depthTex:{value:null},fadeMaxDepth:{value:100},translationOffset:{value:new s.Vector3(0,0,0)}},vertexShader:o(),fragmentShader:r()};class l extends s.Mesh{constructor(e,t){const i=new Float32Array([-9999,-9999,-9999,9999,9999,9999,-9999,-9999,-9999,9999,9999,9999]),n=new Float32Array([-1,1,1,1,1,-1,-1,-1]),o=new s.InstancedBufferGeometry;o.setAttribute("position",new s.Float32BufferAttribute(i,3)),o.setAttribute("offsetDirection",new s.Float32BufferAttribute(n,2)),o.setIndex([0,3,1,1,3,2]);const a={FADE_WIDTH:.8.toFixed(3)},r=null==t?void 0:t.fadeDepth,l=null==t?void 0:t.fadeDepthTexture;null!=r&&null!=l&&(a.FADE_DEPTH=r.toFixed(3));super(o,new s.ShaderMaterial({uniforms:s.UniformsUtils.clone(h.uniforms),vertexShader:h.vertexShader,fragmentShader:h.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,defines:a})),this.material.uniforms.depthTex.value=null==l?void 0:l.texture,this.setPositions(e),this.setMaterialParams(t),this.frustumCulled=!1,this.onBeforeRender=e=>{e.getSize(this.material.uniforms.screenSize.value),this.material.uniforms.pixelRatio.value=e.getPixelRatio()}}setMaterialParams(e){null!=e.color&&this.material.uniforms.color.value.copy(e.color),null!=e.opacity&&(this.material.uniforms.opacity.value=e.opacity),null!=e.radius&&(this.material.uniforms.radius.value=e.radius),null!=e.translationOffset&&this.material.uniforms.translationOffset.value.copy(e.translationOffset)}setPositions(e){this.geometry.dispose();const t=new Float32Array(3*e.length);for(let i=0;i<e.length;i++)t[3*i]=e[i].position.x,t[3*i+1]=e[i].position.y,t[3*i+2]=e[i].position.z;const i=new s.InstancedBufferAttribute(t,3);this.geometry.setAttribute("center",i),i.needsUpdate=!0}}var d=i(86324),c=i(71101),u=i(20854),p=i(38069),m=i(60552);class g extends s.Group{constructor(e,t){super(),this.occlusionLine=new d.y4(e,u.lQ),this.perspectiveLine=new d.y4(e,u.Lv),this.occlusionLineFaded=new d.y4(t,u.Pm),this.perspectiveLineFaded=new d.y4(t,u.Vr),this.add(this.perspectiveLine),this.add(this.occlusionLine),this.add(this.occlusionLineFaded),this.add(this.perspectiveLineFaded)}updateEndpoints(e,t){this.occlusionLine.updateEndpoints(e),this.perspectiveLine.updateEndpoints(e),this.occlusionLineFaded.updateEndpoints(t),this.perspectiveLineFaded.updateEndpoints(t)}globalOpacity(e){this.perspectiveLine.globalOpacity(e*u.lO),this.occlusionLine.globalOpacity(e*u.jT),this.perspectiveLineFaded.globalOpacity(e*u.lO),this.occlusionLineFaded.globalOpacity(e*u.jT)}}class f extends s.Group{constructor(e){super(),this.occlusionDatums=new d.y4(e,u.dr),this.perspectiveDatums=new d.y4(e,u.LH);const t=[];for(const i of e)for(const e of i.points)t.push({position:e});this.datumCircles=new l(t,{radius:5}),this.renderOrder=c.S.INSIDE_LINES,this.occlusionDatums.renderOrder=this.renderOrder,this.perspectiveDatums.renderOrder=this.renderOrder,this.datumCircles.renderOrder=this.renderOrder,this.add(this.occlusionDatums),this.add(this.perspectiveDatums),this.add(this.datumCircles)}globalOpacity(e){this.perspectiveDatums.globalOpacity(e*u.lO),this.occlusionDatums.globalOpacity(e*u.jT),this.datumCircles.setMaterialParams({opacity:e*u.lO})}}class v extends s.Group{constructor(e,t){super();const i={dashed:!0,dashSize:10,gapSize:4,lineWidth:u.kV,color:p.V.WHITE,dashUnits:d.EX.PIXELS,depthWrite:!1,depthTest:!1,depthFunc:s.LessDepth,globalOpacity:u.lO,transitionType:d.ES.FADE_IN,transitionDuration:m.rH},n={radius:5};t&&(i.fadeDepth=m.Zc,i.fadeDepthTexture=t,n.fadeDepth=m.Zc,n.fadeDepthTexture=t),this.solidDatums=new d.y4([],i),this.datumCircles=new l([],n),this.updateEndpoints(e)}updateEndpoints(e){this.solidDatums.updateEndpoints(e);const t=[];for(const i of e)for(const e of i.points)t.push({position:e});this.datumCircles.setPositions(t)}globalOpacity(e,t){this.solidDatums.globalOpacity(e),this.datumCircles.setMaterialParams({opacity:e})}translationOffset(e){this.solidDatums.translationOffset(e),this.datumCircles.setMaterialParams({translationOffset:e})}}},50469:(e,t,i)=>{"use strict";i.r(t),i.d(t,{RoomBoundEdgeView:()=>m,RoomBoundEndHandleView:()=>_,RoomBoundHandleView:()=>y,RoomBoundOpeningHandleView:()=>H,RoomBoundOpeningView:()=>k,RoomBoundRenderer:()=>Oe,RoomBoundStartHandleView:()=>G,RoomBoundView:()=>l.r,default:()=>Xe});var s=i(38069),n=i(25601),o=i(52885),a=i(94814),r=i(68909),h=i(71101),l=i(23689),d=i(60552),c=i(40397);const u=(()=>{const e=new r.Vector3,t=new r.Vector2,i=new r.Vector2,s=new r.Line3;return(n,o,a,h,l,u,p)=>{s.set(n,o);const m=s.closestPointToPoint(u.ray.origin,!0,e);t.set(m.x,m.z),i.set(u.ray.origin.x,u.ray.origin.z);const g=t.distanceTo(i),f=u.ray.origin.distanceTo(s.start),v=(0,c.ff)(f,h.pose.projection.asThreeMatrix4(),h.width),y=d.ub*v;g<.5*Math.max(a,d.FY)+y&&p.push({distance:f,object:l,point:m.clone(),face:{a:-1,b:-1,c:-1,materialIndex:-1,normal:new r.Vector3(0,1,0)}})}})(),p={baseState:{innerColor:s.V.WHITE,outerColor:s.V.WHITE,opacity:1},hoverState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1},selectState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1},dimState:{innerColor:s.V.WHITE,outerColor:s.V.WHITE,opacity:.5},highlightState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1}};class m extends l.r{constructor(e,t,i,l,c,u){super(e,t,i),this.floorId=t,this.instanceBuffer=l,this.lineLabel=c,this.isAddState=u,this.line3=new r.Line3(new r.Vector3,new r.Vector3),this.widthCache=.1,this.currOutlineColor=new r.Color,this.currInnerColor=new r.Color,this.updateMaterial=()=>{super.updateMaterial(),this.targetColorScheme!==p.highlightState||this.isAddState()||(this.targetColorScheme=p.baseState),this.prevColorState.innerColor.copy(this.currInnerColor),this.prevColorState.outerColor.copy(this.currOutlineColor),this.prevColorState.opacity=this.opacity,this.animation.modifyAnimation(0,1,d.JT,a.WD),this.lineLabel.setVisible(this.selectState.active||this.highlightState.active||this.hoverState.active)},this.onEdgePositionChanged=(()=>{const e=new r.Vector3,t=new r.Vector3,i=new r.Vector3,s=new r.Vector3,o=new r.Vector3,a=new r.Vector3,h=new r.Vector3;return(r,l,d)=>{const c=r.getWall(this.roomBoundsId);c.from.getVec3(e),c.to.getVec3(t),c.getBiasAdjustmentVec(h),i.set(e.x,e.y+l,e.z),s.set(t.x,t.y+l,t.z),o.addVectors(i,h),a.addVectors(s,h),this.line3.start.copy(o),this.line3.end.copy(a),this.widthCache=c.width,this.lineLabel.updateDimensions(o,a,c.width,d);const u=(0,n.A)(c,r);this.instanceBuffer.setGeometryForInstance(this,l,o.x,o.z,a.x,a.z,c.width,i.x,i.z,s.x,s.z,u)}})(),this.instanceBuffer.allocInstance(this),this.renderOrder=h.S.EDGE,this.colors=p,this.animation.onChanged((()=>{const e=this.prevColorState,t=this.targetColorScheme;this.currOutlineColor.lerpColors(e.outerColor,t.outerColor,this.animation.value),this.currInnerColor.lerpColors(e.innerColor,t.innerColor,this.animation.value);const i=(0,o.C)(e.opacity,t.opacity,this.animation.value);this.opacity=i,this.instanceBuffer.setColorsForInstance(this,this.currOutlineColor,this.currInnerColor),this.instanceBuffer.setOpacityForInstance(this,this.opacity)})),this.instanceBuffer.setColorsForInstance(this,s.V.WHITE,s.V.WHITE),this.instanceBuffer.setOpacityForInstance(this,1)}raycast(e,t){u(this.line3.start,this.line3.end,this.widthCache,this.cameraData,this,e,t)}tickAnimations(e){super.tickAnimations(e),this.lineLabel.tickAnimations(e)}beforeRender(){}setLabelVisible(e){this.lineLabel.setVisible(e)}dispose(){this.lineLabel.dispose(),this.instanceBuffer.removeInstance(this)}onRender(e,t){super.onRender(e,t),this.lineLabel.update()}}var g=i(81662);const f={baseState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL},hoverState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL},selectState:{opacity:1,innerColor:s.V.MP_BRAND,outerColor:s.V.WHITE},dimState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL}},v=new r.Plane;class y extends l.r{constructor(e,t,i,s){super(e,t,i),this.floorId=t,this.instanceBuffer=s,this.position=new r.Vector3,this.targetRadius=.3,this.prevRadius=.3,this.currOuterColor=f.baseState.outerColor.clone(),this.currInnerColor=f.baseState.innerColor.clone(),this.currRadius=d.m7,this.renderOrder=h.S.NODE,this.colors=f,this.animation.onChanged((()=>this.onAnimationChange())),this.instanceBuffer.allocInstance(this),this.instanceBuffer.setColorsForInstance(this,this.currOuterColor,this.currInnerColor),this.instanceBuffer.setRadiusForInstance(this,this.currRadius),this.instanceBuffer.setOpacityForInstance(this,1)}onAnimationChange(){const e=this.prevColorState,t=this.targetColorScheme;this.currOuterColor.lerpColors(e.outerColor,t.outerColor,this.animation.value),this.currInnerColor.lerpColors(e.innerColor,t.innerColor,this.animation.value),this.instanceBuffer.setColorsForInstance(this,this.currOuterColor,this.currInnerColor),this.opacity=(0,o.C)(e.opacity,t.opacity,this.animation.value),this.instanceBuffer.setOpacityForInstance(this,this.opacity);const i=(0,o.C)(this.prevRadius,this.targetRadius,this.animation.value);this.instanceBuffer.setRadiusForInstance(this,i)}beforeRender(){}onRender(e,t){super.onRender(e,t)}raycast(e,t){v.setFromNormalAndCoplanarPoint(g.B1.UP,this.position);const i=e.ray.intersectPlane(v,new r.Vector3);if(i){const s=e.ray.origin.distanceTo(this.position),n=(0,c.ff)(s,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),o=d.ub*n;i.distanceTo(this.position)<d.m7+o&&t.push({point:i,normal:g.B1.UP.clone(),distance:i.distanceTo(e.ray.origin),object:this})}}updateMaterial(){this.prevRadius=this.currRadius,this.targetRadius=d.m7+(this.hoverState.active?d.xX:0)+(this.selectState.active?d.xX:0),super.updateMaterial(),this.prevColorState.innerColor.copy(this.currInnerColor),this.prevColorState.outerColor.copy(this.currOuterColor),this.prevColorState.opacity=this.opacity,this.animation.modifyAnimation(0,1,d.JT,a.WD)}updatePosition(e){this.position.copy(e),this.instanceBuffer.setPositionForInstance(this,e)}dispose(){this.instanceBuffer.removeInstance(this)}}var b=i(87708),w=i(20854),I=i(86324),D=i(73026),S=i(6525),E=i(76185);const M=new r.Vector3,C=(e,t,i,s,n)=>(M.subVectors(t,s.position).normalize(),n.subVectors(t,e).normalize(),n.set(-n.z,n.y,n.x),n.multiplyScalar(-Math.sign(n.dot(M))*i),n);class T extends D.k{constructor(e,t,i,s,n,o,a,l,d,c){super(n,l),this.floorId=s,this.baseHeight=o,this.cameraPoseData=a,this.labelManager=d,this.datumLabels=[],this.heightAboveRoom=0,this.heightDatum={btm:new r.Vector3},this.endPoints={start:new r.Vector3,end:new r.Vector3,halfWidth:.1},this.shouldSnapToWall=!1,this.applyViewOffsetToLines=(()=>{const e=new r.Vector3,t=new r.Vector3;return()=>{C(this.endPoints.start,this.endPoints.end,this.endPoints.halfWidth,this.cameraPoseData,e);const i=this.baseHeight-this.currentRoomHeight;this.heightAboveRoom=i;const s=Math.abs(i)<.05?-i:0;t.set(0,s,0),this.shouldSnapToWall&&t.add(e),this.solidLines.translationOffset(t),this.fadedLines.translationOffset(t),this.updateHeightDatumLines(e),this.updateHeightAboveLines(e)}})(),this.updateHeightAboveLines=(()=>{const e=new r.Vector3,t=new r.Vector3,i=new r.Vector3,s=new r.Vector3;return n=>{const o=this.heightAboveRoom-w.u4,a=[{points:[e.copy(this.endPoints.start).addScaledVector(g.B1.DOWN,o).add(n),t.copy(this.endPoints.start).add(n)]},{points:[i.copy(this.endPoints.end).addScaledVector(g.B1.DOWN,o).add(n),s.copy(this.endPoints.end).add(n)]}];this.heightAboveLines.updateEndpoints(a)}})(),this.solidLines=new I.y4(e,(0,w.ay)(c)),this.fadedLines=new I.y4(i,(0,w.ay)(c,w.BC)),this.heightAboveLines=new I.y4([],(0,w.ay)(c,w.BC,w.Wh)),this.datumLines=new S.uG(t,c),this.widthLabel=this.labelManager.createInsideLabel(this.floorId,this),this.widthLabel.setVisible(!1),this.solidLines.renderOrder=h.S.INSIDE_LINES,this.fadedLines.renderOrder=h.S.INSIDE_LINES}updateEndpoints(e,t,i,s,n,o){this.units=o,this.heightDatum=i,this.baseHeight=i.btm.y,this.endPoints=s,this.shouldSnapToWall=n,this.applyViewOffsetToLines(),this.solidLines.updateEndpoints(e),this.fadedLines.updateEndpoints(t),this.widthLabel.updateDimensions(this.endPoints.start,this.endPoints.end,0,this.units)}updateLabelEndpoints(){for(const e of this.datumLabels)e.updateUnits(this.units);this.widthLabel.updateUnits(this.units)}lineSceneObjs(){return[this.solidLines,this.fadedLines,this.heightAboveLines,this.datumLines.solidDatums]}calcOpacities(e){return{solid:e*w.lO,faded:e*w.z2}}onLinesAdded(){this.add(this.datumLines.datumCircles)}onLinesRemoved(){this.remove(this.datumLines.datumCircles)}setColor(e){this.solidLines.color(e),this.fadedLines.color(e)}setWidth(e){this.solidLines.lineWidth(e),this.fadedLines.lineWidth(e)}onRender(e){super.onRender(e);const t=this.calcOpacities(e);this.solidLines.globalOpacity(t.solid),this.fadedLines.globalOpacity(t.solid),this.datumLines.globalOpacity(t.solid,t.faded);const i=this.userIsInside&&this.roomBoundViewData.roomDimensionsVisible;for(const e of this.datumLabels)e.setVisible(i);this.widthLabel.setVisible(i)}setUserIsInsideRoom(e,t){super.setUserIsInsideRoom(e,t),this.applyViewOffsetToLines()}updateHeightDatumLines(e){const t=this.heightDatum.top?[{points:[this.heightDatum.btm,this.heightDatum.top]}]:[];this.heightAboveRoom>d.W5&&t.push({points:[(new r.Vector3).copy(this.heightDatum.btm).addScaledVector(g.B1.DOWN,this.heightAboveRoom),this.heightDatum.btm]}),this.datumLines.updateEndpoints(t),this.datumLines.translationOffset(e),this.updateDatumLabels(t,e)}updateDatumLabels(e,t){const i=this.datumLabels.length-e.length;if(i>0)for(let e=0;e<Math.abs(i);e++){const e=this.datumLabels.pop();(0,E.$)(e),this.labelManager.deleteLabel(e),e.dispose()}else for(let e=0;e<Math.abs(i);e++){const e=this.labelManager.createInsideDatumLabel(this.floorId,this);e.setVisible(!1),this.datumLabels.push(e)}for(let i=0;i<e.length;i++){const s=this.datumLabels[i],n=e[i].points;s.updateDimensions(n[0].clone().add(t),n[1].clone().add(t),0,this.units,"")}}}var x=i(84615);class A extends l.r{get iconScale(){return d.xE}constructor(e,t,i,s,n){super(e,t,i),this.floorId=t,this.parentOpeningView=s,this.instanceBuffer=n,this.iconName="arrows",this.heightOffset=.5,this.outlinePct=.4,this.currOuterColor=d.fj.baseState.outerColor.clone(),this.currInnerColor=d.fj.baseState.innerColor.clone(),this.userIsInside=!1,this.enabled=!0,this.centerPosition=new r.Vector3,this.endPoints={start:new r.Vector3,end:new r.Vector3,halfWidth:.1},this.updatePosition=(()=>{const e=new r.Vector3,t=new r.Vector3;return()=>{C(this.endPoints.start,this.endPoints.end,this.endPoints.halfWidth,this.cameraData.pose,e),t.copy(this.centerPosition).add(e),this.instanceBuffer.setPositionForInstance(this,t)}})(),this.currScale=this.iconScale,this.targetScale=this.iconScale,this.prevScale=this.iconScale,this.renderOrder=h.S.NODE,this.colors=d.fj,this.animation.onChanged((()=>this.onAnimationChange())),this.instanceBuffer.createIcon(this.iconName,this),this.instanceBuffer.setInnerColorForInstance(this,this.currInnerColor),this.instanceBuffer.setOutlineForInstance(this,this.currOuterColor,this.outlinePct),this.instanceBuffer.setScaleForInstance(this,this.currScale),this.instanceBuffer.setOpacityForInstance(this,1),this.instanceBuffer.renderOrder=this.renderOrder}beforeRender(){}onAnimationChange(){const e=this.prevColorState,t=this.targetColorScheme;this.currOuterColor.lerpColors(e.outerColor,t.outerColor,this.animation.value),this.currInnerColor.lerpColors(e.innerColor,t.innerColor,this.animation.value),this.instanceBuffer.setInnerColorForInstance(this,this.currInnerColor),this.instanceBuffer.setOutlineForInstance(this,this.currOuterColor,this.outlinePct);const i=(0,o.C)(this.prevScale,this.targetScale,this.animation.value);this.instanceBuffer.setScaleForInstance(this,i)}updateMaterial(){this.prevScale=this.currScale,this.targetScale=this.iconScale+(this.hoverState.active?d.w4:0);let e=this.colors.baseState;this.hoverState.active&&(e=this.colors.hoverState);e!==this.targetColorScheme&&(this.targetColorScheme=e),this.prevColorState.innerColor.copy(this.currInnerColor),this.prevColorState.outerColor.copy(this.currOuterColor),this.animation.modifyAnimation(0,1,d.JT,a.WD)}hasIntersectionPriorityWithRespectTo(e){return!(!e.object||!e.object.isModelMesh)}onRender(e,t){this.raycastEnabled=t>.8&&this.userIsInside&&this.enabled}raycast(e,t){this.userIsInside&&this.instanceBuffer.material.uniforms.globalOpacity.value>.8&&this.instanceBuffer.raycastInstance(this,this.iconName,e,t)}updateOpacity(){const e=this.userIsInside&&this.enabled?1:0;this.instanceBuffer.setOpacityForInstance(this,e)}setUserIsInsideRoom(e,t){this.userIsInside=e,this.updateOpacity(),this.updatePosition()}updatePlacement(e,t,i,s){const n=e.clone().addScaledVector(g.B1.UP,i*this.heightOffset);this.endPoints=s,this.centerPosition.copy(n),this.updatePosition(),this.instanceBuffer.setRotationForInstance(this,t)}updateIcon(){this.instanceBuffer.setIconName(this.iconName,this)}centerPos(){return this.centerPosition}setEnabled(e){this.enabled=e,this.updateOpacity()}dispose(){this.instanceBuffer.removeIcon(this)}}class L extends A{constructor(){super(...arguments),this.heightOffset=.5,this.iconName="arrows"}beforeRender(){throw new Error("Method not implemented.")}}class P extends A{constructor(){super(...arguments),this.heightOffset=.4,this.iconName="position-3d-horizontal",this.outlinePct=.3}get iconScale(){return 1.5*d.xE}beforeRender(){throw new Error("Method not implemented.")}}class R extends L{}class O extends L{}class V extends L{constructor(){super(...arguments),this.heightOffset=1}}class F extends L{constructor(){super(...arguments),this.heightOffset=0}}var B=i(941),N=i(99380);r.ShaderMaterial;class k extends l.r{constructor(e,t,i,n,a,l,d,u,p,m,f,v,y){super(e,t,i),this.floorId=t,this.cameraData=i,this.labelManager=n,this.roomBoundViewData=a,this.instanceBufferOpening=d,this.instanceBufferOpeningStencil=u,this.rootFloor=p,this.units=m,this.readonly=y,this.insideHandles=null,this.start=new r.Vector3,this.end=new r.Vector3,this.width=0,this.outlineColor=s.V.WHITE.clone(),this.heightLinesInScene=!1,this.onEdgePositionChanged=(()=>{const e=new r.Vector3,t=new r.Vector3,i=new r.Vector3,s=new r.Vector3,n=new r.Quaternion,o=(new r.Quaternion).setFromAxisAngle(new r.Vector3(0,1,0),Math.PI/2),a=new r.Quaternion,h=new r.Vector3;return(r,l,d,u,p)=>{this.start.copy(r),this.end.copy(l),this.width=d,e.subVectors(l,r),s.copy(e).normalize();const m=e.length(),f=d;t.set(m,.05,f),this.instanceBufferOpening.setScaleForInstance(this,t),this.instanceBufferOpeningStencil.setScaleForInstance(this,t);const v=Math.atan2(l.x-r.x,l.z-r.z)+Math.PI/2;this.instanceBufferOpening.setRotationForInstance(this,v),this.instanceBufferOpeningStencil.setRotationForInstance(this,v);const y=e.addVectors(l,r).multiplyScalar(.5),b=h.copy(y).addScaledVector(s,.2);this.instanceBufferOpening.setPositionForInstance(this,y),this.instanceBufferOpeningStencil.setPositionForInstance(this,y),this.startHandle.updatePosition(r),this.endHandle.updatePosition(l);let w=1;const I=(0,N.jd)(u),D=(0,N.l6)(u);I&&(w=2),D&&(w=3),this.instanceBufferOpening.setNumLines(this,w),this.instanceBufferOpeningStencil.setNumLines(this,w),this.updateHeightlines(r,l,d,u,p),i.crossVectors(s,g.B1.UP).normalize(),(0,c.LM)(n,g.B1.UP,i,s),a.copy(n).multiply(o);const S={start:r.clone(),end:l.clone(),halfWidth:d/2};if(this.insideHandles){const e=p||B.Sj;this.insideHandles.start.updatePlacement(r,n,e,S),this.insideHandles.end.updatePlacement(l,n,e,S),this.insideHandles.top.updatePlacement(y,a,e,S),this.insideHandles.bottom.updatePlacement(b,a,e,S),this.insideHandles.bottom.setEnabled(D),this.insideHandles.main.updatePlacement(y,a,e,S),this.insideHandles.main.updateIcon()}}})(),this.updateHeightlines=(()=>{const e=new r.Vector3,t=new r.Vector3,i=new r.Vector3,s=new r.Vector3,n=new r.Vector3,o=new r.Vector3,a=new r.Vector3,h=new r.Vector3,l=new r.Vector3,d=new r.Vector3,c=new r.Vector3,u=new r.Vector3,p=new r.Vector3,m=new r.Vector3,f=new r.Vector3,v=new r.Vector3,y=new r.Vector3,b=new r.Vector3,I=new r.Vector3,D=new r.Vector3;return(r,S,E,M,C)=>{const T=C||B.Sj;D.copy(g.B1.UP).multiplyScalar(T),I.subVectors(S,r).normalize(),I.set(-I.z,I.y,I.x);const A=.5*E;e.set(r.x,r.y+w.u4,r.z).addScaledVector(I,A),n.set(r.x,r.y+w.u4,r.z).addScaledVector(I,-A),o.set(S.x,S.y+w.u4,S.z).addScaledVector(I,A),d.set(S.x,S.y+w.u4,S.z).addScaledVector(I,-A),c.copy(e).add(D),u.copy(n).add(D),m.copy(o).add(D),f.copy(d).add(D),t.copy(e).add(n).multiplyScalar(.5),a.copy(o).add(d).multiplyScalar(.5),p.copy(t).add(D),v.copy(a).add(D),y.copy(t).multiplyScalar(3/4).addScaledVector(a,1/4),b.copy(y).add(D);const L=null!=C,P=[],R=[],O=(0,N.jd)(M),V=M===x.k.DIVIDER,F=(0,N.l6)(M);if(O||V){R.push({points:[e,n]},{points:[o,d]});const t=[{points:[e,c]},{points:[n,u]},{points:[o,m]},{points:[d,f]}];L?R.push({points:[c,u]},{points:[m,f]},{points:[c,m]},{points:[u,f]},...t):P.push(...t)}else F&&R.push({points:[t,a]},{points:[t,p]},{points:[a,v]},{points:[p,v]});O?(i.copy(t).addScaledVector(I,.02),s.copy(t).addScaledVector(I,-.02),h.copy(a).addScaledVector(I,.02),l.copy(a).addScaledVector(I,-.02),R.push({points:[i,h]},{points:[s,l]})):V&&R.push({points:[t,a]});const k=L?{btm:y,top:b}:{btm:y};this.insideModeLines.updateEndpoints(R,P,k,{start:t.clone(),end:a.clone(),halfWidth:A},F,this.units),this.heightLines.updateEndpoints(R,P)}})(),this.renderOrder=h.S.OPENING_LINES,this.startHandle=new G(e,t,i,l,this),this.endHandle=new _(e,t,i,l,this),this.readonly||(this.insideHandles={start:new R(e,t,i,this,v),end:new O(e,t,i,this,v),top:new V(e,t,i,this,v),main:new P(e,t,i,this,v),bottom:new F(e,t,i,this,v)},this.insideHandles.bottom.setEnabled(!1)),this.instanceBufferOpening.allocInstance(this),this.instanceBufferOpeningStencil.allocInstance(this),this.instanceBufferOpening.setColorForInstance(this,this.outlineColor),this.instanceBufferOpeningStencil.setColorForInstance(this,this.outlineColor),this.heightLines=new S.M2([],[]),this.insideModeLines=new T([],[],[],this.floorId,this.units,0,this.cameraData.pose,this.roomBoundViewData,this.labelManager,f),this.rootFloor.add(this.insideModeLines),this.animation.onChanged((()=>{this.outlineColor.lerpColors(s.V.WHITE,s.V.NEPTUNE,this.animation.value),this.instanceBufferOpening.setColorForInstance(this,this.outlineColor),this.instanceBufferOpeningStencil.setColorForInstance(this,this.outlineColor),this.readonly||(this.insideModeLines.setColor(this.outlineColor),this.insideModeLines.setWidth((0,o.C)(w.kV,w.Yv,this.animation.value)))}))}*allSubViews(){this.startHandle&&(yield this.startHandle),this.endHandle&&(yield this.endHandle),this.insideHandles&&(yield this.insideHandles.start,yield this.insideHandles.end,yield this.insideHandles.top,yield this.insideHandles.main,yield this.insideHandles.bottom)}*insideModeHandles(){this.insideHandles&&(yield this.insideHandles.start,yield this.insideHandles.end,yield this.insideHandles.top,yield this.insideHandles.main,yield this.insideHandles.bottom)}onRender(e,t){super.onRender(e,t),this.raycastEnabled=this.pitchFactor<1&&this.roomBoundViewData.roomWallsVisible;const i=(1-t)*e;this.heightLines.globalOpacity(i),this.insideModeLines.onRender(t);for(const i of this.allSubViews())i.onRender(e,t)}setIsInside(e,t){this.insideModeLines.setUserIsInsideRoom(e,t);for(const i of this.insideModeHandles())i.setUserIsInsideRoom(e,t)}updateMaterial(){const e=this.highlightState.active,t=this.selectState.active||this.hoverState.active;this.animation.modifyAnimation(this.animation.value,t?1:0,d.JT,a.WD),e?this.heightLinesInScene||(this.rootFloor.add(this.heightLines),this.heightLinesInScene=!0):this.heightLinesInScene&&(this.rootFloor.remove(this.heightLines),this.heightLinesInScene=!1)}tickAnimations(e){super.tickAnimations(e);for(const t of this.allSubViews())t.tickAnimations(e)}raycast(e,t){this.raycastEnabled&&u(this.start,this.end,this.width,this.cameraData,this,e,t)}updateUnits(e){this.insideModeLines.updateUnits(e)}beforeRender(){}dispose(){for(const e of this.allSubViews())e.dispose();this.insideHandles=null,this.instanceBufferOpening.removeInstance(this),this.instanceBufferOpeningStencil.removeInstance(this),this.rootFloor.remove(this.heightLines),this.rootFloor.remove(this.insideModeLines)}}class H extends y{constructor(e,t,i,s,n){super(e,t,i,s),this.floorId=t,this.parentOpeningView=n}}class G extends H{}class _ extends H{}var U=i(49988),W=i(99689),z=i(87965),j=i(23339);class $ extends y{}var X=i(48823),q=i(35341),Y=i.n(q),Q=i(16153),K=i(37458),Z=i(19968),J=i(18952),ee=i(92237);class te{constructor(){this.corner=[new r.Vector2,new r.Vector2,new r.Vector2,new r.Vector2],this.axis=[new r.Vector2,new r.Vector2],this.origin=[0,0],this.aabb=new r.Box2}set(e){if(4!==e.length)throw new Error("Obb needs four points!");for(let t=0;t<e.length;t++)this.corner[t].copy(e[t]);this.aabb.setFromPoints(this.corner),this.axis[0].subVectors(this.corner[1],this.corner[0]),this.axis[1].subVectors(this.corner[3],this.corner[0]);for(let e=0;e<2;e++)this.axis[e].divideScalar(this.axis[e].lengthSq()),this.origin[e]=this.corner[0].dot(this.axis[e])}overlaps(e){return this.overlaps1Way(e)&&e.overlaps1Way(this)}overlaps1Way(e){for(let t=0;t<2;t++){let i=e.corner[0].dot(this.axis[t]),s=i,n=i;for(let o=1;o<4;o++)i=e.corner[o].dot(this.axis[t]),s=Math.min(s,i),n=Math.max(n,i);if(s>1+this.origin[t]||n<this.origin[t])return!1}return!0}}var ie=i(93818),se=i(23431),ne=i(12767);const oe=new r.Vector2(0,0);class ae{constructor(e,t,i,n,o,a){this.cameraData=i,this.getCurrFloorId=n,this.distanceBehindDepthMesh=o,this.debugContainer=a,this.labelsByFloor=new Map,this.needsImmediateCollisionDetectionCtr=5,this.lastCollisionTimestamp=0,this.tree=new(Y()),this.labelDistanceBehindDepthMesh=(()=>{const e=new r.Vector3;return t=>(t.getAnchorPoint(e),this.distanceBehindDepthMesh(e))})(),this.roomLabelMaker=new Q.Il({assetBasePath:e,lang:t,color:s.V.WHITE.clone(),outline:!0,background:!1,backgroundColor:s.V.BLACK.clone(),backgroundColliderType:me,disableDepth:!0}),this.wallLabelMaker=new Q.Il({assetBasePath:e,color:s.V.BLACK.clone(),lang:t,background:!0,outline:!1,backgroundColor:s.V.WHITE.clone(),backgroundColliderType:pe,disableDepth:!0,backgroundBorderHeight:.8,backgroundBorderWidth:.8}),this.insideLabelMaker=new Q.Il({assetBasePath:e,color:s.V.BLACK.clone(),lang:t,background:!0,outline:!1,backgroundColor:s.V.WHITE.clone(),backgroundColliderType:pe,disableDepth:!0,backgroundBorderHeight:.8,backgroundBorderWidth:.8})}createRoomLabel(e,t,i){const s=new he(re.ROOM,e,this.roomLabelMaker.createLabel(),this.cameraData,i);return s.label.collider.userData={roomId:t},this.addToFloorDict(e,s),s}createWallLabel(e,t){const i=new le(re.WALL,e,this.wallLabelMaker.createLabel(),this.cameraData,t,21);return this.addToFloorDict(e,i),this.needsImmediateCollsisionDetection(),i}createPerimeterLabel(e,t,i=!1){const s=new le(re.PERIMETER,e,this.wallLabelMaker.createLabel(),this.cameraData,t,21);return this.addToFloorDict(e,s),i||this.update(),this.needsImmediateCollsisionDetection(),s}createHeightLabel(e,t,i,s=!1){const n=t?re.HEIGHT_HIGH_PRIO:re.HEIGHT_LOW_PRIO,o=new le(n,e,this.wallLabelMaker.createLabel(),this.cameraData,i,21);return this.addToFloorDict(e,o),s||this.update(),this.needsImmediateCollsisionDetection(),o}createInsideLabel(e,t){const i=new ce(re.PERIMETER,e,this.insideLabelMaker.createLabel(),this.cameraData,t,21,d.rH);return this.addToFloorDict(e,i),this.needsImmediateCollsisionDetection(),i}createDatumLabel(e,t){const i=new de(re.PERIMETER,e,this.insideLabelMaker.createLabel(),this.cameraData,t,21);return this.addToFloorDict(e,i),this.needsImmediateCollsisionDetection(),i}createInsideDatumLabel(e,t){const i=new ue(re.PERIMETER,e,this.insideLabelMaker.createLabel(),this.cameraData,t,21);return this.addToFloorDict(e,i),this.needsImmediateCollsisionDetection(),i}deleteLabel(e){this.removeFromFloorDict(e.floorId,e),e.dispose(),this.needsImmediateCollsisionDetection()}tickAnimations(e){for(const t of this.currFloorLabels())t.tickAnimations(e)}needsImmediateCollsisionDetection(){this.needsImmediateCollisionDetectionCtr=5}update(){this.debugContainer&&this.debugContainer.clear();for(const e of this.currFloorLabels())e.update();(this.needsImmediateCollisionDetectionCtr>0||performance.now()-this.lastCollisionTimestamp>2e3)&&(this.updateLabelCollisions(),this.needsImmediateCollisionDetectionCtr=Math.max(this.needsImmediateCollisionDetectionCtr-1,0),this.lastCollisionTimestamp=performance.now())}*currFloorLabels(){const e=this.getCurrFloorId();if(e){const t=this.labelsByFloor.get(e);if(t)for(const e of t)yield e}}addToFloorDict(e,t){let i=this.labelsByFloor.get(e);null==i&&(i=new Set,this.labelsByFloor.set(e,i)),i.add(t)}removeFromFloorDict(e,t){const i=this.labelsByFloor.get(e);null!=i&&i.delete(t)}updateLabelCollisions(){const e=new r.Vector2,t=new r.Vector3,i=new r.Vector3,s=[{x:-1,y:-1,screenPos:new r.Vector2},{x:1,y:-1,screenPos:new r.Vector2},{x:1,y:1,screenPos:new r.Vector2},{x:-1,y:1,screenPos:new r.Vector2}],n=[],o=(0,c.Gp)(this.cameraData.pose.projection),a=e=>{const t=e.positionPriority();let i=0;e.getDisplayingTooltip()&&(i+=1e3);return e.getDimmed()?i+=-1e4:e.type===re.ROOM?i+=200:e.type===re.HEIGHT_HIGH_PRIO?i+=100:e.type===re.HEIGHT_LOW_PRIO&&(i+=50),t+i},h=Array.from(this.currFloorLabels()).filter((e=>e.labelVisible&&e.fitsWall&&e.collisionDetection&&this.cameraData.pose.worldspaceFrustum.value.containsPoint(e.label.position))).map((e=>{const t=e.label;return{label:e,cameraDistance:o?Math.abs(t.position.y-this.cameraData.pose.position.y):this.cameraData.pose.position.distanceTo(t.position),priority:a(e)}})).sort(((e,t)=>t.priority-e.priority)).map((o=>{const{label:a,cameraDistance:h}=o,l=a.label,u=(0,c.ff)(h,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width)*d.IS;(0,Z.bz)(this.cameraData,l.position,e,t);const{width:p,height:m}=l.getUnscaledSize();this.debugContainer&&(n.length=0),l.updateMatrixWorld();for(const e of s)i.set(p*e.x*.5+u*e.x,m*e.y*.5+(u+e.y),0),i.applyMatrix4(l.matrixWorld),this.debugContainer&&n.push(i.clone()),(0,Z.bz)(this.cameraData,i,e.screenPos);if(this.debugContainer){const e=new r.Mesh(new r.ShapeGeometry(new r.Shape(n.map((e=>new r.Vector2(e.x,e.z))))).rotateX(Math.PI/2),new r.MeshBasicMaterial({color:"red",depthTest:!1,side:r.DoubleSide}));this.debugContainer.add(e)}const g=new te;g.set(s.map((e=>e.screenPos)));const f=g.aabb;return{label:a,oob:g,minX:f.min.x,minY:f.min.y,maxX:f.max.x,maxY:f.max.y,distance:h}})),l=new Set;this.tree.clear();for(const e of h){const t=this.tree.search(e),i=!e.label.allowOverlapWithOtherLabel&&t.find((t=>t.oob.overlaps(e.oob))),s=!!e.label.depthMeshOcclusion&&(this.labelDistanceBehindDepthMesh(e.label)>2*d.Zc||e.label.distanceToCamera()>=d.GG),n=i||s,o=e.label.labelGroupId,a=o&&l.has(o),r=!(n||a&&o);e.label.setCollides(!r),r&&(this.tree.insert(e),o&&l.add(o))}}}var re;!function(e){e[e.ROOM=0]="ROOM",e[e.WALL=1]="WALL",e[e.HEIGHT_HIGH_PRIO=2]="HEIGHT_HIGH_PRIO",e[e.HEIGHT_LOW_PRIO=3]="HEIGHT_LOW_PRIO",e[e.PERIMETER=4]="PERIMETER"}(re||(re={}));class he{constructor(e,t,i,s,n,o){this.type=e,this.floorId=t,this.label=i,this.cameraData=s,this.parent=n,this.length=0,this.labelGroupId=null,this.collisionDetection=!0,this.labelVisible=!1,this.collides=!1,this.dimmed=!1,this.displayingTooltip=!1,this.fitsWall=!0,this.inScene=!1,this.tempMidpoint=new r.Vector3,this.label.setRenderOrder(K.X.labels),i.matrixAutoUpdate=!1,this.labelOpacityAnimation=new ee.z(1,void 0,o),this.updateOpacityTarget(0)}get depthMeshOcclusion(){return!1}get allowOverlapWithOtherLabel(){return!1}getAnchorPoint(e){return e.copy(this.label.position)}distanceToCamera(){return this.getAnchorPoint(this.tempMidpoint).distanceTo(this.cameraData.pose.position)}dispose(){this.label.dispose(),this.parent.remove(this.label)}tickAnimations(e){this.labelOpacityAnimation.tick(e)}setVisible(e){e!==this.labelVisible&&(this.labelVisible=e,this.updateOpacityTarget())}setCollides(e){e!==this.collides&&(this.collides=e,this.updateOpacityTarget(e?0:d.JT))}setFitsWall(e){e!==this.fitsWall&&(this.fitsWall=e,this.updateOpacityTarget())}setDimmed(e){e!==this.dimmed&&(this.dimmed=e,this.updateOpacityTarget())}getDimmed(){return this.dimmed}setDisplayingTooltip(e){this.displayingTooltip=e,this.updateOpacityTarget()}getDisplayingTooltip(){return this.displayingTooltip}update(){this.updateOpacity()}getSize(){const e=this.label.text.split("\n"),t=e.reduce(((e,t)=>Math.max(e,t.length)),0),i=(0,J.yp)(t,0,0);return{width:i.width,height:i.height*e.length}}updateOpacity(){this.label.opacity=this.labelOpacityAnimation.value,this.label.opacity>.01?this.inScene||(this.parent.add(this.label),this.inScene=!0):this.inScene&&(this.parent.remove(this.label),this.inScene=!1)}updateOpacityTarget(e=d.JT){const t=this.dimmed&&!this.displayingTooltip?.5:1,i=this.labelVisible&&!this.collides&&this.fitsWall?t:0;this.labelOpacityAnimation.modifyAnimation(e>0?this.labelOpacityAnimation.value:i,i,e)}positionPriority(){const e=this.cameraData.pose.isProjectionOrtho.value,t=this.label;return 1-((e?Math.abs(t.position.y-this.cameraData.pose.position.y):this.cameraData.pose.position.distanceTo(t.position))-ne.Bv.near)/(ne.Bv.far-ne.Bv.near)}}class le extends he{constructor(e,t,i,s,n,o,a){super(e,t,i,s,n,a),this.cameraData=s,this.labelHeightPx=o,this.start=new r.Vector3,this.end=new r.Vector3,this.width=.1,this.collisionDetection=!0,this.prefix="",this.getLinePositions=(()=>{const e=new r.Vector3,t=new r.Vector3,i=new r.Vector3,s=new r.Vector3,n=new r.Vector3,o=new r.Vector3,a=new r.Vector3,h=new r.Vector2,l=new r.Vector2,d=new r.Vector2,c=new r.Vector2,u=new r.Vector2,p=new r.Vector2,m=new r.Vector2;return(r=this.start,f=this.end)=>{e.copy(r),t.copy(f),o.subVectors(t,e).normalize().applyAxisAngle(g.B1.UP,Math.PI/2);const v=(0,J.CW)(e,t,this.cameraData),y=(0,J.yp)(this.label.text.length),b=v.pixelDistance>y.width&&this.labelVisible;this.setFitsWall(b);const w=this.cameraData.isOrtho();i.addVectors(e,t).multiplyScalar(.5),(0,Z.bz)(this.cameraData,r,l,a),(0,Z.bz)(this.cameraData,f,d,a),(0,Z.bz)(this.cameraData,i,c,a);const I=a.z;u.copy(c),s.addVectors(i,o),(0,Z.bz)(this.cameraData,s,p,a);const D=m.subVectors(p,c),S=d.sub(l).normalize().rotateAround(oe,Math.PI/2);w?S.copy(D).normalize():S.y>0&&S.multiplyScalar(-1);const E=this.labelHeightPx;let M=c.addScaledVector(S,E),C=(0,Z.wc)(M.x,M.y,this.cameraData.width,this.cameraData.height,h),T=a.set(C.x,C.y,I),x=(0,Z.Ft)(this.cameraData.pose,T,n);const A=x.distanceTo(i)/E,L=2+(w?this.width/2/A:0)+this.labelHeightPx/2;return M=u.addScaledVector(S,L),C=(0,Z.wc)(M.x,M.y,this.cameraData.width,this.cameraData.height,h),T=a.set(C.x,C.y,I),x=(0,Z.Ft)(this.cameraData.pose,T,n),{start:e,end:t,center:i,labelPosition:x,lineRotation:v.rotation,heightScale:A}}})(),i.matrixAutoUpdate=!1}getAnchorPoint(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}updateDimensions(e,t,i,s){this.start.copy(e),this.end.copy(t),this.width=i;const n=this.start.distanceTo(this.end);this.length=n,this.updateUnits(s)}updateUnits(e){const t=(0,ie.R5)(this.length,e);this.label.text=this.prefix+`${t}`}update(){super.update(),this.updateBillboard()}updateBillboard(){if(!this.labelVisible)return;const{labelPosition:e,lineRotation:t,heightScale:i}=this.getLinePositions(),{label:s}=this;s.setPosition(e),s.setOrientation(this.cameraData.pose.rotation,t);const n=i,o=this.label.unscaledHeight,a=this.labelHeightPx*n/o;s.scaleFactor=a,s.updateMatrix(),s.updateMatrixWorld()}}class de extends le{constructor(){super(...arguments),this.labelHeightFraction=d.Fg,this.center=new r.Vector3,this.dir=new r.Vector3}updateDimensions(e,t,i,s,n="Max: "){this.start.copy(e),this.end.copy(t),this.dir.subVectors(this.end,this.start),this.center.copy(this.start).addScaledVector(this.dir,this.labelHeightFraction),this.width=i,this.label.setPosition(this.center);const o=this.start.distanceTo(this.end);this.length=o,this.prefix=n,this.updateUnits(s)}get depthMeshOcclusion(){return 0===this.prefix.length}getAnchorPoint(e){return e.copy(this.center)}update(){super.updateOpacity();const{position:e,rotation:t,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,n=this.cameraData.isOrtho()?this.cameraData.zoom():1,o=this.cameraData.aspect();this.label.quaternion.copy(t);this.label.scaleBillboard(e,t,i,n,s,o,.1),this.label.updateMatrix(),this.label.updateMatrixWorld()}}class ce extends le{constructor(){super(...arguments),this.collisionDetection=!0,this._t1=new r.Vector3}get depthMeshOcclusion(){return!0}isVertical(e,t){const i=Math.abs(e.y-t.y),s=Math.abs(e.x-t.x),n=Math.abs(e.z-t.z);return i>0&&s<1e-6&&n<1e-6}positionPriority(){const e=this.label;this._t1.copy(e.position);const t=(0,Z.jn)(this._t1,this.cameraData.pose.position,this.cameraData.pose.rotation,this.cameraData.pose.projection.asThreeMatrix4());return 1-Math.sqrt(t.x*t.x+t.y*t.y)}}class ue extends de{get allowOverlapWithOtherLabel(){return!0}}class pe extends r.Mesh{raycast(e,t){}}class me extends r.Mesh{constructor(){super(...arguments),this.intersectionPriority=se.I.RoomLabels}raycast(e,t){this.visible&&super.raycast(e,t)}}var ge=i(23184),fe=i(81544),ve=i(31002),ye=i(78079),be=i(44667),we=i(94790),Ie=i(60043),De=i(27200),Se=i(56147);var Ee=i(16964);class Me extends Ee.l{constructor(e=100){const t=new Float32Array([0,1,2,3,4,5,6,7,8,9]),i=new r.InstancedBufferGeometry;i.setAttribute("vertIndex",new r.Float32BufferAttribute(t,1)),i.setIndex([0,1,2,0,2,3,0,3,4,0,4,5,3,2,6,3,7,4,0,9,1,0,5,8]);super(e,i,new r.ShaderMaterial({uniforms:r.UniformsUtils.clone(b.zP.uniforms),vertexShader:b.zP.vertexShader,fragmentShader:b.zP.fragmentShader,transparent:!0,depthTest:!1,stencilRef:65535,stencilFuncMask:1<<h.j.OPENINGS,stencilFail:r.KeepStencilOp,stencilZFail:r.KeepStencilOp,stencilZPass:r.KeepStencilOp,stencilFunc:r.GreaterStencilFunc,stencilWrite:!0})),this.baseHeight=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("baseHeight",this.baseHeight),this.fromLeft=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("fromLeft",this.fromLeft),this.fromRight=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("fromRight",this.fromRight),this.toLeft=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("toLeft",this.toLeft),this.toRight=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("toRight",this.toRight),this.colorAndOpacity=new r.InstancedBufferAttribute(new Uint8Array(4*this.capacityForAllInstances),4,!0),this.geometry.setAttribute("colorAndOpacity",this.colorAndOpacity),this.outlineColorAttr=new r.InstancedBufferAttribute(new Uint8Array(3*this.capacityForAllInstances),3,!0),this.geometry.setAttribute("outlineColorAttr",this.outlineColorAttr),this.lineBiasedStartAndEnd=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("lineBiasedStartAndEnd",this.lineBiasedStartAndEnd),this.lineStartAndEnd=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("lineStartAndEnd",this.lineStartAndEnd),this.widthAttr=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("widthAttr",this.widthAttr),this.renderOrder=h.S.EDGE}setGeometryForInstance(e,t,i,s,n,o,a,r,h,l,d,c){for(const u of this.getIndices(e)){const{fromLeft:e,fromRight:p,toLeft:m,toRight:g}=c;this.baseHeight.setX(u,t),this.baseHeight.needsUpdate=!0,this.lineBiasedStartAndEnd.setXYZW(u,i,s,n,o),this.widthAttr.setX(u,a),this.lineBiasedStartAndEnd.needsUpdate=!0,this.widthAttr.needsUpdate=!0,this.lineStartAndEnd.setXYZW(u,r,h,l,d),this.lineStartAndEnd.needsUpdate=!0,this.fromLeft.setXYZW(u,e.primary.x,e.primary.z,e.bevel.x,e.bevel.z),this.fromRight.setXYZW(u,p.primary.x,p.primary.z,p.bevel.x,p.bevel.z),this.toLeft.setXYZW(u,m.primary.x,m.primary.z,m.bevel.x,m.bevel.z),this.toRight.setXYZW(u,g.primary.x,g.primary.z,g.bevel.x,g.bevel.z),this.fromLeft.needsUpdate=!0,this.fromRight.needsUpdate=!0,this.toLeft.needsUpdate=!0,this.toRight.needsUpdate=!0}}setOpacityForInstance(e,t){for(const i of this.getIndices(e))this.colorAndOpacity.setW(i,t),this.colorAndOpacity.needsUpdate=!0}setColorsForInstance(e,t,i){for(const s of this.getIndices(e))this.outlineColorAttr.setXYZ(s,t.r,t.g,t.b),this.colorAndOpacity.setXYZ(s,i.r,i.g,i.b),this.outlineColorAttr.needsUpdate=!0,this.colorAndOpacity.needsUpdate=!0}onRender(e,t){this.material.depthTest=1===e;const i=(1-e)*Number(t.roomWallsVisible);this.material.uniforms.globalOpacity.value=i}}class Ce extends r.ShaderMaterial{constructor(){super({fragmentShader:b.p$.fragmentShader,vertexShader:b.p$.vertexShader,uniforms:r.UniformsUtils.clone(b.p$.uniforms),name:"HandleMaterial",transparent:!0,depthTest:!1})}}class Te extends Ee.l{constructor(e=100){const t=new Float32Array([-1,0,-1,1,0,-1,1,0,1,-1,0,1]),i=new r.InstancedBufferGeometry;i.setAttribute("position",new r.Float32BufferAttribute(t,3)),i.setIndex([0,2,1,0,3,2]),super(e,i,new Ce),this.renderOrder=h.S.NODE,this.radius=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("radius",this.radius),this.opacity=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("opacity",this.opacity),this.innerColor=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("innerColor",this.innerColor),this.outerColor=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("outerColor",this.outerColor),this.centerPosition=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("centerPosition",this.centerPosition)}setPositionForInstance(e,t){for(const i of this.getIndices(e))this.centerPosition.setXYZ(i,t.x,t.y,t.z),this.centerPosition.needsUpdate=!0}setOpacityForInstance(e,t){for(const i of this.getIndices(e))this.opacity.setX(i,t),this.opacity.needsUpdate=!0}setRadiusForInstance(e,t){for(const i of this.getIndices(e))this.radius.setX(i,t),this.radius.needsUpdate=!0}setColorsForInstance(e,t,i){for(const s of this.getIndices(e))this.outerColor.setXYZ(s,t.r,t.g,t.b),this.innerColor.setXYZ(s,i.r,i.g,i.b),this.outerColor.needsUpdate=!0,this.innerColor.needsUpdate=!0}onRender(e,t){this.visible=e<1;const i=(1-e)*Number(t.roomWallsVisible);this.material.uniforms.globalOpacity.value=i}}class xe extends r.ShaderMaterial{constructor(){super({fragmentShader:b.zs.fragmentShader,vertexShader:b.zs.vertexShader,uniforms:r.UniformsUtils.clone(b.zs.uniforms),name:"OpeningMaterial",depthTest:!1,transparent:!0,stencilFunc:r.AlwaysStencilFunc,stencilWrite:!1})}}class Ae extends Ee.l{constructor(e=100){const t=new Float32Array([-.5,0,-.5,.5,0,-.5,.5,0,.5,-.5,0,.5]),i=new r.InstancedBufferGeometry;i.setAttribute("position",new r.Float32BufferAttribute(t,3)),i.setIndex([0,2,1,0,3,2]),super(e,i,new xe),this.renderOrder=h.S.OPENING_LINES,this.rotationY=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("rotationY",this.rotationY),this.offset=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("offset",this.offset),this.scaleAttr=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("scaleAttr",this.scaleAttr),this.baseColor=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("baseColor",this.baseColor),this.numLines=new r.InstancedBufferAttribute(new Uint8Array(this.capacityForAllInstances),1),this.geometry.setAttribute("numLines",this.numLines)}setPositionForInstance(e,t){for(const i of this.getIndices(e))this.offset.setXYZ(i,t.x,t.y,t.z),this.offset.needsUpdate=!0}setScaleForInstance(e,t){for(const i of this.getIndices(e))this.scaleAttr.setXYZ(i,t.x,t.y,t.z),this.scaleAttr.needsUpdate=!0}setRotationForInstance(e,t){for(const i of this.getIndices(e))this.rotationY.setX(i,t),this.rotationY.needsUpdate=!0}setColorForInstance(e,t){for(const i of this.getIndices(e))this.baseColor.setXYZ(i,t.r,t.g,t.b),this.baseColor.needsUpdate=!0}setNumLines(e,t){for(const i of this.getIndices(e))this.numLines.setX(i,t),this.numLines.needsUpdate=!0}onRender(e,t){this.visible=e<1&&t.roomWallsVisible;const i=(1-e)*Number(t.roomWallsVisible);this.material.uniforms.globalOpacity.value=i}}class Le extends Ae{constructor(e=100){super(e),this.renderOrder=h.S.OPENING_STENCIL,this.material.colorWrite=!1,this.material.stencilRef=65535,this.material.stencilFuncMask=1<<h.j.OPENINGS,this.material.stencilWriteMask=1<<h.j.OPENINGS,this.material.stencilFail=r.ReplaceStencilOp,this.material.stencilZFail=r.ReplaceStencilOp,this.material.stencilZPass=r.ReplaceStencilOp,this.material.stencilFunc=r.AlwaysStencilFunc,this.material.stencilWrite=!0}}class Pe extends Ee.l{constructor(e=100){const t=new Float32Array([-1,0,-1,1,1,1,1,0]),i=new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0]),s=new r.InstancedBufferGeometry;s.setAttribute("offset",new r.Float32BufferAttribute(t,2)),s.setAttribute("normal",new r.Float32BufferAttribute(i,3)),s.setIndex([0,3,1,3,2,1]);super(e,s,new r.ShaderMaterial({uniforms:r.UniformsUtils.clone(b.OW.uniforms),vertexShader:b.OW.vertexShader,fragmentShader:b.OW.fragmentShader,side:r.DoubleSide,transparent:!0,depthTest:!1}),4),this.tip=new r.InstancedBufferAttribute(new Float32Array(2*this.capacityForAllInstances),2),this.geometry.setAttribute("tip",this.tip),this.normal=new r.InstancedBufferAttribute(new Float32Array(2*this.capacityForAllInstances),2),this.geometry.setAttribute("normal",this.normal),this.height=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("height",this.height),this.opacity=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("opacity",this.opacity),this.visibility=new r.InstancedBufferAttribute(new Uint8Array(this.capacityForAllInstances),1,!0),this.geometry.setAttribute("visibility",this.visibility),this.renderOrder=h.S.EDGE}updateStateForInstances(e,t){let i=0;for(const s of this.getIndices(e)){const e=t[i];this.tip.setXY(s,e.tip.x,e.tip.y),this.normal.setXY(s,e.normal.x,e.normal.y),this.height.setX(s,e.height),i++}this.tip.needsUpdate=!0,this.normal.needsUpdate=!0,this.height.needsUpdate=!0}setOpacityForInstances(e,t){for(const i of this.getIndices(e))this.opacity.setX(i,t);this.opacity.needsUpdate=!0}setVisibilityForInstances(e,t){for(const i of this.getIndices(e))this.visibility.setX(i,Number(t));this.visibility.needsUpdate=!0}onRender(e,t,i,s){this.material.uniforms.metersPerPx.value=e,this.material.uniforms.screenSize.value.set(t,i),this.material.uniforms.globalOpacity.value=1-s}}var Re=i(52030);class Oe{constructor(e,t,i,s,n,o,a,h,l,c,u,p,m,g,f,v,y,b,w){this.readonly=e,this.data=t,this.webglRenderer=i,this.scene=s,this.input=n,this.viewListener=o,this.isAdding=a,this.floorsViewData=h,this.cameraData=l,this.locale=c,this.settingsData=u,this.roomBoundsViewData=p,this.viewmodeData=m,this.sweepData=g,this.toolsData=f,this.rttModule=v,this.generatorSpreader=y,this.canHoverRoomLabels=b,this.onRoomLabelHover=w,this.lastCollisionTimestamp=0,this.rootObjects={},this.viewByFloor=new Map,this.roomByFloor=new Map,this.wallInstanceBuffers={},this.handleInstanceBuffers={},this.openingInstanceBuffers={},this.openingStencilInstanceBuffers={},this.caretsInstanceBuffers={},this.openingInsideModeInstanceBuffers={},this.viewMap=new Map,this.nodeMap=new Map,this.roomMap=new Map,this.openingMap=new Map,this.visibleWallLabels=new Set,this.depthScene={},this.drawDepthToScreen=!1,this.currInsideAbleViews=new Set,this.hideCurrentFloorViews=()=>{if(this.prevFloorId){const e=this.rootObjects[this.prevFloorId],t=this.viewByFloor.get(this.prevFloorId);if(null!=t)for(const e of t)this.unregisterViewToInput(e);e.removeFromParent()}},this.showCurrentFloorViews=()=>{if(this.currentFloorId){const e=this.rootObjects[this.currentFloorId];this.scene.getSubTree([this.currentFloorId]).add(e);const t=this.viewByFloor.get(this.currentFloorId);if(null!=t)for(const e of t)this.registerViewToInput(e)}},this.updateCurrentFloor=()=>{this.hideCurrentFloorViews(),this.showCurrentFloorViews()},this.updateOpeningView=(()=>{const e=new r.Vector3,t=new r.Vector3;return i=>{i.getPoints(i.lowerElevation,e,t);const s=this.openingMap.get(i.id);if(!s)throw new Error("Unable to find view for opening while updating");s.onEdgePositionChanged(e,t,i.wall.width,i.label,i.height)}})(),this.onMoveEnd=()=>{for(const e of this.data.rooms.values())this.updateRoomView(e,!0)},this.resizeDepthTextureIfNecessary=(()=>()=>{const e=this.depthTex.width,t=this.depthTex.height,i=this.cameraData.width,s=this.cameraData.height,n=Math.floor(.5*i),o=Math.floor(.5*s);t===o&&e===n||this.depthTex.setSize(n,o)})(),this.distanceBehindDepthMesh=(()=>{const e=new r.Raycaster,t=new r.Vector3,i=new r.Vector3;return s=>{const n=this.cameraData.pose;i.subVectors(s,n.position),t.copy(i).normalize(),e.set(n.position,t);const o=[];for(const t of this.visibleIdealizedDepthMeshes())t.raycast(e,o);if(0===o.length)return 0;{let e=Number.MAX_SAFE_INTEGER;for(const t of o)t.distance<e&&(e=t.distance);const t=i.length()-e;return Math.max(t,0)}}})(),this.depthTex=this.rttModule.createRenderTarget2D(1024),this.depthTex.texture.type=r.HalfFloatType,this.depthTex.texture.format=r.RedFormat,this.depthTex.texture.internalFormat="R16F",this.depthTex.texture.magFilter=r.LinearFilter,this.depthTex.texture.minFilter=r.LinearFilter,this.floorsViewData.floors.iterate((e=>{this.rootObjects[e.id]=new r.Object3D,this.depthScene[e.id]=new r.Scene;const t=new Me;this.wallInstanceBuffers[e.id]=t,this.rootObjects[e.id].add(t);const i=new Te;this.handleInstanceBuffers[e.id]=i,this.rootObjects[e.id].add(i);const s=new Ae;this.openingInstanceBuffers[e.id]=s,this.rootObjects[e.id].add(s);const n=new Le;this.openingStencilInstanceBuffers[e.id]=n,this.rootObjects[e.id].add(n);const o=new Pe;this.caretsInstanceBuffers[e.id]=o,this.rootObjects[e.id].add(o);const a=this.webglRenderer.createInstancedSDFIconBuffer((e=>this.distanceBehindDepthMesh(e)),{fadeDepth:2*d.Zc,fadeDepthTexture:this.depthTex});a.material.depthTest=!1,a.material.depthWrite=!1,a.material.side=r.DoubleSide,this.openingInsideModeInstanceBuffers[e.id]=a,this.rootObjects[e.id].add(a),this.viewByFloor.set(e.id,new Set),this.roomByFloor.set(e.id,new Set)})),this.currentFloorObservable=new U.r((()=>{var e;const t=this.viewmodeData.isInside()&&(null===(e=this.sweepData.currentAlignedSweepObject)||void 0===e?void 0:e.floorId)||null;return this.floorsViewData.currentFloorNoTransitionObservable.value||t}),[e=>this.floorsViewData.currentFloorNoTransitionObservable.onChanged(e),e=>this.sweepData.state.onPropertyChanged("currentSweep",e),e=>this.viewmodeData.onChanged(e)]),this.bindings=[this.data.onWallsChanged({onRemoved:e=>this.removeViewForWall(e),onUpdated:e=>this.updateWallView(e),onChildUpdated:e=>this.updateWallView(e),onAdded:e=>this.makeWallView(e)}),this.data.onNodesChanged({onRemoved:e=>this.removeViewForNode(e),onUpdated:e=>this.updateNodeView(e),onChildUpdated:e=>this.updateNodeView(e),onAdded:e=>this.makeNodeView(e)}),this.data.onRoomsChanged({onRemoved:e=>this.removeViewForRoom(e),onUpdated:e=>this.updateRoomView(e,!1),onChildUpdated:e=>this.updateRoomView(e,!1),onAdded:e=>this.makeRoomView(e)}),this.data.onOpeningsChanged({onRemoved:e=>this.removeViewForOpening(e),onUpdated:e=>this.updateOpeningView(e),onChildUpdated:e=>this.updateOpeningView(e),onAdded:e=>this.makeOpeningView(e)}),this.data.afterFinalize(this.onMoveEnd),this.currentFloorObservable.onChanged((()=>{this.updateCurrentFloor()})),this.settingsData.onSettingChanged(z.Y.UnitType,(e=>{for(const e of this.data.rooms.values())this.updateRoomViewText(e,!0);for(const e of this.data.walls.values()){this.updateWallView(e);for(const t of e.openings)this.updateOpeningViewUnits(t)}})),this.roomBoundsViewData.onChanged((()=>{for(const e of this.data.rooms.values())this.updateRoomViewText(e,!0)})),this.sweepData.state.onPropertyChanged("currentSweep",(()=>{this.updateIsInsideForViews()})),this.viewmodeData.onChanged((()=>{this.updateIsInsideForViews()})),this.toolsData.onPropertyChanged("activeToolName",(()=>{for(const e of this.data.rooms.values())this.updateRoomView(e,!0)}))],(0,De.C8)()||this.bindings.push(this.input.registerMeshHandler(fe.L,ge.f.isInstanceOf(me),((e,t)=>this.roomLabelHover(t,!0))),this.input.registerMeshHandler(fe.q,ge.f.isInstanceOf(me),((e,t)=>this.roomLabelHover(t,!1)))),this.bindings.push(this.input.registerMeshHandler(ve.rX,ge.f.isInstanceOf(me),((e,t)=>this.roomLabelClick(t)))),this.labelManager=new ae(u.tryGetSetting("assetBasePath",""),c.languageCode,l,(()=>this.currentFloorId),(e=>this.distanceBehindDepthMesh(e))),this.bindings.push(this.input.registerUnfilteredHandler(ye.CD,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(ve.rX,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(be.s,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(we.SK,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(we._w,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(Ie.k,(()=>this.recalculateLabelVisibility()))),this.bindings.forEach((e=>e.cancel())),this.updateCurrentFloor()}get currentFloorId(){return this.currentFloorObservable.value}get prevFloorId(){return this.currentFloorObservable.prevValue}init(){}render(e){}beforeRenderViewport(e){var t,i,n,o,a,r;this.labelManager.tickAnimations(e);const h=this.cameraData.pose.pitchFactor(),l=this.viewmodeData.insideModeTransitionProgress(),d=this.currentFloorId;d&&(null===(t=this.wallInstanceBuffers[d])||void 0===t||t.onRender(h,this.roomBoundsViewData),null===(i=this.handleInstanceBuffers[d])||void 0===i||i.onRender(h,this.roomBoundsViewData),null===(n=this.openingInstanceBuffers[d])||void 0===n||n.onRender(h,this.roomBoundsViewData),null===(o=this.openingStencilInstanceBuffers[d])||void 0===o||o.onRender(h,this.roomBoundsViewData),null===(a=this.caretsInstanceBuffers[d])||void 0===a||a.onRender(this.cameraData.metersPerPx(),this.cameraData.width,this.cameraData.height,h),null===(r=this.openingInsideModeInstanceBuffers[d])||void 0===r||r.setGlobalOpacity(l));for(const t of this.currentFloorViews())t.onRender(h,l),t.tickAnimations(e);if(d){const e=this.depthScene[d];e&&(this.resizeDepthTextureIfNecessary(),this.rttModule.clearRenderTarget2D(this.depthTex,s.V.BLACK),this.rttModule.render(this.depthTex,e,this.scene.camera,void 0,!1),this.drawDepthToScreen&&this.rttModule.renderToScreen(this.depthTex))}}dispose(){}beforeRender(){this.labelManager.update(),performance.now()-this.lastCollisionTimestamp>d.kt&&!this.generatorSpreader.hasTask(d.wX)&&(this.recalculateRoomLabelCollisions(),this.lastCollisionTimestamp=performance.now()),this.updateRoomViews()}async activate(){const e=this;await this.generatorSpreader.enqueue("load-room-bound",function*(){yield;const t=e.readonly?0:1;let i=0;if(!e.readonly)for(const[s,n]of e.data.nodes)e.makeNodeView(n),i+=t,i>=50&&(i=0,yield);for(const[t,s]of e.data.walls)e.makeWallView(s),i+=3,i>=50&&(i=0,yield);for(const[t,s]of e.data.rooms)e.makeRoomView(s),i+=20,i>=50&&(i=0,yield);for(const[t,s]of e.data.wallOpenings)e.makeOpeningView(s),i+=2,i>=50&&(i=0,yield)}(),void 0,!0),this.bindings.forEach((e=>e.renew())),this.updateCurrentFloor()}deactivate(){this.bindings.forEach((e=>e.cancel()));for(const e in this.rootObjects){const t=this.rootObjects[e];t.removeFromParent();for(const e of t.children.slice())e instanceof l.r&&e.dispose(),t.remove(e);this.wallInstanceBuffers[e].removeAllInstances(),this.handleInstanceBuffers[e].removeAllInstances(),this.openingInstanceBuffers[e].removeAllInstances(),this.openingStencilInstanceBuffers[e].removeAllInstances(),this.caretsInstanceBuffers[e].removeAllInstances(),this.openingInsideModeInstanceBuffers[e].removeAllInstances();const i=this.viewByFloor.get(e);if(i)for(const e of i)this.unregisterViewToInput(e)}for(const[e,t]of this.viewByFloor.entries())t.clear();for(const[e,t]of this.roomByFloor.entries())t.clear()}updateRoomViews(){for(const e of this.currentFloorViews(!0))e.beforeRender()}registerViewToInput(...e){for(const t of e)this.currentFloorId===t.floorId&&this.input.registerMesh(t,!1)}unregisterViewToInput(...e){for(const t of e)this.input.unregisterMesh(t)}makeNodeView(e){var t;const i=new $(e.id,e.floorId,this.cameraData,this.handleInstanceBuffers[e.floorId]),s=this.data.baseHeightForFloor(e.floorId);i.updatePosition(new r.Vector3(e.x,s,e.z)),this.nodeMap.set(e.id,i),i.fullyInitialized=!0,null===(t=this.viewByFloor.get(e.floorId))||void 0===t||t.add(i),this.registerViewToInput(i),this.viewListener.addView(i,e.id)}updateNodeView(e){const t=this.nodeMap.get(e.id);if(t){const i=this.data.baseHeightForFloor(e.floorId);t.updatePosition(new r.Vector3(e.x,i,e.z))}}removeViewForNode(e){var t;const i=this.nodeMap.get(e.id);i&&(null===(t=this.viewByFloor.get(e.floorId))||void 0===t||t.delete(i),i.fullyInitialized=!1,this.nodeMap.delete(e.id),i.dispose(),this.unregisterViewToInput(i),this.viewListener.removeView(e.id))}makeWallView(e){var t;const i=this.wallInstanceBuffers[e.floorId],s=this.labelManager.createWallLabel(e.floorId,this.rootObjects[e.floorId]);s.updateDimensions(e.from.getVec3(),e.to.getVec3(),e.width,this.getUnits());const n=new m(e.id,e.floorId,this.cameraData,i,s,this.isAdding);this.viewMap.set(e.id,n),null===(t=this.viewByFloor.get(e.floorId))||void 0===t||t.add(n),this.updateWallView(e),s.update(),n.fullyInitialized=!0,this.registerViewToInput(n),this.viewListener.addView(n,e.id)}updateWallView(e){const t=this.viewMap.get(e.id);if(t){const i=this.data.baseHeightForFloor(e.floorId);t.onEdgePositionChanged(this.data,i,this.getUnits())}}removeViewForWall(e){var t;const i=this.viewMap.get(e.id);i&&(this.labelManager.deleteLabel(i.lineLabel),this.viewMap.delete(e.id),this.visibleWallLabels.delete(i),null===(t=this.viewByFloor.get(e.floorId))||void 0===t||t.delete(i),i.dispose(),i.fullyInitialized=!1,this.unregisterViewToInput(i),this.viewListener.removeView(e.id))}makeRoomView(e){var t,i;const s=this.rootObjects[e.floorId],n=this.depthScene[e.floorId],o=this.caretsInstanceBuffers[e.floorId];this.roomMap.has(e.id)&&this.removeViewForRoom(e);const a=this.data.baseHeightForFloor(e.floorId),r=new X.y(e,e.floorId,a,this.cameraData,this.depthTex,this.roomBoundsViewData,this.labelManager,this.getUnits(),(e=>this.fallbackBaseHeightForRoom(e)),o);s.add(r.main2DMesh),n.add(r.extrusionMesh),null===(t=this.viewByFloor.get(e.floorId))||void 0===t||t.add(r),null===(i=this.roomByFloor.get(e.floorId))||void 0===i||i.add(r),r.fullyInitialized=!0,this.roomMap.set(e.id,r),this.registerViewToInput(r),this.updateRoomView(e,!0),this.viewListener.addView(r,e.id)}updateRoomViewText(e,t){const i=this.roomMap.get(e.id);if(!i)throw new Error("Unable to find view for room while updating.");i.updateUnits(this.getUnits());const s=this.data.getPotentialRoomCanvasLabels(e.id,this.locale.t(Se.A.SHOWCASE.ROOMS.DEFAULT_NAME),this.getUnits(),this.roomBoundsViewData.roomNamesVisible,this.roomBoundsViewData.roomDimensionsVisible);i.updateText(s,t)}updateRoomView(e,t){const i=this.roomMap.get(e.id);if(!i)throw new Error("Unable to find view for room while updating.");this.updateRoomViewText(e,t),i.updateGeo(e),i.beforeRender(),this.updateRoomViewSweep(e)}updateRoomViewSweep(e){const t=this.roomMap.get(e.id);if(!t)throw new Error("Unable to find view for room while updating.");const i=this.isUserInsideRoom(e);i?this.currInsideAbleViews.add(t):this.currInsideAbleViews.delete(t),t.setIsInside(i)}isUserInsideRoom(e){const t=this.sweepData.currentAlignedSweepObject,i=!!t&&t.floorId===e.floorId&&e.containsPoint(t.floorPosition.x,t.floorPosition.z);return this.settingsData.tryGetSetting(Re.VS,!1)&&i&&this.viewmodeData.insideModeTransitionProgress()>0}getInsideableViews(e){const t=new Set,i=this.roomMap.get(e.id);i&&t.add(i);for(const i of e.allWalls())for(const e of i.openings){const i=this.openingMap.get(e.id);i&&t.add(i)}return t}updateIsInsideForViews(){let e=null,t=0;for(const i of this.data.rooms.values())if(this.isUserInsideRoom(i)){e=i,t=this.roomHeightWithFallback(i);break}for(const e of this.currInsideAbleViews)e.setIsInside(!1,t);if(e){this.currInsideAbleViews.clear();const i=this.getInsideableViews(e);for(const e of i)this.currInsideAbleViews.add(e),e.setIsInside(!0,t)}}removeViewForRoom(e){var t,i;const s=this.roomMap.get(e.id);if(!s)throw new Error("Unable to find view for room while deleting.");this.rootObjects[e.floorId].remove(s.main2DMesh),this.depthScene[e.floorId].remove(s.extrusionMesh),s.fullyInitialized=!1,null===(t=this.viewByFloor.get(e.floorId))||void 0===t||t.delete(s),null===(i=this.roomByFloor.get(e.floorId))||void 0===i||i.delete(s),this.roomMap.delete(e.id),this.currInsideAbleViews.delete(s),s.dispose(),this.input.unregisterMesh(s),this.viewListener.removeView(e.id)}makeOpeningView(e){const t=this.data.getWall(e.wallId),i=new k(e.id,t.floorId,this.cameraData,this.labelManager,this.roomBoundsViewData,this.handleInstanceBuffers[t.floorId],this.openingInstanceBuffers[t.floorId],this.openingStencilInstanceBuffers[t.floorId],this.rootObjects[t.floorId],this.getUnits(),this.depthTex,this.openingInsideModeInstanceBuffers[t.floorId],this.readonly),s=this.data.getRoomsForWall(t);let n=!1,o=null;for(const e of s)if(n=this.isUserInsideRoom(e),n){o=e;break}const a=o?this.roomHeightWithFallback(o):0;n&&this.currInsideAbleViews.add(i),i.setIsInside(n,a),i.fullyInitialized=!0;for(const e of i.allSubViews())e.fullyInitialized=!0;const r=this.viewByFloor.get(e.floorId);if(null!=r){r.add(i);for(const e of i.allSubViews())r.add(e)}this.openingMap.set(e.id,i),this.registerViewToInput(i);for(const e of i.allSubViews())this.registerViewToInput(e);this.viewListener.addView(i,e.id);for(const t of i.allSubViews())this.viewListener.addView(t,e.id);this.updateOpeningView(e)}updateOpeningViewUnits(e){const t=this.openingMap.get(e.id);if(!t)throw new Error("Unable to find view for opening while updating");t.updateUnits(this.getUnits())}removeViewForOpening(e){const t=this.openingMap.get(e.id);if(!t)throw new Error("Unable to find view for opening while deleting.");t.fullyInitialized=!1;for(const e of t.allSubViews())e.fullyInitialized=!1;const i=this.viewByFloor.get(e.floorId);if(null!=i){i.delete(t);for(const e of t.allSubViews())i.delete(e)}this.openingMap.delete(e.id),this.currInsideAbleViews.delete(t),this.unregisterViewToInput(t);for(const e of t.allSubViews())this.unregisterViewToInput(e);t.dispose(),this.viewListener.removeView(e.id)}isInsideMode(){return this.viewmodeData.isInside()}roomLabelHover(e,t){if(this.isInsideMode()||!this.canHoverRoomLabels())return;const i=e.userData.roomId,s=this.roomMap.get(i);s&&s instanceof X.y&&(s.hoverRoomLabel(t),this.onRoomLabelHover(t))}roomLabelClick(e){return!(!this.isInsideMode()&&this.canHoverRoomLabels())}getUnits(){return this.settingsData.tryGetSetting(z.Y.UnitType,j.t.IMPERIAL)}fallbackBaseHeightForRoom(e){return this.data.fallbackBaseHeightForRoom(e)}recalculateLabelVisibility(){this.labelManager.needsImmediateCollsisionDetection(),this.recalculateRoomLabelCollisions()}recalculateRoomLabelCollisions(){const e=function*(e){yield;let t=0;for(const i of e.values())i.updateRoomLabelPositionAndText(!1),t++,t>=10&&(t=0,yield)}(this.roomMap);this.generatorSpreader.enqueue(d.wX,e,W.Gq.BACKGROUND)}*currentFloorViews(e=!1){const t=e?this.roomByFloor:this.viewByFloor,i=null!=this.currentFloorId?t.get(this.currentFloorId):null;if(i)for(const e of null==i?void 0:i.values())yield e}visibleIdealizedDepthMeshes(){const e=[];if(null!=this.currentFloorId){const t=this.depthScene[this.currentFloorId];if(t.children.length>0)for(const i of t.children)i.visible&&i instanceof r.Mesh&&e.push(i)}return e}roomHeightWithFallback(e){return this.data.roomHeightWithFallback(e)}toggleDepthDebugView(){this.drawDepthToScreen=!this.drawDepthToScreen}}var Ve=i(64882),Fe=i(92868),Be=i(71687),Ne=i(39209),ke=i(10459),He=i(25443),Ge=i(68387),_e=i(99583),Ue=i(12837),We=i(96319),ze=i(35699),je=i(77510),$e=i(90082);class Xe extends Ve.n{constructor(){super(...arguments),this.name="room-bound-renderer"}async init(e,t){this.engine=t,[this.data,this.renderer,this.input,this.floorsViewData,this.cameraData,this.locale,this.settingsData,this.roomBoundViewData,this.viewmodeData,this.sweepData,this.toolsData,this.rttModule]=await Promise.all([t.market.waitForData(Fe.A),t.getModuleBySymbol(Be.M7),t.getModuleBySymbol(Be.mL),t.market.waitForData(Ne.X),t.market.waitForData(ke.M),t.getModuleBySymbol(Be.gS),t.market.waitForData(He.o),t.market.waitForData(Ge.B),t.market.waitForData(_e.X),t.market.waitForData(Ue.A),t.market.waitForData(We.M),t.getModuleBySymbol(Be.kM)]),t.getModuleBySymbol($e.ZF).then((e=>{e.getSettingsGui().loadPromise.then((()=>{e.getSettingsGui().addButton(0,"Debug","Toggle Room Depth",(()=>{var e;null===(e=this.roomBoundRenderer)||void 0===e||e.toggleDepthDebugView()}))}))}))}async dispose(e){this.roomBoundRenderer&&this.engine.removeComponent(this,this.roomBoundRenderer)}async startRendering(e,t,i,s){if(this.roomBoundRenderer)throw new Error("Already rendering!!");this.roomBoundRenderer=new Oe(e,this.data,this.renderer,this.renderer.getScene(),this.input,t,i,this.floorsViewData,this.cameraData,this.locale,this.settingsData,this.roomBoundViewData,this.viewmodeData,this.sweepData,this.toolsData,this.rttModule,this.engine.generatorSpreader,s,(e=>{e?this.engine.commandBinder.issueCommand(new ze.X(je.b.FINGER)):this.engine.commandBinder.issueCommand(new ze.X(je.b.DEFAULT))})),await this.engine.addComponent(this,this.roomBoundRenderer)}async stopRendering(){if(!this.roomBoundRenderer)throw new Error("Not rendering!");this.engine.removeComponent(this,this.roomBoundRenderer),this.roomBoundRenderer.dispose(),this.roomBoundRenderer=null}}},20854:(e,t,i)=>{"use strict";i.d(t,{BC:()=>c,LH:()=>b,Lv:()=>g,Pm:()=>y,Vr:()=>f,Wh:()=>d,Yv:()=>m,ay:()=>I,dr:()=>w,jT:()=>h,kV:()=>p,lO:()=>r,lQ:()=>v,u4:()=>u,z2:()=>l});var s=i(38069),n=i(86324),o=i(68909),a=i(60552);const r=1,h=.3,l=.4,d=.6,c=.6,u=.01,p=1,m=2,g={dashed:!1,dashSize:1,gapSize:1,lineWidth:p,color:s.V.WHITE,dashUnits:n.EX.METERS,depthWrite:!1,depthTest:!0,depthFunc:o.LessDepth,globalOpacity:r},f=Object.assign(Object.assign({},g),{fadeAlongLineStartPct:c}),v={dashed:!1,dashSize:.08,gapSize:.04,lineWidth:.5,color:s.V.WHITE,dashUnits:n.EX.METERS,depthWrite:!1,depthTest:!0,depthFunc:o.GreaterDepth,globalOpacity:h},y=Object.assign(Object.assign({},v),{fadeAlongLineStartPct:c}),b={dashed:!0,dashSize:10,gapSize:4,lineWidth:p,color:s.V.WHITE,dashUnits:n.EX.PIXELS,depthWrite:!1,depthTest:!0,depthFunc:o.LessDepth,globalOpacity:r},w={dashed:!0,dashSize:10,gapSize:4,lineWidth:p,color:s.V.WHITE,dashUnits:n.EX.PIXELS,depthWrite:!1,depthTest:!0,depthFunc:o.GreaterDepth,globalOpacity:h},I=(e,t,i)=>{const h={dashed:!1,dashSize:1,gapSize:1,lineWidth:.5,color:s.V.WHITE,dashUnits:n.EX.METERS,depthWrite:!1,depthTest:!1,depthFunc:o.LessDepth,globalOpacity:null!=i?i:r,fadeDistanceFromCamera:a.GG,transitionType:n.ES.FADE_IN,transitionDuration:a.rH};return e&&(h.fadeDepth=a.Zc,h.fadeDepthTexture=e),t&&(h.fadeAlongLineStartPct=t),h}},60552:(e,t,i)=>{"use strict";i.d(t,{Dh:()=>p,FY:()=>h,Fg:()=>b,GG:()=>y,IS:()=>c,JT:()=>d,W5:()=>w,Zc:()=>v,fj:()=>I,jd:()=>u,kt:()=>m,m7:()=>n,rH:()=>f,ub:()=>r,w4:()=>a,wX:()=>g,xE:()=>o,xX:()=>l});var s=i(38069);const n=.06,o=2,a=1,r=7,h=.1,l=.02,d=100,c=8,u=500,p=.9,m=1e3,g="room-label-collision",f=300,v=.1,y=20,b=.6,w=.05,I={baseState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL},hoverState:{opacity:1,innerColor:s.V.MP_BRAND,outerColor:s.V.WHITE},selectState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL},dimState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL}}},87708:(e,t,i)=>{"use strict";i.d(t,{OW:()=>V,Om:()=>O,Tx:()=>F,p$:()=>L,zP:()=>P,zs:()=>R});var s=i(38069),n=i(68909),o=i(32686),a=i.n(o),r=i(47876),h=i.n(r),l=i(82312),d=i.n(l),c=i(93854),u=i.n(c),p=i(63380),m=i.n(p),g=i(1834),f=i.n(g),v=i(66083),y=i.n(v),b=i(4605),w=i.n(b),I=i(69555),D=i.n(I),S=i(17709),E=i.n(S),M=i(12201),C=i.n(M),T=i(76539),x=i.n(T),A=i(40160);const L={uniforms:{outlinePct:{value:.8},globalOpacity:{value:0}},vertexShader:a(),fragmentShader:h()},P={uniforms:{selectedWidth:{value:.03},globalOpacity:{value:0}},vertexShader:d(),fragmentShader:u()},R={uniforms:{globalOpacity:{value:0}},vertexShader:m(),fragmentShader:f()},O={uniforms:{opacity:{value:1},centerSpacing:{value:24},radius:{value:4},color:{value:s.V.LENS_GRAY}},vertexShader:y(),fragmentShader:w()},V={uniforms:{color:{type:"v4",value:s.V.WHITE},globalOpacity:{type:"f",value:0},outline:{value:1},outlineColor:{value:s.V.BLACK},screenSize:{value:new n.Vector2},tipPaddingPx:{value:2},widthPx:{value:12},heightPx:{value:6},aaPaddingPx:{value:2},metersPerPx:{value:.01},autoScale:{value:1}},vertexShader:D(),fragmentShader:E()},F={uniforms:{maxDistance:{value:A.sv}},vertexShader:C(),fragmentShader:x()}},92904:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ie});var s=i(64882),n=i(14614),o=i(49988),a=i(45987),r=i(25443),h=i(71687),l=i(56208),d=i(92868),c=i(73566),u=i(96319),p=i(53282),m=i(62802);class g{constructor(e){this.map=new Map,e.forEach((e=>this.map.set(e.state,e.subs)))}renew(e){(this.map.get(e)||[]).forEach((e=>e.renew()))}cancel(e){if(e){(this.map.get(e)||[]).forEach((e=>e.cancel()))}else this.map.forEach((e=>e.forEach((e=>e.cancel()))))}update(e,t){this.map.set(e,t)}}var f=i(9139),v=i(27200),y=i(89928),b=i(31002),w=i(81544),I=i(48823),D=i(3694),S=i(22937),E=i(23184),M=i(41302),C=i(3928),T=i(97994),x=i(7478),A=i(52018);const L=new f.Vy("editor");var P,R;!function(e){e.DragAndDropBase=class{subscribe(e,t){return this.events.subscribe(e,t)}constructor(e=new s,t){this.state=e,this.eventConstructors=t,this.events=new M.Q,this.bindings=[],this.validator=null,this.state.commit(),this.bindings.push(this.state.onPropertyChanged("toolState",(()=>{L.debug("toolState:",{from:this.state.previousToolState,to:this.state.toolState},this.state),this.events.broadcast(new i.StateChange(this.state.toolState,this.state.previousToolState))})),this.onSelectedChanged(((e,i)=>{this.events.broadcast(new t.SelectChange(e,i))})),this.onHoveredChanged(((e,t)=>{this.events.broadcast(new i.HoverChange(e,t))})),this.state.onCurrentIdChanged(((e,i)=>{this.events.broadcast(new t.CurrentChange(e,i))}))),this.bindings.forEach((e=>e.cancel()))}setState(e){e!==this.state.toolState&&(this.state.previousToolState=this.state.toolState,this.state.toolState=e,this.state.commit())}start(){const{toolState:e}=this.state;if(e!==t.CLOSED)throw new n("Editor already started");this.bindings.forEach((e=>e.renew())),this.setState(t.IDLE),this.events.broadcast(new i.Start)}setEnabled(e){if(this.state.toolState===t.CLOSED)throw new n("Editor not started");if(e)this.state.toolState===t.DISABLED&&this.setState(t.IDLE);else switch(this.state.toolState){case t.DISABLED:break;case t.IDLE:this.setState(t.DISABLED);break;default:this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard(),this.setState(t.DISABLED)}}exit(){this.state.toolState!==t.CLOSED&&(this.state.toolState!==t.DISABLED&&(this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard()),this.setState(t.CLOSED),this.bindings.forEach((e=>e.cancel())),this.events.broadcast(new i.Exit))}setValidator(e){this.validator=e}onDiscard(e){this.state.onBeforeDiscard=e||null}internalEdit(e){if(this.assertActive(),null!==this.state.pendingEdit)throw L.error(`Trying to edit asset ${e}, but currently editing ${this.state.pendingEdit}`),new n("Edit in progress");this.state.pendingEdit=e,this.setState(t.EDITING),this.events.broadcast(new this.eventConstructors.EditStart(e,!1))}waitForAdd(){if(this.assertActive(),null!==this.state.pendingAdd)throw L.error(`Entering wait for add state, but already adding ${this.state.pendingAdd}`),new n("Add in progress");null!==this.state.selected&&(L.debug(`Entering the wait for add state, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.events.broadcast(new i.WaitForAddStart),this.setState(t.WAIT_FOR_ADD)}internalAdd(e){if(this.assertActive(),null!==this.state.pendingAdd)throw L.error(`Trying to add new asset ${e}, but already adding ${this.state.pendingAdd}`),new n("Add in progress");null!==this.state.selected&&(L.debug(`Add ${e} called, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.state.pendingAdd=e,this.events.broadcast(new this.eventConstructors.AddStart(e)),this.setState(t.ADDING)}internalPlace(e){this.assertActive();const{pendingAdd:i,pendingEdit:s}=this.state,n=i||s;n&&e===n||(this.state.pendingEdit=e),this.setState(t.PLACING),this.events.broadcast(new this.eventConstructors.EditStart(e,!0))}move(e){this.assertActive(),this.validate(e);const{pendingAdd:t,pendingEdit:i,selected:s}=this.state,n=t||i||s;n&&this.events.broadcast(new this.eventConstructors.Move(n,e)),this.state.ndcPosition.value=e.clientPosition}highlight(...e){this.assertActive();for(const t of e)this.state.highlighted.add(t),this.events.broadcast(new i.HighlightAdd(t))}clearHighlight(...e){this.assertActive();for(const t of e)this.state.highlighted.delete(t),this.events.broadcast(new i.HighlightClear(t))}clearAllHighlights(){this.assertActive();for(const e of this.state.highlighted)this.events.broadcast(new i.HighlightClear(e));this.state.highlighted.clear()}dim(e){this.assertActive(),this.state.dimmed.add(e),this.events.broadcast(new i.DimAdd(e))}clearDim(e){this.assertActive(),this.state.dimmed.delete(e),this.events.broadcast(new i.DimClear(e))}clearAllDims(){this.assertActive();for(const e of this.state.dimmed)this.events.broadcast(new i.DimClear(e));this.state.dimmed.clear()}internalSelect(e,i){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||(this.state.previousSelected=this.state.selected,this.state.selected=e,this.state.commit(),i&&i.transitionTo?this.setState(i.transitionTo):this.setState(t.SELECTED))}deselect(e={commit:!0}){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||null!==this.state.selected&&(this.state.previousSelected=this.state.selected,this.state.selected=null,e.commit&&this.state.commit(),e&&e.transitionTo?this.setState(e.transitionTo):this.setState(t.IDLE))}hover(e){this.assertActive(),e!==this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=e,this.state.commit())}unhover(e={commit:!0}){this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=null,e.commit&&this.state.commit())}tryCommit(){this.assertActive();const e=this.state.pendingAdd,t=this.state.pendingEdit;if(!1===this.state.pendingValid)return L.warn("nop, pendingValid",this.state.pendingValid),!1;let i=!1;const s=this.state.selected,n=this.state.pendingAdd||this.state.pendingEdit;if(n){const o=null===this.state.pendingValid||!0===this.state.pendingValid;o&&(this.state.pendingAdd=null,this.state.pendingEdit=null,this.state.pendingValid=null,this.state.onBeforeDiscard=null,t&&this.events.broadcast(new this.eventConstructors.EditConfirm(t)),e&&this.events.broadcast(new this.eventConstructors.AddConfirm(e)),this.state.pendingAdd||this.state.pendingEdit||s!==this.state.selected||this.internalSelect(n)),i=o}return i}discard(){const e=this.state.pendingAdd||this.state.pendingEdit,i=this.state.pendingAdd,s=this.state.pendingEdit;e&&(this.state.onBeforeDiscard&&this.state.onBeforeDiscard(),s&&(this.state.pendingEdit=null,this.events.broadcast(new this.eventConstructors.EditDiscard(s))),i&&(this.state.pendingAdd=null,this.events.broadcast(new this.eventConstructors.AddDiscard(i))),this.events.broadcast(new this.eventConstructors.ValidChange(null,null)),this.state.pendingValid=null,this.state.onBeforeDiscard=null),this.unhover({commit:!1}),this.deselect({commit:!1}),this.state.toolState!==t.IDLE&&this.setState(t.IDLE),this.state.commit()}validate(e){const t=this.state.pendingAdd||this.state.pendingEdit||this.state.selected;if(t){const i=this.state.pendingValid;let s=!0;this.validator?(s=this.validator.validate(t,e),this.state.pendingValid=s):this.state.pendingValid=null,null!==this.state.pendingValid&&i!==this.state.pendingValid&&this.events.broadcast(new this.eventConstructors.ValidChange(s?t:null,s?null:t))}}assertActive(){if(this.state.toolState===e.ToolState.CLOSED)throw new n("Editor closed");if(this.state.toolState===e.ToolState.DISABLED)throw new n("Editor disabled")}onSelectedChanged(e){return this.state.onPropertyChanged("selected",(()=>e(this.state.selected,this.state.previousSelected)))}onHoveredChanged(e){return this.state.onPropertyChanged("hovered",(()=>e(this.state.hovered,this.state.previousHovered)))}};let t,i;e.EventConstructors=class{constructor(e,t,i,s,n,o,a,r,h,l,d){this.AddStart=e,this.EditStart=t,this.AddConfirm=i,this.AddDiscard=s,this.EditConfirm=n,this.EditDiscard=o,this.Delete=a,this.Move=r,this.CurrentChange=h,this.SelectChange=l,this.ValidChange=d}},function(e){e.CLOSED="CLOSED",e.DISABLED="DISABLED",e.IDLE="IDLE",e.SELECTED="SELECTED",e.WAIT_FOR_ADD="WAIT_FOR_ADD",e.ADDING="ADDING",e.EDITING="EDITING",e.PLACING="PLACING"}(t=e.ToolState||(e.ToolState={}));class s extends C.v{constructor(){super(...arguments),this.toolState=t.CLOSED,this.previousToolState=t.CLOSED,this.pendingAdd=null,this.pendingEdit=null,this.selected=null,this.previousSelected=null,this.hovered=null,this.previousHovered=null,this.highlighted=new Set,this.dimmed=new Set,this.ndcPosition=new T.L(null),this.onBeforeDiscard=null,this.pendingValid=null}get currentId(){return this.pendingAdd||this.pendingEdit||this.selected||null}onCurrentIdChanged(e,t=!1){let i=this.currentId;const s=()=>{this.currentId!==i&&(e(this.currentId,i),i=this.currentId)},n=new m.P(this.onPropertyChanged("selected",s),this.onPropertyChanged("pendingAdd",s),this.onPropertyChanged("pendingEdit",s));return t?n.renew():n.cancel(),n}}e.BaseState=s;class n extends A.t{constructor(e="invalid state"){super(e),this.name="invalid state"}}e.EditorException=n,function(e){class t extends x.QB{}t.type="edit",e.EditEvent=t;class i extends t{constructor(e){super(),this.target=e}}i.type="editt",e.BaseEditTarget=i;class s extends t{constructor(e,t){super(),this.target=e,this.previous=t}}s.type="edittp",e.BaseEditTargetAndPrev=s;class n extends t{constructor(e,t){super(),this.target=e,this.previous=t}}n.type="toolchange",e.StateChange=n;class o extends t{}o.type="editorstart",e.Start=o;class a extends t{}a.type="editorexit",e.Exit=a;class r extends t{}r.type="waitforaddstart",e.WaitForAddStart=r;class h extends i{}h.type="addstart",e.BaseAddStart=h;class l extends i{constructor(e,t){super(e),this.placeOnly=t}}l.type="editstart",e.BaseEditStart=l;class d extends i{}d.type="addconfirm",e.BaseAddConfirm=d;class c extends i{}c.type="adddiscard",e.BaseAddDiscard=c;class u extends i{}u.type="editconfirm",e.BaseEditConfirm=u;class p extends i{}p.type="editdiscard",e.BaseEditDiscard=p;class m extends i{}m.type="delete",e.BaseDelete=m;class g extends i{constructor(e,t){super(e),this.target=e,this.ev=t}}g.type="move",e.BaseMove=g;class f extends s{}f.type="target",e.BaseCurrentChange=f;class v extends s{}v.type="hover",e.HoverChange=v;class y extends s{}y.type="select",e.BaseSelectChange=y;class b extends i{}b.type="highlight",e.HighlightAdd=b;class w extends i{}w.type="highlightclear",e.HighlightClear=w;class I extends i{}I.type="dim",e.DimAdd=I;class D extends i{}D.type="dimclear",e.DimClear=D;class S extends s{}S.type="valid",e.BaseValidChange=S,e.hasTarget=function(e){return e instanceof i},e.hasTargetAndPrev=function(e){return e instanceof s}}(i=e.Events||(e.Events={}))}(P||(P={})),function(e){class t extends P.DragAndDropBase{constructor(e=new i){super(e,new P.EventConstructors(s.AddStart,s.EditStart,s.AddConfirm,s.AddDiscard,s.EditConfirm,s.EditDiscard,s.Delete,s.Move,s.CurrentChange,s.SelectChange,s.ValidChange)),this.state=e}add(e){this.internalAdd(e)}edit(e){this.internalEdit(e)}place(e){this.internalPlace(e)}select(e,t){this.internalSelect(e,t)}toggleSelect(e){this.state.selected===e?this.deselect():this.select(e)}}e.DragAndDrop=t;class i extends P.BaseState{}let s;e.State=i,function(e){class t extends P.Events.BaseAddStart{}e.AddStart=t;class i extends P.Events.BaseEditStart{}e.EditStart=i;class s extends P.Events.BaseAddConfirm{}e.AddConfirm=s;class n extends P.Events.BaseAddDiscard{}e.AddDiscard=n;class o extends P.Events.BaseEditConfirm{}e.EditConfirm=o;class a extends P.Events.BaseEditDiscard{}e.EditDiscard=a;class r extends P.Events.BaseDelete{}e.Delete=r;class h extends P.Events.BaseMove{}e.Move=h;class l extends P.Events.BaseCurrentChange{}e.CurrentChange=l;class d extends P.Events.BaseSelectChange{}e.SelectChange=d;class c extends P.Events.BaseValidChange{}e.ValidChange=c}(s=e.Events||(e.Events={}))}(R||(R={}));var O=i(35699),V=i(77510);const F=new f.Vy("room-bounds-editor");class B extends R.DragAndDrop{constructor(e,t,i,s){super(new R.State),this.messageBus=e,this.commandBinder=t,this.input=i,this.isRoomHoverAllowed=s,this.allViewsComparator=E.f.is((e=>e instanceof I.y)),this.subscribe(P.Events.StateChange,(async({target:e})=>{this.inputStates||(this.inputStates=this.bindInputToEditorStates()),this.inputStates.cancel(),this.inputStates.renew(e)}))}bindInputToEditorStates(){const e=()=>{this.setEnabled(!1),this.commandBinder.issueCommand(new O.X(V.b.DEFAULT))},t=()=>this.setEnabled(!0),i=new m.P((0,p.Sh)((()=>this.messageBus.subscribe(S.zM,e)),(()=>this.messageBus.unsubscribe(S.zM,e)),!1),(0,p.Sh)((()=>this.messageBus.subscribe(S.pT,t)),(()=>this.messageBus.unsubscribe(S.pT,t)),!1),this.isRoomHoverAllowed.onChanged((i=>{i?t():e()}))),s=(0,v.C8)()?new m.P:new m.P(this.input.registerMeshHandler(w.L,this.allViewsComparator,((e,t)=>{this.hover(t.roomBoundsId),this.commandBinder.issueCommand(new O.X(V.b.FINGER))})),this.input.registerMeshHandler(w.q,this.allViewsComparator,(()=>{this.unhover(),this.commandBinder.issueCommand(new O.X(V.b.DEFAULT))})));s.cancel();const n=new m.P(this.input.registerMeshHandler(b.rX,this.allViewsComparator,this.onToggleSelectInput.bind(this)));n.cancel();const o=[this.input.registerMeshHandler(b.rX,E.f.isType(D.W),(e=>!!this.state.selected&&(this.discard(),e.preventDefault(),!0)))],a=new m.P(...o);a.cancel();const r=this.messageBus.subscribe(y.G,(()=>this.discard())),h=new m.P(i,s,n,a,r,(e=>{const t=F.debug;return(0,p.Sh)((()=>t(`${e}.renew()`)),(()=>t(`${e}.cancel()`)),!1)})("ToolState.SELECTED || ToolState.IDLE -> bindings"));return new g([{state:P.ToolState.DISABLED,subs:[i]},{state:P.ToolState.SELECTED,subs:[h]},{state:P.ToolState.IDLE,subs:[h]}])}onToggleSelectInput(e,t){const i=t.roomBoundsId,s=this.state.selected===i;return i&&setTimeout((()=>{t instanceof I.y&&!t.main2DMesh.parent||(s?e instanceof b.rX&&(this.discard(),this.deselect()):(this.select(i),this.hover(i)))}),0),!s}}var N,k,H=i(88186),G=i(98720);!function(e){class t extends P.DragAndDropBase{constructor(e=new i){super(e,new P.EventConstructors(s.AddStart,s.EditStart,s.AddConfirm,s.AddDiscard,s.EditConfirm,s.EditDiscard,s.Delete,s.Move,s.CurrentChange,s.SelectChange,s.ValidChange)),this.state=e}add(e){this.internalAdd(new Set(e))}edit(e){this.internalEdit(new Set(e))}place(e){this.internalPlace(new Set(e))}select(e,t){const i=(null==t?void 0:t.addToExistingSelection)&&this.state.selected?Array.from(this.state.selected.keys()).concat(e):e;this.internalSelect(new Set(i),t)}toggleSelect(e){var t;const i=new Set(null===(t=this.state.selected)||void 0===t?void 0:t.keys());for(const t of e)i.has(t)?i.delete(t):i.add(t);this.internalSelect(i)}}e.DragAndDrop=t;class i extends P.BaseState{}let s;e.State=i,function(e){class t extends P.Events.BaseAddStart{}e.AddStart=t;class i extends P.Events.BaseEditStart{}e.EditStart=i;class s extends P.Events.BaseAddConfirm{}e.AddConfirm=s;class n extends P.Events.BaseAddDiscard{}e.AddDiscard=n;class o extends P.Events.BaseEditConfirm{}e.EditConfirm=o;class a extends P.Events.BaseEditDiscard{}e.EditDiscard=a;class r extends P.Events.BaseDelete{}e.Delete=r;class h extends P.Events.BaseMove{}e.Move=h;class l extends P.Events.BaseCurrentChange{}e.CurrentChange=l;class d extends P.Events.BaseSelectChange{}e.SelectChange=d;class c extends P.Events.BaseValidChange{}e.ValidChange=c}(s=e.Events||(e.Events={}))}(N||(N={})),function(e){const t={[P.Events.HoverChange.type]:"hoverState",[P.Events.HighlightAdd.type]:"highlightState",[P.Events.HighlightClear.type]:"highlightState",[P.Events.DimAdd.type]:"dimState",[P.Events.DimClear.type]:"dimState"};class i{constructor(e){this.editor=e,this.bindings=[],this.entities=new Map,this.bindings.push(this.editor.subscribe(P.Events.HoverChange,(e=>this.bindTargetedCallback(P.Events.HoverChange.type,e))),this.editor.subscribe(P.Events.HighlightAdd,(e=>this.bindTargetedCallback(P.Events.HighlightAdd.type,e))),this.editor.subscribe(P.Events.HighlightClear,(e=>this.bindClearCallback(P.Events.HighlightClear.type,e))),this.editor.subscribe(P.Events.DimAdd,(e=>this.bindTargetedCallback(P.Events.DimAdd.type,e))),this.editor.subscribe(P.Events.DimClear,(e=>this.bindClearCallback(P.Events.DimClear.type,e))))}registerEntity(e,...t){let i=this.entities.get(e);i||(i=[]),i.push(...t),this.entities.set(e,i)}unregisterEntity(e){return this.entities.delete(e)}bindTargetedCallback(e,t){const{target:i,previousTarget:s}=this.getTargetAndPrevIds(t),n=this.eventToCallbackMapping[e];if(!n)throw Error(`implement targetted callback for ${e}`);for(const e of s)(this.entities.get(e)||[]).forEach((e=>{n in e&&(e[n].active=!1,e[n].off())}));for(const e of i)(this.entities.get(e)||[]).forEach((e=>{n in e&&(e[n].active=!0,e[n].on())}))}bindMoveCallback(e){const{target:t}=this.getTargetAndPrevIds(e);for(const i of t)(this.entities.get(i)||[]).forEach((t=>{t.mover&&e.target&&t.mover.onMove(i,e.ev)}))}bindClearCallback(e,t){const i=this.eventToCallbackMapping[e],{target:s}=this.getTargetAndPrevIds(t);for(const e of s)(this.entities.get(e)||[]).forEach((e=>{i in e&&(e[i].active=!1,e[i].off())}))}}e.BaseEditorEntityAdapter=i;e.EditorEntityAdapter=class extends i{constructor(e){super(e),this.eventToCallbackMapping=Object.assign(Object.assign({},t),{[R.Events.SelectChange.type]:"selectState",[R.Events.ValidChange.type]:"validState",[R.Events.Move.type]:"mover"}),this.bindings.push(this.editor.subscribe(R.Events.SelectChange,(e=>this.bindTargetedCallback(R.Events.SelectChange.type,e))),this.editor.subscribe(R.Events.ValidChange,(e=>this.bindTargetedCallback(R.Events.ValidChange.type,e))),this.editor.subscribe(R.Events.Move,(e=>this.bindMoveCallback(e))))}getTargetAndPrevIds(e){if(P.Events.hasTargetAndPrev(e))return{target:e.target?[e.target]:[],previousTarget:e.previous?[e.previous]:[]};if(P.Events.hasTarget(e))return{target:e.target?[e.target]:[],previousTarget:[]};throw new Error("Unexpected message!!")}};e.MultiSelectEditorEntityAdapter=class extends i{constructor(e){super(e),this.eventToCallbackMapping=Object.assign(Object.assign({},t),{[N.Events.SelectChange.type]:"selectState",[N.Events.ValidChange.type]:"validState",[N.Events.Move.type]:"mover"}),this.bindings.push(this.editor.subscribe(N.Events.SelectChange,(e=>this.bindTargetedCallback(N.Events.SelectChange.type,e))),this.editor.subscribe(N.Events.ValidChange,(e=>this.bindTargetedCallback(N.Events.ValidChange.type,e))),this.editor.subscribe(N.Events.Move,(e=>this.bindMoveCallback(e))))}getTargetAndPrevIds(e){const t=e=>e instanceof Set?Array.from(e.keys()):null!==e?[e]:[];if(P.Events.hasTargetAndPrev(e))return{target:e.target?t(e.target):[],previousTarget:e.previous?t(e.previous):[]};if(P.Events.hasTarget(e))return{target:e.target?t(e.target):[],previousTarget:[]};throw new Error("Unexpected message!!")}}}(k||(k={}));class _{constructor(e,t){this.editor=e,this.data=t,this.readBindings=[],this.mover={onMove:(e,t)=>{}},this.onCurrentChange=({target:e})=>{this.editor.state.toolState!==P.ToolState.ADDING&&this.clearHighlightedViews(),this.highlightView(e)},this.onSelectChange=({target:e})=>{this.setSelectedView(e)},this.onHoverChange=({target:e,previous:t})=>{if(this.editor.state.toolState===P.ToolState.ADDING)return;if(!e)return this.editor.clearAllDims(),this.editor.clearAllHighlights(),void(this.editor.state.selected&&this.setSelectedView(this.editor.state.selected));const i=this.data.getEntity(e);this.hoverView(i)},this.editableEntities=new k.EditorEntityAdapter(this.editor)}addEditableEntity(e,t){this.editableEntities.registerEntity(t,this,e)}removeEditableEntity(e){this.editableEntities.unregisterEntity(e)}activate(){0===this.readBindings.length?this.readBindings.push(this.editor.subscribe(R.Events.CurrentChange,this.onCurrentChange),this.editor.subscribe(R.Events.SelectChange,this.onSelectChange),this.editor.subscribe(P.Events.HoverChange,this.onHoverChange)):this.readBindings.forEach((e=>e.renew()))}deactivate(){this.readBindings.forEach((e=>e.cancel()))}clearHighlightedViews(){this.editor.clearAllHighlights()}highlightView(e){if(!e)return;const t=this.data.getEntity(e);t instanceof G.j&&this.editor.highlight(e,t.from.id,t.to.id)}setSelectedView(e){if(!e)return void this.editor.clearAllDims();const t=this.data.getEntity(e);t instanceof G.j&&this.editor.highlight(t.from.id,t.to.id),t instanceof H.pQ&&(this.clearHighlightedViews(),this.dimAllRooms(),this.selectRoom(t))}dimAllRooms(){this.editor.clearAllDims();for(const[,e]of this.data.rooms)this.dimRoom(e)}hoverView(e){e instanceof H.pQ&&this.hoverRoom(e)}hoverRoom(e){const t=e.id;this.editor.clearDim(t);for(const t of e.walls)this.editor.clearDim(t.id),this.highlightWallOpenings(t);for(const t of e.points)this.editor.clearDim(t.id)}selectRoom(e){const t=e.id;this.editor.clearDim(t);for(const t of e.walls)this.editor.clearDim(t.id),this.highlightWallOpenings(t);for(const t of e.points)this.editor.clearDim(t.id)}dimRoom(e){const t=e.id;this.editor.dim(t);for(const t of e.walls)this.editor.dim(t.id),this.clearHighlightWallOpenings(t);for(const t of e.points)this.editor.dim(t.id)}highlightWallOpenings(e){this.editor.highlight(...e.openings.map((e=>e.id)))}clearHighlightWallOpenings(e){this.editor.clearHighlight(...e.openings.map((e=>e.id)))}}var U=i(68387),W=i(11165);class z extends W.u{constructor(e){super(),this.payload={id:e}}}z.id="roombound_unselect";class j extends W.u{constructor(e){super(),this.payload={allowRendering:e}}}j.id="room_bound_set_allow_rendering";var $=i(99583),X=i(41535),q=i(28454),Y=i(12625);class Q extends Y.B{constructor(e){super(),this.editorState=e,this.name="room-bound-editor-state-data",this.commit()}}var K=i(8694),Z=i(12837);const J=[c.S0.SEARCH,c.S0.LAYERS,c.S0.ROOM_VIEW,c.S0.HLR,c.S0.MEASUREMENTS],ee=new Map,te=new Set([X.hb.CLOSED,X.hb.IDLE]);class ie extends s.n{constructor(){super(...arguments),this.name="room_bound",this.active=!1,this.allowRendering=!0,this._currentRoomData=null,this.externalControl=!1,this.isActivatingOrDeactivating=!1,this.viewListener={addView:(e,t)=>this.inputManager.addEditableEntity(e,t),removeView:e=>this.inputManager.removeEditableEntity(e)},this.activate=async()=>{this.isActivatingOrDeactivating=!0,this.active||(this.active=!0,this.editor.start(),await this.startRenderer(),this.viewData.setRoomBoundVisible(!0),this.inputManager.activate()),this.isActivatingOrDeactivating=!1},this.deactivate=async()=>{this.isActivatingOrDeactivating=!0,this.active&&(this.active=!1,this.editor.exit(),this.stopRenderer(),this.viewData.setRoomBoundVisible(!1),this.inputManager.deactivate()),this.isActivatingOrDeactivating=!1},this.unselect=async e=>{e&&(await this.updateShowcaseVisibility(),this.active&&this.editor.deselect())}}getAllowRendering(){return this.allowRendering}get currentRoomData(){if(!this._currentRoomData)throw new Error("CurrentRoomBoundRoomData not initialized. Make sure the module is fully initialized.");return this._currentRoomData}async init(e,t){this.engine=t;const[i,s,p,m,g,f,v]=await Promise.all([t.getModuleBySymbol(h.mL),t.market.waitForData(d.A),t.market.waitForData(r.o),t.market.waitForData(n.zH),t.market.waitForData(u.M),t.market.waitForData($.X),t.market.waitForData(q.s)]);this.data=s,this.data.onActionError=e=>{this.applicationData.error=e,this.applicationData.commit()},this.applicationData=m,this.toolsData=g,this.settingsData=p,this.viewData=new U.B(this.data,m,g),t.market.register(U.B,this.viewData),this.viewmodeData=f,this.isRoomHoverAllowed=new o.r((()=>this.applicationData.application!==n.lg.SHOWCASE||this.toolsData.activeToolName!==c.S0.MEASUREMENTS||te.has(v.phase)),[e=>v.onPhaseChanged(e),e=>this.toolsData.onPropertyChanged("activeToolName",e),e=>this.applicationData.onChanged(e)]),this.editor=new B(t.msgBus,t.commandBinder,i,this.isRoomHoverAllowed);const y=new Q(this.editor.state);t.market.register(Q,y),this.inputManager=new _(this.editor,s),this.bindings.push(t.commandBinder.addBinding(z,(async e=>this.unselect(e.id))),t.commandBinder.addBinding(j,(async e=>await this.setAllowRendering(e.allowRendering))),this.applicationData.onChanged((()=>this.updateShowcaseVisibility())),this.viewmodeData.onChanged((()=>this.updateShowcaseVisibility())),this.toolsData.onPropertyChanged("activeToolName",(()=>this.updateShowcaseVisibility())),this.settingsData.onSettingChanged(l.Q$.RoomBounds,(()=>this.updateShowcaseAvailability())),t.subscribe(a.Fj,(e=>{this.updateShowcaseVisibility()}))),await this.updateShowcaseAvailability(),this.setupCurrentRoomData(t)}dispose(e){super.dispose(e),e.market.unregister(U.B)}toggleVisibilityForViewer(e){this.viewData.commit(),this.updateShowcaseVisibility()}async startRenderer(){const e=await this.engine.getModuleBySymbol(h.A5);await e.startRendering(!0,this.viewListener,(()=>!1),(()=>this.isRoomHoverAllowed.value))}async stopRenderer(){(await this.engine.getModuleBySymbol(h.A5)).stopRendering()}async updateShowcaseAvailability(){this.settingsData.tryGetSetting(l.Q$.RoomBounds,!1)&&!this.viewData.visibleInShowcase?this.toggleVisibilityForViewer(!0):await this.updateShowcaseVisibility()}async updateShowcaseVisibility(){if(this.isActivatingOrDeactivating||this.externalControl)return;const{application:e}=this.applicationData,t=e===n.lg.SHOWCASE,i=e===n.lg.WORKSHOP,s=this.settingsData.tryGetSetting(l.Q$.RoomBounds,!1),o=t&&this.viewData.visibleInShowcase&&s||i,a=null==this.toolsData.activeToolName||J.includes(this.toolsData.activeToolName),r=null!=this.toolsData.activeToolName?ee.get(this.toolsData.activeToolName):null,h=null!=r&&null!=this.viewmodeData.currentMode&&r.includes(this.viewmodeData.currentMode),d=a||h,c=this.data.rooms.size>0,u=!this.viewmodeData.isExterior();o&&d&&c&&this.allowRendering&&u?await this.activate():await this.deactivate()}async takeoverVisibilityControl(){this.externalControl=!0,await this.deactivate()}async returnVisibilityControl(){this.externalControl=!1,this.updateShowcaseVisibility()}setupCurrentRoomData(e){e.market.waitForData(Z.A).then((t=>{const i=new K.y(t,this.data);this._currentRoomData=i,e.market.register(K.y,i)}))}async setAllowRendering(e){this.allowRendering=e,this.updateShowcaseVisibility()}}},93358:(e,t,i)=>{"use strict";i.d(t,{W:()=>s});class s{constructor(e){this.tags=[],e&&Object.assign(this,e)}}},33062:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var s=i(64882),n=i(9139),o=i(3928);class a extends o.v{equals(e){return this.id===e.id}copy(e){return this.id=e.id,this.name=e.name,this.vendor=e.vendor,this.model=e.model,this.captureMode=e.captureMode,this.depthCameraType=e.depthCameraType,this.cameraTypes=e.cameraTypes.slice(),this.sensorSerialNumbers=e.sensorSerialNumbers.slice(),this.serialNumber=e.serialNumber,this.mountCalibrationVersion=e.mountCalibrationVersion,this.softwareVersion=e.softwareVersion,this}}class r extends o.v{constructor(e){super(),e&&(e.id&&(this.id=e.id),void 0!==e.index&&(this.index=e.index),this.name=e.name||"",this.created=e.created||"",this.alignment=e.alignment||"",this.options=e.options||[],this.camera=e.camera||new a)}equals(e){return this.id===e.id}copy(e){return this.id=e.id,this.index=e.index,this.name=e.name,this.created=e.created,this.alignment=e.alignment,this.options=e.options.slice(),this.camera=(new a).copy(e.camera),this}}const h=new n.Vy("mds-scaninfo-serializer");class l{deserialize(e){if(!e||!this.validate(e))return h.debug("Deserialized invalid ScanInfo data from MDS",e),null;const t=e,i=new r;i.id=t.id,i.anchorId=t.anchor&&t.anchor.id||"",i.index=t.index||-1,i.name=t.name||"",i.created=t.created||"",i.alignment=t.alignment||"",i.url=t.url||"",i.timeOfDay=t.timeOfDay||"",i.options=t.options||[];const s=t.camera;return i.camera=new a,i.camera.id=s&&s.id||"",i.camera.name=s&&s.name||"",i.camera.vendor=s&&s.vendor||"",i.camera.model=s&&s.model||"",i.camera.captureMode=s&&s.captureMode||"",i.camera.depthCameraType=s&&s.depthCameraType||"",i.camera.cameraTypes=((null==s?void 0:s.cameraTypes)||[]).filter((e=>e)),i.camera.sensorSerialNumbers=((null==s?void 0:s.sensorSerialNumbers)||[]).filter((e=>e)),i.camera.serialNumber=s&&s.serialNumber||"",i.camera.mountCalibrationVersion=(null==s?void 0:s.mountCalibrationVersion)?s.mountCalibrationVersion:void 0,i.camera.softwareVersion=s&&s.softwareVersion||"",i}validate(e){if(!e)return!1;return["id"].every((t=>t in e))}}var d=i(20968),c=i(34558);class u{}class p extends d.g{constructor(){super(...arguments),this.deserializer=new l}async fetch(){const e=this.getViewId();return this.query(c.GetScans,{modelId:e},{fetchPolicy:"no-cache"}).then((e=>{var t,i,s;const n=(null===(s=null===(i=null===(t=e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.assets)||void 0===s?void 0:s.scans)||[],o={},a={};for(const e of n){const t=this.deserializer.deserialize(e);t&&(o[t.id]=t,t.anchorId&&(a[t.anchorId]=t))}const r=new u;return r.scansById=o,r.scansByAnchor=a,r}))}async read(){return this.scans||(this.scans=this.fetch()),this.scans}async refresh(){return this.scans=this.fetch(),this.scans}}var m=i(47737);class g extends s.n{constructor(){super(...arguments),this.name="scaninfo-data",this.getScanInfo=e=>this.store.read().then((t=>t?t.scansByAnchor[e]:void 0)),this.getScanDownloadURL=e=>this.store.refresh().then((t=>{if(t){const i=t.scansByAnchor[e];return i?i.url:void 0}}))}async init(e,t){const i=await t.market.waitForData(m.P);this.store=new p({context:i.mdsContext,readonly:!0})}}},58899:(e,t,i)=>{"use strict";i.d(t,{r:()=>r});var s=i(39905),n=i(94547),o=i(93877);const a=new s.r({});class r{constructor(e,t,i){this.commandBinder=e,this.layersData=t,this.dataTypeGroup=i,this.textParser=a,this.enabled=!0,this.bindings=[]}get isInMemory(){var e,t;const i=this.getLayerGroupId();if(!i)return!1;const s=null===(e=this.layersData)||void 0===e?void 0:e.getLayer(i);return null!==(t=null==s?void 0:s.isInMemory)&&void 0!==t&&t}getLayerType(){var e;const t=this.getLayerGroupId();if(!t)return;const i=null===(e=this.layersData)||void 0===e?void 0:e.getLayer(t);return null==i?void 0:i.layerType}getGroupingId(e){switch(e){case o.Hj.TYPE:return this.getTypeId();case o.Hj.FLOOR:return this.getFloorId();case o.Hj.ROOM:return this.getRoomId();case o.Hj.LAYER:return this.getLayerGroupId();case o.Hj.DATE:return this.dateBucket}}getFloorId(){return this.floorId}getRoomId(){return this.roomId}getDateBucket(){return this.dateBucket}getTypeId(){return this.typeId}supportsBatchDelete(){return!1}supportsLayeredCopyMove(){return!1}getLayerGroupId(){var e,t;const i=null===(e=this.layersData)||void 0===e?void 0:e.getBaseLayerId(),s=null===(t=this.layersData)||void 0===t?void 0:t.getViewLayerId();return this.layerId&&s&&this.layerId===i?s:this.layerId}isLayerVisible(){return!this.layersData||!this.layerId||this.layersData.layerVisible(this.layerId)}onSelect(e,t,i){this.commandBinder.issueCommand(new n.Xx(this.id,this.typeId))}registerBindings(){}cancelBindings(){this.bindings.forEach((e=>e.cancel()))}}},94547:(e,t,i)=>{"use strict";i.d(t,{$M:()=>a,Oc:()=>c,Pb:()=>o,Xx:()=>d,_d:()=>h,_w:()=>l,tA:()=>n,tf:()=>u,xg:()=>r});var s=i(11165);class n extends s.u{constructor(e){super(),this.payload={query:e}}}n.id="UPDATE_SEARCH_QUERY";class o extends s.u{constructor(e){super(),this.payload={keywords:e}}}o.id="UPDATE_SEARCH_QUERY_KEYWORDS";class a extends s.u{constructor(e){super(),this.payload={keywordId:e}}}a.id="TOGGLE_SEARCH_QUERY_KEYWORD";class r extends s.u{constructor(e){super(),this.payload={grouping:e}}}r.id="CHANGE_SEARCH_GROUPING";class h extends s.u{constructor(){super()}}h.id="SEARCH_FILTER_CLEAR";class l extends s.u{constructor(e,t){super(),this.payload={groupId:e,enabled:t}}}l.id="SEARCH_FILTER_TOGGLE";class d extends s.u{constructor(e,t){super(),this.payload={id:e,typeId:t}}}d.id="SELECT_SEARCH_RESULT";class c extends s.u{constructor(e){super(),this.payload=e}}c.id="SEARCH_GROUP_REGISTER";class u extends s.u{constructor(e){super(),this.payload={id:e}}}u.id="SEARCH_GROUP_DEREGISTER"},13397:(e,t,i)=>{"use strict";i.d(t,{e:()=>o});var s=i(87805),n=i(78849);const o=(0,s.u)(n.L,"query","")},2812:(e,t,i)=>{"use strict";i.d(t,{O:()=>r});var s=i(12625),n=i(64391),o=i(45205),a=i(97696);class r extends s.B{constructor(e){super(),this.name="snapshots",this.snapshots={};for(const t in e)this.snapshots[t]=e[t].clone()}get(e){return this.snapshots[e]}async getImageUrl(e){const t=this.get(e),i=new URL(await t.imageUrl.get());return"panorama"===t.category&&(i.searchParams.delete("height"),i.searchParams.delete("fit")),i.toString()}get collection(){return this.snapshots}get snapshotsCount(){return this.snapshots?Object.keys(this.snapshots).length:0}getSortedCollection(e){if(!this.snapshotsCount)return[];let t=Object.values(this.snapshots);return(null==e?void 0:e.filterFn)&&(t=t.filter(e.filterFn)),t.sort((null==e?void 0:e.compareFn)||a.PN)}setSelectedPhoto(e){this.selectedPhotoId=e,this.commit()}add(e){e.sid=this.validateSid(e.sid),this.snapshots[e.sid]=e,this.updateOnStaleCallbacks(),this.commit()}remove(e){delete this.snapshots[e]}validateSid(e){for(;!e||this.snapshots[e];)e=(0,o.D)(11);return e}set onStale(e){this.hydrate=e,this.updateOnStaleCallbacks()}updateOnStaleCallbacks(){this.hydrate&&(0,n._)(this.snapshots,(async()=>{const e=await this.hydrate();for(const t in this.snapshots)e&&e[t]&&this.snapshots[t].refresh(e[t])}))}}},10574:(e,t,i)=>{"use strict";i.d(t,{V:()=>n});var s=i(11165);class n extends s.u{constructor(e){super(),this.payload={navSize:e}}}n.id="SET_NAV_PANO_SIZE"},62772:(e,t,i)=>{"use strict";i.d(t,{R:()=>o});var s=i(17904),n=i(71687);function o(){return(0,s.S)(n.uq)}},6297:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ToolAnnouncementHandler:()=>g,ToolAnnouncementViewData:()=>b,default:()=>D,useToolAnnouncementModule:()=>o.R,useToolAnnouncementState:()=>a});var s=i(96540),n=i(73566),o=i(62772);function a(e){const t=(0,o.R)(),[i,a]=(0,s.useState)((()=>{var i;return null!==(i=null==t?void 0:t.getToolAnnouncementState(e))&&void 0!==i?i:n.zR.IDLE}));return(0,s.useEffect)((()=>{if(!t)return;a(t.getToolAnnouncementState(e));const i=t.onToolAnnouncementStateChanged(e,((e,t)=>{a(t)}));return()=>{i.cancel()}}),[t,e]),i}var r=i(56147);const{NEW_BADGE:h}=r.A.WORKSHOP.EDIT_BAR,{AUTOGEN_TOUR_CREATED_TITLE:l,AUTOGEN_TOUR_CREATED_MESSAGE:d,AUTOGEN_TOUR_READY_TITLE:c,AUTOGEN_TOUR_READY_MESSAGE:u}=r.A.WORKSHOP.HLR,p={[n.Q7.HLR_AUTOGEN_TOUR_CREATED]:{AnnouncementComponent:(0,s.lazy)((()=>i.e(8636).then(i.bind(i,65205)))),configProps:{icon:"sparkle",badgePhraseKey:h,titlePhraseKey:l,messagePhraseKey:d}},[n.Q7.HLR_AUTOGEN_TOUR_READY]:{AnnouncementComponent:(0,s.lazy)((()=>i.e(8636).then(i.bind(i,65205)))),configProps:{icon:"sparkle",badgePhraseKey:h,titlePhraseKey:c,messagePhraseKey:u,tooltipOptions:{placement:"top",strategy:"absolute"}}}};var m=i(74848);function g(e){let{target:t,announcement:i}=e;if(a(i)!==n.zR.OPEN)return null;const{AnnouncementComponent:o,configProps:r}=p[i];return(0,m.jsx)(s.Suspense,{children:(0,m.jsx)(o,{...r,target:t,announcement:i})})}var f=i(12625),v=i(88325),y=i(51182);class b extends f.B{constructor(){super(),this.name="tool-announcement-view-data",this.bypassLocalStorage=!1,this.toolAnnouncementsState=new v.E}enableDebugMode(){this.bypassLocalStorage=!0}disableDebugMode(){this.bypassLocalStorage=!1}clearToolAnnouncementsState(){this.toolAnnouncementsState.clear()}getToolAnnouncementsStateEntries(){return this.toolAnnouncementsState.entries()}getToolAnnouncementState(e){return this.toolAnnouncementsState.get(e)}setToolAnnouncementState(e,t){if(this.bypassLocalStorage)return void this.toolAnnouncementsState.set(e,t);const i=t===n.zR.OPEN,s=(0,y.zM)(e,!1);s&&i||(!s&&i&&(0,y.lk)(e,String(!0)),this.toolAnnouncementsState.set(e,t))}onToolAnnouncementStateChanged(e,t){return this.toolAnnouncementsState.onElementChanged({onUpdated:(i,s)=>{e===s&&t(s,i)}})}}var w=i(64882),I=i(9139);class D extends w.n{constructor(){super(...arguments),this.name="tool-announcement-gui",this.data=new b,this.DefaultToolAnnouncements=[[n.Q7.HLR_AUTOGEN_TOUR_CREATED,n.zR.IDLE],[n.Q7.HLR_AUTOGEN_TOUR_READY,n.zR.IDLE]]}async init(e,t){e.debug&&(I.Vy.for(this).debug("ToolAnnouncementViewModule initialized in debug mode"),this.data.enableDebugMode()),this.registerToolAnnouncements(),t.market.register(b,this.data)}dispose(e){e.market.unregister(b),this.data.clearToolAnnouncementsState(),this.data.disableDebugMode(),super.dispose(e)}getToolAnnouncementState(e){return this.data.getToolAnnouncementState(e)}setToolAnnouncementState(e,t){this.data.setToolAnnouncementState(e,t)}closeActiveToolAnnouncements(){const e=this.data.getToolAnnouncementsStateEntries();for(const[t,i]of e)i===n.zR.OPEN&&this.data.setToolAnnouncementState(t,n.zR.CLOSE)}onToolAnnouncementStateChanged(e,t){return this.data.onToolAnnouncementStateChanged(e,t)}registerToolAnnouncements(){this.data.clearToolAnnouncementsState();for(const[e,t]of this.DefaultToolAnnouncements)this.data.setToolAnnouncementState(e,t)}}},47067:(e,t,i)=>{"use strict";i.d(t,{P:()=>o});var s=i(3928),n=i(4850);class o extends s.v{constructor(e){super(),this.reel=(0,n.Z)([]),this.modified=new Date,this.mode=e,this.commit()}replace(e){this.atomic((()=>{this.sid=e.sid,this.reel.replace(Array.from(e.reel.values())),this.mode=e.mode,this.modified=e.modified}))}copy(e){return this.atomic((()=>{this.sid=e.sid,this.mode=e.mode,this.modified=e.modified,this.reel=(0,n.Z)([...e.reel.map((e=>Object.assign({},e)))])})),this}clone(){return new o(this.mode).copy(this)}}},15506:(e,t,i)=>{"use strict";i.d(t,{Ux:()=>l,j7:()=>h,nl:()=>r,np:()=>c,vr:()=>d,zc:()=>a});var s=i(74381),n=i(13893),o=i(1333);const a={[s.ES.FADE_TO_BLACK]:n.fl.FadeToBlack,[s.ES.INSTANT]:n.fl.Instant,[s.ES.INTERPOLATE]:n.fl.Interpolate},r={[s.Zw.LEFT]:o.ND.Left,[s.Zw.RIGHT]:o.ND.Right,[s.Zw.AUTO]:o.ND.Auto},h={[s.h6.START]:"start",[s.h6.CENTER]:"center"},l={[n.fl.FadeToBlack]:s.ES.FADE_TO_BLACK,[n.fl.Instant]:s.ES.INSTANT,[n.fl.Interpolate]:s.ES.INTERPOLATE,[n.fl.MoveToBlack]:s.ES.FADE_TO_BLACK,[n.fl.OrbitTo]:s.ES.INTERPOLATE},d={[o.ND.Left]:s.Zw.LEFT,[o.ND.Right]:s.Zw.RIGHT,[o.ND.Auto]:s.Zw.AUTO},c={start:s.h6.START,center:s.h6.CENTER}},85092:(e,t,i)=>{"use strict";i.r(t),i.d(t,{HighlightReel:()=>S.P,TourAddPosition:()=>g.dO,TourData:()=>s.R,TourMode:()=>g.cR,TourState:()=>g.Ci,ToursViewData:()=>n.F,default:()=>W});var s=i(21875),n=i(44481),o=i(64882),a=i(14614),r=i(56287),h=i(81547),l=i(1284),d=i(25443),c=i(74381),u=i(56208),p=i(71687),m=i(47737),g=i(96425),f=i(35447),v=i(15580),y=i(66806),b=i(70046),w=i(97171),I=i(9139),D=i(2812),S=i(47067),E=i(87743),M=i(62802),C=i(56147),T=i(94547),x=i(84917),A=i(58899);const{HLR:L}=C.A.WORKSHOP;class P extends A.r{constructor(e,t,i,s,n,o,a,r){if(super(i,void 0,s),this.toursDataModule=e,this.tourControls=t,this.reelEntry=n,this.index=o,this.tourMode=a,this.locale=r,this.onSelect=async()=>{super.onSelect(),await this.tourControls.tourGoTo(this.index),this.tourMode===g.cR.STORIES?this.toursDataModule.forceShowStoryText():this.toursDataModule.toggleReel(!0)},this.id=this.reelEntry.id,this.title=this.reelEntry.title||"",this.description=this.reelEntry.description||"",this.icon="icon-toolbar-hlr",this.typeId=c.jM.HIGHLIGHTREEL,this.floorId="",this.roomId="",this.dateBucket=(0,x.n)(this.reelEntry.snapshot.created),a===g.cR.STORIES){const e=!!n.title,t=!!n.snapshot.name;this.title=e&&t?n.snapshot.name+" - "+n.title:e||t?n.title?n.title:n.snapshot.name:this.getDefaultName()}else this.title=n.snapshot.name?n.snapshot.name:this.getDefaultName(),this.description="";this.imgUrl=this.reelEntry.snapshot.thumbnailUrl}supportsBatchDelete(){return!1}getDefaultName(){return this.locale.t(L.SEARCH_HIGHLIGHT_DEFAULTNAME)+" "+(this.index+1)}}const{HLR:R}=C.A.WORKSHOP;var O=i(20968),V=i(93327),F=i(37e3);const B=new I.Vy("mds-highlight-reel-serializer");class N{constructor(e,t){this.defaultTourMode=e,this.reelEntrySerializer=new F.W(t)}deserialize(e){if(!e||!this.validate(e))return B.debug("Deserialized invalid active reel data from MDS",e),null;const t=new S.P(e.mode||this.defaultTourMode);if(t.sid=e.id,e.reel)for(const i of e.reel){if(!i)continue;const e=this.reelEntrySerializer.deserialize(i);e&&t.reel.push(e)}return t}validate(e){return["id"].every((t=>t in e))}}var k=i(15506);class H{serialize(e){const t={id:e.id,source:e.source};return e.sourceViewId&&(t.sourceViewId=e.sourceViewId),e.title&&(t.title=e.title),e.description&&(t.description=e.description),e.overrides&&(t.overrides={},void 0!==e.overrides.transitionType&&(t.overrides.transitionType=k.Ux[e.overrides.transitionType]),void 0!==e.overrides.panDirection&&(t.overrides.panDirection=k.vr[e.overrides.panDirection]),void 0!==e.overrides.panAngle&&(t.overrides.panAngle=e.overrides.panAngle),void 0!==e.overrides.panAlignment&&(t.overrides.panAlignment=k.np[e.overrides.panAlignment]),!0===e.overrides.showRoomMeasurements&&(t.overrides.tourShowRoomMeasurements=!0)),t}}const G=new I.Vy("mds-highlight-reel-store");class _ extends O.g{constructor(e,t,i,s){super(e),this.getViewId=i,this.getBaseViewId=s,this.serializer=new H,this.prefetchKey="data.model.activeHighlightReel",this.sweepTagRequirements=null,this.sweepTagRequirements=e.readonly?"showcase":null,this.deserializer=new N(t,this.sweepTagRequirements)}async read(e={}){var t;const i={modelId:null!==(t=null==e?void 0:e.modelId)&&void 0!==t?t:this.getViewId(),prefetchKey:this.prefetchKey};return this.query(V.GetHighlightReel,i,e).then((e=>{var t,i;const s=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.activeHighlightReel;return this.deserializer.deserialize(s)}))}async update(e){const t=this.getViewId(),i=e.reel.map((e=>this.serializer.serialize(e))),s=e.mode;return this.mutate(V.PutActiveReel,{modelId:t,elements:i,mode:s}).then((async e=>{G.debug(e)}))}async fetchAllTourSweeps(){var e,t;const i={modelId:this.getBaseViewId()},s=null===(t=null===(e=(await this.query(V.GetHighlightReelSweeps,i,{fetchPolicy:"no-cache"})).data)||void 0===e?void 0:e.model)||void 0===t?void 0:t.views,n=[];return s&&s.forEach((e=>{var t,i;const s=null===(i=null===(t=e.model)||void 0===t?void 0:t.activeHighlightReel)||void 0===i?void 0:i.reel;s&&s.forEach((e=>{var t,i,s,o,a,r,h;const l=e.sourceView.id,d=null===(s=null===(i=null===(t=e.asset)||void 0===t?void 0:t.snapshotLocation)||void 0===i?void 0:i.anchor)||void 0===s?void 0:s.id,c=null!==(h=null===(r=null===(a=null===(o=e.asset)||void 0===o?void 0:o.snapshotLocation)||void 0===a?void 0:a.anchor)||void 0===r?void 0:r.tags)&&void 0!==h?h:[],u=!this.sweepTagRequirements||c.includes(this.sweepTagRequirements);d&&u&&n.push({viewId:l,sweepId:d})}))})),n}}var U=i(81530);class W extends o.n{constructor(){super(...arguments),this.name="tours-data",this.autoSave=!0,this.defaultModes=[y.N.Panorama,y.N.Outdoor],this.fetchAllTourSweeps=async()=>{const e=await this.store.fetchAllTourSweeps();return this.viewData.setSweepsInToursAcrossViews(e),e},this.query=async e=>this.store.read(e),this.updateTourMode=()=>{this.viewData.currentTourMode=this.getCurrentTourMode(),this.viewData.setTourModeSetting(this.getTourModeSetting()),this.viewData.commit()},this.closeReelIfEmpty=()=>{0===this.tourData.getHighlightsCount()&&this.viewData.reelOpen&&this.toggleReel(!1)},this.setTourMode=e=>{e===g.cR.STORIES?this.tourData.setActiveReelTourMode(c.UR.STORY):e===g.cR.LEGACY&&this.tourData.setActiveReelTourMode(c.UR.REEL),this.updateTourMode()},this.setHighlightReel=e=>{this.tourData.setHighlightReel(e),this.updateTourMode();const{sweepDataModule:t,layersData:i}=this,s=new Map;if(this.tourData.getTourSweeps().forEach((e=>{var i,n;const o=null!==(i=e.sourceViewId)&&void 0!==i?i:null,a=t.getSweepOnView(e.sweepId,o);if(!a||a&&a.sourceViewId!==o){const t=null!==(n=s.get(o))&&void 0!==n?n:new Set;t.add(e.sweepId),s.set(o,t)}})),s.size>0){I.Vy.for(this).debugWarn("Tour requires additional scans",s);for(const[e,n]of s.entries()){const s=null!=e?e:i.getBaseModelId();t.query({modelId:s,sweepIds:[...n.values()]}).then((e=>{t.addSweeps(s,e)}))}}},this.forceShowStoryText=()=>{this.engine.broadcast(new E.lz)}}async init(e,t){const{readonly:i,baseUrl:o,storyToursFeature:f}=e;this.engine=t,this.config=e;const[v,y,I,D,C]=await Promise.all([t.market.waitForData(d.o),t.market.waitForData(m.P),t.market.waitForData(a.zH),t.getModuleBySymbol(p.Wh),t.getModuleBySymbol(p.$q)]);this.settingsData=v,this.appData=I,this.layersData=y,this.sweepDataModule=D,this.splatsDataModule=C;const x=f?c.UR.STORY:c.UR.REEL,A=new S.P(x);if(this.tourData=new s.R(A,(()=>this.getFilterModes(this.defaultModes.slice())),e.looping),this.viewData=new n.F(this.tourData,this.getTourModeSetting(),this.getCurrentTourMode()),!1===i){const e=await t.getModuleBySymbol(p.T9);this.monitor=new r.V(this.tourData.getReel(),{aggregationType:h.D.NextFrame},t),this.monitor.onChanged((()=>{this.autoSave&&this.monitor.hasDiffRecord()&&this.engine.commandBinder.issueCommand(new U.F({dataTypes:[l.p.HIGHLIGHTS]}))})),this.bindings.push(e.onSave((()=>this.save()),{dataType:l.p.HIGHLIGHTS}),e.onSave((()=>this.fetchAllTourSweeps()),{dataType:l.p.SWEEPS}),this.tourData.getReel().reel.onElementChanged({onAdded:e=>t.msgBus.broadcast(new E.Ce(e)),onRemoved:e=>t.msgBus.broadcast(new E.gm(e))})),this.bindings.push(this.settingsData.onSettingChanged(u.Q$.TourButtons,this.updateTourMode),this.settingsData.onSettingChanged(u.Q$.HighlightReel,this.updateTourMode)),this.toggleAutoSave(!0)}const L=()=>this.tourData.updateEnabledStops(this.getFilterModes(this.defaultModes.slice()));this.bindings.push(this.appData.onChanged((()=>L())),this.settingsData.onSettingChanged(u.Q$.Dollhouse,(()=>L())),this.settingsData.onSettingChanged(u.Q$.FloorPlan,(()=>L()))),this.tourData.tourViewId=e.defurnishToursFeature&&y.getCurrentView().isDefurnishView()?y.getBaseModelId():y.currentViewId,this.bindings.push(y.onPropertyChanged("currentViewId",(t=>{var i;t===this.tourData.tourViewId||e.defurnishToursFeature&&t===(null===(i=y.getDefurnishView())||void 0===i?void 0:i.id)||(this.tourData.tourViewId=t,this.tourData.commit(),O())}))),this.store=new _({context:y.mdsContext,readonly:i,baseUrl:o},x,(()=>this.tourData.tourViewId),(()=>y.getBaseModelId()));const O=async()=>{const e=await this.store.refresh();this.tourData.atomic((()=>{var t;this.setHighlightReel(e||new S.P(this.tourData.getActiveReelTourMode())),null===(t=this.monitor)||void 0===t||t.clearDiffRecord()})),this.updateTourMode(),this.closeReelIfEmpty()};await O(),async function(e,t,i,s){const n=await e.market.waitForData(a.zH),o=await e.getModuleBySymbol(p.gS),r=await e.getModuleBySymbol(p.Xf),h=(n,a,h,l=[])=>{const d=[],c=t.getCurrentTourState().highlights,u=i.currentTourMode;if(l.length>0||u===g.cR.NONE)return d;const p=u===g.cR.STORIES;let m=0;return c.forEach((t=>{const i=t.title&&p?t.title:o.t(R.SEARCH_HIGHLIGHT_DEFAULTNAME)+" "+(m+1);if(n(i)||t.snapshot.name&&n(t.snapshot.name)||p&&t.description&&n(t.description)){const i=new P(s,r,e.commandBinder,a,t,m,u,o);d.push(i)}m++})),d},l=e=>new M.P(t.onChanged(e),i.onTourModeSettingChanged(e)),d=()=>{e.commandBinder.issueCommandWhenBound(new T.Oc({id:c.jM.HIGHLIGHTREEL,groupPhraseKey:R.SEARCH_TOUR_HEADER,getSimpleMatches:h,registerChangeObserver:l,groupOrder:10,groupIcon:"toolbar-hlr",batchSupported:!1}))},u=()=>{e.commandBinder.issueCommandWhenBound(new T.tf(c.jM.HIGHLIGHTREEL))},m={renew:d,cancel:u},f=e=>{u(),d()},v=n.onPropertyChanged("application",f);f(n.application),new M.P(m,v)}(t,this.tourData,this.viewData,this),t.market.register(s.R,this.tourData),i?t.market.register(n.F,this.viewData):this.fetchAllTourSweeps().then((()=>{t.market.register(n.F,this.viewData)})),t.msgBus.broadcast(new b.sb(w.D.Tours))}dispose(e){this.store.dispose(),super.dispose(e)}async getPhotosForTour(){var e;const[t,i]=await Promise.all([this.engine.market.waitForData(D.O),this.engine.market.waitForData(m.P)]),s=null===(e=i.getDefurnishView())||void 0===e?void 0:e.id,n=this.tourData.getEnabledSnapshots().map((e=>e.sid)),o=[];for(const e in t.collection){const i=t.collection[e];"tour"!==i.category&&"panorama"!==i.category&&o.push({name:i.name,sid:i.sid,thumbnailUrl:await i.thumbnailUrl.get(),created:i.created,sourceViewId:i.sourceViewId,inReel:n.includes(i.sid),isDefurnish:void 0!==i.sourceViewId&&i.sourceViewId===s})}return o.sort(((e,t)=>{let i=0,s=0;return e.isDefurnish!==t.isDefurnish?(i+=e.isDefurnish?1:-10,s+=t.isDefurnish?1:-10):e.inReel!==t.inReel?(i+=e.inReel?1:-5,s+=t.inReel?1:-5):(i+=t.created.getTime()-e.created.getTime(),s+=e.created.getTime()-t.created.getTime()),i-s}))}async save(){if(!this.monitor||this.config.readonly)return void I.Vy.for(this).warn("Tour changes will NOT be saved");const e=this.tourData.getReel();await this.store.update(e),this.fetchAllTourSweeps(),this.monitor.clearDiffRecord()}getCurrentTourMode(){return(0,f.v)(this.settingsData,this.tourData.getActiveReelTourMode())}getTourModeSetting(){return(0,f.EI)(this.settingsData,this.tourData.getActiveReelTourMode())}toggleReel(e){e?this.engine.broadcast(new E.Yg):this.engine.broadcast(new E.e0),this.viewData.reelOpen=e,this.viewData.commit()}getFilterModes(e){const t=this.appData.application===a.lg.WORKSHOP;return(t||this.settingsData.tryGetSetting(v.n9,!1))&&e.push(y.N.Dollhouse),(t||this.settingsData.tryGetSetting(v._z,!1))&&e.push(y.N.Floorplan),this.splatsDataModule.hasSplats()&&e.push(y.N.ExteriorSplat),e}toggleAutoSave(e){this.config.readonly||(this.autoSave=e)}get hasTour(){return this.tourData.getHighlightsCount()>0}}},37e3:(e,t,i)=>{"use strict";i.d(t,{W:()=>c});var s=i(9139),n=i(25481),o=i(44094),a=i(95234),r=i(57186),h=i(93877),l=i(15506);const d=new s.Vy("mds-reel-element-serializer");class c{constructor(e){this.sweepTagRequirements=e,this.assetDeserializer=new a.S,this.viewDeserailizer=new r.K}deserialize(e){var t;if(!e||!(null===(t=null==e?void 0:e.asset)||void 0===t?void 0:t.id))return d.debug("Deserialized invalid highlight reel entry from MDS",e),null;const i=e.overrides,s={},a=(null==i?void 0:i.transitionType)?l.zc[null==i?void 0:i.transitionType]:void 0,r=(null==i?void 0:i.panDirection)?l.nl[null==i?void 0:i.panDirection]:void 0,c=null==i?void 0:i.panAngle,u=null==i?void 0:i.panAlignment,p=null==i?void 0:i.tourShowRoomMeasurements;(0,o.sw)(a)&&(s.transitionType=a),(0,o.sw)(r)&&(s.panDirection=r),(0,n.Et)(c)&&(s.panAngle=c),(0,o.sw)(u)&&(s.panAlignment=l.j7[u]),!0===p&&(s.showRoomMeasurements=p);const m=this.assetDeserializer.deserialize(e.asset),g=null==m?void 0:m.metadata.scanTags,f=!this.sweepTagRequirements||!g||g.includes(this.sweepTagRequirements);if(!m||!f)return null;let v;const y=this.viewDeserailizer.getModelViewType(e.sourceView);y!==h.jK.DEFURNISH&&y!==h.jK.DIGIPRO_SESSION||(v=e.sourceView.id),m.sourceViewId=v;const b={id:e.asset.id,overrides:s,snapshot:m,sourceViewId:v,source:e.source};return e.title&&(b.title=e.title),e.description&&(b.description=e.description),b}}},76518:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>m});var s=i(64882),n=i(63958),o=i(90082),a=i(9139),r=i(27200),h=i(71687),l=i(22937);class d{constructor(){this._dateNow=Date.now,this._performanceNow=performance.now,this.nowOverride=0}slowTime(e){this.fps=e,this.nowOverride=Date.now(),Date.now=()=>this.nowOverride,performance.now=()=>this.nowOverride}tick(){this.nowOverride+=1e3/this.fps}resetTime(){Date.now=this._dateNow,performance.now=this._performanceNow}}var c,u=i(97573);!function(e){e[e.STOPPED=0]="STOPPED",e[e.RECORDING=1]="RECORDING"}(c||(c={}));var p=i(90457);class m extends s.n{constructor(){super(...arguments),this.name="video-recorder-module",this.state=c.STOPPED,this.frostMage=new d}get currentState(){return this.state}async init(e,t){this.settingsModule=await t.getModuleBySymbol(o.ZF),this.canvasModule=await t.getModuleBySymbol(h.CE),this.tourControls=await t.getModuleBySymbol(h.Xf),this.engine=t,this.engine.diContainer.bindConstant("$FrostMage",this.frostMage),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download 1080p @ 60",(()=>{this.state===c.STOPPED&&this.record(1920,1080,60)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download 720p @ 30",(()=>{this.state===c.STOPPED&&this.record(1280,720,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download instagram",(()=>{this.state===c.STOPPED&&this.record(1080,1080,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download instagram story",(()=>{this.state===c.STOPPED&&this.record(1080,1920,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Stop & download current",(()=>{this.state===c.RECORDING&&this.stop()}))}async record(e,t,s){if(this.state!==c.STOPPED)return void a.Vy.for(this).warn("Can't start recording... we're already recording!");a.Vy.for(this).info("Starting recording of tour. Now is a good time to get a coffee :)"),this.state=c.RECORDING;const o=await Promise.all([i.e(8287),i.e(7504),i.e(6780)]).then(i.bind(i,34649));this.encoder=new o.WebMWriter({quality:.95,frameRate:s}),this.frostMage.slowTime(s),await this.canvasModule.resizeCanvas([{property:p.ResizeProperty.width,setDimension:e,duration:0},{property:p.ResizeProperty.height,setDimension:t,duration:0}]),this.tourControls.startTour();const r=this.engine.subscribe(l.pT,(()=>{r.cancel(),this.state===c.RECORDING&&this.stop()})),h=this,d=this.canvasModule.element;this.engine.startGenerator((function*(){for(;h.state===c.RECORDING;)h.encoder.addFrame(d),yield new n.oN,h.frostMage.tick(),yield new n.oN}))}async stop(){if(this.state!==c.RECORDING)return void a.Vy.for(this).warn("Can't stop recording, we weren't recording at all");this.frostMage.resetTime(),this.state=c.STOPPED,await this.canvasModule.resizeCanvas((0,u.EH)(0)),a.Vy.for(this).info("Encoding tour to video...");const e=await this.encoder.complete();a.Vy.for(this).info("Tour encoded! Prompting user to download."),(0,r.x_)(e,"tour.webm")}}},48248:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>we});var s=i(68909),n=i(64882),o=i(62802),a=i(71687),r=i(53172),h=i(86866),l=i(81662),d=i(10459),c=i(5243),u=i(10574),p=i(76318),m=i(99583),g=i(46793),f=i(94790),v=i(19968);const y=new s.Vector3(0,-100,0),b=new s.Vector2(-2,-2),w=new s.Vector3(-1,-1,-1),I=new s.Vector3(1,1,1);class D{constructor(e){this.raycaster=e,this.currentRay=new s.Ray,this.origin=y,this.direction=new s.Vector3,this.pointerNdc=b,this.cameraCache={position:new s.Vector3,quaternion:new s.Quaternion,camera:void 0},this.cast=e=>{const t=this.currentRay,i=this.raycaster.cast(t.origin,t.direction,e).slice();return i.length&&(this.lastHit=i[0]),i},this.update3D=(e,t,i)=>{e instanceof s.Vector3&&this.origin.copy(e),t instanceof s.Vector3&&this.direction.copy(t),this.cameraCache.camera=i,this.currentRay.set(this.origin,this.direction)},this.updateNDCPosition=()=>{const e=this.lastHit;if(this.cameraCache.camera&&e&&e.point){const t=this.cameraCache.camera;this.cameraCache.position.setFromMatrixPosition(t.matrixWorld),this.cameraCache.quaternion.setFromRotationMatrix(t.matrixWorld);const i=(0,v.jn)(e.point,this.cameraCache.position,this.cameraCache.quaternion,t.projectionMatrix);i.clamp(w,I),this.pointerNdc.set(i.x,i.y)}},this.updatePointer=()=>{}}get pointerRay(){return this.currentRay}get ndcPosition(){return this.updateNDCPosition(),this.pointerNdc}}var S=i(7478);class E extends S.QB{}class M extends E{constructor(e){super(),this.trackedCamera=e}}class C extends E{}class T extends E{}var x,A=i(86721),L=i(41302),P=i(14868);!function(e){e[e.Mono=0]="Mono",e[e.Stereo=1]="Stereo",e[e.SixDof=2]="SixDof",e[e.__length=3]="__length"}(x||(x={}));const R={controllers:Object.freeze([0,1]),rotationDegrees:25};var O;!function(e){e[e.touchpadX=0]="touchpadX",e[e.touchpadY=1]="touchpadY",e[e.thumbstickX=2]="thumbstickX",e[e.thumbstickY=3]="thumbstickY"}(O||(O={}));var V=i(23987);const F={x:0,y:0,z:0,w:1};let B=0;class N extends L.Q{constructor(e,t,i,n,o=!1){super(),this.renderer=e,this.webglScene=t,this.cameraData=i,this.cameraModule=n,this.DEBUG=o,this.trackingStyle=x.Stereo,this.session=null,this.baseReferenceSpace=null,this.cameraRig=null,this.rotations={initialYawOffset:new s.Quaternion,yawOffset:new s.Quaternion,invYawOffset:new s.Quaternion,trackingOffset:new s.Quaternion},this.player={vrCameraRef:new s.Vector3,rigPos:new s.Vector3,offset:new s.Vector3,orientation:new s.Quaternion,leftEye:new s.Vector3,rightEye:new s.Vector3,centerEye:new s.Vector3,neckOffset1:new s.Vector3,neckOffset2:new s.Vector3,ipd:0,localHeightOffset:null},this.setTrackingStyle=(e,t=!0)=>{e<x.__length&&(this.trackingStyle=e,t&&this.resetInitialRotation())},this.offsetRotation=e=>{this.rotations.invYawOffset.multiply(e),this.rotations.yawOffset.copy(this.rotations.invYawOffset).invert()},this.resetPlayerYOffset=()=>{this.player.localHeightOffset=null},this.onPresentStart=(e,t)=>{if(e.cameras[0].layers.mask=P.H.ALL.mask,e.cameras[1].layers.mask=P.H.ALL.mask,e.cameras[0].far=e.far,e.cameras[1].far=e.far,e.layers.mask=P.H.ALL.mask,this.resetInitialRotation(),this.resetPlayerYOffset(),this.baseReferenceSpace=this.renderer.xr.getReferenceSpace(),this.baseReferenceSpace){const e=this.getReferenceSpace(t,this.webglScene.cameraRig,this.baseReferenceSpace);this.renderer.xr.setReferenceSpace(e)}this.broadcast(new C)},this.resetInitialRotation=()=>{const e=this.cameraData.pose.rotation.clone();(0,h.Vs)(e,this.rotations.initialYawOffset),this.rotations.yawOffset.copy(this.rotations.initialYawOffset),this.rotations.invYawOffset.copy(this.rotations.initialYawOffset).invert()},this.onPresentEnd=()=>{this.baseReferenceSpace=null,this.renderer.xr.setReferenceSpace(null),this.webglScene.cameraRig.reset(),this.broadcast(new T)},this.onUpdate=()=>{this.frame&&this.session&&this.baseReferenceSpace&&(this.cameraModule.updateCameraRotation(this.rotations.trackingOffset),this.webglScene.beforeRender(),this.cameraRig=this.webglScene.cameraRig)},this.applyTrackingOverrides=(e,t,i)=>{if(e.xr.isPresenting&&i instanceof s.ArrayCamera){e.clear();const t=e.xr.getCamera(),i=t.cameras[0],s=t.cameras[1];if(this.frame=this.renderer.xr.getFrame(),!this.session&&this.frame&&(this.session=e.xr.getSession(),this.onPresentStart(t,this.frame)),this.frame&&this.session&&this.baseReferenceSpace){if(this.rotations.trackingOffset.copy(this.rotations.yawOffset).multiply(t.quaternion),this.cameraRig){const e=this.getReferenceSpace(this.frame,this.cameraRig,this.baseReferenceSpace);this.renderer.xr.setReferenceSpace(e)}if(this.trackingStyle===x.Mono)s.matrixWorld.copy(i.matrixWorld),s.matrixWorldInverse.copy(s.matrixWorld),s.matrixWorldInverse.invert();this.broadcast(new M(t))}}else this.session&&(this.session=null,this.onPresentEnd())},this.getReferenceSpace=(e,t,i)=>{if(!t)return i;const s=this.renderer.xr.getCamera();this.player.rigPos.copy(t.position),this.player.vrCameraRef.copy(s.position),this.player.offset.copy(s.position).sub(t.position),this.DEBUG&&(V.Z.logValue("xr.tracking",x[this.trackingStyle]),V.Z.logVector3("xr.cameraRig.position",this.player.rigPos),V.Z.logVector3("xr.cameraVR",s.position),V.Z.logVector3("xr.cameraVR offset",this.player.offset));const n=e.getViewerPose(i),o=(null==n?void 0:n.views[0].transform.position)||F,a=(null==n?void 0:n.views[1].transform.position)||F,r=(null==n?void 0:n.views[0].transform.orientation)||F;this.player.leftEye.set(o.x,o.y,o.z),this.player.rightEye.set(a.x,a.y,a.z),this.player.orientation.set(r.x,r.y,r.z,r.w),this.player.ipd=this.player.leftEye.distanceTo(this.player.rightEye);const h=new DOMPointReadOnly((o.x+a.x)/2,(o.y+a.y)/2,(o.z+a.z)/2);this.player.centerEye.set(h.x,h.y,h.z),this.player.neckOffset1.copy(l.B1.BACK).applyQuaternion(this.player.orientation).multiplyScalar(this.player.ipd/2),this.player.neckOffset2.copy(l.B1.DOWN).applyQuaternion(this.player.orientation).multiplyScalar(this.player.ipd/2);const d=this.player.centerEye.add(this.player.neckOffset1).add(this.player.neckOffset2);this.DEBUG&&(V.Z.logVector3("xr.leftEye",this.player.leftEye),V.Z.logVector3("xr.rightEye",this.player.rightEye),V.Z.logVector3("xr.centerEye",h),V.Z.logVector3("xr.neckPivot",d),V.Z.logValue("xr.ipd",this.player.ipd));let c=F;switch(this.trackingStyle){case x.Mono:c=new DOMPointReadOnly(o.x,o.y,o.z);break;case x.Stereo:c=new DOMPointReadOnly(d.x,d.y,d.z);break;case x.SixDof:null===this.player.localHeightOffset&&(this.player.localHeightOffset=h.y,this.DEBUG&&V.Z.logValue(`xr.localHeightOffset${B}`,`${this.player.localHeightOffset}, ${(new Date).toLocaleString()}`),B=(B+1)%5),c=new DOMPointReadOnly(0,this.player.localHeightOffset,0)}const u=new XRRigidTransform({x:c.x-t.position.x,y:c.y-t.position.y,z:c.z-t.position.z,w:1}),p=i.getOffsetReferenceSpace(u),m=this.rotations.invYawOffset,g=this.cameraData.pose.position,f=new XRRigidTransform({x:g.x,y:g.y,z:g.z,w:1},{x:m.x,y:m.y,z:m.z,w:m.w});return p.getOffsetReferenceSpace(f)},this.webglScene.scene.onBeforeRender=this.applyTrackingOverrides}}var k=i(97994),H=i(95102),G=i(91994),_=i(29628),U=i(52026),W=i(63362),z=i(3956),j=i(12837),$=i(90834),X=i(22299),q=i(32024);const Y=i.p+"images/selected_sweep_glow.png";class Q{get container(){return this._container}constructor(e){this.meshQuery=e,this.active=!1,this.target=new k.L(null),this.previousSweep=null,this.activate=()=>{this.active||(this.updateLoopSub.renew(),this.selectionChangeSub.renew(),this.ray.toggle(!0),this.targetDecoration.toggle(!0),this.active=!0)},this.deactivate=()=>{this.active&&(this.target.value=null,this.selectionChangeSub.cancel(),this.updateLoopSub.cancel(),this.ray.toggle(!1),this.targetDecoration.toggle(!1),this.active=!1)},this.getTargetSweep=(e,t,i)=>{let s=null;if(t.object instanceof z.UJ)return s=e.getSweep(t.object.userData.sid),s;const n=(0,U.IV)({sweepData:e,direction:i});if(s=n.length>0?n[0].sweep:null,!s){const i=(0,U.I9)(e,!0,t.intersection,this.meshQuery);s=i.length>0?i[0].sweep:null}return s}}async init(e){this.engine=e,this._container=new s.Group,this._container.name="XRNavigationVisuals",this.ray=new K(this.container),this.targetDecoration=new Z(this.container);const t=await this.engine.market.waitForData(c.$),i=await this.engine.market.waitForData(X.J);return this.updateLoopSub=new o.P(t.onChanged((()=>this.update(t))),i.opacity.onChanged((()=>this.update(t)))),this.updateLoopSub.cancel(),this.selectionChangeSub=this.target.onChanged((e=>{null!==this.previousSweep&&this.engine.commandBinder.issueCommand(new W.WW(this.previousSweep.id,!1,200)),null!==e&&(this.engine.commandBinder.issueCommand(new W.WW(e.id,!0,200)),this.targetDecoration.updateTargetPosition(e.floorPosition)),this.previousSweep=e})),this.selectionChangeSub.cancel(),this}update(e){const t=this.engine.market.tryGetData(j.A),i=this.engine.market.tryGetData(d.M),s=this.engine.market.tryGetData(m.X),n=this.engine.market.tryGetData(X.J),o=this.engine.market.tryGetData($.O);if(!(t&&i&&s&&o&&n))return;if(!o.isVR())return;if(!s.isInside())return;const{hit:a,pointerDirection:r,pointerOrigin:h}=e;if(!a)return;const l=this.getTargetSweep(t,a,r);this.target.value=l,this.ray.update(h,a.point,n.opacity.value),this.targetDecoration.update(i.pose.rotation,n.opacity.value)}}class K{constructor(e){this.container=e,this.styles={ray:{color:"white",transparent:!0,opacity:.3,linewidth:2,depthWrite:!1},hit:{color:"white",transparent:!0,opacity:.3},hitScale:.02},this.update=(e,t,i)=>{this.ray.updatePositions(e,t).opacity(Math.min(i,this.styles.ray.opacity)),this.hitMarker.position.copy(t),this.hitMarker.material.opacity=Math.min(i,this.styles.hit.opacity)},this.toggle=e=>{e?(this.container.add(...this.ray.children),this.container.add(this.hitMarker)):(this.container.remove(...this.ray.children),this.container.remove(this.hitMarker))};const{ray:t,hit:i}=this.styles,n=(0,G.makeLineMaterial)(t.color,!1,t);this.ray=new _.e(new s.Vector3,new s.Vector3,n,{}),this.ray.updateResolution(window.innerWidth,window.innerHeight),this.hitMarker=new H.m(new s.SphereGeometry(this.styles.hitScale),new s.MeshBasicMaterial(i)),this.hitMarker.name="hit"}}class Z{constructor(e){this.container=e,this.styles={scale:.46,animationSpeed:1,plane:{color:"white",transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,map:(0,q.y)(Y)}},this.position=new s.Vector3,this.quaternion=new s.Quaternion,this.updateTargetPosition=e=>{this.position.copy((0,h.$i)(e,l.B1.UP,.05))},this.update=(e,t)=>{const i=(0,h.Vs)(e,this.quaternion);this.target.quaternion.copy(i),this.target.position.lerp(this.position,this.styles.animationSpeed),this.target.material.opacity=Math.min(t,this.styles.plane.opacity)},this.toggle=e=>{e?this.container.add(this.target):this.container.remove(this.target)};const t=new s.PlaneGeometry(1),i=new s.Matrix4;i.makeRotationFromEuler(new s.Euler(-Math.PI/2,0,0,"XYZ")),t.applyMatrix4(i),this.target=new H.m(t,new s.MeshBasicMaterial(this.styles.plane)),this.target.name="Destination",this.target.scale.set(this.styles.scale,this.styles.scale,this.styles.scale)}}class J{constructor(e){this.controllers=e,this._lastInputWas=-1}focus(e){e!==this._lastInputWas&&(R.controllers.forEach((t=>{const i=this.controllers.controller(t);i.grip.visible=t===e,i.hand.visible=t===e,i.handPointer&&(i.handPointer.visible=t===e)})),this._lastInputWas=e)}}var ee=i(53282),te=i(58574),ie=i(30386),se=i(50308);class ne{constructor(e,t){this.renderer=e,this.options=t,this._defaultController=0,this.controllerGroups=[],this.bindings=[],this.cancel=()=>{this.bindings.forEach((e=>e.cancel())),this.bindings.length=0},this.container=new s.Group,this.container.name="XRControllerMesh",R.controllers.forEach((e=>{const t=this.createControllerGroup(e);this.controllerGroups.push(t),this.container.add(t.grip,t.pointer,t.hand)})),this.container.matrixAutoUpdate=!1}controller(e=this._defaultController){return this.controllerGroups[e]}setDefault(e){this._defaultController=e}createControllerGroup(e){const t=this.renderer.xr.getController(e);t.name=`Controller Ray ${e}`;const i=this.renderer.xr.getControllerGrip(e);i.name=`Controller Grip ${e}`,i.visible=!1;const s=(new ie.XRControllerModelFactory).createControllerModel(i);i.add(s);const n=this.renderer.xr.getHand(e);let o;if(this.options.supportHands){o=new te.OculusHandPointerModel(n,t),o.name=`hand pointer ${e}`,n.add(o);const i=(new se.XRHandModelFactory).createHandModel(n,"spheres");n.add(i)}n.visible=!1;const a={index:e,pointer:t,grip:i,connected:!1,handedness:"none",hand:n,handPointer:o,handSource:void 0},r=e=>{a.handedness=e.data.handedness,a.connected=!0,e.data.hand&&(a.handSource=e.data.hand,null==o||o.setAttached(!0))},h=()=>{a.handedness="none",a.connected=!1,a.handSource=void 0,null==o||o.setAttached(!1)};return this.bindings.push((0,ee.Sh)((()=>t.addEventListener("connected",r)),(()=>t.removeEventListener("connected",r))),(0,ee.Sh)((()=>t.addEventListener("disconnected",h)),(()=>t.removeEventListener("disconnected",h)))),this.options.supportHands&&this.bindings.push((0,ee.Sh)((()=>n.addEventListener("connected",r)),(()=>n.removeEventListener("connected",r))),(0,ee.Sh)((()=>n.addEventListener("disconnected",h)),(()=>n.removeEventListener("disconnected",h)))),a}}var oe=i(9139);const ae=new oe.Vy("xr-input-forwarding");class re{constructor(e){this.options=e,this.dispatchPointerDown=e=>{this.forwardEvent("pointerdown",this.mockPointerEventInit(e))},this.dispatchPointerUp=e=>{this.forwardEvent("pointerup",this.mockPointerEventInit(e))},this.target=e.forwardToElement}dispatchPointerMove(e){this.forwardEvent("pointermove",this.mockPointerEventInit(e))}mockPointerEventInit(e){let t=0,i=0;if(this.options.getPointerScreenPosition){const e=this.options.getPointerScreenPosition();t=e.x,i=e.y}return{pointerType:"gamepad",pointerId:e,clientX:t,clientY:i}}forwardEvent(e,t){let i;try{i=window.PointerEvent?new PointerEvent(e,t):new MouseEvent(e,t),i&&this.target.dispatchEvent(i)}catch(e){ae.error(e)}}}const he=["pinchstart","pinchend"],le=["selectstart","select","selectend","squeeze","squeezestart","squeezeend"];class de extends s.EventDispatcher{constructor(e,t){super(),this.renderer=e,this.options={forwardNativeXrEvents:!0,axisMoveTriggerThreshold:.5,supportHands:!1,ignoreTransientPointer:!0},this.previousGamepad=new Map,this.active=!1,this.renew=()=>{!this.active&&this.options.forwardNativeXrEvents&&(this.addSessionListeners(),this.active=!0)},this.cancel=()=>{this.active&&this.options.forwardNativeXrEvents&&(this.removeSessionListeners(),this.active=!1)},this.updateFromGamepads=()=>{if(!this.active)return;const e=this.renderer.xr.getSession();if(!e)return;let t=0;for(const i of e.inputSources){if(!i||!i.gamepad)continue;if(this.options.ignoreTransientPointer&&"transient-pointer"===i.targetRayMode)continue;const e=this.renderer.xr.getController(t),s=this.previousGamepad.get(i),n={buttons:i.gamepad.buttons.map((e=>e.value)),axes:new Float32Array(i.gamepad.axes.slice())},o={controllerIndex:t,inputSource:i,axes:n.axes};n.buttons.forEach(((t,i)=>{(null==s?void 0:s.buttons)&&t!==s.buttons[i]&&(1===t?this.sendGamepadEvent(e,Object.assign(Object.assign({},o),{type:"buttondown",value:t,index:i,target:e})):0===t&&this.sendGamepadEvent(e,Object.assign(Object.assign({},o),{type:"buttonup",value:t,index:i,target:e})))})),n.axes.forEach(((t,i)=>{var n;const a=null!==(n=null==s?void 0:s.axes[i])&&void 0!==n?n:0;if(t!==a){this.sendGamepadEvent(e,Object.assign(Object.assign({},o),{type:"axesmove",value:t,index:i,target:e})),0===a&&this.sendGamepadEvent(e,Object.assign(Object.assign({},o),{type:"axesmovestart",value:t,index:i,target:e}));const s=this.options.axisMoveTriggerThreshold;Math.abs(a)<s&&Math.abs(t)>s&&this.sendGamepadEvent(e,Object.assign(Object.assign({},o),{type:"axestriggered",value:t,index:i,target:e})),0===t&&this.sendGamepadEvent(e,Object.assign(Object.assign({},o),{type:"axesmoveend",value:t,index:i,target:e}))}})),this.previousGamepad.set(i,n),t++}},this.onGamepadEvent=(e,t)=>(0,ee.Sh)((()=>super.addEventListener(e,t)),(()=>super.removeEventListener(e,t))),this.onSessionEvent=(e,t)=>(0,ee.Sh)((()=>super.addEventListener(e,t)),(()=>super.removeEventListener(e,t))),this.sendGamepadEvent=(e,t)=>{this.dispatchEvent(t)},this.sendSessionEvent=(e,t,i)=>{this.dispatchEvent({type:e,controllerIndex:t,data:i})},this.addSessionListeners=()=>{R.controllers.forEach((e=>{const t=this.renderer.xr.getController(e);for(const i of le)t.addEventListener(i,(t=>this.sendSessionEvent(t.type,e,t.data)));if(this.options.supportHands){const t=this.renderer.xr.getHand(e);for(const i of he)t.addEventListener(i,(t=>this.sendSessionEvent(t.type,e,void 0)))}}))},this.removeSessionListeners=()=>{R.controllers.forEach((e=>{const t=this.renderer.xr.getController(e);for(const i of le)t.removeEventListener(i,(t=>this.sendSessionEvent(t.type,e,t)));if(this.options.supportHands){const t=this.renderer.xr.getHand(e);for(const i of he)t.removeEventListener(i,(t=>this.sendSessionEvent(t.type,e,t)))}}))},t&&(this.options=Object.assign(Object.assign({},this.options),t)),this.renew()}}var ce=i(4896),ue=i(21320),pe=i(27200);var me=i(49953),ge=i(78671),fe=i(47004);const ve=(new s.Quaternion).setFromAxisAngle(l.B1.UP,r.fy*R.rotationDegrees),ye=(new s.Quaternion).setFromAxisAngle(l.B1.UP,r.fy*-R.rotationDegrees);class be extends n.n{constructor(){super(...arguments),this.name="webxr",this.framebufferScaledTo=1,this.framebufferScale=0,this.ray={forward:new s.Vector3,origin:new s.Vector3},this.onXrPresentBegin=()=>{if(this.renderer.xr.getSession()){if(this.engine.commandBinder.issueCommand(new u.V(p.MF.HIGH)),!this.viewmodeData.isInside()||this.config.xrMesh){let e=g.w5.INSIDE;this.config.xrMesh&&(this.trackingOverrides.setTrackingStyle(x.SixDof,!1),e=g.w5.MESH),this.engine.commandBinder.issueCommand(new g.S2(e))}this.inputModule.overrideDragThreshold(.15),this.xrPointer=new D(this.raycaster.picking),this.raycaster.setOverridePointer(this.xrPointer),this.xrNavVisuals.activate()}},this.onXrPresentEnd=()=>{this.engine.commandBinder.issueCommand(new u.V(null)),this.inputModule.overrideDragThreshold(null),this.xrNavVisuals.deactivate(),this.raycaster.setOverridePointer(null),this.cameraModule.getCameraControllerForViewport().updateCameraRotation((0,h.Vs)(this.cameraData.pose.rotation,new s.Quaternion)),this.webglScene.setCameraDirty()},this.onXrTrackingApplied=e=>{const t=this.controllerMesh.controller();if(t.connected){let i=this.ray.origin.setFromMatrixPosition(t.grip.matrixWorld),s=this.ray.forward.copy(l.B1.FORWARD).applyQuaternion(t.pointer.quaternion);const{hand:n,handPointer:o}=t;n&&o&&o.isAttached()&&(o.updateMatrixWorld(),i=o.raycaster.ray.origin,s=o.raycaster.ray.direction),this.xrPointer.update3D(i,s,e.trackedCamera),this.xrPointerInput.dispatchPointerMove(t.index)}this.xrGamepadInput.updateFromGamepads()},this.tryEndSession=async()=>{var e;await(null===(e=this.activeXrSession)||void 0===e?void 0:e.end()),this.activeXrSession=void 0},this.requestSession=async(e,t)=>{var i;if(await(0,ce.M1)(this.config.xrBrowsersUnlocked)!==ce.wc.webxr)return null;if(this.renderer.xr.isPresenting)return this.renderer.xr.getSession();if(ue.A.apiExists()){this.config.xrHandTracking&&!t.includes("hand-tracking")&&t.push("hand-tracking");const s=await(null===(i=navigator.xr)||void 0===i?void 0:i.requestSession(e,{optionalFeatures:t}));if(!s)return null;this.activeXrSession=s;const n=XRWebGLLayer.getNativeFramebufferScaleFactor(s);return this.framebufferScaledTo=this.framebufferScale*(n-1)+1,oe.Vy.for(this).info("Scaling framebuffer by:",this.framebufferScaledTo,"native size:",n," * factor:",this.framebufferScale),0!==this.framebufferScale&&this.renderer.xr.setFramebufferScaleFactor(this.framebufferScaledTo),this.renderer.xr.setSession(s),s}return null}}async init(e,t){this.config=e,this.engine=t;const[i,n]=await Promise.all([t.getModuleBySymbol(a.M7),t.getModuleBySymbol(a.PM)]);this.renderer=i.threeRenderer,this.webglScene=i.getScene(),this.bindings.push(t.commandBinder.addBinding(A.X,(e=>this.requestSession(e.type,e.features))),t.commandBinder.addBinding(A.P,(()=>this.tryEndSession())));if(await(0,ce.M1)(e.xrBrowsersUnlocked)!==ce.wc.webxr)return;[this.canvasModule,this.cameraModule,this.raycaster,this.inputModule]=await Promise.all([t.getModuleBySymbol(a.CE),t.getModuleBySymbol(a.jh),t.getModuleBySymbol(a.sA),t.getModuleBySymbol(a.mL)]),[this.cameraData,this.raycasterData,this.viewmodeData,this.policyData]=await Promise.all([t.market.waitForData(d.M),t.market.waitForData(c.$),t.market.waitForData(m.X),t.market.waitForData(me.L)]),this.renderer.xr.setReferenceSpaceType("local"),this.framebufferScale=this.config.framebufferScaling||function(e){const t=(0,pe.Fr)();return!t||t&&function(e){return/Adreno \(TM\) (540|[6-9]\d\d)/.test(e.renderer)}(e)?1:0}(i.gpuInfo);const r=new N(this.renderer,this.webglScene,this.cameraData,this.cameraModule.getCameraControllerForViewport(),e.xrDebug);let h=x.Mono;switch(e.webxr){case"stereo":h=x.Stereo;break;case"6dof":h=x.SixDof,this.config.xrMesh=!0;break;default:h=x.Mono}r.setTrackingStyle(h,!1),this.trackingOverrides=r,this.bindings.push(r.subscribe(C,this.onXrPresentBegin),r.subscribe(T,this.onXrPresentEnd),r.subscribe(M,this.onXrTrackingApplied),t.subscribe(fe.A,(e=>{e.toSweep!==e.fromSweep&&r.resetPlayerYOffset()}))),this.controllerMesh=new ne(this.renderer,{supportHands:e.xrHandTracking}),this.webglScene.addChild(this.webglScene.ids.CameraRig,this.controllerMesh.container);const l=new J(this.controllerMesh);l.focus(0),this.controllerMesh.setDefault(0);this.xrPointerInput=new re({forwardToElement:this.canvasModule.element,getPointerScreenPosition:()=>this.raycasterData.pointerScreenPosition}),this.xrGamepadInput=new de(this.renderer,{supportHands:e.xrHandTracking});const u=e=>{const t=this.renderer.xr.getFrame(),i=this.renderer.xr.getReferenceSpace();if(t&&i&&"transient-pointer"===e.data.targetRayMode){const{targetRaySpace:n,gripSpace:o}=e.data;if(t&&i){const e=t.getPose(o,i),a=t.getPose(n,i);if(e&&a){const t=e.transform.position,i=(new s.Vector3).set(t.x,t.y,t.z),n=a.transform.orientation,o=(new s.Vector3).set(n.x,n.y,n.z);this.xrPointer.update3D(i,o,this.webglScene.cameraRig.camera)}}}},p=[this.xrGamepadInput.onGamepadEvent("axestriggered",(e=>{if(e.index===O.thumbstickX||e.index===O.touchpadX){oe.Vy.for(this).debug(`${e.inputSource.handedness} ${O[e.index]} axis.value over threshold, do the rotate!`);Math.sign(e.value)>0?r.offsetRotation(ve):r.offsetRotation(ye)}l.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("selectstart",(e=>{u(e),this.xrPointerInput.dispatchPointerDown(e.controllerIndex),l.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("selectend",(e=>{u(e),this.xrPointerInput.dispatchPointerUp(e.controllerIndex),l.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("squeezestart",(e=>{l.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)}))];this.config.xrHandTracking&&p.push(this.xrGamepadInput.onSessionEvent("pinchstart",(e=>{this.xrPointerInput.dispatchPointerDown(e.controllerIndex),l.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("pinchend",(e=>{this.xrPointerInput.dispatchPointerUp(e.controllerIndex)}))),this.policyData.hasPolicy(ge.I)&&p.push(this.xrGamepadInput.onGamepadEvent("buttondown",(e=>{4===e.index?(h=(h+1)%x.__length,r.setTrackingStyle(h,!1)):5===e.index&&(h=(x.__length+h-1)%x.__length,r.setTrackingStyle(h,!1)),l.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)}))),p.push(this.inputModule.registerUnfilteredHandler(f.Ve,(e=>{if(this.activeXrSession&&Math.abs(e.fullDelta.x)>Math.abs(e.fullDelta.y)&&Math.abs(e.fullDelta.x)>.25){const t=Math.sign(e.fullDelta.x);t<0?r.offsetRotation(ve):t>0&&r.offsetRotation(ye)}})));const g=new o.P(...p);this.bindings.push(g,this.xrGamepadInput),this.xrNavVisuals=new Q(n),this.xrNavVisuals.init(t),this.webglScene.add(this.xrNavVisuals.container)}onUpdate(e){this.activeXrSession&&this.trackingOverrides.onUpdate()}}const we=be},95102:(e,t,i)=>{"use strict";i.d(t,{m:()=>n});var s=i(68909);class n extends s.Mesh{constructor(e,t){super(e,t)}}},17709:e=>{e.exports="precision highp float;uniform float aaPaddingPx;uniform vec3 color;uniform float globalOpacity;varying vec2 vOffsetPx;uniform float outline;uniform vec3 outlineColor;varying vec2 scaledWidthHeightPx;varying float vOpacity;float sdTriangle(vec2 p,vec2 p0,vec2 p1,vec2 p2){vec2 e0=p1-p0;vec2 e1=p2-p1;vec2 e2=p0-p2;vec2 v0=p-p0;vec2 v1=p-p1;vec2 v2=p-p2;vec2 pq0=v0-e0*clamp(dot(v0,e0)/dot(e0,e0),0.,1.);vec2 pq1=v1-e1*clamp(dot(v1,e1)/dot(e1,e1),0.,1.);vec2 pq2=v2-e2*clamp(dot(v2,e2)/dot(e2,e2),0.,1.);float s=e0.x*e2.y-e0.y*e2.x;vec2 d=min(min(vec2(dot(pq0,pq0),s*(v0.x*e0.y-v0.y*e0.x)),vec2(dot(pq1,pq1),s*(v1.x*e1.y-v1.y*e1.x))),vec2(dot(pq2,pq2),s*(v2.x*e2.y-v2.y*e2.x)));return-sqrt(d.x)*sign(d.y);}void main(){float padding=aaPaddingPx+outline;float halfWidth=scaledWidthHeightPx.x/2.;vec2 p0=vec2(-halfWidth,scaledWidthHeightPx.y+padding);vec2 p1=vec2(halfWidth,scaledWidthHeightPx.y+padding);vec2 p2=vec2(0.,padding);float sd=sdTriangle(vOffsetPx,p0,p1,p2);float aaOpacity=1.-smoothstep(outline,outline+0.5,sd);float colorMix=smoothstep(0.,outline,sd);vec3 colorWithOutline=mix(color,outlineColor,colorMix);gl_FragColor=linearToOutputTexel(vec4(colorWithOutline,aaOpacity*globalOpacity*vOpacity));}"},69555:e=>{e.exports="precision highp float;uniform vec2 screenSize;vec2 rotate90(vec2 v){return vec2(-v.y,v.x);}vec2 ndcToScreen(vec4 pt){return(vec2(pt.x,pt.y)+vec2(1.,1.))*screenSize/2.;}vec2 screenToNdc(vec2 pt){return(pt*2./screenSize)-vec2(1.,1.);}\n#define MIN_SCALE  0.4\n#define MIN_METERS_PER_PX  0.006\n#define MAX_METERS_PER_PX  0.012\nuniform float tipPaddingPx;uniform float widthPx;uniform float heightPx;uniform float aaPaddingPx;uniform float metersPerPx;uniform float outline;uniform float autoScale;attribute vec2 offset;attribute vec2 tip;attribute float height;attribute float opacity;attribute float visibility;varying vec2 vOffsetPx;varying vec2 scaledWidthHeightPx;varying float vOpacity;vec2 scaleByZoom(){float t=clamp((metersPerPx-MIN_METERS_PER_PX)/(MAX_METERS_PER_PX-MIN_METERS_PER_PX),0.,1.);float scale=1.;if(autoScale>0.){scale=mix(1.,MIN_SCALE,t);}return vec2(widthPx,heightPx)*scale;}void main(){if(visibility>0.){vec2 yAxis=normal.xy;vec2 xAxis=rotate90(yAxis);vec4 tipWorld=vec4(tip.x,height,tip.y,1.);vec4 xOffsetWorld=tipWorld+vec4(xAxis.x,0.,xAxis.y,0.);vec4 yOffsetWorld=tipWorld+vec4(yAxis.x,0.,yAxis.y,0.);vec4 ndcTip=projectionMatrix*modelViewMatrix*tipWorld;vec2 tipScreen=ndcToScreen(ndcTip/ndcTip.w);vec4 ndcXOffset=projectionMatrix*modelViewMatrix*xOffsetWorld;vec2 xOffsetScreen=ndcToScreen(ndcXOffset/ndcXOffset.w);vec4 ndcYOffset=projectionMatrix*modelViewMatrix*yOffsetWorld;vec2 yOffsetScreen=ndcToScreen(ndcYOffset/ndcYOffset.w);vec2 xAxisScreen=normalize(xOffsetScreen-tipScreen);vec2 yAxisScreen=normalize(yOffsetScreen-tipScreen);float padding=aaPaddingPx+outline;scaledWidthHeightPx=scaleByZoom();float halfWidth=scaledWidthHeightPx.x/2.+padding;float quadHeight=scaledWidthHeightPx.y+padding*2.;vec2 vertexScreen=(tipScreen+yAxisScreen*tipPaddingPx)+xAxisScreen*halfWidth*offset.x+yAxisScreen*quadHeight*offset.y;vec2 ndcVert=screenToNdc(vertexScreen);vOffsetPx=vec2(offset.x*halfWidth,offset.y*quadHeight);vOpacity=opacity;gl_Position=vec4(ndcVert*ndcTip.w,ndcTip.z,ndcTip.w);}else{gl_Position=vec4(-1000.,-1000.,-1000.,-1000.);}}"},4605:e=>{e.exports="precision highp float;uniform float opacity;uniform float centerSpacing;uniform float radius;uniform vec3 color;void main(){vec2 center=mod(gl_FragCoord.xy,vec2(centerSpacing))-vec2(centerSpacing*0.5);float polkaDot=1.-smoothstep(radius-(radius*0.2),radius,length(center));gl_FragColor=linearToOutputTexel(vec4(color,opacity*polkaDot));}"},66083:e=>{e.exports="precision highp float;void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},47876:e=>{e.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float globalOpacity;uniform float outlinePct;varying vec3 vOuterColor;varying vec3 vInnerColor;varying float vRadius;varying float vOpacity;varying vec3 vPosition;void main(){float fragRadius=length(vPosition.xz);float outlineRadius=vRadius*outlinePct;float smoothAmt=fwidth(fragRadius)*ANTIALIAS_WIDTH;float mixAmt=smoothstep(outlineRadius-smoothAmt,outlineRadius,fragRadius);gl_FragColor=linearToOutputTexel(vec4(mix(vInnerColor,vOuterColor,mixAmt),1.));gl_FragColor.a=globalOpacity*vOpacity*(1.-smoothstep(vRadius-smoothAmt,vRadius,fragRadius));}"},32686:e=>{e.exports="precision highp float;attribute vec3 centerPosition;attribute float radius;attribute float opacity;attribute vec3 innerColor;attribute vec3 outerColor;varying vec3 vPosition;varying float vRadius;varying float vOpacity;varying vec3 vInnerColor;varying vec3 vOuterColor;void main(){vPosition=position;vRadius=radius;vOpacity=opacity;vInnerColor=innerColor;vOuterColor=outerColor;vec3 worldPos=position+centerPosition;gl_Position=projectionMatrix*modelViewMatrix*vec4(worldPos,1.);}"},76539:e=>{e.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform vec3 color;uniform float maxDistance;varying vec3 vWorldPosition;vec4 normalizeDepth(float depth){float depthNormalized=clamp(depth/maxDistance,0.,1.);return vec4(depthNormalized,0.,0.,1.);}void main(){float distanceToCamera=distance(cameraPosition,vWorldPosition);gl_FragColor=normalizeDepth(distanceToCamera);}"},12201:e=>{e.exports="precision highp float;precision highp int;varying vec3 vWorldPosition;void main(){vWorldPosition=(modelMatrix*vec4(position,1.)).xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},1834:e=>{e.exports="precision highp float;uniform float globalOpacity;varying vec3 vBaseColor;varying float vNumLines;varying vec3 vPosition;float lineAround(float signedDist){const float halfWidth=0.1/2.;float aaWidth=fwidth(vPosition.z);float left=signedDist-halfWidth;float right=signedDist+halfWidth;float rise=smoothstep(left-aaWidth,left,vPosition.z);float drop=1.-smoothstep(right,right+aaWidth,vPosition.z);return min(rise,drop);}void main(){float alpha=0.;const float small=0.0001;const float centerSignedDist=0.;const float twoLineSignedDist=0.15;const float threeLineSignedDist=0.3;if(abs(vNumLines-1.)<small){alpha=lineAround(centerSignedDist);}else if(abs(vNumLines-2.)<small){alpha=lineAround(-twoLineSignedDist)+lineAround(twoLineSignedDist);}else if(abs(vNumLines-3.)<small){alpha=lineAround(-threeLineSignedDist)+lineAround(centerSignedDist)+lineAround(threeLineSignedDist);}gl_FragColor=vec4(vBaseColor,alpha*globalOpacity);gl_FragColor=linearToOutputTexel(gl_FragColor);}"},63380:e=>{e.exports="precision highp float;attribute float rotationY;attribute vec3 offset;attribute vec3 scaleAttr;attribute vec3 baseColor;attribute float numLines;varying vec3 vPosition;varying vec3 vBaseColor;varying float vNumLines;vec3 rotateY(vec3 v,float r){float c2=cos(r/2.);float s2=sin(r/2.);float qy=s2;float qw=c2;float tx=2.*qy*v.z;float tz=2.*(-qy*v.x);float x=v.x+qw*tx+qy*tz;float y=v.y;float z=v.z+qw*tz-qy*tx;return vec3(x,y,z);}void main(){vPosition=position;vBaseColor=baseColor;vNumLines=numLines;vec3 wsPosition=rotateY(position*scaleAttr,rotationY)+offset;gl_Position=projectionMatrix*modelViewMatrix*vec4(wsPosition,1.);}"},93854:e=>{e.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float selectedWidth;uniform float globalOpacity;varying vec3 outlineColor;varying vec3 color;varying float opacity;varying float width;varying vec3 lineStart;varying vec3 lineEnd;varying vec3 vWorldPos;float distanceBetween(vec2 l1,vec2 l2,vec2 p){float D=length(l2-l1);float N=abs((l2.x-l1.x)*(l1.y-p.y)-(l1.x-p.x)*(l2.y-l1.y));return N/D;}void main(){float distanceToLine=distanceBetween(lineStart.xz,lineEnd.xz,vWorldPos.xz);float aaWidth=fwidth(distanceToLine)*ANTIALIAS_WIDTH;float lineLerp=smoothstep(selectedWidth-aaWidth,selectedWidth,distanceToLine);float halfWidth=width*0.5;float aaOpacity=smoothstep(halfWidth,halfWidth-aaWidth,distanceToLine);float finalOpacity=opacity*globalOpacity*aaOpacity;gl_FragColor=linearToOutputTexel(mix(vec4(outlineColor,finalOpacity),vec4(color,finalOpacity),lineLerp));if(gl_FragColor.a<0.01){discard;}}"},82312:e=>{e.exports="precision highp float;attribute vec4 colorAndOpacity;attribute vec3 outlineColorAttr;attribute vec4 lineBiasedStartAndEnd;attribute float widthAttr;attribute float baseHeight;attribute vec4 fromLeft;attribute vec4 fromRight;attribute vec4 toLeft;attribute vec4 toRight;attribute vec4 lineStartAndEnd;attribute float vertIndex;varying vec3 outlineColor;varying vec3 color;varying float opacity;varying float width;varying vec3 lineStart;varying vec3 lineEnd;varying vec3 vWorldPos;void main(){vec3 position=vec3(0.,0.,0.);if(floor(vertIndex)==0.){position=vec3(lineStartAndEnd.x,baseHeight,lineStartAndEnd.y);}else if(floor(vertIndex)==3.){position=vec3(lineStartAndEnd.z,baseHeight,lineStartAndEnd.w);}else if(floor(vertIndex)==1.){position=vec3(fromRight.x,baseHeight,fromRight.y);}else if(floor(vertIndex)==2.){position=vec3(toRight.x,baseHeight,toRight.y);}else if(floor(vertIndex)==4.){position=vec3(toLeft.x,baseHeight,toLeft.y);}else if(floor(vertIndex)==5.){position=vec3(fromLeft.x,baseHeight,fromLeft.y);}else if(floor(vertIndex)==9.){position=vec3(fromRight.z,baseHeight,fromRight.w);}else if(floor(vertIndex)==6.){position=vec3(toRight.z,baseHeight,toRight.w);}else if(floor(vertIndex)==7.){position=vec3(toLeft.z,baseHeight,toLeft.w);}else if(floor(vertIndex)==8.){position=vec3(fromLeft.z,baseHeight,fromLeft.w);}outlineColor=outlineColorAttr;color=colorAndOpacity.xyz;opacity=colorAndOpacity.w;width=widthAttr;lineStart=vec3(lineBiasedStartAndEnd.x,baseHeight,lineBiasedStartAndEnd.y);lineEnd=vec3(lineBiasedStartAndEnd.z,baseHeight,lineBiasedStartAndEnd.w);vWorldPos=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},68216:e=>{e.exports="precision highp float;uniform vec3 color;uniform float opacity;uniform float radius;varying vec2 vCenter;varying vec2 vScreenPos;\n#ifdef FADE_DEPTH\nvarying vec3 vWorldPos;\n#endif\n#ifdef FADE_DEPTH\nuniform vec2 screenSize;uniform float pixelRatio;uniform sampler2D depthTex;uniform float fadeMaxDepth;float sample_depth(){vec2 frameBufferSize=screenSize*pixelRatio;vec2 screenUv=gl_FragCoord.xy/frameBufferSize;vec2 onePx=1./frameBufferSize;float nearestDepth=texture2D(depthTex,screenUv).r*fadeMaxDepth;return nearestDepth;}float calcDepthFadeOpacity(float currDepth){float nearestDepth=sample_depth();float behindDepth=max(currDepth-nearestDepth,0.);float depthFadeStartDist=FADE_DEPTH;float depthFadeEndDist=FADE_DEPTH+FADE_WIDTH;float depthFadeT=clamp((behindDepth-depthFadeStartDist)/(depthFadeEndDist-depthFadeStartDist),0.,1.);float depthFadeOpacity=1.-mix(0.,1.,depthFadeT);return depthFadeOpacity;}\n#endif\nvoid main(){float distanceFromCenter=length(vScreenPos-vCenter);float sdfOpacity=1.-smoothstep(radius-0.5,radius+0.5,distanceFromCenter);float depthFadeOpacity=1.;\n#ifdef FADE_DEPTH\nfloat distanceFromCamera=length(cameraPosition-vWorldPos);depthFadeOpacity=calcDepthFadeOpacity(distanceFromCamera);\n#endif\nfloat alpha=sdfOpacity*opacity*depthFadeOpacity;if(alpha<0.01){discard;}gl_FragColor=linearToOutputTexel(vec4(color,alpha));}"},45138:e=>{e.exports="precision highp float;uniform vec2 screenSize;vec2 rotate90(vec2 v){return vec2(-v.y,v.x);}vec2 ndcToScreen(vec4 pt){return(vec2(pt.x,pt.y)+vec2(1.,1.))*screenSize/2.;}vec2 screenToNdc(vec2 pt){return(pt*2./screenSize)-vec2(1.,1.);}\n#define ANTIALIAS_BUFFER  10.0\nuniform float radius;uniform vec3 translationOffset;attribute vec3 center;attribute vec2 offsetDirection;varying vec2 vCenter;varying vec2 vScreenPos;varying vec3 vWorldPos;void main(){vec3 translatedCenter=center+translationOffset;vec4 centerNdc=projectionMatrix*modelViewMatrix*vec4(translatedCenter,1.);vec2 centerScreen=ndcToScreen(centerNdc/centerNdc.w);vec2 vertexScreen=centerScreen+normalize(offsetDirection)*(radius+ANTIALIAS_BUFFER);vec2 vertexNdc=screenToNdc(vertexScreen);vCenter=centerScreen;vScreenPos=vertexScreen;vWorldPos=translatedCenter;gl_Position=vec4(vertexNdc*centerNdc.w,centerNdc.z,centerNdc.w);}"}}]);
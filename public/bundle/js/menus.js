/*! For license information please see menus.js.LICENSE.txt */
"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[3745],{50857:(e,t,i)=>{i.r(t),i.d(t,{NavigationVisuals:()=>S,debugSweepScoring:()=>C,default:()=>P,visDollhouseNavigation:()=>M,visPanoNavigation:()=>v});var o=i(90082),a=i(71687),n=i(82240),s=i(86866),r=i(52026),l=i(65882),c=i(10459),h=i(5243),d=i(12837),u=i(99583),p=i(25443),g=i(22299),w=i(81662),m=i(83075),y=i(23987),f=i(22374);const b={howManySweepScoresToShow:0};class S{constructor(e,t,i){this.engine=e,this.dynamicNumber=t,this.smoothWalk=i,this.active=!1,this.draw=new n.U,Promise.all([this.engine.getModuleBySymbol(a.M7),this.engine.market.waitForData(h.$),this.engine.getModuleBySymbol(a.PM),this.engine.market.waitForData(p.o),this.engine.getModuleBySymbol(o.ZF),this.engine.getModuleBySymbol(a.Kv)]).then((([e,t,i,o,a,n])=>{var s;this.meshQuery=i,this.draw.setStyle({assetBasePath:null!==(s=o.getSetting("assetBasePath"))&&void 0!==s?s:""}),this.draw.addToScene(e.getScene()),this.subscription=t.onChanged((()=>this.update(this.draw,t))),this.subscription.cancel();const r="Navigation";[{header:r,setting:"navDebugEnabled",initialValue:()=>!1,onChange:e=>this.toggle(e),urlParam:!0},{header:`${r}-Scoring`,setting:"navScoring",initialValue:()=>0,range:[0,20],rangePrecision:0,onChange:e=>{b.howManySweepScoresToShow=e},urlParam:!0},{header:`${r}-Filtering`,setting:"raycastNeighbors",initialValue:()=>n.config.raycastNeighbors,onChange:e=>{n.config.raycastNeighbors=e},urlParam:!0},{header:`${r}-Filtering`,setting:"maxDistSameFloor",initialValue:()=>l.U.maxDistSameFloor,range:[3,50],rangePrecision:0,onChange:e=>l.U.maxDistSameFloor=e,urlParam:!0},{header:`${r}-Filtering`,setting:"maxDistOtherFloors",initialValue:()=>l.U.maxDistOtherFloors,range:[3,50],rangePrecision:1,onChange:e=>l.U.maxDistOtherFloors=e,urlParam:!0},{header:`${r}-Filtering`,setting:"directionFactor",initialValue:()=>l.U.directionFactor,range:[-1,1],rangePrecision:2,onChange:e=>l.U.directionFactor=e,urlParam:!0},{header:`${r}-Scoring`,setting:"dirWeight",initialValue:()=>l.U.directionWeight,range:[-5,10],rangePrecision:1,onChange:e=>l.U.directionWeight=e,urlParam:!0},{header:`${r}-Filtering`,setting:"viewDirFactor",initialValue:()=>l.U.viewDirectionFactor,range:[-1,1],rangePrecision:2,onChange:e=>l.U.viewDirectionFactor=e,urlParam:!0},{header:`${r}-Scoring`,setting:"viewDirWeight",initialValue:()=>l.U.viewDirectionWeight,range:[-5,10],rangePrecision:1,onChange:e=>l.U.viewDirectionWeight=e,urlParam:!0},{header:r,setting:"accel",initialValue:()=>this.dynamicNumber.acceleration,range:[1,60],rangePrecision:.5,onChange:e=>{this.dynamicNumber.setAccel(e)}},{header:r,setting:"top speed",initialValue:()=>this.dynamicNumber.maxSpeed,range:[1,40],rangePrecision:.5,onChange:e=>this.dynamicNumber.setMaxSpeed(e)},{header:r,setting:"queue ms",initialValue:()=>this.smoothWalk.repeatedQueueDelayMS,range:[0,1e3],onChange:e=>this.smoothWalk.repeatedQueueDelayMS=e}].forEach((e=>a.registerMenuEntry(e)))}))}toggle(e){this.active!==e&&(e||this.draw.toggleAll(!1),e||this.subscription.cancel(),e&&this.subscription.renew(),!e&&D&&(y.Z.clear(),D=!1),this.active=e)}update(e,t){const i=this.engine.market.tryGetData(d.A),o=this.engine.market.tryGetData(c.M),n=this.engine.market.tryGetData(u.X),s=this.engine.market.tryGetData(g.J);if(e&&i&&o&&n&&s&&(e.toggleAll(!1),t.hit&&this.meshQuery.floorIdFromObject(t.hit.object)))if(n.isInside()){const n=this.engine.getModuleBySymbolSync(a.sA),r=this.engine.getModuleBySymbolSync(a.Kv);v(e,i,o,t.hit.intersection,this.meshQuery,s,n,r)}else M(e,i,t.hit.intersection,this.meshQuery)}}const v=(e,t,i,o,a,n,l,c)=>{let h=0;const d=o.point.clone();if(0===n.opacity.value&&l){const t=l.picking.pick(i.pose.position,i.pose.forward(),m.m.isRoomMesh);t&&(d.copy(t.point),e.sphere("panosphere"+h,{color:"red",opacity:.4}).toggle(!0).update(d,.1))}const u=d.clone().sub(i.pose.position),p=[],g=[],y=(0,r.GI)({sweepData:t,direction:u,meshQuery:(null==c?void 0:c.config.raycastNeighbors)?a:void 0,viewDirection:(null==c?void 0:c.config.raycastNeighbors)?i.pose.forward():void 0,scorers:p,filters:g}),f=Math.max(...y.map((e=>e.score))),b=f-5;C(y,p,g);for(const{sweep:t,score:i}of y)if(t){const o=0===h?"cyan":"orange",a=(0,s.m9)(i,b,f,0,.6);e.line("panosphere"+h++,o).toggle(!0).updatePositions(d,t.position).opacity(a);const n=(0,s.m9)(a,0,.6,.002,.1);if(e.sphere("panosphere"+h++,{color:o,opacity:.8}).toggle(!0).update(t.position,n),t.sourceViewId){const i=(0,s.$i)(t.position,w.B1.UP,n+n+.05);e.line("panosphere"+h++,"yellow").toggle(!0).updatePositions(t.position,i).opacity(a),e.sphere("panosphere"+h++,{color:o,opacity:.8}).toggle(!0).update(i,n)}}},M=(e,t,i,o)=>{let a=0;const n=[],l=[],c=(0,r.I9)(t,!1,i,o,n,l);C(c,n,l);const h=Math.max(...c.map((e=>e.score))),d=h-15;for(const{sweep:t,score:o}of c)if(t){const n=0===a?"cyan":"orange",r=(0,s.m9)(o,d,h,0,1);e.line("panosphere"+a++,n).toggle(!0).updatePositions(i.point,t.position).opacity(r);const l=(0,s.m9)(r,0,1,.05,.3);e.sphere("panosphere"+a++,{color:n}).toggle(!0).update(t.position,l)}};let D=!1;function C(e,t,i,o=b.howManySweepScoresToShow){if(o>0){D=!0,y.Z.clear(),y.Z.logValue("candidate sweeps after filtering",e.length),y.Z.logValue("raycasts checked during filtering",r.vM.count),y.Z.logValue("filters:",i.map((e=>e.name)).join(", "));let a=0;for(const{sweep:i,score:n}of e)i&&++a<=o&&(y.Z.logValue(`rank: ${a}, sweep.index: ${(0,f.H)(i.index+1,3)}, platformId`,i.platformId),t.forEach(((e,t)=>{y.Z.logValue(`rank: ${a}, score${e.name}${t}`,e(i).toFixed(4))})),y.Z.logValue(`rank: ${a}, using ${t.length} scorers, total`,n.toFixed(4)))}else D&&(D=!1,y.Z.clear())}function P(e){e.getModuleBySymbol(a.Kv).then((t=>{const i=t.navigationWalk;for(const t of i.values()){const i=t.positionTracker;new S(e,i,t)}}))}},46317:(e,t,i)=>{i.r(t),i.d(t,{default:()=>c});var o=i(90082),a=i(84440),n=i(9139),s=i(71687);const r=new n.Vy("raycaster-debug");class l{constructor(e){Promise.all([e.getModuleBySymbol(o.ZF),e.getModuleBySymbol(s.M7),e.getModuleBySymbol(s.sA)]).then((([e,t,i])=>{const o=t.getScene(),n=[];let s=!1;const l=()=>{n&&n.forEach((e=>{e.geometry.dispose(),e.material.dispose(),o.remove(e)}))},c=(e,t,s)=>{r.info("draw",{from:e,to:t,faces:s});const l=i.getOctree().getDebugBoundsMesh((0,a.Mq)().getHex(),e,t,s);l.frustumCulled=!1,l.updateMatrixWorld(!0),o.add(l),n.push(l)};e.registerMenuButton({header:"Raycaster",buttonName:"Add Octree Level Buttons",callback:()=>{if(!s){for(let t=0;t<=i.getOctree().depth;t++)e.registerMenuButton({header:"Octree Levels",buttonName:`Anything on Level: ${t}`,callback:()=>{l(),c(t,t,!1)}});for(let t=0;t<=i.getOctree().depth;t++)e.registerMenuButton({header:"Octree Faces",buttonName:`Faces on Level: ${t}`,callback:()=>{l(),c(t,t,!0)}});s=!0}}}),e.registerMenuButton({header:"Raycaster",buttonName:"Visualize Octree - All",callback:()=>{l();for(let e=0;e<=i.getOctree().depth;e++)c(e,e,!1)}}),e.registerMenuButton({header:"Raycaster",buttonName:"Visualize Octree - Faces",callback:()=>{l();for(let e=0;e<=i.getOctree().depth;e++)c(e,e,!0)}}),e.registerMenuButton({header:"Raycaster",buttonName:"Clear Octree Visuals",callback:l})}))}}function c(e){new l(e)}},12655:(e,t,i)=>{i.r(t),i.d(t,{default:()=>b});var o=i(68909),a=i(9139),n=i(56637),s=i(90082),r=i(71687),l=i(82240),c=i(86866),h=i(81662),d=i(10459),u=i(5243),p=i(3694),g=i(38069);const w=new a.Vy("raycaster-debug");var m;!function(e){e.normal="normal",e.hitClass="hitClass",e.hitBounds="hitBounds"}(m||(m={}));const y={color:"yellow"};class f{get draw(){return this._draw||(this._draw=new l.U({background:!1,color:g.V.WHITE.clone()}),this.engine.getModuleBySymbol(r.M7).then((e=>this._draw.addToScene(e.getScene())))),this._draw}constructor(e){this.engine=e,this.cached={v1:new o.Vector3,v2:new o.Vector3,quat:new o.Quaternion,normal4:new o.Vector4,normal:new o.Vector3,rotationMatrix:new o.Matrix4},this.bindings=[],this.showClass=!1,this.showName=!0,this.showNormal=!1,this.showBounds=!1,this.usePointerHits=!1,this.update=()=>{const e=this.engine.market.tryGetData(d.M),t=this.getHit();this.showNormal&&this.drawRaycastHitNormal(t),this.showBounds&&this.drawRaycastHitBounds(t),this.drawRaycastObjectInfo(t,e,this.showClass,this.showName)},this.drawRaycastHitNormal=e=>{const t=this.draw.line(m.normal,"red",4);e&&t.updatePositions(e.point,this.cached.v1.copy(e.point).addScaledVector(e.normal,.2)),t.toggle(null!==e)},this.drawRaycastObjectInfo=(e,t,i,o)=>{const a=this.draw.label(m.hitClass,"X",this.cached.v1,1);if(a.visible=!1,e&&t&&(i||o)){const{position:n,rotation:s}=t.pose,{point:r,object:l}=e,d=o?`\n${""!==l.name?l.name:l.id}`:"",u=i&&l.__proto__.constructor.name?`\n${l.__proto__.constructor.name}`:"",p=l.sourceViewId?`\nsourceViewId: ${l.sourceViewId}`:"",g=l.layerId?`\nlayerId: ${l.layerId}`:"";a.text=`${d}${u}${p}${g}`,a.setPosition(r,(e=>t.isOrtho()?e.addScaledVector(h.B1.UP,10):(0,c.jS)(n,e,1,e))),a.scaleBillboard(n,s,t.pose.projection,t.zoom(),t.height,t.aspect(),.1),a.setOrientation(s),a.visible=!0}},this.drawRaycastHitBounds=e=>{const t=this.draw.boxWire(m.hitBounds,y).toggle(!1);if(e&&e.object&&!(e.object instanceof p.W)&&e.object instanceof o.Mesh){const i=(0,n.UX)(e.object.geometry),o=i.getCenter(this.cached.v1).applyMatrix4(e.object.matrixWorld),a=i.getSize(this.cached.v2).multiply(e.object.scale).multiplyScalar(.5);t.mesh.quaternion.copy(e.object.quaternion),t.toggle(!0).update(o,a)}},this.onPointerDown=()=>{const e=this.data.hits;for(const t of e)if(t&&t.object){let e="";t.object instanceof o.Object3D&&t.object.traverseAncestors((t=>{e=`${""!==t.name?t.name:"Group"}.visible: ${t.visible}, ${e}`})),w.info(t.distance,t.object,e)}},Promise.all([e.getModuleBySymbol(s.ZF),e.getModuleBySymbol(r.sA),e.getModuleBySymbol(r.Qm),e.market.waitForData(u.$)]).then((([e,t,i,o])=>{this.data=o,this.viewportModule=i,this.raycasterModule=t,this.bindings.push(this.viewportModule.viewportManager.onPropertyChanged("activeViewport",(e=>{e&&this.update()}))),this.bindings.forEach((e=>e.cancel()));const a=e=>{e?(window.addEventListener("pointerdown",this.onPointerDown),window.addEventListener("pointermove",this.update),this.bindings.forEach((e=>e.renew()))):(window.removeEventListener("pointerdown",this.onPointerDown),window.removeEventListener("pointermove",this.update),this.bindings.forEach((e=>e.cancel())),this.draw.toggleAll(!1))};e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitDebugging",initialValue:()=>!1,onChange:e=>{a(e)},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterPointerHit",initialValue:()=>!1,onChange:e=>{this.usePointerHits=e},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitClass",initialValue:()=>this.showClass,onChange:e=>{this.showClass=e},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitName",initialValue:()=>this.showName,onChange:e=>{this.showName=e},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitNormal",initialValue:()=>this.showNormal,onChange:e=>{this.showNormal=e},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitBounds",initialValue:()=>this.showBounds,onChange:e=>{this.showBounds=e},urlParam:!0})}))}getHit(){let e=this.data.hit;if(this.usePointerHits){const t=this.raycasterModule.pointer.cast()[0];if(t&&t.face&&t.object instanceof o.Object3D){const i=t.face.normal;this.cached.normal4.set(i.x,i.y,i.z,0),this.cached.rotationMatrix.extractRotation(t.object.matrixWorld),this.cached.normal4.applyMatrix4(this.cached.rotationMatrix),this.cached.normal.set(this.cached.normal4.x,this.cached.normal4.y,this.cached.normal4.z),e=new u.t(t.point.clone(),this.cached.normal.clone(),t.object,t)}}return e}}function b(e){new f(e)}},9831:(e,t,i)=>{i.r(t),i.d(t,{default:()=>d});var o=i(90082),a=i(71687),n=i(68909),s=i(52947),r=i(43543),l=i(32484);const{TILEDMESH_SETTINGS:c}=l.yJ,h="Snapping";async function d(e){const[t,i,l]=await Promise.all([e.getModuleBySymbol(o.ZF),await e.getModuleBySymbol(a.sA),e.getModuleBySymbol(a.M7)]),d=i.snapping,u=l.getScene().scene;t.registerMenuEntry({header:h,setting:"snappingMaxLOD",initialValue:()=>c.snappingMaxLOD,onChange:e=>{c.snappingMaxLOD=e},urlParam:!0,rangePrecision:0,range:[0,3]}),function(e,t,i){const o=new n.BufferGeometry,a=new n.LineSegments(o,new n.LineBasicMaterial({vertexColors:!0}));a.frustumCulled=!1;const r=new n.SphereGeometry(.02,5,5);let l;const c=[16711680,65280,255,16777215],d=new n.Color,u=(new n.Matrix4).identity(),p=new n.Group;let g;function w(){const e=[],i=[],h=[],g=[];t.forEachSnapFeature((t=>{var o,a,n;if(d.setHex(c[(null===(n=null===(a=null===(o=t.meta)||void 0===o?void 0:o.tile)||void 0===a?void 0:a.extras)||void 0===n?void 0:n.level)||0]),t instanceof s.cF){const{start:o,end:a}=t;e.push(o.x,o.y,o.z,a.x,a.y,a.z),i.push(d.r,d.g,d.b,d.r,d.g,d.b)}else t instanceof s.F7&&(h.push(t.x,t.y,t.z),g.push(d.r,d.g,d.b))}),!0),o.dispose(),o.setAttribute("position",new n.Float32BufferAttribute(e,3)),o.setAttribute("color",new n.Float32BufferAttribute(i,3)),l&&3*l.count===h.length||(l&&(p.remove(l),null==l||l.dispose()),l=new n.InstancedMesh(r,new n.MeshBasicMaterial,h.length/3));for(let e=0;e<h.length;e+=3)l.setMatrixAt(e/3,u.setPosition(h[e],h[e+1],h[e+2])),l.setColorAt(e/3,d.setRGB(g[e],g[e+1],g[e+2]));p.add(a,l)}e.registerMenuEntry({header:h,setting:"Show Snapping Features",initialValue:()=>!1,onChange(e){e?(i.add(p),g=setInterval(w,300)):(null==l||l.dispose(),r.dispose(),o.dispose(),i.remove(p),clearInterval(g))}})}(t,d,u),function(e,t,i,o){const a=[];let s,l;function c(){l||(l=new n.Mesh(new n.BufferGeometry,new n.MeshBasicMaterial({vertexColors:!0})),l.frustumCulled=!1,i.add(l));const e=[],t=[];for(const i of a){let o=0;for(const a of i.surfaces){const i=a.area>.1,n=Math.sin(o++)/2+.5,s=i?0:.2+.8*n,r=i?.2+.8*n:0,l=0;for(const i of a.faces){const o=i.va.vector,a=i.vb.vector,n=i.vc.vector;e.push(o.x,o.y,o.z),e.push(a.x,a.y,a.z),e.push(n.x,n.y,n.z),t.push(s,r,l,s,r,l,s,r,l)}}}l.geometry.dispose(),l.geometry.setAttribute("position",new n.Float32BufferAttribute(e,3)),l.geometry.setAttribute("color",new n.Float32BufferAttribute(t,3))}function d(e){a.push(e.edgeFinder)}[{header:h,setting:"Collect Snapping Surfaces",initialValue:()=>!1,onChange(e){e?o.subscribe(r.X,d):(o.unsubscribe(r.X,d),a.length=0)}},{header:"Snapping",setting:"Show Snapping Surfaces",initialValue:()=>!1,onChange(e){clearInterval(s),e?s=setInterval((()=>{t.preloadMeshSnapping(),c()}),1e3):l&&(l.geometry.dispose(),i.remove(l),l=null)}}].forEach((t=>e.registerMenuEntry(t)))}(t,d,u,e)}},2942:(e,t,i)=>{i.r(t),i.d(t,{PanoPreloadVisualizer:()=>S,default:()=>v});var o=i(68909),a=i(9139),n=i(90082),s=i(71687),r=i(82240),l=i(23870),c=i(10459),h=i(5243),d=i(12837),u=i(99583),p=i(50018),g=i(81662),w=i(9997),m=i(40397),y=i(13893),f=i(38069);const b=new a.Vy("previs");class S{constructor(e,t,i){this.engine=e,this.downloadDescriptorGetter=t,this.prioritizer=i,this.allPreloadedSweeps=new Set,this.active=!1,this.freezeCameraRotation=!1,this.sweepIndex=50,this.useCurrentCriteria=!0,this.showPreloadIds=!0,this.visualTour=!1,this.showSweepLabels=!1,this.draw=new r.U,this.engine.getModuleBySymbol(s.M7).then((e=>this.draw.addToScene(e.getScene()))),this.engine.market.waitForData(h.$).then((e=>{this.subscription=e.onChanged((()=>this.update(this.draw))),this.subscription.cancel()}));const o=this.engine.market.tryGetData(d.A);if(o){this.sweepData=o;const e=o.getSweepList(),t=new l.A((e=>e.id));for(let i of e)i.isObservableProxy&&(i=new p.Ay({platformId:i.platformId}).copy(i)),t.add(i);this.sweepMap=t}this.engine.getModuleBySymbol(n.ZF).then((e=>{const t="Pano Preload",i=[{header:t,setting:"ShowVis",initialValue:()=>this.active,onChange:e=>this.toggle(e)},{header:t,setting:"Use Camera",initialValue:()=>this.useCurrentCriteria,onChange:e=>{this.useCurrentCriteria=e,this.update(this.draw)}},{header:t,setting:"Freeze Rotation",initialValue:()=>this.freezeCameraRotation,onChange:e=>{this.freezeCameraRotation=e,this.update(this.draw)}},{header:t,setting:"Show preload ids",initialValue:()=>this.showPreloadIds,onChange:e=>{this.showPreloadIds=e,this.update(this.draw)}},{header:t,setting:"Visual tour",initialValue:()=>this.visualTour,onChange:e=>{this.visualTour=e,this.update(this.draw)}},{header:t,setting:"Pano labels",initialValue:()=>this.showSweepLabels,onChange:e=>{this.showSweepLabels=e,this.update(this.draw)}},{header:t,setting:"Override Sweep",initialValue:()=>0,onChange:e=>this.updateSweepIndex(e),range:[0,this.sweepMap.count()]}];e.registerMenuButton({header:"Pano Preload tour",buttonName:"Tour",callback:()=>{this.activateTourMode()}}),i.forEach((t=>e.registerMenuEntry(t)))}))}updateSweepIndex(e){const t=Math.round(e);this.sweepIndex=t,this.update(this.draw)}toggle(e){this.active!==e&&(e&&this.subscription.renew(),e||(this.subscription.cancel(),this.draw.toggleAll(!1)),this.active=e)}update(e){const t=this.engine.market.tryGetData(d.A),i=this.engine.market.tryGetData(c.M),a=this.engine.market.tryGetData(u.X);if(!(e&&t&&i&&a))return;if(!this.active||!this.sweepMap)return;if(this.tourMode&&!this.visualTour)return;const n=t.getSweepList(),s=this.useCurrentCriteria?this.prioritizer.clonePriorityCriteria():this.lastCriteria;if(this.useCurrentCriteria){if(this.freezeCameraRotation)for(const[e,t]of s.entries()){if(!t.sweep)continue;const i=this.lastCriteria.get(e);i&&t.set({position:t.sweep.position,rotation:i.rotation,direction:g.B1.FORWARD.clone().applyQuaternion(i.rotation)})}}else for(const e of s.values())if(e.set({sweep:this.sweepData.getSweepByIndex(this.sweepIndex)||null}),!this.freezeCameraRotation){if(!e.sweep)return;e.set({position:e.sweep.position,rotation:i.pose.rotation,direction:g.B1.FORWARD.clone().applyQuaternion(i.pose.rotation)})}if(this.lastCriteria=s,Array.from(s.values()).every((e=>!e.sweep)))return;this.tourMode||this.wipePreloadedData();const r=[];this.prioritizer.filterAndPrioritize(r,this.downloadDescriptorGetter,s),this.draw.toggleAll(!1);for(const t of s.values()){const a=new Set;let n="";for(const e of r)e&&e.sweep&&e.criteriaId===t.id&&(a.has(e.sweep.id)||(a.add(e.sweep.id),n+=`${e.sweep.index}, `),this.allPreloadedSweeps.has(e.sweep.id)||this.allPreloadedSweeps.add(e.sweep.id));if(!t.sweep)continue;const s=new o.Vector3(0,0,-1.5).applyQuaternion(t.rotation),l=(new o.Vector3).copy(t.position).add(s),c=`Current Pano: ${t.sweep.index}\n      ${this.showPreloadIds?`Panos: ${n}`:""}\n      Preload Count (this pano): ${a.size}\n      Total Preloaded: ${this.allPreloadedSweeps.size}`,h=e.label("infoLabel"+t.id,c,l,.1);h.lookAt(i.pose.position),h.setPosition(l),h.text=c,this.drawSweepSpheres(a,t)}if(this.showSweepLabels)for(const t of n){const o=`${t.index}`,a=e.label(t.id,o,t.position,.1);a.text=o,a.setColor(f.V.RED),a.lookAt(i.pose.position)}}drawSweepSpheres(e,t){const i=t.sweep;if(!i)return;const a=(new o.Vector3).copy(i.position);a.y+=-.5;for(const t of e){const e=this.sweepData.getSweep(t),n=i===e,s=n?"green":"white",r=(new o.Vector3).copy(e.position);if(r.y+=-.5,this.draw.sphere(e.id+"sphere"+(n&&"source"),{color:s,opacity:1}).update(r,.2).toggle(!0),!n){const t=this.draw.line(`${e.id}-${i.id}`,new o.Color("white"),.05);t.updatePositions(r,a),t.toggle(!0)}}}activateTourMode(){this.tourMode=!0;const e={},t=Math.round(this.sweepIndex),i=this.sweepData.getSweepByIndex(t);i&&this.engine.commandBinder.issueCommand(new w.aj({sweep:i.id})).then((()=>{this.wipePreloadedData(),this.allPreloadedSweeps.clear();const t=this.sweepData.getSweepList(),o=Math.round(.05*t.length);i&&this.tourStep(i,e,o)}))}tourStep(e,t,i,a=0,n=""){const s=e,r=this.sweepData.getSweepList();let l=e;if(!s||s.neighbours.length<=0)return;t[s.id]=!0,n+=`Sweep: ${s.index} Loaded: ${this.allPreloadedSweeps.size}\n`;let c=0;for(;c<r.length;){const e=(s.index+1+c)%r.length,i=this.sweepData.getSweepByIndex(e);if(c++,i&&(l=i,!t[l.id]&&l.id!==s.id&&l))break}if(++a<=i)if(this.visualTour)this.engine.commandBinder.issueCommand(new w.aj({sweep:s.id,rotation:(0,m.kf)(s.position,l.position),transition:y.fl.Interpolate})).then((()=>{setTimeout((()=>{this.tourStep(l,t,i,a,n)}),500)}));else{const e=(0,m.kf)(s.position,l.position),r=(new o.Vector3).copy(g.B1.FORWARD).applyQuaternion(e),c=this.prioritizer.clonePriorityCriteria();for(const t of c.values())t.set({direction:r,rotation:e,sweep:s,position:s.position});const h=[];this.prioritizer.filterAndPrioritize(h,this.downloadDescriptorGetter,c);this.queueToPanoSet(h).forEach((e=>this.allPreloadedSweeps.add(e))),this.tourStep(l,t,i,a,n)}else b.info(`TOUR END\n      Sweeps visited: ${a}\n      Visual: ${this.visualTour}\n      Sweeps preloaded: ${this.allPreloadedSweeps.size}`),b.info(`TOUR INFO\n      ${n}`),this.tourMode=!1}queueToPanoSet(e){const t=new Set;for(const i of e)i&&i.sweep&&(t.has(i.sweep.id)||t.add(i.sweep.id));return t}wipePreloadedData(){const e=this.sweepData.getSweepList();for(const t of e)this.downloadDescriptorGetter.deleteAllTileDownloadDescriptors(t.id)}}function v(e){e.getModuleBySymbol(s.qD).then((t=>{const i=t;"tileDownloader"in i&&new S(e,i.tileDownloader,i.tilePrioritizer)}))}},34547:(e,t,i)=>{i.r(t),i.d(t,{default:()=>O});var o=i(90082),a=i(71687),n=i(47737),s=i(28165),r=i(68909),l=i(25443),c=i(21875),h=i(12837),d=i(10459),u=i(99583),p=i(79728),g=i(66806),w=i(37458),m=i(73427),y=i(41819),f=i(1333),b=i(88664),S=i(13893),v=i(56637);function M(e,t=.8,i=.6){const o=e/5.7%1;return(new r.Color).setHSL(o,t,i)}var D=i(515);class C extends r.Mesh{constructor({position:e,label:t,color:i}){super(new r.SphereGeometry(.25),new r.MeshBasicMaterial({color:i,opacity:.8,depthTest:!1})),this.add(new P(t)),this.position.copy(e)}}class P extends D.EY{constructor(e){super(),this.text=e,this.fontSize=.35,this.outlineWidth=.01,this.anchorX="center",this.anchorY="middle",this.material=new r.MeshBasicMaterial({depthTest:!1}),this.renderOrder=w.X.gizmos+.1}onBeforeRender(e,t,i,o,a,n){super.onBeforeRender(e,t,i,o,a,n),this.quaternion.copy(i.quaternion)}}var B=i(53172);class x extends r.Mesh{constructor({position:e,quaternion:t,angle:i,color:o}){const a=new r.CircleGeometry(1.5,16,(0,B.pu)(90),(0,B.pu)(i));a.rotateX((0,B.pu)(-90));super(a,new r.MeshBasicMaterial({color:o,side:r.DoubleSide,transparent:!0,opacity:.5,depthTest:!1})),this.position.copy(e),this.quaternion.copy(t)}}class I extends r.InstancedMesh{constructor({sweeps:e,curve:t,color:i}){const o=Math.round(t.getLength()/.15),a=t.getSpacedPoints(o);super(new r.SphereGeometry(.05),new r.MeshBasicMaterial({color:i,transparent:!0,opacity:.8,depthTest:!1}),a.length+e.length);const n=new r.Matrix4;a.forEach(((e,t)=>{this.setMatrixAt(t,n.makeTranslation(e))})),e.forEach((({position:e},t)=>{this.setMatrixAt(a.length+t,n.makeScale(2,2,2).setPosition(e))}))}}class T{constructor(e){this.engine=e,this.active=!1,this.root=new r.Group,this.rebuild=()=>{if(this.root.traverse((e=>{(0,v.uW)(e)&&e.geometry.dispose()})),this.root.clear(),this.active){const e=this.getDebugInfo();e.stops.forEach((({position:e,viewMode:t,pan:i},o)=>{const a=M(o);this.root.add(new C({position:e,color:a,label:`${o+1}`})),i&&"panorama"===t&&this.root.add(new x({position:i.startPosition,quaternion:i.startQuaternion,angle:i.panAngle,color:a}))})),e.walkingPaths.forEach((({toStopIndex:e,sweeps:t,curve:i})=>{this.root.add(new I({sweeps:t,curve:i,color:M(e)}))})),this.localTourData.setTourCurrentSnapshotByIndex(0),this.scene.add(this.root)}}}async init(){const[e,t,i,o,{meshTrimData:n}]=await Promise.all([this.engine.market.waitForData(l.o),this.engine.market.waitForData(c.R),this.engine.getModuleBySymbol(a.Wh),this.engine.getModuleBySymbol(a.M7),this.engine.getModuleBySymbol(a.GR)]);this.scene=o.getScene(),this.settingsData=e,this.localTourData=new c.R(t.getReel(),(()=>[g.N.Dollhouse,g.N.Floorplan,g.N.Panorama,g.N.ExteriorSplat]),!1),this.localSweepData=new h.A(i.data.getSweepList().reduce(((e,t)=>(e[t.id]=t,e)),{}));const s=Object.create(i,{data:{value:this.localSweepData}});this.localCameraData=new d.M(1,1),this.localViewmodeData=new u.X,this.transitionFactory=new p.A(this.engine,this.localTourData,s,this.localCameraData,e,this.localViewmodeData),await this.transitionFactory.init(),t.onChanged(this.rebuild),n.onMeshTrimChanged(this.rebuild),this.root.name="tours-debug",this.root.renderOrder=w.X.gizmos}getDebugInfo(){const e={stops:[],walkingPaths:[]};return this.localTourData.enabledTourStops.forEach((t=>{var i,o,a,n;const s=this.localTourData.getTourIndexBySid(t),l=this.localTourData.getTourEntry(t);if(!l)return;const{cameraPosition:c,cameraMode:h,cameraQuaternion:d,scanId:u}=l.snapshot.metadata,p={viewMode:m.e[h],sweepId:u||null,position:c,quaternion:d};e.stops.push(p);const g=this.transitionFactory.getBurnsTransition(s);if(g instanceof y.H&&(p.pan={startPosition:(new r.Vector3).copy((null===(i=g.startPose)||void 0===i?void 0:i.position)||l.snapshot.metadata.cameraPosition),startQuaternion:(null===(o=g.startPose)||void 0===o?void 0:o.rotation)||l.snapshot.metadata.cameraQuaternion,panAngle:g.degrees*(g.direction===f.ND.Left?1:-1)}),s>0){const t=null!==(n=null===(a=l.overrides)||void 0===a?void 0:a.transitionType)&&void 0!==n?n:this.settingsData.tryGetSetting(b.zk,S.fl.Interpolate),i=this.transitionFactory.getMainTransition(s,t);i instanceof f.Tz&&e.walkingPaths.push({fromStopIndex:e.stops.length-2,toStopIndex:e.stops.length-1,sweeps:i.sweeps.map((e=>({id:e.id,position:e.position.clone()}))),curve:i.calculateCurve().curve})}this.localCameraData.pose.position.copy(c),this.localCameraData.pose.rotation.copy(d),this.localViewmodeData.currentMode=h,this.localTourData.setTourCurrentSnapshotByIndex(s),this.localSweepData.state.currentSweep=u})),e}activate(){this.active||(this.active=!0,this.rebuild())}deactivate(){this.active&&(this.active=!1,this.rebuild())}}const E="visualizeTourStops",V="writeTourDebug",A="MP_TOUR_DEBUG";var N=i(9139);async function O(e){const[t,i,r]=await Promise.all([e.getModuleBySymbol(o.ZF),e.getModuleBySymbol(a.Gw),e.market.waitForData(n.P)]),l="Tours";t.registerMenuButton({header:l,buttonName:"Generate a tour",callback:async()=>{const e=t.tryGetSetting(s.Ye,s.lB),o=r.getBaseModelId();i.generateTourFromTemplate(e,{modelId:o})}});const c=new T(e);await c.init(),t.registerMenuEntry({header:l,setting:E,initialValue:()=>!1,urlParam:!0,onChange:e=>{c[e?"activate":"deactivate"]()}}),t.settingsData.getOverrideParam(V,!1)&&(window[A]=c.getDebugInfo(),new N.Vy("tour-debug").info(`Wrote TourDebugInfo to ${A}`,window[A]))}},33796:(e,t,i)=>{i.r(t),i.d(t,{default:()=>n});var o=i(90082),a=i(71687);async function n(e){const[t,i]=await Promise.all([e.getModuleBySymbol(o.ZF),e.getModuleBySymbol(a.M7)]),n="WebGL Renderer";let s=null;function r(e){i.threeRenderer.forceContextLoss(),setTimeout((()=>{i.threeRenderer.forceContextRestore()}),e)}t.registerMenuButton({header:n,buttonName:"Lose Context for 0.1 sec",callback:()=>{r(100)}}),t.registerMenuButton({header:n,buttonName:"Lose Context for 5 sec",callback:()=>{r(5e3)}}),t.registerMenuEntry({header:n,setting:"autoLoseContext",initialValue:()=>!1,urlParam:!0,onChange(e){if(e){const e=()=>r(100);e(),s=setInterval(e,1e4)}else clearInterval(s)}})}},44667:(e,t,i)=>{i.d(t,{s:()=>a});var o=i(92475);class a extends o.E{constructor(e,t,i){super(e),this.position=t,this.delta=i}}},28165:(e,t,i)=>{i.d(t,{C0:()=>h,H$:()=>p,JK:()=>m,OU:()=>g,Vq:()=>d,Ye:()=>s,au:()=>u,cD:()=>w,hd:()=>l,lB:()=>n,nz:()=>c,pH:()=>r});var o=i(64650),a=i(60152);const n=o.pk.SCOUT,s="autotours_template",r="autotours_generate",l={width:480,height:270},c="autotours_pan_angle",h=50,d="autotours_pan_speed",u=a.BU,p="autotours_regen_text",g=!1,w="autotours_defurnish",m=!0},64650:(e,t,i)=>{var o,a,n,s;i.d(t,{ei:()=>a,pT:()=>s,pk:()=>o,sA:()=>n}),function(e){e.SCOUT="scout",e.VISION="vision",e.DIGITAL_PRO="digitalpro"}(o||(o={})),function(e){e.IDLE="idle",e.ACCEPTED="accepted",e.DISCARDED="discarded"}(a||(a={})),function(e){e.CANCELED="canceled",e.COMPLETED="completed",e.CONTINUED="continued",e.FAILED="failed",e.RUNNING="running",e.TERMINATED="terminated",e.TIMEOUT="timeout",e.UNKNOWN="unknown"}(n||(n={})),function(e){e.BALCONY="balcony",e.BASEMENT="basement",e.BATHROOM="bathroom",e.BEDROOM="bedroom",e.CLOSET="closet",e.CORRIDOR="corridor",e.DINING="dining",e.DOLLHOUSE="dollhouse",e.DRIVEWAY="driveway",e.ENTRANCE="entrance",e.EXERCISE="exercise",e.FACADE="facade",e.GAME="game",e.GARAGE="garage",e.HALLWAY="hallway",e.KITCHEN="kitchen",e.LAUNDRY="laundry",e.LIVING="living",e.LOBBY="lobby",e.LOFT="loft",e.MIXED="mixed",e.OFFICE="office",e.OTHER="other",e.OUTDOOR="outdoor",e.PANTRY="pantry",e.PATIO="patio",e.POOL="pool",e.STAIRCASE="staircase",e.UNFURNISHED="unfurnished",e.UNKNOWN="unknown",e.UTILITY="utility",e.YARD="yard"}(s||(s={}))},23870:(e,t,i)=>{i.d(t,{A:()=>n});const o=e=>""+e;class a{constructor(e=o){this.mappingFunction=e,this.list=[],this.map=new Map}add(e){const t=this.mappingFunction(e);return!this.map.has(t)&&(this.list.push(e),this.map.set(t,e),!0)}set(e){const t=this.mappingFunction(e);return this.map.has(t)?(this.map.set(t,e),!0):(this.add(e),!0)}count(){return this.list.length}*[Symbol.iterator](){for(const e of this.list)yield e}getByIndex(e){return this.list[e]}get(e){return this.map.get(e)}copyToList(e){return e.push(...this.list),e}clear(){this.list=[],this.map=new Map}mapElements(e){return this.list.map(e)}values(){return this.list.slice()}}const n=a},78498:(e,t,i)=>{function o(e){return{x:e.x,y:e.y,z:e.z}}function a(e){return{x:e.x||e._x,y:e.y||e._y,z:e.z||e._z,w:e.w||e._w}}i.d(t,{I:()=>o,p:()=>a})},84440:(e,t,i)=>{i.d(t,{Mq:()=>l,Zd:()=>r,_o:()=>c});var o=i(68909);const a=()=>Math.random(),n={},s={},r=(e,t=a())=>(n[t]||(n[t]=new o.Vector4(a(),a(),a(),e)),n[t]),l=(e=a())=>(s[e]||(s[e]=new o.Color(a(),a(),a())),s[e]),c=e=>e instanceof Object&&"r"in e&&"g"in e&&"b"in e}}]);
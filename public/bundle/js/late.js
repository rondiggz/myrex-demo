/*! For license information please see late.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[7475],{41984:(e,t,i)=>{"use strict";i.d(t,{A:()=>p});var n,s,a,o=i(96540),r=i(72909),d=i(77570),l=i(32485),c=i.n(l),h=i(71397),u=i(50178),m=i(74848);let p=(n=Reflect.metadata("design:type",Function),s=Reflect.metadata("design:paramtypes",["undefined"==typeof TextInputBoxProps?Object:TextInputBoxProps]),(0,r.A)(a=n(a=s(a=class extends o.Component{static contextType=(()=>d.B)();input;focusTimeout=0;constructor(e){super(e),this.state={currentText:e.text}}componentWillUnmount(){window.clearTimeout(this.focusTimeout),this.input&&this.input.blur()}componentDidMount(){const{focusOnMount:e,readOnly:t}=this.props;t||(0===e?this.focus():void 0!==e&&(this.focusTimeout=window.setTimeout((()=>{this.focus()}),e)))}UNSAFE_componentWillReceiveProps(e){e.text!==this.props.text&&this.setState({currentText:e.text})}getText(){return this.input?this.input.value:""}focus(){this.input.focus()}blur(){this.input.blur()}scrollIntoView(e){this.input.scrollIntoView(e)}onInput=e=>{if(this.props.onInput){const t=e.target;this.props.onInput(t.value)}};onKeyPress=e=>{e.stopPropagation();const{allowTabbing:t}=this.props,i=e.which||e.keyCode,n=[h.D.TAB,h.D.RETURN,h.D.ESCAPE];if("keydown"===e.type&&!n.includes(i))return!1;const s=e.target;switch(this.props.maxLength&&s.value.length>this.props.maxLength&&e.preventDefault(),i){case h.D.ESCAPE:this.props.onCancel&&this.props.onCancel();break;case h.D.TAB:case h.D.RETURN:this.props.onBlur||e.shiftKey||(i===h.D.TAB&&t||e.preventDefault(),this.blur())}return!1};stopPropagation=e=>e.stopPropagation();onFocus=e=>{this.context.messageBus.broadcast(new u.Yl(this.input,!0)),this.props.onFocus&&this.props.onFocus(e)};onBlur=e=>{this.context.messageBus.broadcast(new u.Yl(this.input,!1));const t=e.target.value,{onBlur:i,onDone:n}=this.props;i?i(t):n&&n(t)};setRef=e=>{this.input=e};render(){const{placeholder:e,tabIndex:t,maxLength:i,type:n,className:s,readOnly:a,disabled:o}=this.props,{currentText:r}=this.state;return(0,m.jsx)("div",{className:c()("text-field",s),children:(0,m.jsx)("input",{ref:this.setRef,className:"text-input-box",type:n||"text",value:r,placeholder:e,"aria-label":e,maxLength:i,onInput:this.onInput,onKeyPress:this.onKeyPress,onKeyDown:this.onKeyPress,onKeyUp:this.stopPropagation,onBlur:this.onBlur,onFocus:this.onFocus,tabIndex:t,readOnly:a,disabled:!!o})})}})||a)||a)||a)},43590:(e,t,i)=>{"use strict";i.d(t,{o:()=>n});const n=(0,i(96540).createContext)(null)},91048:(e,t,i)=>{"use strict";i.d(t,{M:()=>l});var n=i(39869),s=i(56147),a=i(19389),o=i(48270),r=i(40104),d=i(74848);function l(e){let{id:t,icon:i,label:l,selected:c,onToggled:h}=e;const u=(0,n.Y)();return(0,d.jsx)(a.$,{icon:i,label:l,ariaLabel:c?u.t(s.A.SHOWCASE.SEARCH.FILTER_SEARCH_SELECTED):l,size:o.M.SMALL,variant:o.A.TERTIARY,onClick:h,appendChildren:!1,children:(0,d.jsx)("div",{className:"search-filter-selected",children:c&&(0,d.jsx)(r.I,{name:"checkmark"})})},t)}},41176:(e,t,i)=>{"use strict";i.d(t,{x:()=>K});var n=i(96540),s=i(32485),a=i.n(s),o=i(56147),r=i(39869),d=i(93877),l=i(74481),c=i(64695);const h=(0,n.createContext)({includeInMemory:!1});var u=i(38731),m=i(53289),p=i(84917);var g=i(27817),v=i(99438);function f(e){return e?e.floors.getOrderedValues():[]}var y=i(50659),w=i(2716),b=i(93369);function T(e=!0){const t=function(){const e=(0,v._)(),[t,i]=(0,n.useState)(f(e));return(0,n.useEffect)((()=>{if(!e)return()=>{};const t=()=>i(f(e)),n=e.floors.getCollection().onChanged(t);return t(),()=>n.cancel()}),[e]),t}();return S((0,c.W)(),t,d.Hj.FLOOR,e)}function D(e=!0){return S((0,c.W)(),function(){const e=[];for(const t in p.T)e.push({id:t});const[t]=(0,n.useState)(e);return t}(),d.Hj.DATE,e)}function S(e,t,i,s){const a=(0,g.w)(),[o,r]=(0,n.useState)([]);return(0,n.useEffect)((()=>{if(!a)return()=>{};const n=t.reduce(((e,t,n)=>Object.assign(Object.assign({},e),{[t.id]:{id:t.id,grouping:i,groupOrder:n,items:[],batchSupported:!0}})),{}),o={};e.forEach((e=>{const t=e.getGroupingId(i);if(t&&n[t])t&&n[t].items.push(e);else{const t=e.getGroupingId(d.Hj.TYPE);if(t){const i=a.getSearchDataTypeGroup(t);o[t]||(o[t]={id:t,grouping:d.Hj.TYPE,groupOrder:(0,b.E)(a,t,d.Hj.TYPE),items:[],batchSupported:i.batchSupported}),o[t].items.push(e)}}}));let l=Object.values(n);return s&&(l=l.filter((e=>e.items.length>0))),r(l.concat(Object.values(o))),()=>{}}),[a,e,t,i,s]),o}var C=i(16112),E=i(95072);var A=i(78115),P=i(58024),I=i(16700),k=i(64737),N=i(74848);function x(e){let{item:t,itemHeight:i,renderItem:n,renderItemProps:s={}}=e;const a=n;return(0,N.jsx)("div",{className:"mp-nova-vlist-item",style:{height:i},children:(0,N.jsx)(a,{item:t,...s})})}function M(e){let{items:t,itemHeight:i,intersectionRef:s,renderItem:a,itemKeyProp:o,renderItemProps:r,forceRender:d}=e;const l=(0,n.useRef)(null),[c,h]=(0,n.useState)(!1);(0,n.useEffect)((()=>{if(!l.current||!s)return;const e=new IntersectionObserver((e=>{h(e[0].isIntersecting)}),{root:s});return e.observe(l.current),()=>{e.disconnect()}}),[l,s]);const u=c||d;return(0,N.jsx)("div",{className:"mp-nova-vlist-chunk",ref:l,style:{height:t.length*i},children:u&&t.map(((e,t)=>(0,N.jsx)(x,{index:t,item:e,itemHeight:i,renderItem:a,renderItemProps:r},function(e,t){return e[t]}(e,o))))})}function O(e){let{items:t,chunkSize:i=50,itemHeight:s=40,itemKeyProp:o="id",renderItem:r,renderItemProps:d,intersectionRef:l,style:c,showItemWithIndex:h=-1}=e;const[u,m]=(0,n.useState)(null),p=(0,n.useCallback)((e=>{null!==e&&m(e)}),[]),g=[];for(let e=0;e<t.length;e+=i){const n=h>=e&&h<e+i;g.push((0,N.jsx)(M,{itemHeight:s,intersectionRef:l||u,renderItem:r,renderItemProps:d,items:t.slice(e,e+i),itemKeyProp:o,forceRender:n},e))}return(0,N.jsx)("div",{className:a()("mp-nova-vlist",{"mp-nova-vlist-scrollable":!l}),ref:p,style:c,children:(0,N.jsx)("div",{className:"mp-nova-vlist-chunks",children:g})})}let R=0;function L(e){let{group:t,index:i,itemHeight:s,showItemWithIndex:o,active:r}=e;const{GroupRenderer:d,EmptyRenderer:l,ItemRenderer:c,itemRendererProps:h={},isCollapsed:u,intersectionRef:m}=(0,n.useContext)(k.C),p=(0,n.useRef)(null),g=(0,n.useMemo)((()=>(R++,`${"AccordionPanel"}-${R}`)),[]),v=u(t.id);let f,y={};t.items.length>0?(y={height:v?"0":t.items.length*s+"px"},f=(0,N.jsx)(O,{intersectionRef:m,renderItem:c,renderItemProps:h,items:t.items,itemHeight:s,showItemWithIndex:o})):(y={height:v?"0":`${s}px`},f=l?(0,N.jsx)(l,{group:t}):(0,N.jsx)(c,{item:null,...h}));const w=a()("mp-nova-accordion-panel",{active:r,collapsed:v});return(0,N.jsxs)("section",{role:"region",className:w,"aria-labelledby":g,children:[(0,N.jsx)("div",{id:g,children:(0,N.jsx)(d,{group:t})}),(0,N.jsx)("div",{className:"mp-accordion-panel-contents",style:y,ref:p,children:f})]})}function V(e){let{className:t,data:i,itemHeight:s,renderEmpty:o,renderGroup:r,renderItem:d,renderItemProps:l,activeGroupId:c,collapsedIds:h={},collapseEmptyGroups:u=!1,defaultCollapsed:m=!1,onToggleCollapse:p,preventCollapsing:g,ariaExpandLabel:v,ariaCollapseLabel:f,ref:y}=e;const w=(0,I.bt)("mp-nova-accordion"),b=(0,n.useRef)(null),[T,D]=(0,n.useState)(-1),[S,C]=(0,n.useState)(null),E=(0,n.useCallback)((e=>{const t=i.find((t=>t.id===e));return!!t&&0===t.items.length}),[i]),A=(0,n.useCallback)((e=>void 0!==h[e]?h[e]:u&&E(e)||m),[h,u,E,m]),P=(0,n.useCallback)((e=>{if(p){const t=!A(e);p(e,t)}}),[A,p]);(0,n.useImperativeHandle)(y,(()=>({focusGroupItem:(e,t)=>{A(e)&&P(e),C(e),D(t)},scrollIntoView:e=>{if(b.current){const t=b.current.querySelector(e);if(t)return t.scrollIntoView({behavior:"smooth",block:"center"}),!0}return!1}})),[A,P]);const x=b.current?b.current.parentNode:null,M=a()("mp-nova-accordion",w,t);return(0,N.jsx)("div",{className:M,ref:b,children:(0,N.jsx)(k.C.Provider,{value:{intersectionRef:x,GroupRenderer:r,EmptyRenderer:o,ItemRenderer:d,itemRendererProps:l,toggleGroup:P,isCollapsed:A,collapsible:!g,ariaExpandLabel:v,ariaCollapseLabel:f},children:i.map(((e,t)=>(0,N.jsx)(L,{itemHeight:s,index:t,group:e,active:e.id===c,showItemWithIndex:e.id===S?T:-1},e.id)))})})}var j=i(91435);const{SEARCH:B}=o.A.SHOWCASE,F=e=>{let{group:t}=e;const i=(0,r.Y)().t(B.EMPTY_LIST_MESSAGE);return(0,N.jsx)(j.t,{message:i})};var H=i(43590);function U(e){const{excludeEmptyGroups:t}=e,i=T(t);return(0,N.jsx)(W,{...e,dataGroups:i})}function _(e){const{excludeEmptyGroups:t}=e,i=function(e=!0){const t=(0,y.N)();return S((0,c.W)(),t,d.Hj.ROOM,e)}(t);return(0,N.jsx)(W,{...e,dataGroups:i})}function G(e){const{excludeEmptyGroups:t}=e,i=D(t);return(0,N.jsx)(W,{...e,dataGroups:i})}function z(e){const{excludeEmptyGroups:t}=e,i=(0,n.useContext)(H.o),s=function(e,t=!0){const i=(0,C.f)(e),n=Object.values(i).sort(((e,t)=>(e.groupOrder||E.X$)-(t.groupOrder||E.X$))).map((e=>({id:e.id,grouping:d.Hj.TYPE,groupOrder:e.groupOrder||E.X$,items:e.matches,batchSupported:e.batchSupported})));return t?n.filter((e=>e.items.length>0)):n}(i?.sourceViewId||"",t);return(0,N.jsx)(W,{...e,dataGroups:s})}function $(e){const{excludeEmptyGroups:t}=e,i=(0,u.B)(),{includeInMemory:s}=(0,n.useContext)(h),a=function(e=!0,t=!1){const i=(0,w.z)(t);return S((0,c.W)(),i,d.Hj.LAYER,e)}(t,!s),o=(0,P.z0)(),r=i&&o?.id||void 0,[l,p]=(0,n.useState)(void 0),g=(0,n.useCallback)((()=>{p(void 0)}),[]);return(0,m.J)(A.V7,(e=>{let{layerId:t}=e;p(t)})),(0,N.jsx)(W,{...e,dataGroups:a,activeGroupId:r,scrollToGroupId:l,onScrolled:g})}function W(e){const{renderGroup:t,renderItem:i,dataGroups:s,activeItemId:a,activeGroupId:d,scrollToGroupId:c,onScrolled:h,collapseWhenNotSearching:u}=e,m=(0,n.useRef)(null),p=(0,l.M)(),g=(0,n.useRef)(void 0),v=(0,r.Y)(),f=(0,I.XW)(),[y,w]=(0,n.useState)({}),[b,T]=(0,n.useState)(!p&&u),D=(0,n.useCallback)(((e,t)=>{w({...y,[e]:t})}),[y]);(0,n.useEffect)((()=>(window.clearTimeout(g.current),p?(g.current=window.setTimeout((()=>{w({}),T(!1)}),300),()=>{window.clearTimeout(g.current)}):(w({}),T(u),()=>{}))),[p,w,T,u]),(0,n.useEffect)((()=>{if(!c)return;const e=m.current?.scrollIntoView(`[data-id='${c}']`);e&&h?.()}),[c,h]),(0,n.useEffect)((()=>{if(a){let e=-1;const t=s.find((t=>{const i=t.items.findIndex((e=>e.id===a));return-1!==i&&(e=i,!0)}))?.id;m.current&&t&&m.current.focusGroupItem(t,e)}return()=>{}}),[s,a,m]);const S="aura"===f?44:60;return(0,N.jsx)(V,{ref:m,ariaExpandLabel:v.t(o.A.ACCORDIONS.EXPAND),ariaCollapseLabel:v.t(o.A.ACCORDIONS.COLLAPSE),data:s,itemHeight:S,renderItem:i,renderGroup:t,renderEmpty:F,onToggleCollapse:D,collapsedIds:y,activeGroupId:d,collapseEmptyGroups:s.length>1,defaultCollapsed:b})}const{SEARCH:Y}=o.A.SHOWCASE;function K(e){const{excludeEmptyGroups:t,activeItemId:i,grouping:s,emptyPhrase:o,collapseWhenNotSearching:h=!1}=e,u=(0,n.useRef)(null),p=(0,r.Y)(),g=(0,l.M)(),v=(0,c.W)(),f=function(){const[e,t]=(0,n.useState)(!1),i=(0,n.useCallback)((e=>()=>t(e)),[]);return(0,m.J)(A.MT,i(!0)),(0,m.J)(A.tj,i(!1)),e}(),y=0===v.length,w=s===d.Hj.FLOOR,b=s===d.Hj.ROOM,T=s===d.Hj.LAYER,D=s===d.Hj.DATE,S=void 0!==t?t:g,C=p.t(o||Y.EMPTY_LIST_MESSAGE),E=!!S&&y,P={...e,scrollRef:u?.current,excludeEmptyGroups:S,activeItemId:i,collapseWhenNotSearching:h};return E?(0,N.jsx)(j.t,{message:C}):(0,N.jsxs)("div",{className:a()("list-contents","searchable-list",{pending:f}),ref:u,children:[w?(0,N.jsx)(U,{...P}):b?(0,N.jsx)(_,{...P}):T?(0,N.jsx)($,{...P}):D?(0,N.jsx)(G,{...P}):(0,N.jsx)(z,{...P}),e.children]})}},55384:(e,t,i)=>{"use strict";i.d(t,{m:()=>I});var n=i(56147),s=i(39869),a=i(93877),o=i(99438),r=i(96540),d=i(51469),l=i(30169);var c=i(4717),h=i(12621),u=i(32485),m=i.n(u),p=i(64737),g=i(19389),v=i(16700),f=i(74848);function y(e){let{collapsed:t,onClick:i,style:n,ariaLabel:s}=e;const a=(0,v.bt)("mp-nova-accordion-toggle"),o=m()("mp-nova-accordion-toggle",a,{collapsed:t});return(0,f.jsx)(g.$,{className:o,icon:"dpad-up",onClick:i,style:n,ariaLabel:s})}var w=i(91977),b=i(34674);function T(e){let{actions:t,className:i,onClick:n,...s}=e;const{toggleGroup:a,isCollapsed:o,collapsible:d,ariaExpandLabel:l,ariaCollapseLabel:c}=(0,r.useContext)(p.C),h=(0,v.bt)("mp-nova-accordion-header"),{id:u}=s,g=o(u)&&d,T=g?l:c,D=m()("mp-nova-accordion-header",h,i,{collapsed:g,collapsible:d}),S=(0,f.jsxs)(w.e,{children:[t,d&&(0,f.jsx)(y,{collapsed:g,onClick:e=>{e.stopPropagation(),a(u)},ariaLabel:T})]});return(0,f.jsx)(b.c,{...s,className:D,onClick:()=>{let e=!1;n&&(e=n(g)),d&&!e&&a(u)},actions:S,variant:"header"})}function D(e){let{id:t,numItems:i}=e;const n=(0,c.G)(),s=(0,h._)(t,n);let a;return void 0!==i&&(a=(0,f.jsx)("span",{className:"mp-list-item-text",children:`(${i})`})),(0,f.jsx)(T,{id:t,title:s,className:"layers-group-header",decals:a})}var S=i(16112),C=i(13397);function E(e){let{dataTypeGroup:t}=e;return t.groupActionsFC?(0,f.jsx)(t.groupActionsFC,{group:t}):null}function A(e){const{id:t,numItems:i,numSelected:n,selected:a,selectDisabled:o,selectMode:r,onSelect:d}=e,l=(0,S.f)(""),c=(0,C.e)(),h=(0,s.Y)(),u=l[t];if(!u)return null;const m=c&&u.groupMatchingPhraseKey||u.groupPhraseKey,p=m?h.t(m):t;let g;if(void 0!==i){const e=r?`${n}/${i}`:`${i}`;g=(0,f.jsx)("span",{className:"mp-list-item-text",children:`(${e})`})}return(0,f.jsx)(T,{id:t,title:p,decals:g,actions:(0,f.jsx)(E,{dataTypeGroup:u}),selectMode:r,selectDisabled:o,selected:a,onSelect:d})}function P(e){const{id:t,numItems:i,numSelected:n,selected:a,selectMode:o,onSelect:r}=e,d=(0,s.Y)().t(`SHOWCASE.NOTES.${t}`);let l;if(void 0!==i){const e=o?`${n}/${i}`:`${i}`;l=(0,f.jsx)("span",{className:"mp-list-item-text",children:`(${e})`})}return(0,f.jsx)(T,{id:t,title:d,decals:l,selectMode:o,selected:a,onSelect:r})}const I=e=>{let{group:t}=e;const{id:i,grouping:n}=t;switch(n){case a.Hj.TYPE:return(0,f.jsx)(A,{id:i});case a.Hj.FLOOR:return(0,f.jsx)(k,{id:i});case a.Hj.ROOM:return(0,f.jsx)(N,{id:i});case a.Hj.DATE:return(0,f.jsx)(P,{id:i});case a.Hj.LAYER:return(0,f.jsx)(D,{id:i})}};function k(e){let{id:t,numItems:i}=e;const a=(0,o._)();let r,d=(0,s.Y)().t(n.A.FLOOR_ALL);return a&&t&&(d=a.getFloorName(t)),void 0!==i&&(r=(0,f.jsx)("span",{className:"mp-list-item-text",children:`(${i})`})),(0,f.jsx)(T,{id:t,title:d,decals:r})}function N(e){let{id:t,numItems:i}=e;const n=function(e){const t=(0,d.N)(),i=(0,s.Y)(),[n,a]=(0,r.useState)((0,l.Ay)(e,i,t));return(0,r.useEffect)((()=>{if(!t)return()=>{};function n(){a((0,l.Ay)(e,i,t))}const s=t.onRoomsChanged({onUpdated:n});return n(),()=>s.cancel()}),[i,t,e]),n}(t);let a;return void 0!==i&&(a=(0,f.jsx)("span",{className:"mp-list-item-text",children:`(${i})`})),(0,f.jsx)(T,{id:t,title:n,decals:a})}},17651:(e,t,i)=>{"use strict";i.d(t,{M:()=>F});var n=i(96540),s=i(32485),a=i.n(s),o=i(56147),r=i(73566),d=i(17084),l=i(78956),c=i(64057),h=i(39869),u=i(27200),m=i(12103),p=i(13397),g=i(59475),v=i(75410),f=i(94547),y=i(81609),w=i(66726),b=i(19389),T=i(48270),D=i(35404),S=i(68375),C=i(38731),E=i(50747),A=i(74848);function P(e){const{query:t,keywordFilters:i,typeFilters:s}=e,a=(0,C.B)(),r=(0,h.Y)(),d=(0,E.F)(),l=(0,S.s)(),[c,u]=(0,n.useState)(!1),m=a||d.tryGetSetting(D.wD,!1),p=(0,n.useCallback)((()=>{const e=(0,w.Cz)(t,i,s);(0,y.l)(e),u(!0);const n=a?"workshop_gui":"showcase_gui";l.track(n,{gui_action:"space_search_share_link_clicked"})}),[t,i,s,a,l]);return(0,n.useEffect)((()=>{if(!c)return()=>{};const e=window.setTimeout((()=>u(!1)),2500);return()=>window.clearTimeout(e)}),[c]),m?c?(0,A.jsx)("span",{className:"link-copied",children:r.t(o.A.SHARE_COPIED)}):(0,A.jsx)(b.$,{onClick:p,icon:"share",variant:T.A.TERTIARY,tooltip:r.t(o.A.COPY_URL)}):null}var I=i(16700),k=i(41984),N=i(71188),x=i(78197),M=i(90087);const{SEARCH:O}=o.A.SHOWCASE;function R(e){let{filter:t,readOnly:i,shareEnabled:s}=e;const o=(0,M.L)(),y=(0,n.useRef)(null),w=(0,n.useRef)(null),D=(0,h.Y)(),S=(0,l.O)(),C=(0,c.J)(),E=(0,p.e)(),R=(0,g.e)(),L=(0,v.h)(),V=(0,n.useMemo)((()=>(0,u.C8)()),[]),j=S===r.L$.BOTTOM_PANEL&&C,B=(0,N.w)((0,x.A)()),F=(0,I.bt)("search-panel-header"),H=(0,n.useCallback)((e=>{o.issueCommand(new f.tA(e))}),[o]),U=D.t(O.SEARCH_IN_TOOL_PLACEHOLDER),_=D.t(O.CLEAR_SEARCH).toLocaleUpperCase(),G=R.length>0||L.length>0||""!==E,z=s&&G,$=V?void 0:m.JO;return(0,A.jsxs)("div",{ref:w,className:a()("list-search","search-panel-header",F),children:[(0,A.jsxs)("div",{className:"search-bar",children:[(0,A.jsx)("span",{className:a()("search-header-icon","icon","icon-magnifying-glass",{"search-header-icon-active":G})}),(0,A.jsx)(k.A,{text:E,onInput:H,onDone:e=>{j&&e&&o.issueCommand(new d.li(!1))},onCancel:()=>{o.issueCommand(new d.Te)},placeholder:U,onFocus:()=>{B&&j&&V&&(o.issueCommand(new d.li(!1)),window.setTimeout((()=>{w.current&&w.current.scrollIntoView({behavior:"smooth",block:"start"})}),m.JO))},ref:y,focusOnMount:$,className:"search-panel-header-input",readOnly:i}),(0,A.jsxs)("div",{className:"search-header-button-container",children:[""!==E&&(0,A.jsx)(b.$,{onClick:()=>{H(""),y.current&&!V&&y.current.focus()},label:_,size:T.M.SMALL,variant:T.A.TERTIARY}),z&&(0,A.jsx)(P,{query:E,keywordFilters:R,typeFilters:L})]})]}),t]})}var L=i(16112);const{SEARCH:V}=o.A.SHOWCASE;function j(e){let{id:t,label:i}=e;const n=(0,M.L)(),s=(0,h.Y)().t(V.FILTER_SEARCH_REMOVE);return(0,A.jsx)(b.$,{icon:"close",label:i,tooltip:s,tooltipOptions:{placement:"bottom"},size:T.M.SMALL,variant:T.A.FAB,theme:"dark",onClick:()=>{n.issueCommand(new f._w(t,!1))},reverse:!0})}function B(){const e=(0,h.Y)(),t=(0,L.f)(""),i=(0,v.h)();if(0===i.length)return null;const n=[];return i.forEach((i=>{const s=t[i];if(s){const t=e.t(s.groupPhraseKey);n.push((0,A.jsx)(j,{id:i,label:t},i))}})),(0,A.jsx)("div",{className:"search-filter-pills",children:n})}function F(e){const{shareEnabled:t=!1,filterPills:i=!1,filter:n}=e;return(0,A.jsxs)("div",{className:"list-subheaders",children:[(0,A.jsx)(R,{filter:n,shareEnabled:t}),i&&(0,A.jsx)(B,{})]})}},91435:(e,t,i)=>{"use strict";i.d(t,{t:()=>o});var n=i(32485),s=i.n(n),a=i(74848);const o=e=>{let{className:t="",itemHeight:i,message:n}=e;const o=s()("nova-empty-list-item",{[`${t}`]:!!t}),r={height:i||void 0};return(0,a.jsx)("div",{className:o,style:r,children:n&&(0,a.jsx)("p",{className:"message",children:n})})}},34674:(e,t,i)=>{"use strict";i.d(t,{c:()=>d});var n=i(32485),s=i.n(n),a=i(56453),o=i(16700),r=i(74848);function d(e){let{title:t,className:i,variant:n,actions:d,badge:l,decals:c,active:h=!1,selected:u=!1,disabled:m=!1,selectMode:p=!1,selectDisabled:g=!1,onSelect:v,id:f,onClick:y,onMouseEnter:w,onMouseLeave:b,ref:T}=e;const D=(0,o.bt)("mp-nova-list-item"),S=s()("mp-nova-list-item",D,i,{[`mp-nova-list-item-${n}`]:void 0!==n,"mp-nova-disabled":m,"mp-nova-multi-select":p,interactive:!!y,selected:u,active:h});return(0,r.jsxs)("div",{className:S,onClick:y,onMouseEnter:w,onMouseLeave:b,"data-id":f,ref:T,children:[p&&(0,r.jsx)(a.S,{id:`mp-list-checkbox-${f}`,defaultChecked:u,onChange:v,onClick:e=>e.stopPropagation(),disabled:g}),l&&(0,r.jsx)("span",{className:"mp-list-item-badge",children:l}),(0,r.jsxs)("span",{className:"mp-list-item-title",children:[(0,r.jsx)("span",{className:"mp-list-item-text",children:t}),c&&(0,r.jsx)("span",{className:"mp-list-item-decals",children:c})]}),d&&(0,r.jsx)("span",{className:"mp-list-item-actions",children:d})]})}},63360:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"FileAttachments"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"pageSize"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Int"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"fileAttachmentsByModelId"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"pageSize"},value:{kind:"Variable",name:{kind:"Name",value:"pageSize"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"results"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteFileAttachment"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"id"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteFileAttachment"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"id"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"FileAttachmentDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"FileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"bytes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mimeType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"downloadUrl"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ImageFileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"imageWidth"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"imageHeight"},arguments:[],directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"UploadFileAttachmentToModel"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"organizationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"contents"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"FileUpload"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"filename"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"uploadFileAttachmentToModel"},arguments:[{kind:"Argument",name:{kind:"Name",value:"organizationId"},value:{kind:"Variable",name:{kind:"Name",value:"organizationId"}}},{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"contents"},value:{kind:"Variable",name:{kind:"Name",value:"contents"}}},{kind:"Argument",name:{kind:"Name",value:"filename"},value:{kind:"Variable",name:{kind:"Name",value:"filename"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}],loc:{start:0,end:809}};t.loc.source={body:"# read all attachments for the specified model\nquery FileAttachments($modelId: ID!, $pageSize: Int!) {\n  fileAttachmentsByModelId(modelId: $modelId, pageSize: $pageSize) {\n    results { ...FileAttachmentDetails }\n  }\n}\n\nmutation DeleteFileAttachment($id: ID!) {\n  deleteFileAttachment(id: $id)\n}\n\nfragment FileAttachmentDetails on FileAttachment {\n  id\n  created\n  filename\n  url\n  validUntil\n  bytes\n  mimeType\n  downloadUrl\n  ...on ImageFileAttachment {\n      imageWidth\n      imageHeight\n  }\n}\n\nmutation UploadFileAttachmentToModel($organizationId: ID!, $modelId: ID!, $contents: FileUpload!, $filename: String!) {\n  uploadFileAttachmentToModel(organizationId: $organizationId, modelId: $modelId,\n                              contents: $contents, filename: $filename) {\n    ...FileAttachmentDetails\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function s(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function a(e,t){var i={kind:e.kind,definitions:[s(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=n[t]||new Set,o=new Set,r=new Set;for(a.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=s(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.FileAttachments=a(t,"FileAttachments"),e.exports.DeleteFileAttachment=a(t,"DeleteFileAttachment"),e.exports.FileAttachmentDetails=a(t,"FileAttachmentDetails"),e.exports.UploadFileAttachmentToModel=a(t,"UploadFileAttachmentToModel")},44354:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}},type:{kind:"NamedType",name:{kind:"Name",value:"Float"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"ids"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}},type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"objectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"inferenceEvents"},value:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}}},{kind:"Argument",name:{kind:"Name",value:"minimumConfidenceOverride"},value:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}}},{kind:"Argument",name:{kind:"Name",value:"ids"},value:{kind:"Variable",name:{kind:"Name",value:"ids"}}},{kind:"Argument",name:{kind:"Name",value:"includeDisabled"},value:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AddObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationDetails"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"addObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotation"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PatchObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"data"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationPatch"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}},{kind:"Argument",name:{kind:"Name",value:"patch"},value:{kind:"Variable",name:{kind:"Name",value:"data"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"SetBulkObjectAnnotationsEnabled"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}},type:{kind:"NonNullType",type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"setBulkObjectAnnotationsEnabled"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationIds"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}}},{kind:"Argument",name:{kind:"Name",value:"setEnabled"},value:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ObjectAnnotationInfo"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotation"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"modified"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"room"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[{kind:"Directive",name:{kind:"Name",value:"include"},arguments:[{kind:"Argument",name:{kind:"Name",value:"if"},value:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}}}]}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"enabled"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"region"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"VectorRegion"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"anchorPosition"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemNormal"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemLength"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"tag"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"keywords"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"classification"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultKeywords"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:1971}};t.loc.source={body:"# Object Tag Suggestions\n# Reference: https://matterport.atlassian.net/wiki/spaces/EX/pages/44320356/Object+Detection+-+Workshop+Suggestions\n\nquery GetObjectAnnotations($modelId: ID!, $inferenceEvents: [ID!], $minConfidence: Float, $ids: [ID!], $includeDisabled: Boolean, $includeLayers: Boolean!) {\n  model(id: $modelId) {\n    objectAnnotations(inferenceEvents: $inferenceEvents, minimumConfidenceOverride: $minConfidence, ids: $ids, includeDisabled: $includeDisabled) {\n      ...ObjectAnnotationInfo\n    }\n  }\n}\n\nmutation AddObjectAnnotation($modelId: ID!, $objectAnnotation: ObjectAnnotationDetails!, $includeLayers: Boolean!) {\n  addObjectAnnotation(modelId: $modelId, objectAnnotation: $objectAnnotation) {\n    ...ObjectAnnotationInfo\n  }\n}\n\n# Update a single object annotation\nmutation PatchObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!, $data: ObjectAnnotationPatch!, $includeLayers: Boolean!) {\n  patchObjectAnnotation(modelId: $modelId, , objectAnnotationId: $objectAnnotationId, patch: $data) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation SetBulkObjectAnnotationsEnabled($modelId: ID! $objectAnnotationIds:[ID!]!, $setEnabled: Boolean!, $includeLayers: Boolean!) {\n  setBulkObjectAnnotationsEnabled(modelId: $modelId, objectAnnotationIds: $objectAnnotationIds, setEnabled: $setEnabled) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation DeleteObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!) {\n  deleteObjectAnnotation(modelId: $modelId, objectAnnotationId: $objectAnnotationId)\n}\n\nfragment ObjectAnnotationInfo on ObjectAnnotation {\n  id\n  created\n  modified\n  model {\n    id\n  }\n  floor {\n    id\n  }\n  room {\n    id\n  }\n  layer @include(if: $includeLayers) { id } \n  enabled\n  label\n  confidence\n  region {\n    ... on VectorRegion {\n      anchorPosition {\n        x, y, z\n      }\n      stemNormal {\n        x, y, z\n      }\n      stemLength\n    }\n  }\n  tag {\n    id\n  }\n  keywords\n  classification {\n    id,\n    label,\n    defaultKeywords\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function s(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function a(e,t){var i={kind:e.kind,definitions:[s(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=n[t]||new Set,o=new Set,r=new Set;for(a.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=s(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.GetObjectAnnotations=a(t,"GetObjectAnnotations"),e.exports.AddObjectAnnotation=a(t,"AddObjectAnnotation"),e.exports.PatchObjectAnnotation=a(t,"PatchObjectAnnotation"),e.exports.SetBulkObjectAnnotationsEnabled=a(t,"SetBulkObjectAnnotationsEnabled"),e.exports.DeleteObjectAnnotation=a(t,"DeleteObjectAnnotation"),e.exports.ObjectAnnotationInfo=a(t,"ObjectAnnotationInfo")},80164:()=>{},10689:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>T});var n=i(64882),s=i(90082),a=i(71687),o=i(94165),r=i(62568),d=i(10459),l=i(12837),c=i(73065),h=i(40742),u=i(57811),m=i(60152),p=i(90160),g=i(25443),v=i(71397),f=i(23500),y=i(75522),w=i(86325),b=i(47299);class T extends n.n{constructor(){super(...arguments),this.name="quick-menus"}async init(e,t){this.settingsModule=await t.getModuleBySymbol(s.ZF),this.scanInfoDataModule=await t.getModuleBySymbol(a.He),this.settingsGui=this.settingsModule.getSettingsGui();const i=await t.getModuleBySymbol(o.r),n=await t.market.waitForData(l.A),T=await t.market.waitForData(g.o),D=await t.market.waitForData(d.M);this.uIndex=this.settingsGui.addPanel("Link to location",[v.D.U],{allowSubGroups:!1,width:400,ratio:90});const S=[38,38,40,40,37,39,37,39,66,65,v.D.O];this.oIndex=this.settingsGui.addPanel("Scan Info",S,{allowSubGroups:!1,width:400,ratio:75}),this.pIndex=this.settingsGui.addPanel("Quick settings",[v.D.P],{allowSubGroups:!1}),this.settingsGui.loadPromise.then((()=>{this.settingsGui.addControl(this.uIndex,"","Link",{}),this.settingsGui.addButton(this.uIndex,"","Copy to clipboard",(()=>{const e=document.createElement("input");e.type="text",e.value=this.buildLink(i),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)})),this.settingsGui.toggle(this.uIndex),this.settingsGui.addControl(this.oIndex,"","Scan ID",{}),this.settingsGui.addControl(this.oIndex,"","Anchor ID",{}),this.settingsGui.addControl(this.oIndex,"","Created",{}),this.settingsGui.addControl(this.oIndex,"","Time of Day",{}),this.settingsGui.addControl(this.oIndex,"","Alignment",{}),this.settingsGui.addControl(this.oIndex,"","Options",{}),this.settingsGui.addControl(this.oIndex,"","Camera",{}),this.settingsGui.addControl(this.oIndex,"","Camera Types",{}),this.settingsGui.addControl(this.oIndex,"","Sensor Serials",{}),this.settingsGui.addControl(this.oIndex,"","Serial Number",{}),this.settingsGui.addControl(this.oIndex,"","Mount Calibration",{}),this.settingsGui.addControl(this.oIndex,"","Software Version",{}),this.settingsGui.addButton(this.oIndex,"","Copy Scan ID",(async()=>{if(n.currentSweepObject){const e=await this.scanInfoDataModule.getScanInfo(n.currentSweepObject.platformId);if(e){const t=document.createElement("input");t.type="text",t.value=e.id,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}}})),this.settingsGui.addButton(this.oIndex,"","Download Scan",(async()=>{if(n.currentSweepObject){const e=await this.scanInfoDataModule.getScanDownloadURL(n.currentSweepObject.platformId);e&&window.open(e)}})),this.settingsGui.toggle(this.oIndex);const e=c.V$*(180/Math.PI)*60;this.settingsGui.addControl(this.pIndex,"",u.f,!0),this.settingsGui.addControl(this.pIndex,"",f.s,!0),this.settingsGui.addControl(this.pIndex,"",y.qE,!0),this.settingsGui.addControl(this.pIndex,"",w.Q,!0),this.settingsGui.addSlider(this.pIndex,"",b.Vp,b.lg,0,100,1),this.settingsGui.addSlider(this.pIndex,"",h.lookAccelerationKey,e,.25,10,2),this.settingsGui.addSlider(this.pIndex,"",r.l6,r.Ay.camera.baseTransitionTime,1,5e3,0);const t=T.tryGetSetting(m._V,m.aS);this.settingsGui.addSlider(this.pIndex,"",m.d6,(0,p.wg)(t),.5,10,2),this.settingsGui.toggle(this.pIndex),this.settingsModule.registerSetting("Quick settings",h.lookAccelerationKey,e,!1),this.settingsModule.registerSetting("Quick settings",r.l6,r.Ay.camera.baseTransitionTime,!1),this.settingsModule.registerSetting("Quick settings",b.Vp,b.lg,!1),this.settingsGui.onToggle(this.uIndex,(e=>{e&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i))})),this.settingsGui.onToggle(this.oIndex,(e=>{e&&this.refreshScanInfo(n)})),D.pose.onChanged((()=>{this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.uIndex)&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i)),this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.oIndex)&&this.refreshScanInfo(n)})),T.onSettingChanged(m.d6,(e=>{T.setSetting(m._V,(0,p.A0)(e))}))}))}refreshScanInfo(e){e.state.currentSweep?this.scanInfoDataModule.getScanInfo(e.state.currentSweep).then((e=>{this.updateScanInfo(e)})):this.updateScanInfo(void 0)}updateScanInfo(e){this.settingsGui.updateSetting(this.oIndex,"Scan ID",e?e.id:""),this.settingsGui.updateSetting(this.oIndex,"Anchor ID",e?e.anchorId:""),this.settingsGui.updateSetting(this.oIndex,"Created",e?e.created:""),this.settingsGui.updateSetting(this.oIndex,"Time of Day",e?e.timeOfDay:""),this.settingsGui.updateSetting(this.oIndex,"Alignment",e?e.alignment:""),this.settingsGui.updateSetting(this.oIndex,"Options",e?JSON.stringify(e.options):""),this.settingsGui.updateSetting(this.oIndex,"Camera",e?`${e.camera.vendor} ${e.camera.model}`:""),this.settingsGui.updateSetting(this.oIndex,"Camera Types",e?JSON.stringify(e.camera.cameraTypes):""),this.settingsGui.updateSetting(this.oIndex,"Sensor Serials",e?JSON.stringify(e.camera.sensorSerialNumbers):""),this.settingsGui.updateSetting(this.oIndex,"Serial Number",e?e.camera.serialNumber:""),this.settingsGui.updateSetting(this.oIndex,"Mount Calibration",e?e.camera.mountCalibrationVersion:""),this.settingsGui.updateSetting(this.oIndex,"Software Version",e?e.camera.softwareVersion:"")}buildLink(e){return decodeURIComponent(e.creator.createDeepLink().href)}}},84917:(e,t,i)=>{"use strict";var n;function s(e){const t=new Date;t.setHours(0,0,0,0),e.setHours(0,0,0,0);const i=(t.getTime()-e.getTime())/864e5;if(0===i)return n.TODAY;if(1===i)return n.YESTERDAY;if(i<7)return n.THIS_WEEK;const s=Math.floor(i/7);return 1===s?n.ONE_WEEK_AGO:2===s?n.TWO_WEEKS_AGO:3===s?n.THREE_WEEKS_AGO:n.OLDER}i.d(t,{T:()=>n,n:()=>s}),function(e){e.TODAY="TODAY",e.YESTERDAY="YESTERDAY",e.THIS_WEEK="THIS_WEEK",e.ONE_WEEK_AGO="ONE_WEEK_AGO",e.TWO_WEEKS_AGO="TWO_WEEKS_AGO",e.THREE_WEEKS_AGO="THREE_WEEKS_AGO",e.OLDER="OLDER"}(n||(n={}))},92899:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AnnotationAttachmentClickedMessage:()=>h.z,AnnotationBlockClickedMessage:()=>h.v,AnnotationType:()=>u.U,AnnotationsViewData:()=>d.o,default:()=>m});var n=i(64882),s=i(14614),a=i(9139),o=i(20246),r=i(47737),d=i(30926),l=i(22937);class c extends n.n{constructor(){super(...arguments),this.name="annotations",this.handleDockedAnnotationChanged=()=>{this.viewData.dockedAnnotation?this.engine.broadcast(new o.I7):this.engine.broadcast(new o.f1)}}async init(e,t){this.viewData=new d.o,this.engine=t,[this.applicationData,this.layersData]=await Promise.all([t.market.waitForData(s.zH),t.market.waitForData(r.P)]),this.bindings.push(t.subscribe(l.zM,(()=>this.closeBillboard())),this.applicationData.onPropertyChanged("application",(()=>this.closeOtherAnnotations())),this.layersData.onPropertyChanged("currentViewId",(()=>this.closeBillboard())),this.viewData.onDockedAnnotationChanged(this.handleDockedAnnotationChanged)),t.market.register(d.o,this.viewData)}dispose(e){this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],super.dispose(e)}onUpdate(){}dockAnnotation(e,t,i,n=!1){const s=this.viewData,{dockedAnnotation:o}=s;(this.viewData.getCapabilities(e).dock||n)&&((null==o?void 0:o.id)!==e||(null==o?void 0:o.annotationType)!==i?s.atomic((()=>{s.setDockedAnnotation(e,t,i),s.setBillboardAnnotation(null)})):a.Vy.for(this).debug("Annotation is already docked"))}selectAnnotation(e,t,i,n=!1){const s=this.viewData,{billboardAnnotation:o,billboardSelected:r}=s;(this.viewData.getCapabilities(e).preview||n)&&(r&&(null==o?void 0:o.id)===e&&(null==o?void 0:o.annotationType)===i?a.Vy.for(this).debug("Annotation is already selected"):s.atomic((()=>{s.setBillboardAnnotation(e,t,i,!0),s.setDockedAnnotation(null)})))}previewAnnotation(e,t,i){this.viewData.getCapabilities(e).preview&&this.viewData.setBillboardAnnotation(e,t,i,!1)}closeBillboard(){this.viewData.setBillboardAnnotation(null)}closeDockedAnnotation(){this.viewData.setDockedAnnotation(null)}closeOtherAnnotations(e,t){const i=this.viewData,{billboardAnnotation:n,dockedAnnotation:s}=i,a=n&&!this.isMatchingAnnotation(n,e,t),o=s&&!this.isMatchingAnnotation(s,e,t);i.atomic((()=>{n&&a&&i.setBillboardAnnotation(null),s&&o&&i.setDockedAnnotation(null)}))}isMatchingAnnotation(e,t,i){return!(!i&&!t)&&((!i||i===e.id)&&(!t||t===e.annotationType))}closeAnnotation(e,t){const i=this.viewData,{billboardAnnotation:n,dockedAnnotation:s}=i;i.atomic((()=>{e===(null==n?void 0:n.id)&&t===(null==n?void 0:n.annotationType)&&i.setBillboardAnnotation(null),e===(null==s?void 0:s.id)&&t===(null==s?void 0:s.annotationType)&&i.setDockedAnnotation(null)}))}}var h=i(40409),u=i(51831);const m=c},96304:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>H});var n=i(64882),s=i(9139),a=i(25712),o=i(74381),r=i(85453),d=i(3795),l=i(20968),c=i(75027),h=i(3101);class u{constructor(){this.getAttachmentDetails=e=>e.mediaType?{mediaType:(0,h.ft)(e.mediaType),srcUrl:e.src,thumbnailUrl:e.src,width:e.width,height:e.height}:null,this.validate=e=>!!e&&void 0!==e.mediaType}serialize(e){const t=this.getAttachmentDetails(e);return t&&this.validate(t)?t:null}}var m=i(87314),p=i(85275),g=i(6150),v=i(17246);const f=new s.Vy("AttachmentsStore");class y extends l.g{constructor(e){super(e),this.embedSerializer=new u,this.embedDeserializer=new m.g,this.fileDeserializer=new p.x}create(e){if(0===e.length)return Promise.resolve(null);const t=e[0].parentId,i=e[0].parentType;if(e.find((e=>e.parentId!==t||e.parentType!==i)))throw new Error("Cannot attach to different parents in one request");const n=this.getViewId(),s=[],a=[];let r,l;if(e.forEach((e=>{if(e.category===d._A.EXTERNAL){const t=this.embedSerializer.serialize(e);if(!t)throw f.error("Failure attaching external attachment:",e),new Error("Could not attach External Attachment");s.push(t)}else e.category===d._A.UPLOAD&&a.push(e.id)})),i!==o.pi.COMMENT)throw new Error(`Cannot attach to attachment to a ${i}`);return r=g.AddCommentAttachments,l="addCommentAttachments",this.mutate(r,{modelId:n,parentId:t,externalAttachments:s,fileAttachments:a}).then((e=>{const t=[],i=(0,c.L)(e,`data.${l}.externalAttachments`);if(i&&Array.isArray(i))for(const e of i){const i=this.embedDeserializer.deserialize(e);i&&t.push(i)}const n=(0,c.L)(e,`data.${l}.fileAttachments`);if(n&&Array.isArray(n))for(const e of n){const i=this.fileDeserializer.deserialize(e);i&&t.push(i)}return t.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async remove(e){const{id:t,parentId:i,parentType:n}=e,s=this.getViewId(),a=await this.mutate(v.RemoveFileAttachment,{modelId:s,attachmentId:t,parentType:n,parentId:i}),o=(0,c.L)(a,"data.removeFileAttachment")||!1;return o||f.error("remove file attachment failed!"),o}async delete(e,t,i){const n=this.getViewId();return Promise.all(e.map((e=>this.mutate(v.DeleteExternalAttachment,{modelId:n,attachmentId:e,parentType:i,parentId:t}))))}getViewId(){if(!this.viewId)throw new Error("Invalid valid id!");return this.viewId}}var w=i(23775),b=i(96276),T=i(84651),D=i(24790);class S{constructor(e){const{baseUrl:t}=e;this.config=e,this.context=e.context,this.client=new T.t({baseUrl:t,server:D.vE,mdsContext:e.context})}get readonly(){return this.config.readonly}async create(...e){throw new w.E}async read(e={}){throw new w.E}async update(...e){throw new w.E}async delete(...e){throw new w.E}async query(e,t,i={}){if(!this.context.baseViewId)throw new b.V("Cannot read Attachments, no model view configured");return this.client.query(e,t,i)}async mutate(e,t,i){const{readonly:n}=this.config;if(n)throw new b.n8("Cannot write Attachments, model is in read-only mode");if(!this.context.baseViewId)throw new b.V("Cannot write Attachments, no model view configured");return this.client.mutate(e,t,i)}}var C=i(63360),E=i(64391),A=i(81587),P=i(30740);const I=new s.Vy("file-upload-deserializer");class k{deserialize(e){if(!e||!this.validate(e))return I.debug("Deserialized invalid file attachment data from MDS",e),null;const t=new P.o;return t.id=e.id,t.created=(0,A.XH)(e.created),e.mimeType&&(t.mimeType=e.mimeType,t.mediaType=(0,h.uc)(e.mimeType)),t.downloadUrl=new E.f(e.downloadUrl||"",(0,A.XH)(e.validUntil,null)),t.url=new E.f(e.url||"",(0,A.XH)(e.validUntil,null)),t.filename=e.filename||"",t.bytes=e.bytes||0,t.category=d._A.UPLOAD,t.width=e.imageWidth||0,t.height=e.imageHeight||0,(0,h.L7)(t)&&(t.thumbnailUrl=t.url),t}validate(e){return["id","created","url","filename","mimeType","validUntil"].every((t=>t in e))}}class N{constructor(){}serialize(e){return{filename:e.file.name,contents:{filename:e.file.name,blob:e.file}}}}const x=new s.Vy("FileAttachmentStorage");class M extends S{constructor(e){super(e),this.uploadDeserializer=new k,this.uploadSerializer=new N,this.attachmentDeserializer=new p.x}async create(e,t){const i=this.context.baseViewId,n=this.uploadSerializer.serialize(e);let s;try{s=await this.client.upload(C.UploadFileAttachmentToModel,"UploadFileAttachmentToModel",Object.assign(Object.assign({},n),{modelId:i,organizationId:this.config.organizationId}),t,e.xhr)}catch(t){return x.error(t),t.code.includes("quota.exceeded")?e.error=d.t2.OVER_QUOTA:e.error=d.t2.UPLOAD_FAILED,e.progress=100,e}if(s.errors&&s.errors.length>0)x.error(s.errors),e.error=d.t2.UPLOAD_FAILED;else{const t=(0,c.L)(s,"data.uploadFileAttachmentToModel")||null;if(t){const i=this.uploadDeserializer.deserialize(t);i?(x.info("upload successful!"),e.attachment=i):(x.error("cannot create attachment"),e.error=d.t2.UPLOAD_FAILED)}else x.error("upload failed!"),e.error=d.t2.UPLOAD_FAILED}return e.progress=100,e}async delete(e){const t=await this.client.mutate(C.DeleteFileAttachment,{id:e}),i=(0,c.L)(t,"data.deleteFileAttachment")||!1;return i?x.info("upload deleted!"):x.error("upload deletion failed!"),i}async read(){var e,t,i;const n=this.context.baseViewId;if(!n)return x.error("Missing model ID"),[];const s=null!==(i=null===(t=null===(e=(await this.client.query(C.FileAttachments,{modelId:n,pageSize:1e3})).data)||void 0===e?void 0:e.fileAttachmentsByModelId)||void 0===t?void 0:t.results)&&void 0!==i?i:[],a=[];return s.forEach((e=>{const t=this.attachmentDeserializer.deserialize(e);t&&a.push(t)})),a}}var O=i(20835),R=i(15684),L=i(42390);function V(e){switch(e){case L.n.PHOTO:return d.zu.IMAGE;case L.n.VIDEO:return d.zu.VIDEO;case L.n.RICH:return d.zu.RICH;default:return}}function j(e){const{height:t,width:i,thumbnail_height:n,thumbnail_width:s,cache_age:a}=e,o=(void 0===t||void 0===i)&&(s&&n),r=e.type===L.n.PHOTO?e.url:void 0,d=e.thumbnail_url||r,l=a?new Date(Date.now()+1e3*a):null;return{width:o?s:i,height:o?n:t,mediaType:V(e.type),url:new E.f(r||"",l),thumbnailUrl:new E.f(d||"",l)}}var B=i(47737),F=i(33156);class H extends n.n{constructor(){super(...arguments),this.name="attachments-module",this.onProgress=(e,t)=>{if(!e.lengthComputable)return;const i=e.total>0?Math.floor(e.loaded/e.total*100):100,n=Object.assign(Object.assign({},t),{progress:i});this.attachmentsData.updateUpload(n),this.engine.broadcast(new r.hg(n))},this.deleteAttachments=async(e,t,i)=>{if(this.fileAttachmentStorage.readonly)return void s.Vy.for(this).error("File attachment storage is readonly");if(0===e.length)return;const n=[],a=[];this.attachmentsData.atomic((()=>{e.forEach((e=>{e.category===d._A.UPLOAD?n.push(e):e.category===d._A.EXTERNAL&&a.push(e.id)}))})),n.length>0&&await Promise.all(n.map((e=>this.attachmentsStore.remove(e)))),a.length>0&&await this.attachmentsStore.delete(a,t,i)}}async init(e,t){this.engine=t;const[i,n]=await Promise.all([t.market.waitForData(B.P),t.market.waitForData(F.E)]),{oEmbedConsumer:s}=e,a=n.getModelOrganizationId();this.attachmentsStore=new y({context:i.mdsContext,readonly:!1});const o=()=>{this.attachmentsStore.setStoreViewId(i.getNonworkshopViewId())};o(),this.bindings.push(i.onPropertyChanged("currentViewId",o)),this.fileAttachmentStorage=new M(Object.assign({context:i.mdsContext,readonly:!a,organizationId:a},e)),this.oEmbedConsumer=await s,this.attachmentsData=new O.v,t.market.register(O.v,this.attachmentsData)}async getUpdatedEmbed(e){if(e.category===d._A.EXTERNAL){const t=await this.oEmbedConsumer.getOEmbedData(e.src);return Object.assign(e,j(t)),t}return null}loadEmbeddedAttachment(e){return this.getUpdatedEmbed(e)}async embedMedia(e,t,i){let n,s=null;const o=await this.oEmbedConsumer.getOEmbedData(i);return o?(s=new P.o,s.id=(0,a.W0)(),s.parentType=t,s.parentId=e,s.src=i,s.category=d._A.EXTERNAL,Object.assign(s,j(o)),this.attachmentsData.addPending(s),n=d.d3.EMBED_SUCCESS):n=d.d3.EMBED_FAIL,this.engine.broadcast(new r.Z4(s,n,e,t)),s}uploadAttachments(e,t,i){const n=this.attachmentsData,s=[];return i.forEach((i=>{const a=this.uploadAttachment(i,e,t).then((i=>(n.atomic((()=>{i.error?(n.removeUpload(i.id),n.addFailure(i)):i.attachment&&(i.attachment.parentId=e,i.attachment.parentType=t,n.removeUpload(i.id),n.addPending(i.attachment))})),this.engine.broadcast(new r.Uf(i)),i)));s.push(a)})),Promise.all(s)}async uploadAttachment(e,t,i){const n={file:e,id:(0,a.W0)(),progress:0,error:null,attachment:null,parentId:t,parentType:i,xhr:new XMLHttpRequest};if(this.fileAttachmentStorage.readonly)return s.Vy.for(this).error("File attachment storage is readonly"),n.error=d.t2.PERMISSION_DENIED,Promise.resolve(n);const o=e.size;return 0===o?(n.error=d.t2.EMPTY_FILE,Promise.resolve(n)):o>R.LY?(n.error=d.t2.FILE_TOO_LARGE,Promise.resolve(n)):(this.attachmentsData.addUpload(n),this.fileAttachmentStorage.create(n,(e=>this.onProgress(e,n))))}resetAttachmentChanges(){const e=this.attachmentsData;e.atomic((()=>{e.clearPending(),e.clearRemovals(),e.clearUploads(),e.clearFailures()}))}removeFailure(e){this.attachmentsData.removeFailure(e)}async removeAttachment(e){if(this.fileAttachmentStorage.readonly)return void s.Vy.for(this).error("File attachment storage is readonly");const t=this.attachmentsData,i=t.getPendingAttachment(e.id);i?(i.category===d._A.UPLOAD&&await this.fileAttachmentStorage.delete(e.id),t.removePendingAttachment(e.id)):t.markAttachmentForDelete(e)}async confirmAttachmentChanges(e,t,i){const n=this.attachmentsData,{pendings:s,removals:a}=n,r=s.length>0||a.length>0;if(s.length>0){const a=i||e;n.iteratePending((n=>{i&&n.parentId===a&&n.parentType===t&&(n.parentId=e)}));const r=t!==o.pi.MATTERTAG?s.values:s.values.filter((e=>e.category===d._A.UPLOAD));await this.attachmentsStore.create(r)}if(a.length>0){const i=t!==o.pi.MATTERTAG?a.values:a.values.filter((e=>e.category===d._A.UPLOAD));i.length>0&&await this.deleteAttachments(i,e,t)}return this.resetAttachmentChanges(),r}cancelAttachmentUpload(e){const{uploads:t}=this.attachmentsData,i=null==t?void 0:t.get(e);(null==i?void 0:i.xhr)&&(i.xhr.abort(),this.attachmentsData.removeUpload(e))}async cancelAttachmentChanges(){const e=this.attachmentsData,{pendings:t,uploads:i,removals:n}=e;0===t.length&&0===n.length&&0===i.length||(this.fileAttachmentStorage.readonly?s.Vy.for(this).error("File attachment storage is readonly"):(t.values.forEach((e=>{e.category===d._A.UPLOAD&&this.fileAttachmentStorage.delete(e.id)})),i.length&&i.values.map((e=>this.cancelAttachmentUpload(e.id))),this.resetAttachmentChanges()))}toggleAttachmentViewer(e,t,i){e&&t?this.openAttachmentViewer(t,i):this.closeAttachmentViewer()}openAttachmentViewer(e,t){this.viewerOpen=!0,this.engine.broadcast(new r.FA(e,t))}closeAttachmentViewer(){this.viewerOpen&&(this.viewerOpen=!1,this.engine.broadcast(new r.hd))}async getAllAttachments(){return this.fileAttachmentStorage.read()}async immediatelyDeleteAttachment(e){this.fileAttachmentStorage.readonly?s.Vy.for(this).error("File attachment storage is readonly"):e?await this.fileAttachmentStorage.delete(e):s.Vy.for(this).error("ID required to delete attachment")}}},12797:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>v});var n=i(64882),s=i(71687),a=i(68909),o=i(37458),r=i(84250),d=i(38069);const l=new a.Vector3(0,1,0),c=[{innerRadius:0,outerRadius:.42,color:d.V.MP_BRAND.clone(),opacity:.7},{innerRadius:.67,outerRadius:1,color:d.V.MP_BRAND.clone(),opacity:.7}];class h{constructor(e,t,i){this.scene=e,this.sweepData=t,this.mesh=new r.O({radius:.25,normal:l,rings:c}),this.mesh.name="CurrentPanoMarker",this.mesh.renderOrder=o.X.panoMarker,this.mesh.layers.mask=i.mask}init(){}dispose(){this.mesh.dispose()}render(){const e=this.sweepData.currentAlignedSweepObject;e&&this.move(e.floorPosition)}activate(){this.scene.add(this.mesh)}deactivate(){this.scene.remove(this.mesh)}move(e){this.mesh.position.copy(e).setY(e.y+h.floorOffset)}}h.floorOffset=.01;var u=i(99583),m=i(12837),p=i(2993),g=i(66806);class v extends n.n{constructor(){super(...arguments),this.name="current-pano-marker",this.state={markerEnabled:!1,transitionPromise:null}}async init(e,t){const i=(await t.getModuleBySymbol(s.M7)).getScene(),n=t.claimRenderLayer(this.name),[a,o]=await Promise.all([t.market.waitForData(m.A),t.market.waitForData(u.X)]);this.engine=t,this.sweepData=a,this.viewmodeData=o,this.markerRenderer=new h(i,a,n),this.bindings.push(this.viewmodeData.makeModeChangeSubscription((()=>this.updateMarker())),this.sweepData.makeSweepChangeSubscription((()=>this.updateMarker()))),this.updateMarker()}togglePanoMarker(e){this.state.commandOverride=e,this.updateMarker()}async updateMarker(){const{commandOverride:e}=this.state,t=this.viewmodeData.currentMode,i=this.sweepData.currentAlignedSweepObject,n=!1===e||(0,p.nI)(t)||t===g.N.Transition;return this.toggleMarker(!!i&&!n)}async toggleMarker(e){const{markerEnabled:t,transitionPromise:i}=this.state;if(i&&await i,t===e)return;const n=e?this.enableMarker():this.disableMarker();return this.state.transitionPromise=n.finally((()=>{this.state.markerEnabled=e,this.state.transitionPromise=null})),this.state.transitionPromise}async enableMarker(){return this.engine.addComponent(this,this.markerRenderer)}async disableMarker(){return this.engine.removeComponent(this,this.markerRenderer)}}},62592:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n=i(64882),s=i(25443),a=i(71687),o=i(2993),r=i(99583),d=i(21875),l=i(90834),c=i(12837),h=i(86325);class u extends n.n{constructor(){super(...arguments),this.name="cursor-controller",this.visibilityRules=[],this.disabled=!1}async init(e,t){[this.cursorMesh,this.cursorModule]=await Promise.all([t.getModuleBySymbol(a.zX),t.getModuleBySymbol(a.ep)]),this.visibilityRules.push((()=>{const e=t.market.tryGetData(r.X);return!!e&&(0,o.nI)(e.closestMode)}),(()=>{const e=t.market.tryGetData(c.A);return!!e&&!e.isSweepUnaligned(e.state.currentSweep)}),(()=>{const e=t.market.tryGetData(d.R);return!!e&&!e.isTourActive()}),(()=>{const e=t.market.tryGetData(l.O);return!!e&&!e.isMobile()}),(()=>{const e=t.market.tryGetData(s.o);return!!e&&e.tryGetSetting(h.Q,!0)}))}onUpdate(){this.updateCursorVisibility()}disableCursorMesh(e){this.disabled=e,this.updateCursorVisibility()}addVisibilityRule(e){this.visibilityRules.push(e)}removeVisibilityRule(e){const t=this.visibilityRules.indexOf(e);-1!==t&&this.visibilityRules.splice(t,1)}setFadeProps(e){this.cursorModule.setFadeProps(e)}updateCursorVisibility(){const e=!this.disabled&&this.visibilityRules.reduce(((e,t)=>e&&t()),!0);this.cursorMesh.setVisible(e)}setTexture(e){this.cursorModule.setTexture(e)}}},86325:(e,t,i)=>{"use strict";i.d(t,{Q:()=>n});const n="features/cursor"},13230:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>h});var n=i(68909),s=i(64882),a=i(9139),o=i(52885),r=i(71687),d=i(78079),l=i(5243),c=i(22299);class h extends s.n{constructor(){super(...arguments),this.name="cursor-data",this.fadeOutDelay=700,this.fadeOutDuration=700,this.fadeInDuration=300,this.movementThreshold=.003,this.cursorState=new c.J,this.position=new n.Vector2,this.timeToFade=0}async init(e,t){this.input=await t.getModuleBySymbol(r.mL),this.raycasterData=await t.market.waitForData(l.$),t.market.register(c.J,this.cursorState),this.bindings.push(this.input.registerHandler(d.$3,this.onPointerMove.bind(this))),this.fadeInDuration>this.fadeOutDelay&&a.Vy.for(this).warn("fadeInDuration should be less than fadeOutDelay!")}onUpdate(e){let t=!1;this.timeToFade>0&&(this.timeToFade-=e,this.timeToFade<=0&&(t=!0)),this.cursorState.opacity.tick(e),this.cursorState.commit(),t&&this.cursorState.opacity.modifyAnimation(1,0,this.fadeOutDuration)}setFadeProps(e){const{fadeOut:t,fadeIn:i}=e;this.fadeOutDuration=t&&t.duration?t.duration:this.fadeOutDuration,this.fadeOutDelay=t&&t.delay?t.delay:this.fadeOutDelay,this.fadeInDuration=i&&i.duration?i.duration:this.fadeInDuration}setTexture(e){this.cursorState.texture=e}onPointerMove(){if(null!==this.raycasterData.hit&&this.raycasterData.pointerNdcPosition.distanceToSquared(this.position)>this.movementThreshold){this.position.copy(this.raycasterData.pointerNdcPosition),this.timeToFade=this.fadeOutDelay;const e=(0,o.C)(0,this.fadeInDuration,1-this.cursorState.opacity.value);this.cursorState.opacity.modifyAnimation(this.cursorState.opacity.value,1,e),this.cursorState.commit()}}dispose(e){super.dispose(e)}}},22299:(e,t,i)=>{"use strict";i.d(t,{J:()=>a});var n=i(92237),s=i(12625);class a extends s.B{constructor(){super(),this.name="cursor",this.opacity=new n.z(0),this.texture=null}}},62916:(e,t,i)=>{"use strict";var n;i.d(t,{S:()=>n}),function(e){e[e.Reticle=0]="Reticle",e[e.GridPlane=1]="GridPlane"}(n||(n={}))},33694:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var n=i(64882),s=i(71687),a=i(68909),o=i(14868),r=i(38069),d=i(37458),l=i(84250),c=i(22299),h=i(5243),u=i(62916);const m=[{outerRadius:.977,innerRadius:.926,color:r.V.WHITE.clone(),opacity:1},{outerRadius:.898,innerRadius:.648,color:r.V.WHITE.clone(),opacity:.73}];class p{constructor(e,t=o.H.ALL){this.scene=e,this.layer=t,this.supportsMobile=!1,this.style=u.S.Reticle,this.bindings=[],this.onCursorDataUpdated=e=>{this.mesh.configure({opacity:e.opacity.value,texture:e.texture})},this.onPositionUpdate=e=>{if(e.hit&&e.hit.face){const t=e.hit.point.clone(),i=e.hit.face.normal;this.container.position.copy(t),this.mesh.configure({normal:i})}},this.container=new a.Group,this.container.name="cursor",this.mesh=new l.O({radius:.2,rings:m}),this.container.add(this.mesh),this.mesh.renderOrder=d.X.reticule,this.mesh.layers.mask=this.layer.mask}init(){}render(){}dispose(){this.mesh.dispose(),this.container.children.forEach((e=>{if(e.isMesh&&e!==this.mesh){e.geometry.dispose();const t=e.material;t.dispose(),t.map&&t.map.dispose()}}))}async activate(e){const t=await e.market.waitForData(c.J),i=await e.market.waitForData(h.$);this.bindings.push(t.onChanged(this.onCursorDataUpdated),i.onChanged(this.onPositionUpdate)),this.scene.add(this.container)}deactivate(){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(e){this.container.visible=e}}class g extends n.n{constructor(){super(...arguments),this.name="cursor-mesh",this.setVisible=e=>{this.cursor&&this.cursor.setVisible(e)}}async init(e,t){const i=(await t.getModuleBySymbol(s.M7)).getScene(),n=t.claimRenderLayer(this.name);this.cursor=new p(i,n),t.addComponent(this,this.cursor)}}},49701:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>r});var n=i(64882),s=i(78115),a=i(71687);class o extends n.n{constructor(){super(...arguments),this.name="defurnish"}async init(e,t){const i=await t.getModuleBySymbol(a.di);this.bindings.push(t.subscribe(s.uU,(()=>i.setMoveCameraOnViewChange(!1))),t.subscribe(s.Yp,(()=>i.setMoveCameraOnViewChange(!0))))}}const r=o},24679:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>c});var n=i(64882),s=i(71687),a=i(64356),o=i(68909),r=i(81662),d=i(21567);class l extends n.n{constructor(){super(...arguments),this.name="fat-caster",this.rayAssembly=new Array(l.rayCount),this.rayPlaneOrientation=new o.Quaternion,this.rayVisuals=[]}async init(e,t){this.config={debug:!!e.debug},this.raycaster=await t.getModuleBySymbol(s.sA);for(let e=0;e<l.rayCount;++e)this.rayAssembly[e]=new o.Ray;if(e.debug){const e=(await t.getModuleBySymbol(s.M7)).getScene();for(let t=0;t<l.rayCount;++t){this.rayVisuals[t]=new o.ArrowHelper(new o.Vector3,new o.Vector3);const i=this.rayVisuals[t];i.remove(i.cone),i.setLength(1e3),e.add(this.rayVisuals[t])}}}async dispose(e){const t=(await e.getModuleBySymbol(s.M7)).getScene();for(const e of this.rayVisuals)t.remove(e)}get ray(){return this.raycaster.pointer.pointerRay.clone()}cast(e,t,i=a.X.Filter.AVERAGE,n=this.ray){this.updateRayAssembly(n.origin,n.direction,e);const s=[],o=this.castRays(t,i);o&&s.push(o);const r=this.raycaster.picking.pickSplats(n.origin,n.direction);return r&&s.push(r),(0,d.B)(s)}castRays(e,t){const i=[];let n=null;for(const t of this.rayAssembly){const s=this.raycaster.picking.pick(t.origin,t.direction,e);s&&(t===this.rayAssembly[0]&&(n=s),s.point.add(this.rayAssembly[0].origin).sub(t.origin),i.push(s))}return t(i,n,this.rayAssembly)}updateRayAssembly(e,t,i){for(const e of this.rayAssembly)e.direction.copy(t);if(this.rayPlaneOrientation.setFromUnitVectors(r.B1.FORWARD,t),this.rayAssembly[0].origin.copy(e),this.rayAssembly[1].origin.copy(r.B1.RIGHT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[2].origin.copy(r.B1.UP).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[3].origin.copy(r.B1.LEFT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[4].origin.copy(r.B1.DOWN).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[5].origin.copy(r.B1.UP).add(r.B1.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[6].origin.copy(r.B1.UP).add(r.B1.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[7].origin.copy(r.B1.DOWN).add(r.B1.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[8].origin.copy(r.B1.DOWN).add(r.B1.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.config.debug)for(let e=0;e<this.rayVisuals.length;++e){const i=this.rayVisuals[e];i.setDirection(t),i.position.copy(this.rayAssembly[e].origin)}}}l.rayCount=9;const c=l},64356:(e,t,i)=>{"use strict";i.d(t,{X:()=>n});var n,s=i(68909);!function(e){let t;!function(e){const t=e=>{for(const t of e)if(t.face)return{point:t.point,object:t.object,distance:t.distance,face:t.face};return null},i=(e,t)=>e.distance-t.distance;e.CENTER_FIRST=(e,i)=>i&&i.face?{point:i.point,normal:i.face.normal,object:i.object,distance:i.distance,face:i.face}:t(e),e.CLOSEST=e=>t(e.sort(i)),e.AVERAGE=e=>{if(0===e.length)return null;const t={point:new s.Vector3,face:{a:0,b:1,c:2,normal:new s.Vector3,materialIndex:0},distance:0,object:e[0].object};for(const i of e)t.face&&i.face&&(t.point.add(i.point),t.face.normal.add(i.face.normal));return t.point.divideScalar(e.length),t.face&&t.face.normal.divideScalar(e.length).normalize(),t};e.CENTER_GROUP=t=>(i,s,a)=>{if(s){const n=[s];for(let e=1;e<i.length&&e<3;++e){const o=i[e];if(o.face){const i=Math.abs(a[e].direction.dot(o.face.normal));s.point.distanceTo(o.point)*i<=t&&n.push(o)}}if(n.length>=3){const t=e.AVERAGE(n,null,a);if(t&&t.face&&s.face)return t.face.normal=s.face.normal,t}}const o=n(i,a,t);return o?e.AVERAGE(o,null,a):e.CENTER_FIRST(i,s,a)};const n=(e,t,n)=>{const s=e.slice().sort(i),a=[s[0]];let o;for(o=1;o<s.length&&a.length<3;++o){const e=s[o];if(e.face){const i=Math.abs(t[o].direction.dot(e.face.normal));a[0].point.distanceTo(e.point)*i>n&&(a.length=0),a.push(e)}}return a.length<3?null:a}}(t=e.Filter||(e.Filter={}))}(n||(n={}))},11086:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var n=i(68909),s=i(64882),a=i(75772),o=i(81662),r=i(40397),d=i(71687),l=i(10459),c=i(19968),h=i(58229),u=i(6687),m=i(5984);class p extends s.n{constructor(){super(...arguments),this.name="floor-caster",this.cameraPosition=new n.Vector3,this.forwardPosition=new n.Vector3,this.targetPlane=new n.Plane}async init(e,t){this.engine=t,[this.renderer,this.cameraData,this.raycaster,this.floorsData,this.meshQuery]=await Promise.all([t.getModuleBySymbol(d.M7),t.market.waitForData(l.M),t.getModuleBySymbol(d.sA),t.market.waitForData(h.q),t.getModuleBySymbol(d.PM)])}async getFloorIntersect(e,t,i=!0){await this.engine.after(a.R.End);const n=this.renderer.getScene().camera,s=(0,c.wc)(e.x,e.y,this.cameraData.width,this.cameraData.height);let d,l=null;this.cameraPosition.set(s.x,s.y,-1).unproject(n),this.forwardPosition.set(s.x,s.y,1).unproject(n);const h=this.raycaster.picking.cast(this.cameraPosition,this.forwardPosition.clone().sub(this.cameraPosition).normalize(),i?u.c$:u.aV)[0];if(h&&h.object instanceof m.r){l=h&&h.point||null;const e=this.meshQuery.floorIdFromObject(h.object);e?d=this.floorsData.getFloor(e):l&&(d=this.floorsData.getClosestFloorAtHeight(l.y))}if(void 0!==t&&!l){this.cameraPosition.copy(this.cameraData.pose.position);const e=(0,c.OG)(this.cameraData,s);if(this.cameraData.isOrtho())e.y=t,l=e;else{const i=(0,r.kf)(this.cameraPosition,e);this.targetPlane.set(o.B1.DOWN,t),l=(0,r.qK)(this.cameraPosition,i,this.targetPlane)||null}}const p=d?d.index:-1;return{position:l,floor:p,floorIndex:p}}}const g=p},94790:(e,t,i)=>{"use strict";i.d(t,{Qm:()=>r,SK:()=>s,Ve:()=>d,_w:()=>o,jF:()=>a});var n=i(92475);class s extends n.E{constructor(e,t,i,n,s,a=0){super(e),this.position=t,this.buttons=i,this.device=n,this.ctrlKey=s,this.pointerId=a}}class a extends n.E{constructor(e,t,i,n,s,a,o=0){super(e),this.ctrlKey=!1,this.position=t,this.clientPosition=s,this.delta=i,this.buttons=n,this.device=a,this.pointerId=o}}class o extends n.E{constructor(e,t,i,n,s,a,o,r=0){super(e),this.ctrlKey=!1,this.position=t,this.delta=i,this.buttons=n,this.timeSinceLastMove=s,this.fullDelta=a,this.device=o,this.pointerId=r}}class r extends n.E{constructor(e,t,i){super(e),this.position=t,this.pointer=i}}class d extends n.E{constructor(e,t,i,n,s){super(e),this.position=t,this.startPosition=i,this.fullDelta=n,this.pointer=s}}},60043:(e,t,i)=>{"use strict";i.d(t,{k:()=>s});var n=i(49586);class s extends n.T{constructor(e,t,i){super(),this.key=e,this.state=t,this.modifiers=i}}},90834:(e,t,i)=>{"use strict";i.d(t,{O:()=>a});var n=i(12625),s=i(44351);class a extends n.B{constructor(){super(...arguments),this.name="interaction",this._source=a.defaultSource,this._mode=a.defaultMode}static get defaultMode(){return s.o.Desktop}static get defaultSource(){return s.m.None}get mode(){return this._mode}get source(){return this._source}updateSource(e){this._source=e}updateMode(e){this._mode=e}hasController(e=this.mode){return e===s.o.VrWithController||e===s.o.VrWithTrackedController}isVR(e=this.mode){return e===s.o.VrOrientOnly||e===s.o.VrWithTrackedController||e===s.o.VrWithController||e===s.o.VrTransientPointer||-1!==e.indexOf(s.o.VrUnknown)}isMobile(e=this.mode){return e===s.o.Mobile}}},42110:(e,t,i)=>{"use strict";i.d(t,{g:()=>r});var n=i(26655),s=i(74328),a=i(50636),o=i(27200);class r{constructor(e){this.capabilites={links:{enable:e.supportLinks,keepLabels:e.keepLinkLabels}}}parse(e,t){const i=[];if(!e)return[];return e.split("[").map((function(e,t){return 0===t?e:"["+e})).forEach((e=>{const n=this.findLink(e);n?/javascript:/i.test(n.url)||(this.addLinkChunk(i,n,t),this.addTextChunk(i,e.slice(n.markdown.length))):this.addTextChunk(i,e)})),i}findLink(e){const t=e.match(/\[([^\]]*)\]\((.*)\)/);if(!t)return null;const i=t[2];let n=1,s=0;for(;s<i.length&&("("===i[s]?n++:")"===i[s]&&n--,0!==n);)s++;const a=i.length-s;return{markdown:t[0].substring(0,t[0].length-a),label:t[1],url:this.conditionallyEncode(t[2].substring(0,s))}}conditionallyEncode(e){const t=e.trim();return this.needsEncoding(t)?encodeURI(t):t}needsEncoding(e){if(e.match(o.Cv))return!0;let t=e;try{t=decodeURI(e)}catch(e){}return!1}addTextChunk(e,t){0!==t.length&&e.push({type:a.q.text,text:t})}addLinkChunk(e,t,i){if(!this.capabilites.links.enable)return void(this.capabilites.links.keepLabels&&this.addTextChunk(e,t.label));const o={label:t.label,url:t.url,type:n.J.EXT_LINK};-1===o.url.indexOf("://")&&(o.url="http://"+o.url);const r=-1!==o.url.indexOf("matterport.com/show"),d=-1!==o.url.indexOf(window.location.host+"/show");if(r||d){const e=-1!==o.url.indexOf(i),t=s.s.deserialize(o.url);e&&t?(o.type=n.J.NAVIGATION,o.navigationData=t):(o.type=n.J.MODEL,o.url+="&play=1")}e.push({type:a.q.link,link:o})}static getNumLinks(e){let t=0;return e.forEach((e=>{"link"===e.type&&void 0!==e.link&&t++})),t}}},17160:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>X,makeMattertagDeserializer:()=>I.V});var n=i(64882),s=i(1284),a=i(92953),o=i(81547),r=i(97234),d=i(9139),l=i(71687),c=i(35956),h=i(45205),u=i(81530),m=i(96437),p=i(24675),g=i(50636),v=i(29479),f=i(42110),y=i(47907),w=i(77754),b=i(20968),T=i(75027),D=i(85275),S=i(87314),C=i(74381),E=i(51666);const A=new d.Vy("mds-mattertag-serializer");class P{constructor(e,t){this.updateSerializer=e,this.mediaSerializer=t}serialize(e,t){const i=this.mediaSerializer.serialize(e),n=this.updateSerializer.serialize(e,t),s=null!==i?Object.assign(Object.assign({},i),n):n;return this.validate(s)?s:null}validate(e){if(!e)return!1;const t=["label","description","mediaUrl"].some((t=>t in e)),i=["floorId","enabled","anchorPosition"].filter((t=>!(t in e))),n=0===i.length,s=!!e.anchorPosition&&(0,E.Z)(e.anchorPosition),a=n&&t&&s;return a||A.debug("Invalid MattertagDetails:",{missingFields:i,validPosition:s}),a}}var I=i(81483);class k{serialize(e){return this.validate(e)?{sid:e.sid}:null}validate(e){const t=null!==e&&!!e.mediaType&&e.mediaType===g.q.none;return null!==e&&!!e.sid&&t}}var N=i(61430);const x=new d.Vy("mds-mattertag-serializer");class M{serialize(e){const t=this.extractMedia(e);return this.validate(t)?t:null}validate(e){if(!e)return!1;const t=["mediaUrl","mediaType"].every((t=>t in e)),i=void 0!==e.mediaType&&["rich","photo","video"].includes(e.mediaType),n=t&&i;return n||x.debug("invalid media",e,{hasRequiredFields:t,hasValidMediaType:i}),n}extractMedia(e){const t={};return e.mediaSrc&&(t.mediaUrl=e.mediaSrc),e.mediaType&&e.mediaType in O&&(t.mediaType=e.mediaType),t.mediaUrl&&t.mediaType?t:null}}const O={[g.q.photo]:[N.yg.PHOTO],[g.q.rich]:[N.yg.RICH],[g.q.video]:[N.yg.VIDEO]};var R=i(84440),L=i(86866),V=i(57416);const j=new d.Vy("mds-mattertag-serializer");class B{serialize(e,t){var i;if(!e)return null;const n={};return void 0!==e.enabled&&(n.enabled=e.enabled),void 0!==e.stemVisible&&(n.stemEnabled=e.stemVisible),void 0!==e.label&&(n.label=e.label),void 0!==e.description&&(n.description=e.description),void 0!==e.color&&(0,R._o)(e.color)&&(n.color=(new V.I).copy(e.color).getHexString()),void 0!==e.anchorPosition&&(0,E.Z)(e.anchorPosition)&&(n.anchorPosition=L.U$.toVisionVector(e.anchorPosition)),void 0!==e.anchorNormal&&(0,E.Z)(e.anchorNormal)&&(n.stemNormal=L.U$.toVisionVector(e.anchorNormal)),void 0!==e.stemHeight&&(n.stemLength=e.stemHeight),Object.prototype.hasOwnProperty.call(e,"icon")&&(n.icon=null!==(i=e.icon)&&void 0!==i?i:""),void 0!==e.keywords&&(n.keywords=e.keywords.isObservableArray?e.keywords.values():e.keywords),e.floorId&&(n.floorId=e.floorId),e.roomId&&(n.roomId=e.roomId),e.layerId&&t&&(n.layerId=e.layerId),e.objectAnnotationId&&(n.objectAnnotationId=e.objectAnnotationId),n&&this.validate(n)?n:null}validate(e){if(!e)return!1;const t=["layerId","floorId","roomId","color","label","description","enabled","stemEnabled","stemLength","stemNormal","stemDirection","anchorPosition","objectAnnotationId","keywords","icon"],i=Object.keys(e).length>0,n=Object.keys(e).every((e=>t.includes(e))),s=n&&i;return s||j.debug("Invalid MattertagPatch:",{hasContents:i,hasValidFields:n,data:e}),s}}class F{serialize(e){const t=e.fileAttachments;return void 0===t?null:{fileAttachments:t.map((e=>e.id))}}}var H=i(27140);const U=new d.Vy("MdsMattertagStore");class _ extends b.g{constructor(e,t){super(e),this.includeObjectTags=t,this.layeredType=C.jM.MATTERTAG,this.prefetchKey="data.model.mattertags",this.fileAttachmentDeserializer=new D.x,this.fileAttachmentSerializer=new F,this.patchSerializer=new B,this.mediaUpdateSerializer=new M,this.mediaRemovalSerializer=new k,this.createSerializer=new P(this.patchSerializer,this.mediaUpdateSerializer),this.tagDeserializer=new I.P(this.fileAttachmentDeserializer,new S.g),this.deserializer=new w.n({deserializer:this.tagDeserializer})}async read(e){var t;const{includeDisabled:i=!1}=this.config,n={modelId:null!==(t=null==e?void 0:e.modelId)&&void 0!==t?t:this.getViewId(),includeDisabled:i,prefetchKey:this.prefetchKey,includeLayers:this.readLayerId()};return this.query(H.GetMattertags,n,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(!this.includeObjectTags&&t.objectAnnotationId||(e[t.sid]=t),e)),{})}))}async refreshFileAttachments(e){const{includeDisabled:t=!1}=this.config,i={modelId:(null==e?void 0:e.modelId)||this.getViewId(),includeDisabled:t};return this.query(H.RefreshTagFileAttachments,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return{};const s=[];for(const e of n){if(!e.id||!e.fileAttachments)throw U.error("Failure refreshing tag file attachments"),new Error("Failure refreshing tag file attachments");e.fileAttachments.forEach((e=>{const t=this.fileAttachmentDeserializer.deserialize(e);t&&s.push(t)}))}return s.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async create(e){const t=this.getViewId(),i=[];for(const n of e){const e=this.createSerializer.serialize(n,this.writeLayerId(n.layerId));if(!e)throw U.error("Failure saving tag:",n.sid,n),new Error("Could not save Mattertag");const s=n.sid;let a=", $data: MattertagDetails!";const o={modelId:t,mattertagId:s,data:e},r=this.fileAttachmentSerializer.serialize(n);r&&(a+=", $fileAttachments: [ID!]",o.fileAttachments=r.fileAttachments);const d=`\n        addMattertag(\n          modelId: $modelId,\n          mattertagId: "${s}",\n          mattertag: $data) {\n            id\n            created\n            modified\n          }\n        ${r?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${s}",\n            fileAttachments: $fileAttachments) {\n              id\n            }`:""}\n      `,l=y.J1`
        mutation AddMattertag($modelId: ID! ${a}) {
          ${d}
        }
      `,h=await this.mutate(l,o),u=(0,T.L)(h,"data.addMattertag"),m=(new c.Q).copy(n);m.sid=u.id,m.commit(),i.push(m)}return i}async update(e,t){if(!e||0===e.length)return;let i="";const n={},s=this.getViewId();n.modelId=s;let a="";for(const t of e){const e=t.sid,s=this.mediaUpdateSerializer.serialize(t),o=this.mediaRemovalSerializer.serialize(t),r=this.patchSerializer.serialize(t,!1),d=r||o||s,l=this.fileAttachmentSerializer.serialize(t);if(!(r||s||o||l))return void U.debug(`Nothing to update for tag ${e}`,t);if(d){const t=r||{};i+=`, $patch${e}: MattertagPatch!`,o&&(t.mediaUrl=""),s&&(t.mediaUrl=s.mediaUrl,t.mediaType=s.mediaType),n[`patch${e}`]=t}l&&(i+=`, $fileAttachments${e}: [ID!]`,n[`fileAttachments${e}`]=l.fileAttachments),n[`mediaType${e}`]=s&&s.mediaType,n[`mediaUrl${e}`]=s&&s.mediaUrl;a+=`\n        update${e}:\n        ${d?`patchMattertag(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            patch: $patch${e}) {\n              id\n            }`:""}\n        ${l?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            fileAttachments: $fileAttachments${e}) {\n              id\n            }`:""}\n      `}for(const{attachment:e}of t)(null==e?void 0:e.id)&&(null==e?void 0:e.parentId)&&e.parentType?(i+=`, $parentType${e.id}: ParentType!`,n[`parentType${e.id}`]=e.parentType,a+=`\n        unattach${e.id}:\n        removeFileAttachment(modelId: $modelId,\n                             attachmentId: "${e.id}",\n                             parentType: $parentType${e.id},\n                             parentId: "${e.parentId}") `):U.debug("MattertagStore.update: unable to remove file attachment");const o=y.J1`
      mutation tagUpdate($modelId: ID! ${i}) {
        ${a}
      }
    `;await this.mutate(o,n)}async delete(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const t of e){if(!t||t&&!t.sid)throw new Error("MattertagStore.delete failed");i+=`delete${t.sid}: deleteMattertag(modelId: $modelId, mattertagId: "${t.sid}") `}const n=y.J1`
      mutation batchDeleteMattertag($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(n,{modelId:t}).then((()=>{}))}}var G=i(10459),z=i(19968),$=i(68909),W=i(81058),Y=i(47737),K=i(39118);class X extends n.n{constructor(){super(...arguments),this.name="mattertag-data",this.monitor=null,this.filesToUnattach=[],this.refreshIds=new Set,this.getDiscPositions=(()=>{const e=[],t={},i={},n=new $.Vector3;return async s=>(e.length=0,s.tags.forEach((s=>{const a=this.data.getTag(s);a&&(i[s]||(i[s]=new $.Vector3),i[s].copy(a.anchorPosition).add(a.stemVector),t[s]||(t[s]=new $.Vector2),(0,z.bz)(this.cameraData,i[s],t[s],n),e.push({sid:s,screen:n.z>1?null:t[s],world:i[s]}))})),e)})(),this.addTag=async e=>{const t=[];return this.data.atomic((()=>{var i,n,s;for(const a of e){const{positionOptions:e,standardOptions:o,mediaOptions:r}=a,d=Object.assign(Object.assign({},e),o),l=this.createTag(a.id||(0,h.D)(c.Q.idLength),d,(null===(i=a.attachmentOptions)||void 0===i?void 0:i.fileAttachments)||[],r);l.externalAttachments.concat((null===(n=a.attachmentOptions)||void 0===n?void 0:n.externalAttachments)||[]),l.modified=new Date,l.commit(),t.push(l.sid);for(const e of(null===(s=a.attachmentOptions)||void 0===s?void 0:s.refreshIds)||[])this.refreshIds.add(e);this.data.updateOnStaleCallbacks(l.sid)}})),t},this.editTag=async e=>{const{sid:t,positionOptions:i,standardOptions:n,mediaOptions:s}=e,a=Object.assign(Object.assign({},i),n),o=this.data.getTag(t);o&&(this.updateTag(o,a,s),o.modified=new Date,o.commit())},this.editTagAttachments=async({sid:e,attachmentOptions:t,operation:i})=>{const n=this.data.getTag(e);if(!n)return;({[m.nO.Operation.REPLACE]:function(){let e=!1;const i=[...t.fileAttachments],s=[...t.externalAttachments];return i.length&&n.fileAttachments.length||(n.fileAttachments.replace(t.fileAttachments),e=!0),s.length&&n.externalAttachments.length||(n.externalAttachments.replace(t.externalAttachments),e=!0),e},[m.nO.Operation.ADD]:function(){let e=!1;const i=[...t.fileAttachments],s=[...t.externalAttachments];return i.length>0&&(n.fileAttachments.push(...t.fileAttachments),e=!0),s.length>0&&(n.externalAttachments.push(...t.externalAttachments),e=!0),e}})[i]()&&(n.modified=new Date,n.commit());for(const e of t.refreshIds||[])this.refreshIds.add(e);this.data.updateOnStaleCallbacks(n.sid)},this.removeTag=async e=>{const t=this.data.getTag(e.sid);if(void 0!==t&&this.data.removeTag(e.sid))return t&&t.objectAnnotationId&&this.engine.commandBinder.issueCommand(new W.lg(t.objectAnnotationId)),e.sid},this.saveNewTag=async e=>{const{id:t,properties:i,embed:n,fileAttachments:a}=e,o=n?{mediaSrc:n.src,mediaType:(0,p.KP)(n.mediaType)}:void 0;return this.createTag(t,i,a,o),this.engine.commandBinder.issueCommand(new u.F({dataTypes:[s.p.MATTERTAGS]}))},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:a,embed:o}=e,r=this.data.getTag(t);if(!r)return void d.Vy.for(this).debug("Cannot save non-existent tag");const l=o?(0,p.KP)(o.mediaType):g.q.none,c=o?o.src:"";void 0!==o&&(c===r.mediaSrc&&l!==r.mediaType||this.updateExternalAttachment(r,o));const h=void 0!==o?{mediaSrc:c,mediaType:l}:void 0;return this.updateTag(r,i,h),n.forEach((e=>{r.fileAttachments.push(e)})),this.removeFileAttachments(r,a),this.data.addTag(r),this.data.updateOnStaleCallbacks(t),this.engine.commandBinder.issueCommand(new u.F({dataTypes:[s.p.MATTERTAGS]}))}}async init(e,t){const{readonly:i,baseUrl:n,store:r,inferMeshIds:d=!1}=e;this.engine=t,this.descParser=new f.g({supportLinks:!0,keepLinkLabels:!0}),[this.cameraData,this.layersData]=await Promise.all([t.market.waitForData(G.M),t.market.waitForData(Y.P)]),e.inferMeshIds&&(this.meshQueryModule=await t.getModuleBySymbol(l.PM)),this.store=r||new _({context:this.layersData.mdsContext,readonly:i,includeDisabled:!i,baseUrl:n},e.objectTagsEnabled);const c=await t.getModuleBySymbol(l.T9);this.data=new v.j,this.bindings.push(this.store.onNewData((async t=>{this.initializeTagData(t,d,e.parserOptions)})),t.commandBinder.addBinding(m.HI,this.getDiscPositions),t.commandBinder.addBinding(m.aw,this.addTag),t.commandBinder.addBinding(m.rn,this.editTag),t.commandBinder.addBinding(m.nO,this.editTagAttachments),t.commandBinder.addBinding(m.l,this.removeTag)),await this.store.refresh(),i||(this.bindings.push(t.commandBinder.addBinding(m.Ee,this.saveNewTag),t.commandBinder.addBinding(m.vZ,this.saveTag),c.onSave((()=>this.save()),{dataType:s.p.MATTERTAGS})),this.monitor=new a.F(this.data.collection,{aggregationType:o.D.Manual,shallow:!0})),this.registerRoomAssociationSource(t),t.market.register(v.j,this.data)}dispose(e){this.store.dispose(),super.dispose(e)}async save(){if(this.monitor&&this.monitor.commitChanges(),!this.store||!this.monitor)return void d.Vy.for(this).warn("Mattertags changes will NOT be saved");const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=e.map((e=>{var t;const i=e.diff.layerId||(null===(t=this.data.getTag(e.index))||void 0===t?void 0:t.layerId);return Object.assign({layerId:i},e)})).filter((e=>!this.layersData.isInMemoryLayer(e.layerId))),i=t.filter((e=>e.action===r.Xw.removed)).map((e=>({sid:e.index,layerId:e.layerId}))),n=t.filter((e=>e.action===r.Xw.added)).map((e=>this.data.getTag(e.index))),s=t.filter((e=>e.action===r.Xw.updated)).map((e=>{const t=Object.assign({sid:e.index,layerId:e.layerId},e.diff),i=this.data.getTag(e.index);return"mediaSrc"in t&&(t.mediaType=i.mediaType),t.objectAnnotationId=i.objectAnnotationId,!t.roomId&&i.roomId&&(t.roomId=i.roomId),t}));await this.store.delete(i),await this.store.create(n),await this.store.update(s,this.filesToUnattach)}initializeTagData(e,t,i){var n;const s=i?new f.g(i):this.descParser;this.data.atomic((()=>{this.layersData.replaceBackendLayers(this.data.collection,{})})),this.data.atomic((()=>{var i;for(const n in e){const a=e[n];a.parsedDescription=s.parse(e[n].description,this.layersData.currentViewId),t&&(null===(i=this.meshQueryModule)||void 0===i||i.inferMeshIdsFromPoint(a,a.anchorPosition,!1)),this.data.addTag(a)}})),this.data.onStale=async()=>{const e=[this.store.refreshFileAttachments()];for(const t of this.refreshIds)e.push(this.store.refreshFileAttachments({modelId:t}));return(await Promise.all(e)).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{})},this.data.updateOnStaleCallbacks(),null===(n=this.monitor)||void 0===n||n.clearDiffRecord()}createTag(e,t,i,n){let s=e;for(;this.data.getTag(s);)s=(0,h.D)(c.Q.idLength);const a=new c.Q;if(a.sid=s,a.layerId=this.layersData.activeLayerId,n){const e=(0,p.n4)(n.mediaType);if(n.mediaSrc&&e){const t=(0,p.sM)(s,n.mediaSrc,e);t&&a.externalAttachments.push(t)}}t.objectAnnotationId&&(a.objectAnnotationId=t.objectAnnotationId),t.keywords&&a.keywords.replace(t.keywords);for(const e of i)a.fileAttachments.push(e);return this.updateTag(a,t,n),this.data.addTag(a),this.data.updateOnStaleCallbacks(s),a}updateTag(e,t,i){e.updateFromOptions(t,this.descParser,this.layersData.currentViewId),void 0!==(null==i?void 0:i.mediaType)&&(e.mediaType=i.mediaType),void 0!==(null==i?void 0:i.mediaSrc)&&(e.mediaSrc=i.mediaSrc.slice())}removeFileAttachments(e,t){const{fileAttachments:i}=e;t.forEach((t=>{const n=i.findIndex((e=>e.id===t.id));-1!==n?(i.splice(n,1),this.filesToUnattach.push({attachment:t,layerId:e.layerId})):d.Vy.for(this).debug("Attempting to remove an attachment that is not in the tag")}))}updateExternalAttachment(e,t){const{mediaSrc:i}=e;i&&e.externalAttachments.replace([]),t&&e.externalAttachments.replace([t])}registerRoomAssociationSource(e){const t=this.data;e.commandBinder.issueCommandWhenBound(new K.l({type:"mattertags",getPositionId:function*(){for(const e of t)yield{id:e.sid,roomId:e.roomId,floorId:e.floorId,position:e.anchorPosition,layerId:e.layerId}},updateRoomForId:(e,t)=>{const i=this.data.getTag(e);if(!i)throw new Error("Invalid tag id!");i.roomId=t||void 0}}))}}},32502:(e,t,i)=>{"use strict";var n;i.d(t,{f:()=>n}),function(e){e[e.Standard=0]="Standard",e[e.Depth=1]="Depth",e[e.Transparent=2]="Transparent",e[e.Wireframe=3]="Wireframe",e[e.UV=4]="UV",e[e.CeilingSample=5]="CeilingSample",e[e.FloorSample=6]="FloorSample"}(n||(n={}))},86198:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Comment:()=>Ce,FocusCommentMessage:()=>re,HashtagData:()=>Z,Note:()=>se,NoteColorVariant:()=>ee.D,NoteResolutionChangeMessage:()=>oe,NotesData:()=>q,NotesFilter:()=>ee.S,NotesPhase:()=>Y.f,NotesViewData:()=>Q.b,default:()=>Ks});var n=i(64882),s=i(53282),a=i(14614),o=i(45987),r=i(1284),d=i(9139),l=i(93136),c=i(94165),h=i(74381),u=i(32024);const m=i.p+"images/NoteColor.png";var p=i(45205),g=i(13893),v=i(39905),f=i(75742),y=i(73566),w=i(20246),b=i(17084),T=i(96319),D=i(23864),S=i(81088),C=i(33156),E=i(87193),A=i(42329),P=i(12837),I=i(99583),k=i(25443),N=i(90834),x=i(39209),M=i(47737),O=i(40899),R=i(72354),L=i(9997),V=i(25727),j=i(11416),B=i(79457),F=i(51831),H=i(30926),U=i(40409),_=i(53641);function G(e,t){return!!t&&t.id===e.getCurrentUserId()}function z(e,t,i,n){if(i===F.U.NOTE){return t.hasPolicy(_.O7)&&G(e,n)}return e.isEditor()}function $(e,t,i,n){if(i===F.U.NOTE){return t.hasPolicy(_.xB)&&G(e,n)||e.isOrgAdmin()}return e.isEditor()}var W=i(3101),Y=i(89416),K=i(12625),X=i(88325);class q extends K.B{constructor(e){super(),this.name="notes-data",this.notes=(0,X.y)(e)}iterate(e){for(const t of this.notes)e(t)}updateNote(e){this.notes.has(e.id)?this.notes.get(e.id).copy(e):this.notes.set(e.id,e)}updateNoteProperties(e,t){if(this.notes.has(e)){const i=this.notes.get(e);let n=!1;void 0!==t.resolved&&t.resolved!==i.resolved&&(i.resolved=t.resolved,n=!0),void 0!==t.color&&t.color!==i.color&&(i.color=t.color,n=!0),void 0!==t.anchorPosition&&t.anchorPosition!==i.anchorPosition&&(i.anchorPosition=t.anchorPosition,n=!0),void 0!==t.stemNormal&&t.stemNormal!==i.stemNormal&&(i.stemNormal=t.stemNormal,n=!0),void 0!==t.stemLength&&t.stemLength!==i.stemLength&&(i.stemLength=t.stemLength,n=!0),void 0!==t.stemEnabled&&t.stemEnabled!==i.stemEnabled&&(i.stemEnabled=t.stemEnabled,n=!0),void 0!==t.floorId&&t.floorId!==i.floorId&&(i.floorId=t.floorId,n=!0),void 0!==t.roomId&&t.roomId!==i.roomId&&(i.roomId=t.roomId,n=!0),n&&i.commit()}}removeNote(e){this.notes.has(e)&&(this.notes.delete(e),this.commit())}getNote(e){return this.notes.get(e)}getNoteProperties(e){const t=this.notes.get(e);if(!t)return null;return Object.assign({},t)}get collection(){return this.notes}}var Q=i(78450),J=i(4850);class Z extends K.B{constructor(){super(...arguments),this.name="hashtag-data",this.hashtags=(0,J.Z)([])}addHashtags(e){this.atomic((()=>{e.forEach((e=>{this.addHashtag(e)}))}))}addHashtag(e){const t=e.trim().toLowerCase();-1===this.hashtags.map((e=>e.trim().toLowerCase())).indexOf(t)&&this.hashtags.push(e)}getHashtags(){return this.hashtags.values()}}var ee=i(3184),te=i(68909),ie=i(3928),ne=i(33895);class se extends ie.v{constructor(e){super(),this.id="",this.layerId="",this.color=_.Jz,this.anchorPosition=new te.Vector3,this.stemNormal=new te.Vector3,this.stemLength=_.Ay.stem.length,this.stemEnabled=!0,this.created=new Date,this.modified=new Date,this.lastCommentMs=(new Date).getTime(),this.resolved=!1,this.user=(0,ne.A)(""),this.comments=(0,J.Z)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.resolved=e.resolved,this.color=e.color,this.floorId=e.floorId,this.roomId=e.roomId,this.anchorPosition.copy(e.anchorPosition),this.stemNormal.copy(e.stemNormal),this.stemLength=e.stemLength,this.stemEnabled=e.stemEnabled,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.lastCommentMs=e.lastCommentMs,this.comments.replace(e.comments.values()),this.commit(),this}getComment(e){return this.comments.find((t=>t.id===e))||null}updateComment(e){const t=this.comments.findIndex((t=>t.id===e.id));-1!==t&&(e.assetId=this.id,this.comments.update(t,e))}deleteComment(e){const t=this.comments.findIndex((t=>t.id===e));-1!==t&&this.comments.splice(t,1)}}var ae=i(7478);class oe extends ae.QB{constructor(e,t){super(),this.id=e,this.resolved=t}}class re extends ae.QB{constructor(e){super(),this.commentId=e}}var de=i(85204),le=i(20968),ce=i(96276),he=i(87314),ue=i(85275),me=i(51666),pe=i(86866);const ge=new d.Vy("mds-note-serialize");class ve{constructor(){this.getNoteDetails=(e,t,i)=>{const n={enabled:!0,floorId:"",roomId:void 0};void 0!==e.floorId&&""!==e.floorId&&(n.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(n.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(n.color=e.color),void 0!==e.stemEnabled&&(n.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(n.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,me.Z)(e.anchorPosition)&&(n.anchorPosition=pe.U$.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,me.Z)(e.stemNormal)&&(n.stemNormal=pe.U$.toVisionVector(e.stemNormal)),void 0!==e.resolved&&(n.resolution=e.resolved?h.$X.RESOLVED:h.$X.OPEN),i&&e.layerId&&(n.layerId=e.layerId);const s={text:t};return n.comment=s,Object.keys(n).length>0?n:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","enabled"].filter((t=>!(t in e))),i=0===t.length,n=!!e.floorId&&"string"==typeof e.floorId,s=!!e.anchorPosition&&(0,me.Z)(e.anchorPosition),a=i&&n&&s;return a||ge.debug("Note invalid:",{missingFields:t,validPosition:s}),a}}serialize(e,t,i){const n=this.getNoteDetails(e,t,i);return this.validate(n)?n:null}}class fe{constructor(){this.getNotePatch=(e,t)=>{if(!e)return null;const i={};return void 0!==e.floorId&&""!==e.floorId&&(i.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(i.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(i.color=e.color),void 0!==e.stemEnabled&&(i.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(i.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,me.Z)(e.anchorPosition)&&(i.anchorPosition=pe.U$.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,me.Z)(e.stemNormal)&&(i.stemNormal=pe.U$.toVisionVector(e.stemNormal.normalize())),t&&e.layerId&&(i.layerId=e.layerId),Object.keys(i).length>0?i:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","color","anchorPosition","stemNormal","stemLength","stemEnabled","stemNormal","enabled"];return Object.keys(e).every((e=>t.includes(e)))}}serialize(e,t){const i=this.getNotePatch(e,t);return i&&this.validate(i)?i:null}}var ye=i(81587),we=i(25481);function be(e){return Object.assign({modelAccess:h.OQ.PUBLIC},e)}const Te=new d.Vy("mds-note-deserializer");class De{constructor(e,t){this.commentDeserializer=e,this.userData=t,this.validate=e=>{if(!e)return!1;const t=["id","created","modified","floor","resolution"].filter((t=>!(t in e))),i=0===t.length,n=!(!e.floor||!e.floor.id);return i&&n||Te.debug("Note invalid:",{missingFields:t,validFloor:n}),i&&n}}deserialize(e){var t;if(!e||!this.validate(e)||!e.floor)return Te.debug("Deserialized invalid Note data from MDS",e),null;const i=new se;i.id=e.id,i.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",i.floorId=e.floor.id,e.room&&e.room.id&&(i.roomId=e.room.id),i.resolved=e.resolution===h.$X.RESOLVED,i.created=(0,ye.XH)(e.created),i.modified=(0,ye.XH)(e.modified),i.user=this.userData.loadContributor(be(e.createdBy)),i.lastCommentMs=(0,ye.XH)(e.lastCommentAt).getTime();const n=this.deserializeComments(e);if(!(n.length>0))return Te.error("Note without a comment:",i.id),null;i.comments.replace(n),e.color&&(i.color=e.color);const s=e.anchorPosition?pe.U$.fromVisionVector(e.anchorPosition):void 0;s&&(i.anchorPosition=s),(0,we.Et)(e.stemLength)&&(i.stemLength=e.stemLength);const a=e.stemNormal?pe.U$.fromVisionVector(e.stemNormal):void 0;return a?(i.stemNormal=a,i.stemEnabled=!!e.stemEnabled):(i.stemNormal=new te.Vector3(0,0,0),i.stemEnabled=!!e.stemEnabled),i}deserializeComments(e){var t;const i=(null===(t=e.comments)||void 0===t?void 0:t.results)||[],n=[];return i.forEach((t=>{const i=this.commentDeserializer.deserialize(t);i&&(i.assetId=e.id,n.push(i))})),n}}class Se{constructor(){this.validate=e=>!!e}serialize(e){if(void 0===e.text)return null;const t={text:e.text};return t&&this.validate(t)?t:null}}class Ce extends ie.v{constructor(e){super(),this.id="",this.assetId="",this.text="",this.user=(0,ne.A)(""),this.created=new Date,this.modified=new Date,this.edited=!1,this.attachments=(0,J.Z)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.assetId=e.assetId,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.text=e.text,this.edited=e.edited,this.attachments=e.attachments,this.commit(),this}}const Ee=new d.Vy("mds-comment-deserializer");class Ae{constructor(e,t,i){this.fileDeserializer=e,this.embedDeserializer=t,this.userData=i}deserialize(e){if(!e||!this.validate(e))return Ee.debug("Deserialized invalid Comment data from MDS",e),null;const t=new Ce;t.id=e.id,t.created=(0,ye.XH)(e.created),t.modified=(0,ye.XH)(e.modified),e.text&&(t.text=e.text),t.edited=e.edited,t.user=this.userData.loadContributor(be(e.createdBy));const i=this.deserializeExternalAttachments(e),n=this.deserializeFileAttachments(e),s=i.concat(n).sort(((e,t)=>e.created.getTime()-t.created.getTime()));return s.length>0&&t.attachments.replace(s),t}deserializeExternalAttachments(e){const t=e.externalAttachments||[],i=[];return t.forEach((t=>{const n=this.embedDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=h.pi.COMMENT,i.push(n))})),i}deserializeFileAttachments(e){const t=e.fileAttachments||[],i=[];return t.forEach((t=>{const n=this.fileDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=h.pi.COMMENT,i.push(n))})),i}validate(e){if(!e)return!1;const t=["id","created","modified","edited","createdBy"].filter((t=>!(t in e))),i=0===t.length;return i||Ee.debug("Comment invalid:",{missingFields:t}),i}}var Pe=i(44919),Ie=i(6150);const ke=new d.Vy("MdsNoteStore");class Ne extends le.g{constructor(e,t){super(e),this.userData=t,this.layeredType=h.jM.NOTE,this.embedDeserializer=new he.g,this.fileDeserializer=new ue.x,this.commentDeserializer=new Ae(this.fileDeserializer,this.embedDeserializer,this.userData),this.deserializer=new De(this.commentDeserializer,this.userData),this.createSerializer=new ve,this.patchSerializer=new fe,this.commentSerializer=new Se}async read(e){const t={modelId:this.getViewId(),ids:null,includeLayers:this.readLayerId()};return this.query(Pe.GetNotes,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;if(!n||!Array.isArray(n))return{};const s=[];for(const e of n){const t=this.deserializer.deserialize(e);t&&s.push(t)}return s.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async readNote(e,t){const i={modelId:this.getViewId(),ids:[e],includeLayers:this.readLayerId()};return this.query(Pe.GetNotes,i,t).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;return n&&Array.isArray(n)&&1===n.length?this.deserializer.deserialize(n[0]):null}))}async create(e,t){var i;const n=this.getViewId(),s=this.createSerializer.serialize(e,t,this.writeLayerId(e.layerId));if(!s)throw ke.error("Failure creating note:",e.id,e),new Error("Could not create Note");const a={modelId:n,data:s,includeLayers:this.readLayerId()},o=await this.mutate(Pe.AddNote,a).catch((e=>{throw new ce.YA(e)}));if(null===(i=o.data)||void 0===i?void 0:i.addNote){const e=this.deserializer.deserialize(o.data.addNote);if(e)return e.layerId&&await this.context.updateForAutoProvisionedLayer(e.layerId),e}throw new Error("Unable to create new Note")}async update(e){const t=this.getViewId(),i=e.id,n=this.patchSerializer.serialize(e,!1);if(!n||!i)throw ke.error("Failure updating note:",i),new Error("Could not update Note");const s={modelId:t,noteId:i,data:n,includeLayers:this.readLayerId()};return this.mutate(Pe.PatchNote,s).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchNote)?this.deserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchNote):null}))}async updateResolution(e,t){const i={modelId:this.getViewId(),noteId:e};return t?this.mutate(Pe.ResolveNote,i).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.resolveNote})):this.mutate(Pe.ReopenNote,i).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.reopenNote}))}async delete(e){const t=this.getViewId();for(const i of e)await this.mutate(Pe.DeleteNote,{modelId:t,noteId:i.id})}async createComment(e,t){const i=this.getViewId(),n=this.commentSerializer.serialize(t);if(!n)throw ke.error("Failure creating comment:",t),new Error("Could not create Comment");const s={modelId:i,noteId:e,data:n};return this.mutate(Pe.AddNoteComment,s).then((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.addNoteComment)?this.commentDeserializer.deserialize(e.data.addNoteComment):null}))}async updateComment(e){const t=this.getViewId(),i=e.id,n=this.commentSerializer.serialize(e);if(!n||!i)throw ke.error("Failure updating comment:",i),new Error("Could not update Comment");const s={modelId:t,commentId:i,data:n};return this.mutate(Ie.PatchComment,s).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchComment)?this.commentDeserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchComment):null}))}async deleteComment(e){const t=this.getViewId();if(!e||!(null==e?void 0:e.id))throw new Error("MdsNoteStore.deleteComment failed");const i={modelId:t,commentId:e.id};await this.mutate(Ie.DeleteComment,i)}}var xe=i(62802),Me=i(94547),Oe=i(58899),Re=i(84917);class Le extends Oe.r{constructor(e,t,i,n,s,a,o,r,d){super(t,n,s),this.annotationsModule=e,this.notesModule=i,this.comment=a,this.note=o,this.asWholeNote=d,this.onSelect=async(e,t,i)=>{super.onSelect(),this.annotationsModule.closeOtherAnnotations();const n=t===y.S0.NOTES||i||e;await this.notesModule.openNoteToComment(this.note.id,n,!1,this.comment.id)},this.textParser=r,this.id=this.comment.id,this.parentId=this.note.id,this.title=this.comment.user.name,this.description=this.textParser.getPlainText(this.comment.text),this.icon="icon-comment",this.typeId=h.jM.NOTE,this.floorId=this.note.floorId,this.roomId=this.note.roomId||"",this.layerId=this.note.layerId,this.dateBucket=this.getNoteOrCommentDateBucket(),this.color=this.note.color,this.resolved=this.note.resolved,this.numAttachments=this.comment.attachments.length,this.numComments=this.note.comments.length,this.user=this.comment.user,this.enabled=!this.note.resolved}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}getNoteOrCommentDateBucket(){return(0,Re.n)(new Date(this.asWholeNote?this.note.lastCommentMs:this.comment.created))}}var Ve=i(56147);const{NOTES:je}=Ve.A.SHOWCASE;var Be=i(81530),Fe=i(78115),He=i(39118),Ue=i(93877),_e=i(96540),Ge=i(93388);function ze(){const e=(0,Ge.Y)(),[t,i]=(0,_e.useState)(e?e.openNoteView:null);return(0,_e.useEffect)((()=>{if(!e)return()=>{};const t=e.onOpenNoteViewChanged(i);return i(e.openNoteView),()=>t.cancel()}),[e]),t}(0,i(38064).c)("openNoteView",ze);var $e=i(64695),We=i(74481);function Ye(){const e=(0,Ge.Y)(),[t,i]=(0,_e.useState)((null==e?void 0:e.notesFilter)||ee.S.OPEN);return(0,_e.useEffect)((()=>{if(!e)return()=>{};const t=e.onNotesFilterChanged(i);return()=>t.cancel()}),[e]),t}var Ke=i(68419),Xe=i(78956),qe=i(87805);const Qe=(0,qe.u)(T.M,"softOpening",!1);var Je=i(22213),Ze=i(62834);const et=(0,qe.u)(Q.b,"isNewNote",!1);var tt=i(53289),it=i(54616),nt=i(17904),st=i(71687);function at(){return(0,nt.S)(st.TN)}function ot(){const e=(0,Ge.Y)(),[t,i]=(0,_e.useState)((null==e?void 0:e.notesPhase)||Y.f.CLOSED);return(0,_e.useEffect)((()=>{if(!e)return()=>{};const t=e.onNotesPhaseChanged(i);return i(e.notesPhase),()=>t.cancel()}),[e]),t}var rt=i(32485),dt=i.n(rt),lt=i(94799),ct=i(68375);function ht(){const e=(0,Ge.Y)(),[t,i]=(0,_e.useState)((null==e?void 0:e.activeNotation)||null);return(0,_e.useEffect)((()=>{if(!e)return()=>{};const t=e.onActiveNotationChanged(i);return()=>t.cancel()}),[e]),t}var ut=i(80411);function mt(e){const t=[];return e&&e.comments.forEach((e=>{t.push(...e.attachments)})),t}var pt=i(5013);function gt(e){const t=(0,pt.M)(),i=(0,it.P)();return!!t&&!!e&&z(i,t,F.U.NOTE,e?.user)}function vt(e){const t=(0,pt.M)(),i=(0,it.P)();return!!t&&!!e&&$(i,t,F.U.NOTE,e?.user)}var ft=i(39869);function yt(){const e=(0,it.P)(),[t,i]=(0,_e.useState)(e.getUsersWhoMayNeedAccess()||{});return(0,_e.useEffect)((()=>{function t(){i(e.getUsersWhoMayNeedAccess()||{})}const n=e.onChanged(t);return t(),()=>n.cancel()}),[e]),t}var wt=i(29397),bt=i(24865);const Tt=(0,i(98236).v_)(Z);function Dt(){const e=Tt(),[t,i]=(0,_e.useState)((null==e?void 0:e.getHashtags())||[]);return(0,_e.useEffect)((()=>{if(!e)return()=>{};function t(){i((null==e?void 0:e.getHashtags())||[])}const n=e.onChanged(t);return t(),()=>{n.cancel()}}),[e]),t}var St=i(39066),Ct=i(48270),Et=i(19389),At=i(32005),Pt=i(72909),It=i(77570),kt=i(67430),Nt=i(20835),xt=i(15684),Mt=i(75162),Ot=i(74848);const Rt=(0,_e.memo)((e=>{const{accept:t,id:i,multi:n,enabled:s,children:a,tooltip:o,onUpload:r}=e,d=`file-upload-${i}`;return(0,Ot.jsxs)("label",{className:"file-upload-trigger",htmlFor:d,"data-balloon":o,"data-balloon-pos":"down",children:[a,s&&(0,Ot.jsx)("input",{type:"file",className:"file-input",id:d,accept:t,multiple:!!n,onChange:e=>{let{currentTarget:t}=e;const i=t.files;i&&r(i),t.value=""}})]})})),Lt=(0,_e.createContext)(Rt),Vt=(0,_e.memo)((e=>{const{accept:t,id:i,multi:n,enabled:s,children:a,className:o,tooltip:r,onUpload:d}=e,l=(0,_e.useContext)(Lt);return(0,Ot.jsx)("div",{className:dt()("file-upload-button",o,{disabled:!s}),children:(0,Ot.jsx)(l,{id:i,accept:t,multi:n,children:a,onUpload:d,enabled:s,tooltip:r})})}));var jt=i(91977);const Bt=e=>{let{disabled:t,onDropped:i,children:n,className:s,onActivate:a,onDone:o}=e;const r=(0,_e.useRef)(null),d=(0,_e.useRef)(!1),l=(0,_e.useCallback)((()=>{!d.current&&r.current&&(a&&a(!0),d.current=!0,r.current.classList.add("active"))}),[a]),c=(0,_e.useCallback)((()=>{d.current&&r.current&&(d.current=!1,r.current.classList.remove("active"),o&&o())}),[o]),h=(0,_e.useCallback)((e=>{e.dataTransfer&&e.dataTransfer.types.includes("Files")&&(e.preventDefault(),e.stopPropagation(),l())}),[l]),u=(0,_e.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer&&e.dataTransfer.files&&i(e.dataTransfer.files),c()}),[i,c]),m=(0,_e.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),c()}),[c]),p=(0,_e.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),c()}),[c]);return(0,Ot.jsxs)("div",{className:s,onDragEnter:t?void 0:h,onDragLeave:t?void 0:p,onDragOver:t?void 0:h,onDragEnd:t?void 0:m,onDrop:t?void 0:u,children:[(0,Ot.jsxs)("div",{className:"file-drop-zone",ref:r,children:[(0,Ot.jsx)("span",{className:"icon icon-attach"}),(0,Ot.jsx)("label",{children:"Upload file"})]}),n]})};var Ft=i(64200),Ht=i(71397),Ut=new RegExp("^(?:(?:(?:https?|ftp):)?\\/\\/)(?:\\S+(?::\\S*)?@)?(?:(?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z0-9\\u00a1-\\uffff][a-z0-9\\u00a1-\\uffff_-]{0,62})?[a-z0-9\\u00a1-\\uffff]\\.)+(?:[a-z\\u00a1-\\uffff]{2,}\\.?))(?::\\d{2,5})?(?:[/?#]\\S*)?$","i");const _t=e=>(e=>Ut.test(e))(e)&&/^https?:\/\//.test(e);var Gt,zt,$t,Wt=i(44097);const Yt="";let Kt=(Gt=Reflect.metadata("design:type",Function),zt=Reflect.metadata("design:paramtypes",["undefined"==typeof SmartTextEditorProps?Object:SmartTextEditorProps]),(0,Pt.F)($t=Gt($t=zt($t=class extends _e.Component{static contextType=(()=>It.B)();textBox;suggestionMenuRef;emailMention=!1;wordToken=null;endTokens={"@":[","," ","!","?","/",";",":","(",")"],"#":[","," ",".","!","?","/",";",":"]};wordElement=null;linkElement=null;range;constructor(e){super(e),this.state={activeMatch:-1,matches:[],sortedSuggestions:[]}}componentDidMount(){this.props.active&&this.toggleEditing(!0,this.props.focusOnMount)}componentWillUnmount(){this.toggleEditing(!1),this.wordElement=null}componentDidUpdate(e,t){const{active:i}=this.props;i!==e.active&&this.toggleEditing(i)}toggleEditing(e,t){this.textBox&&this.textBox.toggleEditing(e,t),this.endWordMatching(),this.setState({sortedSuggestions:[]}),e?document.addEventListener("selectionchange",this.onSelectionChange):document.removeEventListener("selectionchange",this.onSelectionChange)}ensureActiveMatchIsVisible(e){if(!this.suggestionMenuRef)return;const{scrollTop:t,offsetHeight:i}=this.suggestionMenuRef,n=this.suggestionMenuRef.querySelector(`[data-index="${e}"]`);if(!n)return;const{offsetTop:s,offsetHeight:a}=n,o=t>s;if(t+i<s+a||o){const e=o;n.scrollIntoView(e)}}getTextElement(){return this.textBox?.getTextElement()}focus(){this.textBox&&this.textBox.focus()}getMarkdown(){const e=this.getTextElement();return e?this.props.textParser.serialize(e):""}hasTextSelected(){return!(!this.range||this.range.startOffset===this.range.endOffset)}createAnchor(e,t){const i=document.createElement("a");return i.href=t,i.text=this.props.textParser.sanitizeText(e),i.classList.add(v.H.LINK),i.setAttribute("data-value",t),i}prepareLinkForEdit(e){const t=e||this.getAnchorFromSelection();let i="";const n=window.getSelection();if(n){const e=this.getTextElement();t||this.range||!e?(this.addFauxHighlight(),t||(i=this.range?this.range.toString():n.toString())):(this.focus(),n.selectAllChildren(e),n.collapseToEnd(),this.range=n.getRangeAt(0),i=this.range.toString())}i===Yt&&(i=""),this.linkElement=t;const s=t?t.innerText:i,a=t?t.dataset.value||t.href:"";this.props.onClickBlock({blockType:f.n.LINK,text:s,value:a})}saveLink(e,t){this.linkElement?""!==t?this.updateLink(this.linkElement,e,t):this.unlink(this.linkElement):this.linkify(e,t)}updateLink(e,t,i){const n=this.createAnchor(t,i);return e.href=n.href,e.text=n.text,e.setAttribute("data-value",i),!0}cancelLink(){this.focus(),this.removeFauxHighlight()}linkify(e,t){this.removeFauxHighlight();const i=this.getCurrentRange();if(i){const n=document.createElement("a");n.href=t,n.text=e,n.className=`link-annotation ${v.H.LINK}`,n.setAttribute("data-blocktype",f.n.LINK),n.setAttribute("data-value",t),n.onclick=this.onClickAnchor,i.deleteContents(),i.insertNode(n),this.insertAndFocusCharacter(n)}}insertAndFocusCharacter(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Yt;if(this.range=this.getCurrentRange(),this.range){const n=document.createTextNode(i),s=t?"setStartBefore":"setStartAfter",a=t?"setEndBefore":"setEndAfter";this.range[s](e),this.range[a](e),this.range.insertNode(n),this.range.selectNodeContents(n),i!==Yt&&this.range.collapse(!1),this.applyRange()}}unlink(e){const t=e.parentNode,i=e.textContent;t&&(t.removeChild(e),i&&!_t(i)&&this.execCommand("insertText",i))}onClickAnchor=e=>{const t=e.target,i=t.dataset.blocktype;this.props.active?(e.preventDefault(),i===f.n.LINK&&this.prepareLinkForEdit(t)):i&&this.props.onClickBlock({blockType:i,text:t.innerText,value:t.dataset.value,id:t.dataset.id},e)};execCommand(e,t){this.range&&(this.applyRange(),document.execCommand(e,!1,t),this.onSelectionChange())}applyRange(){if(this.range){const e=window.getSelection();e&&(e.removeAllRanges(),e.addRange(this.range))}}getAnchorFromSelection(){const e=this.getCurrentRange();if(!e)return null;let t=e.commonAncestorContainer;for(;t&&"A"!==t.nodeName;){if(t===this.getTextElement())return null;t=t.parentNode}return t||null}insertFocusNodeIfNeeded(){const e=window.getSelection();if(!e||!this.range)return;const{anchorNode:t,isLinkNode:i}=this.tryGetAnchorNode();if(t){const n=t.textContent?.length??0,s=0===e.focusOffset&&n>0,a=null===t.nextSibling&&n===e.focusOffset&&i;(s||a)&&this.insertAndFocusCharacter(t,s)}}onSelectionChange=()=>{const e=this.getCurrentRange();if(e){this.range=e.cloneRange();const t=this.wordElement&&null===this.wordElement.parentElement,i=!!this.wordElement&&this.wordElement!==this.getAnchorFromSelection();(t||i)&&this.wordElement&&(this.wordElement.classList.add("link-annotation-active"),this.endWordMatching()),this.insertFocusNodeIfNeeded()}};getCurrentRange(){const e=window.getSelection();if(e&&e.rangeCount>0){const t=e.getRangeAt(0),i=this.getTextElement();if(i&&(i===t.commonAncestorContainer||i.compareDocumentPosition(t.commonAncestorContainer)&Node.DOCUMENT_POSITION_CONTAINED_BY))return t}return null}addFauxHighlight=()=>{this.execCommand("backColor","#ff315840")};removeFauxHighlight=()=>{this.execCommand("backColor","transparent")};sortWords(e){return e.sort(((e,t)=>e.text.toLowerCase()<t.text.toLowerCase()?-1:1))}tryGetAnchorNode(){const e=this.getAnchorFromSelection();if(e&&e instanceof HTMLAnchorElement){const t=e.dataset?.blocktype,i=t===f.n.USER||t===f.n.HASH,n=t===f.n.LINK;return{isSpecialNode:i,isLinkNode:n,anchorNode:i||n?e:null}}return{isSpecialNode:!1,isLinkNode:!1,anchorNode:null}}isEmailMention=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").lastIndexOf("@")>0};updateWordElement(e,t,i){const n=e.inputType.startsWith("delete"),s=window.getSelection(),a=this.startTokens;if(!this.wordElement||this.wordElement.parentElement){if(t&&i&&i.parentElement&&s){const e=i.textContent||"";if(!a.includes(e[0]||""))return void this.clearWordElement();const t=e.substr(0,s.focusOffset),o=s&&s.focusOffset<e.length,r=n||o;if(this.wordElement=i,this.wordToken=t[0],this.emailMention=this.isEmailMention(t),this.updateSuggestions(),this.range=this.getCurrentRange(),r&&this.range){this.range.selectNode(i);const n=this.range.extractContents();if(n&&n.firstElementChild&&n.firstElementChild instanceof HTMLElement){const i=e.substring(t.length),s=document.createTextNode(i);n.firstElementChild.innerText=t,n.firstElementChild.classList.remove("link-annotation-active"),n.firstElementChild.removeAttribute("data-value"),n.firstElementChild.removeAttribute("data-id"),n.appendChild(s),this.range.insertNode(n),this.range.setStartBefore(s),this.range.setEndBefore(s),this.range.collapse(!1),this.range.selectNodeContents(this.wordElement),this.range.collapse(!1),this.applyRange()}}}}else this.endWordMatching()}get startTokens(){const{hashtags:e,userMentions:t}=this.props,i=[];return t&&i.push("@"),e&&i.push("#"),i}onInput=e=>{const t=e.nativeEvent,i=t.inputType,n=i.startsWith("insert"),s="insertLineBreak"===i,a=t.data,o=this.startTokens;e.stopPropagation();const{isLinkNode:r,isSpecialNode:d,anchorNode:l}=this.tryGetAnchorNode();if(o.length&&!r&&!s){let s=a&&a.length>0?a.charAt(a.length-1):"";const r=this.getTextElement(),c=(r?.innerText||"").trim().length;if(r&&i.startsWith("delete")&&0===c&&(r.innerHTML=""),this.updateWordElement(t,d,l),!this.wordToken&&o.includes(s)?(e.preventDefault(),this.wordToken=s,this.emailMention=!1,this.createWordElement(s),this.updateSuggestions()):!this.wordToken&&a&&a.length>1&&o.includes(a[0])&&(e.preventDefault(),this.wordToken=a[0],s=a[a.length-1],this.emailMention=this.isEmailMention(a),this.createWordElement(a),this.updateSuggestions()),this.wordToken&&this.wordElement){const t=this.wordElement.textContent||"",i=this.getMatches(t),a=i.length,o=this.endTokens[this.wordToken]?.includes(s);1===a&&this.sanitizeForSearch(t)===this.sanitizeForSearch(i[0].text)&&n?(e.preventDefault(),this.chooseMatch(i[0].text,i[0].value,i[0].id)):o&&"#"===this.wordToken?(e.preventDefault(),this.finishWordElement(!0)):o&&"@"===this.wordToken?(e.preventDefault(),this.emailMention?this.finishWordElement(!0):0===a&&this.clearWordElement()):"@"===this.wordToken?(this.updateUserMatches(),this.isEmailMention(t)&&(this.wordElement.classList.add("link-annotation-active"),this.emailMention=!0)):this.filterSuggestions()}}this.props.onInput(this.getMarkdown())};updateUserMatches=(()=>(0,Ft.s)((()=>this.fetchUserMatches()),350))();fetchUserMatches(){const e=this.wordElement?this.wordElement.textContent:null;if(this.props.active&&this.wordToken&&e){const t=this.sanitizeForSearch(e,!0);this.context.commandBinder.issueCommand(new A.ly(t)).then((()=>{this.updateSuggestions()}))}}filterSuggestions(){const{wordToken:e,wordElement:t}=this;if(e&&t&&t.textContent){const e=this.sanitizeForSearch(t.textContent),i=this.getMatches(e),n=i.length>0?0:-1;this.setState({matches:i,activeMatch:n})}}sanitizeForSearch(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1?arguments[1]:void 0;if(!this.wordToken)return e;let i=(e.startsWith(this.wordToken)?e.substr(1):e).toLowerCase().trim().replace(/\s\s+/g," ");if(t){const e=/([^\s]+)/.exec(i);i=e&&e[0]||""}return i}getMatches(e){const{sortedSuggestions:t=[]}=this.state,i=this.sanitizeForSearch(e)||"";return 0===i.length?t:t.filter((e=>{let t=0===this.sanitizeForSearch(e.text).indexOf(i);return!t&&"@"===this.wordToken&&e.value&&(t=0===this.sanitizeForSearch(e.value).indexOf(i)),t}))}chooseMatch(e,t,i){const n=this.wordElement;if(n){const s=this.wordToken&&!e.startsWith(this.wordToken)?this.wordToken:"";n.innerText=`${s}${e}`,n.classList.add("link-annotation-active"),t&&n.setAttribute("data-value",t),i&&n.setAttribute("data-id",i),this.finishWordElement(!1,!0),this.props.onInput(this.getMarkdown())}}onClickMatch=e=>{const t=e.currentTarget;if(t){const i=t.dataset.value,n=t.dataset.id,s=t.dataset.text||t.innerText;e.stopPropagation(),e.preventDefault(),this.chooseMatch(s,i,n)}};onHoverMatch=e=>{const t=e.currentTarget;if(t){const e=parseInt(t.dataset.index||"0",10);this.setState({activeMatch:e})}};updateSuggestions(){const{wordToken:e}=this,{hashtags:t,userMentions:i}=this.props;let n=[];if("#"===e&&t)n=this.sortWords(t.map((e=>({text:e,blockType:f.n.HASH}))));else if("@"===e&&i){const e=this.context.userData.getKnownUsers();n=this.sortWords(e.map((e=>({text:e.name,id:e.id,value:e.email,blockType:f.n.USER}))))}this.setState({sortedSuggestions:n},this.filterSuggestions)}endWordMatching(){this.setState({matches:[],activeMatch:-1}),this.wordToken=null,this.wordElement=null,this.emailMention=!1}createWordElement(e){const t=window.getSelection(),i=this.range;if(!i||!t||!this.wordToken)return;const n=document.createElement("a");n.removeAttribute("href"),n.innerText=e,"#"===this.wordToken?(n.className=`link-annotation ${v.H.HASH}`,n.setAttribute("data-blocktype",f.n.HASH)):"@"===this.wordToken&&(n.className=`link-annotation ${v.H.USER}`,n.setAttribute("data-blocktype",f.n.USER));const s=i.startContainer,a=i.startOffset,o=i.endOffset+e.length,r=Math.max(0,(s.textContent||"").length);try{i.setStart(s,Math.min(a,r)),i.setEnd(s,Math.min(o,r))}catch(e){i.selectNodeContents(s)}i.deleteContents(),i.insertNode(n),i.selectNodeContents(n),i.collapse(!1),this.applyRange(),this.wordElement=n}clearWordElement(){const e=this.range,t=window.getSelection();e&&t&&this.wordElement&&this.wordToken&&(this.stripAnchorFromNode(this.wordElement),this.endWordMatching())}stripAnchorFromNode(e){const t=this.range;if(!t)return;const i=e.textContent;if(this.focus(),t.selectNode(e),t.deleteContents(),t.collapse(!1),i){const e=document.createTextNode(i);t.insertNode(e),t.selectNodeContents(e),t.collapse(!1)}this.applyRange()}isValidSpecialWord(e,t){return 0!==this.sanitizeForSearch(t).length||(this.clearWordElement(),!1)}finishWordElement(e,t){const{range:i,wordElement:n,wordToken:s}=this,a=window.getSelection();if(!(i&&a&&n&&s))return;n.contentEditable="true",n.classList.add("link-annotation-active");let o="";const r=n.textContent;if(this.isValidSpecialWord(s,r||"")){if(e&&r&&r.length>1?(o=r.charAt(r.length-1),n.textContent=r.slice(0,-1)):t&&(o=" "),this.focus(),i.setStartAfter(n),o){const e=document.createTextNode(o);i.insertNode(e),i.selectNodeContents(e),i.collapse(!1)}this.applyRange(),this.endWordMatching()}else this.clearWordElement()}onClick=e=>{const{active:t,clickToEdit:i,onStartEditing:n}=this.props;t?(this.removeFauxHighlight(),this.range=null):i&&n&&n(e)};handleFocus=()=>{const{onFocusChange:e}=this.props;e&&e(!0)};onBlur=()=>{this.endWordMatching(),this.setState({sortedSuggestions:[]});const{onFocusChange:e}=this.props;e&&e(!1)};onDone=()=>{const{onDoneEditing:e}=this.props;e?e():this.toggleEditing(!1)};onKeyDown=e=>{const{onCancelEditing:t,allowTabbing:i,allowReturnKey:n}=this.props,{matches:s,activeMatch:a}=this.state;e.stopPropagation(),this.range||=this.getCurrentRange();const o=e.which||e.keyCode;switch(o){case Ht.D.ESCAPE:return void(t&&t());case Ht.D.TAB:case Ht.D.RETURN:if(s.length&&a>-1)e.preventDefault(),this.chooseMatch(s[a].text,s[a].value,s[a].id);else{const{isSpecialNode:t,anchorNode:s}=this.tryGetAnchorNode();if(t&&s&&this.range&&(e.preventDefault(),this.insertAndFocusCharacter(s,!1,`\n${Yt}`)),this.wordToken&&(e.preventDefault(),this.finishWordElement(!1,!0)),!e.shiftKey){const t=o===Ht.D.TAB&&i,s=o===Ht.D.RETURN&&n;t||s||(e.preventDefault(),this.onDone())}}return;case Ht.D.DOWNARROW:return void(s.length&&(e.preventDefault(),this.setState((e=>{const t=(e.activeMatch+1)%s.length;return this.ensureActiveMatchIsVisible(t),{activeMatch:t}}))));case Ht.D.UPARROW:return void(s.length&&(e.preventDefault(),this.setState((e=>{const t=0===e.activeMatch?s.length-1:e.activeMatch-1;return this.ensureActiveMatchIsVisible(t),{activeMatch:t}}))));case Ht.D.B:case Ht.D.I:case Ht.D.U:if(e.ctrlKey||e.metaKey)return void e.preventDefault();break;case Ht.D.BACKSPACE:case Ht.D.SHIFT:case Ht.D.CONTROL:case Ht.D.ALT:case Ht.D.LEFTARROW:case Ht.D.RIGHTARROW:case Ht.D.DELETE:return}};saveRef=e=>{this.textBox=e};bindSuggestionMenuRef=e=>{this.suggestionMenuRef=e};renderMatch(e,t){const{activeMatch:i}=this.state,n=t===i,s=e.blockType===f.n.USER,a=s&&e.value?this.context.userData.getUserDisplay(e.value):null,o=s?e.value:void 0,r=`${e.text}-${t}`;return(0,Ot.jsxs)("div",{className:dt()("suggestion",{selected:n}),onMouseDown:this.onClickMatch,onMouseEnter:this.onHoverMatch,"data-value":e.value,"data-id":e.id,"data-text":e.text,"data-index":t,children:[s&&a&&(0,Ot.jsx)(At.E,{badgeStyle:{color:a.color,borderColor:a.color,backgroundColor:"transparent"},label:a.initials}),(0,Ot.jsx)("span",{className:"suggestion-text",children:e.text}),o&&(0,Ot.jsxs)("p",{className:"suggestion-hint",children:["(",o,")"]})]},r)}renderMatches(){if(!this.props.active)return null;const{matches:e}=this.state,t=e.length>0;return(0,Ot.jsx)("div",{className:dt()("suggestion-menu",{open:t}),ref:this.bindSuggestionMenuRef,children:t&&e.map(((e,t)=>this.renderMatch(e,t)))})}render(){const{text:e,textParser:t,clickToEdit:i,placeholder:n,tabIndex:s,className:a,active:o}=this.props;return(0,Ot.jsxs)("div",{className:dt()("smart-text-box",a),children:[(0,Ot.jsx)(Wt.A,{ref:this.saveRef,text:e,textParser:t,active:o,placeholder:n,tabIndex:s,clickToEdit:i&&!o,onClick:this.onClick,onInput:this.onInput,onKeyDown:this.onKeyDown,onBlur:this.onBlur,onFocus:this.handleFocus,onClickAnchor:this.onClickAnchor}),this.renderMatches()]})}})||$t)||$t)||$t);var Xt=i(94448),qt=i(16700);const Qt=9,Jt=13,Zt=27;function ei(e){let{text:t,name:i,label:n,type:s="text",readonly:a,autofocus:o,autocomplete:r="on",placeholder:d,className:l,maxLength:c,onInput:h,onBlur:u,onFocus:m,onKeyDown:p,onKeyUp:g,onReturn:v,onCancel:f,onPaste:y,ref:w}=e;const b=(0,_e.useRef)(null),[T,D]=(0,_e.useState)(t),[S,C]=(0,_e.useState)(!!o),[E,A]=(0,_e.useState)(!1),P=(0,_e.useId)(),I=(0,qt.bt)("mp-text-input"),k=i||P;(0,_e.useImperativeHandle)(w,(()=>({focus:()=>{b.current===document.activeElement&&b.current?.blur(),b.current?.focus()},blur:()=>{b.current?.blur()},setText:e=>{b.current?.setRangeText(e)}})),[b]),(0,_e.useEffect)((()=>(D(t),A(!1),()=>{})),[t]),(0,_e.useEffect)((()=>(b.current&&o&&b.current.focus(),()=>{})),[o,b]),(0,_e.useEffect)((()=>(E&&v&&b.current&&b.current.blur(),()=>{})),[E,b,v]);const N=(0,_e.useCallback)((e=>{const t=e.target;D(t.value),h(t.value)}),[h,D]),x=(0,_e.useCallback)((e=>{const t=e.target.value;E&&v?(A(!1),v(t)):u&&u(t),C(!1)}),[u,v,E]),M=(0,_e.useCallback)((e=>{m&&m(e),C(!0)}),[m]),O=(0,_e.useCallback)((e=>{e.stopPropagation();const t=e.which||e.keyCode;t===Jt&&A(!0);const i=[Qt,Jt,Zt];if("keydown"===e.type&&!i.includes(t))return!1;const n=e.target.value;if(c&&n.length>c&&e.preventDefault(),t===Zt)f&&f();return!1}),[f,c]),R=(0,_e.useCallback)((e=>{let t=!1;p&&(t=p(e)),t||O(e)}),[O,p]),L=(0,_e.useCallback)((e=>{let t=e.clipboardData.getData("text/plain").trim();c&&(t=t.substring(0,Math.min(c,t.length))),y&&y(t)}),[y,c]),V=(0,_e.useCallback)((e=>{g&&g(e),e.stopPropagation()}),[g]),j=dt()("mp-text-input",I,l,{focused:S}),B=n&&(S||!(""===T)),F=S?"":d;return(0,Ot.jsxs)("div",{className:j,children:[B&&(0,Ot.jsx)("label",{className:"mp-text-input-label",htmlFor:k,children:n}),(0,Ot.jsx)("input",{ref:b,autoComplete:r,className:"mp-input",name:k,type:s,value:T,placeholder:F,maxLength:c,onInput:N,onBlur:x,onFocus:M,onKeyPress:O,onKeyDown:R,onKeyUp:V,onPaste:L,readOnly:a})]})}const{MATTERTAGS:ti}=Ve.A.WORKSHOP;function ii(e){const{url:t,text:i,error:n,newLink:s}=e,a=(0,ft.Y)(),o=""===i&&""===t&&s?a.t(ti.LINK_EDITOR_TIP_TEXT):null,r=n?a.t(ti.LINK_EDITOR_INVALID_TIP):null,d=dt()("modal-message",{"modal-message-error":!!n}),l=r||o||"";return(0,Ot.jsx)("div",{className:d,children:l})}const{MATTERTAGS:ni,MODAL:si}=Ve.A.WORKSHOP;function ai(e){return _t(e)}function oi(e){const{linkUrl:t,linkText:i,onSaveLink:n,onRemoveLink:s,onCancelLink:a}=e,o=(0,ft.Y)(),[r,d]=(0,_e.useState)(!1),[l,c]=(0,_e.useState)(i),[h,u]=(0,_e.useState)(t),[m,p]=(0,_e.useState)(ai(t));(0,_e.useEffect)((()=>(u(t),c(i),p(ai(t)),d(!1),()=>{})),[i,t]);const g=(0,_e.useCallback)((()=>{m&&window.open(h,"_blank","noreferrer")}),[h,m]),v=(0,_e.useCallback)(((e,t)=>{const i=void 0!==t?t:h;n((void 0!==e?e:l)||i,i)}),[h,l,n]),f=(0,_e.useCallback)((()=>{v(l,h)}),[v,l,h]),y=(0,_e.useCallback)(((e,t)=>{const i=ai(e);p(i),d(!i&&""!==e),t&&i&&v(l,e)}),[l,v]),w=(0,_e.useCallback)((e=>{c(e)}),[]),b=(0,_e.useCallback)((e=>{u(e);const t=ai(e);p(t),r&&t&&d(!1)}),[r]),T=(0,_e.useCallback)((()=>{y(h,!1)}),[h,y]),D=(0,_e.useCallback)((()=>{y(h,!0)}),[h,y]),S=!t,C=o.t(ni.LINK_EDITOR_TEXT_PLACEHOLDER),E=o.t(si.SAVE),A=o.t(si.CANCEL),P=o.t(ni.LINK_EDITOR_PREVIEW_TIP),I=o.t(ni.LINK_EDITOR_REMOVE_TIP),k=!S&&s;return(0,Ot.jsxs)("div",{className:"modal-contents",children:[(0,Ot.jsxs)("div",{className:"modal-body",children:[(0,Ot.jsx)("div",{className:"link-editor-field link-text-field",children:(0,Ot.jsx)(ei,{text:l,placeholder:C,autofocus:!i,onInput:w,onCancel:a})}),(0,Ot.jsxs)("div",{className:"link-editor-field link-url-field",children:[(0,Ot.jsx)(ei,{text:h,type:"url",placeholder:"https://",autofocus:!!i,onBlur:T,onReturn:D,onInput:b,onCancel:a}),m&&h&&(0,Ot.jsx)(Et.$,{className:"preview-link",icon:"ext-link",variant:Ct.A.TERTIARY,size:Ct.M.SMALL,tooltip:P,onClick:g})]}),(0,Ot.jsx)(ii,{newLink:S,text:i,url:h,error:r})]}),(0,Ot.jsx)("div",{className:"modal-footer",children:(0,Ot.jsxs)(jt.e,{className:dt()("modal-footer",{stretch:k}),children:[k&&(0,Ot.jsx)(Et.$,{icon:"delete",label:I,className:"remove-link",variant:Ct.A.TERTIARY,size:Ct.M.SMALL,onClick:s}),(0,Ot.jsxs)(jt.e,{spacing:"small",children:[(0,Ot.jsx)(Et.$,{label:A,variant:Ct.A.SECONDARY,size:Ct.M.SMALL,onClick:a}),(0,Ot.jsx)(Et.$,{label:E,variant:Ct.A.PRIMARY,disabled:!m,size:Ct.M.SMALL,onClick:f})]})]})})]})}var ri=i(40961),di=i(16876),li=i(43960),ci=i(28422),hi=i(90087),ui=i(19072);function mi(e){let{children:t,className:i,title:n,open:s,onClose:a,fullModal:o=!1,noHeader:r=!1,preventClose:d=!1}=e;const l=(0,ui.x)(),c=(0,hi.L)(),h=(0,_e.useRef)(!1),u=(0,_e.useCallback)((()=>{d||(c.issueCommand(new S.rH),a&&a())}),[c,a,d]),m=(0,_e.useCallback)((()=>{h.current=!0,window.setTimeout((()=>{h.current=!1}),500)}),[]),p=(0,_e.useCallback)((()=>{h.current&&(h.current=!1,u())}),[u]),g=l.querySelector("#react-render-root")||document.body,v=dt()(i,{open:s,"full-modal":o});return(0,ri.createPortal)((0,Ot.jsx)(di.w,{open:s,className:dt()("modal-background",{open:s}),onPointerUp:p,onPointerDown:m,children:(0,Ot.jsxs)(li.l,{className:v,onClose:u,children:[r?null:(0,Ot.jsxs)("header",{className:"modal-header",children:[(0,Ot.jsx)("div",{className:"modal-title",children:n}),(0,Ot.jsx)(ci.J,{onClose:u})]}),t]})}),g)}const{MATTERTAGS:pi}=Ve.A.WORKSHOP;function gi(e){const{linkUrl:t,linkText:i,onSaveLink:n,onRemoveLink:s,onCancelLink:a}=e,o=(0,ft.Y)(),r=(0,Ke.t)(),d=""===t?o.t(pi.LINK_EDITOR_LINK_ADD_LABEL):o.t(pi.LINK_EDITOR_LINK_EDIT_LABEL),l=r===Je.a.LINK_EDITOR;return(0,Ot.jsx)(mi,{open:l,title:d,fullModal:!1,className:"link-editor-modal",children:(0,Ot.jsx)(oi,{linkText:i,linkUrl:t,onCancelLink:a,onSaveLink:n,onRemoveLink:s})})}var vi=i(41984);const fi=/[^]*youtube.com\/shorts\//gi;var yi,wi,bi,Ti=i(30278);const{EMBED:Di}=Ve.A.WORKSHOP;let Si=function(e){return e.NONE="none",e.INVALID_URL_SYNTAX="invalid",e.LOADING="loading",e.LOADED="loaded",e.ERROR="error",e}({}),Ci=(yi=Reflect.metadata("design:type",Function),wi=Reflect.metadata("design:paramtypes",["undefined"==typeof MediaEmbedEditorProps?Object:MediaEmbedEditorProps]),(0,Pt.A)(bi=yi(bi=wi(bi=class e extends _e.Component{static contextType=(()=>It.B)();static supportPage="https://support.matterport.com/hc/en-us/articles/115006363868-Add-Multimedia-to-a-Mattertag-Post";inputRef=(()=>(0,_e.createRef)())();isUnmounting=!1;attachmentsModule;constructor(e){super(e),this.state={currentUrl:e.url||"",validationPhase:Si.NONE,error:void 0}}componentDidMount(){this.context.engine.getModuleBySymbol(st.qy).then((e=>{this.attachmentsModule=e}))}componentWillUnmount(){this.isUnmounting=!0,this.setState({currentUrl:"",validationPhase:Si.NONE,error:void 0})}componentDidUpdate(e,t){const{url:i,onValidationPhaseChange:n}=this.props;let s=this.state.validationPhase;i!==e.url&&(s=Si.NONE,this.setState({currentUrl:i||"",validationPhase:Si.NONE,error:void 0})),n&&s!==t.validationPhase&&n(s)}focus(){this.inputRef.current&&this.inputRef.current.focus()}onInput=e=>{const t=_t(e)?Si.NONE:Si.INVALID_URL_SYNTAX;this.setState({validationPhase:t,currentUrl:e})};onApply=()=>{this.isDisabled()||this.onDoneEditing(this.state.currentUrl)};stopPropagation=e=>{e.stopPropagation()};onDoneEditing=async e=>{const{onEmbed:t,onEmbedCleared:i,url:n}=this.props;if(""===e)return i&&i(),void this.setState({validationPhase:Si.NONE,error:void 0,currentUrl:""});const s=(e=>{if(fi.test(e))return`https://youtube.com/watch?v=${e.replace(fi,"").replace(/\?(.*)/g,"")}`;return e})(e);if(s&&s!==n)try{const e=await this.loadMedia(s);if(this.isUnmounting)return;e?(this.setState({validationPhase:Si.LOADED,error:void 0,currentUrl:s}),t(e)):this.onEmbedError(s)}catch(e){if(this.isUnmounting)return;this.onEmbedError(s,e)}};onEmbedError(e,t){this.setState({error:t,validationPhase:Si.ERROR,currentUrl:e})}loadMedia=async e=>{const{parentId:t,parentType:i}=this.props;return this.setState({validationPhase:Si.LOADING}),this.attachmentsModule.embedMedia(t,i,e)};isDisabled(){const{validationPhase:e,currentUrl:t}=this.state;return e===Si.ERROR||e===Si.LOADING||e===Si.INVALID_URL_SYNTAX&&""!==t||""===t}renderError(){const{locale:t}=this.context,{error:i}=this.state;let n=t.t(Di.ERROR_MESSAGE);return i instanceof Ti.aI?n=t.t(Di.PROVIDER_NOT_SUPPORTED_MESSAGE):i instanceof Ti.Dm&&(n=t.t(Di.LINK_TYPE_NOT_SUPPORTED_MESSAGE)),(0,Ot.jsxs)("div",{className:"popover-message popover-message-error",children:[n,"",(0,Ot.jsx)("a",{className:"link",target:"_blank",rel:"noreferrer",href:e.supportPage,children:t.t(Di.HELP_CTA)})]})}renderHelpMessage(){const{locale:t}=this.context,{currentUrl:i,validationPhase:n}=this.state;switch(n){case Si.ERROR:return this.renderError();case Si.LOADING:return(0,Ot.jsx)("div",{className:"popover-message",children:t.t(Di.LOADING_MESSAGE)});case Si.INVALID_URL_SYNTAX:if(""!==i)return(0,Ot.jsx)("div",{className:"popover-message popover-message-error",children:t.t(Di.INVALID_URL_MESSAGE)})}return(0,Ot.jsx)("div",{className:"popover-message",children:(0,Ot.jsx)("a",{className:"link",target:"_blank",href:e.supportPage,tabIndex:-1,children:t.t(Di.SUPPORTED_FORMATS_MESSAGE)})})}render(){const{locale:e}=this.context,{className:t,tabIndex:i}=this.props,{currentUrl:n}=this.state,s=void 0!==i&&i>=0,a=e.t(Di.MEDIA_EMBED_PLACEHOLDER);return(0,Ot.jsxs)(Ot.Fragment,{children:[(0,Ot.jsxs)("div",{className:"media-embed-editor",onClick:this.stopPropagation,children:[(0,Ot.jsx)(vi.A,{ref:this.inputRef,text:n,type:"url",className:dt()(t),placeholder:a,onDone:this.onDoneEditing,onInput:this.onInput,allowTabbing:s,tabIndex:i}),(0,Ot.jsx)("div",{className:"popover-footer",children:this.renderHelpMessage()})]}),(0,Ot.jsx)("div",{className:"modal-footer embed-apply",children:(0,Ot.jsx)(Et.$,{variant:Ct.A.PRIMARY,size:"small",disabled:this.isDisabled(),onClick:this.onApply,label:e.t(Di.APPLY_CTA)})})]})}})||bi)||bi)||bi);const{EMBED:Ei}=Ve.A.WORKSHOP;function Ai(e){const{parentType:t,parentId:i,onEmbed:n,onCancel:s}=e,a=(0,ft.Y)(),o=(0,Ke.t)(),r=a.t(Ei.MEDIA_LINK_LABEL),d=o===Je.a.MEDIA_EMBED_POPUP;return(0,Ot.jsx)(mi,{open:d,title:r,fullModal:!1,className:"media-embed-popup",onClose:s,children:(0,Ot.jsx)(Ci,{parentId:i,parentType:t,onEmbed:n})})}function Pi(e){let{current:t,min:i,max:n}=e;const s=void 0!==i&&t<i||t>n;return(0,Ot.jsxs)("div",{className:dt()("text-counter",{error:s}),children:[t,"/",n]})}var Ii,ki,Ni;i(72286);const{ANNOTATIONS:xi}=Ve.A.SHOWCASE;let Mi=(Ii=Reflect.metadata("design:type",Function),ki=Reflect.metadata("design:paramtypes",["undefined"==typeof AnnotationProps?Object:AnnotationProps]),(0,Pt.A)(Ni=Ii(Ni=ki(Ni=class extends _e.Component{static contextType=(()=>It.B)();uploadTooltipTimeout=0;bindings=[];textEditor;attachmentsData;annotationsModule;attachmentsModule;isUnmounting=!1;constructor(e){super(e),this.state={textChanged:!1,charCount:e.text.length,selectedBlock:null,showUploadTooltip:!1,pendingAttachments:[],removedAttachments:[],uploads:[],failures:[]}}componentDidMount(){this.context.market.waitForData(Nt.v).then((e=>{this.attachmentsData=e,this.bindings.push(this.attachmentsData.onChanged(this.updateAttachments)),this.isUnmounting||this.updateAttachments()})),this.context.engine.getModuleBySymbol(st.Et).then((e=>{this.annotationsModule=e})),this.context.engine.getModuleBySymbol(st.qy).then((e=>{this.attachmentsModule=e}))}componentWillUnmount(){this.isUnmounting=!0,window.clearTimeout(this.uploadTooltipTimeout);for(const e of this.bindings)e.cancel()}componentDidUpdate(e,t){const{active:i,parentId:n,parentType:s}=this.props;e.active&&!i?this.setState({textChanged:!1,pendingAttachments:[],removedAttachments:[],uploads:[],failures:[]}):n===e.parentId&&s===e.parentType||this.updateAttachments()}edit(){this.textEditor&&this.textEditor.toggleEditing(!0)}focus(){this.textEditor&&this.textEditor.focus()}getAttachmentsState=()=>{if(!this.attachmentsData)return;const{active:e,parentId:t,parentType:i}=this.props;if(!e)return;return{pendingAttachments:this.attachmentsData.getPendingAttachmentsForAsset(t,i),removedAttachments:this.attachmentsData.getRemovedAttachmentsForAsset(t,i),failures:this.attachmentsData.failures.values,uploads:this.attachmentsData.uploads.values}};updateAttachments=()=>{const e=this.getAttachmentsState();e&&this.setState(e)};cancelEdits=()=>{this.props.onCancelEditing&&this.props.onCancelEditing()};saveEdits=()=>{this.onDoneEditing()};onDoneEditing=()=>{const{onDoneEditing:e}=this.props;if(e){const t=this.getMarkdown();e(t,""===t&&0===this.getAttachmentCount())}};onInput=e=>{this.setState({textChanged:e.trim()!==this.props.text,charCount:e.length})};openLinkEditor=()=>{!(this.props.openModal===Je.a.LINK_EDITOR)&&this.textEditor&&(this.context.analytics.trackGuiEvent("annotation_open_link_editor",{tool:"notes"}),this.textEditor.prepareLinkForEdit())};onClickBlock=(e,t)=>{const{active:i,annotationType:n,annotationId:s,linkHandler:a}=this.props,o=e.blockType;if(o===f.n.LINK&&i)this.setState({selectedBlock:e}),this.context.commandBinder.issueCommand(new S.X6(Je.a.LINK_EDITOR,!0));else if(!i){if(o===f.n.LINK&&a&&e.value){t&&t.preventDefault();const i=(0,kt.A)(e.value),{url:o,modelId:r,pose:d}=i;r?a.handler.openLink({fullLink:o,modelId:r}):d?(a.handler.openLink({fullLink:o,pose:d}),this.annotationsModule?.closeAnnotation(s,n)):a.handler.openLink(o)}this.context.messageBus.broadcast(new U.v(n,s,e))}};closeLinkEditor=async()=>(this.setState({selectedBlock:null}),this.context.commandBinder.issueCommand(new S.X6(Je.a.LINK_EDITOR,!1)));onCancelLink=async()=>{await this.closeLinkEditor()};openEmbedEditor=()=>{this.context.analytics.trackGuiEvent("annotation_open_embed_editor",{tool:"notes"}),this.context.commandBinder.issueCommand(new S.X6(Je.a.MEDIA_EMBED_POPUP,!0))};closeEmbedEditor=()=>{this.context.commandBinder.issueCommand(new S.X6(Je.a.MEDIA_EMBED_POPUP,!1))};onRemoveLink=()=>{this.onSaveLink("","")};onSaveLink=(e,t)=>{this.props.openModal===Je.a.LINK_EDITOR&&this.textEditor&&(this.setState({textChanged:!0}),this.textEditor.saveLink(e,t),this.closeLinkEditor())};onClickFileInput=()=>{const{active:e,onClickToEdit:t}=this.props;this.isAtMaxAttachments()?(window.clearTimeout(this.uploadTooltipTimeout),this.setState({showUploadTooltip:!0}),this.uploadTooltipTimeout=window.setTimeout((()=>{this.setState({showUploadTooltip:!1})}),2500)):!e&&t&&t()};onFileUpload=e=>{const{parentId:t,parentType:i}=this.props,n=Array.from(e),s=this.getAttachmentCount();e.length+s>xt.iS&&n.splice(xt.iS-s),this.attachmentsModule.uploadAttachments(t,i,n),this.edit()};onDrop=e=>{this.context.analytics.trackGuiEvent("attachment_drag_and_dropped",{tool:"notes"}),this.onFileUpload(e)};onFilesChosen=e=>{this.context.analytics.trackGuiEvent("annotation_files_chosen",{tool:"notes"}),this.onFileUpload(e)};dropActivated=()=>{const{active:e,creating:t,onClickToEdit:i}=this.props;t&&!e&&i&&i()};getMarkdown(){let e;return e=this.textEditor?this.textEditor.getMarkdown():this.props.text,e.trim()}getAttachmentCount(){const{attachments:e}=this.props,{pendingAttachments:t,removedAttachments:i,uploads:n}=this.state;return e.length+t.length+n.length-i.length}isAtMaxAttachments(){return this.getAttachmentCount()>=xt.iS}inEmptyState(){const{active:e,text:t}=this.props;return!e&&""===t.trim()&&0===this.getAttachmentCount()}setTextEditorRef=e=>{this.textEditor=e};renderButtonBar(){const{active:e,creating:t,parentId:i,maxLength:n}=this.props;if(!e)return null;const{pendingAttachments:s,removedAttachments:a,textChanged:o,charCount:r,uploads:d,showUploadTooltip:l}=this.state,c=this.isAtMaxAttachments(),h=o||a.length>0||s.length>0,u=d.length>0,m=!c&&!u,p=h&&e&&!u&&!(n&&r>n),g=c?Xt.Df.DIMMED:u?Xt.Df.DISABLED:Xt.Df.ENABLED,v=this.context.locale.t(c?xi.MAX_ATTACHMENTS_TOOLTIP:xi.UPLOAD_TOOLTIP,xt.iS),f=this.context.locale.t(c?xi.MAX_ATTACHMENTS_TOOLTIP:xi.EMBED_TOOLTIP,xt.iS),y=this.context.locale.t(t?xi.ADD_CTA:xi.SAVE_CTA),w=this.context.locale.t(xi.LINK_TOOLTIP),b=this.context.locale.t(xi.CANCEL_CTA);return(0,Ot.jsxs)("div",{className:"annotation-button-bar",children:[(0,Ot.jsxs)("div",{className:"annotation-editors",children:[(0,Ot.jsx)(Vt,{id:`${i}-annotation`,multi:!0,enabled:m,onUpload:this.onFilesChosen,children:(0,Ot.jsx)(Xt.K0,{iconClass:"icon-attach",buttonStyle:Xt.zt.PLAIN,buttonState:g,onClick:this.onClickFileInput,tooltipMsg:v,tooltipPersist:l})}),(0,Ot.jsx)(Xt.K0,{iconClass:"icon-media-mix",buttonStyle:Xt.zt.PLAIN,buttonState:g,tooltipMsg:f,onClick:this.openEmbedEditor}),(0,Ot.jsx)(Xt.K0,{iconClass:"icon-add-link",buttonStyle:Xt.zt.PLAIN,tooltipMsg:w,onClick:this.openLinkEditor})]}),(0,Ot.jsxs)(jt.e,{className:"annotation-cta-buttons",spacing:"small",children:[(0,Ot.jsx)(Et.$,{variant:Ct.A.TERTIARY,size:"small",onClick:this.cancelEdits,label:b},"cancel"),(0,Ot.jsx)(Et.$,{variant:Ct.A.TERTIARY,size:"small",disabled:!p,onClick:this.saveEdits,label:y},"save")]})]})}renderAttachments(){const{attachments:e,active:t,onViewAttachment:i,annotationType:n,parentId:s}=this.props,{pendingAttachments:a}=this.state,o=this.attachmentsData?e.filter((e=>!this.attachmentsData.removals.get(e.id))):e;if(a.forEach((e=>o.push(e))),t)return(0,Ot.jsx)(Mt.E,{annotationType:n,parentId:s,canDelete:t,inline:t,attachments:o,onViewAttachment:i});const r=(o||[]).reduce(((e,t)=>{const i=(0,W.rV)(t)?"viewable":"nonViewable";return e[i]=[...e[i],t],e}),{viewable:[],nonViewable:[]});return(0,Ot.jsxs)(Ot.Fragment,{children:[(0,Ot.jsx)(Mt.E,{annotationType:n,parentId:s,canDelete:t,inline:t,attachments:r.viewable,onViewAttachment:i}),(0,Ot.jsx)(Mt.E,{annotationType:n,parentId:s,canDelete:t,inline:t,attachments:r.nonViewable,nonViewable:!0,onViewAttachment:i})]})}renderSmartEditor(){const{placeholder:e,hashtags:t,text:i,creating:n,textParser:s,active:a,maxLength:o,tabIndex:r,annotationType:d,onClickToEdit:l}=this.props,c=d===F.U.NOTE,h=this.inEmptyState()&&c&&!n?this.context.locale.t(xi.CONTENT_DELETED):e;return(0,Ot.jsx)(Kt,{ref:this.setTextEditorRef,textParser:s,text:i,active:!!a,clickToEdit:!!l,placeholder:h,onClickBlock:this.onClickBlock,onStartEditing:a?void 0:l,onDoneEditing:this.onDoneEditing,onCancelEditing:this.cancelEdits,onInput:this.onInput,tabIndex:r,maxLength:o,hashtags:t||[],userMentions:c})}render(){const{className:e,creating:t,active:i,parentId:n,parentType:s,annotationType:a,onClickToEdit:o,edited:r,title:d,maxLength:l}=this.props,{uploads:c,selectedBlock:h,charCount:u}=this.state,m=this.getAttachmentCount()<xt.iS,p=!(c.length>0)&&(i||t)&&m,g=a===F.U.NOTE,v=this.inEmptyState()&&!t&&g,y=!i&&r&&!v,w={annotating:i,"editor-box":i||!!o,"annotation-emptied":v,invalid:i&&!!l&&u>l};let b="",T="";return h&&h.blockType===f.n.LINK&&(b=h.text,T=h.value||""),(0,Ot.jsxs)(Bt,{className:"annotation-box",onDropped:this.onDrop,disabled:!p,onActivate:this.dropActivated,children:[d,(0,Ot.jsxs)("div",{className:dt()("annotation-text-box",w,e),children:[this.renderSmartEditor(),i&&this.renderAttachments(),i&&this.renderButtonBar(),i&&l&&l-u<50&&(0,Ot.jsx)(Pi,{current:u,max:l})]}),y&&(0,Ot.jsx)("div",{className:"annotation-edited",children:"(edited)"}),!i&&!t&&this.renderAttachments(),i&&!!n&&(0,Ot.jsx)(Ai,{parentId:n,parentType:s,onEmbed:this.closeEmbedEditor,onCancel:this.closeEmbedEditor}),i&&!!n&&(0,Ot.jsx)(gi,{linkText:b,linkUrl:T,onCancelLink:this.onCancelLink,onSaveLink:this.onSaveLink,onRemoveLink:this.onRemoveLink})]})}})||Ni)||Ni)||Ni);var Oi,Ri,Li,Vi=i(51005);const{INVITE_USER:ji,INVITE_BUTTON:Bi,INVITE_USERS:Fi,INVITE_VISIBLE_MSG:Hi}=Ve.A.USERS;let Ui=(Oi=Reflect.metadata("design:type",Function),Ri=Reflect.metadata("design:paramtypes",["undefined"==typeof UserInviteCardProps?Object:UserInviteCardProps]),(0,Pt.A)(Li=Oi(Li=Ri(Li=class extends _e.Component{static contextType=(()=>It.B)();constructor(e){super(e)}onInviteUsers=()=>{this.props.onInviteUsers(this.props.invitees)};render(){const{invitees:e}=this.props;if(0===e.length)return null;const{locale:t}=this.context;let i;const n=t.t(Bi,e.length);i=1===e.length?t.t(ji,{email:e[0]}):t.t(Fi,{emails:e.join(", ")});const s=t.t(Hi);return(0,Ot.jsxs)("div",{className:"user-invite-card",children:[(0,Ot.jsxs)("div",{className:"user-invite-info",children:[(0,Ot.jsx)("span",{className:"icon icon-eye-show"}),(0,Ot.jsx)("span",{className:"",children:s})]}),(0,Ot.jsx)("p",{className:"user-invite-msg",children:i}),(0,Ot.jsx)(Et.$,{onClick:this.onInviteUsers,variant:Ct.A.TERTIARY,className:dt()("button-inline","user-invite-button"),label:n})]})}})||Li)||Li)||Li);var _i,Gi,zi;const{INVITE_VISIBLE_MSG:$i,INVITE_USER_FAILED:Wi,INVITE_USERS_FAILED:Yi}=Ve.A.USERS;let Ki=(_i=Reflect.metadata("design:type",Function),Gi=Reflect.metadata("design:paramtypes",["undefined"==typeof UserInviteErrorProps?Object:UserInviteErrorProps]),(0,Pt.A)(zi=_i(zi=Gi(zi=class extends _e.Component{static contextType=(()=>It.B)();constructor(e){super(e)}render(){const{failedEmails:e}=this.props,{locale:t}=this.context;if(0===e.length)return null;let i;i=1===e.length?t.t(Wi,{email:e[0]}):t.t(Yi,{failedEmails:e.join(", ")});const n=t.t($i);return(0,Ot.jsxs)("div",{className:"user-invite-card",children:[(0,Ot.jsxs)("div",{className:"user-invite-info",children:[(0,Ot.jsx)("span",{className:"icon icon-eye-show"}),(0,Ot.jsx)("span",{className:"",children:n})]}),(0,Ot.jsx)("p",{className:"user-invite-msg",children:i})]})}})||zi)||zi)||zi);var Xi;const{UNKNOWN_USER:qi,UNKNOWN_USERS:Qi,INVITE_VISIBLE_MSG:Ji}=Ve.A.USERS;let Zi=(0,Pt.A)(Xi=class extends _e.Component{static contextType=(()=>It.B)();render(){const{locale:e}=this.context,{emails:t}=this.props;if(0===t.length)return null;let i;i=1===t.length?e.t(qi,{email:t[0]}):e.t(Qi,{emails:t.join(", ")});const n=e.t(Ji);return(0,Ot.jsxs)("div",{className:"user-invite-card",children:[(0,Ot.jsxs)("div",{className:"user-invite-info",children:[(0,Ot.jsx)("span",{className:"icon icon-eye-show"}),(0,Ot.jsx)("span",{className:"",children:n})]}),(0,Ot.jsx)("p",{className:"user-invite-msg",children:i})]})}})||Xi;var en,tn,nn;let sn=(en=Reflect.metadata("design:type",Function),tn=Reflect.metadata("design:paramtypes",["undefined"==typeof UnknownUserMentionProps?Object:UnknownUserMentionProps]),(0,Pt.A)(nn=en(nn=tn(nn=class extends _e.Component{static contextType=(()=>It.B)();constructor(e){super(e)}inviteUsers=async e=>{if(0===e.length)return;const{noteId:t,message:i}=this.props;await this.context.commandBinder.issueCommand(new A.jl(e,i,_.NB,t))};getInvitees(){const{userMentions:e}=this.props,t=[];return e.forEach((e=>{(e.userStatus===E._.MENTIONED||e.userStatus===E._.KNOWN&&e.modelAccess===h.OQ.PUBLIC)&&t.push(e.email)})),t}getFailedEmails(){const{userMentions:e}=this.props,t=[];return e.forEach((e=>{e.userStatus===E._.FAILED&&t.push(e.email)})),t}render(){const{expires:e,noteId:t}=this.props;if((new Date).getTime()>e)return null;const{userData:i}=this.context,n=i.isInviter(),s=this.getInvitees(),a=this.getFailedEmails();return(0,Ot.jsxs)("div",{className:"user-mentions-unknown",children:[n&&s.length>0&&(0,Ot.jsx)(Ui,{invitees:s,modelAccess:_.NB,noteId:t,onInviteUsers:this.inviteUsers}),!n&&s.length>0&&(0,Ot.jsx)(Zi,{emails:s}),a.length>0&&(0,Ot.jsx)(Ki,{failedEmails:a})]})}})||nn)||nn)||nn);const{NOTES:an}=Ve.A.SHOWCASE;function on(e){const{comment:t,noteId:i,onCancel:n,onViewAttachment:s}=e,{user:a,created:o,edited:r,id:d,text:l}=t,c=(0,ct.s)(),u=at(),m=(0,it.P)(),p=(0,pt.M)(),g=(0,ft.Y)(),v=(0,Ke.t)(),f=(0,Xe.O)(),y=(0,_e.useRef)(null),w=(0,wt.V)(),b=(0,bt.b)(),T=(0,Ge.Y)(),D=ht(),S=Dt(),C=yt();if(!T||!w)return null;function E(e){c.trackToolGuiEvent("notes",e)}const A=D===d,P=t.attachments.values(),I=!!p&&z(m,p,F.U.NOTE,a),k=!!p&&$(m,p,F.U.NOTE,a),N=t.modified.getTime()+60*_._d*1e3,x=m.getUserDisplay(a.email),M=x.color,O=w.getPlainText(l),R=T.getCommentUserMentions(l,C),L=!A&&(I||k)?(0,Ot.jsxs)(St.y,{icon:"more-vert",variant:Ct.A.TERTIARY,ariaLabel:g.t(Ve.A.MORE_OPTIONS),menuArrow:!0,menuClassName:"search-result-menu",menuPlacement:"bottom-end",children:[I&&(0,Ot.jsx)(Et.$,{label:g.t(an.EDIT),size:Ct.M.SMALL,variant:Ct.A.TERTIARY,onClick:()=>{y.current&&u&&(E("notes_click_edit_comment"),u.editComment(t.id),y.current.edit())}}),k&&(0,Ot.jsx)(Et.$,{className:"menu-delete-btn",label:g.t(an.DELETE),size:Ct.M.SMALL,variant:Ct.A.TERTIARY,onClick:()=>{E("notes_click_delete_comment"),u&&u.deleteComment(i,t.id)}})]}):null;return(0,Ot.jsxs)("div",{className:dt()("comment",{active:A}),"data-id":d,children:[(0,Ot.jsxs)("div",{className:"note-header comment-header",children:[(0,Ot.jsx)(At.E,{badgeStyle:{color:M,borderColor:M},label:x.initials}),(0,Ot.jsxs)("div",{className:"note-details",children:[(0,Ot.jsx)("span",{className:"note-user",children:x.name}),(0,Ot.jsx)("div",{className:"note-subheader",children:o.toLocaleString()})]}),L]}),I?(0,Ot.jsx)(Mi,{ref:y,textParser:w,linkHandler:b,annotationId:i,annotationType:F.U.NOTE,parentId:d,parentType:h.pi.COMMENT,attachments:P,active:A,edited:r,creating:!1,text:l,hashtags:S,toolPanelLayout:f,openModal:v,onViewAttachment:s,onDoneEditing:(e,s)=>{s?(E("notes_delete_empty_comment"),u&&u.deleteComment(i,t.id),n()):u&&u.updateComment(i,t.id,e)},onCancelEditing:n,maxLength:_.u4}):(0,Ot.jsx)(Vi.$,{text:l,textParser:w,linkHandler:b,annotationType:F.U.NOTE,annotationId:i,attachments:P,edited:r,onViewAttachment:s}),I&&R.length>0&&(0,Ot.jsx)(sn,{noteId:i,message:O,userMentions:R,expires:N})]})}const{NOTES:rn}=Ve.A.SHOWCASE;function dn(e){let{noteId:t,replyId:i,active:n,onCancel:s,onReply:a}=e;const o=(0,ft.Y)(),r=(0,ct.s)(),d=(0,Ke.t)(),l=(0,Xe.O)(),c=(0,wt.V)(),u=(0,bt.b)(),m=Dt(),p=at();if(!c||!p)return null;return(0,Ot.jsx)(Mi,{className:"reply-box",textParser:c,linkHandler:u,annotationType:F.U.NOTE,annotationId:t,parentType:h.pi.COMMENT,parentId:i,attachments:[],active:n,edited:!1,creating:!0,text:"",hashtags:m,toolPanelLayout:l,openModal:d,placeholder:o.t(rn.REPLY_PLACEHOLDER),onClickToEdit:()=>{r.trackToolGuiEvent("notes","notes_click_new_comment"),p.editComment(i)},onDoneEditing:(e,t)=>{t?s():a(i,e)},onCancelEditing:s,maxLength:_.u4})}var ln=i(89459);const{NOTES:cn}=Ve.A.SHOWCASE;function hn(e){let{note:t,active:i,onCancelNote:n}=e;const s=(0,ct.s)(),a=(0,it.P)(),o=et(),r=(0,ft.Y)(),d=at(),l=t.comments.get(0);function c(e){s.trackToolGuiEvent("notes",e)}const h=gt(t),u=vt(t),m=a.getUserDisplay(t.user.email),p=m.color,g=!o&&!i,v=g&&u,f=g&&!t.resolved,y=g&&t.resolved,w=!o&&(h||y||v)?(0,Ot.jsxs)(St.y,{icon:"more-vert",ariaLabel:r.t(Ve.A.MORE_OPTIONS),variant:Ct.A.TERTIARY,menuArrow:!0,menuClassName:"search-result-menu",menuPlacement:"bottom-end",children:[h&&(0,Ot.jsx)(Et.$,{label:r.t(cn.EDIT),size:Ct.M.SMALL,variant:Ct.A.TERTIARY,onClick:()=>{c("notes_click_edit_note"),l&&d&&d.editComment(l.id)}}),y&&(0,Ot.jsx)(Et.$,{label:r.t(cn.UNRESOLVE),size:Ct.M.SMALL,variant:Ct.A.TERTIARY,onClick:()=>{c("notes_click_unresolve_note"),d&&d.resolveNote(t.id,!1)}}),v&&(0,Ot.jsx)(Et.$,{className:"menu-delete-btn",label:r.t(cn.DELETE),size:Ct.M.SMALL,variant:Ct.A.TERTIARY,onClick:()=>{c("notes_click_delete_note"),d&&d.deleteNote(t.id)}})]}):null,b=r.t(cn.MARK_AS_RESOLVED);return(0,Ot.jsxs)("header",{className:"note-header",children:[(0,Ot.jsx)(At.E,{badgeStyle:{color:p,borderColor:p},label:m.initials}),(0,Ot.jsxs)("div",{className:"note-details",children:[(0,Ot.jsx)("span",{className:"note-user",children:m.name}),(0,Ot.jsx)("div",{className:"note-subheader",children:t.created.toLocaleString()})]}),(0,Ot.jsxs)(jt.e,{spacing:"small",children:[o&&(0,Ot.jsx)(Et.$,{icon:"close",tooltip:r.t(cn.CANCEL),onClick:n,tooltipOptions:{placement:"bottom-end"}}),f&&(0,Ot.jsx)(Et.$,{icon:"checkmark",size:Ct.M.SMALL,variant:Ct.A.FAB,theme:"dark",tooltip:b,onClick:()=>{c("notes_click_resolve_note"),d&&d.resolveNote(t.id,!0)}}),g&&(0,Ot.jsx)(ln.k,{prefix:"note",pin:t,id:t.id,darkTheme:!0,analyticAction:"copy_note_share_link",includeCameraView:!0}),w]})]})}const{NOTES:un}=Ve.A.SHOWCASE;function mn(e){let{note:t,onViewAttachment:i,onCancel:n}=e;const s=(0,ft.Y)(),a=(0,Ke.t)(),o=(0,Xe.O)(),r=(0,it.P)(),d=yt(),l=(0,_e.useRef)(null),c=at(),u=(0,Ge.Y)(),m=ht(),p=et(),g=Dt(),v=(0,wt.V)(),f=(0,bt.b)(),y=gt(t),w=t.comments.get(0),b=w?.id,T=!!m&&(m===b||p),D=t.id,S=(0,_e.useCallback)((()=>{l.current&&m===D&&l.current.edit()}),[m,D]);if((0,tt.J)(B.wk,(()=>{p&&S()})),(0,_e.useEffect)((()=>{T&&S()}),[T,S]),!u||!v)return null;const C=w?.attachments?.values()||[],E=w?.text||"",A=w?.edited||!1,P=w?.modified.getTime()+60*_._d*1e3,I=t.user.id===r.getCurrentUserId(),k=v.getPlainText(E),N=u.getCommentUserMentions(E,d),x=T?s.t(un.ADD_NOTE_MESSAGE):void 0;return(0,Ot.jsxs)("div",{className:"note-post",children:[(0,Ot.jsx)(hn,{note:t,active:T,onCancelNote:n}),y?(0,Ot.jsx)(Mi,{ref:l,textParser:v,linkHandler:f,annotationId:D,annotationType:F.U.NOTE,parentId:b||D,parentType:h.pi.COMMENT,attachments:C,active:T,edited:A,creating:p,text:E,hashtags:g,placeholder:x,toolPanelLayout:o,openModal:a,onViewAttachment:i,onDoneEditing:async(e,t)=>{t?n():p?c&&await c.saveNewNote(e):c&&await c.saveNoteChanges(D,e)},onCancelEditing:n,maxLength:_.KZ}):(0,Ot.jsx)(Vi.$,{text:E,textParser:v,linkHandler:f,annotationType:F.U.NOTE,annotationId:D,attachments:C,edited:A,onViewAttachment:i}),!p&&w&&I&&N.length>0&&(0,Ot.jsx)(sn,{message:k,noteId:D,expires:P,userMentions:N})]})}function pn(e){let{note:t}=e;const i=(0,ct.s)(),n=(0,lt.j)(st.qy),s=at(),a=ht(),o=et(),r=function(e){const t=(0,ut.Z)(e),[i,n]=(0,_e.useState)(mt(t));return(0,_e.useEffect)((()=>{if(!t)return()=>{};function e(){n(mt(t))}const i=t.comments.onChanged(e);return e(),()=>{i.cancel()}}),[t]),i}(t.id),[d,l]=(0,_e.useState)((0,p.D)(11)),c=()=>{s&&s.cancelCommentChanges()},h=e=>{if(r.length){i.trackToolGuiEvent("notes","notes_click_view_attachment");const t=r.filter((e=>(0,W.rV)(e)));t.length>0&&n.toggleAttachmentViewer(!0,t,e)}},u={annotating:!!a,creating:o},m=a===d,g=function(){const e=(0,pt.M)();return!!e&&e.hasPolicy(_.O7)}(),v=!o&&g&&(m||!a);return(0,Ot.jsxs)("div",{className:dt()("note-widget",u),children:[t&&(0,Ot.jsx)(mn,{note:t,onViewAttachment:h,onCancel:()=>{o?s&&s.cancelNewNote():a&&c()}}),!o&&(0,Ot.jsx)("div",{className:"note-comments",children:t.comments.map(((e,i)=>0===i?null:(0,Ot.jsx)(on,{noteId:t.id,comment:e,onCancel:c,onViewAttachment:h},e.id)))}),v&&(0,Ot.jsx)(dn,{replyId:d,noteId:t.id,active:m,onCancel:()=>{c(),l((0,p.D)(11))},onReply:(e,i)=>{s&&s.addComment(t.id,i,e),l((0,p.D)(11))}})]})}var gn=i(62727);const vn=e=>{let{colors:t,defaultColor:i,onColorPicked:n}=e;const[s,a]=(0,_e.useState)((()=>i||""));(0,_e.useEffect)((()=>{i&&!s&&a(i)}),[i,s]);const o=e=>{const t=e.currentTarget;if(t&&t.dataset){const i=t.dataset.value;i&&(e.stopPropagation(),n(i),a(i))}};return(0,Ot.jsx)("div",{className:"color-picker",children:t.map((e=>(e=>{const t={backgroundColor:e},i=dt()({"color-swatch":!0,"icon-checkmark":!0,active:e===s});return(0,Ot.jsx)("div",{className:i,style:t,"data-value":e,onClick:o},e)})(e)))})};var fn=i(23339),yn=i(87635),wn=i(26348);var bn=i(7579);i(44704);const Tn=bn.A;let Dn=0;class Sn extends _e.Component{id;mdcRef=(()=>(0,_e.createRef)())();setActiveSlider;setInactiveSlider;hasChangedTimeout;layoutRecalculated;constructor(e){super(e),this.id=Dn++,this.state={value:void 0!==e.initialValue?e.initialValue:(e.max+e.min)/2,active:!1,hasChanged:!1},this.setActiveSlider=this.setActive(!0),this.setInactiveSlider=this.setActive(!1)}componentDidMount(){document.addEventListener("mouseup",this.onEventMouseUp),document.addEventListener("mouseleave",this.onEventMouseUp)}componentWillUnmount(){document.removeEventListener("mouseup",this.onEventMouseUp),document.removeEventListener("mouseleave",this.onEventMouseUp)}setValue=e=>{this.setState({value:e})};onSliderInput=e=>{const t=e.detail.value;this.layoutRecalculated||(this.mdcRef.current?.layout(),this.layoutRecalculated=!0),this.setState({value:t}),this.props.onInput&&this.props.onInput(t)};onSliderChange=e=>{const t=e.detail.value;this.setState({value:t}),this.props.onChange&&this.props.onChange(t)};getLeftOffset=()=>100*(this.state.value-this.props.min)/(this.props.max-this.props.min)+"%";getSliderId=()=>`slider-with-tooltip-${this.id}`;getStyleElement=()=>`#${this.getSliderId()} .mdc-slider__thumb-container {\n        left: ${this.getLeftOffset()}\n    }`;getDisplayValue=e=>{const{formatNumbers:t,units:i}=this.props;return(t?t(e):e)+(i||"")};setActive=e=>()=>this.setState({active:e});hasChanged=()=>{this.setState({hasChanged:!1})};componentDidUpdate(e,t){t.value!==this.state.value&&(clearTimeout(this.hasChangedTimeout),this.setState({hasChanged:!0}),this.hasChangedTimeout=window.setTimeout(this.hasChanged,450))}onMouseDown=e=>{this.props.onInputStart&&this.props.onInputStart()};onEventMouseUp=e=>{this.props.onInputEnd&&this.props.onInputEnd()};onMouseUp=e=>{this.props.onInputEnd&&this.props.onInputEnd()};render(){const{width:e,displayBounds:t,min:i,max:n,step:s,discrete:a,tooltipPosition:o=Cn.DOWN,variant:r="default",disabled:d,tabIndex:l}=this.props,{active:c,hasChanged:h,value:u}=this.state,m={left:this.getLeftOffset()},p="inline-value"===r,g=!p&&t,v=!p,f=void 0!==l?l:0;return(0,Ot.jsxs)("div",{id:this.getSliderId(),className:dt()("slider-with-tooltip",{displayBounds:t,disabled:d}),style:{width:e},onMouseEnter:this.setActiveSlider,onMouseLeave:this.setInactiveSlider,children:[v&&o===Cn.UP&&(0,Ot.jsx)("div",{className:dt()("slider-tooltip",{active:c||h}),"data-balloon":this.getDisplayValue(u),"data-balloon-pos":Cn.UP,style:m}),g&&(0,Ot.jsx)("div",{className:"min-amount",children:this.getDisplayValue(i)}),p&&(0,Ot.jsx)("div",{className:"min-amount",children:this.getDisplayValue(u)}),(0,Ot.jsx)(Tn,{discrete:a,min:i,max:n,step:s,value:u,onInput:this.onSliderInput,onChange:this.onSliderChange,onMouseDown:this.onMouseDown,onMouseUp:this.onMouseUp,foundationRef:this.mdcRef,disabled:d,tabIndex:f}),g&&(0,Ot.jsx)("div",{className:"max-amount",children:this.getDisplayValue(n)}),(0,Ot.jsx)("style",{dangerouslySetInnerHTML:{__html:this.getStyleElement()}}),v&&o===Cn.DOWN&&(0,Ot.jsx)("div",{className:dt()("slider-tooltip",{active:c||h}),"data-balloon":this.getDisplayValue(u),"data-balloon-pos":Cn.DOWN,style:m})]})}}let Cn=function(e){return e.UP="up",e.DOWN="down",e}({});var En,An,Pn,In=i(94380),kn=Ve.A.WORKSHOP.MATTERTAGS;function Nn(e){const{stemEnabled:t,stemLength:i,onLengthUpdate:n,onLengthChanged:s,onStemEnabledChanged:a,variant:o,disabled:r,tabIndex:d}=e,l=(0,_e.useRef)(null),c=(0,yn.J)(),h=(0,ft.Y)();(0,_e.useEffect)((()=>{l.current&&l.current.setValue((0,wn.ld)(i))}),[i]);const u=h.t(kn.SHOW_STEM_LABEL);return(0,Ot.jsxs)("div",{className:"stem-editor",onClick:e=>e.stopPropagation(),children:[(0,Ot.jsx)("div",{className:"stem-slider",children:(0,Ot.jsx)(Sn,{ref:l,discrete:!1,min:.1,max:9,initialValue:(0,wn.ld)(i),onChange:function(e){const t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?(0,wn.hV)(e):e;s(t)},onInput:function(e){const t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?(0,wn.hV)(e):e;t!==i&&n(t)},displayBounds:!0,width:150,formatNumbers:e=>{if(c===fn.t.IMPERIAL)return(e=>{let t="";t+=Math.floor(e)+"'";const i=Math.floor(e%1*12);return i<10&&(t+="0"),t+=i+"''",t})(e);return`${Math.round(100*(0,wn.hV)(e))/100}m`},tooltipPosition:Cn.DOWN,variant:o,disabled:r,tabIndex:d})}),(0,Ot.jsx)(In.S,{enabled:!0,checked:t,label:u,onChange:e=>{const t=e.classList.contains("checked");a(t)}})]})}const{PINS:xn}=Ve.A.WORKSHOP;let Mn=(En=Reflect.metadata("design:type",Function),An=Reflect.metadata("design:paramtypes",["undefined"==typeof PinAssetEditorProps?Object:PinAssetEditorProps]),(0,Pt.A)(Pn=En(Pn=An(Pn=class extends _e.Component{static contextType=(()=>It.B)();pinsModule=null;constructor(e){super(e)}async componentDidMount(){this.pinsModule||(this.pinsModule=await this.context.engine.getModuleBySymbol(st.kd))}closePinAssetEditor=()=>{this.props.onClose()};handleColorPicked=e=>{this.context.analytics.trackGuiEvent("pin_change_color"),this.props.onSave({color:e})};saveStemEnabled=e=>{this.context.analytics.trackGuiEvent(e?"pin_show_stem":"pin_hide_stem"),this.props.onSave({stemEnabled:e})};saveStemLength=e=>{this.context.analytics.trackGuiEvent("pin_change_stem_height"),this.props.onSave({stemLength:e})};previewStemLength=e=>{const{id:t,pinType:i}=this.props;this.pinsModule&&this.pinsModule.updatePin(t,i,{stemLength:e})};stopPropagation=e=>{e.stopPropagation()};renderStemEditor(){const{pin:e}=this.props;return(0,Ot.jsx)(Nn,{stemLength:e.stemLength,stemEnabled:e.stemEnabled,onLengthUpdate:this.previewStemLength,onLengthChanged:this.saveStemLength,onStemEnabledChanged:this.saveStemEnabled})}render(){const{toolPanelLayout:e,open:t,pin:i,colors:n}=this.props,s=e===y.L$.BOTTOM_PANEL;if(!t&&!s)return null;const a=this.context.locale.t(xn.COLOR_STEM_EDITOR_TITLE);return(0,Ot.jsxs)("div",{className:dt()("pin-tool-editor",{"tool-popup":!s,open:s&&t}),onClick:this.stopPropagation,children:[(0,Ot.jsxs)("div",{className:"tool-editor-title",children:[(0,Ot.jsx)("span",{children:a}),(0,Ot.jsx)(ci.J,{theme:"dark",tooltip:"",onClose:this.closePinAssetEditor})]}),(0,Ot.jsx)(vn,{colors:n,defaultColor:i.color,onColorPicked:this.handleColorPicked}),this.renderStemEditor()]})}})||Pn)||Pn)||Pn);var On=i(75200),Rn=i(97994),Ln=i(22044);const Vn=(0,Rn.p)(!1);function jn(e){Vn.value=e}function Bn(){return[(0,Ln.A)(Vn),jn]}var Fn=i(80700),Hn=i(66493);function Un(e){const{analyticAction:t}=e,i=(0,ct.s)(),n=at(),s=(0,$e.W)(),a=ze(),o=(0,Fn.e)(a?.id),[r,d]=Bn();if(!(a&&s.length>1))return null;const l=s.findIndex((e=>{const t=e.id,i=e.parentId;return i&&i===a?.id&&(!o||t===o?.id)}));return(0,Ot.jsx)(Hn.r,{index:l,total:s.length,disabled:r,wrapAround:!0,onNavigate:e=>{const o=s[e];if(!o)return;const r=o.id,l=o.parentId;if(!r||!l)return;d(!0);const c=a?null:g.fl.Interpolate;i.trackToolGuiEvent("notes",t),n&&n.openNoteToComment(l,!0,!1,r,c).then((()=>{d(!1)}))}})}const{NOTES:_n}=Ve.A.SHOWCASE;function Gn(){const e=ht(),t=(0,hi.L)(),i=at(),n=(0,ft.Y)(),s=Qe(),a=(0,On.c)(),[o]=Bn(),r=s&&a&&(a===y.S0.SEARCH||a===y.S0.LAYERS),d=r||!s,l=!e&&!r,c=d?n.t(_n.NAV_BACK):n.t(_n.NAV_CLOSE),h=d?"back":"close";return(0,Ot.jsxs)("div",{className:"detail-panel-header",children:[(0,Ot.jsx)(ci.J,{icon:h,label:c,onClose:()=>{o||(r?t.issueCommand(new b.kC).then((()=>{t.issueCommand(new b.oe(!1))})):s?t.issueCommand(new b.u3(y.S0.NOTES)):i&&i.closeNote())}}),l&&(0,Ot.jsx)(Un,{analyticAction:"notes_navigate_in_panel"})]})}function zn(e){let{panelOpen:t,note:i}=e;const n=at(),s=(0,it.P)(),a=(0,pt.M)(),o=(0,Xe.O)(),r=(0,_e.useRef)(null),d=ot(),l=et(),c=i?.id;(0,tt.J)(re,(e=>{r.current&&r.current.scrollToSelector(`[data-id='${e.commentId}']`)})),(0,_e.useEffect)((()=>{r.current&&c&&r.current.resetScrollTop()}),[c]);const h=!!(i&&s&&a)&&z(s,a,F.U.NOTE,i.user),u=d===Y.f.EDITING,m=o===y.L$.BOTTOM_PANEL,p=u&&m;return(0,Ot.jsxs)(gn.q,{ref:r,open:t,className:"note-panel",scrollingDisabled:p,onClose:()=>{n&&n.closeNote()},children:[i&&!l&&(0,Ot.jsx)(Gn,{}),i&&(0,Ot.jsx)(pn,{note:i}),i&&c&&m&&h&&(0,Ot.jsx)(Mn,{id:c,pin:i,pinType:V.yY.NOTE,onSave:e=>{c&&n&&n.saveNoteAppearance(c,e)},onClose:()=>{n&&n.toggleNoteToolEditor(!1)},colors:_.Ay.colors,open:u,toolPanelLayout:o},c)]})}var $n=i(13397),Wn=i(39949),Yn=i(91048);i(80164);const{NOTES:Kn}=Ve.A.SHOWCASE;function Xn(){const e=(0,ft.Y)(),t=Ye(),i=(0,_e.useRef)(null);return(0,Ot.jsx)("div",{className:"search-filter",children:(0,Ot.jsxs)(St.y,{ref:i,icon:"filter",ariaLabel:e.t(Kn.FILTER),variant:Ct.A.TERTIARY,size:Ct.M.SMALL,menuClassName:"search-filter-menu",children:[(0,Ot.jsxs)("div",{className:"search-filter-menu-header",children:[(0,Ot.jsx)("div",{children:e.t(Kn.FILTER_BY)}),(0,Ot.jsx)(ci.J,{onClose:()=>{i.current&&i.current.closeMenu()}})]}),(0,Ot.jsx)(qn,{id:ee.S.ALL,label:e.t(Kn.FILTER_ALL),selected:t===ee.S.ALL},ee.S.ALL),(0,Ot.jsx)(qn,{id:ee.S.OPEN,label:e.t(Kn.FILTER_UNRESOLVED),selected:t===ee.S.OPEN},ee.S.OPEN),(0,Ot.jsx)(qn,{id:ee.S.RESOLVED,label:e.t(Kn.FILTER_RESOLVED),selected:t===ee.S.RESOLVED},ee.S.RESOLVED)]})})}function qn(e){let{id:t,label:i,selected:n}=e;const s=(0,ct.s)(),a=at();return(0,Ot.jsx)(Yn.M,{id:t,label:i,selected:n,onToggled:()=>{!n&&a&&(s.trackToolGuiEvent("notes","notes_list_change_filter"),a.toggleNotesFilter(t,!0))}})}var Qn=i(17651);const{NOTES:Jn}=Ve.A.SHOWCASE;function Zn(e){let{children:t,title:i,hideBadge:n}=e;const s=(0,ft.Y)(),a=(0,$n.e)(),o=(0,$e.W)().length,r=(0,Ot.jsx)(Qn.M,{filter:(0,Ot.jsx)(Xn,{})}),d=i||s.t(a?Jn.COMMENTS:Jn.NOTES,o);return(0,Ot.jsx)(Wn.h,{toolId:y.S0.NOTES,className:"notes-list-panel",title:d,subheader:r,hideBadge:n,children:t})}function es(e){let{children:t,title:i,hideBadge:n}=e;const s=(0,Ke.t)(),a=(0,Xe.O)(),o=Qe(),r=ze(),d=function(){const e=ze(),t=(0,Ze.X)();return(null==e?void 0:e.id)===(null==t?void 0:t.id)?e:null}(),l=et(),[c,h]=(0,_e.useState)(d),u=o;(0,_e.useEffect)((()=>{r&&r?.id!==c?.id&&h(r)}),[c?.id,r,r?.id]);const m=l?d:r,p=a===y.L$.BOTTOM_PANEL,g=s&&s!==Je.a.CONFIRM,v=!(!m||p&&g);return(0,Ot.jsxs)(Ot.Fragment,{children:[(0,Ot.jsx)(zn,{panelOpen:v,note:m||c}),!u&&(0,Ot.jsx)(Zn,{title:i,hideBadge:n,children:t})]})}var ts=i(95541),is=i(48411),ns=i(28479),ss=i(34674),as=i(95143),os=i(87399);const{NOTES:rs}=Ve.A.SHOWCASE;function ds(e){let{userName:t,description:i,numAttachments:n,numComments:s,searchText:a}=e;const o=(0,wt.V)(),r=(0,ft.Y)(),d=s-1,l=(a?(0,as.x8)(t,a):t).trim(),c=r.t(rs.REPLIES,d);let h="";return""===i?n>0?h=r.t(rs.NUM_ATTACHMENTS,n):0===d&&(h=r.t(rs.CONTENT_DELETED)):h=(a?(0,as.x8)(i,a):i).trim(),(0,Ot.jsxs)("div",{className:"item-details",children:[(0,Ot.jsxs)("div",{className:"item-header",children:[o&&(0,Ot.jsx)(os.L,{text:l.trim(),textParser:o,markers:as.S8}),d>0&&!a&&(0,Ot.jsx)("span",{className:"note-summary-info note-replies",children:c})]}),o&&(0,Ot.jsx)("div",{className:"item-description",children:(0,Ot.jsx)(os.L,{text:h,textParser:o,markers:as.S8,linksActive:!1})})]})}var ls=i(38731);const{NOTES:cs}=Ve.A.SHOWCASE,hs=e=>{let{item:t}=e;return t?(0,Ot.jsx)(us,{item:t},t.id):null},us=e=>{let{item:t}=e;const i=(0,_e.useRef)(null),n=(0,ls.B)(),s=(0,ct.s)(),a=(0,ft.Y)(),o=(0,ts.H)(),r=(0,is.T)(),d=ze(),l=(0,$n.e)(),c=(0,ns.L)(),h=gt(d),u=vt(d),m=(0,qt.XW)(),p=at(),{id:g,title:v,description:f,color:y,resolved:w,numAttachments:b,numComments:T}=t,D=g,S=t.parentId;if(!S||!D)return null;const C=S===d?.id,E=w||!t.isLayerVisible(),A=a.t(cs.EDIT_LIST_ITEM_OPTION_CTA),P=a.t(cs.DELETE_LIST_ITEM_OPTION_CTA),I=h||u?(0,Ot.jsx)(jt.e,{children:(0,Ot.jsxs)(St.y,{ref:i,icon:"more-vert",ariaLabel:a.t(Ve.A.MORE_OPTIONS),variant:Ct.A.TERTIARY,menuArrow:!0,menuClassName:"search-result-menu",children:[(0,Ot.jsx)(Et.$,{label:A,size:Ct.M.SMALL,disabled:!h,variant:Ct.A.TERTIARY,onClick:()=>{s.trackGuiEvent("notes_list_edit_note",{tool:c}),p&&p.openNoteToComment(S,!0,!0,D)}}),(0,Ot.jsx)(Et.$,{className:"menu-delete-btn",label:P,size:Ct.M.SMALL,disabled:!u,variant:Ct.A.TERTIARY,onClick:()=>{s.trackGuiEvent("notes_list_delete_note",{tool:c}),p&&p.deleteNote(S)}})]})}):void 0,k=(0,Ot.jsx)(ds,{description:f,userName:v,numAttachments:b,numComments:T,searchText:l}),N=m===qt.cD.AURA?{"--badge-color":y}:y?{backgroundColor:y,borderColor:y}:void 0,x=m===qt.cD.AURA?"icon-comment-outline":"icon-comment",M=(0,Ot.jsx)(At.E,{badgeStyle:N,iconClass:x});return(0,Ot.jsx)(ss.c,{id:D,className:"search-result-item notes-list-item",title:k,badge:M,active:C,disabled:E,onClick:async()=>{s.trackGuiEvent("search_item_note_click",{tool:c}),t.onSelect(n,r,o)},actions:I},D)};var ms=i(41176),ps=i(55384);const{NOTES:gs}=Ve.A.SHOWCASE;function vs(){const e=ze(),t=Ue.Hj.DATE,i=!!(0===(0,$e.W)().length)||void 0;let n;const s=Ye();if(!(0,We.M)())switch(s){case ee.S.OPEN:n=gs.HAVE_NONE_OPEN;break;case ee.S.RESOLVED:n=gs.HAVE_NONE_RESOLVED;break;default:n=gs.HAVE_NONE}return(0,Ot.jsx)(es,{children:(0,Ot.jsx)("div",{className:"panel-list",children:(0,Ot.jsx)(ms.x,{renderItem:hs,renderGroup:ps.m,activeItemId:e?.id,grouping:t,excludeEmptyGroups:i,emptyPhrase:n})})})}var fs=i(50098),ys=i(93216);function ws(){const e=(0,ys.d)(),[t,i]=(0,_e.useState)(e?e.pinEditorState:V.ce.IDLE);return(0,_e.useEffect)((()=>{if(!e)return()=>{};const t=e.onPinEditorStateChanged(i);return()=>t.cancel()}),[e]),t}var bs=i(74453),Ts=i(31201),Ds=i(27200);function Ss(e){let{children:t}=e;return(0,Ot.jsx)("div",{className:"overlay-message",children:t})}const{NOTES:Cs}=Ve.A.SHOWCASE;function Es(){const e=(0,_e.useMemo)((()=>(0,Ds.C8)()),[]),t=ws(),i=function(){const e=(0,ys.d)(),[t,i]=(0,_e.useState)(!!e&&e.canPlace);return(0,_e.useEffect)((()=>{if(!e)return()=>{};const t=e.onCanPlaceChanged(i);return i(e.canPlace),()=>t.cancel()}),[e]),t}(),n=(0,ft.Y)(),s=t===V.ce.CREATING,a=t===V.ce.PLACING;let o=null;if(s||!i||!e&&a){const t=n.t(e?Cs.OVERLAY_ADD_TOUCH:Cs.OVERLAY_ADD_CLICK),s=n.t(e?Cs.OVERLAY_PLACE_TOUCH:Cs.OVERLAY_PLACE_CLICK);o=i?t:s}return o?(0,Ot.jsxs)(Ss,{children:[(0,Ot.jsx)("div",{className:"icon icon-notes"}),(0,Ot.jsx)("span",{className:"message",children:o})]}):null}var As=i(24478),Ps=i(82208),Is=i(23863);const{NOTES:ks}=Ve.A.SHOWCASE;function Ns(e){let{canEdit:t,canDelete:i}=e;const n=(0,_e.useRef)(null),s=(0,ct.s)(),a=ot(),o=ze(),r=et(),d=(0,Xe.O)(),l=ws(),c=function(){const e=(0,ys.d)(),[t,i]=(0,_e.useState)(!!e&&e.canAdd);return(0,_e.useEffect)((()=>{if(!e)return()=>{};const t=e.onCanAddChanged(i);return i(e.canAdd),()=>t.cancel()}),[e]),t}(),h=(0,ft.Y)(),u=at(),m=l!==V.ce.IDLE,p=a===Y.f.EDITING,g=h.t(ks.COLOR_STEM_TOOLTIP),v=h.t(ks.DELETE_TOOLTIP),f=h.t(ks.ADD_TOOLTIP),w=h.t(ks.CANCEL_TOOLTIP),b=m?w:f,T=d===y.L$.SIDE_PANEL,D=m?As.R.CANCEL:As.R.ADD,S=m,C=T&&t&&!m?(0,Ot.jsx)(Et.$,{className:"action-button-outer",icon:"stem-height",variant:Ct.A.FAB,theme:"overlay",active:p,tooltip:g,onClick:()=>{u&&u.toggleNoteToolEditor(!p)}}):void 0,E=T&&i&&!m?(0,Ot.jsx)(Et.$,{className:"action-button-outer",variant:Ct.A.FAB,theme:"overlay",icon:"delete",tooltip:v,onClick:()=>{o&&u&&(s.trackToolGuiEvent("notes","notes_overlay_click_delete"),u.deleteNote(o.id))}}):void 0;return(0,Ot.jsx)(Is.E,{outerLeft:C,outerRight:E,children:(0,Ot.jsx)(Ps.A,{ref:n,addIcon:D,allowLayerChange:S,disabled:!c,onClick:()=>{m?r&&u&&u.cancelNewNote():(s.trackToolGuiEvent("notes","notes_overlay_click_add"),u&&u.startNewNote())},tooltip:b,nudgeDisabled:!0})})}function xs(){const e=(0,Ke.t)(),t=(0,Xe.O)(),i=ze(),n=ot(),s=ws(),a=function(){const e=(0,ys.d)(),[t,i]=(0,_e.useState)((null==e?void 0:e.progress)||0);return(0,_e.useEffect)((()=>{if(!e)return()=>{};const t=e.onProgressChanged(i);return i(e.progress),()=>t.cancel()}),[e]),t}(),o=(0,bs.S)(),r=ht(),d=et(),l=n===Y.f.CLOSED,c=(0,fs.f)(),h=at(),u=function(){const e=(0,pt.M)();return!!e&&e.hasPolicy(_.tG)}(),m=gt(i),p=vt(i);if(e||l)return null;const g=n===Y.f.OPENING,v=n===Y.f.EDITING,f=u&&!c&&!r,w=t===y.L$.SIDE_PANEL,b=s===V.ce.PRESSING,T=!!i&&!g,D=!w&&!d&&i&&m;return(0,Ot.jsxs)("div",{className:"overlay grid-overlay notes-overlay",children:[D&&(0,Ot.jsx)("div",{className:"overlay-top-right",children:(0,Ot.jsx)(Et.$,{icon:"stem-height",variant:Ct.A.FAB,theme:"overlay",disabled:!T,active:v,onClick:e=>{e.stopPropagation(),h&&h.toggleNoteToolEditor(!v)}})}),(0,Ot.jsx)(Es,{}),f&&(0,Ot.jsx)(Ns,{canEdit:m,canDelete:p}),i&&w&&m&&(0,Ot.jsx)(Mn,{pin:i,id:i.id,pinType:V.yY.NOTE,onSave:e=>{i&&h&&h.saveNoteAppearance(i.id,e)},onClose:()=>{h&&h.toggleNoteToolEditor(!1)},open:v,colors:_.Ay.colors,toolPanelLayout:t}),b&&(0,Ot.jsx)(Ts.z,{progress:a,screenPosition:o})]})}var Ms=i(67280);class Os{renderPersistent=e=>{let{createFullViewOverlay:t}=e;return(0,Ot.jsx)(Ot.Fragment,{children:t((0,Ot.jsx)(Ms.T,{parentTool:y.S0.NOTES},"notes-panel-ui"))})};renderActive=e=>{let{createViewOverlay:t,createRightPanel:i}=e;return(0,Ot.jsxs)(Ot.Fragment,{children:[t((0,Ot.jsx)(xs,{})),i((0,Ot.jsx)(vs,{}))]})}}var Rs=i(82748),Ls=i(78849),Vs=i(81459),js=i(23500),Bs=i(28475),Fs=i(57811),Hs=i(75522),Us=i(32408),_s=i(95439);const{NOTES:Gs}=Ve.A.SHOWCASE;class zs{constructor(e,t){this.engine=e,this.settings=t,this.notesModule=null,this.disabledAssets={[Fs.f]:!1,[Bs.RP]:!1,[js.s]:!1,[Hs.qE]:!1},this.settingsToggler=new Vs.U(this.settings,this.disabledAssets),this.initPromise=this.init()}async init(){const{market:e}=this.engine;[this.notesViewData,this.searchData,this.notesModule]=await Promise.all([e.waitForData(Q.b),e.waitForData(Ls.L),this.engine.getModuleBySymbol(st.TN)]),this.setSearchItemFC(!0)}async activate(){this.settingsToggler.toggle(!0),await this.initPromise,this.notesModule&&this.notesModule.toggleNotesMode(!0)}async deactivate(){this.notesModule&&this.notesModule.toggleNotesMode(!1),this.settingsToggler.toggle(!1)}async dispose(){await this.initPromise,this.setSearchItemFC(!1)}setSearchItemFC(e){const t=this.searchData.getSearchDataTypeGroup(h.jM.NOTE);t&&(t.itemFC=e?us:void 0)}async deepLink(e){const t=(await this.engine.market.waitForData(Q.b)).getNoteView(e);if(t)(0,Us.zX)(this.settings,t,(t=>{this.notesModule&&this.notesModule.openNoteToComment(e,!0,!1,(0,Rs.EN)().comment,t)}));else{const e={messagePhraseKey:Gs.MISSING_MESSAGE,timeout:4e3,dismissesOnAction:!0};this.engine.commandBinder.issueCommand(new _s.Q(e)),this.engine.commandBinder.issueCommandWhenBound(new b.yU(y.S0.NOTES,!0))}}async hasPendingEdits(){const{notesPhase:e,activeNotation:t}=this.notesViewData;switch(e){case Y.f.IDLE:case Y.f.CLOSED:case Y.f.OPENING:return!1;case Y.f.EDITING:case Y.f.CREATING:return!0;default:return!!t}}}var $s=i(49953),Ws=i(12103);class Ys extends n.n{constructor(){super(...arguments),this.name="notes",this.activated=!1,this.registered=!1,this.activeBindings=[],this.refreshPromise=null,this.pollOnNotes=()=>{let e;return(0,s.Sh)((()=>{clearInterval(e),e=window.setInterval((()=>{this.refreshNotes()}),1e3*_.RU)}),(()=>{window.clearInterval(e)}),!0)},this.modelViewChanged=()=>{this.cancelNoteCreation(!0)},this.updatePerSettings=()=>{const e=this.settingsData.tryGetSetting(_.nH,!1),t=this.settingsData.tryGetSetting(Ws.Vg,!1),i=!this.in360View(),n=!this.interactionmodeData.isVR(),s=i&&n&&e&&!t,a=s?this.getFilteredNoteIds(!1):[];this.pinsModule.changePinOpacityByType(V.yY.NOTE,s?1:0,a),s||this.closeNoteBillboard()},this.onAppChange=()=>{this.deactivateTool(),this.updatePerSettings(),this.displayNotes()},this.onNotesPhaseChanged=()=>{let e=!0;const t=this.toolsData.toolPanelLayout===y.L$.BOTTOM_PANEL;switch(this.viewData.notesPhase){case Y.f.EDITING:case Y.f.CREATING:e=!1;break;case Y.f.OPENING:case Y.f.OPEN:e=!t}this.engine.broadcast(new w.Vk(e))},this.changeNotesPhase=e=>{e!==this.viewData.notesPhase&&this.viewData.setNotesPhase(e)},this.pinAddCancelled=e=>{e.pinType===V.yY.NOTE&&this.cancelNoteCreation(!1)},this.cancelNoteCreation=e=>{var t;if(!this.policyData.hasPolicy(_.O7))return;const i=this.viewData,n=null===(t=i.openNoteView)||void 0===t?void 0:t.id;if(n){if(e)try{this.pinsModule.cancelNewPin(n,V.yY.NOTE)}catch(e){d.Vy.for(this).error("Failed to cancel new pin:",e)}this.annotationsModule.closeAnnotation(n,F.U.NOTE)}this.cancelAttachmentChanges(),i.setActiveNotation(null),i.setOpenNoteView(null),i.setFocusedComment(null),i.isNewNote=!1,i.commit(),this.changeNotesPhase(Y.f.IDLE)},this.notesWereChanged=()=>{this.parseNotes(),this.updateNoteViewData(),this.displayNotes()},this.onNoteFilterChanged=()=>{this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),this.updateNoteViewData(),this.displayNotes()},this.onViewModeOrFloorChanged=()=>{this.updatePerSettings()},this.onLayersChanged=()=>{this.closeNoteBillboard(),this.displayNotes()},this.onElementsChanged=({added:e,updated:t,removed:i})=>{if(e&&e.length){const t=e.map((([,e])=>this.getPinUpdate(e)));this.pinsModule.updatePinViews(t)}if(t&&t.length){const e=t.map((([,e])=>this.getPinUpdate(e)));this.pinsModule.updatePinViews(e)}null==i||i.forEach((([,e])=>{this.removeNotePin(e)}))},this.onOpenNoteViewChanged=()=>{const e=this.viewData.openNoteView;e&&this.updateNotePin(e)},this.pinMoved=async e=>{const{id:t,pinType:i,pinPos:n}=e,s=this.viewData.openNoteView;if(s&&i===V.yY.NOTE&&t===s.id){const e=this.notesData.getNote(t);if(e){if(this.layersData.isInMemoryLayer(e.layerId))return;const{anchorPosition:i,stemNormal:s,floorId:a,roomId:o}=n;this.store.update({id:t,anchorPosition:i,stemNormal:s,floorId:a,roomId:o}).then((e=>{e&&this.notesData.updateNote(e)}))}else d.Vy.for(this).debug("Cannot move a non-existent note")}},this.pinPlaced=e=>{const t=this.viewData.openNoteView;t&&e.pinType===V.yY.NOTE&&e.id===t.id&&(this.viewData.updateOpenNoteView(e.pinPos),this.changeNotesPhase(Y.f.OPEN),this.viewData.setActiveNotation(t.id),this.openAnnotation(t.id,t.layerId,!0))},this.handlePinFocusChange=async()=>{const{openNoteView:e,isNewNote:t}=this.viewData;if(t)return;const{focusedPin:i,selectedPinId:n}=this.pinsViewData,{billboardAnnotation:s,billboardSelected:a}=this.annotationsViewData;if(!i)return void(s&&s.annotationType===F.U.NOTE&&s.id!==n&&this.closeNoteBillboard());const o=(null==e?void 0:e.id)===(null==s?void 0:s.id)&&a,r=e&&(null==e?void 0:e.id)===(null==i?void 0:i.id);if(e&&o&&!r&&this.closeNote(),i.pinType===V.yY.NOTE){const t=this.viewData.getNoteView(i.id);if(!t)return void d.Vy.for(this).debug("Focused pin changed, but no note view.");t.id!==(null==e?void 0:e.id)&&this.annotationsModule.previewAnnotation(t.id,t.layerId,F.U.NOTE)}},this.handleAnnotationsChanged=async()=>{const{openNoteView:e,isNewNote:t,focusedComment:i}=this.viewData;if(t)return;const{softOpening:n}=this.toolsData,{dockedAnnotation:s,selectedAnnotation:a}=this.annotationsViewData,o=s||a,r=(null==s?void 0:s.annotationType)===F.U.NOTE&&s,d=(null==a?void 0:a.annotationType)===F.U.NOTE&&a,l=r||d,c=!!r;l&&l.id!==(null==e?void 0:e.id)?await this.openNote(l.id,null,c):e&&e.id!==(null==o?void 0:o.id)&&this.closeNote(),c?(this.activated||await this.engine.commandBinder.issueCommand(new b.Wm(y.S0.NOTES,!0)),i&&this.engine.broadcast(new re(i.id))):this.activated&&n&&await this.engine.commandBinder.issueCommand(new b.u3(y.S0.NOTES))},this.handlePinSelectionChange=async()=>{const{openNoteView:e,activeNotation:t}=this.viewData,{selectedPinId:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===i)return;const n=i?this.pinsViewData.getPin(i):null;if(!e||n&&n.pinType===V.yY.NOTE){if(i&&n&&n.pinType===V.yY.NOTE){const t=z(this.userData,this.policyData,F.U.NOTE,null==e?void 0:e.user);this.pinsModule.togglePinEditing(i,!!t);const s=!0;await this.openNote(i,g.fl.Interpolate,s),this.openAnnotation(i,n.layerId,s)}}else{const e=!this.toolsData.softOpening;this.activated&&!e?await this.engine.commandBinder.issueCommand(new b.u3(y.S0.NOTES)):this.closeNote()}},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==F.U.NOTE)return;const s=this.viewData.getNoteAttachments(i),a=s.find((e=>e.id===n));if(a&&(0,W.rV)(a)){const e=s.filter((e=>(0,W.rV)(e)));this.attachmentsModule.toggleAttachmentViewer(!0,e,n)}},this.notationBlockClicked=async e=>{const{annotationType:t,block:i}=e;t===F.U.NOTE&&(i.blockType!==f.n.USER&&i.blockType!==f.n.HASH||(this.activated&&!this.toolsData.softOpening||await this.engine.commandBinder.issueCommand(new b.Wm(y.S0.NOTES,!1)),this.engine.commandBinder.issueCommand(new Me.tA(i.text||"")),i.text&&this.closeNote()))}}async init(e,t){const[i,n,s,r,d]=await Promise.all([t.market.waitForData(k.o),t.market.waitForData(N.O),t.market.waitForData(C.E),t.market.waitForData($s.L),t.market.waitForData(a.zH)]);if(!s.isLoggedIn()||n.isVR()||!i.tryGetSetting(de.nc,!1))return;this.engine=t,this.config=e,this.interactionmodeData=n,this.userData=s,this.policyData=r,this.settingsData=i,this.appData=d;const[l,p,g,f,y,w,b,D,S,E]=await Promise.all([t.market.waitForData(T.M),t.market.waitForData(P.A),t.market.waitForData(I.X),t.market.waitForData(x.X),t.market.waitForData(H.o),t.getModuleBySymbol(c.r),t.market.waitForData(M.P),t.getModuleBySymbol(st.Et),t.getModuleBySymbol(st.qy),t.getModuleBySymbol(st.kd)]);this.toolsData=l,this.sweepData=p,this.viewmodeData=g,this.floorsViewData=f,this.annotationsViewData=y,this.linkHandler=w,this.layersData=b,this.annotationsModule=D,this.attachmentsModule=S,this.pinsModule=E;const{readonly:A,baseUrl:L}=this.config;this.store=new Ne({context:b.mdsContext,readonly:A,includeDisabled:!0,baseUrl:L},this.userData);const V=()=>{this.store.setStoreViewId(b.getNonworkshopViewId())};V(),this.bindings.push(b.onPropertyChanged("currentViewId",V),b.onPropertyChanged("activeLayerId",(()=>this.updatePendingNote())),this.store.onNewData((async e=>{this.loadNewNotes(e)}))),this.notesData=new q({}),this.textParser=new v.r({links:!0,hashtags:!0,users:this.userData}),this.backgroundTexture=(0,u.y)(m),this.viewData=new Q.b(this.notesData,this.textParser,this.linkHandler,this.backgroundTexture),this.hashtagData=new Z,t.market.register(Z,this.hashtagData),this.pinsViewData=await t.market.waitForData(j.U),this.bindings.push(i.onSettingChanged(_.nH,this.updatePerSettings),i.onSettingChanged(Ws.Vg,this.updatePerSettings),t.subscribe(U.z,this.handleViewingAttachment),t.subscribe(U.v,this.notationBlockClicked),t.subscribe(o.E5,this.onAppChange),t.subscribe(O.A,this.updatePerSettings),t.subscribe(R.b,this.updatePerSettings),t.subscribe(Fe.tj,this.modelViewChanged),g.makeModeChangeSubscription(this.onViewModeOrFloorChanged),f.makeFloorChangeSubscription(this.onViewModeOrFloorChanged),y.onChanged(this.handleAnnotationsChanged),this.layersData.onCurrentLayersChanged(this.onLayersChanged),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),this.pollOnNotes(),this.notesData.onChanged(this.notesWereChanged),this.notesData.collection.onElementsChanged(this.onElementsChanged.bind(this)),this.viewData.onOpenNoteViewChanged(this.onOpenNoteViewChanged)),t.market.register(Q.b,this.viewData),this.updatePerSettings(),this.parseNotes(),this.registerRoomAssociationSource(t),async function(e,t,i,n,s,o,r,d,l){let c=o.application===a.lg.WORKSHOP;const u=(a,o,d,l=[])=>{const h=[],u=n.getFilteredNotesMap().values,m=!d,p=[];return 0===l.length&&u.forEach((n=>{if(!c&&!s.layerToggled(n.layerId))return;let d=0;n.comments.forEach(((l,c)=>{m&&c>0||a(l.user.name,r.getPlainText(l.text))&&(d++,h.push(new Le(e,t,i,s,o,l,n,r,m)))})),d>0&&p.push(n.id)})),i.filterVisibleNotes(p),h},m=e=>{i.setNotesVisibilityFilterEnabled(!!e)},p=e=>new xe.P(n.getFilteredNotesMap().onChanged(e),d.onChanged(e)),g={renew:()=>{t.issueCommandWhenBound(new Me.Oc({id:h.jM.NOTE,groupPhraseKey:je.SEARCH_GROUP_HEADER_NOTES,groupMatchingPhraseKey:je.SEARCH_GROUP_HEADER,getSimpleMatches:u,registerChangeObserver:p,onSearchActivatedChanged:m,groupOrder:50,groupIcon:"comment-outline",batchSupported:!0}))},cancel:()=>{t.issueCommandWhenBound(new Me.tf(h.jM.NOTE))}},v=()=>{c=o.application===a.lg.WORKSHOP,l.tryGetSetting(de.nc,!1)||c?g.renew():g.cancel()},f=o.onPropertyChanged("application",v),y=l.onSettingChanged(de.nc,v);return v(),new xe.P(g,f,y)}(this.annotationsModule,t.commandBinder,this,this.viewData,this.layersData,d,this.textParser,this.userData,this.settingsData).then((e=>this.bindings.push(e))),await this.refreshNotes(),t.market.register(q,this.notesData)}dispose(e){this.deactivateTool(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.pinsModule.removePinsByType(V.yY.NOTE),this.backgroundTexture.dispose(),this.store.dispose(),super.dispose(e)}onUpdate(){}async refreshNotes(){if(this.refreshPromise)return;const e=this.viewData,{isNewNote:t,notesPhase:i}=e;t||i===Y.f.EDITING||(this.refreshPromise=this.store.refresh().finally((()=>{this.refreshPromise=null})))}loadNewNotes(e){var t;const{viewData:i}=this,n=null===(t=i.openNoteView)||void 0===t?void 0:t.id,s=n?{[n]:this.notesData.getNote(n)}:{};this.notesData.atomic((()=>{this.layersData.replaceBackendLayers(this.notesData.collection,s)})),this.notesData.atomic((()=>{this.layersData.replaceBackendLayers(this.notesData.collection,e)})),n&&!e[n]&&(d.Vy.for(this).debug("Open note was deleted"),i.setOpenNoteView(null),i.setFocusedComment(null),i.setActiveNotation(null),i.setNotesPhase(Y.f.IDLE))}async refreshNote(e){if(this.refreshPromise)return;const t=this.notesData.getNote(e);if(this.layersData.isInMemoryLayer(null==t?void 0:t.layerId))this.notesData.updateNote(t);else{const t=await this.store.readNote(e);t&&this.notesData.updateNote(t)}}activateTool(){this.activated||(this.annotationsModule.closeOtherAnnotations(F.U.NOTE),this.policyData.hasPolicy(_.O7)&&this.pinsModule.enablePinCreation(!0),this.changeNotesPhase(Y.f.IDLE),this.updateNoteViewData(),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0)}deactivateTool(e){var t;if(!this.activated)return;this.activated=!1;const{isNewNote:i,openNoteView:n}=this.viewData,s=(null===(t=this.annotationsViewData.dockedAnnotation)||void 0===t?void 0:t.annotationType)===F.U.NOTE;i?this.cancelNoteCreation(!0):n&&(e||s)&&this.closeNote(),this.changeNotesPhase(Y.f.CLOSED),this.pinsModule.clearPinSelection(),this.pinsModule.enablePinCreation(!1),this.activeBindings.forEach((e=>{e.cancel()}))}registerHandlers(){this.activeBindings.push(this.engine.subscribe(B.yi,this.pinPlaced),this.engine.subscribe(B.cC,this.modifyInsideSaveCommand(this.pinMoved)),this.engine.subscribe(B.lY,this.pinAddCancelled),this.viewData.onNotesFilterChanged(this.onNoteFilterChanged),this.viewData.onNotesPhaseChanged(this.onNotesPhaseChanged)),this.registered=!0}async parseNotes(){const e=[],t=[];return this.notesData.iterate((i=>{i.comments.forEach((i=>{const n=this.getUserMentionsAndHashtags(i.text);n.emails.forEach((t=>{e.push({email:t,userStatus:E._.MENTIONED})})),t.push(...n.hashtags)}))})),this.hashtagData.addHashtags(t),this.engine.commandBinder.issueCommand(new A.qO(e))}async parseMarkdown(e){const t=[],i=this.getUserMentionsAndHashtags(e);return i.emails.forEach((e=>{t.push({email:e,userStatus:E._.MENTIONED})})),this.hashtagData.addHashtags(i.hashtags),this.engine.commandBinder.issueCommand(new A.qO(t))}getUserMentionsAndHashtags(e){const t=[],i=[];for(const n of this.textParser.parse(e))n.blockType===f.n.USER&&n.value?t.push(n.value):n.blockType===f.n.HASH&&i.push(n.text);return{emails:t,hashtags:i}}closeNoteBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===F.U.NOTE&&this.annotationsModule.closeAnnotation(e.id,F.U.NOTE)}registerNotesTool(){const e=new D.N({id:y.S0.NOTES,deepLinkParam:"note",searchModeType:h.jM.NOTE,namePhraseKey:Ve.A.TOOLS.NOTES,panel:!0,icon:"icon-comment-outline",analytic:"notes",palette:y.o6.VIEW_BASED,order:80,dimmed:!1,enabled:this.settingsData.tryGetSetting(de.nc,!1),hidesAppBar:!0,ui:new Os,manager:new zs(this.engine,this.settingsData),helpMessagePhraseKey:Ve.A.TOOLS.NOTES_HELP_MESSAGE,helpHref:"https://support.matterport.com/s/article/Matterport-Notes"});this.engine.commandBinder.issueCommand(new b.Kw([e]))}toggleNotesMode(e){e?this.activateTool():this.deactivateTool()}toggleNoteToolEditor(e){this.viewData.setActiveNotation(null),e?this.changeNotesPhase(Y.f.EDITING):this.viewData.notesPhase===Y.f.EDITING&&this.changeNotesPhase(Y.f.OPEN)}toggleNotesFilter(e,t){t?this.viewData.setNotesFilter(e):this.viewData.setNotesFilter(ee.S.ALL)}openAnnotation(e,t,i){i?this.annotationsModule.dockAnnotation(e,t,F.U.NOTE):this.annotationsModule.selectAnnotation(e,t,F.U.NOTE)}async openNoteToComment(e,t,i,n,s){const a=this.viewData,o=a.getNoteView(e);if(!o)return void d.Vy.for(this).error(`Missing note ${e}`);const{notesFilter:r}=a,l=r===ee.S.RESOLVED;r!==ee.S.ALL&&o.resolved!==l&&a.setNotesFilter(ee.S.ALL);const c=t||i,h=this.toolsData.toolPanelLayout===y.L$.SIDE_PANEL?g.fl.FadeToBlack:g.fl.Instant;await this.openNote(e,s||h,c,n,i),this.openAnnotation(e,o.layerId,c)}in360View(){const e=this.sweepData.state.currentSweep?this.sweepData.state.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}closeNote(){this.closeNoteInternal()}closeNoteInternal(){var e;const{commandBinder:t}=this.engine,{openNoteView:i,notesPhase:n}=this.viewData;if(this.viewData.setActiveNotation(null),this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),n!==Y.f.CLOSED&&this.changeNotesPhase(Y.f.IDLE),i){const n=i.id;this.cancelAttachmentChanges(),t.issueCommand(new Me.Xx(null)),this.attachmentsModule.toggleAttachmentViewer(!1);const s=this.notesData.getNote(n);s&&(this.pinsModule.unselectPin(n,V.yY.NOTE),this.pinsModule.changePinVisibility(n,V.yY.NOTE,this.getNoteVisibility(n,s.layerId,i.resolved)));(null===(e=this.annotationsViewData.dockedAnnotation)||void 0===e?void 0:e.annotationType)===F.U.NOTE&&this.annotationsModule.closeDockedAnnotation()}}cancelNewNote(){this.cancelNoteCreation(!0)}updateNoteViewData(){this.viewData.updateNoteViews()}getFilteredNoteIds(e){const t=[];return this.notesData.iterate((i=>{this.getNoteVisibility(i.id,i.layerId,i.resolved)===e&&t.push(i.id)})),t}getNoteVisibility(e,t,i){if(!this.settingsData.tryGetSetting(_.nH,!1))return!1;const{notesFilter:n,openNoteView:s,idVisibilityEnabled:o,idVisibility:r}=this.viewData,d=this.appData.application===a.lg.WORKSHOP||this.layersData.layerToggled(t),l=this.layersData.layerVisible(t),c=(null==s?void 0:s.id)===e,h=!o||r.has(e),u=n===ee.S.ALL||i&&n===ee.S.RESOLVED||!i&&n===ee.S.OPEN;return d&&(c||u&&h&&l)}displayNotes(){const e=[];this.notesData.iterate((t=>{const i=this.getPinUpdate(t);e.push(i)})),e.length&&this.pinsModule.updatePinViews(e)}updateNotePin(e){const t=this.getPinUpdate(e);this.pinsModule.updatePinViews([t])}getPinUpdate(e){const{id:t,layerId:i,resolved:n,anchorPosition:s,color:a,stemEnabled:o,floorId:r,roomId:d,stemNormal:l,stemLength:c}=e;return{id:t,anchorPosition:s,color:a,floorId:r,layerId:i,roomId:d,stemEnabled:o,stemNormal:l,stemLength:c,pinType:V.yY.NOTE,backgroundTexture:this.backgroundTexture,icon:V.tf[V.yY.NOTE],visible:this.getNoteVisibility(t,i,n)}}removeNotePin(e){this.pinsModule.removePin(e.id,V.yY.NOTE)}async startNewNote(){if(!this.policyData.hasPolicy(_.O7))return;this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new b.Wm(y.S0.NOTES,!1));const e=this.viewData,t=this.appData.application===a.lg.WORKSHOP;let i=(0,p.D)(11);for(;this.notesData.getNote(i);)i=(0,p.D)(11);const n=new se;n.user=this.userData.getCurrentUser(),n.id=i,n.floorId=this.floorsViewData.getHighestVisibleFloorId(),n.layerId=this.layersData.getNotesLayerId(t);const s=e.createNoteView(n);e.isNewNote=!0,e.commit(),this.changeNotesPhase(Y.f.CREATING),e.setOpenNoteView(s),e.setFocusedComment(null),this.pinsModule.createPin(n.id,this.getPinUpdate(n),V.yY.NOTE,s.backgroundTexture)}async confirmAttachmentChanges(e,t){return this.attachmentsModule.confirmAttachmentChanges(e,h.pi.COMMENT,t)}async cancelAttachmentChanges(){return this.attachmentsModule.cancelAttachmentChanges()}updatePendingNote(){const e=this.viewData.getPendingNote(),t=this.appData.application===a.lg.WORKSHOP;e&&t&&!this.layersData.isInMemoryLayer(e.layerId)&&(e.layerId=this.layersData.getNotesLayerId(t))}async saveNewNote(e){return this.modifyInsideSaveCommand((async()=>{if(!this.policyData.hasPolicy(_.O7))return;const t=this.viewData,i=t.getPendingNote();if(i){if(this.layersData.isInMemoryLayer(i.layerId)){const e=new se(i);return this.notesData.updateNote(e),t.setActiveNotation(null),t.isNewNote=!1,t.commit(),void this.updateNoteViewData()}const n=await this.store.create(i,e);if(!n)return void d.Vy.for(this).error("MDS Note saved failed");const s=n.comments.get(0);if(!s)throw new Error("No root comment in the new note");const a=await this.confirmAttachmentChanges(s.id,i.id);this.notesData.updateNote(n),a&&await this.refreshNote(n.id),this.parseMarkdown(e),t.setOpenNoteView(t.getNoteView(n.id));const o=t.openNoteView;if(o){const e=z(this.userData,this.policyData,F.U.NOTE,o.user);this.pinsModule.selectPin(n.id,V.yY.NOTE,e),this.pinsModule.removePin(i.id,V.yY.NOTE)}t.setActiveNotation(null),t.isNewNote=!1,t.commit(),this.updateNoteViewData()}else d.Vy.for(this).debug("No pending note")}))()}editComment(e){this.viewData.setActiveNotation(e)}setFocusedNoteComment(e,t){if(t){const i=this.viewData.getComment(e,t);this.viewData.setFocusedComment(i)}else this.viewData.setFocusedComment(null)}async openNote(e,t,i,n,s){var a;const o=(null===(a=this.annotationsViewData.dockedAnnotation)||void 0===a?void 0:a.annotationType)===F.U.NOTE,r=null!==i?i:o;return this.engine.commandBinder.issueCommand(new Me.Xx(e,h.jM.NOTE)),r?this.dockNote(e,t,n,s):this.selectNote(e,t,n)}async selectNote(e,t,i){var n;const{commandBinder:s}=this.engine;this.setFocusedNoteComment(e,i);const a=this.viewData.getNoteView(e);if(a){const{openNoteView:i}=this.viewData,o=(null==i?void 0:i.id)===e,r=(null===(n=this.annotationsViewData.dockedAnnotation)||void 0===n?void 0:n.id)===e;if(o&&!r&&i)return void d.Vy.for(this).debug("Note is already selected");this.activated&&await s.issueCommand(new b.u3(y.S0.NOTES)),this.attachmentsModule.toggleAttachmentViewer(!1),i&&(this.annotationsModule.closeAnnotation(i.id,F.U.NOTE),this.pinsModule.unselectPin(i.id,V.yY.NOTE)),this.viewData.setOpenNoteView(a),this.pinsModule.selectPin(e,V.yY.NOTE,!1),null!==t&&await s.issueCommand(new L.E4({pinPosition:a,transition:t}))}else d.Vy.for(this).debug("Cannot select a non-existent note")}async dockNote(e,t,i,n=!1){var s;const{toolsData:a,viewData:o,engine:r,activated:l,userData:c,policyData:h}=this,u=o.getNoteView(e);if(u){const{openNoteView:d,focusedComment:m}=this.viewData,p=(null==d?void 0:d.id)===e,g=(null===(s=this.annotationsViewData.dockedAnnotation)||void 0===s?void 0:s.id)===e;if(a.toolCollapsed&&r.commandBinder.issueCommand(new b.li(!1)),this.setFocusedNoteComment(e,i),p&&g)return void(o.focusedComment&&i!==(null==m?void 0:m.id)&&this.engine.broadcast(new re(o.focusedComment.id)));r.commandBinder.issueCommand(new S.rH),l||await r.commandBinder.issueCommand(new b.Wm(y.S0.NOTES,!0)),p||o.setOpenNoteView(u);const v=z(c,h,F.U.NOTE,u.user);if(this.pinsModule.selectPin(e,V.yY.NOTE,v),this.changeNotesPhase(Y.f.OPENING),null!==t&&await r.commandBinder.issueCommand(new L.E4({pinPosition:u,transition:t})),this.changeNotesPhase(Y.f.OPEN),n){const t=u.comments.get(0);let n=i?o.getComment(e,i):void 0;if(n||(n=t),!n)throw new Error("No root comment in the note");const s=z(c,h,F.U.NOTE,n.user);o.setActiveNotation(s?n.id:null)}else o.setActiveNotation(null)}else d.Vy.for(this).debug("Cannot open a non-existent note")}async deleteNote(e){return this.modifyInsideSaveCommand((async()=>{const t=this.notesData.getNote(e);if(t){this.engine.commandBinder.issueCommand(new S.rH),this.layersData.isInMemoryLayer(t.layerId)||this.store.delete([t]),this.notesData.removeNote(e);const i=this.viewData.openNoteView;i&&i.id===e&&this.closeNote(),this.pinsModule.removePin(e,V.yY.NOTE)}else d.Vy.for(this).debug("Cannot delete a non-existent note")}))()}async resolveNote(e,t){return this.modifyInsideSaveCommand((async()=>{t?await this.resolveNoteInternal(e):await this.reopenNoteInternal(e)}))()}async resolveNoteInternal(e){const t=this.notesData.getNote(e);if(t){if(t.resolved)return;this.closeNote(),await(0,l.c)(350),this.engine.broadcast(new oe(e,!0));!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!0)?this.notesData.updateNoteProperties(e,{resolved:!0}):d.Vy.for(this).error("Resolving note failed")}else d.Vy.for(this).debug("Cannot resolve a non-existent note")}async reopenNoteInternal(e){const t=this.notesData.getNote(e);if(t){if(!t.resolved)return;this.viewData.updateOpenNoteView({resolved:!1});!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!1)?this.notesData.updateNoteProperties(e,{resolved:!1}):d.Vy.for(this).error("Reopen note failed")}else d.Vy.for(this).debug("Cannot reopen a non-existent note")}modifyInsideSaveCommand(e){return async(...t)=>{await this.engine.commandBinder.issueCommand(new Be.F({dataTypes:[r.p.NOTES],onCallback:()=>e(...t),skipDirtyUpdate:!0}))}}async saveNoteChanges(e,t){return this.modifyInsideSaveCommand((async()=>{const i=this.notesData.getNote(e);if(i){const n=i.comments.get(0);if(n)return this.updateNoteComment(e,n.id,t);d.Vy.for(this).warn("no root comment")}else d.Vy.for(this).debug("Cannot update a non-existent note")}))()}cancelCommentChanges(){this.cancelAttachmentChanges(),this.viewData.setActiveNotation(null)}async saveNoteAppearance(e,t){return this.modifyInsideSaveCommand((async()=>{const i=this.notesData,n=i.getNote(e);if(n){const s=this.viewData,{openNoteView:a}=s;if(Object.keys(t)){const o=this.layersData.isInMemoryLayer(n.layerId)?Object.assign(n,t):await this.store.update(Object.assign({id:e},t));o&&(this.updateNotePin(o),i.updateNote(o),(null==a?void 0:a.id)===e&&s.updateOpenNoteView(t))}}else d.Vy.for(this).debug("Cannot update a non-existent note")}))()}async addComment(e,t,i){return this.modifyInsideSaveCommand((async()=>{const n=this.notesData.getNote(e);if(n){n.resolved&&(this.viewData.setNotesFilter(ee.S.ALL),this.reopenNoteInternal(n.id));const s=await this.store.createComment(e,{text:t});if(!s)return void d.Vy.for(this).error("Cannot create MDS comment");this.viewData.setActiveNotation(null),this.parseMarkdown(t),await this.confirmAttachmentChanges(s.id,i),await this.refreshNote(n.id),this.refreshNotes()}else d.Vy.for(this).debug("Cannot add a comment to a non-existent note")}))()}async updateComment(e,t,i){return this.modifyInsideSaveCommand((async()=>{await this.updateNoteComment(e,t,i)}))()}async updateNoteComment(e,t,i){const n=this.notesData.getNote(e);if(n){const s=this.layersData.isInMemoryLayer(n.layerId),a=n.getComment(t);if(a)if(a.user.id===this.userData.getCurrentUserId()){const o=!s&&await this.confirmAttachmentChanges(t,h.pi.COMMENT),r=i!==a.text;if(r){if(s)a.text=i;else{const e=await this.store.updateComment({id:t,text:i});e&&n.updateComment(e)}this.parseMarkdown(i)}(o||r)&&(await this.refreshNote(n.id),n.resolved&&(this.viewData.setNotesFilter(ee.S.ALL),this.reopenNoteInternal(e))),this.viewData.setActiveNotation(null)}else d.Vy.for(this).debug("Cannot update another user's comment");else d.Vy.for(this).debug("Cannot update a non-existent comment")}else d.Vy.for(this).debug("Cannot update a comment in a non-existent note")}async deleteComment(e,t){return this.modifyInsideSaveCommand((async()=>{const i=this.notesData.getNote(e);if(i){const e=i.getComment(t);e&&(this.layersData.isInMemoryLayer(i.layerId)||await this.store.deleteComment(e),i.deleteComment(t)),this.refreshNotes()}else d.Vy.for(this).debug("Cannot delete a comment in a non-existent note")}))()}filterVisibleNotes(e){const{idVisibility:t}=this.viewData;t.clear(),e.forEach((e=>t.add(e))),this.viewData.commit(),this.displayNotes()}setNotesVisibilityFilterEnabled(e){this.viewData.idVisibilityEnabled=e,this.viewData.commit(),this.displayNotes()}registerRoomAssociationSource(e){const t=this.notesData;e.commandBinder.issueCommandWhenBound(new He.l({type:"notes",getPositionId:function*(){for(const e of t.collection.values)yield{id:e.id,roomId:e.roomId,floorId:e.floorId,position:e.anchorPosition,layerId:e.layerId}},updateRoomForId:(e,t)=>{const i=this.notesData.getNote(e);if(!i)throw new Error("Invalid note id!");i.roomId=t||void 0}}))}}const Ks=Ys},45099:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>we});var n=i(68909),s=i(64882),a=i(14614),o=i(1284),r=i(71687),d=i(74381),l=i(81530),c=i(13893),h=i(9997),u=i(25727),m=i(11416),p=i(30926),g=i(81058),v=i(40590),f=i(62802),y=i(94547),w=i(58899),b=i(84917),T=i(85626);function D(e){const t=e.toLowerCase().replace(" & "," ").replace(" ","-");return T.R.includes(`object-${t}`)?`object-${t}`:"simple-tag-small"}class S extends w.r{constructor(e,t,i,n,s){var a,o,r;super(e,t,i),this.suggestion=n,this.mattertag=s,this.onSelect=()=>{super.onSelect(),this.commandBinder.issueCommand(new g.lA(this.suggestion.id))},this.title=(null===(a=this.mattertag)||void 0===a?void 0:a.label)?this.mattertag.label:this.suggestion.displayLabel,this.description=(null===(o=this.mattertag)||void 0===o?void 0:o.description)?this.mattertag.description:this.suggestion.displayCategory,this.color=(null===(r=this.mattertag)||void 0===r?void 0:r.color)?`#${this.mattertag.color.getHexString()}`:this.suggestion.color,this.id=this.suggestion.id,this.title=this.suggestion.displayLabel,this.description=this.suggestion.displayCategory,this.icon=`icon-${D(this.suggestion.displayLabel)}`,this.color=this.suggestion.color,this.enabled=this.suggestion.visible,this.typeId=d.jM.OBJECTANNOTATION,this.floorId=this.suggestion.floorId,this.roomId=this.suggestion.roomId||"",this.dateBucket=(0,b.n)(this.suggestion.created),this.layerId=this.suggestion.layerId}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}}var C=i(56147),E=i(39869),A=i(51831),P=i(91977),I=i(39066),k=i(19389),N=i(48270),x=i(1494),M=i(90087),O=i(74848);const{WORKSHOP:R,HIDE:L,SHOW:V}=C.A;function j(e){let{item:t,onToggle:i}=e;const n=(0,M.L)(),s=(0,E.Y)(),{enabled:a,id:o,typeId:r}=t,d=!t.isLayerVisible(),l=!a||d?"eye-hide":"eye-show",c=(0,x.H)(),h=d?s.t(R.LAYERS.HIDDEN_LAYER_ITEM_TOOLTIP):a?s.t(L):s.t(V);return(0,O.jsx)(k.$,{icon:l,dimmed:!a,variant:N.A.TERTIARY,onClick:e=>{e.stopPropagation(),d||(a&&c===o&&n.issueCommand(new y.Xx(null,r)),i(!a))},tooltip:h})}var B=i(38731),F=i(17904),H=i(68375);const{OBJECT_TAG_SUGGESTION:U}=C.A.WORKSHOP,_=e=>{let{item:t}=e;const{id:i,typeId:n}=t,s=(0,B.B)(),a=(0,H.s)(),o=(0,M.L)(),l=(0,E.Y)(),c=(0,F.S)(r.Et),h=(0,F.S)(r.kd);if(!s||n!==d.jM.OBJECTANNOTATION||!h)return null;function m(e){a.track("showcase_gui",{tool:"object_tags",gui_action:e})}return(0,O.jsxs)(P.e,{children:[(0,O.jsx)(j,{item:t,onToggle:e=>{o.issueCommand(new g._8(i,e)),m(e?"object_tags_show_click":"object_tags_hide_click")}}),(0,O.jsxs)(I.y,{icon:"more-vert",ariaLabel:l.t(C.A.MORE_OPTIONS),menuArrow:!0,menuClassName:"search-result-menu",children:[(0,O.jsx)(k.$,{label:l.t(U.SEARCH_ITEM_EDIT),onClick:()=>{o.issueCommand(new y.Xx(i,n)),o.issueCommand(new g.y_(i)),m("object_tags_edit_click")},variant:N.A.TERTIARY,size:N.M.SMALL}),(0,O.jsx)(k.$,{className:"menu-delete-btn",label:l.t(U.SEARCH_ITEM_DELETE),onClick:()=>{o.issueCommand(new g.lg(i)),h.removePin(i,u.yY.OBJECT),c?.closeAnnotation(i,A.U.OBJECT),m("object_tags_delete_click")},variant:N.A.TERTIARY,size:N.M.SMALL})]})]})};var G=i(47613);const{OBJECT_TAG_SUGGESTION:z}=C.A.WORKSHOP,$=e=>{let{group:t}=e;const i=(0,B.B)(),n=(0,H.s)(),s=(0,M.L)(),a=(0,E.Y)(),o=(0,G._)(),{matches:r}=t;if(!i)return null;if(0===r.length)return null;const d=r.filter((e=>e.enabled)).length,l=d===r.length,c=0===d;function h(e){n.track("showcase_gui",{tool:"object_tags",gui_action:e})}const u=!o||!o.canBatchDeleteInActiveView();return(0,O.jsx)(P.e,{children:(0,O.jsxs)(I.y,{icon:"more-vert",ariaLabel:a.t(C.A.MORE_OPTIONS),menuArrow:!0,menuClassName:"search-result-menu",children:[(0,O.jsx)(k.$,{label:a.t(z.SEARCH_GROUP_HIDE_ALL),onClick:()=>{s.issueCommand(new g.ye(!1,...r.map((e=>e.id)))),h("hide_all_click")},variant:N.A.TERTIARY,size:N.M.SMALL,disabled:c}),(0,O.jsx)(k.$,{label:a.t(z.SEARCH_GROUP_SHOW_ALL),onClick:()=>{s.issueCommand(new g.ye(!0,...r.map((e=>e.id)))),h("show_all_click")},variant:N.A.TERTIARY,size:N.M.SMALL,disabled:l}),u&&(0,O.jsx)(k.$,{className:"menu-delete-btn",label:a.t(z.SEARCH_GROUP_DELETE_ALL),onClick:()=>{s.issueCommand(new g.lg(...r.map((e=>e.id)))),h("delete_all_click")},variant:N.A.TERTIARY,size:N.M.SMALL})]})})};var W=i(44354),Y=i(86866),K=i(20968),X=i(77754),q=i(3928);const Q=.065;class J extends q.v{constructor(e){super(),this.created=new Date,this.modified=new Date,this.position=new n.Vector3,this.stemDirection=new n.Vector3,this.stemLength=Q,this.stemEnabled=!1,this.enabled=!0,this.icon="simple-tag",e&&(Object.assign(this,e),this.keywords=e.keywords||[],this.label&&(this.icon=D(this.label)))}get displayLabel(){return this.localizedName?this.localizedName:this.label}get displayCategory(){return this.localizedCategory?this.localizedCategory:""}get visible(){return this.enabled}set visible(e){this.enabled=e,this.commit()}getMattertagOptions(){return{color:new n.Color(this.color),description:this.displayCategory,enabled:!0,floorId:this.floorId,roomId:this.roomId,label:this.displayLabel,normal:this.stemDirection.clone(),objectAnnotationId:this.id,position:this.position.clone(),stemHeight:this.stemLength,stemVisible:!0,keywords:this.keywords.slice(),icon:this.icon}}getPin(e){return{id:this.id,floorId:this.floorId,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemEnabled:!1,stemLength:Q,color:e?`#${e.color.getHexString()}`:this.color,roomId:this.roomId,layerId:this.layerId,icon:this.icon}}toTagView(e){return{id:this.id,label:e?e.label:this.displayLabel,description:e?e.description:this.displayCategory,enabled:this.enabled,backgroundTexture:ye,attachments:(null==e?void 0:e.fileAttachments.values())||[],created:this.created,modified:this.modified,stemEnabled:this.stemEnabled,color:this.color,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemLength:this.stemLength,floorId:this.floorId,roomId:this.roomId,layerId:this.layerId,keywords:e?null==e?void 0:e.keywords.values():this.keywords.slice(),icon:this.icon}}}var Z,ee=i(81587),te=i(9139);!function(e){e.APPLIANCE="Appliance",e.CONSUMER_ELECTRONICS="Consumer Electronics",e.FIXTURE="Fixture",e.FURNITURE="Furniture",e.LIGHTING="Lighting"}(Z||(Z={}));const ie=Object.freeze({pink:"#f78da7",plum:"#9c4b92",purple:"#673ab7",teal:"#03687d",cerulean:"#03a9f4",ocean:"#00bcd4",fog:"#abb8c3",iron:"#607d8b",forest:"#417505",emerald:"#51a868",mint:"#37d67a",lime:"#cddc39",canary:"#fbcd00",sunflower:"#ffac17",tangerine:"#ff6900",sunset:"#f44336",sierra:"#d44441",magenta:"#e91e63"}),ne="WORKSHOP.OBJECT_TAG_SUGGESTION.VISION.";class se{constructor(e){this.locale=e,this.locale=e,this.log=new te.Vy("Object-tag-deserializer"),this.keywordList=Object.values(Z)}deserialize(e){var t,i,n,s;if(!e||!this.validate(e))return null;const a=e.region,o=(null==a?void 0:a.anchorPosition)?Y.U$.fromVisionVector(a.anchorPosition):void 0,r=(null==a?void 0:a.stemNormal)?Y.U$.fromVisionVector(a.stemNormal):void 0,d=new J({id:e.id,confidence:null!==(t=e.confidence)&&void 0!==t?t:0,created:(0,ee.XH)(e.created),modified:(0,ee.XH)(e.created),enabled:e.enabled});(null===(i=e.region)||void 0===i?void 0:i.stemLength)&&(d.stemLength=e.region.stemLength),e.floor&&e.floor.id&&(d.floorId=e.floor.id),e.room&&e.room.id&&(d.roomId=e.room.id),e.layer&&e.layer.id&&(d.layerId=e.layer.id),o&&(d.position=o),r&&(d.stemDirection=r),d.mattertagId=null===(n=e.tag)||void 0===n?void 0:n.id;let l=e.keywords||[],c=e.label||"";if(e.classification){const t=e.classification,i=ne+this.formatStringToPhraseKey(t.label);this.locale.has(i)&&(d.localizedName=this.locale.t(i));const{defaultKeywords:n}=t;if(n&&n.length>0){const e=n[n.length-1],t=ne+this.formatStringToPhraseKey(e);this.locale.has(t)&&(d.localizedCategory=this.locale.t(t))}t.label&&(c=t.label,d.icon=D(c)),t.defaultKeywords&&(l=t.defaultKeywords);const s=[];for(const e of l){const t=ne+this.formatStringToPhraseKey(e);this.locale.has(t)?s.push(this.locale.t(t)):s.push(e)}l=s}return d.keywords=l,d.label=c,this.postProcess(d,null===(s=e.classification)||void 0===s?void 0:s.defaultKeywords),d}formatStringToPhraseKey(e){return e.trim().replace(/\s/,"_").toUpperCase()}validate(e){if(!e)return!1;const t=["id","label","created","modified","region"];for(const i of t){if(!(i in e))return this.log.error("Missing field: ",i),!1}return!0}postProcess(e,t){let[i,n]=e.label.split(".").slice(1);if(i&&!e.localizedCategory){const t=ne+i.toUpperCase();this.locale.has(t)?e.localizedCategory=this.locale.t(t):e.localizedCategory=i}if(n&&!e.localizedName){const t=ne+n.toUpperCase();this.locale.has(t)?e.localizedName=this.locale.t(t):e.localizedName=n}if(t&&t.length>0)for(const e of this.keywordList)if(t.includes(e)){i=e;break}e.color=this.getCategoryColor(i)}getCategoryColor(e){switch(e){case"appliances":return ie.cerulean;case"consumer_electronics":return ie.emerald;case"fixtures":return ie.sunset;case Z.APPLIANCE:return ie.cerulean;case Z.CONSUMER_ELECTRONICS:return ie.emerald;case Z.FIXTURE:return ie.sunset;case Z.FURNITURE:return ie.canary;case Z.LIGHTING:return ie.fog;default:return ie.forest}}}class ae extends K.g{constructor(e,t,i){super(e),this.classifications=[],this.layeredType=d.jM.OBJECTANNOTATION,this.confidence=i||.9,this.objectDeserializer=new se(t),this.deserializer=new X.n({deserializer:this.objectDeserializer})}async read(e){const t={modelId:this.getViewId(),minConfidence:this.confidence,includeDisabled:!0,inferenceEvents:null,ids:null,includeLayers:this.readLayerId()};return this.query(W.GetObjectAnnotations,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.objectAnnotations;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async toggleEnabled(e,t){const i={modelId:this.getViewId(),objectAnnotationId:e,data:{enabled:t},includeLayers:this.readLayerId()};return this.mutate(W.PatchObjectAnnotation,i).then((e=>{var t;const i=null===(t=e.data)||void 0===t?void 0:t.patchObjectAnnotation;if(i){const e=this.objectDeserializer.deserialize(i);if(e)return e}throw new Error("Could not update Object Annotation")}))}async toggleAllEnabled(e,...t){const i={modelId:this.getViewId(),objectAnnotationIds:t,setEnabled:e,includeLayers:this.readLayerId()};return this.mutate(W.SetBulkObjectAnnotationsEnabled,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.setBulkObjectAnnotationsEnabled;if(!i)throw new Error("Could not update Object Annotations");return i.map((e=>e.id))}))}async deleteObjectAnnotation(e){const t={modelId:this.getViewId(),objectAnnotationId:e};return this.mutate(W.DeleteObjectAnnotation,t).then((e=>{var t;return!!(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.deleteObjectAnnotation)}))}async createObjectTag(e){const t={label:e.label,keywords:e.keywords||[],floorId:e.floorId,layerId:this.writeLayerId(e.layerId)?e.layerId:void 0,enabled:!0,vectorRegion:{anchorPosition:Y.U$.toVisionVector(e.position),stemNormal:Y.U$.toVisionVector(e.stemDirection),stemLength:e.stemLength}},i={modelId:this.getViewId(),objectAnnotation:t,includeLayers:this.readLayerId()};return this.mutate(W.AddObjectAnnotation,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.addObjectAnnotation;if(i){const e=this.objectDeserializer.deserialize(i);if(e)return e}throw new Error("Could not create Object Annotation")}))}}var oe=i(32024);const re=i.p+"images/objectColor.png";var de=i(78849),le=i(29479),ce=i(99104),he=i(45205),ue=i(96437),me=i(17084),pe=i(73566),ge=i(304),ve=i(47737),fe=i(39118);const ye=(0,oe.y)(re);class we extends s.n{constructor(){super(...arguments),this.name="object-tag-suggestions-data",this.visibilityEnabled=!1,this.idVisibility=new Set,this.createdTag=null,this.onPinSelectionChange=e=>{const{commandBinder:t}=this.engine,{billboardAnnotation:i}=this.annotationsViewData,n=e?this.data.getObjectTag(e):null;n?(t.issueCommand(new y.Xx(n.id,d.jM.OBJECTANNOTATION)),this.annotationsModule.previewAnnotation(n.id,n.layerId,A.U.OBJECT)):i&&i.annotationType===A.U.OBJECT&&this.annotationsModule.closeAnnotation(i.id,A.U.OBJECT)},this.onPinFocusChange=async()=>{const{commandBinder:e}=this.engine,{focusedPin:t,selectedPinId:i}=this.pinsViewData,{billboardAnnotation:n,dockedAnnotation:s}=this.annotationsViewData;if(!t)return void(n&&n.annotationType===A.U.OBJECT&&n.id!==i&&this.annotationsModule.closeAnnotation(n.id,A.U.OBJECT));const a=i?this.pinsViewData.getPin(i):null;a&&a.pinType===u.yY.OBJECT&&(this.pinsModule.unselectPin(a.id,u.yY.OBJECT),e.issueCommand(new y.Xx(null))),t.pinType===u.yY.OBJECT&&t.id!==(null==s?void 0:s.id)&&this.annotationsModule.previewAnnotation(t.id,t.layerId,A.U.OBJECT)},this.onLayersChanged=()=>{this.unselectObjectPin(),this.unselectObjectSearchResult(),this.displayObjects()},this.toggleObjectAnnotations=async e=>{const{enabled:t}=e;this.visibilityEnabled=t,this.pinsModule.changePinVisibilityByType(u.yY.OBJECT,t),t||(this.unselectObjectPin(),this.unselectObjectSearchResult()),this.displayObjects()},this.selectedItemChanged=()=>{const{activeItemId:e,selectedType:t}=this.searchData;if(e&&t===d.jM.OBJECTANNOTATION){const t=this.data.getObjectTag(e);t&&this.updatePin(t)}},this.setAllObjectTagsEnabled=async e=>{const{ids:t,enabled:i}=e;0!==t.length&&(await this.store.toggleAllEnabled(i,...t),this.data.atomic((()=>{for(const e of this.data.collection)t.includes(e.id)&&(e.enabled=i,e.commit())})),this.unselectObjectPin(),this.unselectObjectSearchResult())},this.toggleObjectTagEnabled=async e=>{const{id:t,enabled:i}=e,n=this.data.getObjectTag(t);if(!n)throw new Error("Object tag not found!");if(n.enabled===i)return;await this.store.toggleEnabled(t,i)&&(n.enabled=i,n.commit(),this.unselectObjectPin(t),this.unselectObjectSearchResult(t))},this.deleteTags=async e=>{const{ids:t}=e;if(0===t.length)return;const i=this.annotationsViewData.billboardAnnotation;(null==i?void 0:i.annotationType)===A.U.OBJECT&&this.annotationsModule.closeAnnotation(i.id,A.U.OBJECT);for(const e of t){if(!await this.store.deleteObjectAnnotation(e))throw new Error("Could not delete Object Annotation");{this.data.removeObjectTag(e);const t=this.data.getObjectTag(e);t&&t.mattertagId&&await this.engine.commandBinder.issueCommand(new ce.RL(t.mattertagId,"search_menu_object_tag"))}}},this.createObjectTag=async e=>{const{id:t,options:i,pendingAttachments:s,embed:a}=e,o=new J,r=null==i?void 0:i.color,l=r?`#${new n.Color(r.r,r.g,r.b).getHexString(n.LinearSRGBColorSpace)}`:"#ffffff";if(o.label=i.label||"",o.floorId=i.floorId||"",o.keywords=i.keywords||[],o.stemDirection=i.normal||new n.Vector3,o.stemLength=i.stemHeight?Math.max(i.stemHeight,Q):Q,o.position=i.position||new n.Vector3,o.color=l,o.layerId=this.layersData.activeLayerId,await this.modifyInsideSaveCommand((async()=>{this.createdTag=await this.store.createObjectTag(o)}))(),!this.createdTag)return;const c=this.createdTag.id,{commandBinder:h}=this.engine;i.objectAnnotationId=c,await h.issueCommand(new ce.Bu(t,i,s,void 0,a)),this.createdTag.mattertagId=t,this.data.updateObjectTag(this.createdTag);const m=this.getPinUpdate(this.createdTag);this.createdTag=null,this.pinsModule.updatePin(c,u.yY.OBJECT,m),await h.issueCommand(new me.u3(pe.S0.TAGS)),h.issueCommand(new ge.x),await h.issueCommand(new me.Wm(pe.S0.LAYERS)),h.issueCommand(new ge._),h.issueCommand(new y.Xx(c,d.jM.OBJECTANNOTATION)),await h.issueCommand(new g.lA(c))},this.dockObjectTag=async e=>{const{id:t}=e,i=this.data.getObjectTag(t);if(!i)return;const{commandBinder:n}=this.engine;if(!i.mattertagId){const e=i.getMattertagOptions(),t=(0,he.D)(11);n.issueCommand(new ue.Ee(t,e)),i.mattertagId=t}n.issueCommand(new ce.Ki(i.mattertagId,{dock:!0,objectTag:!0}))}}async init(e,t){super.init(e,t),this.engine=t,[this.locale,this.pinsModule,this.pinsViewData,this.annotationsViewData,this.mattertagsData,this.layersData,this.searchData,this.appData,this.annotationsModule]=await Promise.all([t.getModuleBySymbol(r.gS),t.getModuleBySymbol(r.kd),t.market.waitForData(m.U),t.market.waitForData(p.o),t.market.waitForData(le.j),t.market.waitForData(ve.P),t.market.waitForData(de.L),t.market.waitForData(a.zH),t.getModuleBySymbol(r.Et)]),this.store=new ae({context:this.layersData.mdsContext,readonly:!1,baseUrl:e.baseUrl},this.locale,e.minConfidence),this.pinsModule.changePinVisibilityByType(u.yY.OBJECT,!1),this.data=new v.$,this.store.onNewData(this.loadNewData.bind(this));const{commandBinder:i}=this.engine;this.bindings.push(i.addBinding(g.vX,this.toggleObjectAnnotations),i.addBinding(g.HZ,(async e=>this.filterObjectTagSuggestions(e.ids))),i.addBinding(g.lA,(async({id:e})=>this.navigateToSuggestion(e))),i.addBinding(g.ye,this.modifyInsideSaveCommand(this.setAllObjectTagsEnabled)),i.addBinding(g._8,this.modifyInsideSaveCommand(this.toggleObjectTagEnabled)),i.addBinding(g.lg,this.modifyInsideSaveCommand(this.deleteTags)),i.addBinding(g.R5,this.createObjectTag),i.addBinding(g.y_,(async e=>this.dockObjectTag(e))),this.appData.onChanged((()=>this.displayObjects())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),this.searchData.onPropertyChanged("activeItemId",this.selectedItemChanged),this.pinsViewData.onSelectedPinChanged(this.onPinSelectionChange),this.pinsViewData.onFocusedPinChanged((()=>this.onPinFocusChange())),this.data.onChanged((()=>this.displayObjects())),this.data.collection.onElementChanged({onAdded:this.updatePin.bind(this),onUpdated:this.updatePin.bind(this),onRemoved:this.removePin.bind(this)})),await this.store.refresh(),this.engine.market.register(v.$,this.data),this.registerRoomAssociationSource(t),async function(e,t,i,n){const s=await e.market.waitForData(a.zH);let o=s.application===a.lg.WORKSHOP;const r=(s,a,r,d=[])=>{const c=[];return t.iterate((t=>{if(!(o||t.visible&&n.layerToggled(t.layerId)))return;const r=[t.displayLabel,t.displayCategory],l=[...t.keywords],h=t.mattertagId?i.getTag(t.mattertagId):void 0;h&&(r.length=0,l.length=0,r.push(h.label,h.description),l.push(...h.keywords));const u=r.filter((e=>!!e));let m=s(...u);m&&d.length>0&&(m=l.length>0&&l.some((e=>d.includes(e)))),m&&c.push(new S(e.commandBinder,n,a,t,h))})),e.commandBinder.issueCommand(new g.HZ(c.map((e=>e.id)))),l(c),c},l=e=>{e.sort(((e,t)=>{var i;const n=e,s=t,a=null===(i=n.description)||void 0===i?void 0:i.localeCompare(s.description);return 0!==a?a:n.title.localeCompare(s.title)}))},c=t=>{e.commandBinder.issueCommand(new g.vX(!!t))},h=()=>{let e=[];return t.iterate((t=>{t.visible&&t.keywords.length&&!t.mattertagId&&(e=e.concat(t.keywords))})),e},u=e=>new f.P(t.onChanged(e),i.onChanged(e)),m=()=>{e.commandBinder.issueCommandWhenBound(new y.Oc({id:d.jM.OBJECTANNOTATION,groupPhraseKey:"WORKSHOP.OBJECT_TAG_SUGGESTION.SEARCH_GROUP_HEADER",getSimpleMatches:r,registerChangeObserver:u,onSearchActivatedChanged:c,getKeywords:h,groupOrder:90,groupIcon:"snap",groupActionsFC:$,itemActionsFC:_,batchSupported:!0}))},p=()=>{e.commandBinder.issueCommandWhenBound(new y.tf(d.jM.OBJECTANNOTATION))},v={renew:m,cancel:p},w=e=>{o=e===a.lg.WORKSHOP,p(),m()},b=s.onPropertyChanged("application",w);return w(s.application),new f.P(v,b)}(t,this.data,this.mattertagsData,this.layersData).then((e=>this.bindings.push(e)))}loadNewData(e){this.data.atomic((()=>{this.layersData.replaceBackendLayers(this.data.collection,e||{})}))}dispose(e){super.dispose(e),this.data&&e.market.unregister(v.$)}modifyInsideSaveCommand(e){return async(...t)=>{await this.engine.commandBinder.issueCommand(new l.F({dataTypes:[o.p.OBJECT_ANNOTATIONS],onCallback:()=>e(...t),skipDirtyUpdate:!0}))}}displayObjects(){const e=[];this.data.collection.values.forEach((t=>{e.push(this.getPinUpdate(t))})),this.pinsModule.updatePinViews(e)}removePin(e){this.pinsModule.removePin(e.id,u.yY.OBJECT)}updatePin(e){const t=this.getPinUpdate(e);this.pinsModule.updatePinViews([t])}getPinUpdate(e){const t=this.mattertagsData.getTag(e.mattertagId||""),i=e.getPin(t);return Object.assign({id:e.id,pinType:u.yY.OBJECT,backgroundTexture:ye,visible:this.getObjectVisibility(e.id,e.layerId,e.visible),scale:new n.Vector3(.75,.75,.75)},i)}getObjectVisibility(e,t,i){if(!this.visibilityEnabled)return!1;const{activeItemId:n,selectedType:s}=this.searchData,o=this.appData.application===a.lg.WORKSHOP||this.layersData.layerToggled(t),r=this.layersData.layerVisible(t),l=this.idVisibility.has(e),c=n===e&&s===d.jM.OBJECTANNOTATION;return o&&(c||i&&l&&r)}async filterObjectTagSuggestions(e){this.idVisibility.clear(),e.forEach((e=>this.idVisibility.add(e))),this.displayObjects()}async navigateToSuggestion(e){const t=this.data.getObjectTag(e);if(!t)return;const i={anchorPosition:t.position.clone(),stemNormal:t.stemDirection.clone(),stemLength:t.stemLength,stemEnabled:!0,color:"",floorId:t.floorId,roomId:t.roomId,layerId:t.layerId};await this.engine.commandBinder.issueCommand(new h.E4({pinPosition:i,transition:c.fl.FadeToBlack})),this.pinsModule.selectPin(e,u.yY.OBJECT,!1)}unselectObjectPin(e){const{selectedPinId:t}=this.pinsViewData;if(t){const i=this.pinsViewData.getPin(t);i&&(i.pinType!==u.yY.OBJECT||e&&e!==t||this.pinsModule.unselectPin(t,u.yY.OBJECT))}}unselectObjectSearchResult(e){const{selectedType:t,activeItemId:i}=this.searchData;i&&t===d.jM.OBJECTANNOTATION&&(e&&e!==i||this.engine.commandBinder.issueCommand(new y.Xx(null)))}registerRoomAssociationSource(e){const t=this.data;e.commandBinder.issueCommandWhenBound(new fe.l({type:"objectAnnotations",getPositionId:function*(){for(const e of t.collection.values)yield e},updateRoomForId:(e,i)=>{const n=t.getObjectTag(e);if(!n)throw new Error("Invalid object detection id!");n.roomId=i||void 0}}))}}},11779:(e,t,i)=>{"use strict";i.d(t,{Y:()=>a});var n=i(12625),s=i(88325);class a extends n.B{constructor(e){super(),this.name="ordered-list-data",this.lists=(0,s.y)(e)}replace(e){this.lists.replace(e)}getOrderedLists(){return this.lists.values}getOrderedList(e){return this.lists.get(e)}updateOrderedList(e){this.lists.has(e.name)?this.lists.get(e.name).copy(e):this.lists.set(e.name,e)}}},44482:(e,t,i)=>{"use strict";i.d(t,{N3:()=>a,Qm:()=>o,lr:()=>s});var n=i(11165);class s extends n.u{constructor(e,t){super(),this.payload={name:e,entries:t}}}s.id="ORDERED_LIST_NAMED_SAVE";class a extends n.u{constructor(e,t){super(),this.payload={name:e,entries:t}}}a.id="ORDERED_LIST_CREATE";class o extends n.u{constructor(e,t,i){super(),this.payload={id:e,name:t,entries:i}}}o.id="ORDERED_LIST_UPDATE"},11864:(e,t,i)=>{"use strict";var n;i.d(t,{_:()=>n}),function(e){e.TAG="tag"}(n||(n={}))},79747:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CreateOrderedListCommand:()=>b.N3,MdsOrderedListDeserializer:()=>v,MdsOrderedListStore:()=>y,OrderedList:()=>d,OrderedListData:()=>w.Y,OrderedListEntryType:()=>S._,SaveNamedOrderedListCommand:()=>b.lr,TAG_ORDERED_LIST_NAME:()=>C.K,UpdateOrderedListCommand:()=>b.Qm,default:()=>E});var n=i(64882),s=i(1284),a=i(71687),o=i(81530),r=i(3928);class d extends r.v{constructor(e){super(),this.id="",this.name="",this.description="",this.entries=[],this.layerId="",e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.name=e.name,e.description&&(this.description=e.description),this.entries=e.entries.slice(),this.commit(),this}}var l=i(20968),c=i(96276),h=i(47907),u=i(75027),m=i(9139),p=i(92711);const g=new m.Vy("ordered-list-deserializer");class v{deserialize(e){var t,i,n;return e&&this.validate(e)?new d({id:e.id,name:null!==(t=e.label)&&void 0!==t?t:"",layerId:null!==(n=null===(i=e.layer)||void 0===i?void 0:i.id)&&void 0!==n?n:"",entries:e.entries.filter((e=>!!e)).map((e=>({id:e.id,type:e.type})))}):(g.debug("Deserialized invalid ordered list data from Mds",e),null)}validate(e){return["id","label","entries"].every((t=>t in e))}}const f=new m.Vy("MdsOrderedListStore");class y extends l.g{constructor(e){super(e),this.prefetchKey="data.model.orderedLists",this.deserializer=new v}async read(){const e={modelId:this.getViewId(),includeLayers:this.readLayerId()};return this.query(p.GetOrderedLists,e).then((e=>{var t,i;const n=null===(i=null===(t=e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.orderedLists;if(!n||!Array.isArray(n))return f.debug("GetOrderedLists failed"),{};return n.reduce(((e,t)=>{const i=this.deserializer.deserialize(t);return i&&(e[i.name]&&f.debug(`Duplicate orderedList found with label: ${i.name}`),e[i.name]=i),e}),{})}))}async create(e,t){return 0===e.length?[]:Promise.all(e.map((e=>this.createOrderedList(e,t))))}async createOrderedList(e,t){var i;const n={modelId:this.getViewId(),label:e.name,description:e.description,entries:e.entries,includeLayers:this.readLayerId()};let s;if(t&&this.writeLayerId(t)){const e=Object.assign({layerId:t},n);s=await this.mutate(p.AddOrderedListWithLayer,e).catch((e=>{throw new c.YA(e)}))}else s=await this.mutate(p.AddOrderedList,n).catch((e=>{throw new c.YA(e)}));if(null===(i=s.data)||void 0===i?void 0:i.addOrderedList){const e=this.deserializer.deserialize(s.data.addOrderedList);if(e)return e.layerId&&await this.context.updateForAutoProvisionedLayer(e.layerId),e}throw new Error("Unable to create new OrderedList")}async update(e){if(0===e.length)return;const t=this.getViewId();let i="";const n={};n.modelId=t;let s="";for(const t of e){const e=t.id;i+=`\n        , $label${e}: String!\n        , $description${e}: String!\n        , $entries${e}: [EntryInput!]\n      `,n[`label${e}`]=t.name,n[`description${e}`]=t.description,n[`entries${e}`]=t.entries,s+=`\n        update${e}:\n        patchOrderedList(modelId: $modelId,\n                         orderedListId: "${e}",\n                         label: $label${e},\n                         description: $description${e},\n                         entries: $entries${e}) {\n          id\n          label\n          entries {\n            id\n            type\n          }\n        }\n      `}const a=h.J1`
      mutation orderedListsUpdate($modelId: ID! ${i}) {
        ${s}
      }
    `;return this.mutate(a,n).then((e=>{f.debug(Object.assign({type:"patchOrderedList"},Object.values((0,u.L)(e,"data"))))}))}}var w=i(11779),b=i(44482),T=i(47737);class D extends n.n{constructor(){super(...arguments),this.name="ordered-lists",this.saveNamedOrderedList=async e=>{const{name:t,entries:i}=e;let n=this.data.getOrderedList(t);return n?n.entries=i:n=new d({name:t,entries:i}),this.data.updateOrderedList(n),this.engine.commandBinder.issueCommand(new o.F({dataTypes:[s.p.ORDERED_LISTS]}))}}async init(e,t){const{baseUrl:i,workshop:n}=e;if(this.engine=t,this.layersData=await t.market.waitForData(T.P),this.store=new y({context:this.layersData.mdsContext,baseUrl:i,readonly:!n}),this.bindings.push(this.store.onNewData((async e=>{this.data.replace(e)}))),this.data=new w.Y({}),await this.store.refresh(),n){const e=await t.getModuleBySymbol(a.T9);this.bindings.push(t.commandBinder.addBinding(b.lr,this.saveNamedOrderedList),e.onSave((()=>this.save()),{dataType:s.p.ORDERED_LISTS}))}t.market.register(w.Y,this.data)}dispose(e){this.store.dispose(),super.dispose(e)}onUpdate(){}async save(){const e=this.data.getOrderedLists(),t=[],i=[];e.forEach((e=>{""===e.id?t.push(e):i.push(e)}));return Promise.all([this.store.create(t,this.layersData.getOrderedListsLayerId()),this.store.update(i)]).then((e=>{e[0].forEach((e=>{e&&this.data.updateOrderedList(e)}))}))}}var S=i(11864),C=i(98241);const E=D},98241:(e,t,i)=>{"use strict";i.d(t,{K:()=>n});const n="mp.tags"},12251:(e,t,i)=>{"use strict";i.r(t),i.d(t,{NewPinReadyMessage:()=>$.wk,PinAddCancelledMessage:()=>$.lY,PinAnchorMesh:()=>z,PinClickedMessage:()=>$.oX,PinColorVariant:()=>j.ob,PinEditor:()=>Q,PinEditorState:()=>j.ce,PinHeadMesh:()=>B.R,PinHoverChangeMessage:()=>$.RG,PinMovedMessage:()=>$.cC,PinPlacedMessage:()=>$.yi,PinPlacementCancelledMessage:()=>$.fD,PinPreviewDirection:()=>j.DH,PinRenderer:()=>ue,PinType:()=>j.yY,PinUpdatedMessage:()=>$.UW,PinsViewData:()=>w.U,default:()=>Se});var n=i(68909),s=i(64882),a=i(14614),o=i(27200),r=i(9139),d=i(71687),l=i(71067),c=i(90834),h=i(12837),u=i(99583),m=i(66806),p=i(35699),g=i(77510),v=i(40899),f=i(1197),y=i(45862),w=i(11416),b=i(62802),T=i(64356),D=i(19968),S=i(35457),C=i(6687),E=i(5984);var A=i(3694),P=i(23184),I=i(72268),k=i(78079),N=i(31002),x=i(94790),M=i(18633),O=i(60043),R=i(9360),L=i(28337),V=i(71397),j=i(25727),B=i(65425),F=i(37458),H=i(32024);const U=i.p+"images/pinAnchor.png";var _=i(86224),G=i(40397);class z extends n.Mesh{constructor(e){super(new n.PlaneGeometry(_.A.anchor.size,_.A.anchor.size),new n.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:z.getTexture(),side:n.DoubleSide})),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=F.X.pins,this.worldPosition=new n.Vector3}update(e,t,i){const n=_.A.pinHeadMesh.scale;this.getWorldPosition(this.worldPosition);const s=(0,G.cv)(this.worldPosition,e,t,i,n);this.scale.set(s,s,s)}static getTexture(){return z.anchorTexture||(z.anchorTexture=(0,H.y)(U)),z.anchorTexture}}var $=i(79457),W=i(10459),Y=i(58229),K=i(63362),X=i(9997),q=i(39209);class Q{constructor(e,t,i,s,a,l){this.viewData=e,this.engine=t,this.input=i,this.pinRenderer=s,this.cursorController=a,this.pinsModule=l,this.editEnabled=!1,this.handlersRegistered=!1,this.bindings=[],this.externalBehaviorsBlocked=!1,this.touchDevice=(0,o.C8)(),this.ndcPoint=new n.Vector3,this.movingPin=!1,this.anchored=!1,this.inAnchorClick=!1,this.startingPinData=void 0,this.log=new r.Vy("pin-editor"),this.stopEventPropagation=()=>!0,this.updateMeshPreviewSphere=async(e,t)=>{this.engine.commandBinder.issueCommand(new S.P(e,t))},this.startPinCreation=()=>{this.editEnabled&&(this.viewData.setPinEditorState(j.ce.CREATING),this.addingHandlers.renew(),this.touchDevice||this.engine.commandBinder.issueCommand(new p.X(g.b.XHAIR)),this.engine.commandBinder.issueCommand(new K._p))},this.endPinCreation=()=>{this.editEnabled&&(this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.viewData.setPinEditorState(j.ce.IDLE),this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new p.X(g.b.DEFAULT)),this.engine.commandBinder.issueCommand(new K.tA))},this.onSelectedPinChanged=()=>{const{selectedPinId:e}=this.viewData;e?this.selectedHandlers.renew():this.selectedHandlers.cancel(),this.updateAnchorMesh()},this.onPinStateUpdated=()=>{const e=this.viewData.pinEditorState;switch(this.updateAnchorMesh(),e){case j.ce.PLACING:this.draggingHandlers.renew();break;case j.ce.IDLE:this.allowExternalBehaviors(!0)}},this.updateAnchorMesh=()=>{if(!this.editEnabled)return;const{pinEditorState:e,isPinEditable:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;n&&e!==j.ce.CREATING?([j.ce.PLACING,j.ce.PLACED].includes(e)||t?(this.pinRenderer.showAnchorMesh(n.pinType,n.id,n),this.anchored=!0):this.removePinAnchorMesh(),this.editableSelectedHandlers.renew()):(this.editableSelectedHandlers.cancel(),this.anchored&&this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1))},this.placePin=()=>{if(this.viewData.pinEditorState===j.ce.PLACING){this.engine.commandBinder.issueCommand(new p.X(g.b.DEFAULT));try{this.pinsModule.placePin()}catch(e){r.Vy.for(this).error("Failed to place pin:",e)}this.engine.broadcast(new $.wk),this.updateMeshPreviewSphere(!1)}},this.onDragEvent=e=>{e.buttons!==I.O.PRIMARY&&(this.touchDevice||this.viewData.selectedPinId)||this.positionPin(e)},this.onDragEnd=e=>{const{creatingNewPin:t,pinEditorState:i,selectedPinId:n}=this.viewData,s=n?this.viewData.getPin(n):null;t&&!this.touchDevice&&i===j.ce.PLACING||(s&&!t&&(this.pinsModule.movePin(s.id,this.copyPinData(s),this.startingPinData),this.updateMeshPreviewSphere(!1)),this.doneMovingPin(),this.inAnchorClick=!1)},this.positionPin=(()=>{const e=new n.Vector3;return async t=>{if(this.touchDevice&&t.buttons!==I.O.PRIMARY)return!1;const i=this.viewData,{pinEditorState:n,selectedPinId:s}=i;if(n===j.ce.CREATING)this.cursorController.disableCursorMesh(!0);else if(n!==j.ce.PLACING&&!this.movingPin)return!1;const a=s?i.getPin(s):null;if(!a)return!1;this.saveScreenPosition(t.position.x,t.position.y);const o=this.getModelIntersection();if(o&&o.face){this.engine.commandBinder.issueCommand(new p.X(g.b.XHAIR)),i.setCanPlace(!0);const t=((e,t,i)=>{var n;return null!==(n=t.floorIdFromObject(i.object))&&void 0!==n?n:e.getClosestFloorAtHeight(i.point.y).id})(this.floorsData,this.meshQuery,o);if(null===t)return!1;const s=this.meshQuery.mdsRoomIdFromObject(o.object);e.copy(a.stemNormal).setLength(a.stemLength),this.updateMeshPreviewSphere(!0,a.anchorPosition);const r={anchorPosition:a.anchorPosition.copy(o.point),stemNormal:a.stemNormal.copy(o.face.normal).normalize(),floorId:t,roomId:s};return this.pinsModule.updatePin(a.id,a.pinType,r),n===j.ce.CREATING&&i.setPinEditorState(j.ce.PLACING),!0}return this.engine.commandBinder.issueCommand(new p.X(g.b.NOPE)),i.setCanPlace(!1),!1}})(),this.allowExternalBehaviors=async e=>{e||this.externalBehaviorsBlocked?e&&this.externalBehaviorsBlocked&&(this.dragInterceptor.cancel(),this.engine.commandBinder.issueCommand(new X.sD),this.engine.commandBinder.issueCommand(new R.RK),this.externalBehaviorsBlocked=!1):(this.dragInterceptor.renew(),this.engine.commandBinder.issueCommand(new X.Jq),this.engine.commandBinder.issueCommand(new R.WH),this.externalBehaviorsBlocked=!0)},this.getModelIntersection=()=>this.fatcaster.cast(.05,(e=>!!(0,C.aV)(e)&&(!this.viewmodeData.isDollhouse()&&!this.viewmodeData.isFloorplan()||this.floorsViewData.isCurrentMeshGroupOrAllFloors(e.meshGroup))),T.X.Filter.CENTER_GROUP(.05)),this.onPointerButton=e=>{e.down||this.viewData.pinEditorState!==j.ce.PLACED||(this.allowExternalBehaviors(!0),this.cursorController.disableCursorMesh(!1))},this.onAnchorDragBegin=e=>{const{isPinEditable:t,pinEditorState:i,selectedPinId:n}=this.viewData,s=n?this.viewData.getPin(n):null;!s||e.buttons!==I.O.PRIMARY||i!==j.ce.PLACED&&i!==j.ce.IDLE||(t?(this.movingPin=!0,this.startingPinData=this.copyPinData(s),this.allowExternalBehaviors(!1),this.draggingHandlers.renew(),this.engine.commandBinder.issueCommand(new p.X(g.b.GRABBING)),this.cursorController.disableCursorMesh(!0),this.engine.commandBinder.issueCommand(new R.WH),this.inAnchorClick=!0):this.log.debug("onAnchorSelect called on a non-editable pin"))},this.doneMovingPin=()=>{this.viewData.selectedPinId&&this.movingPin&&(this.draggingHandlers.cancel(),this.engine.commandBinder.issueCommand(new p.X(null)),this.cursorController.disableCursorMesh(!1),this.engine.commandBinder.issueCommand(new R.RK),this.movingPin=!1,this.startingPinData=void 0,this.allowExternalBehaviors(!0),this.updateMeshPreviewSphere(!1))},this.onClickElsewhere=e=>{const{selectedPinId:t,pinEditorState:i}=this.viewData;if(!(i===j.ce.CREATING&&t||this.inAnchorClick))return t&&(this.movingPin?this.doneMovingPin():this.pinsModule.clickOffPin()),!0},this.onLongPressStart=async e=>{if(e.buttons!==I.O.PRIMARY)return;const t=this.viewData;t.pinEditorState===j.ce.CREATING&&(t.setProgress(0),t.setPinEditorState(j.ce.PRESSING),this.allowExternalBehaviors(!1),this.saveScreenPosition(e.position.x,e.position.y))},this.onLongPressProgress=e=>{const{viewData:t}=this;t.pinEditorState===j.ce.PRESSING&&t.setProgress(e.progress)},this.onLongPressSuccess=async e=>{const{viewData:t}=this;t.setPinEditorState(j.ce.PLACING);await this.positionPin(e)||(t.setPinEditorState(j.ce.CREATING),t.setCanPlace(!1))},this.onLongPressEnd=()=>{const e=this.viewData.pinEditorState;e===j.ce.PRESSING?(this.log.debug("Did not press long enough"),this.endPinCreation()):e===j.ce.PLACING&&this.placePin()},this.onPointerEvent=e=>{const t=this.viewData.pinEditorState;t!==j.ce.PLACING&&t!==j.ce.CREATING||this.positionPin(e)},this.onClickToPlacePin=()=>{this.placePin()},this.onKeyEvent=e=>{if(e.state===L.$.PRESSED&&e.key===V.D.ESCAPE)this.viewData.creatingNewPin&&this.engine.broadcast(new $.fD)},Promise.all([t.market.waitForData(W.M),t.market.waitForData(Y.q),t.market.waitForData(q.X),t.market.waitForData(u.X),t.getModuleBySymbol(d.yR),t.getModuleBySymbol(d.PM)]).then((([t,n,s,a,o,r])=>{this.cameraData=t,this.floorsData=n,this.floorsViewData=s,this.viewmodeData=a,this.fatcaster=o,this.meshQuery=r,this.bindings.push(i.registerPriorityHandler(k.CD,B.R,this.stopEventPropagation),e.onSelectedPinChanged(this.onSelectedPinChanged)),this.selectedHandlers=new b.P(i.registerPriorityHandler(N.rX,E.r,this.onClickElsewhere),i.registerPriorityHandler(N.rX,A.W,this.onClickElsewhere)),this.selectedHandlers.cancel()}))}dispose(){var e,t,i,n,s;this.removePinAnchorMesh(),null===(e=this.dragInterceptor)||void 0===e||e.cancel(),null===(t=this.addingHandlers)||void 0===t||t.cancel(),null===(i=this.draggingHandlers)||void 0===i||i.cancel(),null===(n=this.selectedHandlers)||void 0===n||n.cancel(),null===(s=this.editableSelectedHandlers)||void 0===s||s.cancel(),this.bindings.forEach((e=>{e.cancel()}))}toggleEditing(e){e!==this.editEnabled&&(this.editEnabled=e,e?(this.handlersRegistered?this.creationHandlers.renew():this.registerHandlers(),this.updateAnchorMesh()):(this.inAnchorClick=!1,this.anchored=!1,this.movingPin=!1,this.creationHandlers.cancel(),this.allowExternalBehaviors(!0),this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1)),this.dragInterceptor.cancel(),this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.editableSelectedHandlers.cancel())}registerHandlers(){const e=this.input,t=this.viewData;this.creationHandlers=new b.P(t.onPinEditorStateChanged(this.onPinStateUpdated)),this.dragInterceptor=new b.P(e.registerPriorityHandler(x.jF,E.r,(()=>!0)),e.registerPriorityHandler(x.jF,A.W,(()=>!0))),this.draggingHandlers=new b.P(e.registerUnfilteredHandler(x.jF,this.onDragEvent),e.registerUnfilteredHandler(x._w,this.onDragEnd)),this.editableSelectedHandlers=new b.P(e.registerMeshHandler(x.SK,P.f.isType(z),this.onAnchorDragBegin)),this.touchDevice?this.addingHandlers=new b.P(e.registerHandler(k.CD,this.onPointerButton),e.registerUnfilteredHandler(M.OR,this.onLongPressStart),e.registerUnfilteredHandler(M.v0,this.onLongPressProgress),e.registerUnfilteredHandler(M.Zl,this.onLongPressSuccess),e.registerUnfilteredHandler(M.vp,this.onLongPressEnd)):this.addingHandlers=new b.P(e.registerHandler(O.k,this.onKeyEvent),e.registerHandler(k.CD,this.onPointerButton),e.registerUnfilteredHandler(N.rX,this.onClickToPlacePin),e.registerHandler(k.$3,this.onPointerEvent))}removePinAnchorMesh(){this.pinRenderer.hideAnchorMesh(),this.anchored=!1}copyPinData(e){return{anchorPosition:e.anchorPosition.clone(),stemNormal:e.stemNormal.clone(),floorId:e.floorId,roomId:e.roomId,layerId:e.layerId,stemLength:e.stemLength,stemEnabled:e.stemEnabled,color:e.color}}saveScreenPosition(e,t){this.ndcPoint.set(e,t,0);const i=(0,D.zH)(this.cameraData.width,this.cameraData.height,this.ndcPoint);this.viewData.setScreenPosition(i)}}var J=i(64208),Z=i(3249),ee=i(33007),te=i(81662),ie=i(81544),ne=i(76191),se=i(99276),ae=i(94814),oe=i(17340),re=i(32408);class de extends n.Mesh{constructor(e,t,i){super(new n.PlaneGeometry(_.A.selection.size,_.A.selection.size),new oe.Kg(t.texture)),this.iconAtlas=t,this.iconEnabled=i,this.visible=!1,this.layers.mask=e.mask,this.renderOrder=F.X.pinSelectedHalo}setPinView(e){const{uniforms:t}=this.material;if(e){const i=(0,re.RN)(e.pinType,e.icon,this.iconEnabled),n=this.iconAtlas.uvRects.get(i);t.maskRect.value.set((null==n?void 0:n.minU)||0,(null==n?void 0:n.minV)||0,(null==n?void 0:n.maxU)||0,(null==n?void 0:n.maxV)||0),t.strokeWidth.value=(0,re.m1)(e.pinType)}else t.maskRect.value.setScalar(0)}setHaloWidth(e){this.material.uniforms.haloWidth.value=e}}var le=i(47213);class ce{constructor(e,t,i=1){this.atlasMaxSize=e,this.iconSize=t,this.padding=i,this.uvRects=new Map,this.iconCount=0,this.onResize=new le.y;const s=this.canvas=document.createElement("canvas");s.width=e,s.height=t,this.texture=new n.CanvasTexture(s),this.texture.colorSpace=n.SRGBColorSpace}addIcon(e,t){var i,n;const{atlasMaxSize:s,iconSize:a,padding:o,canvas:r,uvRects:d}=this,l=r.getContext("2d");let c=!1,h=d.get(e);if(!h){const t=this.iconCount++,i=s/a,n=Math.floor(t/i),o=t%i;if((n+1)*a>r.height){const e=l.getImageData(0,0,r.width,r.height);r.height*=2,l.putImageData(e,0,r.height/2),this.texture.dispose(),d.forEach((e=>{e.minV/=2,e.maxV/=2})),c=!0}h={minU:o/i,minV:n/(r.height/a),maxU:(o+1)/i,maxV:(n+1)/(r.height/a)},d.set(e,h)}const u=h.minU*s,m=(1-h.maxV)*r.height;return l.clearRect(u,m,a,a),"font"===t.type?(l.font=`${a-2*o}px ${t.family}`,l.textAlign="center",l.textBaseline="top",l.fillStyle="#fff",l.fillText(String.fromCodePoint(t.codePoint),u+a/2+((null===(i=t.offset)||void 0===i?void 0:i.x)||0),m+o+((null===(n=t.offset)||void 0===n?void 0:n.y)||0))):l.drawImage(t.image,u+o,m+o,a-2*o,a-2*o),this.texture.needsUpdate=!0,c&&this.onResize.notify(),h}}var he=i(28511);class ue{constructor(e,t,i,s,a,o,r,d=!1,l,c,h){this.input=e,this.cameraData=t,this.viewports=i,this.layer=s,this.commandBinder=a,this.raycaster=o,this.cursorController=r,this.iconsEnabled=d,this.getRootContainer=l,this.getSourceFromLayerId=c,this.floorsViewData=h,this.pinContainers=new Map,this.controlContainer=new n.Object3D,this.floorIdToContainer=new Map,this.hexColorToColor=new Map,this.bindings=[],this.anchor=null,this.selected=null,this.haloEasing=(0,ae.v)(.5,.52,0,1.98),this.pinViews=new Map,this.pinsWithOverrideTexture=new Set,this.refreshPins=()=>{this.pinViews.forEach(((e,t)=>{this.updatePin(t,e.pinType,e,e.backgroundTexture)}))},this.overrideIsFloorHidden=null,this.updateAnchorPosition=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3;return n=>{const s=this.anchorMesh;if(!s)return;const a=this.raycaster.picking;e.copy(n.stemNormal).normalize(),t.copy(e).multiplyScalar(.2).add(n.anchorPosition),i.copy(e).multiplyScalar(-1);const o=a.pick(t,i,(e=>e instanceof se.B));if(o){const e=Math.min(.2,o.distance);s.position.copy(t).add(i.multiplyScalar(.999*e))}else s.position.copy(t).add(i.multiplyScalar(.999*n.stemLength));s.lookAt(t)}})(),this.onAnchorHover=()=>{this.commandBinder.issueCommand(new p.X(g.b.GRAB)),this.cursorController.disableCursorMesh(!0)},this.onAnchorUnhover=()=>{this.commandBinder.issueCommand(new p.X(null)),this.cursorController.disableCursorMesh(!1)},this.iconAtlas=new ce(4096,128,4),this.iconAtlas.onResize.observe({notify:this.refreshPins})}init(){this.selectedMesh=new de(this.layer,this.iconAtlas,this.iconsEnabled),this.selectedMesh.name="Selected Mesh",this.selectedMesh.matrixAutoUpdate=!1,this.controlContainer.name="PinControlsContainer",this.controlContainer.layers.mask=this.layer.mask,this.controlContainer.add(this.selectedMesh),this.anchorMesh=new z(this.layer),this.anchorMesh.name="Anchor Mesh",this.controlContainer.add(this.anchorMesh);for(const e of Object.values(j.tf))this.iconAtlas.addIcon(e,{type:"font",family:"mp-font",codePoint:+he.J[e],offset:(0,re.hs)(e)})}dispose(){this.controlContainer.removeFromParent();for(const e of this.pinContainers.values())e.removeFromParent();for(const e of[this.anchorMesh,this.selectedMesh])e&&e.parent&&e.parent.remove(e)}activate(e){this.bindings.length>0||this.bindings.push(this.input.registerMeshHandler(ie.L,P.f.isType(z),this.onAnchorHover),this.input.registerMeshHandler(ie.q,P.f.isType(z),this.onAnchorUnhover))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}render(e){}beforeRenderViewport(e){if(this.viewports.renderingViewport){if(this.floorIdToContainer.forEach(((e,t)=>{if(this.overrideIsFloorHidden)e.visible=!this.overrideIsFloorHidden(t);else{this.getSourceFromLayerId(e.userData.rootId)===this.floorsViewData.sourceViewId&&(e.visible=!this.floorsViewData.isHidden(t))}})),this.selected){const{animation:e,hideWhenDoneAnimating:t}=this.selected,i=this.selectedMesh;i&&i.visible&&e&&(t&&!e.isAnimating?(i.visible=!1,this.selected=null):(i.matrix.copy(this.pinHeadTransform(this.selected.id)),i.setHaloWidth(e.getUpdatedValue())))}if(this.anchorMesh&&this.anchorMesh.visible){const e=this.getViewportScale(this.cameraData);this.anchorMesh.update(this.viewports.renderingViewport.camera,e,this.cameraData)}}}updatePin(e,t,i,n,s){this.anchorMesh&&this.anchorMesh.visible&&this.anchor&&this.anchor.pinType===t&&this.anchor.id===e&&this.updateAnchorPosition(i),this.pinViews.set(e,Object.assign(Object.assign({},i),{id:e,pinType:t,backgroundTexture:n}))}removePin(e){this.selected&&this.selected.id===e&&this.clearSelected(),this.pinViews.delete(e)}removePinsByType(e){this.removePinsByPredicate((t=>t===e))}removePinsByPredicate(e){}setPinVisible(e,t){}setPinColorVariant(e,t){}setPinColorVariants(e,t){}setPinColorVariantByType(e,t,i){}setPinOpacity(e,t){}setPinOpacityByType(e,t,i){}fadePinOpacity(e,t){}fadePinOpacityByType(e,t,i=[]){}setPinRenderOverrides(e,t,i){t?(this.pinsWithOverrideTexture.add(e),this.selected&&this.selected.id===e&&this.clearSelected()):this.pinsWithOverrideTexture.delete(e)}overrideFloorsHidden(e){this.overrideIsFloorHidden=e}setPinTypeVisible(e,t){this.floorIdToContainer.forEach((i=>{i.userData.typeContainers[e].visible=t}))}showAnchorMesh(e,t,i){this.anchor={pinType:e,id:t},this.anchorMesh&&!this.anchorMesh.visible&&(this.anchorMesh.visible=!0,this.input.registerMesh(this.anchorMesh,!1)),this.updateAnchorPosition(i)}hideAnchorMesh(){this.anchorMesh&&this.anchorMesh.visible&&(this.anchorMesh.visible=!1,this.input.unregisterMesh(this.anchorMesh))}showSelectedMesh(e,t,i){const n=this.selected&&this.selected.pinType===e&&this.selected.id===t;this.selected&&n||this.pinsWithOverrideTexture.has(t)||(this.selected={pinType:e,id:t,hideWhenDoneAnimating:!1,animation:new ne.A({startValue:0,endValue:_.A.selection.haloWidth,duration:_.A.selection.haloAnimDuration,easingFunction:this.haloEasing})},this.selectedMesh.removeFromParent(),this.getRootContainer(i).add(this.selectedMesh),this.selectedMesh.visible=!0,this.selectedMesh.setPinView(this.pinViews.get(t)||null))}hideSelectedMesh(){this.selected&&(this.selected.animation=new ne.A({startValue:_.A.selection.haloWidth,endValue:0,duration:_.A.selection.haloAnimDuration}),this.selected.hideWhenDoneAnimating=!0)}getFloorContainer(e,t){let i=this.floorIdToContainer.get(t);if(i)return i;i=new n.Object3D,i.name="Floor "+t,i.userData.typeContainers={},i.layers.mask=this.layer.mask;for(const e of Object.values(j.yY)){const t=new n.Object3D;t.name=e,t.layers.mask=this.layer.mask,i.add(t),i.userData.typeContainers[e]=t}return this.container(e).add(i),this.floorIdToContainer.set(t,i),i.userData.floorId=t,i.userData.rootId=e,i}getColor(e){let t=this.hexColorToColor.get(e);if(t)return t;const i=new n.Color(e),s={h:0,s:0,l:0};i.getHSL(s);return t={baseColor:i,hoverColor:(new n.Color).setHSL(s.h,s.s,.8*s.l),dimmedColor:(new n.Color).setHSL(s.h,.5*s.s,s.l)},this.hexColorToColor.set(e,t),t}getViewportScale(e){return Math.sqrt(Math.min(e.width,e.height)/_.A.pinHeadMesh.scale.baseViewportSize)}clearSelected(){this.selectedMesh.visible=!1,this.selected=null}container(e){let t=this.pinContainers.get(e);return t||(t=new n.Object3D,t.name="PinContainer",t.layers.mask=this.layer.mask,this.pinContainers.set(e,t),this.getRootContainer(e).add(t)),t}setVisible(e){this.controlContainer.visible=e,this.pinContainers.forEach((t=>{t.visible=e}))}}var me=i(51274),pe=i(73237);const ge=new oe.Zo,ve=new r.Vy("InstancedPinHeads");class fe extends n.InstancedMesh{constructor(e){const t=new n.BufferGeometry,i=new Float32Array(6);i[0]=i[1]=i[2]=0,i[3]=1,i[4]=1,i[5]=1,t.setAttribute("position",new n.BufferAttribute(i,3));const s=new Float32Array(3*e),a=new n.InstancedBufferAttribute(s,3);t.setAttribute("stemVector",a);const o=new Float32Array(e),r=new n.InstancedBufferAttribute(o,1);t.setAttribute("instanceAlpha",r);const d=[],l=[];for(let i=0;i<4;i++){const s=new Float32Array(4*e),a=new n.InstancedBufferAttribute(s,4);t.setAttribute(`pinHeadMatrixCol${i}`,a),d.push(s),l.push(a)}super(t,ge,e),this.maxCount=e,this.stemVectorArray=s,this.stemVectorAttrib=a,this.pinHeadMatrixArray=d,this.pinHeadMatrixAttrib=l,this.opacityArray=o,this.opacityAttrib=r,this.renderOrder=F.X.lines,this.posMatrix=new n.Matrix4,this.onBeforeRender=(e,t,i)=>{(0,pe.QG)(this.material,e,i,!0)},this.isLine=!0,this.isMesh=!1}setDepthTex(e){this.material.setFadeDepthTexture(e)}update(e,t){let i=0;for(const t of e){if(!t.visible||!t.stemEnabled||t.stemLength<.001)continue;if(i>=this.maxCount){ve.error("Instance count is too small!");continue}this.posMatrix.setPosition(t.anchorPosition),this.setMatrixAt(i,this.posMatrix),this.opacityArray[i]=t.opacity*t.opacityAnimation.value*t.opacityScale;const e=3*i;t.pinHeadObjPosition.toArray(this.stemVectorArray,e);let n=0;for(let e=0;e<4;e++)for(let s=0;s<4;s++)this.pinHeadMatrixArray[e][s+4*i]=t.pinHeadMatrix.elements[n++];i++}this.count=i,this.visible=this.count>0,this.instanceMatrix.needsUpdate=!0,this.stemVectorAttrib.needsUpdate=!0;for(const e of this.pinHeadMatrixAttrib)e.needsUpdate=!0;this.opacityAttrib.needsUpdate=!0,ge.uniforms.resolution.value.set(t.width,t.height),ge.uniformsNeedUpdate=!0,this.computeBoundingSphere()}}var ye=i(92237);const we=new r.Vy("InstancedPinRenderer");class be extends ue{constructor(e,t,i,s,a,o,r,d,l,c,h,u,m){super(e,t,i,s,a,o,d,l,h,u,m),this.depthTextures=c,this.pins=new Map,this.idToPin=new Map,this.keyToRenderObjs=new Map,this.updatePinHeadMatrix=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3,s=new n.Vector3,a=new n.Vector3,o=new n.Vector3,r=new n.Vector3;return n=>{const d=_.A.pinHeadMesh.scale,l=this.getViewportScale(this.cameraData),c=1+d.responsiveness/100*(l-1);if(!this.viewports.renderingViewport)throw new Error("No rendering viewport set");const h=this.viewports.renderingViewport.camera;h.getWorldPosition(o);const u=h.quaternion;for(const l of n){r.copy(l.pinHeadObjPosition).add(l.anchorPosition);const n=o.distanceTo(r),m=d.maxSize-(d.maxSize-d.minSize)*(0,J.T)(n,d.nearBound,d.farBound);t.copy(r).project(h),i.set(this.cameraData.width/2,this.cameraData.height/2,1).multiply(t),s.set(m/2,0,0).add(i),a.set(2/this.cameraData.width,2/this.cameraData.height,1).multiply(s);const p=a.unproject(h).distanceTo(r)*c,g=(0,Z.qE)(p,ee.A.epsilon,p),v=l.geomScale||te.B1.UNIT;e.set(g*v.x,g*v.y,g*v.z),l.pinHeadMatrix.compose(r,u,e)}}})(),this.inputCallbacks=r}dispose(){super.dispose()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(N.rX,me.k,((e,t,i)=>{if(!i||void 0===i.instanceId)return!0;const n=t.renderedPins[i.instanceId];return this.inputCallbacks.onClick(n.id,n.pinType),!0}))),this.setupSplatDepthTexBinding(),(0,o.C8)()||(this.bindings.push(this.input.registerMeshHandler(ie.L,P.f.isType(me.k),((e,t,i)=>{if(!i||void 0===i.instanceId)return;const n=t.renderedPins[i.instanceId];this.lastHoverId=n.id,this.lastHoverType=n.pinType,this.inputCallbacks.onHover(n.id,n.pinType)}))),this.bindings.push(this.input.registerMeshHandler(ie.q,P.f.isType(me.k),(()=>{this.inputCallbacks.onUnhover(this.lastHoverId,this.lastHoverType)})))))}beforeRenderViewport(e){var t,i,n,s;for(const a of this.pins.values()){const o=Array.from(a.values());if(0===o.length)continue;const r=this.keyFromPin(o[0]),d=this.keyToRenderObjs.get(r);if(!d){we.error("Expecting renderObjs for this key.",this.keyToRenderObjs,this.keyFromPin(o[0]));continue}let{lines:l,pinHeads:c}=d;if(o.forEach((t=>t.opacityAnimation.tick(e))),this.updatePinHeadMatrix(o),l.maxCount<o.length){const e=l.parent;if(!e){we.error("Expecting a parent.");continue}e.remove(l),l.dispose(),e.remove(c),this.input.unregisterMesh(c);const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=o[0];c.dispose(),Object.assign(d,this.createInstances(e,d.id,o.length+16,t,i,n)),l=d.lines,c=d.pinHeads}l.update(o,this.cameraData),(null===(t=o[0].maskTexture)||void 0===t?void 0:t.uuid)&&(null===(s=null===(n=null===(i=c.material.uniforms)||void 0===i?void 0:i.mask)||void 0===n?void 0:n.value)||void 0===s?void 0:s.uuid)&&o[0].maskTexture.uuid!==c.material.uniforms.mask.value.uuid&&c.updateMaskTexture(o[0].maskTexture),c.update(o)}super.beforeRenderViewport(e)}updatePin(e,t,i,s,a){var o;super.updatePin(e,t,i,s,a);let r=this.idToPin.get(e);const d=i.floorId,l=this.getColor(i.color).baseColor,c=`${d}_${t}_${(null===(o=null==r?void 0:r.overrideTexture)||void 0===o?void 0:o.uuid)||s.uuid}`,h=(0,re.RN)(t,i.icon,this.iconsEnabled);let u=this.iconAtlas.uvRects.get(h);u||(u=this.iconAtlas.addIcon(h,{type:"font",family:"mp-font",codePoint:+he.J[h],offset:(0,re.hs)(h)}));const m=(0,re.m1)(t);if(!r){r=Object.assign(Object.assign({id:e},i),{visible:!0,opacity:1,opacityScale:1,pinType:t,opacityAnimation:new ye.z(0),backgroundTexture:s,maskTexture:this.iconAtlas.texture,pinHeadMatrix:new n.Matrix4,pinHeadObjPosition:new n.Vector3,pinColor:l,colorVariant:j.ob.DEFAULT,overrideTexture:null,geomScale:null,pinIconUVRect:u,pinStrokeWidth:m,needsEntryAnimation:!0}),this.idToPin.set(e,r);let a=this.pins.get(c);a||(a=new Map,this.pins.set(c,a)),a.set(e,r),this.createRenderObjsForPin(r)}const p=this.keyFromPin(r);Object.assign(r,i,{pinType:t,textureId:s.uuid,maskTexture:this.iconAtlas.texture}),this.changePinHeadGroupIfNeeded(p,c,r),r.pinHeadObjPosition.copy(r.stemNormal).setLength(r.stemLength),r.pinColor=(0,re.nK)(this.getColor(r.color),r.colorVariant),r.pinIconUVRect=u,r.pinStrokeWidth=m,void 0!==a&&this.setPinVisible(e,a),u&&r.needsEntryAnimation&&(r.opacityAnimation.modifyAnimation(r.opacityAnimation.value,1,500,ae.lu),r.opacityAnimation.onComplete((()=>{r&&(r.needsEntryAnimation=!1)})))}removePin(e){super.removePin(e);const t=this.idToPin.get(e);if(!t)return;this.idToPin.delete(e);const i=this.keyFromPin(t),n=this.pins.get(i);n&&(n.delete(e),this.cleanupRenderObjIfNeeded(i))}removePinsByPredicate(e){this.idToPin.forEach(((t,i)=>{e(t.pinType)&&this.removePin(i)}))}setPinVisible(e,t){const i=this.idToPin.get(e);i?i.visible=t:we.error("setPinVisible on a pin that doesn't exist.",e)}setPinColorVariant(e,t){const i=this.idToPin.get(e);i?(i.colorVariant=t,i.pinColor=(0,re.nK)(this.getColor(i.color),t)):we.error("setPinColorVariant on a pin that doesn't exist.")}setPinColorVariants(e,t){this.idToPin.forEach(((i,n)=>{n!==t&&this.setPinColorVariant(n,e)}))}setPinColorVariantByType(e,t,i){this.idToPin.forEach(((n,s)=>{n.pinType===e&&s!==i&&this.setPinColorVariant(s,t)}))}setPinOpacity(e,t){const i=this.idToPin.get(e);i?i.opacity=t:we.error("setPinOpacity on a pin that doesn't exist.")}setPinOpacityScale(e,t){const i=this.idToPin.get(e);i?i.opacityScale=t:we.error("setPinOpacityScale on a pin that doesn't exist.")}fadePinOpacity(e,t){const i=this.idToPin.get(e);i?(t>0&&this.setPinVisible(e,!0),i.opacityAnimation.modifyAnimation(i.opacityAnimation.value,t,300).onComplete((()=>{i.opacityAnimation.endValue<=0&&this.setPinVisible(e,!1)}))):we.error("setPinVisible on a pin that doesn't exist.",e)}setPinOpacityByType(e,t,i){this.idToPin.forEach(((n,s)=>{n.pinType===e&&s!==i&&this.setPinOpacity(s,t)}))}fadePinOpacityByType(e,t,i=[]){this.idToPin.forEach(((n,s)=>{n.pinType!==e||i.includes(s)||this.fadePinOpacity(s,t)}))}setPinRenderOverrides(e,t,i){super.setPinRenderOverrides(e,t,i);const n=this.idToPin.get(e);if(!n)return void we.error("setPinRenderOverrides on a pin that doesn't exist.");const s=this.keyFromPin(n);if(!this.keyToRenderObjs.get(s))return void we.error("Expecting renderObjs while setting override material");n.overrideTexture=t,n.geomScale=i;const a=this.keyFromPin(n);this.changePinHeadGroupIfNeeded(s,a,n)}pinHeadTransform(e){const t=this.idToPin.get(e);return t?t.pinHeadMatrix:(we.error("pinHeadTransform on a pin that doesn't exist."),new n.Matrix4)}keyFromPin(e){return`${e.floorId}_${e.pinType}_${e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid}`}createRenderObjsForPin(e){const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=e,s=this.keyFromPin(e);if(this.keyToRenderObjs.get(s))return;const a=this.getFloorContainer(e.layerId,e.floorId).userData.typeContainers[e.pinType];a.userData||(a.userData={});const o=e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid;if(!a.userData[o]){const e=this.createInstances(a,o,16,t,i,n);a.userData[o]=e,this.keyToRenderObjs.set(s,e)}}createInstances(e,t,i,n,s,a){const o=new fe(i);o.layers.mask=this.layer.mask,e.add(o);const r=new me.k(i,a||n,a?null:s,!a);return r.layers.mask=this.layer.mask,e.add(r),this.input.registerMesh(r,!1),r.setDepthTex(this.depthTextures.getDepthTexture("splat")),o.setDepthTex(this.depthTextures.getDepthTexture("splat")),{lines:o,pinHeads:r,id:t}}changePinHeadGroupIfNeeded(e,t,i){if(e!==t){let n=this.pins.get(t);n||(n=new Map,this.pins.set(t,n)),n.set(i.id,i),this.createRenderObjsForPin(i);const s=this.pins.get(e);s&&(null==s||s.delete(i.id),this.cleanupRenderObjIfNeeded(e))}}cleanupRenderObjIfNeeded(e){const t=this.pins.get(e),i=this.keyToRenderObjs.get(e);if(t&&0===t.size&&i){const t=i.lines.parent;if(this.input.unregisterMesh(i.pinHeads),this.pins.delete(e),this.keyToRenderObjs.delete(e),!t)return void we.error("Expecting pinTypeObj!");t.userData[i.id]=void 0,t.remove(i.lines),t.remove(i.pinHeads)}}updateDepthTexture(){const e=this.depthTextures.getDepthTexture("splat");for(const t of this.keyToRenderObjs.values())t.pinHeads.setDepthTex(e),t.lines.setDepthTex(e)}setupSplatDepthTexBinding(){this.updateDepthTexture(),this.bindings.push(this.depthTextures.onDepthTextureChanged("splat",(()=>this.updateDepthTexture())))}}var Te=i(47737);class De extends s.n{constructor(){super(...arguments),this.name="pins",this.editActivated=!1,this.editBindings=[],this.touchDevice=(0,o.C8)(),this.worldPosition=new n.Vector3,this.visibilityChanged=()=>{const e=!this.in360View(),t=!this.interactionmodeData.isVR();this.pinRenderer.setVisible(e&&t);const{floorsViewData:i}=this,n=this.viewmode===m.N.Dollhouse||this.viewmode===m.N.Floorplan,s=i.transition.progress.active?()=>!0:null;this.pinRenderer.overrideFloorsHidden(n?s:()=>!1)},this.viewmodeChanged=e=>{this.viewmode=e.toMode,this.visibilityChanged()},this.updateCurrentPin=()=>{const{pinEditorState:e,focusedPin:t,selectedPinId:i}=this.viewData;if(e!==j.ce.CREATING){const e=i?this.viewData.getPin(i):null,n=t||e;if(this.pinEditor.updateAnchorMesh(),n){const{id:e,pinType:t,backgroundTexture:i}=n;this.pinRenderer.updatePin(e,t,n,i),this.pinRenderer.setPinColorVariant(e,j.ob.HIGHLIGHTED),this.pinRenderer.setPinColorVariants(j.ob.DEFAULT,e)}else this.pinRenderer.setPinColorVariants(j.ob.DEFAULT)}},this.saveScreenPosition=e=>{const t=this.viewportManager,i=this.viewportManager.viewportIdForLayerId(e.layerId),n=this.cameraModule.getCameraDataForViewport(i),s=this.viewData,a=e.stemNormal.clone().normalize();this.worldPosition.copy(e.anchorPosition).addScaledVector(a,e.stemLength);const o=n.pose,r=t.worldToScreenPosition(o.position,o.rotation,o.projection.asThreeMatrix4(),this.worldPosition,i),d=r.ndcPosition.z>1||Math.abs(r.ndcPosition.x)>1||Math.abs(r.ndcPosition.y)>1;s.setScreenPosition(d?null:r.screenPosition)},this.onCameraUpdate=()=>{const{creatingNewPin:e,focusedPin:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;!e&&t?this.saveScreenPosition(t):n&&this.saveScreenPosition(n)},this.handleSweepChange=()=>this.handleSweepAndViewModeChange(),this.handleViewModeChange=()=>this.handleSweepAndViewModeChange(),this.cancelPinCreation=()=>{const{creatingNewPin:e,selectedPinId:t}=this.viewData;if(this.changeSelectedPin(null),t){const i=t?this.viewData.getPin(t):null;e&&i&&(this.engine.broadcast(new $.lY(i.id,i.pinType)),this.removePin(i.id,i.pinType),this.pinEditor.endPinCreation())}this.resetEditingState()},this.onPinPlacementCancelled=()=>{this.cancelPinCreation()},this.onViewChange=e=>{this.cancelPinCreation()},this.onPinClicked=e=>{const{pinType:t,id:i}=e,{creatingNewPin:n,selectedPinId:s}=this.viewData,a=s?this.viewData.getPin(s):null,o=i===(null==a?void 0:a.id)&&t===(null==a?void 0:a.pinType);if(a&&o){if(n)return;this.changeSelectedPin(null)}else if(n)this.cancelPinCreation();else{if(!(i===(null==a?void 0:a.id)&&t===(null==a?void 0:a.pinType))){const e=this.viewData.getPin(i);e&&this.changeSelectedPin(e)}}},this.onHoverChanged=e=>{const{pinType:t,id:i,hovering:n}=e,{creatingNewPin:s,focusedPin:a,selectedPinId:o}=this.viewData;if(!s)if(n){const e=this.viewData.getPin(i);if(!e)return void r.Vy.for(this).debug("Cannot find pin to focus");const n=o?this.viewData.getPin(o):null;if(this.viewData.setFocusedPin(e),n&&n.id===i&&n.pinType===t)return;this.saveScreenPosition(e),this.pinRenderer.setPinColorVariantByType(t,j.ob.DEFAULT,null==a?void 0:a.id),this.pinRenderer.setPinColorVariant(i,j.ob.HIGHLIGHTED)}else a&&(this.pinRenderer.setPinColorVariant(a.id,j.ob.DEFAULT),this.viewData.setFocusedPin(null))}}async init(e,t){this.engine=t;const[i,n,s,o,r,m,b,T,D]=await Promise.all([t.getModuleBySymbol(d.mL),t.getModuleBySymbol(d.M7),t.market.waitForData(a.zH),t.getModuleBySymbol(d.sA),t.market.waitForData(Te.P),t.getModuleBySymbol(d._v),t.getModuleBySymbol(d.Qm),t.getModuleBySymbol(d.jh),t.getModuleBySymbol(d.QW),document.fonts.ready]);this.input=i,this.viewportManager=b.viewportManager,this.cameraModule=T,this.floorsViewData=D.floorsViewData;const S={onClick:(e,i)=>{t.broadcast(new $.oX(e,i))},onHover:(e,i)=>{t.broadcast(new $.RG(e,!0,i)),t.commandBinder.issueCommand(new p.X(g.b.FINGER)),m.disableCursorMesh(!0)},onUnhover(e,i){t.broadcast(new $.RG(e,!1,i)),t.commandBinder.issueCommand(new p.X(null)),m.disableCursorMesh(!1)}},C=t.claimRenderLayer(this.name);this.pinRenderer=new be(i,T.cameraData,b.viewportManager,C,t.commandBinder,o,S,m,e.tagIconsEnabled,n.getDepthTextures(),(e=>n.getScene().getSubTree([e||l.j])),(e=>{var t;return null===(t=r.findLayer(e))||void 0===t?void 0:t.sourceViewId}),this.floorsViewData),n.getScene().add(this.pinRenderer.controlContainer),t.addComponent(this,this.pinRenderer),[this.viewmodeData,this.interactionmodeData,this.sweepData]=await Promise.all([t.market.waitForData(u.X),t.market.waitForData(c.O),t.market.waitForData(h.A)]),this.viewData=new w.U,this.pinEditor=new Q(this.viewData,this.engine,this.input,this.pinRenderer,m,this),this.viewmode=this.viewmodeData.currentMode,this.bindings.push(this.interactionmodeData.onChanged(this.visibilityChanged),this.floorsViewData.onChanged(this.visibilityChanged),this.viewmodeData.makeModeChangeSubscription(this.visibilityChanged),t.subscribe(v.A,this.visibilityChanged),t.subscribe(y.Y,this.viewmodeChanged),t.subscribe(f.A,this.viewmodeChanged),t.subscribe($.oX,this.onPinClicked),this.viewData.onPinEditorStateChanged(this.updateCurrentPin),this.viewData.onSelectedPinChanged(this.updateCurrentPin),this.viewData.onFocusedPinChanged(this.updateCurrentPin),this.viewData.onPinEditableChanged(this.updateCurrentPin),this.cameraModule.cameraData.onChanged(this.onCameraUpdate),r.onPropertyChanged("currentViewId",this.onViewChange)),this.touchDevice||this.bindings.push(t.subscribe($.RG,this.onHoverChanged));let E=s.application;this.bindings.push(s.onPropertyChanged("application",(e=>{e!==E&&(this.visibilityChanged(),this.viewData.creatingNewPin?this.cancelPinCreation():(this.changeSelectedPin(null),this.viewData.setFocusedPin(null),this.resetEditingState()),E=e)}))),this.visibilityChanged(),t.market.register(w.U,this.viewData)}setPinRenderOverrides(e,t,i){this.pinRenderer.setPinRenderOverrides(e,t,i)}dispose(e){this.disableEditing(),this.pinEditor.dispose(),this.pinRenderer.dispose(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.editBindings=[],super.dispose(e)}in360View(){const e=this.sweepData.state.currentSweep?this.sweepData.state.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}enablePinCreation(e){e?this.enableEditing():this.disableEditing()}enableEditing(){if(!this.editActivated){if(this.editActivated=!0,this.pinEditor.toggleEditing(!0),0===this.editBindings.length){const e=this.engine;this.editBindings.push(this.sweepData.makeSweepChangeSubscription(this.handleSweepChange),e.subscribe(f.A,this.handleViewModeChange),e.subscribe($.fD,this.onPinPlacementCancelled))}else this.editBindings.forEach((e=>{e.renew()}));this.handleSweepAndViewModeChange()}}disableEditing(){this.editActivated&&(this.editActivated=!1,this.pinEditor.toggleEditing(!1),this.cancelPinCreation(),this.editBindings.forEach((e=>{e.cancel()})))}assertEditingEnabled(){if(!this.editActivated)throw new Error("Pin editing must be enabled before calling this method")}changeSelectedPin(e){const{selectedPinId:t}=this.viewData;if(((null==e?void 0:e.id)||null)===t)return void r.Vy.for(this).debug("Pin selection did not change");(t?this.viewData.getPin(t):null)&&this.pinRenderer.hideSelectedMesh(),e?(this.saveScreenPosition(e),this.viewData.setSelectedPinId(e.id),this.pinRenderer.showSelectedMesh(e.pinType,e.id,e.layerId)):(this.viewData.setScreenPosition(null),this.viewData.setSelectedPinId(null))}updatePin(e,t,i){const n=this.viewData.getPin(e);if(n&&n.pinType===t){const{focusedPin:s,selectedPinId:a}=this.viewData,o=a?this.viewData.getPin(a):null,r=Object.assign(Object.assign({},n),i);this.viewData.updatePin(r),this.pinRenderer.updatePin(r.id,r.pinType,r,r.backgroundTexture),(null==o?void 0:o.id)===e&&(this.saveScreenPosition(r),this.updateCurrentPin()),(null==s?void 0:s.id)===e&&this.saveScreenPosition(r),this.engine.broadcast(new $.UW(e,t,i))}else r.Vy.for(this).debug(`Cannot update non-existent ${t} pin`)}updatePinViews(e){e.forEach((e=>{this.viewData.updatePin(e),this.pinRenderer.updatePin(e.id,e.pinType,e,e.backgroundTexture,e.visible),this.viewData.selectedPinId===e.id&&(this.viewData.updatePin(e),this.updateCurrentPin()),void 0!==e.opacity&&this.pinRenderer.setPinOpacity(e.id,e.opacity),void 0!==e.scale&&this.pinRenderer.setPinRenderOverrides(e.id,null,e.scale)})),this.visibilityChanged()}changePinVisibility(e,t,i){const n=this.viewData.getPin(e);if(n&&n.pinType===t){this.pinRenderer.setPinVisible(e,i);const{selectedPinId:t,focusedPin:n}=this.viewData;i||t!==e||this.changeSelectedPin(null),i||(null==n?void 0:n.id)!==e||this.viewData.setFocusedPin(null)}else r.Vy.for(this).debug(`Cannot change visibility of non-existent ${t} pin`)}changePinVisibilityByType(e,t){this.pinRenderer.setPinTypeVisible(e,t)}changePinOpacity(e,t,i){const n=this.viewData.getPin(e);n&&n.pinType===t?this.pinRenderer.setPinOpacity(e,i):r.Vy.for(this).debug(`Cannot change opacity of non-existent ${t} pin`)}changePinOpacityScale(e,t,i){const n=this.viewData.getPin(e);n&&n.pinType===t?this.pinRenderer.setPinOpacityScale(e,i):r.Vy.for(this).debug(`Cannot change opacity scaling of non-existent ${t} pin`)}changePinOpacityByType(e,t,i=[]){this.pinRenderer.fadePinOpacityByType(e,t,i)}clearPinSelection(){this.changeSelectedPin(null)}createPin(e,t,i,n){const s=this.viewData,a=Object.assign(Object.assign({id:e,pinType:i},t),{backgroundTexture:n});s.setEditablePin(!0),s.setPinEditorState(j.ce.CREATING),this.changeSelectedPin(a),this.pinEditor.startPinCreation()}handleSweepAndViewModeChange(){const e=this.viewData,t=!this.in360View();e.creatingNewPin&&!t?this.cancelPinCreation():e.setCanAdd(t)}resetEditingState(){const e=this.viewData;e.setPinEditorState(j.ce.IDLE),e.setEditablePin(!1),e.setCanPlace(!0),e.setCanAdd(!this.in360View())}cancelNewPin(e,t){this.assertEditingEnabled();const{selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;n&&n.id===e&&n.pinType===t?this.cancelPinCreation():r.Vy.for(this).debug(`Cannot cancel pin ${e} - does not match current creation state`)}removePin(e,t){const{focusedPin:i,selectedPinId:n}=this.viewData;n===e&&this.changeSelectedPin(null),(null==i?void 0:i.id)===e&&(null==i?void 0:i.pinType)===t&&this.viewData.setFocusedPin(null),this.viewData.removePin(e),this.pinRenderer.removePin(e)}removePinsByType(e){const{focusedPin:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;(null==n?void 0:n.pinType)===e&&this.changeSelectedPin(null),(null==t?void 0:t.pinType)===e&&this.viewData.setFocusedPin(null),this.viewData.removePinsByType(e),this.pinRenderer.removePinsByType(e)}togglePinEditing(e,t){this.viewData.getPin(e)&&this.viewData.setEditablePin(t)}selectPin(e,t,i){const n=this.viewData,{selectedPinId:s,isPinEditable:a}=n;if(n.setPinEditorState(j.ce.IDLE),e===s&&i===a)return void r.Vy.for(this).debug("Pin is already selected");const o=this.viewData.getPin(e);o&&o.pinType===t?(n.setEditablePin(i),this.changeSelectedPin(o)):r.Vy.for(this).debug(`Cannot select ${t} pin`)}unselectPin(e,t){const{selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;(null==n?void 0:n.pinType)===t&&(null==n?void 0:n.id)===e&&this.changeSelectedPin(null)}clickOffPin(){this.viewData.creatingNewPin||this.changeSelectedPin(null)}movePin(e,t,i){const{isPinEditable:n,selectedPinId:s}=this.viewData;if(!n)return;const a=s?this.viewData.getPin(s):null;if(a&&a.id===e){const e=Object.assign(Object.assign({},a),t);this.viewData.updatePin(e),this.updateCurrentPin(),this.engine.broadcast(new $.cC(a.id,a.pinType,t,i))}else r.Vy.for(this).debug("Cannot move the pin, not open for edit")}placePin(){this.assertEditingEnabled();const{isPinEditable:e,canPlace:t,selectedPinId:i}=this.viewData;if(!e)return;const n=i?this.viewData.getPin(i):null;n&&t?(this.viewData.setPinEditorState(j.ce.PLACED),this.engine.broadcast(new $.yi(n.id,n.pinType,n))):(r.Vy.for(this).debug("Cannot place pin because there is no open pin"),this.cancelPinCreation())}}const Se=De},41418:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n,s=i(64882),a=i(71687),o=i(12837),r=i(35898),d=i(4582),l=i(64713);!function(e){e.None="none",e.Queued="queued",e.Rendering="loading",e.Rendered="loaded"}(n||(n={}));class c{constructor(e){this.panoRenderer=e,this.statusMap={},this.active=[],this.queued=[]}processQueued(){let e=0;for(const t of Object.keys(this.statusMap))this.statusMap[t]===n.Rendering&&e++;if(0===e&&this.queued.length>0){const e=this.queued.shift();if(e){this.active.push(e),this.statusMap[e]=n.Rendering;this.panoRenderer.activateSweep(e,!1).then((()=>{this.statusMap[e]=n.Rendered}))}}}tryPreRender(e){return this.getPreRenderState(e)===n.None&&(this.queued.push(e),this.statusMap[e]=n.Queued,!0)}getPreRenderState(e){const t=this.statusMap[e];return void 0!==t?t:n.None}cleanup(e=[]){const t=(0,l.Z)(e),i=[];for(const e of this.queued)t[e]?i.push(e):this.statusMap[e]=n.None;this.queued.length=0,this.queued.push(...i);const s=[];for(const e of this.active)t[e]?s.push(e):this.statusMap[e]=n.None;this.active.length=0,this.active.push(...s)}}var h=i(25443);class u extends s.n{constructor(){super(...arguments),this.name="prerenderer-module",this.lastPrerendered=null}async init(e,t){[this.settings,this.sweepData]=await Promise.all([await t.market.waitForData(h.o),await t.market.waitForData(o.A)]),this.panoRenderer=(await t.getModuleBySymbol(a.qD)).getRenderer(),this.preRenderer=new c(this.panoRenderer),this.bindings.push(t.subscribe(r.A,(e=>this.onRestrictSweepsSet(e.sweepIds))),t.subscribe(d.A,(()=>this.onRestrictedSweepsClear())))}enabled(){return this.settings.getOverrideParam("pre",true)}onUpdate(){this.enabled()&&this.preRenderer.processQueued()}getCurrentSweeps(){return this.currentRestrictedSweeps||[]}onRestrictSweepsSet(e){this.enabled()&&(this.lastPrerendered=null,e&&e.length>=3&&(this.lastPrerendered=e[2],this.preRenderer.tryPreRender(this.lastPrerendered)),this.cleanup(this.sweepData),this.currentRestrictedSweeps=e)}onRestrictedSweepsClear(){this.enabled()&&(this.cleanup(this.sweepData,!0),this.currentRestrictedSweeps=null)}cleanup(e,t=!1){const i=[];e.state.transition.active?(e.state.transition.from&&i.push(e.state.transition.from),e.state.transition.to&&i.push(e.state.transition.to)):e.state.currentSweep&&i.push(e.state.currentSweep),this.lastPrerendered&&i.push(this.lastPrerendered),t&&this.panoRenderer.freeAllTextures(i),this.preRenderer.cleanup(i)}}},43036:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>f});var n=i(64882),s=i(80783),a=i(71687),o=i(79388),r=i(68909),d=i(53282),l=i(62802),c=i(78079),h=i(31002),u=i(23184);const m=new r.Vector2;class p{constructor(e,t){this.input=e,this.rendererModule=t,this.registrations=new Map,this.hovered=new Map,this.checkPointerLeave=()=>{if(this.hovered.size){const e=v(this.input.getCurrentRayHits());this.hovered.forEach(((t,i)=>{var n,s,a,o,r,d;if(!e.find((e=>e.object===i))){this.hovered.delete(i);const l=Object.assign(Object.assign({},t),{intersections:e});null===(a=null===(n=i.__r3f)||void 0===n?void 0:(s=n.handlers).onPointerOut)||void 0===a||a.call(s,l),null===(d=null===(o=i.__r3f)||void 0===o?void 0:(r=o.handlers).onPointerLeave)||void 0===d||d.call(r,l)}}))}},this.checkPointerMissed=()=>{var e,t,i;const n=new Set;for(const e of this.input.getCurrentRayHits())e.object instanceof r.Object3D&&n.add(e.object);for(const s of this.registrations.keys())n.has(s)||null===(i=null===(e=s.__r3f)||void 0===e?void 0:(t=e.handlers).onPointerMissed)||void 0===i||i.call(t,new MouseEvent("click",this.lastPointerUp.nativeEvent))},this.handlers=[this.initMeshHandlers(),e.registerUnfilteredHandler(c.$3,this.checkPointerLeave),e.registerUnfilteredHandler(h.rX,this.checkPointerMissed),e.registerUnfilteredHandler(c.CD,(e=>{e.down?this.lastPointerDown=e:this.lastPointerUp=e}))]}dispose(){[...this.handlers,...this.registrations.values()].forEach((e=>e.cancel()))}registerObject3D(e){const t=this.registrations.get(e);if(t)return t;const i=(0,d.Sh)((()=>{this.registrations.set(e,i),this.input.registerMesh(e,!1,(t=>function(e){let t=e;for(;t&&!g(t);)t=t.parent;return t}(t)===e))}),(()=>{this.registrations.delete(e),this.hovered.delete(e),this.input.unregisterMesh(e)}),!1);return i.renew(),i}initMeshHandlers(){const e=new WeakMap,t=(t,i,n)=>{var s,a,o,d,l,u,p,f,y,w,b,T;let D=null;for(let e=i;e;e=e.parent)g(e)&&(D||(D=[])).push(e);if(!D)return!1;const S=this.rendererModule.getCamera(),C=new r.Vector2(t.position.x,t.position.y);let E;n||(n=e.get(i)||{});let A=0;if(t instanceof h.rX){const{x:e,y:t}=this.lastPointerDown.clientPosition,{x:i,y:n}=this.lastPointerUp.clientPosition;A=m.set(i-e,n-t).length(),E=new MouseEvent("click",this.lastPointerUp.nativeEvent)}else E=t.nativeEvent;const P=v(this.input.getCurrentRayHits()),I={};for(const e in E)"function"!=typeof E[e]&&(I[e]=E[e]);const k=Object.assign(Object.assign(Object.assign({},I),n),{intersections:P,camera:S,delta:A,eventObject:i,nativeEvent:E,sourceEvent:E,pointer:C,ray:this.input.getCurrentPointerRay(),stopPropagation:()=>{k.stopped=!0,this.handleStopPropagation(k.eventObject,P),t.stopPropagation(),t.preventDefault()},stopped:!1,unprojectedPoint:new r.Vector3(C.x,C.y,0).unproject(S),spaceX:C.x,spaceY:C.y});for(const i of D){e.set(i,n);const r=i.__r3f;if(r&&g(i)&&(k.eventObject=i,t instanceof c.CD?t.down?null===(a=(s=r.handlers).onPointerDown)||void 0===a||a.call(s,k):null===(d=(o=r.handlers).onPointerUp)||void 0===d||d.call(o,k):t instanceof c.$3?(this.hovered.has(i)||(this.hovered.set(i,k),null===(u=(l=r.handlers).onPointerOver)||void 0===u||u.call(l,k),null===(f=(p=r.handlers).onPointerEnter)||void 0===f||f.call(p,k)),null===(w=(y=r.handlers).onPointerMove)||void 0===w||w.call(y,k)):t instanceof h.rX&&(null===(T=(b=r.handlers).onClick)||void 0===T||T.call(b,k)),k.stopped))return!0}return!1},i=[c.CD,c.$3,h.rX];return new l.P(...i.map((e=>this.input.registerMeshHandler(e,u.f.isInstanceOf(r.Object3D),t))))}handleStopPropagation(e,t){if(this.hovered.has(e)){const i=t.findIndex((t=>t.object===e));if(i>-1){const e=[];for(let n=i+1;n<t.length;n++)for(let i=t[n].object;i;i=i.parent){const t=this.hovered.get(i);t&&e.push({obj:i,origEvent:t})}e.forEach((({obj:e,origEvent:i})=>{var n,s,a;const o=Object.assign(Object.assign({},i),{intersections:t,eventObject:e});this.hovered.delete(e);const r=null===(n=e.__r3f)||void 0===n?void 0:n.handlers;null===(s=null==r?void 0:r.onPointerOut)||void 0===s||s.call(r,o),null===(a=null==r?void 0:r.onPointerLeave)||void 0===a||a.call(r,o)}))}}}}function g(e){const t=e.__r3f;return!!t&&(t.hasOwnProperty("eventCount")?(t.eventCount||0)>0:t.handlers&&Object.keys(t.handlers).length>0)}function v(e){const t=new Set;return e.filter((e=>e.object instanceof r.Object3D&&!t.has(e.object)&&(t.add(e.object),!0)))}class f extends n.n{name="react-three-fiber-external";rendererModule;eventsAdapter;externalCallbacks;async init(e,t){this.bindings.push(t.subscribe(s.h,this.onPlayerResized),t.subscribe(o.lo,this.onPixelRatioChanged));const[i,n]=await Promise.all([t.getModuleBySymbol(a.mL),t.getModuleBySymbol(a.M7)]);this.rendererModule=n,this.eventsAdapter=new p(i,n)}dispose(e){this.eventsAdapter.dispose(),super.dispose(e)}onUpdate(e){this.externalCallbacks?.onFrame()}onPlayerResized=e=>{this.externalCallbacks?.onSizeChange(e.width,e.height)};onPixelRatioChanged=e=>{this.externalCallbacks?.onPixelRatioChange(e.pixelRatio)};registerExternalR3F(e){if(this.externalCallbacks)throw new Error("registerExternalR3F called twice");return this.externalCallbacks=e,{renderer:this.rendererModule.threeRenderer,scene:this.rendererModule.getScene().scene,camera:this.rendererModule.getCamera(),registerMeshEvents:e=>this.eventsAdapter.registerObject3D(e)}}}},78854:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var n=i(64882),s=i(14868),a=i(9139),o=i(27200),r=i(90082),d=i(71687),l=i(37105),c=i(16653),h=i(32502),u=i(68909),m=i(18821),p=i(99583),g=i(46793),v=i(13893),f=i(66806);class y extends n.n{constructor(){super(...arguments),this.name="screenshots-module",this.capturer=new w}async init(e,t){this.engine=t,[this.settingsModule,this.canvas,this.renderer,this.renderToTexture,this.modelMesh]=await Promise.all([t.getModuleBySymbol(r.ZF),t.market.waitForData(l.p),t.getModuleBySymbol(d.M7),t.getModuleBySymbol(d.kM),t.getModuleBySymbol(d.GR)]),this.settingsModule.registerButton("Debug","Take screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,s.H.ALL)})),this.settingsModule.registerButton("Debug","Take 4k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:2304,width:4096},`image_${e}.jpg`,s.H.ALL)})),this.settingsModule.registerButton("Debug","Take 8k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:4608,width:8192},`image_${e}.jpg`,s.H.ALL)})),this.settingsModule.registerButton("Debug","Take 16k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:9e3,width:16e3},`image_${e}.jpg`,s.H.ALL)})),this.settingsModule.registerButton("Debug","Take FB 3D screenshot",(async()=>{const e=Date.now(),t=this.engine.getRenderLayer("model-mesh"),i=this.engine.getRenderLayer("skybox"),n=t.clone();n.addLayers(i);const s=(await this.engine.market.waitForData(p.X)).currentMode;try{await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,n),this.modelMesh.setChunkRenderingMode(h.f.Depth),await this.engine.commandBinder.issueCommand(new g.S2(g.w5.MESH,v.fl.Instant)),await this.takeAndDownloadScreenshot({height:Math.floor(this.canvas.height/4),width:Math.floor(this.canvas.width/4)},`image_${e}_depth.jpg`,t)}catch(e){throw a.Vy.for(this).error("Could not take screenshot"),e}finally{this.modelMesh.setChunkRenderingMode(null),await this.engine.commandBinder.issueCommand(new g.S2(g.De[s||f.N.Panorama]))}}))}async takeAndDownloadScreenshot(e,t,i){this.renderTarget||(this.renderTarget=await this.engine.commandBinder.issueCommandWhenBound(new m.q6));const n=await this.capturer.capture(i,e,this.renderer,this.renderToTexture,this.renderTarget);(0,o.x_)((0,c.y)(n),t)}}class w{constructor(){this.captureCamera=new u.PerspectiveCamera}async capture(e,t,i,n,s){const{camera:a,scene:o}=i.getScene();return a.getWorldPosition(this.captureCamera.position),a.getWorldQuaternion(this.captureCamera.quaternion),this.captureCamera.projectionMatrix.copy(a.projectionMatrix),this.captureCamera.layers.mask=e.mask,s.setSize(t.width,t.height),n.render(s.target,o,this.captureCamera),await(0,c.uz)(s)}}},58899:(e,t,i)=>{"use strict";i.d(t,{r:()=>r});var n=i(39905),s=i(94547),a=i(93877);const o=new n.r({});class r{constructor(e,t,i){this.commandBinder=e,this.layersData=t,this.dataTypeGroup=i,this.textParser=o,this.enabled=!0,this.bindings=[]}get isInMemory(){var e,t;const i=this.getLayerGroupId();if(!i)return!1;const n=null===(e=this.layersData)||void 0===e?void 0:e.getLayer(i);return null!==(t=null==n?void 0:n.isInMemory)&&void 0!==t&&t}getLayerType(){var e;const t=this.getLayerGroupId();if(!t)return;const i=null===(e=this.layersData)||void 0===e?void 0:e.getLayer(t);return null==i?void 0:i.layerType}getGroupingId(e){switch(e){case a.Hj.TYPE:return this.getTypeId();case a.Hj.FLOOR:return this.getFloorId();case a.Hj.ROOM:return this.getRoomId();case a.Hj.LAYER:return this.getLayerGroupId();case a.Hj.DATE:return this.dateBucket}}getFloorId(){return this.floorId}getRoomId(){return this.roomId}getDateBucket(){return this.dateBucket}getTypeId(){return this.typeId}supportsBatchDelete(){return!1}supportsLayeredCopyMove(){return!1}getLayerGroupId(){var e,t;const i=null===(e=this.layersData)||void 0===e?void 0:e.getBaseLayerId(),n=null===(t=this.layersData)||void 0===t?void 0:t.getViewLayerId();return this.layerId&&n&&this.layerId===i?n:this.layerId}isLayerVisible(){return!this.layersData||!this.layerId||this.layersData.layerVisible(this.layerId)}onSelect(e,t,i){this.commandBinder.issueCommand(new s.Xx(this.id,this.typeId))}registerBindings(){}cancelBindings(){this.bindings.forEach((e=>e.cancel()))}}},74481:(e,t,i)=>{"use strict";i.d(t,{M:()=>d});var n=i(13397),s=i(75410),a=i(59475),o=i(73566),r=i(48411);function d(){const e=(0,n.e)(),t=(0,s.h)(),i=(0,a.e)(),d=(0,r.T)(),l=d===o.S0.SEARCH||d===o.S0.LAYERS;return!!e||l&&t.length>0||i.length>0}},27817:(e,t,i)=>{"use strict";i.d(t,{w:()=>a});var n=i(98236),s=i(78849);const a=(0,n.v_)(s.L)},16112:(e,t,i)=>{"use strict";i.d(t,{f:()=>o});var n=i(96540),s=i(27817),a=i(47613);function o(e){const t=(0,s.w)(),i=(0,a._)(),[o,r]=(0,n.useState)({});return(0,n.useEffect)((()=>{if(!t||!i)return()=>{};function n(){if(t&&i)if(e&&i.getCurrentView().connections.length){const n={};for(const s of Object.keys(t.dataTypeGroups)){const a=t.dataTypeGroups[s].matches.filter((t=>{const n=t.getLayerGroupId();if(!n)return!1;const s=null==i?void 0:i.getLayerSource(n);return s===e||!s}));n[s]=Object.assign(Object.assign({},t.dataTypeGroups[s]),{matches:a,subscriptions:[]})}r(n)}else r(t.dataTypeGroups)}const s=t.onChanged(n);return n(),()=>s.cancel()}),[t,i,e]),o}},59475:(e,t,i)=>{"use strict";i.d(t,{e:()=>a});var n=i(96540),s=i(27817);function a(){const e=(0,s.w)(),[t,i]=(0,n.useState)((null==e?void 0:e.getKeywordFilters())||[]);return(0,n.useEffect)((()=>{if(!e)return()=>{};function t(){e&&i(e.getKeywordFilters())}const n=e.keywordFilters.onChanged(t);return t(),()=>n.cancel()}),[e]),t}},13397:(e,t,i)=>{"use strict";i.d(t,{e:()=>a});var n=i(87805),s=i(78849);const a=(0,n.u)(s.L,"query","")},64695:(e,t,i)=>{"use strict";i.d(t,{W:()=>d});var n=i(96540),s=i(27817),a=i(53289),o=i(78115),r=i(43590);function d(){const e=(0,n.useContext)(r.o),t=(0,s.w)(),[i,d]=(0,n.useState)([]);return(0,n.useEffect)((()=>{if(!t)return()=>{};function i(){t&&!(null==e?void 0:e.results)&&d(t.getResults())}const n=t.onSearchResultsChanged(i);return i(),()=>n.cancel()}),[null==e?void 0:e.results,t]),(0,a.J)(o.MT,(()=>{null==t||t.setResults([])})),(null==e?void 0:e.results)?e.results:i}},75410:(e,t,i)=>{"use strict";i.d(t,{h:()=>a});var n=i(96540),s=i(27817);function a(){const e=(0,s.w)(),[t,i]=(0,n.useState)((null==e?void 0:e.getTypeFilters())||[]);return(0,n.useEffect)((()=>{if(!e)return()=>{};function t(){e&&i(e.getTypeFilters())}const n=e.typeFilters.onChanged(t);return t(),()=>n.cancel()}),[e]),t}},1494:(e,t,i)=>{"use strict";i.d(t,{H:()=>a});var n=i(87805),s=i(78849);const a=(0,n.u)(s.L,"activeItemId",null)},16713:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ChangeSearchGroupingCommand:()=>C.xg,ClearSearchFiltersCommand:()=>C._d,DeregisterSearchGroupCommand:()=>C.tf,RegisterSearchGroupCommand:()=>C.Oc,SelectSearchResultCommand:()=>C.Xx,ToggleSearchFilterCommand:()=>C._w,ToggleSearchQueryKeywordCommand:()=>C.$M,UpdateSearchQueryCommand:()=>C.tA,UpdateSearchQueryKeywordsCommand:()=>C.Pb,default:()=>Xe});var n=i(64882),s=i(14614),a=i(45987),o=i(9139),r=i(64200),d=i(71687),l=i(56147),c=i(25443),h=i(79723),u=i(96319),m=i(73566),p=i(17084),g=i(23864),v=i(3071);class f{constructor(e){this.engine=e}async activate(){await this.engine.commandBinder.issueCommandWhenBound(new v.S(!0,!1,!1))}async deactivate(){await this.engine.commandBinder.issueCommandWhenBound(new v.S(!1,!1,!1))}}var y=i(39869),w=i(87805),b=i(78849);const T=(0,w.u)(b.L,"grouping",b.L.defaultGrouping);var D=i(64695),S=i(1494),C=i(94547),E=i(12103),A=i(16700),P=i(32485),I=i.n(P),k=i(74848);function N(e){let{className:t="",children:i}=e;const n=I()("mp-nova-list-controls",t);return(0,k.jsx)("div",{className:n,children:i})}const x=(0,w.u)(b.L,"searchMode",!1);var M=i(28479),O=i(78379),R=i(93877),L=i(39066),V=i(48270),j=i(19389),B=i(68375);const{SEARCH:F}=l.A.SHOWCASE;function H(e){let{phraseKeys:t={},grouping:i,onGroupBy:n}=e;const s=(0,y.Y)(),a=(0,O.S)(),o=x(),r=[R.Hj.DATE,R.Hj.FLOOR];"boolean"==typeof o&&r.unshift(R.Hj.TYPE),a&&r.push(R.Hj.LAYER);const d=s.t(_(i,!0,t));return(0,k.jsx)(L.y,{className:"grouping-sort-menu-button",ariaLabel:d,variant:V.A.TERTIARY,label:d,caret:!0,children:r.map((e=>(0,k.jsx)(U,{onGroupBy:n,grouping:e,phraseKeys:t},e)))})}function U(e){let{grouping:t,onGroupBy:i,phraseKeys:n={}}=e;const s=(0,B.s)(),a=(0,y.Y)().t(_(t,!1,n)),o=(0,M.L)();return(0,k.jsx)(j.$,{label:a,size:V.M.SMALL,variant:V.A.TERTIARY,onClick:()=>{i(t),s.trackGuiEvent(`items_group_by_${t}`,{tool:o})}},t)}function _(e,t,i){switch(e){case R.Hj.TYPE:return t?i[R.Hj.TYPE]?.selectedTextKey||F.GROUP_TYPE_SELECTED:i[R.Hj.TYPE]?.textKey||F.GROUP_TYPE;case R.Hj.FLOOR:return t?i[R.Hj.FLOOR]?.selectedTextKey||F.GROUP_FLOOR_SELECTED:i[R.Hj.FLOOR]?.textKey||F.GROUP_FLOOR;case R.Hj.ROOM:return t?i[R.Hj.ROOM]?.selectedTextKey||F.GROUP_ROOM_SELECTED:i[R.Hj.ROOM]?.textKey||F.GROUP_ROOM;case R.Hj.LAYER:return t?i[R.Hj.LAYER]?.selectedTextKey||F.GROUP_LAYER_SELECTED:i[R.Hj.LAYER]?.textKey||F.GROUP_LAYER;case R.Hj.DATE:default:return t?i[R.Hj.DATE]?.selectedTextKey||F.GROUP_DATE_SELECTED:i[R.Hj.DATE]?.textKey||F.GROUP_DATE}}var G=i(96540),z=i(16112),$=i(75410),W=i(95072),Y=i(28422),K=i(91048),X=i(90087);function q(e){let{id:t,icon:i,label:n,selected:s}=e;const a=(0,B.s)(),o=(0,X.L)(),r=(0,M.L)();return(0,k.jsx)(K.M,{id:t,icon:i,label:n,selected:s,onToggled:e=>{e.stopPropagation(),"ALL"===t?s||o.issueCommand(new C._d):o.issueCommand(new C._w(t,!s)),s||a.trackGuiEvent(`items_filter_by_${t.toLowerCase()}`,{tool:r})}})}i(80164);const{SEARCH:Q}=l.A.SHOWCASE;function J(){const e=(0,y.Y)(),t=Object.values((0,z.f)("")),i=(0,$.h)(),n=0===i.length,s=(0,G.useRef)(null),a=t.sort(((e,t)=>(e.groupOrder||W.X$)-(t.groupOrder||W.X$))).map((t=>{const{id:s,groupIcon:a,groupPhraseKey:o}=t,r=e.t(o),d=!n&&i.includes(s);return(0,k.jsx)(q,{id:s,icon:a,label:r,selected:d},s)})),o=e.t(Q.FILTER_SEARCH),r=e.t(Q.FILTER_SEARCH_ALL);return(0,k.jsx)("div",{className:"search-filter",onClick:e=>e.stopPropagation(),children:(0,k.jsxs)(L.y,{ariaLabel:e.t(Q.FILTER_SEARCH_LABEL),ref:s,icon:"filter",variant:V.A.TERTIARY,size:V.M.SMALL,menuClassName:"search-filter-menu",children:[(0,k.jsxs)("div",{className:"search-filter-menu-header",children:[(0,k.jsx)("div",{children:o}),(0,k.jsx)(Y.J,{onClose:()=>{s.current&&s.current.closeMenu()}})]}),(0,k.jsx)(q,{id:"ALL",icon:"fullscreen",label:r,selected:n}),a]})})}var Z=i(17651),ee=i(39949),te=i(41176),ie=i(55384),ne=i(91435),se=i(34674),ae=i(14804),oe=i(32005);function re(e){let{item:t}=e;const{imgUrl:i,color:n,icon:s}=t,a={"--badge-color":n};return i?(0,k.jsx)(ae.q,{className:"thumbnail-image",resource:i}):s?(0,k.jsx)(oe.E,{badgeStyle:void 0!==n?a:{},iconClass:s}):null}var de=i(13397),le=i(95143),ce=i(87399);function he(e){let{item:t}=e;const{textParser:i,title:n,description:s}=t,a=(0,de.e)();let o=n;o&&(o=(0,le.x8)(o,a));let r=s;return r&&(r=(0,le.A_)(r,a)),(0,k.jsxs)("div",{className:"item-details",children:[(0,k.jsx)("div",{className:"item-header",children:(0,k.jsx)(ce.L,{text:o||"",textParser:i,markers:le.S8})}),i&&(0,k.jsx)("div",{className:"item-description",children:(0,k.jsx)(ce.L,{text:r||"",textParser:i,markers:le.S8})})]})}var ue=i(17904);const{SEARCH:me}=l.A.SHOWCASE,pe=e=>{let{item:t}=e;const i=(0,y.Y)();if(!t){const e=i.t(me.EMPTY_LIST_MESSAGE);return(0,k.jsx)(ne.t,{message:e})}const{dataTypeGroup:n}=t;return n?.itemFC?(0,k.jsx)(n.itemFC,{item:t}):(0,k.jsx)(ge,{item:t},t.id)};function ge(e){let{item:t,className:i}=e;const n=(0,A.bt)("search-result-item"),s=(0,S.H)(),a=t.id,o=!!s&&a===s,r=(0,B.s)(),l=(0,X.L)(),c=(0,ue.S)(d.Et),h=(0,k.jsx)(re,{item:t}),u=(0,k.jsx)(he,{item:t});return(0,k.jsx)(se.c,{id:a,className:I()("search-result-item",n,i),title:u,active:o,disabled:!t.enabled,onClick:async()=>{const e="search_item_"+t.typeId.toLowerCase()+"_click";r.track("showcase_gui",{tool:"search",gui_action:e}),l.issueCommand(new p.oe(!0)),c?.closeOtherAnnotations(),t.onSelect()},badge:h||void 0},a)}var ve=i(43590),fe=i(74481),ye=i(57726),we=i.n(ye);const be=i.p+"images/empty-model.svg";var Te=i(4106);const De=we().bind({"model-search-list":"model-search-list-fd8b364c4460f5ea9449","aura-model-search-list":"aura-model-search-list-eb450503e95ca479286b","model-search-list-title":"model-search-list-title-e6bd86c440c1c4ac7923","model-search-empty":"model-search-empty-bb9509e6792e7f7f081a","model-search-empty-title":"model-search-empty-title-fc297ede3f00b2e04eb1","model-search-empty-icon":"model-search-empty-icon-e7961b8862bb27c71c23","model-search-empty-description":"model-search-empty-description-df1f9a4aa1fda3a63566","list-contents":"list-contents-df2470d34f4a60473e89"});function Se(e){let{activeItemId:t,emptyMessage:i,grouping:n,results:s,title:a,sourceViewId:o}=e;const r=s.length,d=(0,fe.M)(),l=(0,A.bt)("model-search-list"),c=(0,A.XW)(),{_:h}=(0,Te.uB)(),u=c===A.cD.AURA&&!d,m=d||c===A.cD.NOVA,p=h({id:"O8MQks",message:"Nothing Here Yet"}),g=h({id:"/QSm1K",message:"Add notes and measurements to\ncapture what matters."}),v=h({id:"nlkjim",message:"Image representing adding notes and measurements."});return(0,k.jsx)(ve.o.Provider,{value:{results:s,sourceViewId:o},children:(0,k.jsxs)("div",{className:De(l,"panel-list","search-panel-list","model-search-list"),children:[a&&(0,k.jsx)("span",{className:De("model-search-list-title"),children:a}),0===r?(0,k.jsxs)(k.Fragment,{children:[m&&(0,k.jsx)(ne.t,{message:i,className:De("model-search-empty-list-item")}),u&&(0,k.jsxs)("div",{className:De("model-search-empty"),children:[(0,k.jsx)("span",{className:De("model-search-empty-title"),children:p}),(0,k.jsx)("img",{src:be,className:De("model-search-empty-icon"),alt:v}),(0,k.jsx)("span",{className:De("model-search-empty-description"),children:g})]})]}):(0,k.jsx)(te.x,{renderGroup:ie.m,renderItem:pe,activeItemId:t,grouping:n,excludeEmptyGroups:!0,collapseWhenNotSearching:!0})]})})}var Ce=i(47613),Ee=i(30901);function Ae(){const e=(0,Ce._)(),t=function(){var e;const t=(0,Ce._)(),i=(0,Ee.t)(),n=null==t?void 0:t.getView(i);return null!==(e=null==n?void 0:n.compositeView)&&void 0!==e?e:null}(),i=(0,D.W)(),n=null==e?void 0:e.currentViewId;return(0,G.useMemo)((()=>{var s,a;if(!n)return[];const o={};return i.forEach((t=>{const i=t.getLayerGroupId();let s=n;i&&(s=e.getLayerSource(i)),o[s]?o[s].push(t):o[s]=[t]})),null!==(a=null===(s=null==t?void 0:t.connections)||void 0===s?void 0:s.map((e=>{var t;return{id:e.model.id,name:e.model.name,results:null!==(t=o[e.model.id])&&void 0!==t?t:[]}})))&&void 0!==a?a:[{id:n,name:e.getCurrentView().name,results:i}]}),[null==t?void 0:t.connections,e,n,i])}const{SEARCH:Pe}=l.A.SHOWCASE;function Ie(e){let{hideFilter:t,hideGrouping:i,hideHeader:n}=e;const s=(0,X.L)(),a=T(),o=(0,D.W)(),r=(0,S.H)(),d=(0,y.Y)(),l=(0,A.bt)("search-tool-panel"),c=Ae();const h=o.length,u=d.t(Pe.ITEMS,h),p=d.t(Pe.EMPTY_LIST_MESSAGE),g=(0,k.jsx)(Z.M,{filter:t||(0,k.jsx)(J,{}),filterPills:!0,shareEnabled:!0}),v=I()("search-tool-panel",l),f=c.length>1;return(0,k.jsxs)(ee.h,{toolId:m.S0.SEARCH,className:v,title:u,subheader:g,subheaderCollapsedHeight:E.on,hideHeader:n,children:[!i&&(0,k.jsx)(N,{className:"list-panel-controls",children:(0,k.jsx)(H,{grouping:a,onGroupBy:function(e){s.issueCommand(new C.xg(e))}})}),(0,k.jsx)("div",{className:"search-panel-list-contents",children:c.map((e=>{let{id:t,name:i,results:n}=e;return(0,k.jsx)(Se,{results:n,sourceViewId:t,grouping:a,activeItemId:r,emptyMessage:p,title:f?i:void 0},t)}))})]})}var ke=i(9702),Ne=i(56023),xe=i(27817);const Me=(e,t)=>Number(t.isSelected)-Number(e.isSelected)||e.text.localeCompare(t.text),Oe={fixtures:"KEYWORDS_FIXTURES"};function Re(){const e=(0,y.Y)(),t=function(){const e=(0,xe.w)(),[t,i]=(0,G.useState)((null==e?void 0:e.getKeywordSummaries())||[]);return(0,G.useEffect)((()=>{if(!e)return()=>{};function t(){e&&i(e.getKeywordSummaries())}const n=e.keywordCounts.onChanged(t),s=e.keywordFilters.onChanged(t);return t(),()=>{n.cancel(),s.cancel()}}),[e]),t}();return(0,G.useMemo)((()=>t.map((t=>Object.assign(Object.assign({},t),{text:Oe[t.id]?e.t(Oe[t.id]):t.text}))).sort(Me)),[t,e])}const Le=()=>{const e=Re(),t=(0,Ne.D)(C.$M,(e=>[e.id]));return(0,k.jsx)(ke.c,{className:"search-keyword-summary",tokens:e,onTokenClick:t,maxVisibleTruncated:5,allowSelect:!0})};var Ve=i(69485),je=i(77897),Be=i(64057),Fe=i(78956),He=i(68419);function Ue(){const e=(0,Be.J)(),t=(0,Fe.O)(),i=t===m.L$.NARROW||t===m.L$.BOTTOM_PANEL,n=!e&&t===m.L$.BOTTOM_PANEL;return(0,He.t)()&&n?null:(0,k.jsx)("div",{className:"search-tool-overlay",children:i?(0,k.jsx)(Ve.A,{direction:je.OP.horizontal,children:(0,k.jsx)(Le,{})}):(0,k.jsx)(Le,{})})}class _e{renderActive=e=>{let{createViewOverlay:t,createLeftPanel:i}=e;const n=(0,xe.w)(),s=n?.simpleSearchView;return(0,k.jsxs)(k.Fragment,{children:[t((0,k.jsx)(Ue,{})),i((0,k.jsx)(Ie,{hideHeader:s,hideFilter:s,hideGrouping:s}))]})}}function Ge(...e){return!0}function ze(...e){return!1}class $e{constructor(e){this.searchData=e,this.subscriptions=[],this.isSearchingGroup=e=>{const t=this.searchData.searchMode;return!0===t||t===e},this.onFiltersChanged=()=>{this.updateAvailableKeywords(),this.clearUnavailableKeywordFilters(),this.searchData.getSearchDataTypeList().forEach(this.updateMatches),this.updateResults()},this.updateAvailableKeywords=()=>{const e=this.getActiveSearchDataTypeList().reduce(((e,{getKeywords:t})=>{if(t){t().forEach((t=>{e[t]?e[t]++:e[t]=1}))}return e}),{});this.searchData.setKeywordCounts(e)},this.updateMatches=e=>{const{id:t,getSimpleMatches:i}=e,n=this.searchData.getTypeFilters(),s=this.searchData.getQuery(),a=0===n.length||n.includes(t)?function(e){if(!e)return Ge;const t=e.toLowerCase();return(...e)=>function(e,...t){return t.some((t=>t.toLowerCase().includes(e)))}(t,...e)}(s):ze,o=this.searchData.getKeywordFilters();e.matches=i(a,e,s,o)},this.activationChanged=e=>{e?this.updateAllMatchesAndResults():this.searchData.getSearchDataTypeList().forEach(this.revealItems)},this.revealItems=e=>{e.getSimpleMatches(Ge,e,"",[])},this.updateAllMatchesAndResults=(0,r.s)((()=>{this.updateAvailableKeywords(),this.searchData.getSearchDataTypeList().forEach(this.updateMatches),this.updateResults()}),200),this.subscriptions.push(e.onPropertyChanged("query",this.updateAllMatchesAndResults),e.onPropertyChanged("keywordFilters",this.updateAllMatchesAndResults),e.onPropertyChanged("searchMode",this.activationChanged),e.typeFilters.onChanged(this.onFiltersChanged))}dispose(){const e=e=>e.cancel();this.subscriptions.forEach(e),this.searchData.getSearchDataTypeList().forEach((t=>t.subscriptions.forEach(e)))}registerSearchGroup(e,t,i){const n=()=>{this.updateMatches(e),this.updateResults(),this.updateAvailableKeywords()};let s=!1,a=!1;const o=(0,r.s)((()=>{a?(n(),s=!1):s=!0}),200);t&&e.subscriptions.push(t(o));const d=t=>{const n=a;a=this.isSearchingGroup(e.id),i&&n!==a&&i(a&&t),a&&s&&o()};e.subscriptions.push(this.searchData.onPropertyChanged("searchMode",d)),d(this.searchData.searchMode)}deregisterSearchGroup(e){e.subscriptions.forEach((e=>e.cancel())),this.updateResults()}clearUnavailableKeywordFilters(){const e=this.searchData.getTypeFilters().length>0,t=this.getActiveSearchDataTypeList().find((e=>!!e.getKeywords));e&&!t&&this.searchData.setKeywordFilters([])}getActiveSearchDataTypeList(){const e=this.searchData.typeFilters;return this.searchData.getSearchDataTypeList().filter((t=>0===e.length||e.includes(t.id)))}updateResults(){const e=this.searchData.getSearchDataTypeList().reduce(((e,t)=>(e.push(...t.matches),e)),[]);this.searchData.setResults(e)}}var We=i(47737);const{TOOLS:Ye}=l.A;class Ke extends n.n{constructor(){super(...arguments),this.name="search",this.searchData=new b.L,this.deactivateTimeout=0,this.hasStartedTrackingQueries=!1,this.onApplicationChange=async()=>{this.updateFeatureEnablement()},this.registerSearchGroup=async e=>{const{id:t,groupPhraseKey:i,groupMatchingPhraseKey:n,getSimpleMatches:s,getKeywords:a,groupOrder:r,groupIcon:d,registerChangeObserver:l,onSearchActivatedChanged:c,itemFC:h,itemActionsFC:u,groupActionsFC:m,batchSupported:p=!1}=e;if(this.searchData.dataTypeGroups[t])return void o.Vy.for(this).debug("Search group already registered");const g={id:t,groupPhraseKey:i,groupMatchingPhraseKey:n,getSimpleMatches:s,getKeywords:a,groupOrder:r,groupIcon:d,matches:[],subscriptions:[],itemFC:h,itemActionsFC:u,groupActionsFC:m,batchSupported:p};this.searchData.dataTypeGroups[t]=g,this.searchResultsUpdater.registerSearchGroup(g,l,c)},this.deregisterSearchGroup=async e=>{const{id:t}=e,i=this.searchData.dataTypeGroups[t];i?(delete this.searchData.dataTypeGroups[t],this.searchResultsUpdater.deregisterSearchGroup(i)):o.Vy.for(this).debug("Search group not found to deregister")},this.updateQuery=async e=>{this.searchData.setQuery(e.query),this.searchData.commit()},this.updateQueryKeywords=async e=>{this.searchData.setKeywordFilters(e.keywords)},this.toggleQueryKeyword=async({keywordId:e})=>{const t=[...this.searchData.getKeywordFilters()];t.includes(e)?t.splice(t.indexOf(e),1):t.push(e),this.searchData.setKeywordFilters(t)},this.selectSearchResult=async e=>{const{id:t,typeId:i}=e,{activeItemId:n,selectedType:s}=this.searchData;t===n&&i===s||(this.searchData.activeItemId=t,this.searchData.selectedType=t&&i||null,this.searchData.commit())},this.changeGrouping=async e=>{this.searchData.grouping=e.grouping,this.searchData.commit()},this.toggleSearchFilter=async e=>{const{groupId:t,enabled:i}=e;this.searchData.toggleSearchFilter(t,i);this.searchData.getTypeFilters().length===Object.keys(this.searchData.dataTypeGroups).length&&this.searchData.clearTypeFilters()},this.onToolChanged=()=>{const e=this.toolsData.getActiveTool(),t=null==e?void 0:e.searchModeType;if(window.clearTimeout(this.deactivateTimeout),t){const e="string"==typeof t?t:void 0;this.activateSearchMode(e),e?this.searchData.setTypeFilter(e):this.searchData.clearTypeFilters()}else this.deactivateSearchMode()},this.trackQuery=(0,r.s)((()=>{const e=this.searchData.query.substring(0,1e3),t=this.searchData.getKeywordFilters().map((e=>e.trim())).sort().join(",");if(!e&&!t)return;const i=!this.hasStartedTrackingQueries&&e===this.config.urlQuery;this.analytics.track("space_search_queried",{query:e,queryKeywords:t,submittedByUrlParam:i}),this.hasStartedTrackingQueries=!0}),1e3),this.onViewChanged=()=>{this.searchResultsUpdater.updateAllMatchesAndResults()}}async init(e,t){if(this.config=e,this.engine=t,[this.toolsData,this.appData,this.settingsData,this.layersData,this.analytics]=await Promise.all([t.market.waitForData(u.M),t.market.waitForData(s.zH),t.market.waitForData(c.o),t.market.waitForData(We.P),t.getModuleBySymbol(d.aF)]),this.searchResultsUpdater=new $e(this.searchData),this.bindings.push(t.subscribe(a.E5,this.onApplicationChange),this.searchData.onPropertyChanged("query",this.trackQuery),this.searchData.onPropertyChanged("keywordFilters",this.trackQuery),this.toolsData.onPropertyChanged("activeToolName",this.onToolChanged),this.layersData.onPropertyChanged("currentViewId",this.onViewChanged),t.commandBinder.addBinding(C.tA,this.updateQuery),t.commandBinder.addBinding(C.Pb,this.updateQueryKeywords),t.commandBinder.addBinding(C.$M,this.toggleQueryKeyword),t.commandBinder.addBinding(C.xg,this.changeGrouping),t.commandBinder.addBinding(C._w,this.toggleSearchFilter),t.commandBinder.addBinding(C._d,(async()=>this.searchData.clearTypeFilters())),t.commandBinder.addBinding(C.Xx,this.selectSearchResult),t.commandBinder.addBinding(C.Oc,this.registerSearchGroup),t.commandBinder.addBinding(C.tf,this.deregisterSearchGroup)),this.updateFeatureEnablement(),(0,h.W)(this.settingsData)&&(void 0!==e.urlQuery||void 0!==e.urlQueryKeywords||void 0!==e.urlQueryFilters)){const t=decodeURIComponent(e.urlQuery||"");this.searchData.setQuery(t),this.searchData.commit();const i=decodeURIComponent(e.urlQueryFilters||"").trim(),n=i?i.split(","):[];n.length>0&&this.searchData.setTypeFilters(n);const s=decodeURIComponent(e.urlQueryKeywords||"").trim(),a=s?s.split(","):[];a.length>0&&this.searchData.setKeywordFilters(a);const o=this.toolsData.getTool(m.S0.LAYERS)?m.S0.LAYERS:m.S0.SEARCH;this.engine.commandBinder.issueCommand(new p.yU(o,!0))}t.market.register(b.L,this.searchData)}dispose(e){super.dispose(e),window.clearTimeout(this.deactivateTimeout),this.searchResultsUpdater&&this.searchResultsUpdater.dispose()}updateFeatureEnablement(){if(!(this.appData.application===s.lg.WORKSHOP)&&(0,h.W)(this.settingsData)&&!this.toolsData.getTool(m.S0.SEARCH)){const e=new g.N({id:m.S0.SEARCH,searchModeType:!0,namePhraseKey:Ye.SEARCH,panel:!0,panelLeft:!0,icon:"icon-magnifying-glass",analytic:"search",dimmed:!1,enabled:!0,hidesAppBar:!0,order:1,ui:new _e,manager:new f(this.engine)});this.engine.commandBinder.issueCommand(new p.Kw([e]))}}activateSearchMode(e){const t=e||!0;this.searchData.searchMode!==t&&(this.searchData.searchMode=t,this.searchData.commit())}deactivateSearchMode(){this.searchData.searchMode&&(this.searchData.setKeywordFilters([]),this.searchData.searchMode=!1,this.searchData.activeItemId=null,this.searchData.commit(),this.deactivateTimeout=window.setTimeout((()=>{this.searchData.clearTypeFilters()}),300))}}const Xe=Ke},31403:(e,t,i)=>{"use strict";i.r(t),i.d(t,{BoxVolume:()=>x.M,CylinderVolume:()=>M.z,SensorModule:()=>N,SourceType:()=>b.Y,SphereVolume:()=>O.I,default:()=>R});var n=i(64882),s=i(71687),a=i(46771),o=i(81662),r=i(68909);class d{constructor(){this.needsUpdate=!0}notify(){this.needsUpdate=!0}}var l=i(47213);class c{constructor(e){this.observable=new l.y,this.notifier=new class{constructor(e){this.sensorObservable=e}notify(){this.sensorObservable.observable.notify()}}(this),this.dependencySub=e.sub(this.notifier)}dispose(){this.dependencySub.cancel()}observe(e){return this.observable.observe(e)}}class h{constructor(e){this.cameraData=e,this._forward=new r.Vector3,this.frustum=new r.Frustum,this.frustumTransform=new a.k,this.frustumProjection=new a.k,this.forwardObserver=new d,this.frustumObserver=new d,this.frustumObservable=new c(new u(e)),this.frustumObservable.observe(this.forwardObserver),this.frustumObservable.observe(this.frustumObserver)}dispose(){this.frustumObservable.dispose()}get fovx(){return this.cameraData.fovX()}get fovy(){return this.cameraData.fovY()}get forward(){return this.forwardObserver.needsUpdate&&(this.forwardObserver.needsUpdate=!1,this._forward.copy(o.B1.FORWARD),this._forward.applyQuaternion(this.cameraData.pose.rotation)),this._forward}observe(e){return this.frustumObservable.observe(e)}get origin(){return this.cameraData.pose.position}containsPoint(e){return this.updateVolume(),this.frustum.containsPoint(e)}updateVolume(){if(this.frustumObserver.needsUpdate){this.frustumObserver.needsUpdate=!1;const e=this.cameraData.pose;this.frustumTransform.compose(e.position,e.rotation,o.B1.UNIT).getInverse(this.frustumTransform),this.frustumProjection.copy(this.cameraData.pose.projection),this.frustum.setFromProjectionMatrix(this.frustumTransform.multiplyMatrices(this.frustumProjection,this.frustumTransform).asThreeMatrix4())}}}class u{constructor(e){this.cameraData=e}sub(e){return this.cameraData.onChanged((()=>e.notify()))}}var m=i(10459);class p{constructor(){this.sensors=new Set}addSensor(e){this.sensors.add(e)}removeSensor(e){this.sensors.delete(e)}update(){for(const e of this.sensors)e.update()}}class g{constructor(e,t,i){this.frustum=e,this.raycaster=t,this.sensorDisposer=i,this.volumeObserver=new d,this.sources=new Set,this.dirtySources=new Set,this.sourceWatchers=new Map,this.readingsCache=new Map,this.readingObservable=new l.y,this.raycastDirection=new r.Vector3,this.volumeSub=e.observe(this.volumeObserver)}get origin(){return this.frustum.origin}dispose(){this.volumeSub.cancel(),this.sensorDisposer.disposeSensor(this)}addSource(...e){for(const t of e)this.sources.add(t),this.dirtySources.add(t),this.sourceWatchers.set(t,new v(this.dirtySources,t))}get readings(){return this.readingsCache}update(){this.volumeObserver.needsUpdate?(this.volumeObserver.needsUpdate=!1,this.recomputeAllReadings(),this.readingObservable.notify()):this.dirtySources.size>0&&(this.recomputeDirtyReadings(),this.readingObservable.notify())}recomputeAllReadings(){for(const e of this.sources)this.recomputeReading(e);this.dirtySources.clear()}recomputeDirtyReadings(){for(const e of this.dirtySources)this.recomputeReading(e);this.dirtySources.clear()}recomputeReading(e){this.raycastDirection.copy(e.origin).sub(this.frustum.origin).normalize();const t=this.frustum.origin.distanceToSquared(e.origin),i=this.readingsCache.get(e)||{direction:new r.Vector3};i.inRange=function(e,t){return t.volume.containsPoint(e.origin)}(this,e),i.inView=i.inRange&&this.frustum.containsPoint(e.origin)&&!function(e,t){return!!t&&e>t.distance**2}(t,this.raycaster.picking.pick(this.frustum.origin,this.raycastDirection)),i.direction.copy(this.raycastDirection),i.distanceSq=t,this.readingsCache.set(e,i)}onReadingsUpdated(e){return this.readingObservable.observe(e)}}class v{constructor(e,t){this.sub=t.volume.observe({notify(){e.add(t)}})}dispose(){this.sub.cancel()}}var f=i(81544),y=i(31002),w=i(23184),b=i(84358);const T=(e,t)=>e.type===b.Y.BOX?S(t):e.type===b.Y.CYLINDER?function(e){const t=new r.CylinderGeometry(.5,.5,1);t.translate(0,.5,0);const i=new r.Mesh(t,new r.MeshBasicMaterial);i.scale.set(.05,.1,.05);const n=new r.MeshBasicMaterial({transparent:!0,opacity:.1,side:r.DoubleSide,depthWrite:!1}),s=new r.Mesh(t,new r.MeshBasicMaterial({wireframe:!0})),a=new r.Mesh(t,n);return a.add(s),e.add(i),e.add(a),{interactionMesh:i,volumeMesh:a,dispose(){e.remove(i),e.remove(a),i.geometry.dispose(),i.material.dispose(),a.geometry.dispose(),a.material.dispose(),s.geometry.dispose(),s.material.dispose()},setColor(e){a.material.color.setHex(e),s.material.color.setHex(e)}}}(t):D(t),D=e=>{const t=new r.SphereGeometry(1,20,20),i=new r.Mesh(t,new r.MeshBasicMaterial);i.scale.set(.5,.5,.5);const n=new r.Mesh(t,new r.MeshBasicMaterial({wireframe:!0})),s=new r.Mesh(t,new r.MeshBasicMaterial({transparent:!0,opacity:.1,side:r.DoubleSide,depthWrite:!1}));return s.add(n),e.add(i),e.add(s),{interactionMesh:i,volumeMesh:s,dispose:()=>{e.remove(i),e.remove(s),i.geometry.dispose(),i.material.dispose(),s.geometry.dispose(),s.material.dispose(),n.geometry.dispose(),n.material.dispose()},setColor:e=>{s.material.color.setHex(e),n.material.color.setHex(e)}}},S=e=>{const t=new r.BoxGeometry(1,1,1),i=new r.Mesh(t,new r.MeshBasicMaterial);i.scale.set(.1,.1,.1);const n=new r.MeshBasicMaterial({transparent:!0,opacity:.1,side:r.DoubleSide,depthWrite:!1}),s=new r.Mesh(t,n),a=new r.LineSegments(new r.EdgesGeometry(t),new r.LineBasicMaterial);return s.add(a),e.add(i),e.add(s),{interactionMesh:i,volumeMesh:s,dispose:()=>{e.remove(i),e.remove(s),i.geometry.dispose(),i.material.dispose(),s.geometry.dispose(),s.material.dispose(),a.geometry.dispose(),a.material.dispose()},setColor:e=>{s.material.color.setHex(e),a.material.color.setHex(e)}}};var C=i(38069);const E=e=>{if(e.type===b.Y.BOX){const t=e;return Object.assign({},t.volume.size)}if(e.type===b.Y.CYLINDER){const t=e;return{x:t.volume.radius,y:t.volume.height,z:t.volume.radius}}{const t=e.volume.radius;return{x:t,y:t,z:t}}},A=(new r.Quaternion).identity();function P(e){if(e.type===b.Y.BOX){return e.volume.orientation}return A}class I{constructor(e,t,i){this.source=e,this.scene=t,this.inputIni=i,this.subs=[],this.stickyHover=!1,this.sourceDirty=!0,this.meshes=T(e,this.scene.scene),this.meshes.interactionMesh.scale.set(.1,.1,.1),this.meshes.interactionMesh.position.copy(this.source.origin),this.meshes.interactionMesh.material.color.copy(C.V.MP_BRAND),this.meshes.volumeMesh.scale.set(0,0,0),this.meshes.volumeMesh.position.copy(this.source.origin),this.meshes.volumeMesh.visible=!1;const n=P(e);this.meshes.volumeMesh.quaternion.copy(n);this.mixer=new r.AnimationMixer(this.meshes.volumeMesh);const s=E(e),a=new r.VectorKeyframeTrack(".scale",[0,.4],[0,0,0,s.x,s.y,s.z],r.InterpolateSmooth),o=new r.AnimationClip(void 0,.4,[a]);this.onHoverAction=this.mixer.clipAction(o),this.onHoverAction.clampWhenFinished=!0,this.onHoverAction.loop=r.LoopOnce;const d=()=>{const e=this.onHoverAction.time;this.onHoverAction.reset(),this.meshes.volumeMesh.visible=!0,this.onHoverAction.timeScale=1,this.onHoverAction.time=e,this.onHoverAction.play()},l=()=>{this.stickyHover=!this.stickyHover,this.stickyHover?this.meshes.interactionMesh.material.color.copy(C.V.LENS_GRAY):this.meshes.interactionMesh.material.color.copy(C.V.MP_BRAND)};this.subs.push(this.inputIni.registerMeshHandler(f.L,w.f.isValue(this.meshes.interactionMesh),d)),this.subs.push(this.inputIni.registerMeshHandler(f.q,w.f.isValue(this.meshes.interactionMesh),(()=>{if(!this.stickyHover){const e=this.onHoverAction.time;this.onHoverAction.reset(),this.onHoverAction.time=e,this.onHoverAction.timeScale=-1,this.onHoverAction.play()}}))),this.subs.push(this.inputIni.registerMeshHandler(y.rX,w.f.isValue(this.meshes.interactionMesh),l)),this.inputIni.registerMesh(this.meshes.interactionMesh,!1),d(),l(),this.subs.push(e.volume.observe(this))}notify(){this.sourceDirty=!0}update(e,t){if(this.sourceDirty){this.sourceDirty=!1,this.meshes.interactionMesh.position.copy(this.source.origin),this.meshes.volumeMesh.position.copy(this.source.origin),this.meshes.volumeMesh.quaternion.copy(P(this.source));const e=E(this.source),t=this.onHoverAction.getClip().tracks[0].values;t[3]=e.x,t[4]=e.y,t[5]=e.z}this.meshes.setColor(t.inRange?65280:16711680),this.mixer.update(e/1e3)}dispose(){this.meshes.dispose(),this.mixer.stopAllAction();for(const e of this.subs)e.cancel()}}class k{constructor(e,t,i){this.sensor=e,this.scene=t,this.inputIni=i,this.subs=[],this.visuals=new Map}init(){this.subs.push(this.sensor.onReadingsUpdated(this))}render(e){for(const[t,i]of this.sensor.readings){let n=this.visuals.get(t);n||(n=new I(t,this.scene,this.inputIni),this.visuals.set(t,n)),n.update(e,i)}}dispose(){}activate(){}deactivate(){for(const e of this.subs)e.cancel();for(const e of this.visuals.values())e.dispose();this.visuals.clear()}notify(){}}class N extends n.n{constructor(){super(...arguments),this.name="sensor-module",this.sensorUpdater=new p,this.debugSensor=null,this.sensorDisposer=new class{constructor(e){this.sensors=e}disposeSensor(e){this.sensors.removeSensor(e)}}(this)}async init(e,t){[this.cameraData,this.raycaster,this.renderer,this.inputIni]=await Promise.all([await t.market.waitForData(m.M),await t.getModuleBySymbol(s.sA),await t.getModuleBySymbol(s.M7),await t.getModuleBySymbol(s.mL)]),this.cameraVolume=new h(this.cameraData);var i,n,a,o;this.sensorDebuggerFactory=(i=e=>{t.addComponent(this,e)},n=e=>{t.removeComponent(this,e)},a=this.renderer.getScene(),o=this.inputIni,e=>{const t=new k(e,a,o);return i(t),{dispose:()=>{n(t)}}})}dispose(){this.cameraVolume.dispose()}createSensor(e){const t=new g(e,this.raycaster,this.sensorDisposer);return this.sensorUpdater.addSensor(t),t}createCameraBoundSensor(){return this.createSensor(this.cameraVolume)}setDebugSensor(e){this.debugSensor&&(this.debugSensor.dispose(),this.debugSensor=null),e&&(this.debugSensor=this.sensorDebuggerFactory(e))}onUpdate(){this.sensorUpdater.update()}removeSensor(e){this.sensorUpdater.removeSensor(e)}}var x=i(29543),M=i(39634),O=i(41369);const R=N},89281:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>J});var n=i(64882),s=i(97994),a=i(14868),o=i(93136),r=i(9139),d=i(81587),l=i(53172),c=i(81662),h=i(40397),u=i(32024),m=i(71687),p=i(12837),g=i(10459),v=i(92868),f=i(66806),y=i(99583),w=i(19702),b=i(18821),T=i(16653),D=i(76318),S=i(46140),C=i(8333),E=i(97696),A=i(2812),P=i(66416),I=i(39209),k=i(50018),N=i(9997),x=i(28404),M=i(35159),O=i(86426),R=i(304),L=i(96319),V=i(73566),j=i(47737),B=i(56547),F=i(7478);class H extends F.QB{constructor(e){super(),this.error=e}}var U=i(52018);class _ extends U.t{constructor(e,t="72002"){super(e,t),this.name="SnapshotCaptureError"}}class G extends U.t{constructor(e,t="73002"){super(e,t),this.name="SnapshotUploadError"}}class z extends U.t{constructor(e,t="74002"){super(e,t),this.name="SnapshotEncodingError"}}var $=i(11165),W=i(95300);class Y extends $.u{constructor(e){super(),this.payload={maxSize:e.maxSize||D.MF.ULTRAHIGH,aspect:e.aspect||W.BE,origin:e.origin,category:e.category||P.X.USER,onProgress:e.onProgress,waitForUpload:void 0===e.waitForUpload||e.waitForUpload}}}Y.id="CAPTURE_SNAPSHOT";class K extends $.u{constructor(e){super(),this.payload={origin:e.origin,onProgress:e.onProgress,waitForUpload:void 0===e.waitForUpload||e.waitForUpload}}}K.id="EQUIRECTANGULAR_SNAPSHOT";const X=i.p+"images/ai-watermark-512.svg",q=C.W0.uploadIntervalDelay;class Q extends n.n{constructor(){super(...arguments),this.name="snapshots-editor"}async init(e,t){this.engine=t,this.config=e,[this.renderer,this.sweepRenderer,this.rtt]=await Promise.all([t.getModuleBySymbol(m.M7),t.getModuleBySymbol(m.qD),t.getModuleBySymbol(m.kM)]),[this.sweepData,this.viewmodeData,this.cameraData,this.floorsViewData,this.layersData]=await Promise.all([t.market.waitForData(p.A),t.market.waitForData(y.X),t.market.waitForData(g.M),t.market.waitForData(I.X),t.market.waitForData(j.P),t.market.waitForData(A.O)]),t.market.waitForData(v.A).then((e=>this.roomBoundData=e)),[this.snapshotTarget,this.snapshotOverlayTarget]=await Promise.all([t.commandBinder.issueCommandWhenBound(new b.q6),t.commandBinder.issueCommandWhenBound(new b.q6)]);const i=await t.market.waitForData(L.M);this.bindings.push(i.onPropertyChanged("activeToolName",this.onToolChanged.bind(this)),t.commandBinder.addBinding(Y,this.onCaptureSnapshotCommand.bind(this)),t.commandBinder.addBinding(K,this.onCaptureEquirectCommand.bind(this)))}onToolChanged(e){this.sweepRenderer.setPreloadQuality(e===V.S0.PHOTOS||e===V.S0.START_LOCATION?this.sweepRenderer.enum.resolution.ULTRAHIGH:null)}async onCaptureEquirectCommand(e){const t=e.onProgress||(0,s.p)(0);t.value=10,this.engine.commandBinder.issueCommand(new N.Jq),await(0,o.c)(50);const i=this.sweepData.currentSweepObject;if(!i)throw new _("Equirectangular capture is only supported in Panorama mode");const n=this.queryIdealEqResolution();this.snapshotTarget.setSize(n.width,n.height);const a=c.B1.FORWARD.clone().applyQuaternion(i.rotation).setY(0),d=c.B1.FORWARD.clone().applyQuaternion(this.cameraData.pose.rotation).setY(0),l=(0,h.Vg)(a,d)+Math.PI;await this.fetchHighestAvailable(!0,D.MF.ULTRAHIGH,(e=>t.value=Math.max(10,e))),await this.takeEquirectangular(l),await this.sweepRenderer.resetSweep(i.id),this.engine.commandBinder.issueCommand(new N.sD);const u=(0,T._h)(this.snapshotTarget.width,this.snapshotTarget.height,l,0),m=this.uploadAndAddSnapshot({category:P.X.PANORAMA,origin:e.origin,exifData:u}).then((e=>e&&e.sid)).catch((e=>{throw r.Vy.for(this).error(e),this.engine.broadcast(new H(e)),e}));return e.waitForUpload?m:null}async onCaptureSnapshotCommand(e){const t=e.onProgress||(0,s.p)(0);t.value=10,this.engine.commandBinder.issueCommand(new N.Jq),this.engine.commandBinder.issueCommand(new R.x);const i=this.queryIdealResolution(e.maxSize,e.aspect);this.snapshotTarget.setSize(i.width,i.height),this.snapshotOverlayTarget.setSize(i.width,i.height),await this.fetchHighestAvailable(!1,e.maxSize,(e=>t.value=Math.max(10,e))),await(0,o.c)(2*q),await this.takeScreenshot();const n=this.sweepData.currentSweepObject;n&&this.viewmodeData.currentMode===f.N.Panorama&&await this.sweepRenderer.resetSweep(n.id),this.engine.commandBinder.issueCommand(new N.sD),this.engine.commandBinder.issueCommand(new R._);let a=e.category;n&&(n.alignmentType===k.c$.UNALIGNED||n.placementType===k.EO.MANUAL)&&a===P.X.USER&&(a=P.X.UNALIGNED);const d=this.uploadAndAddSnapshot({category:a,origin:e.origin}).then((e=>e&&e.sid)).catch((e=>{throw r.Vy.for(this).error(e),this.engine.broadcast(new H(e)),e}));return e.waitForUpload?d:null}async uploadAndAddSnapshot({category:e,origin:t,exifData:i}){const n=this.createSnapshot({category:e,origin:t});n.state=M._.CAPTURING;try{const e=await(0,T.uz)(this.snapshotTarget,i);n.imageBlob=(0,T.y)(e)}catch(e){throw n.state=M._.ERROR,r.Vy.for(this).error(e),new z(e)}n.state=M._.UPLOADING;try{const e=await this.engine.commandBinder.issueCommand(new O.Ns(n));if(!e)throw n.state=M._.ERROR,r.Vy.for(this).error("Exception during snapshot upload"),new G("Exception during snapshot upload");return n.state=M._.DONE,e}catch(e){throw n.state=M._.ERROR,r.Vy.for(this).error(e),new G(e)}}createSnapshot({category:e,origin:t}){var i;const n=this.viewmodeData.isInside(),s=this.floorsViewData.currentFloorId,{position:a,viewmode:o}=(0,E.nF)(this.cameraData,this.floorsViewData,this.viewmodeData);let r=(0,d.Rt)(new Date);if(!this.config.disableHlrRoomnames&&e===P.X.TOUR&&this.roomBoundData&&n&&s){const e=this.roomBoundData.findRoomIdForPosition(a,s),t=(e?this.roomBoundData.getPotentialRoomCanvasLabels(e,"","metric",!0,!1):[]).find((e=>e.length<=w.LT));t&&(r=`${r}_${t}`)}const l=new x.F;(0,B.AF)(this.layersData.getCurrentView())&&(r+="_defurnished",l.sourceViewId=this.layersData.getCurrentView().id),l.name=r,l.category=e,l.origin=t,l.is360=n&&!this.sweepData.currentAlignedSweepObject;const c=this.sweepData.state.currentSweep&&n?this.sweepData.getSweep(this.sweepData.state.currentSweep):null;return l.metadata={cameraMode:o,cameraPosition:a,cameraQuaternion:this.cameraData.pose.rotation.clone(),orthoZoom:o===f.N.Floorplan?this.cameraData.zoom():-1,ssZoom:this.cameraData.zoom(),scanId:null==c?void 0:c.platformId,scanTags:null!==(i=null==c?void 0:c.tags)&&void 0!==i?i:null,floorId:s,floorVisibility:this.floorsViewData.getFloorsVisibility()},l}queryIdealResolution(e=D.MF.ULTRAHIGH,t){var i,n;const s=1/Math.max(t,Number.EPSILON);let a=3840,o=a*s;const d=this.renderer.maxTextureSize;if(a>d&&(r.Vy.for(this).warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${d}`),a=d,o=a*s),this.viewmodeData.currentMode===f.N.Panorama){const s=null!==(n=null===(i=this.sweepData.currentSweepObject)||void 0===i?void 0:i.availableResolution(e))&&void 0!==n?n:D.MF.STANDARD,r=S.A.getPanoSize(s)*(this.cameraData.fovY()*l.tm)/90;a=Math.min(Math.round(r*t),d),o=Math.round(a/t)}return{width:a,height:o}}queryIdealEqResolution(){let e=8192,t=.5*e;const i=this.renderer.maxTextureSize;return e>i&&r.Vy.for(this).warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${i}`),e=Math.min(i,e),t=.5*e,{width:e,height:t}}fetchHighestAvailable(e,t=D.MF.ULTRAHIGH,i){const n=this.sweepData.currentSweepObject;if(n&&this.viewmodeData.currentMode===f.N.Panorama){const s=e?this.sweepRenderer.enum.queueStyle.FullPanorama:this.sweepRenderer.enum.queueStyle.CurrentView,a=i?e=>i(e*Q.captureProgressFudgeFactor):void 0;return this.sweepRenderer.requestResolution({sweepId:n.id,resolution:t,queueType:s,quickly:!0,onProgress:a}).promise}return i&&i(Q.captureProgressFudgeFactor),Promise.resolve()}async takeScreenshot(){const e=a.H.ALL;e.removeLayers(this.engine.getRenderLayer("grid-underlay")),e.removeLayers(this.engine.getRenderLayer("cursor-mesh")),e.removeLayers(this.engine.getRenderLayer("current-pano-marker"));const t=this.renderer.getScene().scene,i=this.renderer.getScene().camera,n=i.layers.mask;i.layers.mask=e.mask,this.rtt.render(this.snapshotTarget.target,t,i,void 0,!0),(0,B.AF)(this.layersData.getCurrentView())&&(this.watermarkTexture||(this.watermarkTexture=await(0,u.S)(X)),this.rtt.compose(this.snapshotTarget.target,this.watermarkTexture,{sourceMask:this.watermarkTexture,sourceResize:!1,sourceScale:.5})),i.layers.mask=n}async takeEquirectangular(e){const t=this.sweepData.state.currentSweep;if(t){const i=this.sweepRenderer.getRenderer(),n=i.useTexture(t),s=this.engine.commandBinder.issueCommand(new b.cl(this.snapshotTarget,n,e));await s,i.freeTexture(t)}}}Q.captureProgressFudgeFactor=90;const J=Q},28404:(e,t,i)=>{"use strict";i.d(t,{F:()=>o});var n=i(3928),s=i(66416),a=i(27625);class o extends n.v{constructor(){super(),this.category=s.X.USER}get aspectRatio(){return this.width/this.height}clone(){return(new o).copy(this)}copy(e){return this.sid=e.sid,this.sourceViewId=e.sourceViewId,this.thumbnailUrl=e.thumbnailUrl,this.imageUrl=e.imageUrl,this.downloadUrl=e.downloadUrl,this.name=e.name,this.label=e.label,this.is360=e.is360,this.origin=e.origin,this.category=e.category,this.height=e.height,this.width=e.width,this.created=e.created,this.modified=e.modified,this.state=e.state,this.visionLabel=e.visionLabel,this.visionName=e.visionName,this.imageBlob=e.imageBlob,this.metadata={cameraMode:e.metadata.cameraMode,cameraPosition:e.metadata.cameraPosition.clone(),cameraQuaternion:e.metadata.cameraQuaternion.clone(),scanId:e.metadata.scanId,orthoZoom:e.metadata.orthoZoom,ssZoom:e.metadata.ssZoom,floorId:e.metadata.floorId,floorVisibility:e.metadata.floorVisibility,scanTags:e.metadata.scanTags},this.commit(),this}refresh(e){this.thumbnailUrl.refreshFrom(e.thumbnailUrl),this.imageUrl.refreshFrom(e.imageUrl),this.downloadUrl.refreshFrom(e.downloadUrl)}equals(e){return this.metadata.cameraMode===e.metadata.cameraMode&&this.metadata.scanId===e.metadata.scanId&&(0,a.j1)(this.metadata.cameraPosition,e.metadata.cameraPosition)&&(0,a.qS)(this.metadata.cameraQuaternion,e.metadata.cameraQuaternion)}dispose(){[this.imageUrl,this.thumbnailUrl,this.downloadUrl].forEach((e=>{const t=e.getCurrentValue();t.startsWith("blob:")&&URL.revokeObjectURL(t)}))}}},35159:(e,t,i)=>{"use strict";var n;i.d(t,{_:()=>n}),function(e){e.CREATED="created",e.CAPTURING="capturing",e.UPLOADING="uploading",e.ERROR="error",e.DONE="done"}(n||(n={}))},81530:(e,t,i)=>{"use strict";i.d(t,{F:()=>s});var n=i(11165);class s extends n.u{constructor(e){super(),this.payload=e}}s.id="SAVE_COMMAND"},78229:(e,t,i)=>{"use strict";i.d(t,{AU:()=>o,DJ:()=>v,Eo:()=>m,GS:()=>l,OX:()=>h,Ol:()=>g,Pi:()=>f,Zx:()=>c,Zz:()=>b,f:()=>d,fm:()=>w,jW:()=>p,lp:()=>y,sT:()=>u,xg:()=>r});var n=i(50018),s=i(68909);const a=.25,o=e=>{function t(t){return t!==e}return Object.defineProperty(t,"name",{value:"_not"}),t},r=e=>{function t(t){return!!e.neighbours&&(-1!==e.neighbours.indexOf(t.id)||-1!==e.neighbours.indexOf(t.platformId))}return Object.defineProperty(t,"name",{value:"_neighbor"}),t},d=e=>{function t(t){return e===t||r(e)(t)}return Object.defineProperty(t,"name",{value:"_neighborOrSelf"}),t};function l(e){return e&&e.placementType===n.EO.MANUAL}function c(){function e(e){return e&&e.alignmentType===n.c$.ALIGNED}return Object.defineProperty(e,"name",{value:"_aligned"}),e}const h=()=>{function e(e){return e&&e.alignmentType!==n.c$.ALIGNED}return Object.defineProperty(e,"name",{value:"_unaligned"}),e},u=e=>{function t(t){return t&&e.floorId===t.floorId}return Object.defineProperty(t,"name",{value:"_sameFloor"}),t},m=e=>{function t(t){return t&&e===t.floorId}return Object.defineProperty(t,"name",{value:"_onFloor"}),t},p=(()=>{const e=new s.Vector3,t=new s.Vector3;return(i,n,s=a)=>{function o(a){return e.copy(a.position).sub(i).normalize().dot(t.copy(n))>s}return Object.defineProperty(o,"name",{value:"_inDirection"}),o}})(),g=()=>{function e(e){return e&&e.enabled}return Object.defineProperty(e,"name",{value:"_enabled"}),e},v=(e,t)=>{const i=new s.Vector3;function n(n){return i.copy(n.position).sub(e).normalize().dot(t)>0}return t=t.clone(),Object.defineProperty(n,"name",{value:"_byNormal"}),n},f=(e,t)=>{function i(i){return e.distanceTo(i.position)>t}return Object.defineProperty(i,"name",{value:"_outsideMaxDist"}),i},y=(e,t)=>{function i(i){return e.distanceTo(i.position)<t}return Object.defineProperty(i,"name",{value:"_inMaxDist"}),i},w=(e,t)=>{function i(i){return e.distanceToSquared(i.position)<t}return Object.defineProperty(i,"name",{value:"_inMaxSqDist"}),i},b={negate:e=>function(t){return!e.call(e,t)},every:(...e)=>function(t){return e.every((e=>e(t)))},some:(...e)=>function(t){return e.some((e=>e(t)))}}},96659:(e,t,i)=>{"use strict";i.d(t,{Io:()=>r,VY:()=>l,cv:()=>c,d$:()=>o,oW:()=>d});var n=i(68909);const s=-1,a=10,o=(e,t=s)=>{function i(i){return e.distanceToSquared(i.position)*t}return Object.defineProperty(i,"name",{value:"_distanceSq"}),i},r=(e,t=s)=>{function i(i){return e.distanceTo(i.position)*t}return Object.defineProperty(i,"name",{value:"_distance"}),i},d=(e,t,i=a)=>{const s=new n.Vector3;function o(n){return s.copy(n.position).sub(e).normalize().dot(t)*i}return Object.defineProperty(o,"name",{value:"_direction"}),o},l=(e,t,i=a)=>{const s=new n.Vector3;function o(n){return s.copy(n.position).sub(e).normalize().dot(t)*i}return Object.defineProperty(o,"name",{value:"_viewDirNorm"}),o},c=(e,t=s)=>{function i(i){return e.distanceToSquared(i.floorPosition)*t}return Object.defineProperty(i,"name",{value:"_floorDistSq"}),i}},46140:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var n,s=i(76318),a=i(8333);!function(e){e[e.Untested=0]="Untested",e[e.Testing=1]="Testing",e[e.Success=2]="Success",e[e.Fail=3]="Fail"}(n||(n={}));class o{constructor(e,t,i,n){this.maxCubemapSize=e,this.maxNavPanoSize=t,this.maxZoomPanoSize=i,this.overrideWindow=!1,this.navPanoSize=s.c5.STANDARD,this.zoomPanoSize=s.c5.STANDARD,this.defaultMaxNavPanoSize=this.maxNavPanoSize,this.resolution=n,this.highQualityThreshold=a.W0.windowHeightHighQualityThresholdOverride||a.W0.windowHeightHighQualityThreshold,this.updateMaximums()}update({height:e,fov:t}){this.resolution=e,this.updateMaximums()}overrideWindowMaximums(e){this.overrideWindow=e,this.updateMaximums()}overrideNavPanoSize(e){this.maxNavPanoSize=null!=e?e:this.defaultMaxNavPanoSize,this.updateMaximums()}updateMaximums(){this.resolution<this.highQualityThreshold&&!this.overrideWindow?(this.navPanoSize=Math.min(o.getPanoSize(s.MF.STANDARD),this.maxNavPanoSize),this.zoomPanoSize=Math.min(o.getPanoSize(s.MF.HIGH),this.maxZoomPanoSize)):(this.navPanoSize=this.maxNavPanoSize,this.zoomPanoSize=this.maxZoomPanoSize),this.zoomPanoSize<this.navPanoSize&&(this.navPanoSize=this.zoomPanoSize),this.zoomPanoSize=Math.min(this.maxCubemapSize,this.zoomPanoSize),this.navPanoSize=Math.min(this.maxCubemapSize,this.navPanoSize)}static getPanoSize(e){if(e in s.oY)return s.oY[e];throw new Error(`Not a panoSizeClass: ${e}`)}static getPanoSizeClass(e){if(e in s.Mo)return s.Mo[e];throw new Error(`Not a valid pano resolution: ${e}`)}getNavPanoSize(){return this.navPanoSize}getZoomPanoSize(){return this.zoomPanoSize}}},4582:(e,t,i)=>{"use strict";i.d(t,{A:()=>s});var n=i(7478);class s extends n.QB{constructor(){super()}}},35898:(e,t,i)=>{"use strict";i.d(t,{A:()=>s});var n=i(7478);class s extends n.QB{constructor(e){super(),this.sweepIds=e}}},67725:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n=i(68909),s=i(64882),a=i(9130),o=i(71687),r=i(35898),d=i(4582),l=i(9139),c=i(86866);const h=[.5,1.5,1,2];class u extends s.n{constructor(e,t,i,s){super(),this.distanceMap={},this.raycastCache={},this.raycastCount=0,this.name="sweep-path",this.getDistance=(()=>{const e=new n.Vector3(0,0,0);return(t,i,n=0)=>{var s;const a=this.distanceMap[t],o=this.distanceMap[i];a||(this.distanceMap[t]={}),o||(this.distanceMap[i]={});let r=null!==(s=this.distanceMap[t][i])&&void 0!==s?s:this.distanceMap[i][t];if(void 0!==r)return r;const d=this.getSweep(t),l=this.getSweep(i);return e.copy(d.position).sub(l.position),r=e.length(),r*=Math.max(1,(0,c.OF)(e.y,...h)),d.sourceViewId!==l.sourceViewId&&(r*=1.5),this.areSweepsOccluded(d,l,n)&&(this.areSweepsOccluded(d,l,0)?r*=100:r*=1.5),d.enabled&&l.enabled||(r=1/0),this.distanceMap[t][i]=r,this.distanceMap[i][t]=r,r}})(),this.validNeighbors={},this.distanceMap={},s&&(this.msgBus=s),e&&(this.sweepDataModule=e),t&&(this.meshQuery=t),i&&(this.meshTrimData=i),this.getValidNeighbors=this.getValidNeighbors.bind(this),this.findShortestPath=this.findShortestPath.bind(this),this.addSweepsNearPath=this.addSweepsNearPath.bind(this)}async init(e,t){var i,n;this.msgBus=t.msgBus,this.sweepDataModule||(this.sweepDataModule=await t.getModuleBySymbol(o.Wh)),null!==(i=this.meshQuery)&&void 0!==i||(this.meshQuery=await t.getModuleBySymbol(o.PM)),null!==(n=this.meshTrimData)&&void 0!==n||(this.meshTrimData=(await t.getModuleBySymbol(o.GR)).meshTrimData),this.bindings.push(this.meshTrimData.onMeshTrimChanged((()=>this.clearCaches())))}setRestrictedSweeps(e,t=0){if(this.restrictedSweeps=[],e){for(let i=t;i<e.length;i++)this.restrictedSweeps.push(e[i].id);this.msgBus.broadcast(new r.A(this.restrictedSweeps))}else this.restrictedSweeps=void 0,this.msgBus.broadcast(new d.A)}findShortestPath(e,t,i,n,s,o,r,d,c,h=5e3){const u=this.getSweep(e),m=this.getSweep(t);if(!u||!m)return null;const p=this,g=performance.now(),v=(0,a.G)({start:u,isEnd:e=>e.platformId===m.platformId,*neighbors(e){for(const t of p.getValidNeighbors(e.id,i,n))yield p.getSweep(t.id)},distance:(e,t)=>p.getDistance(e.id,t.id,d),heuristic:(e,t)=>1,timeout:h});return v.status===a.E.Success&&v.path.length<c?(this.addSweepsNearPath(v.path,s,o,r,d),this.raycastCount&&(l.Vy.for(this).debugInfo(`findShortestPath: ${this.raycastCount} mesh casts, ${(performance.now()-g).toFixed(2)}ms`),this.raycastCount=0),v.path):null}addSweepsNearPath(e,t,i,s,a){const o=new n.Vector3,r=new n.Vector3;for(let n=1;n<e.length;n++){const d=e[n-1].position,l=e[n].position,c=d.distanceTo(l);if(c>t){o.subVectors(l,d).normalize();const t=this.sweepDataModule.data.getSweepList().filter((e=>{if(e.isAligned()&&e.enabled){const t=r.subVectors(e.position,d).dot(o);if(t>i&&t<c-i&&r.copy(d).addScaledVector(o,t).distanceTo(e.position)<s)return!0}return!1}));t.sort(((e,t)=>d.distanceToSquared(e.position)-d.distanceToSquared(t.position)));let h=e[n-1];for(const s of t)h.position.distanceToSquared(s.position)>i**2&&!this.areSweepsOccluded(h,s,a)&&!this.areSweepsOccluded(s,e[n],a)&&(e.splice(n,0,s),h=s,n++)}}}areSweepsOccluded(e,t,i){var n,s,a,o,r,d;const l=null!==(n=(o=this.raycastCache)[i])&&void 0!==n?n:o[i]={};let c=(null!==(s=l[r=e.id])&&void 0!==s?s:l[r]={})[t.id];return void 0===c&&(this.raycastCount++,c=this.meshQuery.isSegmentOccluded(e.position,t.position,i),l[e.id][t.id]=c,(null!==(a=l[d=t.id])&&void 0!==a?a:l[d]={})[e.id]=c),c}getValidNeighbors(e,t,i){let n=this.validNeighbors[e];if(!n){n=[],this.validNeighbors[e]=n;const s=this.getSweep(e);if(!s)throw new Error(`sweep not found! ${e}`);const a=e=>t=>t!==s&&t.enabled&&t.isAligned()&&s.position.distanceTo(t.position)<=e;if(n.push(...s.neighbours.map((e=>this.getSweep(e))).filter(a(t))),i>0&&this.meshTrimData.numberOfTrims>0){this.sweepDataModule.data.getAlignedSweeps().filter(a(i)).filter((e=>!(null==n?void 0:n.includes(e))&&e.floorId===s.floorId)).forEach((e=>{this.meshTrimData.isSegmentTrimmed(s.position,e.position,{panoMode:!0})&&!this.areSweepsOccluded(s,e,0)&&n.push(e)}))}}return n}getCurveForPath(e){let t=0;const i=[0];for(let n=1;n<e.length;n++)t+=e[n-1].distanceTo(e[n]),i.push(t);const s=[0];for(let n=1;n<e.length;n++)s.push(i[n]/t);const a=e.slice();e=[a[0]];for(let t=1;t<a.length;t++){const i=a[t-1],n=a[t],s=i.distanceTo(n);s>3&&(e.push(i.clone().lerp(n,1.5/s)),e.push(n.clone().lerp(i,1.5/s))),e.push(n)}const o=new n.CatmullRomCurve3(e,!1);return{curve:new n.CatmullRomCurve3(o.getSpacedPoints(2*t).concat(e[e.length-1])),totalLength:t,sourceDistances:i,normalSourceDistances:s}}getSweep(e){return this.sweepDataModule.data.getSweep(e)||this.sweepDataModule.getSweepOnView(e)}clearCaches(){this.distanceMap={},this.validNeighbors={},this.raycastCache={}}}},8175:(e,t,i)=>{"use strict";i.d(t,{im:()=>g,jd:()=>y});var n=i(68909),s=i(85641),a=i.n(s),o=i(81019),r=i.n(o);class d extends n.ShaderMaterial{constructor(e,t){const i={tMask:{value:e},tPinHole:{value:t},pinColor:{value:new n.Color},opacity:{value:1}};super({vertexShader:a(),fragmentShader:r(),uniforms:i,name:"PinMaterial",transparent:!0})}}var l=i(32024),c=i(3249),h=i(37458),u=i(38069),m=i(95102);const p=i.p+"images/360_placement_pin_mask.png";class g extends n.Mesh{}let v;const f=()=>v||(v=(0,l.y)(p),v);class y extends m.m{constructor(e,t,i,n){const s=new d(f(),t);super(y.geometry,s),this.layers.mask=n.mask,this.name="PinMesh",this.cameraData=i,this._collider=new g(y.colliderGeometry,y.colliderMaterial),this._collider.name="PinMeshCollider",this._collider.material.visible=!1,this.add(this._collider),this.opacityProgress=0,this.shouldHide=!0,this.uniforms=s.uniforms,this.unhover(),this.selected=0,this.visible=!1,this.position.copy(e),this.renderOrder=h.X.pins360}updatePosition(e){this.position.copy(e)}get collider(){return this._collider}render(e){this.quaternion.copy(this.cameraData.pose.rotation),null===this.uniforms.tPinHole.value?this.opacityProgress=0:!this.shouldHide&&this.opacityProgress<1?this.opacityProgress+=e/y.FADE_DURATION:this.shouldHide&&this.opacityProgress>0&&(this.opacityProgress-=e/y.FADE_DURATION),this.opacityProgress=(0,c.qE)(this.opacityProgress,0,1),this.uniforms.opacity.value=this.opacityProgress,this.visible=0!==this.opacityProgress}activate(){this.shouldHide=!1}deactivate(){this.shouldHide=!0}isActive(){return!this.shouldHide}dispose(){this.collider.geometry.dispose(),this.collider.material.dispose()}setPinHover(e,t=!0,i=!0){const n=Math.min(Math.max(e,0),1);this.selected!==n&&(i&&this.uniforms.pinColor.value.copy(u.V.WHITE).lerp(u.V.MP_BRAND,n),t&&n>0&&n<=1&&(this.material.depthTest=!1),0===n&&(this.material.depthTest=!0),this.selected=n)}unhover(){this.uniforms.pinColor.value.copy(u.V.WHITE)}}y.FADE_DURATION=500,y.geometry=new n.PlaneGeometry(1.5,1.5),y.colliderGeometry=new n.SphereGeometry(1.5*.65),y.colliderMaterial=new n.MeshBasicMaterial({transparent:!0,opacity:.5,depthWrite:!1,color:16724312})},70047:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>V});var n,s=i(64882),a=i(97994),o=i(14614),r=i(71687),d=i(10459),l=i(99583),c=i(25443),h=i(2993),u=i(66806),m=i(39209);!function(e){e.CLOSED="closed",e.IDLE="idle",e.PRESSING="pressing",e.PLACING="placing",e.MOVING="moving",e.ROTATING="rotating",e.ROTATED="rotated"}(n||(n={}));var p=i(89928),g=i(7478);class v extends g.QB{constructor(e){super(),this.sweepId=e}}g.QB;class f extends g.QB{constructor(e){super(),this.sweepId=e}}var y=i(12837),w=i(23500),b=i(12103),T=i(9139),D=i(23184),S=i(76318),C=i(81544),E=i(78229),A=i(71067),P=i(8175);class I extends g.QB{constructor(e,t){super(),this.sweepId=e,this.selected=t}}class k extends g.QB{constructor(e,t,i){super(),this.sweepId=e,this.pinIndex=t,this.placed=i}}const N=new T.Vy("pin-mesh"),x=e=>(0,E.OX)()(e)&&(0,E.GS)(e);class M{constructor(e,t,i,n,s,a,o){this.getSelectedSweep=e,this.sweepData=t,this.scene=i,this.sweepTextureLoader=n,this.input=s,this.cameraData=a,this.layer=o,this.name="sweep-360-pins",this.containersBySourceId=new Map,this.bindings=[],this.visibilityFilter=()=>!0,this.hoverSweep=(e,t)=>{const i=this.getSelectedSweep()===e;this.highlightPin(e,t||i)},this.meshes=[],this.meshToDataMap={},this.dataToMeshMap={}}updatePinMeshPosition(e,t){this.mapSweepToMesh(e).updatePosition(t)}mapSweepToMesh(e){return this.dataToMeshMap[e]}mapColliderToSweep(e){const t=e.hasOwnProperty("collider")?e:e.parent;if(t){const e=this.meshToDataMap[t.id];if(e)return e.sweep}return null}filter(e){e&&(this.visibilityFilter=e);for(const e of this.meshes)this.filterMesh(e)}init(){}dispose(){for(const e in this.meshToDataMap){const t=this.meshToDataMap[e];this.removePinMesh(t.sweep)}}render(e){}beforeRenderViewport(e){for(const t of this.meshes)t.render(e)}activate(e){this.engine=e,this.bindings.push(this.input.registerMeshHandler(C.L,D.f.isType(P.im),((e,t)=>this.onHoverEvent(t,!0)))),this.bindings.push(this.input.registerMeshHandler(C.q,D.f.isType(P.im),((e,t)=>this.onHoverEvent(t,!1))));const t=this.sweepData.getCollection(),i=({added:e,updated:t,removed:i})=>{if(e)for(const[,t]of e)x(t)&&this.createPinMesh(t,this.cameraData);if(t)for(const[e,i]of t){const t=this.sweepData.getIndexByAlignment(!1,e);x(i)?(this.dataToMeshMap[e]||(this.createPinMesh(i,this.cameraData),this.engine.broadcast(new k(e,t,!0))),this.updatePinMeshPosition(e,i.position)):this.dataToMeshMap[e]&&(this.removePinMesh(i),this.engine.broadcast(new k(e,t,!1)))}if(i)for(const[,e]of i)this.removePinMesh(e)};this.bindings.push(t.onElementsChanged(i)),i({added:t.entries()})}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0;for(const[e,t]of this.containersBySourceId)t.removeFromParent()}getMeshes(){return this.meshToDataMap}highlightPin(e,t,i=!1){this.dataToMeshMap[e]&&(t&&i&&Object.entries(this.dataToMeshMap).forEach((([t,i])=>{t!==e&&i.unhover()})),this.dataToMeshMap[e].setPinHover(t?1:0,!1))}lockSelection(e,t){return t&&(this.engine.broadcast(new I(e.id,!0)),this.hoverSweep(e.id,!0)),!0}createPinMesh(e,t){var i,n;const s=new P.jd(e.position,null,t,this.layer);this.meshes.push(s),this.dataToMeshMap[e.id]=s,this.meshToDataMap[s.id]={id:s.id,sweep:e};const a=this.scene.getSubTree([null!==(i=e.sourceViewId)&&void 0!==i?i:A.j,this.name]);this.containersBySourceId.set(null!==(n=e.sourceViewId)&&void 0!==n?n:A.j,a),a.add(s),this.filterMesh(s),this.sweepTextureLoader.loadFace(e,S.MF.BASE,1,{flipY:!0}).then((e=>{s.material.uniforms.tPinHole.value=e})).catch((t=>{N.error(`${e.id} failed to load texture: ${t}`)}))}removePinMesh(e){const t=this.dataToMeshMap[e.id];if(!t)return;const i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),t.removeFromParent(),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.id],t.dispose()}filterMesh(e){const t=this.meshToDataMap[e.id];if(t){const i=t.sweep;this.visibilityFilter(i)?this.activateMesh(e):this.deactivateMesh(e)}}onHoverEvent(e,t){const i=this.mapColliderToSweep(e);i&&this.hoverSweep(i.id,t)}activateMesh(e){this.input.registerMesh(e.collider,!1),e.activate()}deactivateMesh(e){this.input.unregisterMesh(e.collider);const t=this.meshToDataMap[e.id];t&&e.isActive()&&(this.hoverSweep(t.sweep.id,!1),e.deactivate())}}M.MENU_CLEAR_DEBOUNCE=100;var O=i(11165);class R extends O.u{constructor(e){super(),this.payload={id:e}}}R.id="PIN_UNSELECT";class L extends O.u{constructor(e,t){super(),this.payload={sweepId:e,highlight:t}}}L.id="HIGHLIGHT_PIN";class V extends s.n{constructor(){super(...arguments),this.name="sweep-pin-mesh",this.selectedPinObservable=new a.L(null),this.toolStateObservable=new a.L(n.CLOSED),this.onChange=()=>{const e=this.selectedPinObservable.value,t=this.toolStateObservable.value,i=t===n.ROTATING||t===n.ROTATED;this.pinRenderer.filter((t=>{const n=this.settingsData.tryGetSetting(w.s,!0),s=this.settingsData.tryGetSetting(b.Vg,!1);if(!n||s)return!1;if(i&&e===t.id)return!1;if(this.viewmodeData.transition.active&&(0,h.nI)(this.viewmodeData.transition.to))return!1;const a=!this.nextFloor||this.nextFloor===t.floorId||!t.floorId,r=this.config.showPinsInFloorplanDollhouse||this.applicationData.application===o.lg.WORKSHOP,d=this.viewmodeData.closestMode===u.N.Dollhouse||this.viewmodeData.closestMode===u.N.Floorplan;return a&&d&&r}))},this.onSelectedPinChange=()=>{const e=this.selectedPinObservable.value;e&&this.pinRenderer.highlightPin(e,!0,!0)}}async init(e,t){var i;[this.webglRenderer,this.input,this.sweepData,this.cameraData,this.settingsData,this.viewmodeData,this.floorsViewData,this.applicationData]=await Promise.all([t.getModuleBySymbol(r.M7),t.getModuleBySymbol(r.mL),t.market.waitForData(y.A),t.market.waitForData(d.M),t.market.waitForData(c.o),t.market.waitForData(l.X),t.market.waitForData(m.X),t.market.waitForData(o.zH)]);const n=await t.getModuleBySymbol(r.wY),s=t.claimRenderLayer(this.name),a=this.webglRenderer.getScene();this.config={showPinsInFloorplanDollhouse:null===(i=e&&e.showPinsInFloorplanDollhouse)||void 0===i||i},this.pinRenderer=new M((()=>this.selectedPinObservable.value),this.sweepData,a,n,this.input,this.cameraData,s),t.addComponent(this,this.pinRenderer),this.bindings.push(this.applicationData.onPropertyChanged("application",this.onChange),this.settingsData.onSettingChanged(w.s,this.onChange),this.settingsData.onSettingChanged(b.Vg,this.onChange),this.viewmodeData.onChanged(this.onChange),this.toolStateObservable.onChanged(this.onChange),this.selectedPinObservable.onChanged(this.onSelectedPinChange),t.subscribe(p.G,(e=>{this.nextFloor=e.to,this.onChange()})),t.subscribe(v,this.onChange),t.subscribe(f,this.onChange),t.commandBinder.addBinding(R,(async e=>{this.pinRenderer.highlightPin(e.id,!1)})),t.commandBinder.addBinding(L,(async e=>{this.highlightPinMesh(e.sweepId,e.highlight)}))),this.nextFloor=this.floorsViewData.currentFloorId,this.onChange()}mapColliderToSweep(e){return this.pinRenderer.mapColliderToSweep(e)}selectPinMesh(e,t){return this.selectedPinObservable.value=e.id,this.pinRenderer.lockSelection(e,t)}highlightPinMesh(e,t){this.pinRenderer.highlightPin(e,t)}mapSweepToMesh(e){return this.pinRenderer.mapSweepToMesh(e)}updatePosition(e,t){this.pinRenderer.updatePinMeshPosition(e,t)}}},64382:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var n=i(64882),s=i(71687),a=i(8175),o=i(35699),r=i(77510),d=i(66806),l=i(13893),c=i(99583),h=i(68909),u=i(31002),m=i(81544),p=i(23184);class g extends n.n{constructor(){super(...arguments),this.name="sweep-pin-navigation"}async init(e,t){const[i,n,g,v]=await Promise.all([t.getModuleBySymbol(s.gk),t.getModuleBySymbol(s.SD),t.market.waitForData(c.X),t.getModuleBySymbol(s.mL)]),f=new h.Quaternion;this.bindings.push(v.registerMeshHandler(u.rX,p.f.isType(a.im),((e,t,s)=>{const a=i.mapColliderToSweep(t);return!(!a||g.transition.active)&&(f.set(0,0,0,1).multiply(a.rotation),o=a.id,r=f,g.currentMode&&g.currentMode!==d.N.Panorama&&n.switchToMode(d.N.Panorama,l.fl.FadeToBlack,{sweepID:o,rotation:r}),!0);var o,r})),v.registerMeshHandler(m.L,p.f.isType(a.im),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.X(r.b.FINGER))})),v.registerMeshHandler(m.q,p.f.isType(a.im),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.X(null))})))}}},61036:(e,t,i)=>{"use strict";i.d(t,{z:()=>b,E:()=>v});var n=i(68909),s=i(24235),a=i.n(s),o=i(38581),r=i.n(o);class d extends n.ShaderMaterial{constructor(e,t){const i=n.UniformsUtils.clone(d.uniforms);i.tNoHover.value=e,i.tHover.value=t,i.tPortal.value=null,super({vertexShader:a(),fragmentShader:r(),uniforms:i,name:"PortalMaterial",transparent:!0})}}d.uniforms={tNoHover:{value:null},tHover:{value:null},tPortal:{value:null},progress:{value:1},opacity:{value:1}};var l=i(32024);const c=i.p+"images/exterior.png",h=i.p+"images/exterior_hover.png",u=i.p+"images/interior.png",m=i.p+"images/interior_hover.png";let p;const g={get:()=>p||(p={toExteriorTexture:(0,l.y)(c),toExteriorHoverTexture:(0,l.y)(h),toInteriorTexture:(0,l.y)(u),toInteriorHoverTexture:(0,l.y)(m)},p)};var v,f=i(3249),y=i(37458),w=i(66721);!function(e){e[e.HIDE=0]="HIDE",e[e.SHOW=1]="SHOW",e[e.ONTOP=2]="ONTOP"}(v||(v={}));class b extends n.Mesh{constructor(e,t){const i=new d(g.get().toInteriorTexture,g.get().toInteriorHoverTexture);super(b.geometry,i),this.layers.mask=t.mask,this.uniforms=i.uniforms,this.renderOrder=y.X.portals,this.setState(v.HIDE),this.update(e)}update(e){if(this.portalData=e,this.position.copy(e.position),null!==e.lookDirection){const t=e.lookDirection.clone().add(e.position);this.lookAt(t)}this.hoverProgress=0,this.hovered=!1,e.toExterior?(this.uniforms.tNoHover.value=g.get().toExteriorTexture,this.uniforms.tHover.value=g.get().toExteriorHoverTexture):(this.uniforms.tNoHover.value=g.get().toInteriorTexture,this.uniforms.tHover.value=g.get().toInteriorHoverTexture)}resetMesh(e=0,t=!1,i=!1){this.uniforms.opacity.value=e,this.visible=0!==e,this.material.depthTest=t,this.material.depthWrite=i}setHover(e){this.hovered=e}setState(e){switch(e){case v.HIDE:this.resetMesh(0,!0,!0);break;case v.SHOW:this.resetMesh(1,!0,!0);break;case v.ONTOP:this.resetMesh(1)}}beforeRender(e){this.hovered&&this.hoverProgress<1?this.hoverProgress+=e/300:!this.hovered&&this.hoverProgress>0&&(this.hoverProgress-=e/300),this.hoverProgress=(0,f.qE)(this.hoverProgress,0,1),this.uniforms.progress.value=this.hoverProgress}beforeRenderViewport(e){var t;if((null===(t=this.portalData)||void 0===t?void 0:t.billboard)&&this.visible){const t=e.pose.position,i=this.position.copy(this.portalData.position),n=t.distanceTo(i);n<w._9?i.lerpVectors(t,i,w._9/n):n>w.SM&&i.lerpVectors(t,i,w.SM/n),this.lookAt(e.pose.position)}}updatePortalTexture(e){this.uniforms.tPortal.value=e}raycast(e,t){if(!this.visible)return;const i=[];super.raycast(e,i),i.length>0&&(i[0].distance/=1e4,t.push(i[0]))}}b.geometry=new n.PlaneGeometry(w.yb,w.yb)},89499:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>k});var n=i(68909),s=i(64882),a=i(71687),o=i(6687),r=i(10459),d=i(12837),l=i(50018),c=i(78229),h=i(96659),u=i(76318),m=i(20736),p=i.n(m),g=i(39142),v=i.n(g);class f extends n.ShaderMaterial{constructor(){const e=n.UniformsUtils.clone(f.uniforms);super({vertexShader:p(),fragmentShader:v(),uniforms:e,name:"PortalViewportMaterial",side:n.BackSide})}updateTexture(e){this.uniforms.tMap.value=e}}f.uniforms={tMap:{value:null}};class y{constructor(e,t,i,s){this.tempLookDirection=new n.Vector3,this.worldCamera=s,this.camera=new n.PerspectiveCamera,this.renderSize=i,this.sweepTextureLoader=e,this.textureRenderer=t,this.renderTargets={},this.renderCube=new n.Mesh(new n.BoxGeometry(4,4,4),new f)}async getPortalTexture(e,t,i){const n=this.renderTargets[e.id]||this.textureRenderer.createRenderTarget2D(this.renderSize,this.renderSize),s=await this.sweepTextureLoader.load(e,u.MF.BASE);return this.renderCube.material.updateTexture(s),this.renderCube.quaternion.copy(t),this.camera.projectionMatrix.copy(this.worldCamera.projectionMatrix),this.worldCamera.getWorldPosition(this.tempLookDirection),this.camera.lookAt(this.tempLookDirection.sub(i).negate()),this.textureRenderer.render(n,this.renderCube,this.camera),n.texture}releasePortalTexture(e){const t=this.renderTargets[e];t&&this.textureRenderer.disposeRenderTarget2D(t)}}var w=i(61036),b=i(73586),T=i(71067),D=i(81544),S=i(31002),C=i(23184),E=i(21156);class A{constructor(e,t,i,n,s){this.name="portal-pucks",this.containersBySourceId=new Map,this.bindings=[],this.visibilityFilter=e=>w.E.HIDE,this.isActive=!1,this.webGLScene=e,this.input=t,this.layer=n,this.cameraData=s,this.viewportLoader=i,this.meshes=[],this.activeMeshes={},this.meshToDataMap={},this.dataToMeshMap={},this.activeTexturePromises={},this.meshPool=new b.i}addPortal(e){var t;let i;const s=this.meshPool.get();s?(i=s.object,i.update(e)):i=this.meshPool.add(new w.z(e,this.layer)).object,this.meshes.push(i);const a=null!==(t=e.toSweep.sourceViewId)&&void 0!==t?t:T.j,o=this.containersBySourceId.get(a)||new n.Object3D;if(this.containersBySourceId.set(a,o),o.add(i),this.isActive&&!o.parent){this.webGLScene.getSubTree([a,this.name]).add(o)}this.meshToDataMap[i.id]=e,this.dataToMeshMap[e.index]=i,this.activateMesh(i,this.visibilityFilter(e))}removePortal(e){const t=this.dataToMeshMap[e.index];if(t){this.meshPool.free(t);const i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),t.removeFromParent(),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.index]}}init(){}activate(e){this.broadcast=e.broadcast.bind(e),this.bindings.push(this.input.registerMeshHandler(D.L,C.f.isType(w.z),((e,t)=>{this.onPuckSelect(t)}))),this.bindings.push(this.input.registerMeshHandler(D.q,C.f.isType(w.z),((e,t)=>{this.onPuckDeselect(t)}))),this.bindings.push(this.input.registerMeshHandler(S.rX,C.f.isType(w.z),((e,t)=>{this.onPuckClick(t)}))),this.isActive=!0;for(const[e,t]of this.containersBySourceId){this.webGLScene.getSubTree([e,this.name]).add(t)}}dispose(){for(const e of Object.keys(this.meshToDataMap)){const t=this.meshToDataMap[e],i=this.dataToMeshMap[t.index];this.removePortal(t),i.material.dispose(),i.geometry.dispose()}}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0;for(const[e,t]of this.containersBySourceId)t.removeFromParent()}beforeRender(e){for(const t of this.meshes)t.beforeRender(e)}beforeRenderViewport(e){for(const e of this.meshes)e.beforeRenderViewport(this.cameraData)}render(e){}filter(e){this.visibilityFilter=e;for(const t of this.meshes){const i=e(this.meshToDataMap[t.id]);i===w.E.HIDE?this.deactivateMesh(t):this.activateMesh(t,i)}}mapSweepToMesh(e){for(const t in this.meshToDataMap){const i=this.meshToDataMap[t];if(i.toSweep.id===e&&i.toExterior&&i.fromInterior)return this.dataToMeshMap[i.index]}return null}activateMesh(e,t=0){this.activeMeshes[e.id]||(this.input.registerMesh(e,!1),this.activeMeshes[e.id]=!0),e.setState(t)}deactivateMesh(e){this.input.unregisterMesh(e),this.activeMeshes[e.id]=!1,this.onPuckDeselect(e),e.setState(w.E.HIDE)}onPuckClick(e){this.broadcast(new E.G(this.meshToDataMap[e.id]))}onPuckSelect(e){this.broadcast(new E.w(!0));const t=this.meshToDataMap[e.id].toSweep,i=this.viewportLoader.getPortalTexture(t,t.rotation,e.position);this.activeTexturePromises[e.id]=i,i.then((t=>{this.activeTexturePromises.hasOwnProperty(e.id)&&i===this.activeTexturePromises[e.id]&&(e.updatePortalTexture(t),e.setHover(!0))}))}onPuckDeselect(e){this.broadcast(new E.w(!1)),e.setHover(!1),this.viewportLoader.releasePortalTexture(this.meshToDataMap[e.id].toSweep.id),delete this.activeTexturePromises[e.id]}}var P=i(66721),I=i(9139);class k extends s.n{constructor(){super(...arguments),this.name="sweep-portal-mesh",this.portalCount=0}async init(e,t){const[i,n,s,o,h,u,m]=await Promise.all([t.getModuleBySymbol(a.wY),t.getModuleBySymbol(a.sA),t.getModuleBySymbol(a.mL),t.getModuleBySymbol(a.kM),t.getModuleBySymbol(a.M7),t.market.waitForData(d.A),t.market.waitForData(r.M)]),p=t.claimRenderLayer(this.name);this.portalData={};const g=h.getScene().camera;this.raycaster=n;const v=new y(i,o,256,g);this.portalRenderer=new A(h.getScene(),s,v,p,m),await Promise.all([t.getModuleBySymbol(a.Ne)]);const f=new Map,w=e=>{var t;this.portalData[e.id]&&(this.removePortals(e.id,this.portalRenderer),null===(t=f.get(e.id))||void 0===t||t.cancel(),f.delete(e.id),delete this.portalData[e.id])},b=e=>{if(!this.portalData[e.id]){this.portalData[e.id]=[],c.GS(e)&&this.addPortals(e,this.portalRenderer,u,u.filter((e=>c.GS(e))));let t=e.placementType;f.set(e.id,e.onPropertyChanged("placementType",(i=>{t!==l.EO.MANUAL&&i===l.EO.MANUAL&&this.addPortals(e,this.portalRenderer,u,u.filter((e=>c.GS(e)))),t===l.EO.MANUAL&&i!==l.EO.MANUAL&&this.removePortals(e.id,this.portalRenderer),t=i})))}},T=u.getCollection();this.bindings.push(T.onElementsChanged((e=>{var t,i,n;null===(t=e.removed)||void 0===t||t.forEach((([e,t])=>w(t))),null===(i=e.added)||void 0===i||i.forEach((([e,t])=>b(t))),null===(n=e.updated)||void 0===n||n.forEach((([e,t])=>{this.portalData[t.id]&&c.GS(t)&&(this.removePortals(t.id,this.portalRenderer),this.addPortals(t,this.portalRenderer,u,u.filter((e=>c.GS(e)))))}))}))),T.forEach(b),t.addComponent(this,this.portalRenderer)}filter(e){this.portalRenderer.filter(e)}getPortalToExterior(e){return this.portalRenderer.mapSweepToMesh(e)}removePortals(e,t){for(const i of this.portalData[e])t.removePortal(i);this.portalData[e].length=0}addPortals(e,t,i,n){const s=this.nearestAlignedSweep(e,i);if(s){const i=this.entryLinks(e,s),a=this.neighborLinks(e,n);this.portalData[e.id].length=0,this.portalData[e.id].push(...i,...a);for(const i of this.portalData[e.id])t.addPortal(i)}else I.Vy.for(this).debug(`Couldn't find the nearest sweep for a 360 on floor ${e.floorId}; not adding portals`)}nearestAlignedSweep(e,t){const i=[c.AU(e),c.Ol(),c.Zx(),c.sT(e)],n=[h.Io(e.position)],s=t.sortByScore(i,n)[0];return s?s.sweep:null}modelIntersection(e,t,i=1/0){const s=(new n.Vector3).copy(e.position).sub(t.position).setY(0).normalize(),a=this.raycaster.picking.pick(t.position,s,o.c$);return{intersect:a&&a.distance<=i?a:null,rayDirection:s}}entryLinks(e,t){const i=[],s=e.position.distanceTo(t.position),a=this.modelIntersection(e,t,s+P.yb);let o,r,d=!1;a.intersect&&a.intersect.face?(o=a.intersect.face.normal.clone().setY(0).normalize(),Math.abs(a.rayDirection.dot(o))<.3&&o.copy(a.rayDirection).multiplyScalar(-1),r=a.intersect.point.clone().addScaledVector(o,P.Wf)):(o=null,d=!0,r=e.position.clone()),r.y=t.position.y,i.push({index:this.portalCount++,toSweep:e,fromSweep:t,position:r,lookDirection:o,billboard:d,toExterior:!0,fromInterior:!0});const l=(new n.Vector3).lerpVectors(e.position,t.position,2/s).setY(e.position.y);return i.push({index:this.portalCount++,toSweep:t,fromSweep:e,position:l,lookDirection:o?o.clone().negate():null,billboard:d,toExterior:!1,fromInterior:!1}),i}neighborLinks(e,t){const i=[];for(const n of t)if(e!==n&&n.floorId===e.floorId&&e.position.distanceTo(n.position)<P.Ml){const t=e.position.distanceTo(n.position);if(this.modelIntersection(e,n,t).intersect||this.modelIntersection(n,e,t).intersect)continue;const s=e.position.clone().sub(n.position).setY(0).normalize(),a=n.position.clone(),o=P.SM;t>o&&a.addScaledVector(s,t-o),i.push({index:this.portalCount++,toSweep:n,fromSweep:e,position:a,lookDirection:s,billboard:!1,toExterior:!0,fromInterior:!1})}return i}}},21156:(e,t,i)=>{"use strict";i.d(t,{G:()=>s,w:()=>a});var n=i(7478);class s extends n.QB{constructor(e){super(),this.toSweep=e.toSweep,this.toExterior=e.toExterior,this.fromInterior=e.fromInterior,this.meshPosition=e.position}}class a extends n.QB{constructor(e){super(),this.hovered=e}}},66721:(e,t,i)=>{"use strict";i.d(t,{Ml:()=>n,SM:()=>r,Wf:()=>s,_9:()=>o,yb:()=>a});const n=15,s=.1,a=.3,o=.75,r=4},26519:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>T});const n=(0,i(26348).hV)(20);var s=i(64882),a=i(71687),o=i(50018),r=i(2993),d=i(66806),l=i(13893),c=i(10459),h=i(12837),u=i(99583),m=i(61036),p=i(21156),g=i(9997),v=i(25443),f=i(23500),y=i(12103),w=i(77510),b=i(35699);class T extends s.n{constructor(){super(...arguments),this.name="sweep-portal-navigation",this.onChange=()=>{this.portalRenderer.filter((e=>{if(this.settingsData.tryGetSetting(y.Vg,!1))return m.E.HIDE;if(!this.settingsData.tryGetSetting(f.s,!0))return m.E.HIDE;if(!(0,r.nI)(this.viewmodeData.closestMode))return m.E.HIDE;const t=this.sweepData.getSweep(this.sweepData.state.currentSweep||"");if(t)if(t.alignmentType===o.c$.ALIGNED){if(e.fromInterior&&e.toExterior&&e.position.distanceTo(t.position)<n)return m.E.SHOW}else if(t.placementType===o.EO.MANUAL&&e.fromSweep.id===t.id)return m.E.ONTOP;return m.E.HIDE}))}}async init(e,t){this.engine=t,[this.portalRenderer,this.cameraData,this.viewmodeModule,this.viewmodeData,this.sweepData,this.settingsData]=await Promise.all([t.getModuleBySymbol(a.f0),t.market.waitForData(c.M),t.getModuleBySymbol(a.SD),t.market.waitForData(u.X),t.market.waitForData(h.A),t.market.waitForData(v.o)]);const i=(e,i)=>{this.viewmodeData.currentMode&&this.cameraData.canTransition()&&(this.viewmodeData.currentMode!==d.N.Panorama?this.viewmodeModule.switchToMode(d.N.Panorama,l.fl.FadeToBlack,{sweepID:e,rotation:i}):t.commandBinder.issueCommand(new g.aj({sweep:e,rotation:i,transition:l.fl.FadeToBlack})))};this.settingsData.onSettingChanged(f.s,this.onChange),this.settingsData.onSettingChanged(y.Vg,this.onChange),this.bindings.push(t.subscribe(p.G,(e=>{i(e.toSweep.id)})),t.subscribe(p.w,(e=>this.onPortalHover(e.hovered))),this.viewmodeData.onChanged(this.onChange),this.sweepData.onChanged(this.onChange)),this.onChange()}onPortalHover(e){const t=e?w.b.FINGER:null;this.engine.commandBinder.issueCommand(new b.X(t))}}},23461:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>F});var n=i(65945),s=i(64882),a=i(97994),o=i(45987),r=i(53282),d=i(90082),l=i(71687),c=i(23184),h=i(3694),u=i(5984),m=i(72268),p=i(78079),g=i(31002),v=i(10459),f=i(99583),y=i(9997),w=i(90834),b=i(62568),T=i(35699),D=i(77510),S=i(51313),C=i(39209),E=i(63362),A=i(60662),P=i(18855),I=i(22937),k=i(38069);const N=[{outerRadius:1,innerRadius:.97,color:k.V.BLACK.clone(),opacity:.1},{outerRadius:.97,innerRadius:.65,color:k.V.WHITE.clone(),opacity:.64},{outerRadius:.65,innerRadius:.62,color:k.V.BLACK.clone(),opacity:.13}];var x=i(58097),M=i(3956),O=i(57811),R=function(e,t,i,n){var s,a=arguments.length,o=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var r=e.length-1;r>=0;r--)(s=e[r])&&(o=(a<3?s(o):a>3?s(t,i,o):s(t,i))||o);return a>3&&o&&Object.defineProperty(t,i,o),o},L=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},V=function(e,t){return function(i,n){t(i,n,e)}};const j={enabled:N,enabledHover:N};let B=class extends s.n{constructor(e,t,i,n){super(),this.input=e,this.rendererModule=t,this.settingsModule=i,this.sweepDataModule=n,this.name="sweep-pucks",this.defaultCheckRenderModes=()=>!0,this.selectedSweep=new a.L(null),this.unselectingSweep=null,this.selectionBindings=[],this.unselectionBindings=[],this.isHoveringPuck=!1,this.selectionHandled=!0,this.unselectionHandled=!0,this.enableSweepSelection=()=>{this.configure({selectionEnabled:!0})},this.disableSweepSelection=()=>{this.configure({selectionEnabled:!1})},this.setSelected=e=>{if(!this.renderer.options.selectionEnabled)return;const{id:t,active:i,duration:n}=e,s=null!=n?n:x.u4;this.selectedSweep.value&&(this.updateHighlightOnSelectedPuck(!1),this.setHovered({id:this.selectedSweep.value,active:!1,duration:s})),this.selectedSweep.value=t,t&&(this.setHovered({id:t,active:i,duration:s}),this.updateHighlightOnSelectedPuck(!0)),this.updateHandlers()},this.setHovered=e=>{var t;const{id:i,active:n,duration:s}=e,a=null===(t=this.renderer.getPuck(i))||void 0===t?void 0:t.state;if(!a)return;const o=a.hovered,r=1===o.endValue;n!==r&&(!r&&a.selectable?o.modifyAnimation(o.value,1,s):o.modifyAnimation(o.value,0,Math.max(0,s-o.elapsed)))},this.handlePuckClickedMessage=e=>{if(!e)throw new Error("SweepPucks -> on PuckClickedMessage: Tried to move to invalid sweep id.");this.canSelectPuck()||this.sweepDataModule.data.state.canTransition()&&this.cameraData.canTransition()&&this.engine.commandBinder.issueCommand(new y.aj({transition:(0,b.xl)(this.interactionmodeData.mode),sweep:e})),this.needsUpdate()},this.handlePuckHoverMessage=({hovered:e})=>{this.isHoveringPuck=e,this.engine.commandBinder.issueCommand(new T.X(e?D.b.FINGER:null))},this.cursorVisibilityRule=()=>!this.isHoveringPuck,this.updateHandlers=()=>{this.selectionHandled=this.toggleHandlers(this.canSelectPuck(),this.selectionBindings,this.selectionHandled),this.unselectionHandled=this.toggleHandlers(this.canUnselectPuck(),this.unselectionBindings,this.unselectionHandled)},this.unselectPuck=()=>{this.unselectingSweep=null,this.setSelected({id:null,active:!1})},this.onUnselectPuck=e=>{const t=this.selectedSweep.value;return t&&(e.down?this.unselectingSweep=t:this.unselectingSweep&&this.unselectPuck()),!0},this.onPointerMove=()=>{this.unselectingSweep=null},this.onPointerOnPuck=(e,t)=>{if(e.button!==m.m.PRIMARY)return;const i=t.userData.sid;i&&(e.down?i===this.selectedSweep.value?this.unselectingSweep=i:(this.unselectingSweep=null,this.setSelected({id:i,active:!0})):(i===this.unselectingSweep&&this.unselectPuck(),this.unselectingSweep=null))},this.needsUpdate=this.needsUpdate.bind(this)}async init(e,t){this.engine=t,void 0!==e.checkRenderModes&&(this.defaultCheckRenderModes=e.checkRenderModes),[this.cameraData,this.viewmodeData,this.interactionmodeData]=await Promise.all([t.market.waitForData(v.M),t.market.waitForData(f.X),t.market.waitForData(w.O)]);let i=(await t.market.waitForData(C.X)).currentFloorId;this.renderer=new M.Jz((()=>this.selectedSweep.value),(()=>this.viewmodeData.isInside()?null:i),(()=>this.viewmodeData.isInside()),this.setHovered,this.rendererModule.getScene(),this.input,this.settingsModule.settingsData,this.sweepDataModule.data,j,this.defaultCheckRenderModes,t.claimRenderLayer(this.name)),t.addComponent(this,this.renderer),this.bindings.push(t.msgBus.subscribe(S.P,(e=>{i=e.floorId,this.needsUpdate()})),t.commandBinder.addBinding(E.WW,(async e=>{this.setHovered({id:e.id,duration:e.duration,active:e.hovered})})),t.commandBinder.addBinding(E.tA,(async()=>this.enableSweepSelection())),t.commandBinder.addBinding(E._p,(async()=>this.disableSweepSelection())),t.subscribe(A.e,(e=>this.handlePuckClickedMessage(e.sweepId))),t.subscribe(P.n,this.handlePuckHoverMessage),this.sweepDataModule.data.state.onPropertyChanged("currentSweep",(()=>{var e;this.renderer.options.editingEnabled&&this.setSelectedSweep(null!==(e=this.sweepDataModule.data.state.currentSweep)&&void 0!==e?e:null),this.renderer.updateVisibleNeighbors(),this.needsUpdate()})),t.subscribe(o.E5,(()=>this.needsUpdate())),this.viewmodeData.makeModeChangeSubscription((()=>{const e=this.renderer.options.editingEnabled;this.updateHighlightOnSelectedPuck(e),this.updateHandlers(),this.configure({displayNeighborsOnly:this.viewmodeData.isInside()})})),t.subscribe(I.zM,(()=>this.settingsModule.updateSetting(O.f,!1))),t.subscribe(I.pT,(()=>this.settingsModule.updateSetting(O.f,!0)))),t.getModuleBySymbol(l._v).then((e=>{this.bindings.push((0,r.Sh)((()=>e.addVisibilityRule(this.cursorVisibilityRule)),(()=>e.removeVisibilityRule(this.cursorVisibilityRule))))})),this.selectionBindings.push(this.input.registerMeshHandler(p.CD,c.f.isType(M.UJ),this.onPointerOnPuck),this.input.registerHandler(p.$3,this.onPointerMove)),this.unselectionBindings.push(this.input.registerPriorityHandler(g.rX,u.r,(()=>!0)),this.input.registerPriorityHandler(p.CD,u.r,this.onUnselectPuck),this.input.registerPriorityHandler(p.CD,h.W,this.onUnselectPuck)),this.updateHandlers()}needsUpdate(){this.renderer.needsUpdate()}configure(e){!1===e.selectionEnabled&&this.selectedSweep.value&&this.setSelected({id:null,active:!1}),this.renderer.options=Object.assign(Object.assign({},this.renderer.options),e);const t=this.renderer.options.editingEnabled;this.updateHighlightOnSelectedPuck(t),this.updateHandlers(),this.renderer.updateVisibleNeighbors(),this.renderer.needsUpdate()}dispose(e){for(const e of this.bindings)e.cancel();this.bindings=[],this.configure({editingEnabled:!1}),super.dispose(e)}getPuck(e){return this.renderer.getPuck(e)}updatePuckImagery(e={}){const t=Object.assign(Object.assign({},j),e);t.disabled&&!t.disabledHover&&(t.disabledHover=t.disabled),this.renderer.updatePuckImagery(t)}updateCheckRenderModes(e){this.renderer.updateCheckRenderModes(e||this.defaultCheckRenderModes)}getSelectedSweep(){return this.selectedSweep.value}onSelectedSweepChanged(e){return this.selectedSweep.onChanged(e)}setSelectedSweep(e){this.setSelected({id:e,active:!0})}updateHighlightOnSelectedPuck(e){const t=this.selectedSweep.value;if(t){const i=this.renderer.getPuck(t);if(!i||!i.sweep.isAligned())return;const n=this.renderer.options.editingEnabled,s=this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan(),a=e&&n&&s;i.state.selected=a,i.state.commit()}}canUnselectPuck(){const e=this.renderer.options.editingEnabled,t=this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan();return e&&!!this.selectedSweep.value&&t}canSelectPuck(){const e=this.renderer.options.editingEnabled,t=this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan();return e&&t}toggleHandlers(e,t,i){if(e!==i)for(const i of t)e?i.renew():i.cancel();return e}};B=R([(0,n._q)(),V(0,(0,n.y_)(l.mL)),V(1,(0,n.y_)(l.M7)),V(2,(0,n.y_)(d.ZF)),V(3,(0,n.y_)(l.Wh)),L("design:paramtypes",[Object,Object,Object,Object])],B);const F=B},14288:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>l});var n=i(64882),s=i(76318),a=i(68909),o=i(71687);const r=new(i(9139).Vy)("sweep-textures"),d={[s.MF.BASE]:256,[s.MF.STANDARD]:1024,[s.MF.HIGH]:2048,[s.MF.ULTRAHIGH]:4096};class l extends n.n{constructor(){super(...arguments),this.name="sweep-textures",this.sweepCubeTextures={}}async init({sizes:e=d},t){this.api=(await t.getModuleBySymbol(o.qL)).getApi(),this.sizes=e}useTexture(e){const t=this.getTexture(e);if(!t)throw Error("Texture for sweep not loaded before using");return t}loadFace(e,t,i,n){return this.loadFaceImage(e,t,i,n).then((e=>{const t=new a.Texture(e);return t.colorSpace=a.SRGBColorSpace,t.needsUpdate=!0,t}))}load(e,t=s.MF.STANDARD){const i=this.sweepCubeTextures[e.id];if(i)return r.debug("Skipping load of pano, already loaded"),new Promise((function(e,t){e(i)}));const n=[2,4,0,5,1,3].map((i=>this.loadFaceImage(e,t,i))),o=Promise.all(n).then((t=>{const i=new a.CubeTexture(t);return i.flipY=!1,i.needsUpdate=!0,i.colorSpace=a.SRGBColorSpace,this.sweepCubeTextures[e.id]=i,i}));return o.catch((()=>{r.error(`Downloading cubemap for pano ${e.id} failed`)})),o}unload(e){var t;const i=this.sweepCubeTextures[e];if(!i)throw Error("Texture for sweep not loaded before unloading");i.dispose(),null===(t=i.images)||void 0===t||t.forEach((e=>{var t,i;null===(i=(t=e).close)||void 0===i||i.call(t)})),this.sweepCubeTextures[e]=null}async loadFaceImage(e,t,i,n){const s=this.sizes[t],a=await e.getFaceUrl(t,i);return this.api.getImageBitmap(a,s,s,n)}getTexture(e){return this.sweepCubeTextures[e]}}},44447:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelTagEditsCommand:()=>M.J9,CloseTagCommand:()=>M.KH,DeleteTagCommand:()=>M.RL,EditTagCommand:()=>M.YN,FilterVisibleTagsCommand:()=>M.$m,OpenTagCommand:()=>M.Ki,RegisterTagsToolCommand:()=>M.eo,SaveCustomTagOrderCommand:()=>M.mg,SaveTagCommand:()=>M.Bu,SaveTagVisibilityCommand:()=>M.br,SetEmbedErrorTagIdCommand:()=>M.kd,SetTagOrderByCommand:()=>M.l7,SetTagsModeCommand:()=>M.ir,StartNewTagCommand:()=>M.aH,TagOrderBy:()=>x.k,TagsMode:()=>x.j,TagsToolToggleCommand:()=>M.NR,TagsViewData:()=>ue.r,TagsVisibilityFilterEnabledCommand:()=>M.wJ,ToggleDirtyTagStateCommand:()=>M.jC,UpdateOpenTagViewCommand:()=>M.OT,default:()=>Oe});var n=i(64882),s=i(14614),a=i(1284),o=i(71687),r=i(94165),d=i(74381),l=i(56147),c=i(45205),h=i(32024);const u=i.p+"images/tagColor.png";var m=i(81530),p=i(13893),g=i(9997),v=i(39905),f=i(42110),y=i(40899),w=i(72354),b=i(24675),T=i(50636),D=i(62802),S=i(58899),C=i(84917),E=i(51831),A=i(32408),P=i(25727),I=i(71188);class k extends S.r{constructor(e,t,i,n,s,a,o,r,l){super(e,t,i),this.annotationsModule=n,this.containerData=s,this.tag=a,this.tagIconsEnabled=r,this.defaultTagLabel=l,this.onSelect=async()=>{this.annotationsModule.closeOtherAnnotations(),await this.commandBinder.issueCommand(new g.E4({pinPosition:this.tag,transition:p.fl.FadeToBlack})),(0,I.w)(this.containerData.size)?this.annotationsModule.dockAnnotation(this.id,this.layerId,E.U.TAG):this.annotationsModule.selectAnnotation(this.id,this.layerId,E.U.TAG)},this.textParser=o,this.id=this.tag.id,this.title=this.tag.label||this.textParser.getPlainText(this.tag.description)||this.defaultTagLabel,this.description=this.tag.label?this.textParser.getPlainText(this.tag.description):"",this.icon=`icon-${(0,A.RN)(P.yY.MATTERTAG,this.tag.icon,this.tagIconsEnabled)}`,this.typeId=d.jM.MATTERTAG,this.floorId=this.tag.floorId,this.roomId=this.tag.roomId||"",this.layerId=this.tag.layerId,this.dateBucket=(0,C.n)(this.tag.created),this.color=this.tag.color,this.enabled=this.tag.enabled}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}}var N=i(82748),x=i(35826),M=i(99104),O=i(94547),R=i(13767);const{TAGS:L}=l.A.SHOWCASE,V=new v.r({links:!0}),j="0"===(0,N.P3)("mt");function B(e,t,i,n,a,o,r,l,c){let h=r.application===s.lg.WORKSHOP;const u=o.tryGetSetting(R.Jr,!1),m=(t,s,o,r=[])=>{const d=[];return(i.tagOrder===x.k.ALPHABETICAL?i.getAlphabeticTagViewMapFilter().values:i.getOrderedTagViewMapFilter().values).forEach((i=>{if(!(h||i.enabled&&n.layerToggled(i.layerId)))return;if(i.objectAnnotationId)return;let o=t(i.label,V.getPlainText(i.description));o&&r.length>0&&(o=i.keywords.length>0&&i.keywords.some((e=>r.includes(e)))),o&&d.push(new k(e,n,s,l,a,i,V,u,c))})),e.issueCommand(new M.$m(d.map((e=>e.id)))),d},p=t=>{e.issueCommand(new M.wJ(!!t))},g=e=>new D.P(i.getOrderedTagViewMapFilter().onChanged(e),i.onPropertyChanged("tagOrder",e)),v={renew:()=>{e.issueCommandWhenBound(new O.Oc({id:d.jM.MATTERTAG,groupPhraseKey:L.SEARCH_GROUP_HEADER,getSimpleMatches:m,registerChangeObserver:g,onSearchActivatedChanged:p,getKeywords:t.getTagKeywords.bind(t),groupOrder:20,groupIcon:"toolbar-mattertags",batchSupported:!0}))},cancel:()=>{e.issueCommandWhenBound(new O.tf(d.jM.MATTERTAG))}},f=e=>{h=e===s.lg.WORKSHOP;!j||h?v.renew():v.cancel()},y=r.onPropertyChanged("application",f);return f(r.application),new D.P(v,y)}var F,H=i(7478);class U extends H.QB{constructor(e,t,i){super(),this.sid=e,this.position=t,this.distanceFromCamera=i}}class _ extends H.QB{constructor(e,t){super(),this.sid=e,this.removeMethod=t}}class G extends H.QB{constructor(e,t){super(),this.sid=e,this.characterCount=t}}class z extends H.QB{constructor(e,t,i){super(),this.sid=e,this.characterCount=t,this.tagDescriptionChunks=i}}class $ extends H.QB{constructor(e,t,i){super(),this.sid=e,this.mediaType=t,this.mediaSrc=i}}class W extends H.QB{constructor(e,t,i){super(),this.sid=e,this.property=t,this.value=i}}class Y extends H.QB{constructor(e,t,i,n){super(),this.sid=e,this.position=t,this.distanceFromCamera=i,this.distanceMoved=n}}!function(e){e.DISC_COLOR="disc_color",e.STEM_VISIBLE="stem_visible",e.STEM_LENGTH="stem_length",e.TITLE="title",e.DESCRIPTION="description",e.MEDIA="media",e.LINKS="links",e.ENABLED="enabled",e.KEYWORDS="keywords"}(F||(F={}));var K=i(11416),X=i(79457),q=i(30926),Q=i(40409),J=i(23864),Z=i(17084),ee=i(73566),te=i(20246),ie=i(96319),ne=i(81088),se=i(11864),ae=i(44482),oe=i(11779),re=i(98241),de=i(75522),le=i(96437),ce=i(35956),he=i(29479),ue=i(93821),me=i(3101),pe=i(39209),ge=i(12837),ve=i(25443),fe=i(99583),ye=i(26482),we=i(10459),be=i(58229),Te=i(47737),De=i(78115),Se=i(80419),Ce=i(25903),Ee=i(58480),Ae=i(94502),Pe=i(73554),Ie=i(57416),ke=i(9139),Ne=i(12103),xe=i(21693);class Me extends n.n{constructor(){super(...arguments),this.name="tags-module",this.opening=null,this.activated=!1,this.registered=!1,this.activeBindings=[],this.tagsViewNeedsUpdate=!1,this.updatePerSettings=()=>{const e=this.settingsData.tryGetSetting(de.qE,!1),t=this.settingsData.tryGetSetting(Ne.Vg,!1),i=!this.in360View()&&e&&!t;this.pinsModule.changePinVisibilityByType(P.yY.MATTERTAG,i),i||this.closeTagBillboard()},this.registerTagsTool=async()=>{const e=new J.N(Object.assign(Object.assign({},xe.P),{ui:new Ae.a,manager:new Pe.l(this.engine,this.settingsData)}));this.engine.commandBinder.issueCommand(new Z.Kw([e]))},this.tagsToolToggled=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.updateViewingControls=()=>{const{openTagView:e}=this.viewData,t=this.toolsData.toolPanelLayout===ee.L$.BOTTOM_PANEL,i=!this.activated||!t&&!e;this.engine.broadcast(new te.Vk(i))},this.onCloseTag=async()=>{this.closeTag()},this.pinAddCancelled=e=>{e.pinType===P.yY.MATTERTAG&&this.cancelTagCreation(!1)},this.cancelTagEdits=async()=>{this.viewData.creatingTag?this.cancelTagCreation(!0):this.closeTag()},this.cancelTagCreation=e=>{var t;const i=this.viewData,n=null===(t=i.openTagView)||void 0===t?void 0:t.id;if(this.cancelAttachmentChanges(),i.setOpenTagView(null),i.creatingTag=!1,i.openTagIsDirty=!1,i.commit(),n){if(e)try{this.pinsModule.cancelNewPin(n,P.yY.MATTERTAG)}catch(e){ke.Vy.for(this).error("Failed to cancel new pin:",e)}this.annotationsModule.closeAnnotation(n,E.U.TAG)}},this.tagsWereChanged=()=>{this.tagsViewNeedsUpdate=!0,this.viewData.notifyOrderedMapsMightHaveChanged()},this.refreshTagViews=()=>{this.viewData.refreshTagViews(this.getCustomTagOrder())},this.onTagRemoved=e=>{const t=e.objectAnnotationId?P.yY.OBJECT:P.yY.MATTERTAG;this.pinsModule.removePin(e.sid,t)},this.handleModelViewChange=()=>{if(this.viewData.openTagView)if(this.viewData.creatingTag)this.cancelTagCreation(!0);else{this.tagsData.getTag(this.viewData.openTagView.id)||this.closeTag()}},this.onLayersChanged=()=>{this.closeTagBillboard(),this.displayTags()},this.onOpenTagViewChanged=()=>{const e=this.viewData.openTagView;e&&this.updateTagPin(e)},this.startTagCreation=async()=>{const e=this.viewData;e.setTagsMode(x.j.DEFAULT),await this.closeTag();let t=(0,c.D)(11);for(;this.tagsData.getTag(t);)t=(0,c.D)(11);const i=new ce.Q;i.sid=t,i.floorId=this.floorsViewData.getHighestVisibleFloor().id,i.layerId=this.layersData.activeLayerId,i.anchorPosition.y=1e9;const n=e.createTagView(i);return e.creatingTag=!0,e.commit(),e.setOpenTagView(n),this.pinsModule.createPin(n.id,this.getPinUpdate(n),P.yY.MATTERTAG,n.backgroundTexture),t},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:s,embed:a}=e,o=this.viewData,{openTagView:r,creatingTag:d}=o;if(!r)return void ke.Vy.for(this).debug("No open tag");const l=Object.assign({},r,i);this.trackChanges(t,l,a),d?(o.creatingTag=!1,o.openTagIsDirty=!1,o.commit(),await this.engine.commandBinder.issueCommand(new le.Ee(t,l,n,a))):await this.engine.commandBinder.issueCommand(new le.vZ(t,l,n,s,a)),l.objectAnnotationId||this.selectPin(t,!0),await this.attachmentsModule.resetAttachmentChanges(),this.closeTag()},this.saveTagVisibility=async e=>{const{id:t,visible:i}=e,n=this.tagsData.getTag(t);if(!n)throw new Error("Tag not found!");this.pinsModule.changePinVisibility(t,P.yY.MATTERTAG,this.getTagVisibility(t,n.layerId,i));const s={enabled:i};return this.trackChanges(t,s),i||this.closeTag(),this.engine.commandBinder.issueCommand(new le.vZ(t,s))},this.onDeleteTag=async e=>{const t=e.id;this.tagsData.getTag(t)?(this.toggleTagDirty(!1),this.engine.commandBinder.issueCommand(new ne.rH),this.engine.broadcast(new _(t,e.removalMethod)),this.engine.commandBinder.issueCommand(new le.l(t)).then((()=>{this.saveTags().then((()=>{this.pinsModule.removePin(t,P.yY.MATTERTAG);const e=this.viewData.openTagView;e&&e.id===t&&this.closeTag()}))})),this.attachmentsModule.resetAttachmentChanges()):ke.Vy.for(this).debug("Cannot delete a non-existent tag")},this.onEditTag=async e=>{const{tagId:t}=e,i=this.tagsData.getTag(t);i?(this.attachmentsModule.resetAttachmentChanges(),await this.openTag(t,p.fl.FadeToBlack,!0,!0),this.openAnnotation(t,i.layerId,!0),this.selectPin(t,!0)):ke.Vy.for(this).debug("Cannot edit a non-existent tag")},this.updateOpenTagView=async e=>{const{updates:t}=e,i=this.viewData.openTagView;if(i){this.viewData.setOpenTagView(Object.assign(Object.assign({},i),t));const e=i.objectAnnotationId||i.id,n=i.objectAnnotationId?P.yY.OBJECT:P.yY.MATTERTAG;this.pinsModule.updatePin(e,n,t)}else ke.Vy.for(this).debug("No open tag to update")},this.onSaveCustomTagOrder=async e=>{const{ids:t}=e,i=t.map((e=>({id:e,type:se._.TAG})));await this.engine.commandBinder.issueCommand(new ae.lr(re.K,i)),this.viewData.refreshTagViews(t)},this.setEmbedErrorTagId=async e=>{this.viewData.setEmbedErrorTagId(e.id)},this.pinMoved=e=>{const{id:t,pinType:i,pinPos:n,previousPos:s}=e,a=this.viewData.openTagView;if(a&&i===P.yY.MATTERTAG&&t===a.id){if(this.tagsData.getTag(t)){const{anchorPosition:e,stemNormal:i,floorId:a,roomId:o}=n,r={position:e,normal:i,floorId:a,roomId:o};this.engine.broadcast(new Y(t,r.position,r.position.distanceTo(this.cameraData.pose.position),s?r.position.distanceTo(s.anchorPosition):0)),this.engine.commandBinder.issueCommand(new le.vZ(t,r))}else ke.Vy.for(this).debug("Cannot move a non-existent tag")}},this.pinPlaced=e=>{const{openTagView:t}=this.viewData;t&&e.pinType===P.yY.MATTERTAG&&e.id===t.id&&(Object.assign(t,e.pinPos),this.openAnnotation(t.id,t.layerId,!0))},this.handlePinFocusChange=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t)return;const{focusedPin:i,selectedPinId:n}=this.pinsViewData,{billboardAnnotation:s}=this.annotationsViewData;if(!i)return void(s&&s.annotationType===E.U.TAG&&s.id!==n&&this.annotationsModule.closeAnnotation(s.id,E.U.TAG));const a=this.getSelectedTag(),o=a&&(null==a?void 0:a.id)===(null==e?void 0:e.id),r=e&&(null==e?void 0:e.id)===(null==i?void 0:i.id);if(e&&o&&!r&&this.closeTag(),i.pinType===P.yY.MATTERTAG){const t=this.viewData.getTagView(i.id);if(!t)return void ke.Vy.for(this).debug("Focused pin changed, but no tag view.");t.id!==(null==e?void 0:e.id)&&(this.annotationsModule.previewAnnotation(t.id,t.layerId,E.U.TAG),this.engine.broadcast(new Se.T8(t.id,Ce.h.HOVER)))}},this.handlePinSelectionChange=async()=>{const{openTagView:e,openTagIsDirty:t}=this.viewData,{selectedPinId:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===i)return;const n=i?this.pinsViewData.getPin(i):null,a=this.appData.application===s.lg.WORKSHOP;if(e&&!n)!a&&this.activated?await this.engine.commandBinder.issueCommand(new Z.u3(ee.S0.TAGS)):this.closeTag();else if(n&&n.pinType===P.yY.MATTERTAG){(0,I.w)(this.containerData.size)&&this.annotationsModule.dockAnnotation(n.id,n.layerId,E.U.TAG);const e=this.isTagDocked()||!!this.getSelectedTag(),t=a&&e;this.pinsModule.togglePinEditing(n.id,t),this.engine.broadcast(new Se.T8(n.id,Ce.h.OPEN));const i=this.isDocking();await this.openTag(n.id,p.fl.Interpolate,i),this.openAnnotation(n.id,n.layerId,i)}},this.isDocking=()=>(0,I.w)(this.containerData.size)||this.activated&&this.isTagDocked(),this.handleAnnotationsChanged=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t||this.opening)return;const i=this.getDockedTag(),n=this.getSelectedTag(),a=i||n,o=!!i,{dockedAnnotation:r}=this.annotationsViewData;if(e&&!a&&(null==r?void 0:r.annotationType)!==E.U.OBJECT)this.closeTag();else if(a&&a.id!==(null==e?void 0:e.id)){this.engine.broadcast(new Se.T8(a.id,Ce.h.OPEN));const e=this.appData.application!==s.lg.WORKSHOP||!o;await this.openTag(a.id,p.fl.Interpolate,o,e),this.selectPin(a.id,o)}o?(this.activated||await this.engine.commandBinder.issueCommand(new Z.Wm(ee.S0.TAGS,!0)),a&&this.selectPin(a.id,o)):this.activated&&this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new Z.u3(ee.S0.TAGS))},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==E.U.TAG)return;const s=this.viewData.getTagView(i);if(!s)return void ke.Vy.for(this).debug("Cannot view attachment for a non-existent tag");const a=s.attachments,o=a.find((e=>e.id===n));if(o&&(0,me.rV)(o)){const e=a.filter((e=>(0,me.rV)(e)));this.attachmentsModule.toggleAttachmentViewer(!0,e,n)}},this.onOpenTag=async e=>{const{tagId:t,dock:i,transition:n,objectTag:s,forceOpen:a}=e;this.toggleTagDirty(!1);const o=this.annotationsViewData.getCapabilities(t).dock,r=!(!i||!o),d=null===i&&this.isTagDocked()&&o,l=r||d||!(!i||!a);if(l&&s)return void this.dockObjectTag(t);const c=this.tagsData.getTag(t);await this.openTag(t,n,l),this.openAnnotation(t,c.layerId,l,a),this.selectPin(t,l)},this.filterVisibleTags=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayTags()},this.tagVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayTags()},this.setTagOrderBy=async({order:e})=>{e!==this.viewData.tagOrder&&(this.viewData.tagOrder=e,this.viewData.commit())},this.setTagsMode=async({mode:e})=>{e===x.j.REORDERING&&this.closeTag(),this.viewData.setTagsMode(e)}}async init(e,t){const[i,n,a,d,c,m,p,g,b,T,D,S,C,E]=await Promise.all([t.market.waitForData(we.M),t.market.waitForData(he.j),t.market.waitForData(ie.M),t.market.waitForData(ge.A),t.market.waitForData(ve.o),t.market.waitForData(fe.X),t.getModuleBySymbol(o.Et),t.market.waitForData(q.o),t.market.waitForData(s.zH),t.market.waitForData(pe.X),t.market.waitForData(oe.Y),t.market.waitForData(Te.P),t.market.waitForData(Ee.G),t.getModuleBySymbol(o.gS)]),[A,P,I,k,N]=await Promise.all([t.market.waitForData(be.q),t.market.waitForData(ye.G),t.getModuleBySymbol(r.r),t.getModuleBySymbol(o.qy),t.getModuleBySymbol(o.kd)]);this.cameraData=i,this.tagsData=n,this.toolsData=a,this.sweepData=d,this.settingsData=c,this.viewmodeData=m,this.annotationsViewData=g,this.annotationsModule=p,this.attachmentsModule=k,this.pinsModule=N,this.appData=b,this.floorsViewData=T,this.orderedListData=D,this.layersData=S,this.containerData=C,this.engine=t,this.backgroundTexture=(0,h.y)(u),this.descriptionParser=new f.g({supportLinks:!0,keepLinkLabels:!0});const x=new v.r({links:!0,hashtags:!1}),O=this.getCustomTagOrder(),R=E.t(l.A.WORKSHOP.MATTERTAGS.DEFAULT_TAG_TITLE);this.viewData=new ue.r(this.tagsData,A,P,O,x,I,R,this.backgroundTexture,e.objectTagsEnabled),this.pinsViewData=await t.market.waitForData(K.U),this.bindings.push(c.onSettingChanged(de.qE,this.updatePerSettings),c.onSettingChanged(Ne.Vg,this.updatePerSettings),t.commandBinder.addBinding(M.eo,this.registerTagsTool),t.commandBinder.addBinding(M.NR,this.tagsToolToggled),t.subscribe(Q.z,this.handleViewingAttachment),t.subscribe(y.A,this.updatePerSettings),t.subscribe(w.b,this.updatePerSettings),m.makeModeChangeSubscription(this.updatePerSettings),t.commandBinder.addBinding(M.KH,this.onCloseTag),t.commandBinder.addBinding(M.Ki,this.onOpenTag),t.commandBinder.addBinding(M.ir,this.setTagsMode),t.commandBinder.addBinding(M.l7,this.setTagOrderBy),t.commandBinder.addBinding(M.Bu,this.saveTag),t.commandBinder.addBinding(M.jC,(async e=>this.toggleTagDirty(e.dirty))),t.commandBinder.addBinding(M.RL,this.onDeleteTag),t.commandBinder.addBinding(M.br,this.saveTagVisibility),t.commandBinder.addBinding(M.YN,this.onEditTag),t.commandBinder.addBinding(M.OT,this.updateOpenTagView),t.commandBinder.addBinding(M.kd,this.setEmbedErrorTagId),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.annotationsViewData.onChanged(this.handleAnnotationsChanged),this.viewData.onOpenTagViewChanged(this.onOpenTagViewChanged),this.orderedListData.onChanged(this.refreshTagViews),this.tagsData.onChanged(this.tagsWereChanged),this.tagsData.collection.onElementChanged({onRemoved:this.onTagRemoved}),this.appData.onChanged((()=>this.displayTags())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),this.layersData.onPropertyChanged("activeLayerId",(()=>this.updatePendingTag())),t.commandBinder.addBinding(M.$m,this.filterVisibleTags),t.commandBinder.addBinding(M.wJ,this.tagVisbilityFilterEnabled),t.subscribe(De.tj,this.handleModelViewChange)),t.market.register(ue.r,this.viewData),this.updatePerSettings(),this.displayTags();const L=B(t.commandBinder,this.tagsData,this.viewData,this.layersData,C,this.settingsData,this.appData,this.annotationsModule,R);this.bindings.push(L)}dispose(e){this.deactivateTool(!0),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.pinsModule.removePinsByType(P.yY.MATTERTAG),this.backgroundTexture.dispose(),super.dispose(e)}updateTagViews(){this.refreshTagViews(),this.displayTags()}onUpdate(){this.tagsViewNeedsUpdate&&(this.tagsViewNeedsUpdate=!1,this.updateTagViews())}activateTool(){this.activated||(this.annotationsModule.closeOtherAnnotations(E.U.TAG),this.pinsModule.enablePinCreation(!0),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0,this.updateViewingControls())}deactivateTool(e){if(!this.activated)return;this.activated=!1;const{creatingTag:t,openTagView:i,tagsMode:n}=this.viewData;n!==x.j.DEFAULT&&this.viewData.setTagsMode(x.j.DEFAULT),t?this.cancelTagCreation(!0):i&&this.closeTag(),this.pinsModule.clearPinSelection(),this.pinsModule.enablePinCreation(!1),this.activeBindings.forEach((e=>{e.cancel()})),this.updateViewingControls(),this.attachmentsModule.resetAttachmentChanges()}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(X.yi,this.pinPlaced),this.engine.subscribe(X.cC,this.pinMoved),this.engine.subscribe(X.lY,this.pinAddCancelled),e.addBinding(M.aH,this.startTagCreation),e.addBinding(M.J9,this.cancelTagEdits),e.addBinding(M.mg,this.onSaveCustomTagOrder),this.viewData.onOpenTagViewChanged(this.updateViewingControls),this.viewData.onPropertyChanged("creatingTag",this.updateViewingControls),this.viewData.onPropertyChanged("tagsMode",(()=>this.displayTags()))),this.registered=!0}closeTagBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===E.U.TAG&&this.annotationsModule.closeAnnotation(e.id,E.U.TAG)}in360View(){const e=this.sweepData.state.currentSweep?this.sweepData.state.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeTag(){const{commandBinder:e}=this.engine,t=this.viewData,{openTagView:i}=t;if(this.toggleTagDirty(!1),i){const{id:n,layerId:s,enabled:a}=i;t.setOpenTagView(null),this.cancelAttachmentChanges(),e.issueCommand(new O.Xx(null)),this.attachmentsModule.toggleAttachmentViewer(!1);const o=this.tagsData.getTag(n);o&&(this.pinsModule.unselectPin(n,P.yY.MATTERTAG),o.objectAnnotationId?this.pinsModule.removePin(n,P.yY.MATTERTAG):(this.pinsModule.changePinVisibility(n,P.yY.MATTERTAG,this.getTagVisibility(n,s,a)),this.pinsModule.updatePin(n,P.yY.MATTERTAG,o.getPin()))),this.annotationsModule.closeAnnotation(n,E.U.TAG)}this.attachmentsModule.resetAttachmentChanges()}getTagVisibility(e,t,i){const{openTagView:n,idVisibilityEnabled:a,idVisibility:o,tagsMode:r}=this.viewData,d=this.appData.application===s.lg.WORKSHOP||this.layersData.layerToggled(t),l=this.layersData.layerVisible(t),c=r===x.j.REORDERING,h=!a||o.has(e),u=(null==n?void 0:n.id)===e;return d&&(u||i&&c||i&&h&&l)}displayTags(){const e=[];this.viewData.getOrderedTags(!1).forEach((t=>{if(!t.objectAnnotationId){const i=this.getPinUpdate(t);e.push(i)}})),this.pinsModule.updatePinViews(e)}updateTagPin(e){if(!e.objectAnnotationId){const t=this.getPinUpdate(e);this.pinsModule.updatePinViews([t])}}getPinUpdate(e){const{openTagView:t}=this.viewData,i=t&&t.id===e.id?t:e,{id:n,layerId:s,enabled:a,anchorPosition:o,color:r,icon:d,stemEnabled:l,floorId:c,roomId:h,stemNormal:u,stemLength:m}=i;return{id:n,anchorPosition:o,color:r,layerId:s,floorId:c,roomId:h,stemEnabled:l,stemNormal:u,stemLength:m,pinType:P.yY.MATTERTAG,backgroundTexture:this.backgroundTexture,icon:d,visible:this.getTagVisibility(n,s,a)}}updatePendingTag(){const{creatingTag:e,openTagView:t}=this.viewData;e&&t&&(this.layersData.isInMemoryLayer(t.layerId)||(t.layerId=this.layersData.activeLayerId))}async cancelAttachmentChanges(){return this.attachmentsModule.cancelAttachmentChanges()}toggleTagDirty(e){this.viewData.openTagIsDirty=e,this.viewData.commit()}getCustomTagOrder(){const e=this.orderedListData.getOrderedList(re.K);return e?e.entries.map((e=>e.id)):[]}async saveTags(){this.engine.commandBinder.issueCommand(new m.F({dataTypes:[a.p.MATTERTAGS]}))}openAnnotation(e,t,i,n=!1){const s=this.annotationsViewData.getCapabilities(e);i?(s.dock||n)&&this.annotationsModule.dockAnnotation(e,t,E.U.TAG,n):(s.preview||n)&&this.annotationsModule.selectAnnotation(e,t,E.U.TAG,n)}selectPin(e,t=!1){const i=t&&this.activated&&this.appData.application===s.lg.WORKSHOP;t?this.engine.broadcast(new Se.T8(e,Ce.h.DOCKED)):this.engine.broadcast(new Se.T8(e,Ce.h.OPEN)),this.pinsModule.selectPin(e,P.yY.MATTERTAG,i)}dockObjectTag(e){const t=this.viewData.getTagView(e);t?(this.annotationsModule.dockAnnotation(e,null,E.U.OBJECT),this.viewData.setOpenTagView(Object.assign({},t)),this.selectPin(e,!0),this.toolsData.toolCollapsed&&this.engine.commandBinder.issueCommand(new Z.li(!1))):ke.Vy.for(this).debug("Cannot dock a non-existent tag")}async openTag(e,t,i,n=!0){const s=this.viewData,a=s.getTagView(e);if(a){const{openTagView:o,tagsMode:r}=this.viewData,{commandBinder:l}=this.engine,{dockedAnnotation:c,selectedAnnotation:h}=this.annotationsViewData;i&&r===x.j.REORDERING&&s.setTagsMode(x.j.DEFAULT),i&&this.toolsData.toolCollapsed&&this.activated&&l.issueCommand(new Z.li(!1));const u=(null==o?void 0:o.id)===e;if(u&&this.activated===i)return void ke.Vy.for(this).debug("Tag is already open and "+(i?"docked":"undocked"));if(i!==!!c){const t=this.annotationsViewData.getCapabilities(e);i?t.dock&&!this.activated&&await this.engine.commandBinder.issueCommand(new Z.Wm(ee.S0.TAGS,!0)):c&&this.annotationsModule.closeAnnotation(c.id,c.annotationType)}if(!u&&this.opening!==e){this.opening=e,l.issueCommand(new ne.rH),h&&h.id!==e&&this.annotationsModule.closeAnnotation(h.id,h.annotationType),s.setOpenTagView(Object.assign({},a));const i=s.getCapabilities(e);null!==t&&i.focus&&(n||this.viewmodeData.isInside())&&await this.engine.commandBinder.issueCommand(new g.E4({pinPosition:a,transition:t})).then((()=>{this.engine.broadcast(new Se.Yt(a.id))})),this.engine.commandBinder.issueCommand(new O.Xx(a.id,d.jM.MATTERTAG)),setTimeout((()=>{this.opening=null}),0)}}else ke.Vy.for(this).debug("Cannot open a non-existent tag")}isTagDocked(){const{dockedAnnotation:e}=this.annotationsViewData;return(null==e?void 0:e.annotationType)===E.U.TAG}getDockedTag(){const{dockedAnnotation:e}=this.annotationsViewData;return e&&e.annotationType===E.U.TAG?this.viewData.getTagView(e.id):null}getSelectedTag(){const{billboardAnnotation:e,billboardSelected:t}=this.annotationsViewData;return e&&t&&e.annotationType===E.U.TAG||(null==e?void 0:e.annotationType)===E.U.OBJECT?this.viewData.getTagView(e.id):null}trackChanges(e,t,i){const n=this.tagsData.getTag(e),{position:s,color:a,description:o,label:r,stemHeight:d,stemVisible:l,enabled:c,keywords:h}=t;if(!n&&s)return void this.engine.broadcast(new U(e,s,s.distanceTo(this.cameraData.pose.position)));if(void 0!==c&&n.enabled!==c&&this.engine.broadcast(new W(e,F.ENABLED,c)),a){const t=new Ie.I(a.r,a.g,a.b).getHexString();n.color.getHexString()!==t&&this.engine.broadcast(new W(e,F.DISC_COLOR,`#${t}`))}if(void 0!==d&&n.stemHeight!==d&&this.engine.broadcast(new W(e,F.STEM_LENGTH,d)),void 0!==l&&n.stemVisible!==l&&this.engine.broadcast(new W(e,F.STEM_VISIBLE,l)),void 0!==r&&n.label!==r&&(this.engine.broadcast(new W(e,F.TITLE,r.length)),this.engine.broadcast(new G(e,r.length))),void 0!==o&&n.description!==o){this.engine.broadcast(new W(e,F.DESCRIPTION,o.length));const t=this.descriptionParser.parse(o,this.layersData.getNonworkshopViewId());this.engine.broadcast(new z(e,o.length,t));const i=f.g.getNumLinks(t);f.g.getNumLinks(n.parsedDescription)!==i&&this.engine.broadcast(new W(e,F.LINKS,i))}if(i){const t=i?i.src:"",s=i?(0,b.KP)(i.mediaType):T.q.none;n.mediaSrc===t&&n.mediaType===s||(this.engine.broadcast(new W(e,F.MEDIA,s)),this.engine.broadcast(new $(e,s,t)))}const u=n.keywords.every((e=>!!h&&h.includes(e)));if((null==h?void 0:h.length)!==n.keywords.length||!u){const t=(null==h?void 0:h.length)||0;this.engine.broadcast(new W(e,F.KEYWORDS,t))}}}const Oe=Me},73586:(e,t,i)=>{"use strict";i.d(t,{i:()=>a});var n=i(76185),s=i(68920);class a{constructor(e){this.waitingGets=new Map,this.comparer=e||this.defaultComparer,this.poolArray=[]}add(e,t=!0){const i=this.createObjectDescriptor(e);return i.object=e,i.inUse=t,this.addObjectDescriptorToPool(i),i}get(e){for(const t of this.poolArray)if(!t.inUse&&this.comparer(t,e))return t.inUse=!0,t;return null}async tryGetAndWait(e){const t=this.get(e);if(t)return Promise.resolve(t);{const t=e||"no-criteria";this.waitingGets.has(t)||this.waitingGets.set(t,[]);const i=this.waitingGets.get(t);(0,n.$)(i);const a=new s.i;return i.push(a),a.nativePromise()}}free(e){for(const t of this.poolArray)if(t.object===e){const e=this.isWaitingForObject(t);return e?e.resolve(t):t.inUse=!1,!0}return!1}isWaitingForObject(e){if(this.waitingGets.size>0)for(const[t,i]of this.waitingGets.entries())if(i.length>0){if("no-criteria"===t||this.comparer(e,t)){const e=i.shift();if(e)return e}}return null}all(){return this.poolArray}defaultComparer(e,t){return!0}createObjectDescriptor(e){return{object:e,inUse:!1}}addObjectDescriptorToPool(e){this.poolArray.push(e)}}},64713:(e,t,i)=>{"use strict";i.d(t,{Z:()=>n});const n=(e=[])=>{const t={};for(const i of e)t[i]=!0;return t}},84440:(e,t,i)=>{"use strict";i.d(t,{Mq:()=>d,Zd:()=>r,_o:()=>l});var n=i(68909);const s=()=>Math.random(),a={},o={},r=(e,t=s())=>(a[t]||(a[t]=new n.Vector4(s(),s(),s(),e)),a[t]),d=(e=s())=>(o[e]||(o[e]=new n.Color(s(),s(),s())),o[e]),l=e=>e instanceof Object&&"r"in e&&"g"in e&&"b"in e},80783:(e,t,i)=>{"use strict";i.d(t,{h:()=>s});var n=i(7478);class s extends n.QB{constructor(e,t){super(),this.width=e,this.height=t}}},81547:(e,t,i)=>{"use strict";var n;i.d(t,{D:()=>n}),function(e){e[e.Immediate=0]="Immediate",e[e.NextFrame=1]="NextFrame",e[e.Duration=2]="Duration",e[e.Manual=3]="Manual",e[e.Debounced=4]="Debounced"}(n||(n={}))},97234:(e,t,i)=>{"use strict";i.d(t,{Xw:()=>n,gj:()=>d,jz:()=>l});var n,s=i(64200),a=i(5894),o=i(75772),r=i(81547);!function(e){e.added="added",e.removed="removed",e.updated="updated"}(n||(n={}));class d{constructor(e,t,i){this.index=e,this.action=t,this.diff=i}}class l{constructor(e,t){if(this.changedHandlers=[],this.awaitingInvoke=!1,this.diffRecord=[],this.targetMonitors={},this.triggerChangeHandlers=this.invokeChangeHandlers.bind(this),this.config=e,this.updatePhaseSync=t,this.config.aggregationType===r.D.NextFrame){if(!t)throw Error("UpdatePhaseSync required for NextFrame aggregation")}else{if(this.config.aggregationType===r.D.Duration)throw Error("Aggregation Type not implemented");this.config.aggregationType===r.D.Debounced&&(this.triggerChangeHandlers=(0,s.s)(this.invokeChangeHandlers.bind(this),e.aggregationDuration))}}hasDiffRecord(){return this.diffRecord.length>0}clearDiffRecord(){this.diffRecord=[];for(const e in this.targetMonitors){const t=this.targetMonitors[e];t.hasDiffRecord()&&t.clearDiffRecord()}this.awaitingInvoke=!1}onChanged(e){this.changedHandlers.push(e)}removeOnChanged(e){(0,a.Nz)(this.changedHandlers,e)}invokeCallbacks(e){if(this.changedHandlers.length>0)for(const t of this.changedHandlers)t(e)}invokeChangeHandlers(e){var t;switch(this.config.aggregationType){case r.D.Immediate:case r.D.Debounced:this.invokeCallbacks(e);break;case r.D.NextFrame:this.awaitingInvoke||(this.awaitingInvoke=!0,null===(t=this.updatePhaseSync)||void 0===t||t.after(o.R.End).then((()=>{this.awaitingInvoke&&(this.invokeCallbacks(e),this.awaitingInvoke=!1)})));case r.D.Manual:}}}},92953:(e,t,i)=>{"use strict";i.d(t,{F:()=>o});var n=i(69304),s=i(97234),a=i(56287);class o extends s.jz{constructor(e,t,i){super(t,i),this.target=e;for(const n of e.keys){const s=e.get(n),o=new a.V(s,t,i);o.onChanged(this.triggerChangeHandlers),this.targetMonitors[n]=o}const o={onAdded:(e,o)=>{const r=new a.V(e,t,i);r.onChanged(this.triggerChangeHandlers),this.targetMonitors[o]=r;const d=this.diffRecord.findIndex((e=>e.index===o));-1!==d&&this.diffRecord.splice(d,1);const l=new s.gj(o,s.Xw.added,(0,n.A4)(e));-1===d&&this.diffRecord.push(l),this.triggerChangeHandlers(l)},onRemoved:(e,t)=>{delete this.targetMonitors[t];const i=this.diffRecord.findIndex((e=>e.index===t));-1!==i&&this.diffRecord.splice(i,1);const a=new s.gj(t,s.Xw.removed,(0,n.A4)(e));-1===i&&this.diffRecord.push(a),this.triggerChangeHandlers(a)}};this.target.onElementChanged(o)}commitChanges(){this.invokeCallbacks(this.getDiffRecord())}getDiffRecord(){const e=[];for(const t in this.targetMonitors){const i=this.targetMonitors[t];if(i.hasDiffRecord()){const a=i.getDiffRecord(),o=this.diffRecord.findIndex((e=>e.index===t));-1!==o?(0,n.h1)(this.diffRecord[o].diff,a):e.push(new s.gj(t,s.Xw.updated,a))}}return this.diffRecord.concat(e)}}},56287:(e,t,i)=>{"use strict";i.d(t,{V:()=>d});var n=i(64200),s=i(69304),a=i(5894),o=i(75772),r=i(81547);class d{constructor(e,t,i){this.updatePhaseSync=i,this.target=e,this.clearDiffRecord(),this.aggregationType=t.aggregationType,this.aggregationType===r.D.Debounced&&(this.handleAggregation=(0,n.s)(this.handleAggregation.bind(this),t.aggregationDuration||30)),this.target.onChanged((()=>{this.diffRecord=(0,s.bB)(this.originalData,(0,s.A4)(this.target),t.shallow),this.handleAggregation()})),this.changedHandlers=[]}hasDiffRecord(){return Object.keys(this.diffRecord).length>0}getDiffRecord(){return this.diffRecord}clearDiffRecord(){this.originalData=(0,s.A4)(this.target),this.diffRecord={}}onChanged(e){this.changedHandlers.push(e)}removeOnChanged(e){(0,a.Nz)(this.changedHandlers,e)}commitChanges(){this.triggerChangeHandlers(this.diffRecord)}handleAggregation(){switch(this.aggregationType){case r.D.Immediate:this.triggerChangeHandlers(this.diffRecord);break;case r.D.NextFrame:if(!this.updatePhaseSync)throw new Error("handleAggregation() -> Next frame aggregation requested, but updatePhaseSync is null");this.nextFramePromise||(this.nextFramePromise=this.updatePhaseSync.after(o.R.Begin).then((()=>{this.triggerChangeHandlers(this.diffRecord)})).finally((()=>{this.nextFramePromise=void 0})));break;case r.D.Debounced:this.triggerChangeHandlers(this.diffRecord);break;case r.D.Duration:throw new Error("AggregationType.Duration: Please implement me :)");case r.D.Manual:}}triggerChangeHandlers(e){if(this.changedHandlers.length>0)for(const t of this.changedHandlers)t(e)}}},1284:(e,t,i)=>{"use strict";var n;i.d(t,{p:()=>n}),function(e){e.BLURS="blurs",e.BLUR_SUGGESTIONS="blur-suggestions",e.FLOORS="floors",e.HIGHLIGHTS="highlights",e.LABELS="labels",e.MATTERTAGS="mattertags",e.MEASUREMENTS="measurements",e.NOTES="notes",e.OBJECT_ANNOTATIONS="objectAnnotations",e.ORDERED_LISTS="orderedLists",e.PHOTOS="photos",e.PLUGINS="plugins",e.SETTINGS="settings",e.START_LOCATION="startlocation",e.SWEEPS="sweeps",e.LAYERS="layers",e.ROOM_BOUNDS="room_bounds"}(n||(n={}))},77754:(e,t,i)=>{"use strict";i.d(t,{n:()=>n});class n{constructor(e){this.config=e}serialize(e){const{serializer:t}=this.config;if(!e||!Array.isArray(e)||!t)return null;const i=[];for(const n of e){const e=t.serialize(n);e&&i.push(e)}return i}deserialize(e){const{deserializer:t}=this.config;if(!e||!Array.isArray(e)||!t)return null;const i=[];for(const n of e){const e=t.deserialize(n);e&&i.push(e)}return i}}},64737:(e,t,i)=>{"use strict";i.d(t,{C:()=>n});const n=(0,i(96540).createContext)({intersectionRef:null,GroupRenderer:()=>null,ItemRenderer:()=>null,itemRendererProps:{},toggleGroup:()=>{},isCollapsed:()=>!1,collapsible:!0,ariaExpandLabel:"",ariaCollapseLabel:""})},28337:(e,t,i)=>{"use strict";var n;i.d(t,{$:()=>n}),function(e){e[e.DOWN=0]="DOWN",e[e.PRESSED=1]="PRESSED",e[e.UP=2]="UP"}(n||(n={}))},72268:(e,t,i)=>{"use strict";var n,s;i.d(t,{O:()=>s,m:()=>n}),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.MIDDLE=1]="MIDDLE",e[e.SECONDARY=2]="SECONDARY",e[e.BACK=3]="BACK",e[e.FORWARD=4]="FORWARD",e[e.COUNT=5]="COUNT"}(n||(n={})),function(e){e[e.NONE=0]="NONE",e[e.PRIMARY=1]="PRIMARY",e[e.SECONDARY=4]="SECONDARY",e[e.MIDDLE=2]="MIDDLE",e[e.BACK=8]="BACK",e[e.FORWARD=16]="FORWARD",e[e.ALL=31]="ALL"}(s||(s={}))},51666:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var n=i(25481);function s(e){if(e&&"object"==typeof e&&"x"in e&&"y"in e&&"z"in e){const t=e;return(0,n.Et)(t.x)&&(0,n.Et)(t.y)&&(0,n.Et)(t.z)}return!1}},81019:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform sampler2D tMask;uniform sampler2D tPinHole;uniform vec3 pinColor;uniform float opacity;void main(){vec4 maskColor=texture2D(tMask,vUv);vec4 pinHoleColor=vec4(texture2D(tPinHole,vec2(vUv.x,vUv.y-0.11)).xyz,1.);float redness=maskColor.r-maskColor.b;vec4 mixedPinColor=mix(vec4(pinColor,1.),pinHoleColor,redness);mixedPinColor.a=min(mixedPinColor.a,maskColor.a)*opacity;if(mixedPinColor.a==0.)discard;gl_FragColor=linearToOutputTexel(mixedPinColor);}"},85641:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},39142:e=>{e.exports="precision highp float;precision highp int;uniform samplerCube tMap;varying vec3 vUvw;void main(){vec4 color=textureCube(tMap,vec3(-vUvw.x,vUvw.yz));gl_FragColor=linearToOutputTexel(vec4(color.rgb,1.));}"},20736:e=>{e.exports="precision highp float;precision highp int;varying vec3 vUvw;void main(){vUvw=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},38581:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform float progress;uniform float opacity;uniform sampler2D tNoHover;uniform sampler2D tHover;uniform sampler2D tPortal;void main(){vec4 noHoverColor=texture2D(tNoHover,vUv);vec4 hoverColor=texture2D(tHover,vUv);vec4 portalColor=texture2D(tPortal,vUv);float xToCtr=2.*vUv.x-1.;float yToCtr=2.*vUv.y-1.;float withinRadius=step(xToCtr*xToCtr+yToCtr*yToCtr,0.9);vec4 mixedPortalColor=mix(hoverColor,portalColor,withinRadius);mixedPortalColor=mix(mixedPortalColor,hoverColor,hoverColor.a);mixedPortalColor=mix(noHoverColor,mixedPortalColor,progress);mixedPortalColor.a=min(mixedPortalColor.a,opacity);gl_FragColor=linearToOutputTexel(mixedPortalColor);}"},24235:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"}}]);